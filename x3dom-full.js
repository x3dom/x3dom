/** 
 * X3DOM 1.8.3-dev
 * Build : 7409
 * Revision: cd32048c1e00317891a3af016d11e98fe5ce7a3f
 * Date: Wed Jul 20 04:56:03 2022 +0800
 */
var x3dom={canvases:[],x3dNS:"http://www.web3d.org/specifications/x3d-namespace",x3dextNS:"http://philip.html5.org/x3d/ext",xsltNS:"http://www.w3.org/1999/XSL/x3dom.Transform",xhtmlNS:"http://www.w3.org/1999/xhtml"};function defineClass(e,t,i){if(e){function s(){}s.prototype=e.prototype,t.prototype=new s,t.prototype.constructor=t,t.superClass=e}if(i)for(var o in i)t.prototype[o]=i[o];return t}function array_to_object(e){for(var t={},i=0;i<e.length;i++)t[e[i]]="";return t}x3dom.about={version:"1.8.3-dev",build:"7409",revision:"cd32048c1e00317891a3af016d11e98fe5ce7a3f",date:"Wed Jul 20 04:56:03 2022 +0800"},x3dom.nodeTypes={},x3dom.nodeTypesLC={},x3dom.components={},x3dom.geoCache=[],x3dom.BUFFER_IDX={INDEX:0,POSITION:1,NORMAL:2,TEXCOORD:3,TEXCOORD_0:3,COLOR:4,COLOR_0:4,ID:5,TANGENT:6,BITANGENT:7,TEXCOORD_1:8},x3dom.BRDF_LUT="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED8xAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAMAdJREFUeNrsXduWIruOlGjOzP8/zdceNA+QmbZ19yVJKFh79a6ChKqCkBQRkm38v/8QABBA++/zf+JD2r8k35/4lqIXd1zA/yj7i/ij7rP67jy+psRP77vszG87Lph4T3PnHYEIAAGe/x43BCAoH9L+bZ4i/jwMfotAAEjqxfx+7QL5pvyGAP6vHbxSfFb8TuPXDl6fe0O6bvYH+lm3OwDxP+b1L1ZYtN+O4ykAREJ45MKA5Efj8aB+UcTYCKTc546C3gzd6ZhLfVjfdLvjRj1Q/Ds3uPjpX/m0moujb7SZ8zrTfwBP9iu7d/b9PtFXiBXY8Ye+6eaW/IMCyRndKwUqO5KekgsDPCTBtPSfp0PjibwbakJgZCjc75aoAOBmd6yIjV8E2FN6wkD6vAfTf/X0us7YL5hK/30EabqM+Zo8Pfd1ysteGkAEdIt1swTLgcG4UDoMMMrXc+nffM86IuHMm1uQfyGRqQBIouKUEx7KesBiR5hzdWxNnAN3UDzob3b8p0RKQfeLrJC5XxAS4ueWveyO8AKXQVcqrOspUw2MsKtja+Jp7F/SG81veBqkOl+ECaS/kK0X2qANw7GKAABKesCRyJKrk9XEWfsyl85jkFpI7rOv6eHuL/g8HaS/ubNygUqGYxUB6SVdXqSx+WAYpOhQVteKxS0eCRFet4TefEjujfyaEeoyAvewC1TD1BLHUrSArSX0LO6GgUuHhtJ/GaUgx/ZFbsHu+9/RuINFoHKBIvalKB/99O+J2mD55pR9PP2DWWemOKFrQ+hKemB1VI5zHqECNIiJ6IHyymZ6x30WgN+I9dN211RPoqtlomoEaktgem4d6Phps1jQINz5nS0FEh1P3yE1ZbE8DTE+8DNgj4ZgnfycO1L+YPUImrmfGxIj7mfwzpYCiY5nX5vMLgKaNZRj7fsVU9N/pJEXB/ofmbqZImqny1w3BhQKVDqe0nyy2yazGVHjO6VYUMeL9KT/OkovzX8WFIHmld6rtEcaXu7Tj3Foi7dguk0WGhbSraF0WQh3ynoiIdAmO0f++q92JVNoYhFYFwN3ROIDYeJcWkO4I1c66V+hsClCb9SBCenffAuz4D5pyP6UGOhmL1erA3cEEr1/UJpfEZnrzlbYTCbO5u06MCf91y++qBM8ORjyYHSf0YfvuUogHgMQt0FfFKhe+KIGA/p6wPBSfSibxk4oNsw6MLq2K7kk5a+tR5lo7AzGgHEn8DXBoLSBNTIQbZMxWRxcRSDO6CcaXoGJhr61XWVUD/KfKxqTa2rCXLtzPAYsFwikHCy3ycB3SJufxhFg1IG4uanWAVDdm9GVK4Hx6bVKdwaET2tmnW/sBOnQ8/6jDwDS5KbjkJI/xalxodDq9QAdsrvF9sxF/+B+QQXH+c/C4rBYmZ7Qqc3GACTvF/oA4K1isWWxyoUgP8gZpkNqSIy5+FZUrNlh5Qtcy7md2j5YazHDrxf6AM38fYcsttwhmrBkMWIQiXVgSvofzK9n7zjyjs7AxE7t3FLAr69EMOj4TsliSxjEhswm1gGAznnJ0KCOwoWm7AQxLTwQgE71MVNRMSUGIM+IYG+EacxE4+IRWawVAU5LosMO4O/gYN2pW0OjwPUk+yX4j4SdiVAeIUJTRG1HeMCxHkBKsVoODspiZxJOn97p3sFBxHGbrcGSBCNffwYdOlfprmMy2fuNhzYKtBn2YEytgWqq2Du6qePQ5ghQig7FHdK+9e8hKAeI1jshHgPyCT4m5lP4xJQP9aP359cYyMoa/mzZ4PSAPYUanJiIe/waUueQoiuNjgr4YHe9y8ecldpTWBefWItgPStr7EWbbLM3eRYlQYIOJeuA28zqWIAyzoWm859Q7zbw6w16OOendluFORpA6AN4qtddzKUNURvEye55RWRxpA5oBk7WCApyoSuq4V65ssLZnMvmIykfon0AXfVCYfvY7qfdA6b6LylfMCQG2Pva0+tFNYRGqfyw+270vD/Cs4dwP2uEzXeTHygpENW/BG6ywO/doi+LxXk4FaAYGuDh6bZ/B8LAUEPnQ2vU9hwX30N9Kn7Hzc1uQPdlfWaD5l2XlCzevwmN9Gxdm4TFqdSBxL77kBCviYcCA+FvY0fF77aoHdvn5Xez+b5IuCMS2JkeR2UxxVwmg5n4bk+YzGR7um/hQleeHTpBuXaHQZb/FDboxoSCxwoZF1jUJbyRSdm0iro9Sjc68bW5gWk2GAa3spvMecR7uopAx/3TmU+Q3kQuKGzQ7eMX9EDhoGFggNmhTBD1fLR5ZutZNfMebOhO4y3DJ3y9awExnihbB1N+POu3LhAERm6ie1HpFwQbuoI7lPE6I32uoInZf8hf+LSbcwjPyQ3akYdGMnqqLFQuEBRpHlyyHpHFEHWHBMTH2Lnb59LqQKgUTG3oTvRG36KGu2NgJN+PpPzgNSA2wg62ow/qaIXCjZNIPVHZOYQvDidyI4pse3TkBFjIdN86wq+nOzsWAyt8GwgtjM2VBfHKdkmk6EiqjQJ3fs51h2pkOwDN9q3MiQxfznad++2zrNjpyydQ/WxB6iM2S12dbMrn8dCuB4AU6XedzYA7xPU3/01AmoQL1QGQV8MEywJ46547w8NrYL9BFgeKwAiDn+jqDKZ8QQTjpgNaIrTLUMO3Maeag+5QDtkd8wtdkgC8tT4d1eAt3mi0CIRjYApveVfKB74ksoSp2AoINQp08wdMd6iJJaBY0ypr+SclgVsKAIZ3ibuGJu4QuIOcZ6LY7Uj5zfX1KMSW7CFAVHih2OErCwOvA9AkeJECgb60JeLtGHwm62N2SNXIFkNLLVEf6/UVgyjHDBxn5XvQd6mRKZAwDKcAfVajwF3hDjodAqVL4EcLqwOQQn+NiAj6ozs6Xr4OwIwwWEdp4qOs4vsvu0AgAX1KowCCC4JrxgVd+zKodSO2WEfGcYwLnTbMPAvoYA6K4hitT0VC6spsvhf6AE8vU/Ze9F5VX6MAUguCixlSyHQJQkS/q907iwulBPGZm5DaMQAzwqAvEqbke1AXxSsuEBRADzYK0iYpKZpboUOQlLkW1Ylt7WhAlpSKHFmnLw5On1MlzlG3Hcm7L99nWxmCDQqKCyRyHrtRAMr8HOR3ebDpUFYWy4ERntcHs1WcRf+VTSEILB2eGwaD4LYPQ3Fv9SyQ5AKJnCfbKNA6yhpfgjAdgkG7k0WX+Fwwd7nLoj9+HtlbigDEls9Pd2+WPl0NgGoaVLdW7OVa4Gpfl+1IezC2+EZrrgH0OgBuqyusiUGa7SE9geF0bJ5YB2aZmCegufs9O2xQzQVqc7bRL9uWEUNg7EcIA4lNAbvGlcVQV4yovwl+KZDvUWZ7Utumu8elTVS6iUArxr0m+jaD1k13sie5AiCVxAbqtgiS4r4XcGlrhdFGMAsFKLNx7fsbk8XcITW4U7e9o3EhGATuQB1YsatPH7JpHoinFEVUK4DE77VSYHAeCM76m+6QyMEEkgPt0IRdMaIUX6E0vuHj7YvYERWX2lV3UNTSAuxOiZNiFMIOAz08IqI51UbgvlOcDgmMSK8DcjAwSkOKYce5ENC80/LOOu0UkjugTMnutPLPSQdA9Yaj0xAAj/NAeI8TS1KD3LI16JBtj4p1AAIjD5By+qXZHujeYaU3BiYO+msP4xiUp2uA7pu8JBJADwPR9VeYkmaDNu4QgKOMwaRDXL/KoQKW6w9MPwCFEn+HhE2UhcsYo9fhOdmbXfaPUYjWCyrIX/WQDmjOlFyHxx5BBWl/RZmd6znbdv2tHB+z+UFZkQxeQ75jd62lgLaSenhr9Sskdfe3asehgdEbkAb0K5sIQyUiKprdRWF1UZK1AcvZsjI2M3QLTXPkwRK1+nLK8VR3wi4SS42XS4VHQYFQxro6KRS4v3vIVAwDkQ5xWdxRB4xSAOGRB9FQSkFfveasImBxmwVk7Arjse2+QAB6GIiTQub92SHTRvi60zsgcf2OOuAkeO9igwsZfeJcXu89oX4FUi+4t8tQBRDYvxgGhV42+mIgrRGzPaVoUDFxAp4stug+ayb00XqH0MdOIQilw/x205OztvTOXz8e0KkASKWBI4pgw5apwoPd7w6ZWoJBCipg202DJ4st6RzI7uUfyD9tiihdc0+4HBPII/oEG+n6Z4D7FIhPfZRsnmNdS/kQGJ2whQQq3o5gt0lNAOjg+kp2d1kNxJu+kh6As1a6zIwB/B4ChC0Fqr38yvBRGJEA98DoRERIiN6OAXFQDOko148JVjHwohk9owcs9L9DEH8ElPsrQLM5TJwRlaMQEB6d6AkPxQN1ZbFooaZiybBHU2SGzMjJKYT3xsCJvblTKBBbEwwMwSIjErEL5UhF12SRWyVkh86FuDfdAMoBTWBakxEyY3ij/eL4M+sAXu/n3kuG0WR30LpjXARr2K0XDYM7cWSEB2v3gpSVyXDuItMNYYoPXkZXX8SDYVQh9MbALOvmUtq3+5epG2F6GDSsQywFMna1UpCcOAL2asIHiepDYh3Q4gQlgMhPQfXK7glefB9iousbzy0luPI1722bT+f6bWoUw4AFjI1py2wFVf5SvYslSIxfpfJ6HQBlvt/5GFBwDty339Abb+Q0b0/qePqr3Xe0IqPUwDZPdRmRSGPAG52wTFJtdk2iQ6D3blN1wAiVSOUJMXucN21Db4IqfRjWfQ0ghkGEEQEwYeBJiJCpKr24C1CxlAmPgjzkA6Zm7WP2dAEi8UcyevYVBA0QCQMkwY4US0F8pMI1SWUuxKqAQWNA2Y4KTLeHKPYZKGXHpU/fVATwMnAPPp1tiyJuEs/XBogJXsrWqtgVA8Y0SdVFwEqfNZLpQd/TAerqFFKxqMoP+MoYmI17PPGJ2GiAhr0MMaLgZJEYMLpJymU3KEfeAlfGpL9fbqHQJUeHyxmBL83OptfE/flw79EAPYyo7hCDO1lEEJ1IBd2qr8Op/ePRcjZDete8pjsGtI3505/9+iIwvlDhNMTHr69mgQTzR7szyIjEySKd/YOyAobne9TYtrEUK1YHLAYf7mHFkYHvg+O7dOeKJ3ZHiDALpFGd6k7tMuptIOiKWagPEtumiDhz6wB4aR7lImNH1FIev4gpnQ99fEeE3J+5lHOYHQokKTzSLlOeKIcBObC2oqgOJBd8RnjYJF4g/bhyXxsaQ9v59vyYF7QO9DkXSJSzArEJJ34xqCKuEXhzFqIkEJBalxLUH7KDZGgWbYYg/ghVmno6rnnlvti4N+ILuY7ksWEm/khgGK4RGNsBoWUBYZaxhCVBUFGsSJA9KDyXSi1i6njWC975/r8o2imS1SMi3uFIumsEZoOZ6wdgQ3LiB49d5z7bEM/xjbwYGDxKHrtWTvZfH/hx+A7ch88HkGZksYbaolJgcyTQesBaB5fd739CykNRiC+LARielsPPuRjPfamKAlUcgfFmIbPybB2RCvHAIIvh8KIBwbm0rjpgPErBEJpnCmES/vEysgL9sy5bHRuv8wFI0YjqyA1XCxhzjcizfQINOJv9U8fZ5/kY6HE8OwYlrsSkz7zstPh5USBN+1YI5jkJWQyES4EYXSiBOH5nxZFAn1ugOTEw2cHMvGa8IY0r02fHz5oCfZz3FxXbo3PSz7M4ClIBQA4DUjIfSRyX+CwA+31U9m84oSms98ZAQhMHTl8cun4lVlZfc86vio4LJLEdTenailksBRqtiiNeZv/a1Kc2Y4Nn14HUMoBpJCeQmN8Cu9QFS3+BdlE8mWEgWkCVYg4/RaRVTQeA6zltfI0M4ThQB1bN24QVKgZ+4mAMDGLXDexpr7/m6ffm067EQFD7lpgWn0KybaIpbI1WtYgXkYqyNSSrWCMGIKqYO92ejCDGwRiAVQGwFJ3nVJW75L3XH3+M8FiY1sWxpgFA3ASFI17XLRjEtJG3hl2jifbiGzkGvgPfpz16Vw8B9MLAuEB2jXRxDGx1vAZloVyANMmcgXuqVYzJGLA+mNSUxAibH2BBK9L/W2IV1D4AL+cBlKNGu5sLXEYk8h9TaYCijIWkK82EynDvA7qd6QcEMa5RtHhiAJyM/u63JUCBlDA4crl4vRckbRiQqXpR4DntHlgBZONAHYijPG74YJd27Pmwe4sAnhVO57/m86G7uq4kS4p6gwR0vlSpXuUVWmSDpRziOsGlK0GUR+bSMN7wCqiLuQ/hKWF2fuIHcVG8pl9HwsCylZo+cRDi5HF9/jGkaE/WMnLf65gmjkKtOwZMdK6+/7TIzL5m1QeglAK2SY5N63UHCVC1WW18O75nvA5497v1oZuiZD/v1Rn9veg/RwofIphcFsS+pdml4AgYCMWMJgnUGAA/MNDGdLZudJlCGJbOWYqC9IYA6MDraYzoDkg0zPUhjGwycKxLYVDazG5UhJxQPd9jRp5i19KC8ZS8Ltn3vHJyBRxOwnH3s+4UFMFj6b+KgdiVgir1QE+uYtE+JG0BMYbvjPDs/DgdxnCGJwbACbzoTL50lzaw9b+lJO45lNVS4KZ2jArlbHHA2J0YM4U6SUg8BvrAmilr41Fx2YBRbNBAGFAv7kdLgf1tng7ZHTEMeKYY2H1oIT8JhMoKWL9LLUx3iiQbVDtUmmK4B+lgo1mlIGZMWfjurQPoiVEMUOFoidAKUW8dwKmvv45uwbldZxRsUAYvCoI7kv7NUjCU++PfBu0j3Wm1gZ6Ao2v4hNcZI00IiSvXikWmEHIbFNwuWDAMhkMC5oYEpCsDmtICTbCG6kMvTCNXdpaFCwfAUlPoTkhZ/ycdBjbWx7SE8S2GK0Mw4xpYR685gFkGrxhKCSkyzII6YZ1vOb9xVPsurTPXv+3I5YPhEX+oXBIZsJKMxhmaHqiB9RxHChCYWRl9YhWa/tz3UqM7pCoA6lIhgG+0wyOIewPHtkNqz2sEFILBhbAXfNiVSkP65EQW9JYAmBIbVgUgCOds9zIWKjjGlJBmgD48aGQQGLSjxQZojOdEwJR+kQB3mh4Apxmj8ddMaoA+vEpflycHp8oCBioGdtmjGKgMGCgOCJmiYWtl3TON1IrxsnCOhp4eG10uUFwDzPua3FLA5+TM3I9JphS6XpO/ItwzBCkE0GAMTCkLU6MC3jpkColG2HgF6Pi6KAUYKx2YLwsaU0J3JC7AhXJw1wiSRqgmCQbrnoB4WKR63+4RHQFw7Aw6owKgB/fj63K8IvBERHN8mgJ8RqkDGNAPOfmriwE1BmyUhyPkVwSyj97103d7sjvxkIiVAtLojac6gkDnayblgQWvUKASFWJlmBIbg9/CR/XO4JTFBtDaoPYs0BjJqfa+FbN7ETzo1g27LMSArj4rzIWQHCKk3hmuGwZNMlhWUC1MCZLviIE76bNAEbijwVsUGxRRDRhq8GrGA9rx0EBKgnWU6ihkSQSoCM34lVPU82nU6OTAWMGF6vUABhfiX7MEf0hSsywQVwt1kGBANkRCEc3wQH0gz54dMICCMcKj1gQ7NgZoknqPubDmy2JAvEDZFiXChQxzU8SlpBYSBSTiCJGX+1kdwGDF4PhT2gVoWqXBwOivA33TqZesA7BgdIJfwxphWRkgGjhSiUBFIWDszlQ8oEFyFKvHAJOxHiAkBlLFQUHwirGL1YIY3jcmHS8FhQh2+Y/B7EUzVCkLzaNiKaBGKrh0SMn9/tecC5HOfCIWEI+BmBoO1QFPP9gPrSsLl5W5vg1KcRu0uB9NUlQd/qU8isGsH0z/ZUfMqwOoyNwITdLcGEf7Fi/iB4bImuJfe+vlL7uqZrXlb4pgrnTBGWEAN/HXA3Aq4pWsT8R2gsBMly1TBxLhYRcQE8GpL1wTaRYv6sb3BUegOx5VOsH619id+HdNrJcCkp7YxoMOd2x+AVJNTxmpnlQYigFPDXeaql8aAzDc4cosiMkIX1IkASqJv6ElxEhLUwpKoMtKQOs089Re21BIFtDtzlRq1CdI8UckgdtTy64Q6GYvOCOvvysMChcoXAQQ5QtKUoQ1ESL2RKr5ukp+eAwkdQKyIBRJP2rxoF3m6VH5gqQSUCNKm7NY7xHBslloWDP67z66uUDVMSxWJMjsv/FwpLIghgGWiZ+TH1ZVUIM+7wx42gB1XiTA1GQ+cUfIevFBbXAiFxpc1w/L+lxdGsB2gQJsp0R8Ew+k3IMSI9ISP6HUTdPTPzIZYNQBzMaDIRvM3BxsGI9A/4IxcD4p6uoDuC6QXQS4umWh0ihgoso12ktBSABQJtOLEI9gPR4DWQM07hHF9In7c8+MAbjMqHNGA2RcoNYO4kWgRnYbBnaaV3hRhCC17N+2RPXc79YEx7bPGzgYiIpxXmQ9NHV98MlhEIyEGAXS0Y+iwa8UAarv2SsGsqgoS8FOdQzO416DXh2wuZCGxT5eZFuiMDIx0SsDpi8tOC0MphQEkwKZuZ+UvOsznzLl11Hxem5RCqgMhjoqIEWHlDrQjgxpuR+8YMjLWf/O7MTEjLHqifbopbJ+PBgyNqgJ+mDKbzI9NCSnDIb9M64viEAfxfQvwl3M/Z4Y8OFolog4U5rfIsiHBLx7hHMW1vUTYjwb1KD7otgFOjL6/i2x+5ErYAnrlftZl45UQVA3bVZyvy+IPfY/x9Lp9oimbuAF15tkHmRBCQ3QRkj5I5UuGEkXvI5I0kh/A26G9ZYOeZUBdVKEujAQxYAtlDGia/UpUZfxdwTVoi7BpUweHEj8jALZGoBdcOhdVijEIqDleFKCobm/GpdQKoMtA9wOGnr8R1YCnjCYZefbsuH8zgCcOPYzy/GURTCJfQAT9AL1B8n8aaKiJkL7o7SphQbllQaoE7/cEi5/pUAwIKkQ56YnatESEAaWbPW6BJCZfZjmir6JAk3HeuSyYk2wSISK+0kKjCrrb5xn/xZLoxMq9IulgOpHoagbtL0yRrDeZRnZBSEaA0bHoIvApJjMIAWCc+c9p3P6juCpKVCA/GhZ//BzoBC+LM2/mL0eDMe/hTawwB2IAXTTv14QUM/xIWpku0NroJxaYAnTpyFobWrHqSGxdYJN8iM6oVRXDBTdT2hJDtSJvMzuFcOpU75QH2IxgLFGgRMVGqAjitlN/4E2mQXlgTXEbxmIWIf1vp9rukD68wnaakAFKZKLAFToL1VBBXTOcCS4t7JYa4FJvhBqsxKxyiAHhlEHYqNE012dJUcWTBUDE+38/grwOineSP8c+vVDIuk/agIrAkcpAAH9PNmLVaKZIHK5kGyJSpDVugSi44kdyvhEZ/PkLRZP6FtNf+VKA4h+P2rdADHfVz6KUATEUnDgHiSqwwSx4IfqMYCiHoAQERLfOEMNq9XAtINsd+hquJ+e/nENyoPPkkQwqwTG65LIguocDzWsIY77/TIQ7pRVr9QxEPSAQoRsMeCr4aQd1NHZjcP3XbjHE7HeFw/l05U+gKEEGsSz65scDzWNYXAV2E7b/4Kj+cC1csggAkseoDQogZrbYw7SYdgOmrX4azXQ32uDToQ7dlYAqSHAXSCUtEETD1D7ntq/UJcFC/di/0siP/LaAGVWFO1qIBEVNFXBiDIOxUD+pNR1hwZo21MvyuuDFSBEgbJxVpmepSBuFC0I/0JdFoAZpvIzQbkTVCmMPP2DUA2y9ija1SOT/kV/8/zsvm5JwDlwR0bmcTwAkI0AkXmlcBwRV8BlB0BHv3oPKCHFq4Fcm/SQsP91G2crm8R9kF19cv24Elhh/2vXJAPAaBIzlq8GA1VKtG0LBNBv1o465eslQqsGnLVDV8PYrQPckgo2iadg+swDjt7ojc4OADApfo1CMc0TquSlVRw687Hs/xLTjdgFtRqgdiJGpBpkGFEHKQraoxMhPuUEu3NGncefOFkDaOlfrgY17QFkU9OlL+XWAZF4iaFSuorKrI5q1dtKQGkCRFjQii1PBvGdzegng36EKZFgg07FfQVCVgRAckXLqekG6JUfWpQaUpK9JkSw6QlA5YoiWcwkogpQ7zH3qOE1O8AtpDc0H/HjTr99fxEAkdSdvTXmKecsrHEGRRsB6soAzbAQqNRfJj/1L4Hkn6fdOJXojQxB2BcCZTVmqhQMiuNu4n6FWf9ZT1QqgGKcD0K/6QaU6wQEuBeVQaT+7WZB5MkAcYfnRisXuDTaAoO+kLHFUDYexhnRuodWMJ+5BYHaAHDhXp7l2A195qWWd4IYCSKb9ywgLR5ki10KEnT3CLJ9oUk9gaEwkNpkI7g8DfHjTa7IbyJUAOr+VaQmlwx9adkASN8CG4iIjANFY0DUwWCKYIjqgQ4vqD8e8vuhT4Tj3M06z+Q/LQUihfyQMh0J/vIBOeu3W+7WA9VQr7hHluxbI8htArgpsxAGqi9k20RZ9n9KKYA1s/vv4vrjNUGqALfXmmDyaA/EhuWcHykuHthfTdpXq0n8AE4TQF4GILmiSObyK00EKztBOCyoY2MVTyfA7O7YEDWnyfCdDnfLBSL3pK0I7qWMq27hXIhgkNYWNz+SlJCwNADIygEz8cBlq7tXSjD3h2akxw7Me72fM1z8cwTr+WXhTvuKsJgCPlZjZd+OhudIewo1/ma743QThYGBUM3xbBCj7scWWMgiGjvo1Q0V9L3by8Hipth0OJ5sd6oB8GAuEFcC2OiBOhgaHBpVoZmaRk15K0ctubsAWatkvHGJ0hL1DzKS2sBGZ2CWGIAZKwRg8VLGCz59gggGa7fc9F9C7IVC2/8HggH1BTHI6BAGTqV2UzIGUinapuqy4dCoDFi8kckb4R7YFsUVwdsrESlekLJ8lvTHQ22E3mDQlkTyIQjREhWYj0HKk/a/saoYxoaCYFJHrLMO0CVSe9fmuE8NYBzAKPEfLRhIX05OQbjrl2E4GHA3NGGoFJSEB/XTwZxI0PjSAP+B2c3gcTsIAzltqZ8zRwOQ6P9gfZiFJEFdDV0x/noNcSgqlMMn7WBAUJcEIFscg8rYXBCymgzotoMGhe/S/XzeOL8w96XudCMojsjQ0j8V+YwYdGjgHZFX1pN6RB9456XyL7DJ+nVgJzZX215E7A+ELFGvN3w2+59SCugSubzvBe+EdPSepDqAzPARcK9syBN6Z0rjv+wBl5ke2AllYpDY8bCnc0btsLlG+dqpA4FRuRW5f8oGJ7Ms0aXdqxW/Q9UHIPAsoHrzWpEUdfyKpN1fdgCUQ4udOxW3FJvQbRhR7HAKdRqCb69i7kWXmgmdboAuZf/X5P21BmhcIIUxU5EFX3cbW88y28SumdU6Hdb2OpYKkH+Id4QRlcUNFakDsaOtnd1Cpe6bhtEhCkRv6IKt6GTR6RHVukAEVieVH1pBKB0wEFtFgGKmB2UCFHS4d4dBaQoVvxWC5IrGuVBwJmLgnMmZdWBwGdfUEaBzoI+iC0QgEQaQFbDQ/bWPbpd+A95fg2IqjgZCAmHjOSh8YW2SlTy8ETNtAQg7nlMWhZ3UAbieEkhqgBsd3KNsBjNP0DikWqBD4u9Fer5uVoGJoFfDpYW+XQ2wzPpiN0BfjKvOBZkQH6RAsHICYhb0161foZVxdYhg4ohhAqDsc1mHtkvpH9kf0wKVbwax/0QonB+OeyhmhzKkCMVugNT/EtdPinyGd0VmzcCNoH/F9lUjoLxOPXmJ4KMCSJOV5cnV1eFFcfTv1qqOSQB5QxRBGUn3oBFkniQQw0DMvsi+iAsAF53zBQBN9fsHQHkFe3SsAkC9v+cWDx3odxxLFgNUDmyhWRpJFhlcEkTCAClGPML7BkzZJhrm9r9oDPr0kaDvrQD8+Lr6yF4EuD2f5aJ/DyotBkA/tgyU9M8iAUtJAHIrANmHhqSuCoj2AcwD9rJFoC8SYPZiSHxfsndt0/kVgGriW1WAmvY8q8GOvwfBra4DGvqNNS0gCYBgJBzA1QsCsAPi0dwgqFLGxo5DpthN7Qk3vfv7ESJ4nTwg/Sn3x+04I4zENbgS/9nZf6X5Gh+JJKJRGKkAiqNa62BoRu7YH4f1H9dm/ZgqQN4QkHx6DYuR5le2CPSZPx/n/5zAlKwjkp59gHYagg1Ocv5Tsf8CVQ+CG7WRR1C8TmA7HzWUiZ3XYgYDb3ghSDaozumD/gzE1DCYQ/+QCYl16I/inq6O+2gfgEqoFL5n0wFoKgCHflUEOO4pAXShFAQ5IBPEuIkBnvux+K8xLuXVYSYK4woy2wKbjv4LDkFcQgST2QEopyl36r9n01vTOd5wv08ZNf9i7F8Z6KhT5GaoAXV3SLSA2HmSNkCNVoCxK1a3+zlk+AxD/5tw34rgfQ6CmiEzKvZzplr17imfAAAehQVU4j6+l2Ekr6Mu/rkSEOSP+K2yHgBA2DNUHjuLnK43y/+hEPrFlb74g75YAY7cTK0MePmVBfkpK8CtJj9UU38j5avC13Z+gjeSHBg4rEwsOwOSUYN6SJTeaLN6OCUos7Ab9EZwAJ34ybhHzzA9KBDVew9Cc6xvLX9x07soSt69b1D8SwT4sGb1y33PSVsqmZKJxfoy1JZuspUAwgvqpifGFHCHBkjEEvVEmruXm7vj5WWhj+FIwMoFwkIHw5bR6xWuSC3zAYAHwo0AaPN/CqunSf90AySgh2L8o2KGdg9DkRQPCilCtJDkQjaS/iO+p5v+xYWawfiMw/SzJh2y5ZGqrRFvVCKVk5Vj9qFI/4fwpWpLFQIF+iXibwAPdicox+9J9xsGnLzlGypKWiwpmg7W/VC7CMQ/rXOOAsCvgP6s0/JaDXD0gwvyo6X/XfiWuZ+o4j8786kQfwN8tGmekA3/xJZOIqf+qKrqtg8Agg7ua8TaB7BiBvQ59NNfGfpfMg59BABTwK9ca6b/ffaBisCBWuk+mQ80YYB1SHDIRsY/NW9USu0I7cQoApuDYEemanUgWARScO+oA7Nyf3ab148GfR0Az10hip1riapzTp8BYKR/ourf44tHRYGarF9+y8HtLHwBITz8T1cnQuJgXGrUDDN2ZFxazEK/7SjgZeB4/g/aNEChgGnDRGuAbmtkm/T/ALgpiX+nQLAxn1IB70vAqlUvbJcUeRy6secjEHE3dYzr4LD7GUHtRPSvoz34RaAXKFAlghsLqI6BGxQDP2LiL0C/5/4D98+IaWwfEj58kvYLculQAiJKX0xsbEFgU1RV/ga2/oQxq74bQHgBXL7XQaoDgB8wuslZ3KjMYwuDp/v5jIQjAB4F6IvcX+KeNvZ/8H4Oeopt/WB4vCYVRpQaYfyJ3vEtEc6d9UBHZh84w5k/9kPfgHs9AGo9i4UGaLUvVbSHdpJTCIDXt4+6DuzBUKOAwNz0E6qFv4gSwzb7fihOB4G0HqAbhZjrLqVG3+ZQ/3cz/qsNRygBIPGfZ8d3b3tRnf5fvmdRAYA2oCuIL++vOsGBMBDn21Qb1FYCiokZFcHF2GzfmuAV9uXqY/C+APosAJomAFS5/yA/JJCfw/O5bU+vs/6L9jTf7l9gbVDWYYB8U2iOe7TqPrqfTOGKGppY7Z3NRUByqymcDbU/An0pAEDuAb9Gx+jA/e78EFSknxMe2n2iB0uJpGZLKhcf2tWAUyDqQb8K+phXA/ktISa0wLr3+qResNI3gN4LADgWNJZF4EB/k/tJhv4O+j39H5HAw0Acj9aOgQFhe4lqjx3wmwMGZRdXw3SI4O5MGV/5fsHbp0C/DQBBAW8B8BK+qKO/lrzP6kCPNv2/ug0ohQEq9UE7+xFixzCR7gKBPAc6KEa75W+niTk1JeOfwX0RAEivDM0DoGH/oKN/4z9PuJcV4FkQKnqzh0ED+uAKseYQbN0eFXtkfKGMOMODxoowVHdjHpmEC5Gf3p1of+jXA+AfqwClBdSwf3yZP3uENOh/8Z993nPDghwGDfQj8QCsU8GA2zGqjjNy+Yh78/ZFJ/jHcK9SIGrYP7TaF4oi8HgAaui/HdVgJzzUMB9eCqiOByUGWn0sDbSlabq0MqZsEcR7BRpQUpNwTcrv3vF87uj/FyAeOwLgtSCY4AYy86Gd6hTo37P+qxRsib/aX5O2e6i6BylWBzRFa7qithpGvYwM+j/dLhCk0D+pOn0T6I2/ogoA4v4P1MIXZPTDrXgUigpQZv2dDpVwL6OCXo+iXgGQrFNc+XnuQDn0Z72Xjq1QDHsRp0JwhXb/Gty3AfAobdDS/4HD+jy6Yxv6oYyKnfBsoKfS7akjgeoi8LyH9uOHXRZk7MUb6wygtjLmAwGBp6GfPhvragA8mj5AwXwe2xe3Iv0/4FjtRQXRf/0LB/pf8dBk+oYFlRkd/cO6q7+5tINI5jNNGGhzmhh2Y1IsqE/+4rIIjDunf6TncAQA1R0ALCgQNfynVAIb7WkrAFTor4gQ1iexamGAlv+DeltAZeropLTgid88eKZYRhN5/AUHga6G+yMA/nsTbNDD/YSa/Ijsf0v8bQWQ8n17PzFe4p31qxEh9Gj9oMWJfwMcfwf6sgvUBABAJX8fzwGhh5L+66z/+oKFBP+iTf/SWUYGEYr0ht872bto6/Dph/7iX4K+LIKxCAAh/Re4hwL6O+F5wb3kFw9WChoOYhQE4/gZJSRQapD1W9146gJwW3uMDCB9qJlzwq99f/yjB1Ui+LD/odK+Le8vsv6L9O9hwNI8oQR3VOx8+2yvsJXZw4WGtzDp6wBMWQ18/tafXxBvmwimgwId9j9UCyMfexGAog7AK/2XfEYgOTX0CaVIiBSBshXQrETxNnaekoZX6Nd1q4FntoHpq3BvBgBL/4+S/2wN4z33U/0uEbWYfu27yENCfGMxWgQwaMgofS6dl01OddONoGvi7FOnQV8uUB0APP03FOiA1KNoY+E26gzbRkPifyIGRUaE8k5VhgZwmQ+OLaG61kbhlzmk8ZOnQbcKAEUA7HtFvdL/Rvpb86c5EpIEhlPxfqj9UPsdnaEEctZ+hgX1yYAsO4o8hH8PtesDoCgCuIvg3QDdSH+T41/9AU0MgLTvZrAOBNbmvjeHjaNw2iAQjVL5PxU/mwu07WkOVCzfZRYQfwePQToGYmKnqlMzEBH5UOw5H3v8gaL2zjoc4DeC5ptKx/2/N6IyALYYeDYHKu0rkh/aeL844CkO/XMZoFGgSKZ3y0X8czUm/s0jU0+60Q/9iygQHcsAsNy5sJl/Lpyfg+5vtKf5r6XDfEkIFh+o2xwA1eX8iE/3gjuJ4w/9WgDcSmLTCIDN+TncT2LpHyXLHyQZgJlFGbQeMvRX0DBZV3xZAOxZtu0BF6T/+RWh6XXicfhkdQ9oB7lkZEBAGaPHcK7I2mk5vn/mjxIAsG0DsW+NVUw9EBXof0L/Vq1lUQc/QaBDBOZJLPHEHH60xw+dVXZWps+f2T9NBEPNf16zbUXn60j8BfRLqnP8B4XN3/Af5b2Ux4SSo/mrP+lZczXRIQj6ExB8dwX4R49HvYE9vtB/+D8I9NzZakP/EQM3tqkJKto3u09sN9BHisZAhMxHpyf3f/EwiQJtyeYGQE/0YzHz8zh0MBToVxc6gh4D7NMj6BrH0U+m+FCViX9Mel40AJ5YxNIFeobB45jwKT0fOQb4WS/NF31rq5I7M+c2hjgFf3jJ2PvLAqAKAISaxO8bnOzmD722PxEGnkEy9Wv0O4MymMfbKSMSkWDAzwHNjzXJLtDrRIkbIEJ5XkZ1dliNftIt/wM2UrKvJiri++/QepRfGzQ/7K4JAKTHDQDghi9z81giTLXrT2arC1tLlDp2QMYzTJ5O9NEPlF9MgZ6ew+3Ys/a16HEvBXyJo05aqGFEwDgShDfbd9G/ZvE7nhB4P417HQqECHSDx22rA0X6LxO/trMVRVhwatVJqg8wDlb8jZr9UfZ1fzwbYQjwb6sA9QKx47SLjuF+7b0csYOW8Zkf7P6oBqDbqwLQv+KcvMdB/ZtdPl+mTb3bM/0+zOv/6T/SpVWA2z+gfwD/XvznmALiEz6QP98Hp6LpHcMRPxR+cwWAGzz+AT5j4Hl7yBPOO/pFh4c6ZMBbNxzs2BTkR0u+LQDoRgRwuwHdNw+UXjM/RNW+bny68yUTxI0eapFwwaznD1DQZcLvV0lWV4AX/2nO/tWnO334hB+ibvh80Tbfv9s7AwAR6A7077VrOT3UBS6q3p27QdTv9hMt51Gg5y64/14BANvYc+X5iFResjIp/2a+PRB+kfjnK8A/uN0B/lUbPRCf75+BF/zzSPzF2+UqAN5fCvg4JFjr7zaLevuO/7wAdP4mCn+xJwfAUwHv6wD2ESDgQ84LWOLPzPih+d0B8J9XB0CWvyjrV+r6WOgzEfZD21eL4DvAv4r/0C9bf+jt9wmlA+BG9FTAj3JTON30/CXD3+2rAuBOcA8MNv9uv9tXBgDcCe7F9ugS+SWXF//C5qe2P7UC/E+5Ibr1BtDv/f3dvrAC/C8dO538UPnL1n8wAMiF/q8F9SE3+r3BPRrgd/vd/m4A/CP475vOU/7dfrf3i+DXaXi/2+/2NyvAr3n4u/3pAMBfAPxuf/f2/wMAQAlQpLLpCe4AAAAASUVORK5CYII=",x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent,RENDERMODE:"HARDWARE"},x3dom.registerNodeType=function(e,t,i){void 0===x3dom.components[t]&&(x3dom.components[t]={}),i._typeName=e,i._compName=t,x3dom.components[t][e]=i,x3dom.nodeTypes[e]=i,x3dom.nodeTypesLC[e.toLowerCase()]=i},x3dom.isX3DElement=function(e){var t=e.nodeType===Node.ELEMENT_NODE&&e.localName?e.localName.toLowerCase():null;return t&&(x3dom.nodeTypes[e.localName]||x3dom.nodeTypesLC[t]||"x3d"==t||"websg"==t||"route"==t||"import"==t||"export"==t)},x3dom.extend=function(e){function t(){}return t.prototype=e.prototype||e,new t},x3dom.getStyle=function(e,t){var i="",s=document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null):null;return s?i=s.getPropertyValue(t):e.currentStyle&&(t=t.replace(/\-(\w)/g,(function(e,t){return t.toUpperCase()})),i=e.currentStyle[t]),i},x3dom.isa=function(e,t){return e instanceof t},x3dom.getGlobal=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,16)},x3dom.toggleFullScreen=function(){if(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var e=document.documentElement;e.requestFullScreen?e.requestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen&&e.webkitRequestFullScreen()}},x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:1e4,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(e){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer(),x3dom.debug.isSetup=!0}},activate:function(e){x3dom.debug.isActive=!0,x3dom.debug.logContainer.style.display=e?"block":"none"},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div"),x3dom.debug.logContainer.setAttribute("class","x3dom-log")},appendElement:function(e){e.appendChild(x3dom.debug.logContainer)},doLog:function(e,t){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(e="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var i=document.createElement("p");switch(i.style.margin=0,t){case x3dom.debug.INFO:i.style.color="#00ff00";break;case x3dom.debug.WARNING:i.style.color="#cd853f";break;case x3dom.debug.ERROR:i.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:i.style.color="#ffff00";break;default:i.style.color="#00ff00"}try{i.innerHTML=t+": "+e,x3dom.debug.logContainer.insertBefore(i,x3dom.debug.logContainer.firstChild)}catch(t){void 0!==window.console.firebug&&window.console.warn(e)}if(x3dom.debug.isFirebugAvailable)switch(t){case x3dom.debug.INFO:window.console.info(e);break;case x3dom.debug.WARNING:window.console.warn(e);break;case x3dom.debug.ERROR:window.console.error(e);break;case x3dom.debug.EXCEPTION:window.console.debug(e)}x3dom.debug.numLinesLogged++}},logInfo:function(e){x3dom.debug.doLog(e,x3dom.debug.INFO)},logWarning:function(e){x3dom.debug.doLog(e,x3dom.debug.WARNING)},logError:function(e){x3dom.debug.doLog(e,x3dom.debug.ERROR)},logException:function(e){x3dom.debug.doLog(e,x3dom.debug.EXCEPTION)},assert:function(e,t){e||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+t,x3dom.debug.ERROR)},typeOf:function(e){var t=typeof e;return"object"!==t||e?t:"null"},exists:function(e,t,i){return i=i||"function",(e?this.typeOf(e[t]):"null")===i},dumpFields:function(e){var t="";for(var i in e)t+=i+", ";return t+="\n",x3dom.debug.logInfo(t),t}},x3dom.debug.setup(),x3dom.X3DCanvas=function(e,t){var i=this;if(this._canvasIdx=t,this.x3dElem=e,this._current_dim=[0,0],this.fps_t0=(new Date).getTime(),this.lastTimeFPSWasTaken=0,this.framesSinceLastTime=0,this._totalTime=0,this._elapsedTime=0,this.doc=null,this.vrDisplay=null,this.vrDisplayPromise=null,this.vrFrameData=null,this.supportsPassiveEvents=!1,this.devicePixelRatio=window.devicePixelRatio||1,this.lastMousePos={x:0,y:0},x3dom.caps.DOMNodeInsertedEvent_perSubtree=!(-1!=navigator.userAgent.indexOf("MSIE")||-1!=navigator.userAgent.indexOf("Trident")),e.__setAttribute=e.setAttribute,e.setAttribute=function(e,t){switch(this.__setAttribute(e,t),t=parseInt(t),e){case"width":i.canvas.setAttribute("width",t*i.devicePixelRatio),i.doc&&i.doc._viewarea&&(i.doc._viewarea._width=parseInt(i.canvas.getAttribute("width"),0),i.doc.needRender=!0);break;case"height":i.canvas.setAttribute("height",t*i.devicePixelRatio),i.doc&&i.doc._viewarea&&(i.doc._viewarea._height=parseInt(i.canvas.getAttribute("height"),0),i.doc.needRender=!0)}},this.backend=this.x3dElem.getAttribute("backend"),this.backend=this.backend?this.backend.toLowerCase():"none",this.canvas=this._createHTMLCanvas(e),x3dom.debug.appendElement(e),this.canvas.parent=this,this.gl=this._initContext(this.canvas),this.backend="webgl",null==this.gl)return this.hasRuntime=!1,void this._createInitFailedDiv(e);x3dom.caps.BACKEND=this.backend;var s=e.getAttribute("runtimeEnabled");this.hasRuntime=null!==s?"true"==s.toLowerCase():e.hasRuntime,this.showStat=e.getAttribute("showStat"),this.stateViewer=new x3dom.States(e),null!==this.showStat&&"true"==this.showStat&&this.stateViewer.display(!0),this.x3dElem.appendChild(this.stateViewer.viewer),this.showProgress=e.getAttribute("showProgress"),this.progressDiv=this._createProgressDiv(),this.progressDiv.style.display=null!==this.showProgress&&"true"==this.showProgress?"flex":"none",this.x3dElem.appendChild(this.progressDiv),this.vrDiv=this._createVRDiv(),this.x3dElem.appendChild(this.vrDiv),this.showTouchpoints=e.getAttribute("showTouchpoints"),this.showTouchpoints=!!this.showTouchpoints&&this.showTouchpoints,this.disableTouch=e.getAttribute("disableTouch"),this.disableTouch=!!this.disableTouch&&"true"==this.disableTouch.toLowerCase(),this.disableKeys=e.getAttribute("disableKeys"),this.disableKeys=!!this.disableKeys&&"true"==this.disableKeys.toLowerCase(),this.disableRightDrag=e.getAttribute("disableRightDrag"),this.disableRightDrag=!!this.disableRightDrag&&"true"==this.disableRightDrag.toLowerCase(),this.disableLeftDrag=e.getAttribute("disableLeftDrag"),this.disableLeftDrag=!!this.disableLeftDrag&&"true"==this.disableLeftDrag.toLowerCase(),this.disableMiddleDrag=e.getAttribute("disableMiddleDrag"),this.disableMiddleDrag=!!this.disableMiddleDrag&&"true"==this.disableMiddleDrag.toLowerCase(),this.detectPassiveEvents(),this.bindEventListeners()},x3dom.X3DCanvas.prototype.detectPassiveEvents=function(){if("undefined"!=typeof window&&"function"==typeof window.addEventListener){var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}}),i=function(){};window.addEventListener("testPassiveEventSupport",i,t),window.removeEventListener("testPassiveEventSupport",i,t),this.supportsPassiveEvents=e}},x3dom.X3DCanvas.prototype.bindEventListeners=function(){var e=this;if(this.onMouseDown=function(t){if(!this.isMulti){switch(this.focus(),this.classList.add("x3dom-canvas-mousedown"),t.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}t.shiftKey&&(this.mouse_button=1),t.ctrlKey&&(this.mouse_button=4),t.altKey&&(this.mouse_button=2);var i=this.parent.mousePosition(t);this.mouse_drag_x=i.x,this.mouse_drag_y=i.y,this.mouse_dragging=!0,this.parent.doc.onMousePress(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0}},this.onMouseUp=function(t){if(!this.isMulti){var i=this.mouse_button;this.classList.remove("x3dom-canvas-mousedown"),this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseRelease(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button,i),this.parent.doc.needRender=!0}},this.onMouseOver=function(t){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},this.onMouseOut=function(t){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.classList.remove("x3dom-canvas-mousedown"),this.parent.doc.onMouseOut(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0)},this.onDoubleClick=function(t){if(!this.isMulti){this.mouse_button=0;var i=this.parent.mousePosition(t);this.mouse_drag_x=i.x,this.mouse_drag_y=i.y,this.mouse_dragging=!1,this.parent.doc.onDoubleClick(e.gl,this.mouse_drag_x,this.mouse_drag_y),this.parent.doc.needRender=!0}},this.onMouseMove=function(t){if(!this.isMulti){var i=this.parent.mousePosition(t);i.x==e.lastMousePos.x&&i.y==e.lastMousePos.y||(e.lastMousePos=i,this.mouse_drag_x=i.x,this.mouse_drag_y=i.y,this.mouse_dragging?(t.shiftKey&&(this.mouse_button=1),t.ctrlKey&&(this.mouse_button=4),t.altKey&&(this.mouse_button=2),(1==this.mouse_button&&!this.parent.disableLeftDrag||2==this.mouse_button&&!this.parent.disableRightDrag||4==this.mouse_button&&!this.parent.disableMiddleDrag)&&this.parent.doc.onDrag(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button)):this.parent.doc.onMove(e.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,t.preventDefault(),t.stopPropagation())}},this.onDOMMouseScroll=function(t){if(!this.isMulti){this.focus();var i=this.parent.mousePosition(t).y;1==this.parent.doc._scene.getNavigationInfo()._vf.reverseScroll?this.mouse_drag_y-=2*t.detail:this.mouse_drag_y+=2*t.detail,this.parent.doc.onWheel(e.gl,this.mouse_drag_x,this.mouse_drag_y,i),this.parent.doc.needRender=!0,t.preventDefault(),t.stopPropagation()}},this.onKeyPress=function(e){this.parent.disableKeys||(e.preventDefault(),this.parent.doc.onKeyPress(e.charCode)),this.parent.doc.needRender=!0},this.onMouseWheel=function(t){if(!this.isMulti){this.focus();var i=this.parent.mousePosition(t).y;1==this.parent.doc._scene.getNavigationInfo()._vf.reverseScroll?this.mouse_drag_y+=.1*t.wheelDelta:this.mouse_drag_y-=.1*t.wheelDelta,this.parent.doc.onWheel(e.gl,this.mouse_drag_x,this.mouse_drag_y,i),this.parent.doc.needRender=!0,t.preventDefault(),t.stopPropagation()}},this.onKeyUp=function(e){this.parent.disableKeys||this.parent.doc.onKeyUp(e.keyCode),this.parent.doc.needRender=!0},this.onKeyDown=function(e){this.parent.disableKeys||this.parent.doc.onKeyDown(e.keyCode),this.parent.doc.needRender=!0},this.onVrDisplayPresentChange=function(e){if(this.vrDisplay&&this.vrDisplay.isPresenting){var t=this.vrDisplay.getEyeParameters("left"),i=this.vrDisplay.getEyeParameters("right");this._oldCanvasWidth=this.canvas.width,this._oldCanvasHeight=this.canvas.height,this.canvas.width=2*Math.max(t.renderWidth,i.renderWidth),this.canvas.height=Math.max(t.renderHeight,i.renderHeight),this.gl.VRMode=2,this.doc.needRender=!0}else this.vrDisplay&&!this.vrDisplay.isPresenting&&(this.canvas.width=this._oldCanvasWidth,this.canvas.height=this._oldCanvasHeight,this.vrFrameData=null,this.gl.VRMode=1,this.doc.needRender=!0)},null!==this.canvas&&null!==this.gl&&this.hasRuntime){this.canvas.mouse_dragging=!1,this.canvas.mouse_button=0,this.canvas.mouse_drag_x=0,this.canvas.mouse_drag_y=0,this.canvas.isMulti=!1,this.canvas.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},this.canvas.addEventListener("webglcontextlost",(function(e){x3dom.debug.logError("WebGL context lost"),e.preventDefault()}),!1),this.canvas.addEventListener("webglcontextrestored",(function(e){x3dom.debug.logError("recover WebGL state and resources on context lost NYI"),e.preventDefault()}),!1),window.addEventListener("vrdisplaypresentchange",this.onVrDisplayPresentChange.bind(this),!1),this.canvas.addEventListener("mousedown",this.onMouseDown,!1),this.canvas.addEventListener("mouseup",this.onMouseUp,!1),this.canvas.addEventListener("mouseover",this.onMouseOver,!1),this.canvas.addEventListener("mouseout",this.onMouseOut,!1),this.canvas.addEventListener("dblclick",this.onDoubleClick,!1),this.canvas.addEventListener("mousemove",this.onMouseMove,!1),this.canvas.addEventListener("DOMMouseScroll",this.onDOMMouseScroll,!1),this.canvas.addEventListener("mousewheel",this.onMouseWheel,!!this.supportsPassiveEvents&&{passive:!1}),this.canvas.addEventListener("keypress",this.onKeyPress,!0),this.canvas.addEventListener("keyup",this.onKeyUp,!0),this.canvas.addEventListener("keydown",this.onKeyDown,!0);var t={numTouches:0,firstTouchTime:(new Date).getTime(),firstTouchPoint:new x3dom.fields.SFVec2f(0,0),lastPos:new x3dom.fields.SFVec2f,lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,lastLayer:[],examineNavType:1,calcAngle:function(e){var t=e.normalize().dot(new x3dom.fields.SFVec2f(1,0));return t=Math.acos(t),e.y<0&&(t=Math.PI+(Math.PI-t)),t},disableTouch:this.disableTouch,visMarker:this.showTouchpoints,visMarkerBag:[],visualizeTouches:function(e){if(this.visMarker){for(var t=[],i=null,s=0;s<e.touches.length;s++){var o=e.touches[s].identifier||e.touches[s].streamId;o||(o=0);var n=this.visMarkerBag.indexOf(o);n>=0?((i=document.getElementById("visMarker"+o)).style.left=e.touches[s].pageX+"px",i.style.top=e.touches[s].pageY+"px"):((i=document.createElement("div")).appendChild(document.createTextNode("#"+o)),i.id="visMarker"+o,i.className="x3dom-touch-marker",document.body.appendChild(i),n=this.visMarkerBag.length,this.visMarkerBag[n]=o),t.push(o)}for(var r=this.visMarkerBag.length-1;r>=0;r--){var a=this.visMarkerBag[r];t.indexOf(a)<0&&(this.visMarkerBag.splice(r,1),i=document.getElementById("visMarker"+a),document.body.removeChild(i))}}}};this.disableTouch||(this.canvas.addEventListener("touchstart",(function(i,s){var o,n;switch(this.isMulti=!0,i.preventDefault(),t.visualizeTouches(i),this.focus(),null==s&&(s=this.parent.doc),s._scene.getNavigationInfo().getType()){case"examine":t.examineNavType=1;break;case"turntable":t.examineNavType=2;break;default:t.examineNavType=0}for(t.lastLayer=[],o=0;o<i.touches.length;o++)n=this.parent.mousePosition(i.touches[o]),t.lastLayer.push([i.touches[o].identifier,new x3dom.fields.SFVec2f(n.x,n.y)]);if(t.numTouches<1&&1==i.touches.length)t.numTouches=1,t.lastDrag=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY);else if(t.numTouches<2&&i.touches.length>=2){t.numTouches=2;var r=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY),a=new x3dom.fields.SFVec2f(i.touches[1].screenX,i.touches[1].screenY).subtract(r),d=a.multiply(.5).add(r),h=a.dot(a);t.lastMiddle=d,t.lastSquareDistance=h,t.lastAngle=t.calcAngle(a),t.lastPos=this.parent.mousePosition(i.touches[0])}if(s._scene.updateVolume(),1==t.examineNavType)for(o=0;o<i.touches.length;o++)n=this.parent.mousePosition(i.touches[o]),s.onPick(e.gl,n.x,n.y),s._viewarea.prepareEvents(n.x,n.y,0,"onmouseover"),s._viewarea.prepareEvents(n.x,n.y,1,"onmousedown"),s._viewarea._pickingInfo.lastClickObj=s._viewarea._pickingInfo.pickObj;else i.touches.length&&(n=this.parent.mousePosition(i.touches[0]),s.onMousePress(e.gl,n.x,n.y,1));s.needRender=!0}),!this.supportsPassiveEvents||{passive:!1}),this.canvas.addEventListener("touchmove",(function(i,s){i.preventDefault(),t.visualizeTouches(i),null==s&&(s=this.parent.doc);var o,n,r,a,d,h,l,f=null,u=null;if(1==t.examineNavType){if(1==i.touches.length){var _=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY),c=_.subtract(t.lastDrag);t.lastDrag=_;var m=x3dom.fields.SFMatrix4f.rotationY(c.x/100),p=x3dom.fields.SFMatrix4f.rotationX(c.y/100);u=m.mult(p),s.onMoveView(e.gl,i,t,null,u),f=this.parent.mousePosition(i.touches[0]),s.onPick(e.gl,f.x,f.y),s._viewarea.prepareEvents(f.x,f.y,1,"onmousemove")}else if(i.touches.length>=2){o=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY),r=(n=new x3dom.fields.SFVec2f(i.touches[1].screenX,i.touches[1].screenY).subtract(o)).multiply(.5).add(o),a=n.dot(n),d=r.subtract(t.lastMiddle),h=a-t.lastSquareDistance,l=new x3dom.fields.SFVec3f(d.x/screen.width,-d.y/screen.height,h/(screen.width*screen.height*.2));var x=t.calcAngle(n),v=t.lastAngle-x;t.lastAngle=x,u=x3dom.fields.SFMatrix4f.rotationZ(v),t.lastMiddle=r,t.lastSquareDistance=a,s.onMoveView(e.gl,i,t,l,u)}}else i.touches.length&&(2==t.examineNavType&&i.touches.length>=2?(o=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY),h=((a=(n=new x3dom.fields.SFVec2f(i.touches[1].screenX,i.touches[1].screenY).subtract(o)).dot(n))-t.lastSquareDistance)/(.1*(screen.width+screen.height)),t.lastPos.y+=h,t.lastSquareDistance=a,s.onDrag(e.gl,t.lastPos.x,t.lastPos.y,2)):(f=this.parent.mousePosition(i.touches[0]),s.onDrag(e.gl,f.x,f.y,1)));s.needRender=!0}),!this.supportsPassiveEvents||{passive:!1}),this.canvas.addEventListener("touchend",(function(i,s){if(this.isMulti=!1,i.cancelable&&i.preventDefault(),t.visualizeTouches(i),null==s&&(s=this.parent.doc),s._viewarea._isMoving=!1,2==t.numTouches&&1==i.touches.length&&(t.lastDrag=new x3dom.fields.SFVec2f(i.touches[0].screenX,i.touches[0].screenY)),0==i.touches.length){for(var o=s._nodeBag.affectedPointingSensors,n=0;n<o.length;++n)o[n].pointerReleased();s._nodeBag.affectedPointingSensors=[]}var r=!1;if(i.touches.length<2&&(1==t.numTouches&&(r=!0),t.numTouches=i.touches.length),1==t.examineNavType){for(n=0;n<t.lastLayer.length;n++){var a=t.lastLayer[n][1];if(s.onPick(e.gl,a.x,a.y),"box"!==s._scene._vf.pickMode.toLowerCase())s._viewarea.prepareEvents(a.x,a.y,1,"onmouseup"),s._viewarea._pickingInfo.lastClickObj=s._viewarea._pickingInfo.pickObj,s._viewarea._pickingInfo.pickObj&&s._viewarea._pickingInfo.pickObj===s._viewarea._pickingInfo.lastClickObj&&s._viewarea.prepareEvents(a.x,a.y,1,"onclick");else{var d=s._viewarea.calcViewRay(a.x,a.y),h=s._scene.doIntersect(d),l=d.hitObject;h&&l&&(s._viewarea._pick.setValues(d.hitPoint),s._viewarea.checkEvents(l,a.x,a.y,1,"onclick"),x3dom.debug.logInfo("Hit '"+l._xmlNode.localName+"/ "+l._DEF+"' at pos "+s._viewarea._pick))}}if(r){var f=(new Date).getTime();t.firstTouchPoint.subtract(t.lastDrag).length()<18&&f-t.firstTouchTime<180&&s.onDoubleClick(e.gl,0,0),t.firstTouchTime=f,t.firstTouchPoint=t.lastDrag}}else t.lastLayer.length&&(a=t.lastLayer[0][1],s.onMouseRelease(e.gl,a.x,a.y,0,1));s.needRender=!0}),!0))}},x3dom.X3DCanvas.prototype._initContext=function(e){x3dom.debug.logInfo("Initializing X3DCanvas for ["+e.id+"]");var t=x3dom.gfx_webgl(e,this.x3dElem);return t?(parseFloat(x3dom.caps.VERSION.match(/\d+\.\d+/)[0])<1&&x3dom.debug.logError("WebGL version "+x3dom.caps.VERSION+" lacks important WebGL/GLSL features needed for shadows, special vertex attribute types, etc.!"),t):(x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(e),null)},x3dom.X3DCanvas.prototype.appendParam=function(e,t,i){var s=document.createElement("param");s.setAttribute("name",t),s.setAttribute("value",i),e.appendChild(s)},x3dom.X3DCanvas.prototype._createInitFailedDiv=function(e){var t=document.createElement("div");t.setAttribute("id","x3dom-create-init-failed"),t.style.width=e.getAttribute("width"),t.style.height=e.getAttribute("height"),t.style.backgroundColor="#C00",t.style.color="#FFF",t.style.fontSize="20px",t.style.fontWidth="bold",t.style.padding="10px 10px 10px 10px",t.style.display="inline-block",t.style.fontFamily="Helvetica",t.style.textAlign="center",t.appendChild(document.createTextNode("Your Browser does not support X3DOM")),t.appendChild(document.createElement("br")),t.appendChild(document.createTextNode("Read more about Browser support on:")),t.appendChild(document.createElement("br"));var i=document.createElement("a");i.setAttribute("href","http://www.x3dom.org/?page_id=9"),i.appendChild(document.createTextNode("X3DOM | Browser Support")),t.appendChild(i);var s=e.getAttribute("altImg")||null;s&&((new Image).src=s,t.style.backgroundImage="url("+s+")",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="50% 50%");e.appendChild(t),x3dom.debug.logError("Your Browser does not support X3DOM!")},x3dom.X3DCanvas.prototype._createHTMLCanvas=function(e){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var t=document.createElement("canvas");t.setAttribute("class","x3dom-canvas"),e.getAttribute("style")&&x3dom.debug.logInfo("Inline X3D styles detected");for(var i=["onmousedown","onmousemove","onmouseout","onmouseover","onmouseup","onclick","ondblclick","onkeydown","onkeypress","onkeyup","ontouchstart","ontouchmove","ontouchend","ontouchcancel","ontouchleave","ontouchenter","ondragstart","ondrop","ondragover"],s=0;s<i.length;s++){var o=i[s],n=e.getAttribute(o);n&&(x3dom.debug.logInfo(o+", "+n),t.setAttribute(o,n),e.removeAttribute(o))}var r=e.getAttribute("draggable");r&&(x3dom.debug.logInfo("draggable="+r),t.setAttribute("draggable",r)),e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.__removeEventListener=e.removeEventListener,e.addEventListener=function(e,s,o){var n,r=!1;for(n=0;n<i.length&&!r;n++)i[n]===e&&(r=!0);r?(x3dom.debug.logInfo("addEventListener for div.on"+e),t.addEventListener(e,s,o)):(x3dom.debug.logInfo("addEventListener for X3D.on"+e),this.__addEventListener(e,s,o))},e.removeEventListener=function(e,s,o){var n,r=!1;for(n=0;n<i.length&&!r;n++)i[n]===e&&(r=!0);r?(x3dom.debug.logInfo("removeEventListener for div.on"+e),t.removeEventListener(e,s,o)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+e),this.__removeEventListener(e,s,o))}),e.hasAttribute("ondownloadsfinished")&&e.addEventListener("downloadsfinished",(function(){var t={target:e,type:"downloadsfinished"},i=e.getAttribute("ondownloadsfinished");new Function("event",i).call(e,t)}),!0),e.appendChild(t);var a,d,h=e.getAttribute("id");if(null!==h)t.id="x3dom-"+h+"-canvas";else{var l=(new Date).getTime();t.id="x3dom-"+l+"-canvas"}return e.style=e.style||{},null!==(a=e.getAttribute("width"))&&(a.indexOf("%")>=0&&x3dom.debug.logWarning("The width attribute is to be specified in pixels not in percent."),t.style.width=a,e.style.width=a,t.setAttribute("width",a)),null!==(d=e.getAttribute("height"))&&(d.indexOf("%")>=0&&x3dom.debug.logWarning("The height attribute is to be specified in pixels not in percent."),t.style.height=d,e.style.height=d,t.setAttribute("height",d)),t.setAttribute("tabindex","0"),t},x3dom.X3DCanvas.prototype._watchForResize=function(){if(!this.vrDisplay||!this.vrDisplay.isPresenting){var e=[parseInt(x3dom.getStyle(this.canvas,"width"))||0,parseInt(x3dom.getStyle(this.canvas,"height"))||0];this._current_dim[0]==e[0]&&this._current_dim[1]==e[1]||(this._current_dim=e,this.x3dElem.setAttribute("width",e[0]+"px"),this.x3dElem.setAttribute("height",e[1]+"px"))}},x3dom.X3DCanvas.prototype._createProgressDiv=function(){var e=document.createElement("div");e.setAttribute("class","x3dom-progress");var t=document.createElement("div");t.setAttribute("class","x3dom-progress-spinner"),e.appendChild(t);var i=document.createElement("div");return i.setAttribute("id","x3domProgessCount"),i.appendChild(document.createTextNode("Loading...")),e.appendChild(i),e.oncontextmenu=e.onmousedown=function(e){return e.preventDefault(),e.stopPropagation(),!1},e},x3dom.X3DCanvas.prototype._createVRDiv=function(){var e=document.createElement("div");return e.setAttribute("class","x3dom-vr"),e.onclick=function(){this.x3dElem.runtime.toggleVR()}.bind(this),e.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1},e},x3dom.X3DCanvas.prototype.mousePosition=function(e){var t=e.target.getBoundingClientRect(),i=Math.round(e.clientX-t.left)*this.devicePixelRatio,s=Math.round(e.clientY-t.top)*this.devicePixelRatio;return new x3dom.fields.SFVec2f(i,s)},x3dom.X3DCanvas.prototype.tick=function(e){this._elapsedTime=this._totalTime?e-this._totalTime:0,this._totalTime=e;var t=this.x3dElem.runtime,i=(new Date).getTime(),s=i-this.lastTimeFPSWasTaken;this.fps_t0;this.fps_t0=i,this.doc.advanceTime(i/1e3);var o,n=(new Date).getTime()-i;if(this.doc.hasAnimationStateChanged()&&(this.doc.isAnimating()?t.onAnimationStarted():t.onAnimationFinished()),this.doc.needRender&&(s>=1e3&&(t.fps=this.framesSinceLastTime/(s/1e3),t.addMeasurement("FPS",t.fps),this.framesSinceLastTime=0,this.lastTimeFPSWasTaken=i),this.framesSinceLastTime++,t.addMeasurement("ANIM",n),0==t.isReady&&(t.ready(),t.isReady=!0),t.enterFrame({total:this._totalTime,elapsed:this._elapsedTime}),this.vrDisplay&&this.vrDisplay.isPresenting?(this.vrFrameData||(this.vrFrameData=new VRFrameData),this.vrDisplay.getFrameData(this.vrFrameData)):this.doc.needRender=!1,this.doc.render(this.gl,this.vrFrameData,this.vrDisplay),this.doc._scene._vf.doPickPass||t.removeMeasurement("PICKING"),t.exitFrame({total:this._totalTime,elapsed:this._elapsedTime}),this.vrDisplay&&this.vrDisplay.isPresenting&&this.vrDisplay.submitFrame()),this.progressDiv)if(this.doc.downloadCount>0?t.addInfo("#LOADS:",this.doc.downloadCount):t.removeInfo("#LOADS:"),"false"!==this.doc.properties.getProperty("showProgress")){if(this.progressDiv){var r=Math.max(+this.doc.downloadCount,0);this.progressDiv.childNodes[1].textContent=""+r,this.doc.downloadCount>0?this.progressDiv.style.opacity="1":this.progressDiv.style.opacity="0"}}else this.progressDiv.style.opacity="0";this.doc.downloadCount<=0&&this.doc.previousDownloadCount>0&&(document.createEvent?((o=document.createEvent("Events")).initEvent("downloadsfinished",!0,!0),this.x3dElem.dispatchEvent(o)):document.createEventObject&&(o=document.createEventObject(),this.x3dElem.fireEvent("ondownloadsfinished",o)));this.doc.previousDownloadCount=this.doc.downloadCount},x3dom.X3DCanvas.prototype.load=function(e,t,i){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,i);var s=this;this.doc.onload=function(){s.hasRuntime?function e(t){s.doc&&s.x3dElem.runtime&&(s._watchForResize(),s.tick(t),navigator.getVRDisplays&&null===s.vrDisplay?(s.vrDisplayPromise||(s.vrDisplayPromise=navigator.getVRDisplays()),s.vrDisplayPromise.then((function(t){t[0]?(s.vrDisplay=t[0],s.vrDisplay.requestAnimationFrame(e,s),s.vrDiv.style.display="block"):(s.vrDisplay=void 0,window.requestAnimFrame(e,s))})).catch((function(t){s.vrDisplay=void 0,window.requestAnimFrame(e,s)}))):navigator.getVRDisplays&&s.vrDisplay?s.vrDisplay.requestAnimationFrame(e,s):window.requestAnimFrame(e,s))}():s.tick()},this.x3dElem.render=function(){s.hasRuntime?s.doc.needRender=!0:s.doc.render(s.gl)},this.x3dElem.context=s.gl.ctx3d,this.doc.onerror=function(){alert("Failed to load X3D document")},this.doc.load(e,t)},x3dom.InputTypes={NAVIGATION:1,INTERACTION:2},x3dom.Viewarea=function(e,t){this._doc=e,this._scene=t,e._nodeBag.viewarea.push(this),this._pickingInfo={pickPos:new x3dom.fields.SFVec3f(0,0,0),pickNorm:new x3dom.fields.SFVec3f(0,0,1),pickObj:null,firstObj:null,lastObj:null,lastClickObj:null,shadowObjectId:-1},this._currentInputType=x3dom.InputTypes.NAVIGATION,this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0,this._deltaT=0,this._flyMat=null,this._pitch=0,this._yaw=0,this._eyePos=new x3dom.fields.SFVec3f(0,0,0),this._width=400,this._height=300,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._points=0,this._numRenderedNodes=0,this._pick=new x3dom.fields.SFVec3f(0,0,0),this._pickNorm=new x3dom.fields.SFVec3f(0,0,1),this._isAnimating=!1,this._isMoving=!1,this._lastTS=0,this._mixer=new x3dom.MatrixMixer,this._interpolator=new x3dom.FieldInterpolator,this._animationStateChanged=!1,this.vrFrameData=null,this.gamepads=null,this.vrLeftViewMatrix=new x3dom.fields.SFMatrix4f,this.vrRightViewMatrix=new x3dom.fields.SFMatrix4f,this.vrLeftProjMatrix=new x3dom.fields.SFMatrix4f,this.vrRightProjMatrix=new x3dom.fields.SFMatrix4f,this.vrControllerManager=new x3dom.VRControllerManager,this._inverseDevicePixelRatio=1/window.devicePixelRatio,this.arc=null},x3dom.Viewarea.prototype.setVRFrameData=function(e){this.vrFrameData=e,this.vrFrameData&&(this.vrLeftViewMatrix.setFromArray(this.vrFrameData.leftViewMatrix),this.vrRightViewMatrix.setFromArray(this.vrFrameData.rightViewMatrix))},x3dom.Viewarea.prototype.updateGamepads=function(e){this.vrControllerManager.update(this,e)},x3dom.Viewarea.prototype.tick=function(e){if(this._scene.getEnvironment()._vf.enableARC&&null==this.arc&&(this.arc=new x3dom.arc.AdaptiveRenderControl(this._scene)),this._mixer.isActive()){if(this._mixer._isVPtarget){var t=this._scene.getViewpoint();t.resetView();var i=t.getViewMatrix().mult(t.getCurrentTransform().inverse());this._mixer.setEndMatrix(i)}var s=this._mixer.mix(e);this._scene.getViewpoint().setView(s)}if(this._interpolator.isActive()){var o=this._interpolator.interpolate(e);this._scene.getViewpoint().setZoom(o)}var n=this.navigateTo(e),r=this._isAnimating;return this._lastTS=e,this._isAnimating=this._mixer.isMixing||this._interpolator.isInterpolating||n,this._isAnimating!=r?this._animationStateChanged=!0:this._animationStateChanged=!1,null!=this.arc&&this.arc.update(this.isMovingOrAnimating()?1:0,this._doc._x3dElem.runtime.getFPS()),this._isAnimating||r},x3dom.Viewarea.prototype.isMoving=function(){return this._isMoving},x3dom.Viewarea.prototype.isAnimating=function(){return this._isAnimating},x3dom.Viewarea.prototype.hasAnimationStateChanged=function(){return this._animationStateChanged},x3dom.Viewarea.prototype.isMovingOrAnimating=function(){return this._isMoving||this._isAnimating},x3dom.Viewarea.prototype.navigateTo=function(e){return this._scene.getNavigationInfo()._impl.navigateTo(this,e)},x3dom.Viewarea.prototype.moveFwd=function(){this._scene.getNavigationInfo()._impl.moveForward(this)},x3dom.Viewarea.prototype.moveBwd=function(){this._scene.getNavigationInfo()._impl.moveBackwards(this)},x3dom.Viewarea.prototype.strafeRight=function(){this._scene.getNavigationInfo()._impl.strafeRight(this)},x3dom.Viewarea.prototype.strafeLeft=function(){this._scene.getNavigationInfo()._impl.strafeLeft(this)},x3dom.Viewarea.prototype.animateTo=function(e,t,i){this._scene.getNavigationInfo()._impl.animateTo(this,e,t,i)},x3dom.Viewarea.prototype.orthoAnimateTo=function(e,t,i){this._scene.getNavigationInfo()._impl.orthoAnimateTo(this,e,t,i)},x3dom.Viewarea.prototype.zoom=function(e){this._scene.getNavigationInfo()._impl.zoom(this,e)},x3dom.Viewarea.prototype.getLights=function(){for(var e=[],t=0;t<this._doc._nodeBag.lights.length;t++)1==this._doc._nodeBag.lights[t]._vf.on&&e.push(this._doc._nodeBag.lights[t]);return e},x3dom.Viewarea.prototype.getLightsShadow=function(){for(var e=this._doc._nodeBag.lights,t=0;t<e.length;t++)if(e[t]._vf.shadowIntensity>0)return!0;return!1},x3dom.Viewarea.prototype.hasPhysicalEnvironmentLight=function(){for(var e=0;e<this._doc._nodeBag.lights.length;e++){var t=this._doc._nodeBag.lights[e];if(x3dom.isa(t,x3dom.nodeTypes.PhysicalEnvironmentLight)&&t._vf.on)return!0}return!1},x3dom.Viewarea.prototype.updateSpecialNavigation=function(e,t){var i=this._scene.getNavigationInfo();if("helicopter"==i.getType()&&!i._heliUpdated){var s=i.getTypeParams(),o=s[0],n=e.getViewMatrix().mult(t.inverse()).inverse();this._from=n.e3(),this._at=this._from.subtract(n.e2()),this._up=new x3dom.fields.SFVec3f(0,1,0),this._from.y=s[1],this._at.y=this._from.y;var r=n.e0(),a=x3dom.fields.Quaternion.axisAngle(r,o).toMatrix(),d=x3dom.fields.SFMatrix4f.translation(this._from);d=d.mult(a),a=x3dom.fields.SFMatrix4f.translation(this._from.negate()),d=d.mult(a),this._at=d.multMatrixPnt(this._at),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),this._scene.getViewpoint().setView(this._flyMat.inverse()),i._heliUpdated=!0}},x3dom.Viewarea.prototype.getViewpointMatrix=function(){var e=this._scene.getViewpoint(),t=e.getCurrentTransform();return this.updateSpecialNavigation(e,t),e.getViewMatrix().mult(t.inverse())},x3dom.Viewarea.prototype.getViewMatrix=function(){return this.vrFrameData?this.vrLeftViewMatrix:this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)},x3dom.Viewarea.prototype.getViewMatrices=function(){if(this.vrFrameData)return[this.vrLeftViewMatrix,this.vrRightViewMatrix];var e=this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat);return[e,e]},x3dom.Viewarea.prototype.getLightMatrix=function(e){var t,i=(e=e||this._doc._nodeBag.lights).length;if(i>0){var s=this._scene.getVolume();if(s.isValid()){var o=x3dom.fields.SFVec3f.MAX(),n=x3dom.fields.SFVec3f.MIN();s.getBounds(o,n);var r=[],a=this._scene.getViewpoint().getFieldOfView(),d=n.subtract(o),h=d.y/2/Math.tan(a/2)+d.z/2,l=d.x/2/Math.tan(a/2)+d.z/2;for(d=o.add(d.multiply(.5)),t=0;t<i;t++){var f=e[t];if(x3dom.isa(f,x3dom.nodeTypes.PointLight)){var u=f.getCurrentTransform().multMatrixPnt(f._vf.location);d=d.subtract(u).normalize()}else{var _=f.getCurrentTransform().multMatrixVec(f._vf.direction);_=_.normalize().negate(),d=d.add(_.multiply(1.2*(h>l?h:l)))}r.push(f.getViewMatrix(d))}return r}}return Array(i||1).fill(this.getViewMatrix())},x3dom.Viewarea.prototype.getWCtoLCMatrix=function(e){var t,i=this.getProjectionMatrix();return t=0===arguments.length?this.getLightMatrix()[0]:e,i.mult(t)},x3dom.Viewarea.prototype.getWCtoLCMatricesPointLight=function(e,t,i){var s=t._vf.zNear,o=t._vf.zFar,n=this.getLightProjectionMatrix(e,s,o,!1,i);n._00=1,n._11=1;var r,a=[];a[0]=n.mult(e);for(var d=1;d<=3;d++)r=x3dom.fields.SFMatrix4f.rotationY(d*Math.PI/2),a[d]=n.mult(r.mult(e));return r=x3dom.fields.SFMatrix4f.rotationX(Math.PI/2),a[4]=n.mult(r.mult(e)),r=x3dom.fields.SFMatrix4f.rotationX(3*Math.PI/2),a[5]=n.mult(r.mult(e)),a},x3dom.Viewarea.prototype.getWCtoLCMatricesCascaded=function(e,t,i){var s=Math.max(1,Math.min(t._vf.shadowCascades,6)),o=Math.max(0,Math.min(t._vf.shadowSplitFactor,1)),n=Math.max(0,Math.min(t._vf.shadowSplitOffset,1)),r=x3dom.isa(t,x3dom.nodeTypes.SpotLight),a=t._vf.zNear,d=t._vf.zFar,h=this.getLightProjectionMatrix(e,a,d,!0,i);r&&(h._00=1,h._11=1);var l=h.mult(e),f=[];if(1==s)return f[0]=l,f;for(var u=this.getShadowSplitDepths(s,o,n,!0,i),_=0;_<s;_++){var c=this.getLightFittingMatrix(l,u[_],u[_+1],i);f[_]=c.mult(l)}return f},x3dom.Viewarea.prototype.getLightProjectionMatrix=function(e,t,i,s,o){var n=x3dom.fields.SFMatrix4f.copy(o);if(!s||t>0||i>0){var r,a,d=e.inverse().e3(),h=x3dom.fields.SFVec3f.copy(this._scene._lastMin),l=x3dom.fields.SFVec3f.copy(this._scene._lastMax).subtract(h),f=l.length()/2,u=h.add(l.multiply(.5)),_=d.subtract(u).length();return f&&(r=_>f?.8*(_-f):1,a=1.2*(_+f)),t>0&&(r=t),i>0&&(a=i),n._22=-(a+r)/(a-r),n._23=-2*a*r/(a-r),n}return this.getLightCropMatrix(n.mult(e)).mult(n)},x3dom.Viewarea.prototype.getProjectionMatrix=function(){return this.vrFrameData?this.vrLeftProjMatrix.setFromArray(this.vrFrameData.leftProjectionMatrix):this._scene.getViewpoint().getProjectionMatrix(this._width/this._height)},x3dom.Viewarea.prototype.getProjectionMatrices=function(){if(this.vrFrameData)return[this.vrLeftProjMatrix.setFromArray(this.vrFrameData.leftProjectionMatrix),this.vrRightProjMatrix.setFromArray(this.vrFrameData.rightProjectionMatrix)];var e=this._scene.getViewpoint().getProjectionMatrix(this._width/this._height);return[e,e]},x3dom.Viewarea.prototype.getViewfrustum=function(e){var t=this._scene.getEnvironment();if(1==t._vf.frustumCulling){if(0==arguments.length){var i=this.getProjectionMatrix(),s=this.getViewMatrix();return new x3dom.fields.FrustumVolume(i.mult(s))}return new x3dom.fields.FrustumVolume(e)}return null},x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var e=this.getViewMatrix();return this.getProjectionMatrix().mult(e)},x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){return this.getWCtoCCMatrix().inverse()},x3dom.Viewarea.prototype.calcViewRay=function(e,t,i){var s=i||this.getCCtoWCMatrix(),o=e/(this._width-1)*2-1,n=(this._height-1-t)/(this._height-1)*2-1,r=s.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,n,-1)),a=s.multFullMatrixPnt(new x3dom.fields.SFVec3f(o,n,1)).subtract(r);return new x3dom.fields.Ray(r,a)},x3dom.Viewarea.prototype.showAll=function(e,t){void 0===e&&(e="negZ"),void 0===t&&(t=!1);var i=this._scene;i.updateVolume();var s,o=x3dom.fields.SFVec3f.copy(i._lastMin),n=x3dom.fields.SFVec3f.copy(i._lastMax),r="x",a="y",d="z",h=1,l=new x3dom.fields.SFVec3f(0,0,-1);switch(e){case"posX":h=-1;case"negX":d="x",r="y",a="z",s=new x3dom.fields.SFVec3f(h,0,0);break;case"posY":h=-1;case"negY":d="y",r="z",a="x",s=new x3dom.fields.SFVec3f(0,h,0);break;case"posZ":h=-1;case"negZ":default:s=new x3dom.fields.SFVec3f(0,0,-h)}var f=i.getViewpoint(),u=f.getFieldOfView(),_=x3dom.isa(f,x3dom.nodeTypes.OrthoViewpoint),c=n.subtract(o),m=c.multiply(.5),p=o.add(m);t&&f.setCenterOfRotation(p);var x=Math.min(this._width/this._height,1),v=c[d]/2,g=Math.tan(u/2),y=c[a]/2/g+v,S=c[r]/2/g+v;(c=o.add(c.multiply(.5)))[d]+=_?h*(y>S?y:S)*3.01:h*(y>S?y:S)*1.01,c[d]/=x;var T=x3dom.fields.Quaternion.rotateFromTo(l,s).toMatrix();T=T.mult(x3dom.fields.SFMatrix4f.translation(c.negate())),_?(this.orthoAnimateTo(y,Math.abs(f._fieldOfView[0])),this.animateTo(T,f)):this.animateTo(T,f)},x3dom.Viewarea.prototype.fit=function(e,t,i){var s=this._scene.getViewpoint(),o=this.getFitViewMatrix(e,t,s,i);x3dom.isa(s,x3dom.nodeTypes.OrthoViewpoint)?(this.orthoAnimateTo(dist/2.01,Math.abs(s._fieldOfView[0])),this.animateTo(o,s)):this.animateTo(o,s)},x3dom.Viewarea.prototype.getFitViewMatrix=function(e,t,i,s){void 0===s&&(s=!0);var o=t.subtract(e).multiply(.5),n=e.add(o),r=o.length(),a=i.getFieldOfView(),d=x3dom.fields.SFMatrix4f.copy(this.getViewMatrix()),h=new x3dom.fields.SFVec3f(d._00,d._01,d._02),l=new x3dom.fields.SFVec3f(d._10,d._11,d._12),f=new x3dom.fields.SFVec3f(d._20,d._21,d._22),u=Math.min(this._width/this._height,1),_=r/Math.tan(a/2)/u,c=n.add(f.multiply(_));return d._03=-h.dot(c),d._13=-l.dot(c),d._23=-f.dot(c),s&&i.setCenterOfRotation(n),d},x3dom.Viewarea.prototype.resetView=function(){this._scene.getNavigationInfo()._impl.resetView(this)},x3dom.Viewarea.prototype.resetNavHelpers=function(){this._rotMat=x3dom.fields.SFMatrix4f.identity(),this._transMat=x3dom.fields.SFMatrix4f.identity(),this._movement=new x3dom.fields.SFVec3f(0,0,0),this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.uprightView=function(){var e=this.getViewMatrix().inverse(),t=e.e3(),i=t.subtract(e.e2()),s=new x3dom.fields.SFVec3f(0,1,0),o=e.e2().cross(s).normalize().cross(s).normalize();i=t.add(o),e=(e=x3dom.fields.SFMatrix4f.lookAt(t,i,s)).inverse(),this.animateTo(e,this._scene.getViewpoint())},x3dom.Viewarea.prototype.callEvtHandler=function(e,t,i){if(!e||!e._xmlNode)return null;try{var s=e._xmlNode,o=s[t];if("function"==typeof o)o.call(s,i);else if(s.hasAttribute(t)){var n=s.getAttribute(t);new Function("event",n).call(s,i)}var r=e._listeners[i.type];if(r)for(var a=0;a<r.length;a++)r[a].call(s,i)}catch(e){x3dom.debug.logException(e)}return i.cancelBubble},x3dom.Viewarea.prototype.checkEvents=function(e,t,i,s,o){var n,r,a,d=this,h=!0,l=e&&e._xmlNode?e._xmlNode:{},f=this._doc._nodeBag.affectedPointingSensors,u={viewarea:d,target:l,type:o.substr(2,o.length-2),button:s,layerX:t*this._inverseDevicePixelRatio,layerY:i*this._inverseDevicePixelRatio,worldX:d._pick.x,worldY:d._pick.y,worldZ:d._pick.z,normalX:d._pickNorm.x,normalY:d._pickNorm.y,normalZ:d._pickNorm.z,hitPnt:d._pick.toGL(),hitObject:l,shadowObjectId:d._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};try{var _=e;_&&_._xmlNode&&_._cf.geometry&&!_._xmlNode[o]&&!_._xmlNode.hasAttribute(o)&&!_._listeners[u.type]&&(_=_._cf.geometry.node),_&&!0===d.callEvtHandler(_,o,u)&&(h=!1)}catch(e){x3dom.debug.logException(e)}var c=function(e){e._parentNodes.forEach((function(e){if(e._xmlNode&&(e._xmlNode[o]||e._xmlNode.hasAttribute(o)||e._listeners[u.type])&&!0===d.callEvtHandler(e,o,u)&&(h=!1),0==s&&0==f.length&&("onmousemove"==o||"onmouseover"==o||"onmouseout"==o))for(a=e._childNodes.length,r=0;r<a;++r)n=e._childNodes[r],x3dom.isa(n,x3dom.nodeTypes.X3DPointingDeviceSensorNode)&&n._vf.enabled&&-1==f.indexOf(n)&&f.push(n);x3dom.isa(e,x3dom.nodeTypes.Anchor)&&"onclick"===o?(e.handleTouch(),h=!1):h&&c(e)}))};return h&&e&&c(e),h},x3dom.Viewarea.prototype._notifyAffectedPointingSensors=function(e){var t,i={mousedown:"pointerPressedOverSibling",mousemove:"pointerMoved",mouseover:"pointerMovedOver",mouseout:"pointerMovedOut"}[e.type],s=this._doc._nodeBag.affectedPointingSensors,o=s.length;if(o>0&&void 0!==i)for(t=0;t<o;t++)s[t][i](e)},x3dom.Viewarea.prototype.initMouseState=function(){this._deltaT=0,this._dx=0,this._dy=0,this._lastX=-1,this._lastY=-1,this._pressX=-1,this._pressY=-1,this._lastButton=0,this._isMoving=!1,this._needNavigationMatrixUpdate=!0},x3dom.Viewarea.prototype.onMousePress=function(e,t,i){(this._needNavigationMatrixUpdate=!0,this.prepareEvents(e,t,0,"onmouseover"),this.prepareEvents(e,t,i,"onmousedown"),this._pickingInfo.lastClickObj=this._pickingInfo.pickObj,this._pickingInfo.firstObj=this._pickingInfo.pickObj,this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._pressX=e,this._pressY=t,this._lastButton=i,this._isMoving=!1,this._currentInputType==x3dom.InputTypes.NAVIGATION)&&this._scene.getNavigationInfo()._impl.onMousePress(this,e,t,i)},x3dom.Viewarea.prototype.onMouseRelease=function(e,t,i,s){var o,n,r=this._doc._nodeBag.affectedPointingSensors;for(o=0;o<r.length;++o)r[o].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[];var a=this._scene.getNavigationInfo(),d=a.getType(),h=this._scene._vf.pickMode.toLowerCase();if("box"!==h){if(this.prepareEvents(e,t,s,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj)this.prepareEvents(e,t,s,"onclick");else if(!this._pickingInfo.pickObj&&!this._pickingInfo.lastClickObj&&!this._pickingInfo.firstObj){var l="backgroundClicked";try{if(this._scene._xmlNode&&(this._scene._xmlNode["on"+l]||this._scene._xmlNode.hasAttribute("on"+l)||this._scene._listeners[l])){var f={target:this._scene._xmlNode,type:l,button:s,layerX:e*this._inverseDevicePixelRatio,layerY:t*this._inverseDevicePixelRatio,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._scene.callEvtHandler("on"+l,f)}}catch(e){x3dom.debug.logException("backgroundClicked: "+e)}}}else{var u=(new Date).getTime(),_=this.calcViewRay(e,t),c=this._scene.doIntersect(_),m=_.hitObject;c&&m&&(this._pick.setValues(_.hitPoint),this.checkEvents(m,e,t,i,"onclick"),x3dom.debug.logInfo("Hit '"+m._xmlNode.localName+"/ "+m._DEF+"' at dist="+_.dist.toFixed(4)),"color"===h?x3dom.debug.logInfo("Ray hit color "+this._pick):"idbufid"===h||"texcoord"===h?x3dom.debug.logInfo("Ray hit data "+this._pick):x3dom.debug.logInfo("Ray hit at position "+this._pick.x.toFixed(4)+" "+this._pick.y.toFixed(4)+" "+this._pick.z.toFixed(4)));var p=(new Date).getTime()-u;if(x3dom.debug.logInfo("Picking time (box): "+p+"ms"),!c){var x=(n=this.getViewMatrix().e2().negate()).dot(_.pos.negate())/n.dot(_.dir);this._pick=_.pos.add(_.dir.multiply(x))}}if(this._pickingInfo.firstObj=null,this._currentInputType==x3dom.InputTypes.NAVIGATION&&(this._pickingInfo.pickObj||this._pickingInfo.shadowObjectId>=0)&&"lookat"===d&&this._pressX===e&&this._pressY===t){var v=2&this._lastButton?-1:1,g=this._pickingInfo.pickPos.subtract(this._from).length()/3,y=new x3dom.fields.SFMatrix4f;y.setValues(this.getViewMatrix());var S=(y=y.inverse()).e3(),T=(S.subtract(y.e2()),y.e1()),F=(n=this._pickingInfo.pickPos.subtract(S)).length();n=n.normalize();var b=S.addScaled(n,F),C=n.cross(T).normalize();n=C.cross(T).normalize(),v<0&&(g=2*(.5+F+g));var M=b.addScaled(n,g);y=(y=x3dom.fields.SFMatrix4f.lookAt(M,b,T)).inverse(),g=M.subtract(S).length();var E=Math.max(.5,Math.log((1+g)/a._vf.speed));this.animateTo(y,this._scene.getViewpoint(),E)}this._dx=0,this._dy=0,this._lastX=e,this._lastY=t,this._lastButton=i,this._isMoving=!1},x3dom.Viewarea.prototype.onMouseOver=function(e,t,i){this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0},x3dom.Viewarea.prototype.onMouseOut=function(e,t,i){var s;this._dx=0,this._dy=0,this._lastButton=0,this._isMoving=!1,this._lastX=e,this._lastY=t,this._deltaT=0;var o=this._doc._nodeBag.affectedPointingSensors;for(s=0;s<o.length;++s)o[s].pointerReleased();this._doc._nodeBag.affectedPointingSensors=[]},x3dom.Viewarea.prototype.onDoubleClick=function(e,t){this._doc._x3dElem.hasAttribute("disableDoubleClick")&&"true"===this._doc._x3dElem.getAttribute("disableDoubleClick")||this._scene.getNavigationInfo()._impl.onDoubleClick(this,e,t)},x3dom.Viewarea.prototype.handleMoveEvt=function(e,t,i){if(0==i&&(this._doc._nodeBag.affectedPointingSensors=[]),this.prepareEvents(e,t,i,"onmousemove"),this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var s=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj;var o=this._doc._nodeBag.affectedPointingSensors;this._doc._nodeBag.affectedPointingSensors=[],this.prepareEvents(e,t,i,"onmouseout"),this._doc._nodeBag.affectedPointingSensors=o,this._pickingInfo.pickObj=s}this._pickingInfo.pickObj&&this.prepareEvents(e,t,i,"onmouseover"),this._pickingInfo.lastObj=this._pickingInfo.pickObj}},x3dom.Viewarea.prototype.onMove=function(e,t,i){this.handleMoveEvt(e,t,i),(this._lastX<0||this._lastY<0)&&(this._lastX=e,this._lastY=t),this._dx=e-this._lastX,this._dy=t-this._lastY,this._lastX=e,this._lastY=t},x3dom.Viewarea.prototype.onMoveView=function(e,t){if(this._currentInputType==x3dom.InputTypes.NAVIGATION){var i=this._scene.getNavigationInfo(),s=this._scene.getViewpoint();if("examine"===i.getType()){if(e){var o=this._scene._lastMax.subtract(this._scene._lastMin).length();o=(o<x3dom.fields.Eps?1:o)*i._vf.speed,e=e.multiply(o),this._movement=this._movement.add(e),this._transMat=s.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(s.getViewMatrix())}if(t){var n=s.getCenterOfRotation(),r=this.getViewMatrix();r.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(n)).mult(r.inverse()).mult(t).mult(r).mult(x3dom.fields.SFMatrix4f.translation(n.negate()))}this._isMoving=!0}}},x3dom.Viewarea.prototype.onDrag=function(e,t,i){this.handleMoveEvt(e,t,i),this._currentInputType==x3dom.InputTypes.NAVIGATION&&this._scene.getNavigationInfo()._impl.onDrag(this,e,t,i)},x3dom.Viewarea.prototype.prepareEvents=function(e,t,i,s){var o=this._doc._nodeBag.affectedPointingSensors,n=this._scene._vf.pickMode.toLowerCase(),r=null;(0==n.indexOf("idbuf")||"color"==n||"texcoord"==n)&&(r=this._pickingInfo.pickObj)&&(this._pick.setValues(this._pickingInfo.pickPos),this._pickNorm.setValues(this._pickingInfo.pickNorm),this.checkEvents(r,e,t,i,s),"onclick"===s&&(r._xmlNode&&x3dom.debug.logInfo('Hit "'+r._xmlNode.localName+"/ "+r._DEF+'"'),"color"===n?x3dom.debug.logInfo("Ray hit color "+this._pick):"idbufid"===n||"texcoord"===n?x3dom.debug.logInfo("Ray hit data "+this._pick):x3dom.debug.logInfo("Ray hit at position "+this._pick.x.toFixed(4)+" "+this._pick.y.toFixed(4)+" "+this._pick.z.toFixed(4))));var a={viewarea:this,target:{},type:s.substr(2,s.length-2),button:i,layerX:e,layerY:t,worldX:this._pick.x,worldY:this._pick.y,worldZ:this._pick.z,normalX:this._pickNorm.x,normalY:this._pickNorm.y,normalZ:this._pickNorm.z,hitPnt:this._pick.toGL(),hitObject:r&&r._xmlNode?r._xmlNode:null,shadowObjectId:this._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};this._notifyAffectedPointingSensors(a),o.length>0?this._currentInputType=x3dom.InputTypes.INTERACTION:this._currentInputType=x3dom.InputTypes.NAVIGATION},x3dom.Viewarea.prototype.getRenderMode=function(){return this._points},x3dom.Viewarea.prototype.getShadowedLights=function(){for(var e=[],t=0,i=this.getLights(),s=0;s<i.length;s++)i[s]._vf.shadowIntensity>0&&(e[t]=i[s],t++);return e},x3dom.Viewarea.prototype.getShadowSplitDepths=function(e,t,i,s,o){var n,r=[],a=this._scene.getViewpoint(),d=a.getNear(),h=a.getFar();r[0]=d,d+=i*(h-d)/10;for(var l=1;l<e;l++)n=d*Math.pow(h/d,l/e),r[l]=t*n+(1-t)*(d+l/(e*(d-h)));if(r[e]=h,!s)return r;for(var f=[],u=0;u<=e;u++)f[u]=o.multFullMatrixPnt(new x3dom.fields.SFVec3f(0,0,-r[u])).z;return f},x3dom.Viewarea.prototype.getLightCropMatrix=function(e){var t,i=x3dom.fields.SFVec3f.copy(this._scene._lastMin),s=x3dom.fields.SFVec3f.copy(this._scene._lastMax),o=[];for(o[0]=new x3dom.fields.SFVec3f(i.x,i.y,i.z),o[1]=new x3dom.fields.SFVec3f(i.x,i.y,s.z),o[2]=new x3dom.fields.SFVec3f(i.x,s.y,i.z),o[3]=new x3dom.fields.SFVec3f(i.x,s.y,s.z),o[4]=new x3dom.fields.SFVec3f(s.x,i.y,i.z),o[5]=new x3dom.fields.SFVec3f(s.x,i.y,s.z),o[6]=new x3dom.fields.SFVec3f(s.x,s.y,i.z),o[7]=new x3dom.fields.SFVec3f(s.x,s.y,s.z),t=0;t<8;t++)o[t]=e.multFullMatrixPnt(o[t]);var n=x3dom.fields.SFVec3f.copy(o[0]),r=x3dom.fields.SFVec3f.copy(o[0]);for(t=1;t<8;t++)n.z=Math.min(o[t].z,n.z),r.z=Math.max(o[t].z,r.z);var a=2/(r.z-n.z),d=-a*(r.z+n.z)/2,h=x3dom.fields.SFMatrix4f.identity();return h._22=a,h._23=d,h},x3dom.Viewarea.prototype.getLightFittingMatrix=function(e,t,i,s){var o,n=this.getViewMatrix(),r=s.mult(n).inverse(),a=[];for(a[0]=new x3dom.fields.SFVec3f(-1,-1,i),a[1]=new x3dom.fields.SFVec3f(-1,-1,t),a[2]=new x3dom.fields.SFVec3f(-1,1,i),a[3]=new x3dom.fields.SFVec3f(-1,1,t),a[4]=new x3dom.fields.SFVec3f(1,-1,i),a[5]=new x3dom.fields.SFVec3f(1,-1,t),a[6]=new x3dom.fields.SFVec3f(1,1,i),a[7]=new x3dom.fields.SFVec3f(1,1,t),o=0;o<8;o++)a[o]=r.multFullMatrixPnt(a[o]),a[o]=e.multFullMatrixPnt(a[o]);var d=x3dom.fields.SFVec3f.copy(a[0]),h=x3dom.fields.SFVec3f.copy(a[0]);for(o=1;o<8;o++)d.x=Math.min(a[o].x,d.x),d.y=Math.min(a[o].y,d.y),d.z=Math.min(a[o].z,d.z),h.x=Math.max(a[o].x,h.x),h.y=Math.max(a[o].y,h.y),h.z=Math.max(a[o].z,h.z);var l=function(e,t){var i=e.x,s=e.y,o=e.z,n=t.x,r=t.y,a=t.z;i>1||n<-1?(i=-1,n=1):(i=Math.max(i,-1),n=Math.min(n,1)),s>1||r<-1?(s=-1,r=1):(s=Math.max(s,-1),r=Math.min(r,1)),o>1||a<-1?(o=-1,a=1):(o=Math.max(o,-1),a=Math.min(a,1));var d=new x3dom.fields.SFVec3f(i,s,o),h=new x3dom.fields.SFVec3f(n,r,a);return new x3dom.fields.BoxVolume(d,h)}(d,h),f=2/(l.max.x-l.min.x),u=2/(l.max.y-l.min.y),_=-f*(l.max.x+l.min.x)/2,c=-u*(l.max.y+l.min.y)/2,m=x3dom.fields.SFMatrix4f.identity();return m._00=f,m._11=u,m._03=_,m._13=c,m},x3dom.fields={};var VecMath=x3dom.fields;function _colorParse(e){var t=0,i=0,s=0,o=1,n={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",feldspar:"#d19275",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslateblue:"#8470ff",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",violetred:"#d02090",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},r=/^rgb\((\d{1,3}),\s{0,1}(\d{1,3}),\s{0,1}(\d{1,3})\)$/.exec(e);null!==r&&(t=r[1]/255,i=r[2]/255,s=r[3]/255);var a=/^rgba\((\d{1,3}),\s{0,1}(\d{1,3}),\s{0,1}(\d{1,3}),(0+\.?\d*|1\.?0*)\)$/.exec(e);if(null!==a&&(t=a[1]/255,i=a[2]/255,s=a[3]/255,o=+a[4]),n[e]&&(e=n[e]),e.substr&&"#"===e.substr(0,1)){var d=e.substr(1),h=d.length;8===h?(t=parseInt("0x"+d.substr(0,2),16)/255,i=parseInt("0x"+d.substr(2,2),16)/255,s=parseInt("0x"+d.substr(4,2),16)/255,o=parseInt("0x"+d.substr(6,2),16)/255):6===h?(t=parseInt("0x"+d.substr(0,2),16)/255,i=parseInt("0x"+d.substr(2,2),16)/255,s=parseInt("0x"+d.substr(4,2),16)/255):4===h?(t=parseInt("0x"+d.substr(0,1),16)/15,i=parseInt("0x"+d.substr(1,1),16)/15,s=parseInt("0x"+d.substr(2,1),16)/15,o=parseInt("0x"+d.substr(3,1),16)/15):3===h&&(t=parseInt("0x"+d.substr(0,1),16)/15,i=parseInt("0x"+d.substr(1,1),16)/15,s=parseInt("0x"+d.substr(2,1),16)/15)}return{r:t,g:i,b:s,a:o}}function startDashVideo(e,t){var i,s,o,n=function(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(t,i,s){e[i]=s}));return e},r=e;n&&n.hasOwnProperty("url")&&(r=n.url),i=document.querySelector(t),s=new Dash.di.DashContext,(o=new MediaPlayer(s)).startup(),o.attachView(i),o.setAutoPlay(!1),o.attachSource(r)}function setNamespace(e,t,i){t instanceof Element&&void 0!==t.__setAttribute&&(t.hasAttribute("id")?t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("id")):t.hasAttribute("DEF")&&i&&(t.__setAttribute("id",e.toString().replace(" ","")+"__"+t.getAttribute("DEF")),t.id||(t.id=t.__getAttribute("id")))),t.hasChildNodes()&&t.childNodes.forEach((function(t){setNamespace(e,t,i)}))}function NodeProducer(){var e=null,t=1e6;this.AddNewNode=function(i,s){i.Level()<t&&(t=i.Level(),e=i),i.Level()===t&&s<1e6&&(s=1e6,e=i)},this.CreateNewNode=function(){null!==e&&e.CreateChildren(),e=null,t=1e3}}function QuadtreeNode2dWMTS(e,t,i,s,o,n,r,a){var d=[],h=new x3dom.nodeTypes.Shape,l=null,f=!1,u=!1,_=t._vf.textureUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.textureFormat.toLowerCase(),c=(t._vf.size.x+t._vf.size.y)/2,m={};function p(){f=!0;for(var e=0;e<h._webgl.texture.length;e++)h._webgl.texture[e].texture.ready||(f=!1);return f}this.CreateChildren=function(){var h,l,f,u,_,c,m;h=Math.sqrt(Math.pow(4,i)),l=Math.sqrt(Math.pow(4,i+1)),f=4*Math.floor(s/h)*h+s%h*2,u=f+1,c=(_=f+l)+1,m=t._vf.size.multiply(.25),d.push(new QuadtreeNode2dWMTS(e,t,i+1,f,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-m.x,m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r,a)),d.push(new QuadtreeNode2dWMTS(e,t,i+1,u,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(m.x,m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r,a)),d.push(new QuadtreeNode2dWMTS(e,t,i+1,_,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-m.x,-m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r+1,a)),d.push(new QuadtreeNode2dWMTS(e,t,i+1,c,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(m.x,-m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r+1,a))},this.Shape=function(){return h},this.Ready=function(){return void 0!==h._webgl&&void 0!==h._webgl.texture&&p()},this.collectDrawables=function(e,s,n,r,a){if(m.localMatrix=o,a=s.cull(o,m,n,a),f&&u||function(e,t){u=!0;for(var i=0;i<d.length;i++)d[i].Ready()||(u=!1);if(d.length<4)u=!1;else if(u)for(i=0;i<d.length;i++)d[i].Shape()._vf.visible=!0;void 0===h._webgl||void 0===h._webgl.texture?e.context.setupShape(e.gl,{shape:h,transform:t},e.viewarea):p()}(s,o),f&&a>=0){var _=s.viewMatrix.multMatrixPnt(o.multMatrixPnt(l)),v=Math.sqrt(Math.pow(_.x,2)+Math.pow(_.y,2)+Math.pow(_.z,2));if(v<Math.pow(t._vf.maxDepth-i,2)*c/t._vf.factor||i<t._vf.minDepth)if(t.view.isMovingOrAnimating()&&0===d.length||t.view.isMovingOrAnimating()&&i>=t._vf.interactionDepth)h.collectDrawableObjects(o,s,n,r,a,[]);else if(0===d.length)t.nodeProducer.AddNewNode(x,v),h.collectDrawableObjects(o,s,n,r,a,[]);else if(u)for(var g=0;g<d.length;g++)d[g].collectDrawables(o,s,n,r,a);else{h.collectDrawableObjects(o,s,n,r,a,[]);for(g=0;g<d.length;g++)d[g].collectDrawables(o,s,n,r,a),d[g].Shape()._vf.visible=!1}else h.collectDrawableObjects(o,s,n,r,a,[])}},this.getVolume=function(){return h.getVolume()},this.Level=function(){return i};var x=this;!function(){var i=new x3dom.nodeTypes.Appearance(e),s=new x3dom.nodeTypes.ImageTexture(e);h._nameSpace=t._nameSpace;var n=new x3dom.nodeTypes.TextureProperties(e);n._vf.boundaryModeS="CLAMP_TO_EDGE",n._vf.boundaryModeT="CLAMP_TO_EDGE",n._vf.boundaryModeR="CLAMP_TO_EDGE",n._vf.minificationFilter="LINEAR",n._vf.magnificationFilter="LINEAR",s.addChild(n,"textureProperties"),s.nodeChanged(),s._nameSpace=t._nameSpace,s._vf.url[0]=_,l=o.e3(),i.addChild(s),s.nodeChanged(),h.addChild(i),i.nodeChanged(),h.addChild(a),a.nodeChanged(),t.addChild(h),h.nodeChanged(),m.boundedNode=h,m.volume=h.getVolume()}()}function QuadtreeNode2D(e,t,i,s,o,n,r,a,d,h){var l=[],f=new x3dom.nodeTypes.Shape,u=null,_=!1,c=!1,m=t._vf.textureUrl+d+h+"."+t._vf.textureFormat,p=(t._vf.size.x+t._vf.size.y)/2,x={};function v(){_=!0;for(var e=0;e<f._webgl.texture.length;e++)f._webgl.texture[e].texture.ready||(_=!1);return _}this.CreateChildren=function(){var f,u,_,c,m,p,x;f=Math.sqrt(Math.pow(4,i)),u=Math.sqrt(Math.pow(4,i+1)),_=4*Math.floor(s/f)*f+s%f*2,c=_+1,p=(m=_+u)+1,x=t._vf.size.multiply(.25),l.push(new QuadtreeNode2D(e,t,i+1,_,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-x.x,x.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r,a,d+h+"/",1)),l.push(new QuadtreeNode2D(e,t,i+1,c,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(x.x,x.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r,a,d+h+"/",3)),l.push(new QuadtreeNode2D(e,t,i+1,m,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-x.x,-x.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r+1,a,d+h+"/",2)),l.push(new QuadtreeNode2D(e,t,i+1,p,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(x.x,-x.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r+1,a,d+h+"/",4))},this.Shape=function(){return f},this.Ready=function(){return void 0!==f._webgl&&void 0!==f._webgl.texture&&v()},this.collectDrawables=function(e,s,n,r,a){if(x.localMatrix=o,_&&c||function(e,t){c=!0;for(var i=0;i<l.length;i++)l[i].Ready()||(c=!1);if(l.length<4)c=!1;else if(c)for(i=0;i<l.length;i++)l[i].Shape()._vf.visible=!0;void 0===f._webgl||void 0===f._webgl.texture?e.context.setupShape(e.gl,{shape:f,transform:t},e.viewarea):v()}(s,o),_&&(a=s.cull(o,x,n,a))>0){var d=s.viewMatrix.multMatrixPnt(o.multMatrixPnt(u)),h=Math.sqrt(Math.pow(d.x,2)+Math.pow(d.y,2)+Math.pow(d.z,2));if(h<Math.pow(t._vf.maxDepth-i,2)*p/t._vf.factor||i<t._vf.minDepth)if(t.view.isMovingOrAnimating()&&0===l.length||t.view.isMovingOrAnimating()&&i>=t._vf.interactionDepth)f.collectDrawableObjects(o,s,n,r,a,[]);else if(0===l.length)t.nodeProducer.AddNewNode(g,h),f.collectDrawableObjects(o,s,n,r,a,[]);else if(c)for(var m=0;m<l.length;m++)l[m].collectDrawables(o,s,n,r,a);else{f.collectDrawableObjects(o,s,n,r,a,[]);for(m=0;m<l.length;m++)l[m].collectDrawables(o,s,n,r,a),l[m].Shape()._vf.visible=!1}else f.collectDrawableObjects(o,s,n,r,a,[])}},this.getVolume=function(){return f.getVolume()},this.Level=function(){return i};var g=this;!function(){var i=new x3dom.nodeTypes.Appearance(e),s=new x3dom.nodeTypes.ImageTexture(e);f._nameSpace=t._nameSpace;var n=new x3dom.nodeTypes.TextureProperties(e);n._vf.boundaryModeS="CLAMP_TO_EDGE",n._vf.boundaryModeT="CLAMP_TO_EDGE",n._vf.boundaryModeR="CLAMP_TO_EDGE",n._vf.minificationFilter="LINEAR",n._vf.magnificationFilter="LINEAR",s.addChild(n,"textureProperties"),s.nodeChanged(),s._nameSpace=t._nameSpace,s._vf.url[0]=m,u=o.e3(),i.addChild(s),s.nodeChanged(),f.addChild(i),i.nodeChanged(),f.addChild(a),a.nodeChanged(),t.addChild(f),f.nodeChanged(),x.boundedNode=f,x.volume=f.getVolume()}()}function QuadtreeNode3D(e,t,i,s,o,n,r,a){var d=[],h=[],l=new x3dom.nodeTypes.Shape,f=null,u=t._vf.textureUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.textureFormat.toLowerCase(),_=t._vf.elevationUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.elevationFormat.toLowerCase();if(""!==t._vf.normalUrl)var c=t._vf.normalUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.normalFormat.toLowerCase();var m=!1,p=!1,x=(t._vf.size.x+t._vf.size.y)/2,v={},g=0,y=null;function S(){m=!0;for(var e=0;e<l._webgl.texture.length;e++)l._webgl.texture[e].texture.ready||(m=!1);return m}function T(e,i,s,n,r){for(var a=[],d=0;d<h.length;d++)void 0!==t.nodeList[h[d]]&&t.nodeList[h[d]].ChildrenReady()&&t.nodeList[h[d]].hasHigherRenderLevel(i)?a.push(!0):a.push(!1);var f=0;a[3]?f=a[1]?5:a[0]?6:4:a[2]?f=a[1]?8:a[0]?7:3:a[0]?f=1:a[1]&&(f=2),g===f&&null!==y||(y=l._cf.geometry.node.getTriangulationAttributes(f),g=f),l._tessellationProperties=[y],l.collectDrawableObjects(o,i,s,n,r,[])}this.CreateChildren=function(){var h,l,f,u,_,c,m;h=Math.sqrt(Math.pow(4,i)),l=Math.sqrt(Math.pow(4,i+1)),f=4*Math.floor(s/h)*h+s%h*2,u=f+1,c=(_=f+l)+1,m=t._vf.size.multiply(.25),d.push(new QuadtreeNode3D(e,t,i+1,f,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-m.x,m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r,a)),d.push(new QuadtreeNode3D(e,t,i+1,u,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(m.x,m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r,a)),d.push(new QuadtreeNode3D(e,t,i+1,_,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-m.x,-m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r+1,a)),d.push(new QuadtreeNode3D(e,t,i+1,c,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(m.x,-m.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r+1,a))},this.Shape=function(){return l},this.ChildrenReady=function(){return p},this.Ready=function(){return void 0!==l._webgl&&void 0!==l._webgl.texture&&S()},this.collectDrawables=function(e,s,n,r,a){s.frustumCulling=!1,v.localMatrix=o,m&&p||function(e,t){p=!0;for(var i=0;i<d.length;i++)d[i].Ready()||(p=!1);if(d.length<4)p=!1;else if(p)for(i=0;i<d.length;i++)d[i].Shape()._vf.visible=!0;void 0===l._webgl||void 0===l._webgl.texture?e.context.setupShape(e.gl,{shape:l,transform:t},e.viewarea):S()}(s,o);var h=s.viewMatrix.multMatrixPnt(o.multMatrixPnt(f)),u=Math.sqrt(Math.pow(h.x,2)+Math.pow(h.y,2)+Math.pow(h.z,2));if(m&&h.z-v.volume.diameter/2<0)if(u<Math.pow(t._vf.maxDepth-i,2)*x/t._vf.factor||i<t._vf.minDepth)if(t.view.isMovingOrAnimating()&&(0==d.length||i>=t._vf.interactionDepth))T(o,s,n,r,a);else if(0===d.length)t.nodeProducer.AddNewNode(F,u),T(o,s,n,r,a);else if(p)for(var _=0;_<d.length;_++)d[_].collectDrawables(o,s,n,r,a);else{T(o,s,n,r,a);for(_=0;_<d.length;_++)d[_].collectDrawables(o,s,n,r,a),d[_].Shape()._vf.visible=!1}else T(o,s,n,r,a)},this.hasHigherRenderLevel=function(e){var s=e.viewMatrix.multMatrixPnt(o.multMatrixPnt(f));return Math.sqrt(Math.pow(s.x,2)+Math.pow(s.y,2)+Math.pow(s.z,2))<Math.pow(t._vf.maxDepth-i,2)*x/t._vf.factor},this.getVolume=function(){return l.getVolume()},this.Level=function(){return i};var F=this;!function(){var d=new x3dom.nodeTypes.Appearance(e),m=new x3dom.nodeTypes.MultiTexture(e),p=new x3dom.nodeTypes.ImageTexture(e),x=new x3dom.nodeTypes.ImageTexture(e),g=new x3dom.nodeTypes.ImageTexture(e),y=new x3dom.nodeTypes.ComposedShader(e);l._nameSpace=t._nameSpace,(f=o.e3()).z=t._vf.maxElevation/2;var S=new x3dom.nodeTypes.ShaderPart(e);S._vf.type="vertex",S._vf.url[0]=""!==t._vf.normalUrl?"attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texColor;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\nconst float shininess = 32.0;\n\nvoid main(void) {\n    vec3 uLightPosition = vec3(160.0, -9346.0, 4806.0);\n    vec4 colr = texture2D(texColor, vec2(texcoord[0], 1.0-texcoord[1]));\n    vec3 uAmbientMaterial = vec3(1.0, 1.0, 0.9);    vec3 uAmbientLight = vec3(0.5, 0.5, 0.5);    vec3 uDiffuseMaterial = vec3(0.7, 0.7, 0.7);    vec3 uDiffuseLight = vec3(1.0, 1.0, 1.0);    vec4 vertexPositionEye4 = modelViewMatrix * vec4(position, 1.0);    vec3 vertexPositionEye3 = vec3((modelViewMatrix * vec4(vertexPositionEye4.xyz, 1.0)).xyz);    vec3 vectorToLightSource = normalize(uLightPosition - vertexPositionEye3);    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    vec4 normalEye = 2.0 * texture2D(texNormal, vec2(texcoord[0], 1.0-texcoord[1])) - 1.0;\n    float diffuseLightWeighting = max(dot(normalEye.xyz, vectorToLightSource), 0.0);    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    vec3 diffuseReflectance = uDiffuseMaterial * uDiffuseLight * diffuseLightWeighting;    vec3 uSpecularMaterial = vec3(0.0, 0.0, 0.0);    vec3 uSpecularLight = vec3(1.0, 1.0, 1.0);    vec3 reflectionVector = normalize(reflect(-vectorToLightSource, normalEye.xyz));    vec3 viewVectorEye = -normalize(vertexPositionEye3);    float rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);    float specularLightWeight = pow(rdotv, shininess);    vec3 specularReflection = uSpecularMaterial * uSpecularLight * specularLightWeight;    vLight = vec4(uAmbientMaterial * uAmbientLight + diffuseReflectance + specularReflection, 1.0).xyz;    gl_Position = modelViewProjectionMatrix * vec4(position.xy, height.x * maxElevation, 1.0);\n}\n":"attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nvarying vec2 texC;\n\nvoid main(void) {\n    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    gl_Position = modelViewProjectionMatrix * vec4(position.xy, height.x * maxElevation, 1.0);\n}\n";var T=new x3dom.nodeTypes.ShaderPart(e);T._vf.type="fragment",T._vf.url[0]=""!==t._vf.normalUrl?"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\n\n\nvoid main(void) {\n    vec4 normal = 2.0 * texture2D(texNormal, texC) - 1.0;\n    vec4 colr = texture2D(texColor, texC);\n    gl_FragColor = vec4(colr.xyz * vLight, colr.w);\n}\n":"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nvarying vec2 texC;\n\n\nvoid main(void) {\n    gl_FragColor = texture2D(texColor, texC);\n}\n",y.addChild(S,"parts"),y.addChild(T,"parts");var b=new x3dom.nodeTypes.TextureProperties(e);b._vf.boundaryModeS="CLAMP_TO_EDGE",b._vf.boundaryModeT="CLAMP_TO_EDGE",b._vf.boundaryModeR="CLAMP_TO_EDGE",b._vf.minificationFilter="LINEAR",b._vf.magnificationFilter="LINEAR",p.addChild(b,"textureProperties"),p.nodeChanged(),p._nameSpace=t._nameSpace,p._vf.url[0]=u,p._vf.repeatT=!1,p._vf.repeatS=!1,m.addChild(p,"texture"),p.nodeChanged();var C=new x3dom.nodeTypes.Field(e);C._vf.name="texColor",C._vf.type="SFInt32",C._vf.value=0,y.addChild(C,"fields"),C.nodeChanged();var M=new x3dom.nodeTypes.TextureProperties(e);M._vf.boundaryModeS="CLAMP_TO_EDGE",M._vf.boundaryModeT="CLAMP_TO_EDGE",M._vf.boundaryModeR="CLAMP_TO_EDGE",M._vf.minificationFilter="NEAREST",M._vf.magnificationFilter="NEAREST",x.addChild(M,"textureProperties"),x.nodeChanged(),x._nameSpace=t._nameSpace,x._vf.url[0]=_,x._vf.repeatT=!1,x._vf.repeatS=!1,x._vf.scale=!1,m.addChild(x,"texture"),x.nodeChanged();var E=new x3dom.nodeTypes.Field(e);if(E._vf.name="texHeight",E._vf.type="SFInt32",E._vf.value=1,y.addChild(E,"fields"),E.nodeChanged(),""!==t._vf.normalUrl){var w=new x3dom.nodeTypes.TextureProperties(e);w._vf.boundaryModeS="CLAMP_TO_EDGE",w._vf.boundaryModeT="CLAMP_TO_EDGE",w._vf.boundaryModeR="CLAMP_TO_EDGE",w._vf.minificationFilter="LINEAR",w._vf.magnificationFilter="LINEAR",g.addChild(w,"textureProperties"),g.nodeChanged(),g._nameSpace=t._nameSpace,g._vf.url[0]=c,g._vf.repeatT=!1,g._vf.repeatS=!1,m.addChild(g,"texture"),g.nodeChanged();var A=new x3dom.nodeTypes.Field(e);A._vf.name="texNormal",A._vf.type="SFInt32",A._vf.value=2,y.addChild(A,"fields"),A.nodeChanged()}var D=new x3dom.nodeTypes.Field(e);D._vf.name="maxElevation",D._vf.type="SFFloat",D._vf.value=t._vf.maxElevation,y.addChild(D,"fields"),D.nodeChanged(),d.addChild(m),m.nodeChanged(),d.addChild(y),y.nodeChanged(),l.addChild(d),d.nodeChanged(),l.addChild(a),t.addChild(l),l.nodeChanged(),v.boundedNode=l,v.volume=l.getVolume(),v.volume.max.z=t._vf.maxElevation,v.volume.min.z=0,v.volume.center=v.volume.min.add(v.volume.max).multiply(.5),v.volume.transform(o),function(){for(var e=0,o=0;o<i;o++)e+=Math.pow(4,o);var a=e+s;t.nodeList[a]=F;var d=Math.sqrt(Math.pow(4,i));h[0]=e+(Math.ceil((s+1)/d-1)*d+(s+(d-1))%d),h[1]=e+(Math.ceil((s+1)/d-1)*d+(s+1)%d),h[3]=e+(s+d*(d-1))%Math.pow(4,i),h[2]=e+(s+d)%Math.pow(4,i),0===n&&(h[0]=-1);0===r&&(h[3]=-1);n===d-1&&(h[1]=-1);r===d-1&&(h[2]=-1)}()}()}function QuadtreeNodeBin(e,t,i,s,o,n){var r,a,d,h={},l=.1*(1/4*Math.pow(i,2)+1.5)*t._vf.factor,f=[],u=!1,_=!1,c=!1,m=t._vf.url+"/"+i+"/"+s+"/",p=m+o+".x3d",x=new x3dom.fields.SFVec3f(0,0,0),v=!1,g=new x3dom.nodeTypes.Shape(e),y=new XMLHttpRequest;y.open("GET",p,!1);try{x3dom.RequestManager.addRequest(y);var S=y.responseXML;if(null!==S){new RegExp('"',"g");!function(i){this._nameSpace=new x3dom.NodeNameSpace("",t._nameSpace.doc),this._nameSpace.setBaseURL(t._nameSpace.baseURL+m);var s=S.getElementsByTagName("Shape")[0];if(g=this._nameSpace.setupTree(s),!t._vf.useNormals){var o=new x3dom.nodeTypes.Appearance(e),n=new x3dom.nodeTypes.Material(e);o.addChild(n),g._cf.appearance=o}x=x3dom.fields.SFVec3f.copy(g._cf.geometry.node._vf.position)}(),T(),v=!0}}catch(e){x3dom.debug.logException("Error loading file '"+p+"': "+e)}function T(){h.boundedNode=g,h.volume=g.getVolume()}function F(){return _=!0,g._webgl.internalDownloadCount>0&&(_=!1),_}this.Exists=function(){return v},this.Shape=function(){return g},this.CreateChildren=function(){f.push(new QuadtreeNodeBin(e,t,i+1,2*s,2*o,n)),f.push(new QuadtreeNodeBin(e,t,i+1,2*s+1,2*o,n)),f.push(new QuadtreeNodeBin(e,t,i+1,2*s,2*o+1,n)),f.push(new QuadtreeNodeBin(e,t,i+1,2*s+1,2*o+1,n))},this.Ready=function(){return void 0!==g._webgl&&void 0!==g._webgl.internalDownloadCount&&F()},this.collectDrawables=function(e,s,o,n,m){if(l=.1*(1/4*Math.pow(i,2)+1.5)*t._vf.factor,h.localMatrix=e,_&&c||function(e,t){c=!0;for(var i=0;i<f.length;i++)f[i].Ready()||(c=!1);if(c)for(i=0;i<f.length;i++)f[i].Shape()._vf.visible=!0;null!==g._cf.geometry.node&&(void 0===g._webgl||void 0===g._webgl.internalDownloadCount?e.context.setupShape(e.gl,{shape:g,transform:t},e.viewarea):F())}(s,e),_&&v&&(m=s.cull(e,h,o,m))>0)if(r=s.viewMatrix,a=r.multMatrixPnt(e.multMatrixPnt(x)),(d=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)+Math.pow(a.z,2)))<Math.pow(t._vf.maxDepth-i,2)/l*1e3||i<t._vf.minDepth)if(t.view.isMovingOrAnimating()&&i>=t._vf.interactionDepth)g.collectDrawableObjects(e,s,o,n,m,[]);else if(0===f.length)t.nodeProducer.AddNewNode(b,d),g.collectDrawableObjects(e,s,o,n,m,[]);else if(0===f.length&&t.createChildren>0)g.collectDrawableObjects(e,s,o,n,m,[]);else{if(!u)for(var p=0;p<f.length;p++)if(f[p].Exists()){u=!0;break}if(u&&c)for(p=0;p<f.length;p++)f[p].collectDrawables(e,s,o,n,m);else{for(p=0;p<f.length;p++)f[p].collectDrawables(e,s,o,n,m),f[p].Shape()._vf.visible=!1;g.collectDrawableObjects(e,s,o,n,m,[])}}else g.collectDrawableObjects(e,s,o,n,m,[])},this.getVolume=function(){return g.getVolume()},this.Level=function(){return i};var b=this;T()}function BVHNode(e,t,i,s,o,n){var r={},a=(Math.pow(i,2),t._vf.factor,[]),d=t._vf.url+s+o+".x3d",h=(new x3dom.fields.SFVec3f(0,0,0),!1),l=new x3dom.nodeTypes.Shape(e);this.RecalcFactor=function(){.1*(1/4*Math.pow(i,2)+1.5)*t._vf.factor;for(var e=0;e<a.length;e++)a[e].RecalcFactor()};var f=new XMLHttpRequest;f.open("GET",d,!1);try{x3dom.RequestManager.addRequest(f);var u=f.responseXML;if(null!==u){new RegExp('"',"g");!function(i){this._nameSpace=new x3dom.NodeNameSpace("",t._nameSpace.doc),this._nameSpace.setBaseURL(t._nameSpace.baseURL+t._vf.url+s);var o=u.getElementsByTagName("Shape")[0];if(l=this._nameSpace.setupTree(o),!t._vf.useNormals){var n=new x3dom.nodeTypes.Appearance(e),r=new x3dom.nodeTypes.Material(e);n.addChild(r),l._cf.appearance=n}x3dom.fields.SFVec3f.copy(l._cf.geometry.node._vf.position)}(),_(),h=!0}}catch(e){x3dom.debug.logException("Error loading file '"+d+"': "+e)}function _(){r.boundedNode=l,r.volume=l.getVolume()}function c(){return l._webgl.internalDownloadCount<=0}this.Exists=function(){return h},this.Shape=function(){return l},this.CreateChildren=function(){!function(){for(var r=0;r<n;r++)a.push(new BVHNode(e,t,i+1,s+o+"/",r+1,n))}()},this.Ready=function(){return void 0!==l._webgl&&void 0!==l._webgl.internalDownloadCount&&c()},this.collectDrawables=function(e,s,o,n,d){.1*(1/4*Math.pow(i,2)+1.5)*t._vf.factor,r.localMatrix=e,function(e,t){for(var i=0;i<a.length;i++)!0,a[i].Ready()?a[i].Shape()._vf.visible=!0:!1;null!==l._cf.geometry.node&&(void 0===l._webgl||void 0===l._webgl.internalDownloadCount?e.context.setupShape(e.gl,{shape:l,transform:t},e.viewarea):c())}(s,e)},this.getVolume=function(){return l.getVolume()},this.Level=function(){return i};_()}function QuadtreeNode3D_NEW(e,t,i,s,o,n,r,a){var d,h,l,f,u,_,c=[],m=new x3dom.nodeTypes.Shape,p=null,x=t._vf.textureUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.textureFormat.toLowerCase(),v=t._vf.elevationUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.elevationFormat.toLowerCase(),g=(t._vf.normalUrl,t._vf.normalFormat.toLowerCase(),(t._vf.size.x+t._vf.size.y)/2),y={};this.collectDrawables=function(d,h,l,f,u){if(y.localMatrix=o,(u=h.cull(d,y,l,u))>0){var _=h.viewMatrix.multMatrixPnt(d.multMatrixPnt(p));if(Math.sqrt(Math.pow(_.x,2)+Math.pow(_.y,2)+Math.pow(_.z,2))<Math.pow(t._vf.maxDepth-i,2)*g/t._vf.factor)if(0===c.length&&0===t.createChildren)t.createChildren++,v=Math.sqrt(Math.pow(4,i)),S=Math.sqrt(Math.pow(4,i+1)),T=4*Math.floor(s/v)*v+s%v*2,F=T+1,C=(b=T+S)+1,M=t._vf.size.multiply(.25),c.push(new QuadtreeNode3D_NEW(e,t,i+1,T,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-M.x,M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r,a)),c.push(new QuadtreeNode3D_NEW(e,t,i+1,F,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(M.x,M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r,a)),c.push(new QuadtreeNode3D_NEW(e,t,i+1,b,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-M.x,-M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r+1,a)),c.push(new QuadtreeNode3D_NEW(e,t,i+1,C,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(M.x,-M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r+1,a)),m.collectDrawableObjects(o,h,l,f,u,[]);else if(0===c.length&&t.createChildren>0)m.collectDrawableObjects(o,h,l,f,u,[]);else for(var x=0;x<c.length;x++)c[x].collectDrawables(o,h,l,f,u);else m.collectDrawableObjects(o,h,l,f,u,[])}var v,S,T,F,b,C,M},this.getVolume=function(){return m.getVolume()},d=new x3dom.nodeTypes.Appearance(e),h=new x3dom.nodeTypes.CommonSurfaceShader(e),l=new x3dom.nodeTypes.SurfaceShaderTexture(e),f=new x3dom.nodeTypes.ImageTexture(e),u=new x3dom.nodeTypes.SurfaceShaderTexture(e),_=new x3dom.nodeTypes.ImageTexture(e),m._nameSpace=t._nameSpace,p=o.e3(),h._vf.displacementFactor=t._vf.maxElevation,f._nameSpace=t._nameSpace,f._vf.url[0]=x,f._vf.repeatT=!1,f._vf.repeatS=!1,l.addChild(f,"texture"),f.nodeChanged(),h.addChild(l,"diffuseTexture"),l.nodeChanged(),_._nameSpace=t._nameSpace,_._vf.url[0]=v,_._vf.repeatT=!1,_._vf.repeatS=!1,u.addChild(_,"texture"),_.nodeChanged(),h.addChild(u,"displacementTexture"),_.nodeChanged(),d.addChild(h,"shaders"),h.nodeChanged(),m.addChild(d),d.nodeChanged(),m.addChild(a),a.nodeChanged(),t.addChild(m),m.nodeChanged(),y.boundedNode=m,y.volume=m.getVolume(),y.volume.max.z=Math.round(t._vf.maxElevation/2),y.volume.min.z=-y.volume.max.z}function OctreeNode(e,t,i,s){var o,n,r=[],a=s.e3(),d=new x3dom.nodeTypes.Shape(e),h={},l=(t._vf.octSize.x+t._vf.octSize.y+t._vf.octSize.z)/3;this.collectDrawables=function(o,n,f,u,_){if(h.localMatrix=s,(_=n.cull(o,h,f,_))>0){var c=n.viewMatrix.multMatrixPnt(o.multMatrixPnt(a));if(Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2)+Math.pow(c.z,2))<Math.pow(t._vf.maxDepth-i,2)*l/t._vf.factor)if(0===r.length)p=t._vf.octSize.multiply(.25),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,p.y,p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,p.y,p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,-p.y,p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,-p.y,p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,p.y,-p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,p.y,-p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-p.x,-p.y,-p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5))))),r.push(new OctreeNode(e,t,i+1,s.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(p.x,-p.y,-p.z))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,.5)))));else for(var m=0;m<r.length;m++)r[m].collectDrawables(s,n,f,u,_);else d.collectDrawableObjects(s,n,f,u,_,[])}var p},this.getVolume=function(){return d.getVolume()},o=new x3dom.nodeTypes.Appearance(e),(n=new x3dom.nodeTypes.Box(e))._vf.size=t._vf.octSize,n.fieldChanged("size"),d._nameSpace=new x3dom.NodeNameSpace("",t._nameSpace.doc),d._nameSpace.setBaseURL(t._nameSpace.baseURL),d.addChild(o),o.nodeChanged(),d.addChild(n),n.nodeChanged(),d.nodeChanged(),h.boundedNode=d,h.volume=d.getVolume()}function QuadtreeNode3D_32bit(e,t,i,s,o,n,r,a){var d=[],h=new x3dom.nodeTypes.Shape,l=null,f=t._vf.textureUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.textureFormat.toLowerCase(),u=t._vf.elevationUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.elevationFormat.toLowerCase(),_=t._vf.normalUrl+"/"+i+"/"+n+"/"+r+"."+t._vf.normalFormat.toLowerCase(),c=(t._vf.size.x+t._vf.size.y)/2,m={};this.collectDrawables=function(f,u,_,p,x){if(m.localMatrix=o,(x=u.cull(f,m,_,x))>0){var v=u.viewMatrix.multMatrixPnt(f.multMatrixPnt(l));if(Math.sqrt(Math.pow(v.x,2)+Math.pow(v.y,2)+Math.pow(v.z,2))<Math.pow(t._vf.maxDepth-i,2)*c/t._vf.factor)if(0===d.length&&0===t.createChildren)t.createChildren++,y=Math.sqrt(Math.pow(4,i)),S=Math.sqrt(Math.pow(4,i+1)),T=4*Math.floor(s/y)*y+s%y*2,F=T+1,C=(b=T+S)+1,M=t._vf.size.multiply(.25),d.push(new QuadtreeNode3D_32bit(e,t,i+1,T,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-M.x,M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r,a)),d.push(new QuadtreeNode3D_32bit(e,t,i+1,F,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(M.x,M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r,a)),d.push(new QuadtreeNode3D_32bit(e,t,i+1,b,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(-M.x,-M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n,2*r+1,a)),d.push(new QuadtreeNode3D_32bit(e,t,i+1,C,o.mult(x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f(M.x,-M.y,0))).mult(x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(.5,.5,1))),2*n+1,2*r+1,a)),h.collectDrawableObjects(o,u,_,p,x,[]);else if(0===d.length&&t.createChildren>0)h.collectDrawableObjects(o,u,_,p,x,[]);else for(var g=0;g<d.length;g++)d[g].collectDrawables(o,u,_,p,x);else h.collectDrawableObjects(o,u,_,p,x,[])}var y,S,T,F,b,C,M},this.getVolume=function(){return h.getVolume()},function(){var i=new x3dom.nodeTypes.Appearance(e),s=new x3dom.nodeTypes.MultiTexture(e),n=new x3dom.nodeTypes.ImageTexture(e),r=new x3dom.nodeTypes.ImageTexture(e),d=new x3dom.nodeTypes.ImageTexture(e),c=new x3dom.nodeTypes.ComposedShader(e);h._nameSpace=t._nameSpace,l=o.e3();var p=new x3dom.nodeTypes.ShaderPart(e);p._vf.type="vertex",p._vf.url[0]="attribute vec3 position;\nattribute vec3 texcoord;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform sampler2D texColor;\nuniform sampler2D texHeight;\nuniform float maxElevation;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\nconst float shininess = 32.0;\n\nvoid main(void) {\n    vec3 uLightPosition = vec3(160.0, -9346.0, 4806.0);\n    vec4 colr = texture2D(texColor, vec2(texcoord[0], 1.0-texcoord[1]));\n    vec3 uAmbientMaterial = vec3(1.0, 1.0, 0.9);    vec3 uAmbientLight = vec3(0.5, 0.5, 0.5);    vec3 uDiffuseMaterial = vec3(0.7, 0.7, 0.7);    vec3 uDiffuseLight = vec3(1.0, 1.0, 1.0);    vec4 vertexPositionEye4 = modelViewMatrix * vec4(position, 1.0);    vec3 vertexPositionEye3 = vec3((modelViewMatrix * vec4(vertexPositionEye4.xyz, 1.0)).xyz);    vec3 vectorToLightSource = normalize(uLightPosition - vertexPositionEye3);    vec4 height = texture2D(texHeight, vec2(texcoord[0], 1.0 - texcoord[1]));\n    vec4 normalEye = 2.0 * texture2D(texNormal, vec2(texcoord[0], 1.0-texcoord[1])) - 1.0;\n    float diffuseLightWeighting = max(dot(normalEye.xyz, vectorToLightSource), 0.0);    texC = vec2(texcoord[0], 1.0-texcoord[1]);\n    vec3 diffuseReflectance = uDiffuseMaterial * uDiffuseLight * diffuseLightWeighting;    vec3 uSpecularMaterial = vec3(0.0, 0.0, 0.0);    vec3 uSpecularLight = vec3(1.0, 1.0, 1.0);    vec3 reflectionVector = normalize(reflect(-vectorToLightSource, normalEye.xyz));    vec3 viewVectorEye = -normalize(vertexPositionEye3);    float rdotv = max(dot(reflectionVector, viewVectorEye), 0.0);    float specularLightWeight = pow(rdotv, shininess);    vec3 specularReflection = uSpecularMaterial * uSpecularLight * specularLightWeight;    vLight = vec4(uAmbientMaterial * uAmbientLight + diffuseReflectance + specularReflection, 1.0).xyz;    gl_Position = modelViewProjectionMatrix * vec4(position.xy, ((height.g * 256.0)+height.b) * maxElevation, 1.0);\n}\n";var x=new x3dom.nodeTypes.ShaderPart(e);x._vf.type="fragment",x._vf.url[0]="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D texColor;\nuniform sampler2D texNormal;\nvarying vec2 texC;\nvarying vec3 vLight;\n\n\nvoid main(void) {\n    vec4 normal = 2.0 * texture2D(texNormal, texC) - 1.0;\n    vec4 colr = texture2D(texColor, texC);\n    float coler = ((colr.g * 256.0)+colr.b);    gl_FragColor = vec4(vLight * coler, 1.0);\n}\n",c.addChild(p,"parts"),c.addChild(x,"parts"),n._nameSpace=t._nameSpace,n._vf.url[0]=f,n._vf.repeatT=!1,n._vf.repeatS=!1,n._vf.generateMipMaps=!1,s.addChild(n,"texture"),n.nodeChanged();var v=new x3dom.nodeTypes.Field(e);v._vf.name="texColor",v._vf.type="SFInt32",v._vf.value=0,c.addChild(v,"fields"),v.nodeChanged(),r._nameSpace=t._nameSpace,r._vf.url[0]=u,r._vf.repeatT=!1,r._vf.repeatS=!1,s.addChild(r,"texture"),r.nodeChanged();var g=new x3dom.nodeTypes.Field(e);g._vf.name="texHeight",g._vf.type="SFInt32",g._vf.value=1,c.addChild(g,"fields"),g.nodeChanged(),d._nameSpace=t._nameSpace,d._vf.url[0]=_,d._vf.repeatT=!1,d._vf.repeatS=!1,s.addChild(d,"texture"),d.nodeChanged();var y=new x3dom.nodeTypes.Field(e);y._vf.name="texNormal",y._vf.type="SFInt32",y._vf.value=2,c.addChild(y,"fields"),y.nodeChanged();var S=new x3dom.nodeTypes.Field(e);S._vf.name="maxElevation",S._vf.type="SFFloat",S._vf.value=t._vf.maxElevation,c.addChild(S,"fields"),S.nodeChanged(),i.addChild(s),s.nodeChanged(),i.addChild(c),c.nodeChanged(),h.addChild(i),i.nodeChanged(),h.addChild(a),a.nodeChanged(),t.addChild(h),h.nodeChanged(),m.boundedNode=h,m.volume=h.getVolume(),m.volume.max.z=Math.round(t._vf.maxElevation),m.volume.min.z=-m.volume.max.z}()}x3dom.fields.Eps=1e-6,x3dom.fields.SFMatrix4f=function(e,t,i,s,o,n,r,a,d,h,l,f,u,_,c,m){0===arguments.length?(this._00=1,this._01=0,this._02=0,this._03=0,this._10=0,this._11=1,this._12=0,this._13=0,this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):(this._00=e,this._01=t,this._02=i,this._03=s,this._10=o,this._11=n,this._12=r,this._13=a,this._20=d,this._21=h,this._22=l,this._23=f,this._30=u,this._31=_,this._32=c,this._33=m)},x3dom.fields.SFMatrix4f.prototype.e0=function(){return new x3dom.fields.SFVec3f(this._00,this._10,this._20).normalize()},x3dom.fields.SFMatrix4f.prototype.e1=function(){return new x3dom.fields.SFVec3f(this._01,this._11,this._21).normalize()},x3dom.fields.SFMatrix4f.prototype.e2=function(){return new x3dom.fields.SFVec3f(this._02,this._12,this._22).normalize()},x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)},x3dom.fields.SFMatrix4f.copy=function(e){return new x3dom.fields.SFMatrix4f(e._00,e._01,e._02,e._03,e._10,e._11,e._12,e._13,e._20,e._21,e._22,e._23,e._30,e._31,e._32,e._33)},x3dom.fields.SFMatrix4f.prototype.copy=function(){return x3dom.fields.SFMatrix4f.copy(this)},x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},x3dom.fields.SFMatrix4f.translation=function(e){return new x3dom.fields.SFMatrix4f(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationX=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationY=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1)},x3dom.fields.SFMatrix4f.rotationZ=function(e){var t=Math.cos(e),i=Math.sin(e);return new x3dom.fields.SFMatrix4f(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1)},x3dom.fields.SFMatrix4f.scale=function(e){return new x3dom.fields.SFMatrix4f(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1)},x3dom.fields.SFMatrix4f.lookAt=function(e,t,i){var s=e.subtract(t).normalize(),o=i.normalize().cross(s).normalize();if(o.dot(o)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(e);var n=s.cross(o).normalize(),r=x3dom.fields.SFMatrix4f.identity();return r.setValue(o,n,s,e),r},x3dom.fields.SFMatrix4f.perspectiveFrustum=function(e,t,i,s,o,n){return new x3dom.fields.SFMatrix4f(2*o/(t-e),0,(t+e)/(t-e),0,0,2*o/(s-i),(s+i)/(s-i),0,0,0,-(n+o)/(n-o),-2*n*o/(n-o),0,0,-1,0)},x3dom.fields.SFMatrix4f.perspective=function(e,t,i,s){var o=1/Math.tan(e/2);return new x3dom.fields.SFMatrix4f(o/t,0,0,0,0,o,0,0,0,0,(i+s)/(i-s),2*i*s/(i-s),0,0,-1,0)},x3dom.fields.SFMatrix4f.ortho=function(e,t,i,s,o,n,r){var a=(t-e)/2,d=(s-i)/2,h=n-o;return void 0===r&&(r=1),r<a/d?d=a/r:a=d*r,e=-a,t=a,i=-d,s=d,a*=2,d*=2,new x3dom.fields.SFMatrix4f(2/a,0,0,-(t+e)/a,0,2/d,0,-(s+i)/d,0,0,-2/h,-(n+o)/h,0,0,0,1)},x3dom.fields.SFMatrix4f.prototype.setTranslate=function(e){this._03=e.x,this._13=e.y,this._23=e.z},x3dom.fields.SFMatrix4f.prototype.setScale=function(e){this._00=e.x,this._11=e.y,this._22=e.z},x3dom.fields.SFMatrix4f.prototype.setRotate=function(e){var t=e.x*e.x,i=e.x*e.y,s=e.x*e.z,o=e.y*e.y,n=e.y*e.z,r=e.z*e.z,a=e.w*e.x,d=e.w*e.y,h=e.w*e.z;this._00=1-2*(o+r),this._01=2*(i-h),this._02=2*(s+d),this._10=2*(i+h),this._11=1-2*(t+r),this._12=2*(n-a),this._20=2*(s-d),this._21=2*(n+a),this._22=1-2*(t+o)},x3dom.fields.SFMatrix4f.parseRotation=function(e){var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e),i=+t[1],s=+t[2],o=+t[3],n=+t[4],r=Math.sqrt(i*i+s*s+o*o);0===r?(i=1,s=o=0):(i/=r,s/=r,o/=r);var a=Math.cos(n),d=Math.sin(n),h=1-a;return new x3dom.fields.SFMatrix4f(h*i*i+a,h*i*s+d*o,h*i*o-d*s,0,h*i*s-d*o,h*s*s+a,h*s*o+d*i,0,h*i*o+d*s,h*s*o-d*i,h*o*o+a,0,0,0,0,1).transpose()},x3dom.fields.SFMatrix4f.parse=function(e){var t=!1;/matrix.*\((.+)\)/.exec(e)&&(e=RegExp.$1,t=!0);var i=e.split(/[,\s]+/).map((function(e){return+e}));return i.length>=16?t?new x3dom.fields.SFMatrix4f(i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]):new x3dom.fields.SFMatrix4f(i[0],i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],i[10],i[11],i[12],i[13],i[14],i[15]):6===i.length?new x3dom.fields.SFMatrix4f(i[0],i[1],0,i[4],i[2],i[3],0,i[5],0,0,1,0,0,0,0,1):(x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),x3dom.fields.SFMatrix4f.identity())},x3dom.fields.SFMatrix4f.prototype.mult=function(e){return new x3dom.fields.SFMatrix4f(this._00*e._00+this._01*e._10+this._02*e._20+this._03*e._30,this._00*e._01+this._01*e._11+this._02*e._21+this._03*e._31,this._00*e._02+this._01*e._12+this._02*e._22+this._03*e._32,this._00*e._03+this._01*e._13+this._02*e._23+this._03*e._33,this._10*e._00+this._11*e._10+this._12*e._20+this._13*e._30,this._10*e._01+this._11*e._11+this._12*e._21+this._13*e._31,this._10*e._02+this._11*e._12+this._12*e._22+this._13*e._32,this._10*e._03+this._11*e._13+this._12*e._23+this._13*e._33,this._20*e._00+this._21*e._10+this._22*e._20+this._23*e._30,this._20*e._01+this._21*e._11+this._22*e._21+this._23*e._31,this._20*e._02+this._21*e._12+this._22*e._22+this._23*e._32,this._20*e._03+this._21*e._13+this._22*e._23+this._23*e._33,this._30*e._00+this._31*e._10+this._32*e._20+this._33*e._30,this._30*e._01+this._31*e._11+this._32*e._21+this._33*e._31,this._30*e._02+this._31*e._12+this._32*e._22+this._33*e._32,this._30*e._03+this._31*e._13+this._32*e._23+this._33*e._33)},x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z+this._03,this._10*e.x+this._11*e.y+this._12*e.z+this._13,this._20*e.x+this._21*e.y+this._22*e.z+this._23)},x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(e){return new x3dom.fields.SFVec3f(this._00*e.x+this._01*e.y+this._02*e.z,this._10*e.x+this._11*e.y+this._12*e.z,this._20*e.x+this._21*e.y+this._22*e.z)},x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(e){var t=this._30*e.x+this._31*e.y+this._32*e.z+this._33;return t&&(t=1/t),new x3dom.fields.SFVec3f((this._00*e.x+this._01*e.y+this._02*e.z+this._03)*t,(this._10*e.x+this._11*e.y+this._12*e.z+this._13)*t,(this._20*e.x+this._21*e.y+this._22*e.z+this._23)*t)},x3dom.fields.SFMatrix4f.prototype.multMatrixPlane=function(e){var t=new x3dom.fields.SFVec3f(e.x,e.y,e.z),i=t.multiply(-e.w);i=this.multMatrixPnt(i);var s=-(t=this.inverse().transpose().multMatrixVec(t)).dot(i);return new x3dom.fields.SFVec4f(t.x,t.y,t.z,s)},x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)},x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f(-this._00,-this._01,-this._02,-this._03,-this._10,-this._11,-this._12,-this._13,-this._20,-this._21,-this._22,-this._23,-this._30,-this._31,-this._32,-this._33)},x3dom.fields.SFMatrix4f.prototype.multiply=function(e){return new x3dom.fields.SFMatrix4f(e*this._00,e*this._01,e*this._02,e*this._03,e*this._10,e*this._11,e*this._12,e*this._13,e*this._20,e*this._21,e*this._22,e*this._23,e*this._30,e*this._31,e*this._32,e*this._33)},x3dom.fields.SFMatrix4f.prototype.add=function(e){return new x3dom.fields.SFMatrix4f(this._00+e._00,this._01+e._01,this._02+e._02,this._03+e._03,this._10+e._10,this._11+e._11,this._12+e._12,this._13+e._13,this._20+e._20,this._21+e._21,this._22+e._22,this._23+e._23,this._30+e._30,this._31+e._31,this._32+e._32,this._33+e._33)},x3dom.fields.SFMatrix4f.prototype.addScaled=function(e,t){return new x3dom.fields.SFMatrix4f(this._00+t*e._00,this._01+t*e._01,this._02+t*e._02,this._03+t*e._03,this._10+t*e._10,this._11+t*e._11,this._12+t*e._12,this._13+t*e._13,this._20+t*e._20,this._21+t*e._21,this._22+t*e._22,this._23+t*e._23,this._30+t*e._30,this._31+t*e._31,this._32+t*e._32,this._33+t*e._33)},x3dom.fields.SFMatrix4f.prototype.setValues=function(e){this._00=e._00,this._01=e._01,this._02=e._02,this._03=e._03,this._10=e._10,this._11=e._11,this._12=e._12,this._13=e._13,this._20=e._20,this._21=e._21,this._22=e._22,this._23=e._23,this._30=e._30,this._31=e._31,this._32=e._32,this._33=e._33},x3dom.fields.SFMatrix4f.prototype.setValue=function(e,t,i,s){this._00=e.x,this._01=t.x,this._02=i.x,this._10=e.y,this._11=t.y,this._12=i.y,this._20=e.z,this._21=t.z,this._22=i.z,this._30=0,this._31=0,this._32=0,arguments.length>3&&(this._03=s.x,this._13=s.y,this._23=s.z,this._33=1)},x3dom.fields.SFMatrix4f.prototype.setFromArray=function(e){return this._00=e[0],this._01=e[4],this._02=e[8],this._03=e[12],this._10=e[1],this._11=e[5],this._12=e[9],this._13=e[13],this._20=e[2],this._21=e[6],this._22=e[10],this._23=e[14],this._30=e[3],this._31=e[7],this._32=e[11],this._33=e[15],this},x3dom.fields.SFMatrix4f.fromArray=function(e){var t=new x3dom.fields.SFMatrix4f;return t._00=e[0],t._01=e[4],t._02=e[8],t._03=e[12],t._10=e[1],t._11=e[5],t._12=e[9],t._13=e[13],t._20=e[2],t._21=e[6],t._22=e[10],t._23=e[14],t._30=e[3],t._31=e[7],t._32=e[11],t._33=e[15],t},x3dom.fields.SFMatrix4f.prototype.fromRotationTranslationScale=function(e,t,i){t=t||new x3dom.fields.SFVec3f,e=e||new x3dom.fields.Quaternion,i=i||new x3dom.fields.SFVec3f(1,1,1);var s=e.x,o=e.y,n=e.z,r=e.w,a=s+s,d=o+o,h=n+n,l=s*a,f=s*d,u=s*h,_=o*d,c=o*h,m=n*h,p=r*a,x=r*d,v=r*h;return this._00=(1-(_+m))*i.x,this._10=(f+v)*i.x,this._20=(u-x)*i.x,this._30=0,this._01=(f-v)*i.y,this._11=(1-(l+m))*i.y,this._21=(c+p)*i.y,this._31=0,this._02=(u+x)*i.z,this._12=(c-p)*i.z,this._22=(1-(l+_))*i.z,this._32=0,this._03=t.x,this._13=t.y,this._23=t.z,this._33=1,this},x3dom.fields.SFMatrix4f.fromRotationTranslationScale=function(e,t,i){t=t||new x3dom.fields.SFVec3f,e=e||new x3dom.fields.Quaternion,i=i||new x3dom.fields.SFVec3f(1,1,1);var s=new x3dom.fields.SFMatrix4f,o=e.x,n=e.y,r=e.z,a=e.w,d=o+o,h=n+n,l=r+r,f=o*d,u=o*h,_=o*l,c=n*h,m=n*l,p=r*l,x=a*d,v=a*h,g=a*l;return s._00=(1-(c+p))*i.x,s._10=(u+g)*i.x,s._20=(_-v)*i.x,s._30=0,s._01=(u-g)*i.y,s._11=(1-(f+p))*i.y,s._21=(m+x)*i.y,s._31=0,s._02=(_+v)*i.z,s._12=(m-x)*i.z,s._22=(1-(f+c))*i.z,s._32=0,s._03=t.x,s._13=t.y,s._23=t.z,s._33=1,s},x3dom.fields.SFMatrix4f.prototype.toGL=function(){return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]},x3dom.fields.SFMatrix4f.fromGL=function(e){var t=new x3dom.fields.SFMatrix4f;return t._00=e[0],t._01=e[4],t._02=e[8],t._03=e[12],t._10=e[1],t._11=e[5],t._12=e[9],t._13=e[13],t._20=e[2],t._21=e[6],t._22=e[10],t._23=e[14],t._30=e[3],t._31=e[7],t._32=e[11],t._33=e[15],t},x3dom.fields.SFMatrix4f.prototype.at=function(e,t){return this["_"+e+t]},x3dom.fields.SFMatrix4f.prototype.setAt=function(e,t,i){return this["_"+e+t]=i,this},x3dom.fields.SFMatrix4f.prototype.sqrt=function(){for(var e=x3dom.fields.SFMatrix4f.identity(),t=x3dom.fields.SFMatrix4f.copy(this),i=0;i<6;i++){var s=t.inverse(),o=0==i?x3dom.fields.SFMatrix4f.identity():e.inverse(),n=t.det(),r=e.det(),a=Math.abs(Math.pow(n*r,-.125)),d=1/a;t=(t=(t=t.multiply(a)).addScaled(o,d)).multiply(.5),e=(e=(e=e.multiply(a)).addScaled(s,d)).multiply(.5)}return t},x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var e=0,t=0;return(e=Math.abs(this._00))>t&&(t=e),(e=Math.abs(this._01))>t&&(t=e),(e=Math.abs(this._02))>t&&(t=e),(e=Math.abs(this._03))>t&&(t=e),(e=Math.abs(this._10))>t&&(t=e),(e=Math.abs(this._11))>t&&(t=e),(e=Math.abs(this._12))>t&&(t=e),(e=Math.abs(this._13))>t&&(t=e),(e=Math.abs(this._20))>t&&(t=e),(e=Math.abs(this._21))>t&&(t=e),(e=Math.abs(this._22))>t&&(t=e),(e=Math.abs(this._23))>t&&(t=e),(e=Math.abs(this._30))>t&&(t=e),(e=Math.abs(this._31))>t&&(t=e),(e=Math.abs(this._32))>t&&(t=e),(e=Math.abs(this._33))>t&&(t=e),t},x3dom.fields.SFMatrix4f.prototype.norm1_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._10)+Math.abs(this._20),t=0;return(t=Math.abs(this._01)+Math.abs(this._11)+Math.abs(this._21))>e&&(e=t),(t=Math.abs(this._02)+Math.abs(this._12)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.normInf_3x3=function(){var e=Math.abs(this._00)+Math.abs(this._01)+Math.abs(this._02),t=0;return(t=Math.abs(this._10)+Math.abs(this._11)+Math.abs(this._12))>e&&(e=t),(t=Math.abs(this._20)+Math.abs(this._21)+Math.abs(this._22))>e&&(e=t),e},x3dom.fields.SFMatrix4f.prototype.adjointT_3x3=function(){var e=x3dom.fields.SFMatrix4f.identity();return e._00=this._11*this._22-this._12*this._21,e._01=this._12*this._20-this._10*this._22,e._02=this._10*this._21-this._11*this._20,e._10=this._21*this._02-this._22*this._01,e._11=this._22*this._00-this._20*this._02,e._12=this._20*this._01-this._21*this._00,e._20=this._01*this._12-this._02*this._11,e._21=this._02*this._10-this._00*this._12,e._22=this._00*this._11-this._01*this._10,e},x3dom.fields.SFMatrix4f.prototype.equals=function(e){var t=1e-12;return Math.abs(this._00-e._00)<t&&Math.abs(this._01-e._01)<t&&Math.abs(this._02-e._02)<t&&Math.abs(this._03-e._03)<t&&Math.abs(this._10-e._10)<t&&Math.abs(this._11-e._11)<t&&Math.abs(this._12-e._12)<t&&Math.abs(this._13-e._13)<t&&Math.abs(this._20-e._20)<t&&Math.abs(this._21-e._21)<t&&Math.abs(this._22-e._22)<t&&Math.abs(this._23-e._23)<t&&Math.abs(this._30-e._30)<t&&Math.abs(this._31-e._31)<t&&Math.abs(this._32-e._32)<t&&Math.abs(this._33-e._33)<t},x3dom.fields.SFMatrix4f.prototype.getTransform=function(e,t,i,s,o){var n=null;if(arguments.length>4){n=(n=x3dom.fields.SFMatrix4f.translation(o.negate())).mult(this);var r=x3dom.fields.SFMatrix4f.translation(o);n=n.mult(r)}else n=x3dom.fields.SFMatrix4f.copy(this);var a=n.decompose(e,t,i,s);i.setValues(i.multiply(a))},x3dom.fields.SFMatrix4f.prototype.decompose=function(e,t,i,s){var o=x3dom.fields.SFMatrix4f.copy(this),n=x3dom.fields.SFMatrix4f.identity(),r=x3dom.fields.SFMatrix4f.identity(),a=x3dom.fields.SFMatrix4f.identity();e.x=o._03,e.y=o._13,e.z=o._23,o._03=0,o._13=0,o._23=0,o._30=0,o._31=0,o._32=0;var d=1;return o.polarDecompose(n,r)<0&&(n=n.negate(),d=-1),t.setValue(n),r.spectralDecompose(a,i),s.setValue(a),d},x3dom.fields.SFMatrix4f.prototype.polarDecompose=function(e,t){var i,s,o,n,r,a=this.transpose(),d=x3dom.fields.SFMatrix4f.identity(),h=a.norm1_3x3(),l=a.normInf_3x3();do{if(i=a.adjointT_3x3(),0==(r=a._00*i._00+a._01*i._01+a._02*i._02)){x3dom.debug.logWarning("polarDecompose: Mk_det == 0.0");break}s=i.norm1_3x3(),o=i.normInf_3x3();var f=Math.sqrt(Math.sqrt(s*o/(h*l))/Math.abs(r)),u=.5*f,_=.5/(f*r);d.setValues(a),a=(a=a.multiply(u)).addScaled(i,_),n=(d=d.addScaled(a,-1)).norm1_3x3(),h=a.norm1_3x3(),l=a.normInf_3x3()}while(n>1e-12*h);e.setValues(a.transpose()),t.setValues(a.mult(this));for(var c=0;c<3;++c)for(var m=c;m<3;++m)t.setAt(m,c,.5*(t.at(m,c)+t.at(c,m))),t.setAt(c,m,.5*(t.at(m,c)+t.at(c,m)));return r},x3dom.fields.SFMatrix4f.prototype.spectralDecompose=function(e,t){for(var i=[1,2,0],s=[this._00,this._11,this._22],o=[this._12,this._20,this._01],n=0;n<20;++n){if(0==Math.abs(o[0])+Math.abs(o[1])+Math.abs(o[2]))break;for(var r=2;r>=0;--r){var a=i[r],d=i[a],h=Math.abs(o[r]),l=100*h;if(h>0){var f=0,u=s[d]-s[a],_=Math.abs(u);if(_+l==_)f=o[r]/u;else{var c=.5*u/o[r];f=1/(Math.abs(c)+Math.sqrt(c*c+1)),f=c<0?-f:f}var m=1/Math.sqrt(f*f+1),p=f*m,x=p/(m+1),v=f*o[r];o[r]=0,s[a]-=v,s[d]+=v;var g=o[d];o[d]-=p*(o[a]+x*g),o[a]+=p*(g-x*o[a]);for(var y=2;y>=0;--y){var S=e.at(y,a),T=e.at(y,d);e.setAt(y,a,e.at(y,a)-p*(T+x*S)),e.setAt(y,d,e.at(y,d)+p*(S-x*T))}}}}t.x=s[0],t.y=s[1],t.z=s[2]},x3dom.fields.SFMatrix4f.prototype.log=function(){var e=x3dom.fields.SFMatrix4f.copy(this),t=x3dom.fields.SFMatrix4f.copy(this);t._00-=1,t._11-=1,t._22-=1,t._33-=1;for(var i=0;t.normInfinity()>.5;)e=e.sqrt(),t.setValues(e),t._00-=1,t._11-=1,t._22-=1,t._33-=1,i++;e._00-=1,e._11-=1,e._22-=1,e._33-=1,e=e.negate(),t.setValues(e);for(var s=x3dom.fields.SFMatrix4f.copy(e),o=1;t.normInfinity()>1e-12&&o<12;)t=t.mult(e),o++,s=s.addScaled(t,1/o);return s.multiply(-(1<<i))},x3dom.fields.SFMatrix4f.prototype.exp=function(){var e=x3dom.fields.SFMatrix4f.copy(this),t=x3dom.fields.SFMatrix4f.identity(),i=x3dom.fields.SFMatrix4f.identity(),s=x3dom.fields.SFMatrix4f.identity(),o=0,n=1,r=1+parseInt(Math.log(e.normInfinity()/.693));for(r<0&&(r=0),e=e.multiply(1/(1<<r)),o=1;o<=6;o++)n*=(6-o+1)/(o*(12-o+1)),s=e.mult(s),i=i.addScaled(s,n),t=o%2?t.addScaled(s,-n):t.addScaled(s,n);for(s=t.inverse().mult(i),o=0;o<r;o++)s=s.mult(s);return s},x3dom.fields.SFMatrix4f.prototype.det3=function(e,t,i,s,o,n,r,a,d){return e*o*d+t*n*r+i*s*a-e*n*a-t*s*d-i*o*r},x3dom.fields.SFMatrix4f.prototype.det=function(){var e=this._00,t=this._10,i=this._20,s=this._30,o=this._01,n=this._11,r=this._21,a=this._31,d=this._02,h=this._12,l=this._22,f=this._32,u=this._03,_=this._13,c=this._23,m=this._33;return e*this.det3(n,h,_,r,l,c,a,f,m)-t*this.det3(o,d,u,r,l,c,a,f,m)+i*this.det3(o,d,u,n,h,_,a,f,m)-s*this.det3(o,d,u,n,h,_,r,l,c)},x3dom.fields.SFMatrix4f.prototype.inverse=function(){var e=this._00,t=this._10,i=this._20,s=this._30,o=this._01,n=this._11,r=this._21,a=this._31,d=this._02,h=this._12,l=this._22,f=this._32,u=this._03,_=this._13,c=this._23,m=this._33,p=this.det();return 0==p?(x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity()):(p=1/p,new x3dom.fields.SFMatrix4f(+this.det3(n,h,_,r,l,c,a,f,m)*p,-this.det3(o,d,u,r,l,c,a,f,m)*p,+this.det3(o,d,u,n,h,_,a,f,m)*p,-this.det3(o,d,u,n,h,_,r,l,c)*p,-this.det3(t,h,_,i,l,c,s,f,m)*p,+this.det3(e,d,u,i,l,c,s,f,m)*p,-this.det3(e,d,u,t,h,_,s,f,m)*p,+this.det3(e,d,u,t,h,_,i,l,c)*p,+this.det3(t,n,_,i,r,c,s,a,m)*p,-this.det3(e,o,u,i,r,c,s,a,m)*p,+this.det3(e,o,u,t,n,_,s,a,m)*p,-this.det3(e,o,u,t,n,_,i,r,c)*p,-this.det3(t,n,h,i,r,l,s,a,f)*p,+this.det3(e,o,d,i,r,l,s,a,f)*p,-this.det3(e,o,d,t,n,h,s,a,f)*p,+this.det3(e,o,d,t,n,h,i,r,l)*p))},x3dom.fields.SFMatrix4f.prototype.getEulerAngles=function(){var e,t,i,s,o,n,r,a;return Math.abs(Math.abs(this._20)-1)>1e-4?(e=-Math.asin(this._20),t=Math.PI-e,r=Math.cos(e),a=Math.cos(t),s=Math.atan2(this._21/r,this._22/r),o=Math.atan2(this._21/a,this._22/a),[s,e,Math.atan2(this._10/r,this._00/r),o,t,Math.atan2(this._10/a,this._00/a)]):(0,-1==this._20?(i=Math.PI/2,n=0+Math.atan2(this._01,this._02)):(i=-Math.PI/2,n=-0+Math.atan2(-this._01,-this._02)),[n,i,0,n,i,0])},x3dom.fields.SFMatrix4f.prototype.toString=function(){return this._00.toFixed(6)+" "+this._10.toFixed(6)+" "+this._20.toFixed(6)+" "+this._30.toFixed(6)+" "+this._01.toFixed(6)+" "+this._11.toFixed(6)+" "+this._21.toFixed(6)+" "+this._31.toFixed(6)+" "+this._02.toFixed(6)+" "+this._12.toFixed(6)+" "+this._22.toFixed(6)+" "+this._32.toFixed(6)+" "+this._03.toFixed(6)+" "+this._13.toFixed(6)+" "+this._23.toFixed(6)+" "+this._33.toFixed(6)},x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(e){var t=!1;/matrix.*\((.+)\)/.exec(e)&&(e=RegExp.$1,t=!0);var i=e.split(/[,\s]+/).map((function(e){return+e}));return i.length>=16?t?(this._00=i[0],this._01=i[4],this._02=i[8],this._03=i[12],this._10=i[1],this._11=i[5],this._12=i[9],this._13=i[13],this._20=i[2],this._21=i[6],this._22=i[10],this._23=i[14],this._30=i[3],this._31=i[7],this._32=i[11],this._33=i[15]):(this._00=i[0],this._01=i[1],this._02=i[2],this._03=i[3],this._10=i[4],this._11=i[5],this._12=i[6],this._13=i[7],this._20=i[8],this._21=i[9],this._22=i[10],this._23=i[11],this._30=i[12],this._31=i[13],this._32=i[14],this._33=i[15]):6===i.length?(this._00=i[0],this._01=i[1],this._02=0,this._03=i[4],this._10=i[2],this._11=i[3],this._12=0,this._13=i[5],this._20=0,this._21=0,this._22=1,this._23=0,this._30=0,this._31=0,this._32=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+e),this},x3dom.fields.SFVec2f=function(e,t){0===arguments.length?(this.x=0,this.y=0):(this.x=e,this.y=t)},x3dom.fields.SFVec2f.copy=function(e){return new x3dom.fields.SFVec2f(e.x,e.y)},x3dom.fields.SFVec2f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return null===t?new x3dom.fields.SFVec2f:new x3dom.fields.SFVec2f(+t[1],+t[2])},x3dom.fields.SFVec2f.prototype.copy=function(){return x3dom.fields.SFVec2f.copy(this)},x3dom.fields.SFVec2f.prototype.setValues=function(e){return this.x=e.x,this.y=e.y,this},x3dom.fields.SFVec2f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;default:return this.x}},x3dom.fields.SFVec2f.prototype.add=function(e){return new x3dom.fields.SFVec2f(this.x+e.x,this.y+e.y)},x3dom.fields.SFVec2f.prototype.subtract=function(e){return new x3dom.fields.SFVec2f(this.x-e.x,this.y-e.y)},x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f(-this.x,-this.y)},x3dom.fields.SFVec2f.prototype.dot=function(e){return this.x*e.x+this.y*e.y},x3dom.fields.SFVec2f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec2f(this.x-t*e.x,this.y-t*e.y)},x3dom.fields.SFVec2f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.multComponents=function(e){return new x3dom.fields.SFVec2f(this.x*e.x,this.y*e.y)},x3dom.fields.SFVec2f.prototype.multiply=function(e){return new x3dom.fields.SFVec2f(this.x*e,this.y*e)},x3dom.fields.SFVec2f.prototype.divideComponents=function(e){return new x3dom.fields.SFVec2f(this.x/e.x,this.y/e.y)},x3dom.fields.SFVec2f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec2f(this.x*t,this.y*t)},x3dom.fields.SFVec2f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t},x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]},x3dom.fields.SFVec2f.prototype.toString=function(){return this.x+" "+this.y},x3dom.fields.SFVec2f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return t=t||[0,0,0],this.x=+t[1],this.y=+t[2],this},x3dom.fields.SFVec3f=function(e,t,i){0===arguments.length?(this.x=0,this.y=0,this.z=0):(this.x=e,this.y=t,this.z=i)},x3dom.fields.SFVec3f.NullVector=new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.SFVec3f.OneVector=new x3dom.fields.SFVec3f(1,1,1),x3dom.fields.SFVec3f.copy=function(e){return new x3dom.fields.SFVec3f(e.x,e.y,e.z)},x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)},x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},x3dom.fields.SFVec3f.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3])}catch(t){var i=x3dom.fields.SFColor.colorParse(e);return new x3dom.fields.SFVec3f(i.r,i.g,i.b)}},x3dom.fields.SFVec3f.prototype.copy=function(){return x3dom.fields.SFVec3f.copy(this)},x3dom.fields.SFVec3f.prototype.fromArray=function(e){return this.x=e[0],this.y=e[1],this.z=e[2],this},x3dom.fields.SFVec3f.fromArray=function(e){return new x3dom.fields.SFVec3f(e[0],e[1],e[2])},x3dom.fields.SFVec3f.prototype.setValues=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},x3dom.fields.SFVec3f.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},x3dom.fields.SFVec3f.prototype.at=function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:return this.x}},x3dom.fields.SFVec3f.prototype.add=function(e){return new x3dom.fields.SFVec3f(this.x+e.x,this.y+e.y,this.z+e.z)},x3dom.fields.SFVec3f.prototype.addScaled=function(e,t){return new x3dom.fields.SFVec3f(this.x+t*e.x,this.y+t*e.y,this.z+t*e.z)},x3dom.fields.SFVec3f.prototype.subtract=function(e){return new x3dom.fields.SFVec3f(this.x-e.x,this.y-e.y,this.z-e.z)},x3dom.fields.SFVec3f.prototype.subtractVectors=function(e,t){return new x3dom.fields.SFVec3f(e.x-t.x,e.y-t.y,e.z-t.z)},x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f(-this.x,-this.y,-this.z)},x3dom.fields.SFVec3f.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},x3dom.fields.SFVec3f.prototype.cross=function(e){return new x3dom.fields.SFVec3f(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)},x3dom.fields.SFVec3f.prototype.reflect=function(e){var t=2*this.dot(e);return new x3dom.fields.SFVec3f(this.x-t*e.x,this.y-t*e.y,this.z-t*e.z)},x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},x3dom.fields.SFVec3f.prototype.normalize=function(){var e=this.length();return e&&(e=1/e),new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.multComponents=function(e){return new x3dom.fields.SFVec3f(this.x*e.x,this.y*e.y,this.z*e.z)},x3dom.fields.SFVec3f.prototype.multiply=function(e){return new x3dom.fields.SFVec3f(this.x*e,this.y*e,this.z*e)},x3dom.fields.SFVec3f.prototype.divide=function(e){var t=e?1/e:1;return new x3dom.fields.SFVec3f(this.x*t,this.y*t,this.z*t)},x3dom.fields.SFVec3f.prototype.equals=function(e,t){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t},x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]},x3dom.fields.SFVec3f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z},x3dom.fields.SFVec3f.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.x=+t[1],this.y=+t[2],this.z=+t[3]}catch(t){var i=x3dom.fields.SFColor.colorParse(e);this.x=i.r,this.y=i.g,this.z=i.b}return this},x3dom.fields.SFVec4f=function(e,t,i,s){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x=e,this.y=t,this.z=i,this.w=s)},x3dom.fields.SFVec4f.copy=function(e){return new x3dom.fields.SFVec4f(e.x,e.y,e.z,e.w)},x3dom.fields.SFVec4f.prototype.copy=function(){return x3dom.fields.SFVec4f(this)},x3dom.fields.SFVec4f.parse=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return null===t?new x3dom.fields.SFVec4f:new x3dom.fields.SFVec4f(+t[1],+t[2],+t[3],+t[4])},x3dom.fields.SFVec4f.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return t=t||[0,0,0,0,0],this.x=+t[1],this.y=+t[2],this.z=+t[3],this.w=+t[4],this},x3dom.fields.SFVec4f.prototype.toGL=function(){return[this.x,this.y,this.z,this.w]},x3dom.fields.SFVec4f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+" "+this.w},x3dom.fields.Quaternion=function(e,t,i,s){0===arguments.length?(this.x=0,this.y=0,this.z=0,this.w=1):(this.x=e,this.y=t,this.z=i,this.w=s)},x3dom.fields.SFRotation=new Proxy(x3dom.fields.Quaternion,{construct:function(e,t){var i;t[0]=t[0]||0,t[1]=null==t[1]?1:t[1],t[2]=t[2]||0,t[3]=t[3]||0;var s={get:function(e,t){switch(t){case"0":return e.SFRotation.x;case"1":return e.SFRotation.y;case"2":return e.SFRotation.z;case"3":case"angle":return e.SFRotation.angle;default:return Reflect.get(e,t)}},set:function(e,t,i){var s=e.SFRotation,o={0:"x",1:"y",2:"z",x:"x",y:"y",z:"z",angle:"angle"};return t in o?(s[o[t]]=i,e.setValues(new x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(s.x,s.y,s.z),s.angle)),!0):(x3dom.debug.logWarning(" SFRotation: property not available - "+t),!1)}};if(t[0].constructor==x3dom.fields.SFVec3f){var o=(i=t[1].constructor==x3dom.fields.SFVec3f?new x3dom.fields.Quaternion.rotateFromTo(t[0].normalize(),t[1].normalize()):new x3dom.fields.Quaternion.axisAngle(t[0],t[1])).toAxisAngle();i.SFRotation={x:o[0].x,y:o[0].y,z:o[0].z,angle:o[1]}}else(i=new x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(t[0],t[1],t[2]),t[3])).SFRotation={x:t[0],y:t[1],z:t[2],angle:t[3]};return new Proxy(i,s)}}),x3dom.fields.Quaternion.prototype.getAxis=function(){if("SFRotation"in this){var e=this.SFRotation;return new x3dom.fields.SFVec3f(e.x,e.y,e.z)}return this.toAxisAngle()[0]},x3dom.fields.Quaternion.prototype.setAxis=function(e){var t;"SFRotation"in this?(t=this.SFRotation.angle,this.SFRotation.x=e.x,this.SFRotation.y=e.y,this.SFRotation.z=e.z):t=this.angle();var i=new x3dom.fields.Quaternion.axisAngle(e,t);this.setValues(i)},x3dom.fields.Quaternion.prototype.multiVec=function(e){var t=x3dom.fields.SFMatrix4f.identity();return t.setRotate(this),t.multMatrixVec(e)},x3dom.fields.Quaternion.prototype.setValues=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},x3dom.fields.Quaternion.copy=function(e){return new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w)},x3dom.fields.Quaternion.prototype.multiply=function(e){var t=new x3dom.fields.Quaternion(this.w*e.x+this.x*e.w+this.y*e.z-this.z*e.y,this.w*e.y+this.y*e.w+this.z*e.x-this.x*e.z,this.w*e.z+this.z*e.w+this.x*e.y-this.y*e.x,this.w*e.w-this.x*e.x-this.y*e.y-this.z*e.z);if("SFRotation"in this){var i=t.toAxisAngle();return new x3dom.fields.SFRotation(i[0].x,i[0].y,i[0].z,i[1])}return t},x3dom.fields.Quaternion.prototype.fromArray=function(e){return this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3],this},x3dom.fields.Quaternion.fromArray=function(e){return new x3dom.fields.Quaternion(e[0],e[1],e[2],e[3])},x3dom.fields.Quaternion.parseAxisAngle=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return null===t?new x3dom.fields.Quaternion:x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4])},x3dom.fields.Quaternion.axisAngle=function(e,t){var i=e.length();if(i>x3dom.fields.Eps){var s=Math.sin(t/2)/i,o=Math.cos(t/2);return new x3dom.fields.Quaternion(e.x*s,e.y*s,e.z*s,o)}return new x3dom.fields.Quaternion(0,0,0,1)},x3dom.fields.Quaternion.prototype.copy=function(){return x3dom.fields.Quaternion.copy(this)},x3dom.fields.Quaternion.prototype.toMatrix=function(){var e=this.x*this.x,t=this.x*this.y,i=this.x*this.z,s=this.y*this.y,o=this.y*this.z,n=this.z*this.z,r=this.w*this.x,a=this.w*this.y,d=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(s+n),2*(t-d),2*(i+a),0,2*(t+d),1-2*(e+n),2*(o-r),0,2*(i-a),2*(o+r),1-2*(e+s),0,0,0,0,1)},x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var e,t,i=0,s=0,o=0;return this.w>1&&this.normalize(),t=2*Math.acos(this.w),0==(e=Math.sqrt(1-this.w*this.w))?(i=this.x,s=this.y,o=this.z):(i=this.x/e,s=this.y/e,o=this.z/e),[new x3dom.fields.SFVec3f(i,s,o),t]},x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)},x3dom.fields.Quaternion.prototype.setValue=function(e){var t,i=1,s=[0,0,0],o=0,n=0,r=0,a=[1,2,0];if((t=e._00+e._11+e._22)>0?(i=Math.sqrt(t+1),this.w=.5*i,i=.5/i,this.x=(e._21-e._12)*i,this.y=(e._02-e._20)*i,this.z=(e._10-e._01)*i):(o=e._11>e._00?1:0,e._22>e.at(o,o)&&(o=2),r=a[n=a[o]],i=Math.sqrt(e.at(o,o)-(e.at(n,n)+e.at(r,r))+1),s[o]=.5*i,i=.5/i,this.w=(e.at(r,n)-e.at(n,r))*i,s[n]=(e.at(n,o)+e.at(o,n))*i,s[r]=(e.at(r,o)+e.at(o,r))*i,this.x=s[0],this.y=s[1],this.z=s[2]),this.w>1||this.w<-1){var d=1+100*x3dom.fields.Eps;(this.w>d||this.w<-d)&&x3dom.debug.logInfo("MatToQuat: BUG: |quat[4]| ("+this.w+") >> 1.0 !"),this.w>1?this.w=1:this.w=-1}},x3dom.fields.Quaternion.prototype.setFromEuler=function(e,t,i){var s=Math.sin(.5*e),o=Math.cos(.5*e),n=Math.sin(.5*t),r=Math.cos(.5*t),a=Math.sin(.5*i),d=Math.cos(.5*i);return this.x=s*r*d-o*n*a,this.y=o*n*d+s*r*a,this.z=o*r*a-s*n*d,this.w=o*r*d+s*n*a,this},x3dom.fields.Quaternion.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},x3dom.fields.Quaternion.prototype.add=function(e){return new x3dom.fields.Quaternion(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},x3dom.fields.Quaternion.prototype.subtract=function(e){return new x3dom.fields.Quaternion(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},x3dom.fields.Quaternion.prototype.setValues=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},x3dom.fields.Quaternion.prototype.equals=function(e,t){return this.dot(e)>=1-t},x3dom.fields.Quaternion.prototype.multScalar=function(e){return new x3dom.fields.Quaternion(this.x*e,this.y*e,this.z*e,this.w*e)},x3dom.fields.Quaternion.prototype.normalize=function(){var e=this.dot(this),t=1;return e&&(t=1/Math.sqrt(e)),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},x3dom.fields.Quaternion.normalize=function(e){var t=e.dot(e),i=1;return t&&(i=1/Math.sqrt(t)),e.x*=i,e.y*=i,e.z*=i,e.w*=i,e},x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,-this.w)},x3dom.fields.Quaternion.prototype.inverse=function(){var e=new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,this.w);if("SFRotation"in this){var t=e.toAxisAngle();return new x3dom.fields.SFRotation(t[0].x,t[0].y,t[0].z,t[1])}return e},x3dom.fields.Quaternion.prototype.slerp=function(e,t){var i,s,o,n=this.dot(e);if(n<0?(n=-n,i=e.negate()):i=new x3dom.fields.Quaternion(e.x,e.y,e.z,e.w),1-n>1e-5){var r=Math.acos(n),a=Math.sin(r);s=Math.sin((1-t)*r)/a,o=Math.sin(t*r)/a}else s=1-t,o=t;var d=this.multScalar(s).add(i.multScalar(o));if("SFRotation"in this){var h=d.toAxisAngle();return new x3dom.fields.SFRotation(h[0].x,h[0].y,h[0].z,h[1])}return d},x3dom.fields.Quaternion.rotateFromTo=function(e,t){var i=e.normalize(),s=t.normalize(),o=i.dot(s);if(o>.99999)return new x3dom.fields.Quaternion(0,0,0,1);if(o<-.99999){var n=new x3dom.fields.SFVec3f(1,0,0),r=i.cross(n);return r.length()<1e-5&&(n.x=0,n.y=1,n.z=0,r=i.cross(n)),r=r.normalize(),x3dom.fields.Quaternion.axisAngle(r,Math.PI)}var a=e.cross(t);a=a.normalize();var d=Math.sqrt(.5*(1-o));return a=a.multiply(d),d=Math.sqrt(.5*(1+o)),new x3dom.fields.Quaternion(a.x,a.y,a.z,d)},x3dom.fields.Quaternion.prototype.toGL=function(){var e=this.toAxisAngle();return[e[0].x,e[0].y,e[0].z,e[1]]},x3dom.fields.Quaternion.prototype.toString=function(){return"SFRotation"in this?this.SFRotation.x+" "+this.SFRotation.y+" "+this.SFRotation.z+" "+this.SFRotation.angle:this.x+" "+this.y+" "+this.z+", "+this.w},x3dom.fields.Quaternion.prototype.setValueByStr=function(e){var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);t=t||[0,1,0,0,0];var i=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[1],+t[2],+t[3]),+t[4]);return this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w,this},x3dom.fields.SFColor=function(e,t,i){0===arguments.length?(this.r=0,this.g=0,this.b=0):(this.r=e,this.g=t,this.b=i)},x3dom.fields.SFColor.parse=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);return new x3dom.fields.SFColor(+t[1],+t[2],+t[3])}catch(t){return x3dom.fields.SFColor.colorParse(e)}},x3dom.fields.SFColor.copy=function(e){return new x3dom.fields.SFColor(e.r,e.g,e.b)},x3dom.fields.SFColor.prototype.copy=function(){return x3dom.fields.SFColor.copy(this)},x3dom.fields.SFColor.prototype.setHSV=function(e,t,i){var s,o,n,r,a,d=0,h=0,l=0;switch(n=i*(1-t),r=i*(1-t*(o=e/60-(s=Math.floor(e/60)))),a=i*(1-t*(1-o)),s){case 0:case 6:d=i,h=a,l=n;break;case 1:d=r,h=i,l=n;break;case 2:d=n,h=i,l=a;break;case 3:d=n,h=r,l=i;break;case 4:d=a,h=n,l=i;break;case 5:d=i,h=n,l=r;break;default:x3dom.debug.logWarning("Using black for invalid case in setHSV: "+s)}return this.r=d,this.g=h,this.b=l,this},x3dom.fields.SFColor.prototype.getHSV=function(){var e,t=0,i={},s=this.r;if(i.name="red",i.value=this.r,this.g<s&&(s=this.g),this.b<s&&(s=this.b),this.g>i.value&&(i.name="green",i.value=this.g),this.b>i.value&&(i.name="blue",i.value=this.b),0==(e=i.value-s))t=0;else if("red"==i.name)t=(this.g-this.b)/e%6*60;else if("green"==i.name)t=60*((this.b-this.r)/e+2);else{if("blue"!=i.name)throw"Unknown maximum component: "+i.name;t=60*((this.r-this.g)/e+4)}return t<0&&(t+=360),[t,0==i.value?0:e/i.value,i.value]},x3dom.fields.SFColor.prototype.setValues=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},x3dom.fields.SFColor.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t},x3dom.fields.SFColor.prototype.add=function(e){return new x3dom.fields.SFColor(this.r+e.r,this.g+e.g,this.b+e.b)},x3dom.fields.SFColor.prototype.subtract=function(e){return new x3dom.fields.SFColor(this.r-e.r,this.g-e.g,this.b-e.b)},x3dom.fields.SFColor.prototype.multiply=function(e){return new x3dom.fields.SFColor(this.r*e,this.g*e,this.b*e)},x3dom.fields.SFColor.prototype.toUint=function(){return(Math.round(255*this.r)<<16|Math.round(255*this.g)<<8|Math.round(255*this.b))>>>0},x3dom.fields.SFColor.prototype.setFromUint=function(e){return this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e>>0&255)/255,this},x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]},x3dom.fields.SFColor.prototype.toString=function(){return this.r+" "+this.g+" "+this.b},x3dom.fields.SFColor.prototype.setValueByStr=function(e){try{var t=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3]}catch(t){var i=x3dom.fields.SFColor.colorParse(e);this.r=i.r,this.g=i.g,this.b=i.b}return this},x3dom.fields.SFColor.colorParse=function(e){var t=_colorParse(e);return new x3dom.fields.SFColor(t.r,t.g,t.b)},x3dom.fields.SFColorRGBA=function(e,t,i,s){0===arguments.length?(this.r=0,this.g=0,this.b=0,this.a=1):(this.r=e,this.g=t,this.b=i,this.a=s)},x3dom.fields.SFColorRGBA.parse=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);return new x3dom.fields.SFColorRGBA(+t[1],+t[2],+t[3],+t[4])}catch(t){return x3dom.fields.SFColorRGBA.colorParse(e)}},x3dom.fields.SFColorRGBA.copy=function(e){return new x3dom.fields.SFColorRGBA(e.r,e.g,e.b,e.a)},x3dom.fields.SFColorRGBA.prototype.copy=function(){return x3dom.fields.SFColorRGBA.copy(this)},x3dom.fields.SFColorRGBA.prototype.setHSV=x3dom.fields.SFColor.prototype.setHSV,x3dom.fields.SFColorRGBA.prototype.getHSV=x3dom.fields.SFColor.prototype.getHSV,x3dom.fields.SFColorRGBA.prototype.setValues=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},x3dom.fields.SFColorRGBA.prototype.equals=function(e,t){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t},x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]},x3dom.fields.SFColorRGBA.prototype.toString=function(){return this.r+" "+this.g+" "+this.b+" "+this.a},x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(e){try{var t=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(e);this.r=+t[1],this.g=+t[2],this.b=+t[3],this.a=+t[4]}catch(t){var i=x3dom.fields.SFColorRGBA.colorParse(e);this.r=i.r,this.g=i.g,this.b=i.b,this.a=i.a}return this},x3dom.fields.SFColorRGBA.prototype.toUint=function(){return(Math.round(255*this.r)<<24|Math.round(255*this.g)<<16|Math.round(255*this.b)<<8|Math.round(255*this.a))>>>0},x3dom.fields.SFColorRGBA.prototype.setFromUint=function(e){return this.r=(e>>24&255)/255,this.g=(e>>16&255)/255,this.b=(e>>8&255)/255,this.a=(e>>0&255)/255,this},x3dom.fields.SFColorRGBA.colorParse=function(e){var t=_colorParse(e);return new x3dom.fields.SFColorRGBA(t.r,t.g,t.b,t.a)},x3dom.fields.SFImage=function(e,t,i,s){if(0!==arguments.length&&s&&s.map){this.width=e,this.height=t,this.comp=i;var o=this.array;s.map((function(e){o.push(e)}),this.array)}else this.width=0,this.height=0,this.comp=0,this.array=[]},x3dom.fields.SFImage.parse=function(e){var t=new x3dom.fields.SFImage;return t.setValueByStr(e),t},x3dom.fields.SFImage.copy=function(e){var t=new x3dom.fields.SFImage;return t.width=e.width,t.height=e.height,t.comp=e.comp,t.setPixels(e.getPixels()),t},x3dom.fields.SFImage.prototype.copy=function(){return x3dom.fields.SFImage.copy(this)},x3dom.fields.SFImage.prototype.setValueByStr=function(e){var t,i,s,o,n,r=e.match(/(\w+)/g),a=r.length;if(this.array=[],!(a>2))return this.width=0,this.height=0,void(this.comp=0);this.width=+r[0],this.height=+r[1],this.comp=+r[2];var d=10;for(t=3;t<a;t++)if(r[t].substr){"x"===r[t].substr(1,1).toLowerCase()&&(d=16);var h=parseInt(r[t],d);1===this.comp?(i=255&h,this.array.push(i)):2===this.comp?(i=h>>8&255,s=255&h,this.array.push(i,s)):3===this.comp?(i=h>>16&255,s=h>>8&255,o=255&h,this.array.push(i,s,o)):4===this.comp&&(i=h>>24&255,s=h>>16&255,o=h>>8&255,n=255&h,this.array.push(i,s,o,n))}},x3dom.fields.SFImage.prototype.setPixel=function(e,t,i){var s=(t*this.width+e)*this.comp;return 1===this.comp&&s<this.array.length?this.array[s]=255*i.r:2===this.comp&&s+1<this.array.length?(this.array[s]=255*i.r,this.array[s+1]=255*i.g):3===this.comp&&s+2<this.array.length?(this.array[s]=255*i.r,this.array[s+1]=255*i.g,this.array[s+2]=255*i.b):4===this.comp&&s+3<this.array.length&&(this.array[s]=255*i.r,this.array[s+1]=255*i.g,this.array[s+2]=255*i.b,this.array[s+3]=255*i.a),this},x3dom.fields.SFImage.prototype.getPixel=function(e,t){var i=(t*this.width+e)*this.comp;if(1===this.comp&&i<this.array.length){var s=this.array[i]/255;return new x3dom.fields.SFColorRGBA(s,s,s,1)}if(2===this.comp&&i+1<this.array.length){s=this.array[i]/255;var o=this.array[i+1]/255;return new x3dom.fields.SFColorRGBA(s,s,s,o)}return 3===this.comp&&i+2<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,1):4===this.comp&&i+3<this.array.length?new x3dom.fields.SFColorRGBA(this.array[i]/255,this.array[i+1]/255,this.array[i+2]/255,this.array[i+3]/255):void 0},x3dom.fields.SFImage.prototype.setPixels=function(e){var t,i=0;if(1===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r;else if(2===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g;else if(3===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b;else if(4===this.comp)for(t=0;t<e.length;t++)this.array[i++]=255*e[t].r,this.array[i++]=255*e[t].g,this.array[i++]=255*e[t].b,this.array[i++]=255*e[t].a},x3dom.fields.SFImage.prototype.getPixels=function(){var e,t=[];if(1===this.comp)for(e=0;e<this.array.length;e+=this.comp){var i=this.array[e]/255;t.push(new x3dom.fields.SFColorRGBA(i,i,i,1))}else if(2===this.comp)for(e=0;e<this.array.length;e+=this.comp){i=this.array[e]/255;var s=this.array[e+1]/255;t.push(new x3dom.fields.SFColorRGBA(i,i,i,s))}else if(3===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,1));else if(4===this.comp)for(e=0;e<this.array.length;e+=this.comp)t.push(new x3dom.fields.SFColorRGBA(this.array[e]/255,this.array[e+1]/255,this.array[e+2]/255,this.array[e+3]/255));return t},x3dom.fields.SFImage.prototype.toGL=function(){var e=[];return this.array.map((function(t){e.push(t)})),e},x3dom.fields.MFColor=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFColor.copy=function(e){var t=new x3dom.fields.MFColor;return e.map((function(e){t.push(e.copy())}),this),t},x3dom.fields.MFColor.prototype=x3dom.extend([]),x3dom.fields.MFColor.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=3)i.push(new x3dom.fields.SFColor(+t[s+0],+t[s+1],+t[s+2]));return new x3dom.fields.MFColor(i)},x3dom.fields.MFColor.prototype.copy=function(){return x3dom.fields.MFColor.copy(this)},x3dom.fields.MFColor.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=3)this.push(new x3dom.fields.SFColor(+t[i+0],+t[i+1],+t[i+2]))},x3dom.fields.MFColor.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t.r),e.push(t.g),e.push(t.b)})),e},x3dom.fields.MFColorRGBA=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFColorRGBA.copy=function(e){var t=new x3dom.fields.MFColorRGBA;return e.map((function(e){t.push(e.copy())}),this),t},x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]),x3dom.fields.MFColorRGBA.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=4)i.push(new x3dom.fields.SFColorRGBA(+t[s+0],+t[s+1],+t[s+2],+t[s+3]));return new x3dom.fields.MFColorRGBA(i)},x3dom.fields.MFColorRGBA.prototype.copy=function(){return x3dom.fields.MFColorRGBA.copy(this)},x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=4)this.push(new x3dom.fields.SFColorRGBA(+t[i+0],+t[i+1],+t[i+2],+t[i+3]))},x3dom.fields.MFColorRGBA.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t.r),e.push(t.g),e.push(t.b),e.push(t.a)})),e},x3dom.fields.MFRotation=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFRotation.prototype=x3dom.extend([]),x3dom.fields.MFRotation.copy=function(e){var t=new x3dom.fields.MFRotation;return e.map((function(e){t.push(e.copy())}),this),t},x3dom.fields.MFRotation.prototype.copy=function(){return x3dom.fields.MFRotation.copy(this)},x3dom.fields.MFRotation.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=4)i.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[s+0],+t[s+1],+t[s+2]),+t[s+3]));return new x3dom.fields.MFRotation(i)},x3dom.fields.MFRotation.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]),+t[i+3]))},x3dom.fields.MFRotation.prototype.toGL=function(){var e=[];return this.map((function(t){var i=t.toAxisAngle();e.push(i[0].x),e.push(i[0].y),e.push(i[0].z),e.push(i[1])})),e},x3dom.fields.MFVec3f=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFVec3f.prototype=x3dom.extend(Array),x3dom.fields.MFVec3f.copy=function(e){var t=new x3dom.fields.MFVec3f;return e.map((function(e){t.push(e.copy())}),this),t},x3dom.fields.MFVec3f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=3)i.push(new x3dom.fields.SFVec3f(+t[s+0],+t[s+1],+t[s+2]));return new x3dom.fields.MFVec3f(i)},x3dom.fields.MFVec3f.prototype.copy=function(){return x3dom.fields.MFVec3f.copy(this)},x3dom.fields.MFVec3f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=3)this.push(new x3dom.fields.SFVec3f(+t[i+0],+t[i+1],+t[i+2]));return this},x3dom.fields.MFVec3f.prototype.setValues=function(e){var t,i=Math.min(e.length,this.length);for(t=0;t<i;t++)this[t].setValues(e[t])},x3dom.fields.MFVec3f.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t.x),e.push(t.y),e.push(t.z)})),e},x3dom.fields.MFVec3f.prototype.toString=function(){var e="";return this.forEach((function(t){e=e+t.toString()+" "})),e.trim()},x3dom.fields.MFVec2f=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFVec2f.prototype=x3dom.extend([]),x3dom.fields.MFVec2f.copy=function(e){var t=new x3dom.fields.MFVec2f;return e.map((function(e){t.push(e.copy())}),this),t},x3dom.fields.MFVec2f.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s+=2)i.push(new x3dom.fields.SFVec2f(+t[s+0],+t[s+1]));return new x3dom.fields.MFVec2f(i)},x3dom.fields.MFVec2f.prototype.copy=function(){return x3dom.fields.MFVec2f.copy(this)},x3dom.fields.MFVec2f.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i+=2)this.push(new x3dom.fields.SFVec2f(+t[i+0],+t[i+1]))},x3dom.fields.MFVec2f.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t.x),e.push(t.y)})),e},x3dom.fields.MFInt32=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFInt32.prototype=x3dom.extend([]),x3dom.fields.MFInt32.copy=function(e){var t=new x3dom.fields.MFInt32;return e.map((function(e){t.push(e)}),this),t},x3dom.fields.MFInt32.parse=function(e){for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=[],s=0,o=t?t.length:0;s<o;++s)i.push(parseInt(t[s],10));return new x3dom.fields.MFInt32(i)},x3dom.fields.MFInt32.prototype.copy=function(){return x3dom.fields.MFInt32.copy(this)},x3dom.fields.MFInt32.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-]?\d+\s*){1},?\s*/g),i=0,s=t?t.length:0;i<s;++i)this.push(parseInt(t[i],10))},x3dom.fields.MFInt32.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t)})),e},x3dom.fields.MFFloat=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFFloat.prototype=x3dom.extend([]),x3dom.fields.MFFloat.copy=function(e){var t=new x3dom.fields.MFFloat;return e.map((function(e){t.push(e)}),this),t},x3dom.fields.MFFloat.parse=function(e){for(var t=e.match(/([+\-0-9eE\.]+)/g),i=[],s=0,o=t?t.length:0;s<o;s++)i.push(+t[s]);return new x3dom.fields.MFFloat(i)},x3dom.fields.MFFloat.prototype.copy=function(){return x3dom.fields.MFFloat.copy(this)},x3dom.fields.MFFloat.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/([+\-0-9eE\.]+)/g),i=0,s=t?t.length:0;i<s;i++)this.push(+t[i])},x3dom.fields.MFFloat.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t)})),e},x3dom.fields.MFBoolean=function(e){if(e){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFBoolean.prototype=x3dom.extend([]),x3dom.fields.MFBoolean.copy=function(e){var t=new x3dom.fields.MFBoolean;return e.map((function(e){t.push(e)}),this),t},x3dom.fields.MFBoolean.parse=function(e){for(var t=e.match(/(true|false|1|0)/gi),i=[],s=0,o=t?t.length:0;s<o;s++)i.push("1"==t[s]||"true"==t[s].toLowerCase());return new x3dom.fields.MFBoolean(i)},x3dom.fields.MFBoolean.prototype.copy=function(){return x3dom.fields.MFBoolean.copy(this)},x3dom.fields.MFBoolean.prototype.setValueByStr=function(e){this.length=0;for(var t=e.match(/(true|false|1|0)/gi),i=0,s=t?t.length:0;i<s;i++)this.push("1"==t[i]||"true"==t[i].toLowerCase())},x3dom.fields.MFBoolean.prototype.toGL=function(){var e=[];return this.map((function(t){e.push(t?1:0)})),e},x3dom.fields.MFString=function(e){if(e&&e.map){var t=this;e.map((function(e){t.push(e)}),this)}},x3dom.fields.MFString.prototype=x3dom.extend([]),x3dom.fields.MFString.copy=function(e){var t=new x3dom.fields.MFString;return e.map((function(e){t.push(e)}),this),t},x3dom.fields.MFString.parse=function(e){var t=[];if((e=e.trim()).length&&'"'==e[0])for(var i,s=/"((?:[^\\"]|\\\\|\\")*)"/g;i=s.exec(e);){var o=i[1].replace(/\\([\\"])/g,"$1");void 0!==o&&t.push(o)}else t.push(e);return new x3dom.fields.MFString(t)},x3dom.fields.MFString.prototype.copy=function(){return x3dom.fields.MFString.copy(this)},x3dom.fields.MFString.prototype.setValueByStr=function(e){if(this.length=0,e.length&&'"'==e[0])for(var t,i=/"((?:[^\\"]|\\\\|\\")*)"/g;t=i.exec(e);){var s=t[1].replace(/\\([\\"])/,"$1");void 0!==s&&this.push(s)}else this.push(e);return this},x3dom.fields.MFString.prototype.toString=function(){for(var e="",t=0,i=this.length;t<i;t++)e=e+this[t]+" ";return e},x3dom.fields.SFNode=function(e){this.type=e,this.node=null},x3dom.fields.SFNode.prototype.hasLink=function(e){return e?this.node===e:this.node},x3dom.fields.SFNode.prototype.addLink=function(e){return this.node=e,!0},x3dom.fields.SFNode.prototype.rmLink=function(e){return this.node===e&&(this.node=null,!0)},x3dom.fields.MFNode=function(e){this.type=e,this.nodes=[]},x3dom.fields.MFNode.prototype.hasLink=function(e){if(!e)return this.length>0;for(var t=0,i=this.nodes.length;t<i;t++)if(this.nodes[t]===e)return!0;return!1},x3dom.fields.MFNode.prototype.addLink=function(e){return this.nodes.push(e),!0},x3dom.fields.MFNode.prototype.rmLink=function(e){for(var t=0,i=this.nodes.length;t<i;t++)if(this.nodes[t]===e)return this.nodes.splice(t,1),!0;return!1},x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length},x3dom.fields.Line=function(e,t){0===arguments.length&&(this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1)),this.pos=x3dom.fields.SFVec3f.copy(e),this.dir=x3dom.fields.SFVec3f.copy(t)},x3dom.fields.Line.prototype.closestPoint=function(e){var t=e.subtract(this.pos).dot(this.dir);return this.pos.add(this.dir.multiply(t))},x3dom.fields.Line.prototype.shortestDistance=function(e){var t=e.subtract(this.pos),i=t.dot(this.dir);return t.subtract(this.dir.multiply(i)).length()},x3dom.fields.Ray=function(e,t){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(e.x,e.y,e.z);var i=t.length();i&&(i=1/i),this.dir=new x3dom.fields.SFVec3f(t.x*i,t.y*i,t.z*i)}this.enter=0,this.exit=0,this.hitObject=null,this.hitPoint={},this.dist=Number.MAX_VALUE},x3dom.fields.Ray.prototype.toString=function(){return"Ray: ["+this.pos.toString()+"; "+this.dir.toString()+"]"},x3dom.fields.Ray.prototype.intersectPlane=function(e,t){var i,s=null,o=t.dot(this.dir);return o<0&&(i=(e.dot(t)-this.pos.dot(t))/o,s=this.pos.addScaled(this.dir,i)),s},x3dom.fields.Ray.prototype.intersect=function(e,t){var i,s,o,n=0,r=Number.MAX_VALUE;if(this.dir.x>x3dom.fields.Eps)i=1/this.dir.x,s=(e.x-this.pos.x)*i,(o=(t.x-this.pos.x)*i)<r&&(r=o),s>n&&(n=s);else if(this.dir.x<-x3dom.fields.Eps)i=1/this.dir.x,s=(t.x-this.pos.x)*i,(o=(e.x-this.pos.x)*i)<r&&(r=o),s>n&&(n=s);else if(this.pos.x<e.x||this.pos.x>t.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(i=1/this.dir.y,s=(e.y-this.pos.y)*i,(o=(t.y-this.pos.y)*i)<r&&(r=o),s>n&&(n=s),n-r>=x3dom.fields.Eps)return!1}else if(this.dir.y<-x3dom.fields.Eps){if(i=1/this.dir.y,s=(t.y-this.pos.y)*i,(o=(e.y-this.pos.y)*i)<r&&(r=o),s>n&&(n=s),n-r>=x3dom.fields.Eps)return!1}else if(this.pos.y<e.y||this.pos.y>t.y)return!1;if(this.dir.z>x3dom.fields.Eps)i=1/this.dir.z,s=(e.z-this.pos.z)*i,(o=(t.z-this.pos.z)*i)<r&&(r=o),s>n&&(n=s);else if(this.dir.z<-x3dom.fields.Eps)i=1/this.dir.z,s=(t.z-this.pos.z)*i,(o=(e.z-this.pos.z)*i)<r&&(r=o),s>n&&(n=s);else if(this.pos.z<e.z||this.pos.z>t.z)return!1;return this.enter=n,this.exit=r,n-r<x3dom.fields.Eps},x3dom.fields.BoxVolume=function(e,t){arguments.length<2?(this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.valid=!1):(this.min=x3dom.fields.SFVec3f.copy(e),this.max=x3dom.fields.SFVec3f.copy(t),this.valid=!0),this.updateInternals()},x3dom.fields.BoxVolume.prototype.getScalarValue=function(){var e=this.max.subtract(this.min);return e.x*e.y*e.z},x3dom.fields.BoxVolume.copy=function(e){var t=new x3dom.fields.BoxVolume(e.min,e.max);return t.valid=e.valid,t},x3dom.fields.BoxVolume.prototype.equals=function(e){return this.min.equals(e.min,1e-12)&&this.max.equals(e.max,1e-12)},x3dom.fields.BoxVolume.prototype.updateInternals=function(){this.radialVec=this.max.subtract(this.min).multiply(.5),this.center=this.min.add(this.radialVec),this.diameter=2*this.radialVec.length()},x3dom.fields.BoxVolume.prototype.setBounds=function(e,t){this.min.setValues(e),this.max.setValues(t),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.setBoundsByCenterSize=function(e,t){var i=t.multiply(.5);this.min=e.subtract(i),this.max=e.add(i),this.updateInternals(),this.valid=!0},x3dom.fields.BoxVolume.prototype.extendBounds=function(e,t){this.valid?(this.min.x>e.x&&(this.min.x=e.x),this.min.y>e.y&&(this.min.y=e.y),this.min.z>e.z&&(this.min.z=e.z),this.max.x<t.x&&(this.max.x=t.x),this.max.y<t.y&&(this.max.y=t.y),this.max.z<t.z&&(this.max.z=t.z),this.updateInternals()):this.setBounds(e,t)},x3dom.fields.BoxVolume.prototype.getBounds=function(e,t){e.setValues(this.min),t.setValues(this.max)},x3dom.fields.BoxVolume.prototype.getRadialVec=function(){return this.radialVec},x3dom.fields.BoxVolume.prototype.invalidate=function(){this.valid=!1,this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.updateInternals()},x3dom.fields.BoxVolume.prototype.isValid=function(){return this.valid},x3dom.fields.BoxVolume.prototype.getCenter=function(){return this.center},x3dom.fields.BoxVolume.prototype.getDiameter=function(){return this.diameter},x3dom.fields.BoxVolume.prototype.transform=function(e){var t,i,s,o,n,r;t=o=e._03,i=n=e._13,s=r=e._23;var a=this.max.x*e._00,d=this.min.x*e._00;a>=d?(o+=a,t+=d):(o+=d,t+=a),(a=this.max.y*e._01)>=(d=this.min.y*e._01)?(o+=a,t+=d):(o+=d,t+=a),(a=this.max.z*e._02)>=(d=this.min.z*e._02)?(o+=a,t+=d):(o+=d,t+=a),(a=this.max.x*e._10)>=(d=this.min.x*e._10)?(n+=a,i+=d):(n+=d,i+=a),(a=this.max.y*e._11)>=(d=this.min.y*e._11)?(n+=a,i+=d):(n+=d,i+=a),(a=this.max.z*e._12)>=(d=this.min.z*e._12)?(n+=a,i+=d):(n+=d,i+=a),(a=this.max.x*e._20)>=(d=this.min.x*e._20)?(r+=a,s+=d):(r+=d,s+=a),(a=this.max.y*e._21)>=(d=this.min.y*e._21)?(r+=a,s+=d):(r+=d,s+=a),(a=this.max.z*e._22)>=(d=this.min.z*e._22)?(r+=a,s+=d):(r+=d,s+=a),this.min.x=t,this.min.y=i,this.min.z=s,this.max.x=o,this.max.y=n,this.max.z=r,this.updateInternals()},x3dom.fields.BoxVolume.prototype.transformFrom=function(e,t){var i,s,o,n,r,a;i=n=e._03,s=r=e._13,o=a=e._23;var d=t.max.x*e._00,h=t.min.x*e._00;d>=h?(n+=d,i+=h):(n+=h,i+=d),(d=t.max.y*e._01)>=(h=t.min.y*e._01)?(n+=d,i+=h):(n+=h,i+=d),(d=t.max.z*e._02)>=(h=t.min.z*e._02)?(n+=d,i+=h):(n+=h,i+=d),(d=t.max.x*e._10)>=(h=t.min.x*e._10)?(r+=d,s+=h):(r+=h,s+=d),(d=t.max.y*e._11)>=(h=t.min.y*e._11)?(r+=d,s+=h):(r+=h,s+=d),(d=t.max.z*e._12)>=(h=t.min.z*e._12)?(r+=d,s+=h):(r+=h,s+=d),(d=t.max.x*e._20)>=(h=t.min.x*e._20)?(a+=d,o+=h):(a+=h,o+=d),(d=t.max.y*e._21)>=(h=t.min.y*e._21)?(a+=d,o+=h):(a+=h,o+=d),(d=t.max.z*e._22)>=(h=t.min.z*e._22)?(a+=d,o+=h):(a+=h,o+=d),this.min.x=i,this.min.y=s,this.min.z=o,this.max.x=n,this.max.y=r,this.max.z=a,this.updateInternals(),this.valid=!0},x3dom.fields.FrustumVolume=function(e){if(this.planeNormals=[],this.planeDistances=[],this.directionIndex=[],0!==arguments.length){for(var t=[],i=0;i<6;i++)this.planeNormals[i]=new x3dom.fields.SFVec3f(0,0,0),this.planeDistances[i]=0,this.directionIndex[i]=0,t[i]=new x3dom.fields.SFVec4f(0,0,0,0);for(t[0].x=e._30-e._00,t[0].y=e._31-e._01,t[0].z=e._32-e._02,t[0].w=e._33-e._03,t[1].x=e._30+e._00,t[1].y=e._31+e._01,t[1].z=e._32+e._02,t[1].w=e._33+e._03,t[2].x=e._30+e._10,t[2].y=e._31+e._11,t[2].z=e._32+e._12,t[2].w=e._33+e._13,t[3].x=e._30-e._10,t[3].y=e._31-e._11,t[3].z=e._32-e._12,t[3].w=e._33-e._13,t[4].x=e._30+e._20,t[4].y=e._31+e._21,t[4].z=e._32+e._22,t[4].w=e._33+e._23,t[5].x=e._30-e._20,t[5].y=e._31-e._21,t[5].z=e._32-e._22,t[5].w=e._33-e._23,i=0;i<6;i++){var s=Math.sqrt(t[i].x*t[i].x+t[i].y*t[i].y+t[i].z*t[i].z);t[i].x/=s,t[i].y/=s,t[i].z/=s,t[i].w/=-s}var o=function(e){var t=0;return e.x>0&&(t|=1),e.y>0&&(t|=2),e.z>0&&(t|=4),t};this.planeNormals[3].setValues(t[0]),this.planeDistances[3]=t[0].w,this.directionIndex[3]=o(this.planeNormals[3]),this.planeNormals[2].setValues(t[1]),this.planeDistances[2]=t[1].w,this.directionIndex[2]=o(this.planeNormals[2]),this.planeNormals[5].setValues(t[2]),this.planeDistances[5]=t[2].w,this.directionIndex[5]=o(this.planeNormals[5]),this.planeNormals[4].setValues(t[3]),this.planeDistances[4]=t[3].w,this.directionIndex[4]=o(this.planeNormals[4]),this.planeNormals[0].setValues(t[4]),this.planeDistances[0]=t[4].w,this.directionIndex[0]=o(this.planeNormals[0]),this.planeNormals[1].setValues(t[5]),this.planeDistances[1]=t[5].w,this.directionIndex[1]=o(this.planeNormals[1])}},x3dom.fields.FrustumVolume.prototype.intersect=function(e,t){if(this.planeNormals.length<6)return x3dom.debug.logWarning("FrustumVolume not initialized!"),!1;var i=this,s=e.min,o=e.max,n=function(e){var t=new x3dom.fields.SFVec3f(0,0,0);return t.x=1&e?s.x:o.x,t.y=2&e?s.y:o.y,t.z=4&e?s.z:o.z,t},r=function(e,t){return i.planeNormals[e].dot(t)-i.planeDistances[e]>=0},a=function(e){var t=n(i.directionIndex[e]);return r(e,t)},d=function(e){var t=n(7^i.directionIndex[e]);return!r(e,t)},h=1;t<0&&(t=0);for(var l=0;l<6;l++,h<<=1)if(0==(t&h)){if(d(l))return-1;a(l)&&(t|=h)}return t},x3dom.BindableStack=function(e,t,i,s){this._doc=e,this._type=t,this._defaultType=i,this._defaultRoot=null,this._getter=s,this._bindBag=[],this._bindStack=[]},x3dom.BindableStack.prototype.top=function(){return this._bindStack.length>0?this._bindStack[this._bindStack.length-1]:null},x3dom.BindableStack.prototype.push=function(e){var t=this.top();t!==e&&(t&&t.deactivate(),this._bindStack.push(e),e.activate(t))},x3dom.BindableStack.prototype.replaceTop=function(e){var t=this.top();t!==e&&t&&(t.deactivate(),this._bindStack[this._bindStack.length-1]=e,e.activate(t))},x3dom.BindableStack.prototype.pop=function(e){var t;return e&&e!==(t=this.top())?null:((t=this._bindStack.pop())&&t.deactivate(),t)},x3dom.BindableStack.prototype.switchTo=function(e){var t=this.getActive(),i=this._bindBag.length,s=0,o=0,n=-1;if(!(i<=1)){switch(e){case"first":s=this._bindBag[0];break;case"last":s=this._bindBag[i-1];break;default:for(o=0;o<i;o++)if(this._bindBag[o]==t){n=o;break}if(n>=0)for(o=n;!s&&(o="next"==e?o<i-1?o+1:0:o>0?o-1:i-1)!=n;)this._bindBag[o]._vf.description.length>=0&&(s=this._bindBag[o])}s?this.replaceTop(s):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}},x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length)if(this._defaultRoot){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var e=new this._defaultType({doc:this._doc,nameSpace:this._defaultRoot._nameSpace,autoGen:!0});this._defaultRoot.addChild(e),e.nodeChanged()}else x3dom.debug.logError("stack without defaultRoot");else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]),this._bindBag[0].activate()}var t=this._bindStack[this._bindStack.length-1];return null==t._nameSpace&&(this.pop(),t=this.getActive()),t},x3dom.BindableBag=function(e){this._stacks=[],this.addType("X3DViewpointNode","Viewpoint","getViewpoint",e),this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",e),this.addType("X3DBackgroundNode","Background","getBackground",e),this.addType("X3DFogNode","Fog","getFog",e),this.addType("X3DEnvironmentNode","Environment","getEnvironment",e)},x3dom.BindableBag.prototype.addType=function(e,t,i,s){var o=x3dom.nodeTypes[e],n=x3dom.nodeTypes[t];if(o&&n){var r=new x3dom.BindableStack(s,o,n,i);this._stacks.push(r)}else x3dom.debug.logWarning("Invalid Bindable type/defaultType: "+e+"/"+n)},x3dom.BindableBag.prototype.setRefNode=function(e){this._stacks.forEach((function(t){t._defaultRoot=e,e[t._getter]=function(){return t.getActive()}}))},x3dom.BindableBag.prototype.addBindable=function(e){for(var t=0,i=this._stacks.length;t<i;t++){var s=this._stacks[t];if(x3dom.isa(e,s._type)){x3dom.debug.logInfo("register "+e.typeName()+"Bindable "+e._DEF+"/"+e._vf.description),s._bindBag.push(e);var o=s.top();if(o&&o._autoGen){s.replaceTop(e);for(var n=0,r=s._bindBag.length;n<r;n++)if(s._bindBag[n]===o){s._bindBag.splice(n,1);break}s._defaultRoot.removeChild(o)}return s}}return x3dom.debug.logError(e.typeName()+" is not a valid bindable"),null},x3dom.NodeNameSpace=function(e,t){this.name=e,this.doc=t,this.baseURL="",this.defMap={},this.parent=null,this.childSpaces=[],this.protos=[],this.lateRoutes=[],this.imports=new Map,this.exports=new Map,this.superInlineNode=null},x3dom.NodeNameSpace.prototype.addNode=function(e,t){this.defMap[t]=e,e._nameSpace||(e._nameSpace=this)},x3dom.NodeNameSpace.prototype.removeNode=function(e){var t=e?this.defMap[e]:null;t&&(delete this.defMap[e],t._nameSpace==this&&(t._nameSpace=null))},x3dom.NodeNameSpace.prototype.getNamedNode=function(e){return this.defMap[e]},x3dom.NodeNameSpace.prototype.getNamedElement=function(e){var t=this.defMap[e];return t?t._xmlNode:null},x3dom.NodeNameSpace.prototype.addSpace=function(e){this.childSpaces.push(e),e.parent=this},x3dom.NodeNameSpace.prototype.removeSpace=function(e){e.parent=null;for(var t=0;t<this.childSpaces.length;t++)this.childSpaces[t]==e&&this.childSpaces.splice(t,1)},x3dom.NodeNameSpace.prototype.setBaseURL=function(e){var t=e.lastIndexOf("/");this.baseURL=t>=0?e.substr(0,t+1):"",x3dom.debug.logInfo("setBaseURL: "+this.baseURL)},x3dom.NodeNameSpace.prototype.getURL=function(e){return void 0!==e&&e.length?"/"===e[0]||e.indexOf(":")>=0?e:this.baseURL+e:""},x3dom.hasElementAttribute=function(e){var t=this.__hasAttribute(e);return!t&&e&&(t=this.__hasAttribute(e.toLowerCase())),t},x3dom.getElementAttribute=function(e){var t=this.__getAttribute(e);return!t&&""!=t&&e&&(t=this.__getAttribute(e.toLowerCase())),t||!this._x3domNode?t:this._x3domNode._vf[e]},x3dom.setElementAttribute=function(e,t){this.__setAttribute(e,t);var i=this._x3domNode;i&&(i.updateField(e,t),i._nameSpace.doc.needRender=!0)},x3dom.getFieldValue=function(e){var t=this._x3domNode;if(t&&void 0!==t._vf[e]){var i=t._vf[e];return i instanceof Object&&"copy"in i?t._vf[e].copy():t._vf[e]}return null},x3dom.setFieldValue=function(e,t){var i=this._x3domNode;i&&void 0!==i._vf[e]&&(i._vf[e]=t instanceof Object&&"copy"in t?t.copy():t,i.fieldChanged(e),i._nameSpace.doc.needRender=!0)},x3dom.requestFieldRef=function(e){var t=this._x3domNode;return t&&t._vf[e]?t._vf[e]:null},x3dom.releaseFieldRef=function(e){var t=this._x3domNode;t&&t._vf[e]&&(t.fieldChanged(e),t._nameSpace.doc.needRender=!0)},x3dom.NodeNameSpace.prototype.setupTree=function(e,t){var i=null;if(t=t||null,x3dom.isX3DElement(e)){if(e._x3domNode)return x3dom.debug.logWarning("Tree is already initialized"),null;if(void 0===e.tagName||e.__addEventListener||e.__removeEventListener||(e.__addEventListener=e.addEventListener,e.addEventListener=function(e,t,i){this._x3domNode._listeners[e]||(this._x3domNode._listeners[e]=[]),this._x3domNode._listeners[e].push(t),this.__addEventListener(e,t,i)},e.__removeEventListener=e.removeEventListener,e.removeEventListener=function(e,t,i){var s=this._x3domNode._listeners[e];if(s)for(var o=0;o<s.length;o++)s[o]==t&&(s.splice(o,1),o--);this.__removeEventListener(e,t,i)}),e.hasAttribute("USE")||e.hasAttribute("use")){if(e.hasAttribute("USE")||e.setAttribute("USE",e.getAttribute("use")),!(i=this.defMap[e.getAttribute("USE")])){var s=e.getAttribute("USE").split("__");if(s.length>=2){for(var o=this;o;)o.name==s[0]&&(i=o.defMap[s[1]]),o=i?null:o.parent;i||(i=null,x3dom.debug.logWarning("Could not USE: "+e.getAttribute("USE")))}}return i&&(e._x3domNode=i),i}if("route"===e.localName.toLowerCase()){var n=e,r=n.getAttribute("fromNode")||n.getAttribute("fromnode"),a=n.getAttribute("toNode")||n.getAttribute("tonode"),d=this.defMap[r],h=this.defMap[a],l=n.getAttribute("fromField")||n.getAttribute("fromfield"),f=n.getAttribute("toField")||n.getAttribute("tofield");return d&&h?(d.setupRoute(l,h,f),n._nodeNameSpace=this):(x3dom.debug.logWarning("not yet available route - can't find all DEFs for "+l+" -> "+f),this.lateRoutes.push({route:n,fnDEF:r,tnDEF:a,fnAtt:l,tnAtt:f})),null}if("import"===e.localName.toLowerCase()){var u=e.getAttribute("inlineDEF")||e.getAttribute("inlinedef"),_=e.getAttribute("importedDEF")||e.getAttribute("importeddef"),c=e.getAttribute("AS")||e.getAttribute("as");if(!u||!_)return null;if(c||(c=_),this.imports.get(u)||this.imports.set(u,new Map),this.imports.get(u).set(c,_),e._nodeNameSpace=this,this.defMap[u]&&this.defMap[u]._childNodes[0]&&this.defMap[u]._childNodes[0]._nameSpace){var m=this.defMap[u]._childNodes[0]._nameSpace;if(x=m.exports.get(_)){var p=m.defMap[x];p&&(this.defMap[c]=p,this.routeLateRoutes())}}return null}if("export"===e.localName.toLowerCase()){var x=e.getAttribute("localDEF")||e.getAttribute("localdef");c=e.getAttribute("AS")||e.getAttribute("as");return x?(c||(c=x),this.exports.set(c,x),e._nodeNameSpace=this,this.superInlineNode&&this.superInlineNode._nameSpace&&this.superInlineNode._nameSpace.importNodes(this),null):null}e.requestFieldRef=x3dom.requestFieldRef,e.releaseFieldRef=x3dom.releaseFieldRef,e.getFieldValue=x3dom.getFieldValue,e.setFieldValue=x3dom.setFieldValue;var v=x3dom.nodeTypesLC[e.localName.toLowerCase()];if(void 0!==v){!1===x3dom.userAgentFeature.supportsDOMAttrModified&&e instanceof Element&&(e.setAttribute&&!e.__setAttribute&&(e.__setAttribute=e.setAttribute,e.setAttribute=x3dom.setElementAttribute),e.getAttribute&&!e.__getAttribute&&(e.__getAttribute=e.getAttribute,e.getAttribute=x3dom.getElementAttribute),e.hasAttribute&&!e.__hasAttribute&&(e.__hasAttribute=e.hasAttribute,e.hasAttribute=x3dom.hasElementAttribute));var g={doc:this.doc,runtime:this.doc._x3dElem.runtime,xmlNode:e,nameSpace:this};return i=new v(g),e.hasAttribute("DEF")?(i._DEF=e.getAttribute("DEF"),this.defMap[i._DEF]=i):e.hasAttribute("id")&&(i._DEF=e.getAttribute("id"),i._DEF in this.defMap||(this.defMap[i._DEF]=i)),void 0===e.highlight&&(e.highlight=function(e,t){var i=x3dom.fields.SFColor.parse(t);this._x3domNode.highlight(e,i),this._x3domNode._nameSpace.doc.needRender=!0}),i._xmlNode=e,e._x3domNode=i,e.querySelectorAll(":scope > *").forEach((function(t){var i=t.localName.toLowerCase();"protodeclare"==i?this.protoDeclare(t):"externprotodeclare"==i?this.externProtoDeclare(t):"protoinstance"==i&&this.protoInstance(t,e)}),this),e.childNodes.forEach((function(e){var t=this.setupTree(e,i);t&&i.addChild(t,e.getAttribute("containerField"))}),this),i.nodeChanged(),i}x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;.")}else if(e.localName){var y=e.localName.toLowerCase(),S=this.protos.find((function(e){return y==e.name.toLowerCase()&&e.isExternProto}));t&&"x3dommetagroup"==y?e.childNodes.forEach(function(e){var i=this.setupTree(e,t);i&&t.addChild(i,e.getAttribute("containerField"))}.bind(this)):"protodeclare"==y||"externprotodeclare"==y||"protoinstance"==y?i=null:"is"==e.localName.toLowerCase()?0==e.querySelectorAll("connect").length&&x3dom.debug.logWarning("IS statement without connect link: "+e.parentElement.localName):S?this.loadExternProtoAsync(S,e,e,e.parentElement):(x3dom.debug.logWarning("Unrecognised X3D element &lt;"+e.localName+"&gt;."),i=null)}return i},x3dom.NodeNameSpace.prototype.importNodes=function(e){if(e&&e.superInlineNode&&e.superInlineNode._nameSpace==this){var t=this,i=e.superInlineNode._DEF,s=t.imports,o=e.exports,n=0;i&&s.get(i)&&(s.get(i).forEach((function(i,s){var r=o.get(i);if(r){var a=e.defMap[r];a&&(t.defMap[s]=a,n++)}})),n>0&&t.routeLateRoutes())}},x3dom.NodeNameSpace.prototype.routeLateRoutes=function(){var e=this;e.lateRoutes.forEach((function(t){var i=e.defMap[t.fnDEF],s=e.defMap[t.tnDEF];i&&s&&(x3dom.debug.logInfo("fixed ROUTE: from="+i._DEF+", to="+s._DEF),i.setupRoute(t.fnAtt,s,t.tnAtt),t.route._nodeNameSpace=e)}))},x3dom.NodeNameSpace.prototype.protoInstance=function(e,t){if(e.localName&&!e._x3dom){var i=e.getAttribute("name");if(e.hasAttribute("USE")){var s=e.getAttribute("USE"),o=this.defMap[s];i=o?o.constructor._typeName:t.getRootNode().querySelector("[DEF="+s+"]").getAttribute("name")}var n=this.protos.find((function(e){return e.name==i}));if(null!=n){var r=document.createElement(i);if(e.hasAttribute("DEF")?r.setAttribute("DEF",e.getAttribute("DEF")):e.hasAttribute("USE")&&r.setAttribute("USE",e.getAttribute("USE")),e.hasAttribute("containerField")&&r.setAttribute("containerField",e.getAttribute("containerField")),e.querySelectorAll(":scope > fieldValue , :scope > fieldvalue").forEach((function(e){var t=e.getAttribute("name"),i=e.querySelectorAll(":scope > *");if(i.length>0)i.forEach((function(e){e.setAttribute("containerField",t),r.appendChild(e)}));else{var s=e.getAttribute("value");s&&r.setAttribute(t,s)}})),n.isExternProto&&n.needsLoading)this.loadExternProtoAsync(n,r,e,t);else{this.doc.mutationObserver.disconnect(),e.insertAdjacentElement("afterend",r);var a=this.doc._x3dElem;this.doc._scene&&(a=this.doc._scene._xmlNode),this.doc.mutationObserver.observe(a,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),e._x3dom=r}}else x3dom.debug.logWarning("ProtoInstance without a ProtoDeclaration "+i)}},x3dom.NodeNameSpace.prototype.loadExternProtoAsync=function(e,t,i,s){e.instanceQueue.push({protoInstanceDom:t,domNode:i,parentDom:s,targetChildIndex:s._x3domNode._childNodes.length+e.instanceQueue.length}),i._x3dom=t;var o=this,n=0;!function t(){var i=o.getURL(e.url[n]);o.doc.incrementDownloads(),fetch(i).then((function(e){if(!e.ok)throw new Error("Network response was not OK: "+e.status);return e.text()})).then((function(t){var s=new DOMParser,n=s.parseFromString(t,"application/xml"),r=n.querySelector("X3D");null==r&&(r=(n=s.parseFromString(t,"text/html")).querySelector("X3D"));var a=i.includes("#")?i.split("#").slice(-1)[0]:"",d=""==a?"ProtoDeclare":"ProtoDeclare[name='"+a+"']",h=r.querySelector(d);h.setAttribute("name",e.name),o.confNameSpace=new x3dom.NodeNameSpace(e.name,o.doc),o.confNameSpace.setBaseURL(o.baseURL+e.name),o.confNameSpace.setupTree(r.querySelector("Scene"),r),o.confNameSpace.protos.forEach((function(e){o.protos.push(e)}));var l,f=o.protos.findIndex((function(t){return t==e}));for(o.protos.splice(f,1),o.protoDeclare(h);l=e.instanceQueue.shift();){var u=l.parentDom,_=u._x3domNode,c=l.protoInstanceDom,m=l.targetChildIndex;o.doc.mutationObserver.disconnect(),l.domNode!==c&&l.domNode.insertAdjacentElement("afterend",c),o.doc.mutationObserver.observe(o.doc._scene._xmlNode,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),o.doc.onNodeAdded(c,u);var p=_._childNodes,x=p.length-1;if(m!==x){var v=p[m],g=p[x];p[m]=g,p[x]=v;var y=(S=u.getAttribute("containerField"))in _._cf&&_._cf[S];if(!y)for(var S in _._cf){var T=_._cf[S];if(x3dom.isa(g,T.type)){y=T;break}}y[m]=g,y[x]=v}o.lateRoutes.forEach((function(e){var t=o.defMap[e.fnDEF],i=o.defMap[e.tnDEF];t&&i&&(x3dom.debug.logInfo("fixed ROUTE: from="+t._DEF+", to="+i._DEF),t.setupRoute(e.fnAtt,i,e.tnAtt),e.route._nodeNameSpace=o)})),o.superInlineNode&&o.superInlineNode._nameSpace&&o.superInlineNode._nameSpace.importNodes(o)}e.needsLoading=!1,o.doc.decrementDownloads()})).catch((function(s){if(x3dom.debug.logWarning(i+": ExternProto fetch failed: "+s),o.doc.decrementDownloads(),!(++n<e.url.length))return x3dom.debug.logError("ExternProto fetch failed for all urls."),e.needsLoading=!1,null;t()}))}()},x3dom.NodeNameSpace.prototype.externProtoDeclare=function(e){var t=e.getAttribute("name"),i=x3dom.fields.MFString.parse(e.getAttribute("url")),s=new x3dom.ProtoDeclaration(this,t,null,null,!0,i);this.protos.push(s)},x3dom.NodeNameSpace.prototype.protoDeclare=function(e){var t=e.getAttribute("name"),i=e.querySelector("ProtoInterface"),s=[];i&&i.querySelectorAll("field").forEach((function(e){s.push({name:e.getAttribute("name"),accessType:e.getAttribute("accessType"),dataType:e.getAttribute("type"),value:e.getAttribute("value"),cfValue:e.querySelectorAll(":scope > *")})}));var o=e.querySelector("ProtoBody");if(o){o._ISRoutes={},o.querySelectorAll("IS").forEach((function(e){for(var t=e.parentElement;"protobody"!==t.localName.toLowerCase();)t=t.parentElement;t===o&&e.querySelectorAll("connect").forEach((function(t){var i=e.parentElement;if(0==i.hasAttribute("DEF")){var s="_proto_"+i.tagName+"_"+x3dom.protoISDEFuid++;i.setAttribute("DEF",s),"protoinstance"==i.localName.toLowerCase()&&i._x3domNode&&(i._x3domNode._DEF=s,i._x3domNode.typeNode._nameSpace.defMap[s]=i._x3domNode)}var n=t.getAttribute("protoField"),r=i.getAttribute("DEF"),a=t.getAttribute("nodeField");o._ISRoutes[n]||(o._ISRoutes[n]=[]),o._ISRoutes[n].push({nodeDEF:r,nodeField:a})}))}));var n=new x3dom.ProtoDeclaration(this,t,o,s);n.registerNode(),this.protos.push(n)}else x3dom.debug.logWarning("ProtoDeclare without a ProtoBody definition: "+e.name);return"ProtoDeclare"},x3dom.protoISDEFuid=0,x3dom.gfx_webgl=function(){"use strict";function e(e,t,i,s){this.ctx3d=e,this.canvas=t,this.name=i,this.x3dElem=s,this.IG_PositionBuffer=null,this.cache=new x3dom.Cache,this.stateManager=new x3dom.StateManager(e),this.VRMode=1,this.vrFrameData=null,this.BUFFER_IDX={INDEX:0,POSITION:1,NORMAL:2,TEXCOORD:3,TEXCOORD_0:3,COLOR:4,TANGENT:6,BITANGENT:7,TEXCOORD_1:8,ID:9}}return e.prototype.getName=function(){return this.name},e.prototype.setupShape=function(e,t,i){var s,o,n,r,a,d,h,l,f,u,_,c,m=0,p=t.shape,x=p._cf.geometry.node;if(void 0!==p._webgl){var v=!1;if(!0===p._dirty.colors&&void 0===p._webgl.shader.color&&x._mesh._colors[0].length&&(v=!0),v&&p._cleanupGLObjects&&p._cleanupGLObjects(!0,!1),!0===p._dirty.texture){if(p._webgl.texture.length!=p.getTextures().length){for(n=0;n<p._webgl.texture.length;++n)p._webgl.texture.pop();for(o=p.getTextures(),n=0;n<o.length;++n)p._webgl.texture.push(new x3dom.Texture(e,p._nameSpace.doc,this.cache,o[n]));p._dirty.shader=!0,void 0===p._webgl.shader.texcoord&&(p._dirty.texcoords=!0)}else for(o=p.getTextures(),n=0;n<o.length;++n)o[n]===p._webgl.texture[n].node||(p._webgl.texture[n].texture=null,p._webgl.texture[n].node=o[n]),p._webgl.texture[n].update();p._dirty.texture=!1}if(p._webgl.shader=this.cache.getShaderByProperties(e,p,p.getShaderProperties(i)),!v&&0==p._webgl.binaryGeometry&&0==p._webgl.bufferGeometry)for(m=0;m<p._webgl.positions.length;m++)if(s=6*m,1!=p._dirty.positions&&1!=p._dirty.indexes||(void 0!==p._webgl.shader.position&&(p._webgl.indexes[m]=x._mesh._indices[m],e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.INDEX]),f=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.INDEX]=f,x3dom.caps.INDEX_UINT&&x._mesh._positions[0].length/3>65535?(u=new Uint32Array(p._webgl.indexes[m]),p._webgl.indexType=e.UNSIGNED_INT):(u=new Uint16Array(p._webgl.indexes[m]),p._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f),e.bufferData(e.ELEMENT_ARRAY_BUFFER,u,e.STATIC_DRAW),u=null,p._webgl.positions[m]=x._mesh._positions[m],e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.POSITION]),a=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.POSITION]=a,e.bindBuffer(e.ARRAY_BUFFER,a),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,p._webgl.buffers[s+x3dom.BUFFER_IDX.INDEX]),r=new Float32Array(p._webgl.positions[m]),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(p._webgl.shader.position,x._mesh._numPosComponents,p._webgl.coordType,!1,p._coordStrideOffset[0],p._coordStrideOffset[1]),r=null),p._dirty.positions=!1,p._dirty.indexes=!1),1==p._dirty.colors&&(void 0!==p._webgl.shader.color&&(p._webgl.colors[m]=x._mesh._colors[m],e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.COLOR]),c=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.COLOR]=c,M=new Float32Array(p._webgl.colors[m]),e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,M,e.STATIC_DRAW),e.vertexAttribPointer(p._webgl.shader.color,x._mesh._numColComponents,p._webgl.colorType,!1,p._colorStrideOffset[0],p._colorStrideOffset[1]),M=null),p._dirty.colors=!1),1==p._dirty.normals&&(void 0!==p._webgl.shader.normal&&(p._webgl.normals[m]=x._mesh._normals[m],e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.NORMAL]),_=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.NORMAL]=_,F=new Float32Array(p._webgl.normals[m]),e.bindBuffer(e.ARRAY_BUFFER,_),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(p._webgl.shader.normal,x._mesh._numNormComponents,p._webgl.normalType,!1,p._normalStrideOffset[0],p._normalStrideOffset[1]),F=null),p._dirty.normals=!1),1==p._dirty.texcoords&&(void 0!==p._webgl.shader.texcoord&&(p._webgl.texcoords[m]=x._mesh._texCoords[m],e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.TEXCOORD]),d=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.TEXCOORD]=d,C=new Float32Array(p._webgl.texcoords[m]),e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,C,e.STATIC_DRAW),e.vertexAttribPointer(p._webgl.shader.texCoord,x._mesh._numTexComponents,p._webgl.texCoordType,!1,p._texCoordStrideOffset[0],p._texCoordStrideOffset[1]),C=null),p._dirty.texcoords=!1),1==p._dirty.specialAttribs&&void 0!==p._webgl.shader.particleSize){var g=x._vf.size.toGL();g.length&&(e.deleteBuffer(p._webgl.buffers[s+x3dom.BUFFER_IDX.ID]),p._webgl.buffers[s+x3dom.BUFFER_IDX.ID]=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,p._webgl.buffers[s+x3dom.BUFFER_IDX.ID]),e.bufferData(e.ARRAY_BUFFER,new Float32Array(g),e.STATIC_DRAW)),p._dirty.specialAttribs=!1}if(!v)return}else if(!(x3dom.isa(x,x3dom.nodeTypes.Text)||x3dom.isa(x,x3dom.nodeTypes.BinaryGeometry)||x3dom.isa(x,x3dom.nodeTypes.PopGeometry)||x3dom.isa(x,x3dom.nodeTypes.BufferGeometry))&&(!x||x._mesh._positions[0].length<1))return void x3dom.debug.logError("NO VALID MESH OR NO VERTEX POSITIONS SET!");for(p.unsetDirty(),p._cleanupGLObjects||(p._cleanupGLObjects=function(t,i){if(this._webgl&&(arguments.length>0&&t||0==this._parentNodes.length)){for(var s=this._webgl.shader,o=0;o<this._webgl.positions.length;o++){var n=6*o;void 0!==s.position&&(e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.INDEX]),e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.POSITION])),void 0!==s.normal&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.NORMAL]),void 0!==s.texcoord&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.TEXCOORD]),void 0!==s.color&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.COLOR]),void 0!==s.id&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.ID]),void 0!==s.tangent&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.TANGENT]),void 0!==s.binormal&&e.deleteBuffer(this._webgl.buffers[n+x3dom.BUFFER_IDX.BITANGENT])}for(var r=0;r<this._webgl.dynamicFields.length;r++){var a=this._webgl.dynamicFields[r];void 0!==s[a.name]&&e.deleteBuffer(a.buf)}void 0===i&&(i=!0),i&&(delete this._webgl,x3dom.BinaryContainerLoader.outOfMemory=!1)}}),p._webgl={positions:x._mesh._positions,normals:x._mesh._normals,texcoords:x._mesh._texCoords,colors:x._mesh._colors,tangents:x._mesh._tangents,binormals:x._mesh._binormals,indexes:x._mesh._indices,indexType:e.UNSIGNED_SHORT,coordType:e.FLOAT,normalType:e.FLOAT,texCoordType:e.FLOAT,texCoord2Type:e.FLOAT,colorType:e.FLOAT,tangentType:e.FLOAT,binormalType:e.FLOAT,coordNormalized:!1,normalNormalized:!1,texCoordNormalized:!1,texCoord2Normalized:!1,colorNormalized:!1,tangentNormalized:!1,binormalNormalized:!1,texture:[],dirtyLighting:x3dom.Utils.checkDirtyLighting(i),binaryGeometry:0,popGeometry:0,bufferGeometry:0},o=p.getTextures(),n=0;n<o.length;++n)p._webgl.texture.push(new x3dom.Texture(e,p._nameSpace.doc,this.cache,o[n]));p._webgl.shader=this.cache.getShaderByProperties(e,p,p.getShaderProperties(i));var y=p._webgl.shader,S=0;if(p._webgl.buffers=[],p._webgl.dynamicFields=[],x3dom.isa(x,x3dom.nodeTypes.X3DBinaryContainerGeometryNode)){p._webgl.primType=[];for(var T=0;T<x._vf.primType.length;++T)p._webgl.primType.push(x3dom.Utils.primTypeDic(e,x._vf.primType[T]))}else p._webgl.primType=x3dom.Utils.primTypeDic(e,x._mesh._primType);if(x3dom.isa(x,x3dom.nodeTypes.BinaryGeometry))x3dom.BinaryContainerLoader.setupBinGeo(p,y,e,i,this);else if(x3dom.isa(x,x3dom.nodeTypes.BufferGeometry))x3dom.BinaryContainerLoader.setupBufferGeo(p,y,e,i,this);else if(x3dom.isa(x,x3dom.nodeTypes.PopGeometry))x3dom.BinaryContainerLoader.setupPopGeo(p,y,e,i,this);else{for(m=0;m<p._webgl.positions.length;m++){if(s=6*m,p._webgl.positions[m]&&(f=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.INDEX]=f,x3dom.caps.INDEX_UINT&&p._webgl.positions[0].length/3>65535?(u=new Uint32Array(p._webgl.indexes[m]),p._webgl.indexType=e.UNSIGNED_INT):(u=new Uint16Array(p._webgl.indexes[m]),p._webgl.indexType=e.UNSIGNED_SHORT),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,f),e.bufferData(e.ELEMENT_ARRAY_BUFFER,u,e.STATIC_DRAW),u=null,a=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.POSITION]=a,e.bindBuffer(e.ARRAY_BUFFER,a),r=new Float32Array(p._webgl.positions[m]),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,a),e.vertexAttribPointer(y.position,x._mesh._numPosComponents,p._webgl.coordType,!1,p._coordStrideOffset[0],p._coordStrideOffset[1]),e.enableVertexAttribArray(y.position),r=null),p._webgl.normals[m]){_=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.NORMAL]=_;var F=new Float32Array(p._webgl.normals[m]);e.bindBuffer(e.ARRAY_BUFFER,_),e.bufferData(e.ARRAY_BUFFER,F,e.STATIC_DRAW),e.vertexAttribPointer(y.normal,x._mesh._numNormComponents,p._webgl.normalType,!1,p._normalStrideOffset[0],p._normalStrideOffset[1]),e.enableVertexAttribArray(y.normal),F=null}if(p._webgl.texcoords[m]){var b=e.createBuffer();p._webgl.buffers[s+x3dom.BUFFER_IDX.TEXCOORD]=b;var C=new Float32Array(p._webgl.texcoords[m]);e.bindBuffer(e.ARRAY_BUFFER,b),e.bufferData(e.ARRAY_BUFFER,C,e.STATIC_DRAW),e.vertexAttribPointer(y.texcoord,x._mesh._numTexComponents,p._webgl.texCoordType,!1,p._texCoordStrideOffset[0],p._texCoordStrideOffset[1]),e.enableVertexAttribArray(y.texcoord),C=null}if(p._webgl.colors[m]){c=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.COLOR]=c;var M=new Float32Array(p._webgl.colors[m]);e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferData(e.ARRAY_BUFFER,M,e.STATIC_DRAW),e.vertexAttribPointer(y.color,x._mesh._numColComponents,p._webgl.colorType,!1,p._colorStrideOffset[0],p._colorStrideOffset[1]),e.enableVertexAttribArray(y.color),M=null}if(void 0!==y.particleSize){var E=x._vf.size.toGL();if(E.length){var w=e.createBuffer();p._webgl.buffers[s+x3dom.BUFFER_IDX.ID]=w,e.bindBuffer(e.ARRAY_BUFFER,w),e.bufferData(e.ARRAY_BUFFER,new Float32Array(E),e.STATIC_DRAW)}}if(p._webgl.tangents[m]){h=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.TANGENT]=h;var A=new Float32Array(p._webgl.tangents[m]);e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,A,e.STATIC_DRAW),e.vertexAttribPointer(y.tangent,x._mesh._numTangentComponents,p._webgl.tangentType,!1,p._tangentStrideOffset[0],p._tangentStrideOffset[1]),e.enableVertexAttribArray(y.tangent),A=null}if(p._webgl.binormals[m]){l=e.createBuffer(),p._webgl.buffers[s+x3dom.BUFFER_IDX.BITANGENT]=l;var D=new Float32Array(p._webgl.binormals[m]);e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,D,e.STATIC_DRAW),e.vertexAttribPointer(y.binormal,x._mesh._numBinormalComponents,p._webgl.binormalType,!1,p._binormalStrideOffset[0],p._binormalStrideOffset[1]),e.enableVertexAttribArray(y.tangent),D=null}}for(var N in x._mesh._dynamicFields)if(x._mesh._dynamicFields.hasOwnProperty(N)){var R=x._mesh._dynamicFields[N];if(p._webgl.dynamicFields[S]={buf:{},name:N,numComponents:R.numComponents},void 0!==y[N]){var I=e.createBuffer();p._webgl.dynamicFields[S++].buf=I;var P=new Float32Array(R.value);e.bindBuffer(e.ARRAY_BUFFER,I),e.bufferData(e.ARRAY_BUFFER,P,e.STATIC_DRAW),e.vertexAttribPointer(y[N],R.numComponents,e.FLOAT,!1,0,0),P=null}}}},e.prototype.setupScene=function(e,t){var i=null,s=null,o=this;if(void 0!==t._webgl){if(!t._dirty)return;void 0!==t._webgl.texture&&t._webgl.texture&&e.deleteTexture(t._webgl.texture),t._cleanupGLObjects&&t._cleanupGLObjects(),t._webgl={}}t._dirty=!1;var n=t.getTexUrl(),r=0;if(n.length>0&&n[0].length>0)n.length>=6&&n[1].length>0&&n[2].length>0&&n[3].length>0&&n[4].length>0&&n[5].length>0||-1!=n[0].indexOf(".dds")?(i=new x3dom.nodeTypes.Sphere,t._webgl={positions:i._mesh._positions[0],indexes:i._mesh._indices[0],buffers:[{},{}]},t._webgl.primType=e.TRIANGLES,-1!=n[0].indexOf(".dds")?(t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_CUBETEXTURE_DDS),t._webgl.texture=x3dom.Utils.createTextureCube(e,t._nameSpace.doc,[n[0]],!1,t._vf.crossOrigin,!0,!1,!1)):(t._webgl.shader=this.cache.getShader(e,x3dom.shader.BACKGROUND_CUBETEXTURE_DDS),t._webgl.texture=x3dom.Utils.createTextureCube(e,t._nameSpace.doc,n,!1,t._vf.crossOrigin,!0,!1))):(t._webgl={positions:[-1,-1,0,-1,1,0,1,-1,0,1,1,0],indexes:[0,1,2,3],buffers:[{},{}]},n=t._nameSpace.getURL(n[0]),t._webgl.texture=x3dom.Utils.createTexture2D(e,t._nameSpace.doc,n,!0,t._vf.crossOrigin,!1,!1),t._webgl.primType=e.TRIANGLE_STRIP,t._webgl.shader=o.cache.getShader(e,x3dom.shader.BACKGROUND_TEXTURE));else if(t.getSkyColor().length>1||t.getGroundColor().length){i=new x3dom.nodeTypes.Sphere,s=e.createTexture(),t._webgl={positions:i._mesh._positions[0],texcoords:i._mesh._texCoords[0],indexes:i._mesh._indices[0],buffers:[{},{},{}],texture:s,primType:e.TRIANGLES};var a=x3dom.Utils.nextHighestPowerOfTwo(t.getSkyColor().length+t.getGroundColor().length+2);a=a<512?512:a;var d=t._vf.groundAngle.length,h=[],l=[],f=[],u=[0];for(r=0;r<t._vf.skyColor.length;r++)f[r]=t._vf.skyColor[r];for(r=0;r<t._vf.skyAngle.length;r++)u[r+1]=t._vf.skyAngle[r];if(d>0||1==t._vf.groundColor.length){for(u[u.length-1]<Math.PI/2&&(u[u.length]=Math.PI/2-x3dom.fields.Eps,f[f.length]=f[f.length-1]),r=d-1;r>=0;r--)r==d-1&&Math.PI-t._vf.groundAngle[r]<=Math.PI/2&&(u[u.length]=Math.PI/2,f[f.length]=t._vf.groundColor[t._vf.groundColor.length-1]),u[u.length]=Math.PI-t._vf.groundAngle[r],f[f.length]=t._vf.groundColor[r+1];0==d&&1==t._vf.groundColor.length&&(u[u.length]=Math.PI/2,f[f.length]=t._vf.groundColor[0]),u[u.length]=Math.PI,f[f.length]=t._vf.groundColor[0]}else u[u.length-1]<Math.PI&&(u[u.length]=Math.PI,f[f.length]=f[f.length-1]);for(r=0;r<u.length;r++)u[r]/=Math.PI;if(u.length!=f.length){x3dom.debug.logError("Number of background colors and corresponding angles do not match.\nYou have to define one angle less than the count of RGB colors because the angle 0 is added automatically.");var _=u.length<f.length?u.length:f.length;u.length=_,f.length=_}var c=new x3dom.nodeTypes.ColorInterpolator;for(c._vf.key=new x3dom.fields.MFFloat(u),c._vf.keyValue=new x3dom.fields.MFColor(f),c._vf.RGB=!0,c.fieldChanged("keyValue"),r=0;r<a;r++)c._vf.set_fraction=r/(a-1),c.fieldChanged("set_fraction"),h[r]=c._vf.value_changed;h.reverse();var m=Math.floor(255*(1-t.getTransparency()));for(r=0;r<h.length;r++)l.push(Math.floor(255*h[r].r),Math.floor(255*h[r].g),Math.floor(255*h[r].b),m);var p=new Uint8Array(l),x=e.RGBA;a=p.length/4,e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(e.TEXTURE_2D,0,x,1,a,0,x,e.UNSIGNED_BYTE,p),e.bindTexture(e.TEXTURE_2D,null),t._webgl.shader=o.cache.getShader(e,x3dom.shader.BACKGROUND_SKYTEXTURE)}else t._webgl={};if(t._webgl.shader){var v=t._webgl.shader,g=e.createBuffer();t._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=g,e.bindBuffer(e.ARRAY_BUFFER,g);var y=new Float32Array(t._webgl.positions);e.bufferData(e.ARRAY_BUFFER,y,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,g),e.vertexAttribPointer(v.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(v.position);var S=e.createBuffer();t._webgl.buffers[x3dom.BUFFER_IDX.INDEX]=S;var T=new Uint16Array(t._webgl.indexes);if(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,S),e.bufferData(e.ELEMENT_ARRAY_BUFFER,T,e.STATIC_DRAW),y=null,T=null,void 0!==v.texcoord){var F=e.createBuffer();t._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]=F;var b=new Float32Array(t._webgl.texcoords);e.bindBuffer(e.ARRAY_BUFFER,F),e.bufferData(e.ARRAY_BUFFER,b,e.STATIC_DRAW),e.vertexAttribPointer(v.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(v.texcoord),b=null}t._cleanupGLObjects=function(){var t=this._webgl.shader;void 0!==t.position&&(e.deleteBuffer(this._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),e.deleteBuffer(this._webgl.buffers[x3dom.BUFFER_IDX.POSITION])),void 0!==t.texcoord&&e.deleteBuffer(this._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD])}}t._webgl.render=function(e,i,s,n){var r=t._webgl.shader,a=1-t.getTransparency(),d=null,h=s._22,l=s._23,f=i.e3();if(null!=r&&void 0!==r.texcoord&&null!==r.texcoord&&void 0!==t._webgl.texture&&null!==t._webgl.texture)e.clearColor(0,0,0,a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),o.stateManager.frontFace(e.CCW),o.stateManager.disable(e.CULL_FACE),o.stateManager.disable(e.DEPTH_TEST),o.stateManager.disable(e.BLEND),o.stateManager.useProgram(r),r.tex||(r.tex=0),s._22=100001/99999,s._23=2e5/99999,i._03=0,i._13=0,i._23=0,d=s.mult(i),r.modelViewProjectionMatrix=d.toGL(),i._03=f.x,i._13=f.y,i._23=f.z,s._22=h,s._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]),e.vertexAttribPointer(r.texcoord,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.texcoord),o.setVertexAttribEyeIdx(e,r),o.drawElements(e,t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(r.position),e.disableVertexAttribArray(r.texcoord),o.disableVertexAttribEyeIdx(e,r),e.clear(e.DEPTH_BUFFER_BIT);else if(!r||!t._webgl.texture||void 0!==t._webgl.texture.textureCubeReady&&!0!==t._webgl.texture.textureCubeReady){var u=t.getSkyColor().toGL();e.clearColor(u[0],u[1],u[2],a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}else{if(e.clearColor(0,0,0,a),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),o.stateManager.frontFace(e.CCW),o.stateManager.disable(e.CULL_FACE),o.stateManager.disable(e.DEPTH_TEST),o.stateManager.disable(e.BLEND),o.stateManager.useProgram(r),r.tex||(r.tex=0),t._webgl.texture.textureCubeReady)s._22=100001/99999,s._23=2e5/99999,i._03=0,i._13=0,i._23=0,d=s.mult(i),r.modelViewProjectionMatrix=d.toGL(),i._03=f.x,i._13=f.y,i._23=f.z,s._22=h,s._23=l,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_CUBE_MAP,t._webgl.texture),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);else{if(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t._vf.scaling&&t._webgl.texture.ready){var _=1,c=new x3dom.fields.SFVec2f(o.canvas.width,o.canvas.height),m=new x3dom.fields.SFVec2f(t._webgl.texture.width,t._webgl.texture.height);c.x>c.y?(_=c.x/m.x,m.x=c.x,m.y=m.y*_):(_=c.y/m.y,m.y=c.y,m.x=m.x*_);var p=c.divideComponents(m),x=m.subtract(c).multiply(.5).divideComponents(m)}else p=new x3dom.fields.SFVec2f(1,1),x=new x3dom.fields.SFVec2f(0,0);r.scale=p.toGL(),r.translation=x.toGL()}if(r.isVR=-1,r.screenWidth=o.canvas.width,o.setTonemappingOperator(n,r),2==o.VRMode){var v=n.getViewMatrices()[1],g=v.e3();v._03=0,v._13=0,v._23=0;var y=n.getProjectionMatrices()[1].mult(v);r.modelViewProjectionMatrix2=y.toGL(),v._03=g.x,v._13=g.y,v._23=g.z,r.isVR=1}o.setVertexAttribEyeIdx(e,r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),e.vertexAttribPointer(r.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r.position),o.drawElements(e,t._webgl.primType,t._webgl.indexes.length,e.UNSIGNED_SHORT,0),e.disableVertexAttribArray(r.position),o.disableVertexAttribEyeIdx(e,r),e.activeTexture(e.TEXTURE0),t._webgl.texture.textureCubeReady?e.bindTexture(e.TEXTURE_CUBE_MAP,null):e.bindTexture(e.TEXTURE_2D,null),e.clear(e.DEPTH_BUFFER_BIT)}}},e.prototype.setupFgnds=function(e,t){if(void 0===t._fgnd){var i=this;t._fgnd={},t._fgnd._webgl={positions:[-1,-1,0,-1,1,0,1,-1,0,1,1,0],indexes:[0,1,2,3],buffers:[{},{}]},t._fgnd._webgl.primType=e.TRIANGLE_STRIP,t._fgnd._webgl.shader=this.cache.getShader(e,x3dom.shader.FRONTGROUND_TEXTURE);var s=t._fgnd._webgl.shader,o=e.createBuffer();t._fgnd._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=o,e.bindBuffer(e.ARRAY_BUFFER,o);var n=new Float32Array(t._fgnd._webgl.positions);e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,o),e.vertexAttribPointer(s.position,3,e.FLOAT,!1,0,0);var r=e.createBuffer();t._fgnd._webgl.buffers[x3dom.BUFFER_IDX.INDEX]=r;var a=new Uint16Array(t._fgnd._webgl.indexes);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW),n=null,a=null,t._fgnd._webgl.render=function(e,o){t._fgnd._webgl.texture=o,i.stateManager.frontFace(e.CCW),i.stateManager.disable(e.CULL_FACE),i.stateManager.disable(e.DEPTH_TEST),i.stateManager.useProgram(s),s.tex||(s.tex=0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t._fgnd._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t._fgnd._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),e.bindBuffer(e.ARRAY_BUFFER,t._fgnd._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),e.vertexAttribPointer(s.position,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(s.position),i.drawElements(e,t._fgnd._webgl.primType,t._fgnd._webgl.indexes.length,e.UNSIGNED_SHORT,0,1),e.disableVertexAttribArray(s.position),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}}},e.prototype.renderShadowPass=function(e,t,i,s,o,n,r){var a=t._scene,d=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,o.fbo),this.stateManager.viewport(0,0,o.width,o.height),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND);x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL();var h,l=a.getEnvironment()._vf.shadowExcludeTransparentObjects,f=a.drawableCollection.length;for(h=0;h<f;h++){var u=a.drawableCollection.get(h),_=u.transform,c=u.shape,m=c._webgl;if(m&&(!l||"transparent"!=u.sortType)){var p=c._cf.geometry.node,x=c._cf.appearance.node,v=(p._mesh,c.getShaderProperties(t)),g=this.cache.getShaderByProperties(e,c,v,null,!0);if(!g)return;if(this.stateManager.useProgram(g),g.cameraView=r,g.offset=n,g.modelViewProjectionMatrix=i.mult(_).toGL(),m.coordType!=e.FLOAT&&(!m.popGeometry&&x3dom.Utils.isUnsignedType(p._vf.coordType)?g.bgCenter=p.getMin().toGL():g.bgCenter=p._vf.position.toGL(),g.bgSize=p._vf.size.toGL(),g.bgPrecisionMax=p.getPrecisionMax("coordType")),c._clipPlanes){g.modelViewMatrix=s.mult(_).toGL(),g.viewMatrixInverse=s.inverse().toGL();for(var y=0;y<c._clipPlanes.length;y++){var S=c._clipPlanes[y].plane,T=c._clipPlanes[y].trafo;g["clipPlane"+y+"_Plane"]=T.multMatrixPlane(S._vf.plane).toGL(),g["clipPlane"+y+"_CappingStrength"]=S._vf.cappingStrength,g["clipPlane"+y+"_CappingColor"]=S._vf.cappingColor.toGL()}}c.isSolid()?(this.stateManager.enable(e.CULL_FACE),c.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);var F,b=x?x._cf.depthMode.node:null;if(b?b._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!b._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,b._vf.depthFunc)),this.stateManager.depthRange(b._vf.zNearRange,b._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),m.popGeometry){var C=s.mult(_);this.updatePopState(u,p,g,m,a,C,t,this.x3dElem.runtime.fps)}F=m.positions.length;for(var M=0;M<F;M++){var E,w,A,D=6*M;if(void 0!==g.position&&m.buffers[D+x3dom.BUFFER_IDX.POSITION]&&m.indexes[M]){if(d=!1,m.buffers[D+x3dom.BUFFER_IDX.INDEX]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,m.buffers[D+x3dom.BUFFER_IDX.INDEX]),d=!0),this.setVertexAttribPointerPosition(e,c,D,M),void 0!==g.id&&m.buffers[D+x3dom.BUFFER_IDX.ID]&&(e.bindBuffer(e.ARRAY_BUFFER,m.buffers[D+x3dom.BUFFER_IDX.ID]),0!=m.binaryGeometry&&1==p._vf.idsPerVertex&&(e.vertexAttribPointer(g.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(g.id))),d&&(m.binaryGeometry>0||m.popGeometry>0))for(E=0,A=0,w=p._vf.vertexCount.length;E<w;E++)this.drawElements(e,m.primType[E],p._vf.vertexCount[E],m.indexType,x3dom.Utils.getByteAwareOffset(A,m.indexType,e)),A+=p._vf.vertexCount[E];else if(m.binaryGeometry<0||m.popGeometry<0)for(E=0,A=0,w=p._vf.vertexCount.length;E<w;E++)this.drawArrays(e,m.primType[E],A,p._vf.vertexCount[E]),A+=p._vf.vertexCount[E];else if(p.hasIndexOffset()){var N=c.tessellationProperties();for(E=0,w=N.length;E<w;E++)this.drawElements(e,m.primType,N[E].count,m.indexType,N[E].offset*x3dom.Utils.getOffsetMultiplier(m.indexType,e))}else 0==m.indexes[M].length?this.drawArrays(e,m.primType,0,m.positions[M].length/3):this.drawElements(e,m.primType,m.indexes[M].length,m.indexType,0);e.disableVertexAttribArray(g.position),void 0!==g.texcoord&&m.buffers[D+x3dom.BUFFER_IDX.TEXCOORD]&&e.disableVertexAttribArray(g.texcoord),void 0!==g.color&&m.buffers[D+x3dom.BUFFER_IDX.COLOR]&&e.disableVertexAttribArray(g.color),void 0!==g.id&&m.buffers[D+x3dom.BUFFER_IDX.ID]&&e.disableVertexAttribArray(g.id)}}}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),b&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderPickingPass=function(e,t,i,s,o,n,r,a,d,h,l){var f=t._webgl.pickScale,u=t._webgl.fboPick.height,_=a*f,c=u-1-d*f,m=!1;this.stateManager.bindFramebuffer(e.FRAMEBUFFER,t._webgl.fboPick.fbo),this.stateManager.viewport(0,0,t._webgl.fboPick.width,u),e.clearColor(0,0,0,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var p=t.drawableCollection.viewarea,x=t.getEnvironment(),v=t.drawableCollection.length;x._vf.smallFeatureCulling&&x._lowPriorityThreshold<1&&p.isMovingOrAnimating()&&!(v=Math.floor(v*x._lowPriorityThreshold))&&t.drawableCollection.length&&(v=1);x3dom.fields.SFVec3f.NullVector.toGL(),x3dom.fields.SFVec3f.OneVector.toGL();this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(2);for(var g=0;g<v;g++){var y=t.drawableCollection.get(g),S=y.transform,T=y.shape,F=T._webgl;if(F&&!(T._objectID<1)&&T._vf.isPickable){var b=T._cf.geometry.node,C=T._cf.appearance.node,M=(b._mesh,T.getShaderProperties(p)),E=this.cache.getShaderByProperties(e,T,M,r);if(!E)return;if(F.shader=E,this.stateManager.useProgram(E),E.screenWidth=this.canvas.width*t._webgl.pickScale,E.modelMatrix=S.toGL(),E.modelViewProjectionMatrix=s.mult(S).toGL(),E.isVR=-1,2==this.VRMode){var w=p.getViewMatrices()[1],A=p.getProjectionMatrices()[1].mult(w);E.modelViewProjectionMatrix2=A.mult(S).toGL(),E.isVR=1}if(E.lowBit=(255&T._objectID)/255,E.highBit=(T._objectID>>>8)/255,E.from=o.toGL(),E.sceneSize=n,0!=F.binaryGeometry&&1==b._vf.idsPerVertex&&(E.shadowIDs=T._vf.idOffset+x3dom.nodeTypes.Shape.objectID+2),F.coordType!=e.FLOAT&&(!F.popGeometry&&x3dom.Utils.isUnsignedType(b._vf.coordType)?E.bgCenter=b.getMin().toGL():E.bgCenter=b._vf.position.toGL(),E.bgSize=b._vf.size.toGL(),E.bgPrecisionMax=b.getPrecisionMax("coordType")),1==r&&F.colorType!=e.FLOAT&&(E.bgPrecisionColMax=b.getPrecisionMax("colorType")),2==r&&F.texCoordType!=e.FLOAT&&(E.bgPrecisionTexMax=b.getPrecisionMax("texCoordType")),T._clipPlanes){E.modelViewMatrix=i.mult(S).toGL(),E.viewMatrixInverse=i.inverse().toGL(),2==this.VRMode&&(E.modelViewMatrix2=w.mult(S).toGL(),E.viewMatrixInverse2=w.inverse().toGL());for(var D=0;D<T._clipPlanes.length;D++){var N=T._clipPlanes[D].plane,R=T._clipPlanes[D].trafo;E["clipPlane"+D+"_Plane"]=R.multMatrixPlane(N._vf.plane).toGL(),E["clipPlane"+D+"_CappingStrength"]=N._vf.cappingStrength,E["clipPlane"+D+"_CappingColor"]=N._vf.cappingColor.toGL()}}T.isSolid()?(this.stateManager.enable(e.CULL_FACE),T.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);var I=C?C._cf.depthMode.node:null;if(I?I._vf.enableDepthTest?(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!I._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(e,I._vf.depthFunc)),this.stateManager.depthRange(I._vf.zNearRange,I._vf.zFarRange)):this.stateManager.disable(e.DEPTH_TEST):(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL)),F.popGeometry){var P=i.mult(S);this.updatePopState(y,b,E,F,t,P,p,this.x3dElem.runtime.fps)}var V=C?C._cf.pointProperties.node:null;if(V=V&&(x3dom.isa(b,x3dom.nodeTypes.PointSet)||x3dom.isa(b,x3dom.nodeTypes.BinaryGeometry))){var O=C._cf.pointProperties.node._vf;E.pointSizeAttenuation=O.attenuation.toGL(),E.pointSizeFactor=f*O.pointSizeScaleFactor,E.minPointSize=O.pointSizeMinValue,E.maxPointSize=O.pointSizeMaxValue}for(var L=F.positions.length,B=0;B<L;B++){var U,G,X,k=6*B;if(void 0!==E.position&&F.buffers[k+x3dom.BUFFER_IDX.POSITION]&&F.indexes[B]){if(m=!1,F.buffers[k+x3dom.BUFFER_IDX.INDEX]&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,F.buffers[k+x3dom.BUFFER_IDX.INDEX]),m=!0),this.setVertexAttribEyeIdx(e,E),this.setVertexAttribPointerPosition(e,T,k,B),1==r&&this.setVertexAttribPointerColor(e,T,k,B),2==r&&void 0!==E.texcoord&&F.buffers[k+x3dom.BUFFER_IDX.TEXCOORD]&&this.setVertexAttribPointerTexCoord(e,T,k,B),void 0!==E.id&&F.buffers[k+x3dom.BUFFER_IDX.ID]&&(e.bindBuffer(e.ARRAY_BUFFER,F.buffers[k+x3dom.BUFFER_IDX.ID]),0!=F.binaryGeometry&&1==b._vf.idsPerVertex&&(e.vertexAttribPointer(E.id,1,e.FLOAT,!1,4,0),e.enableVertexAttribArray(E.id))),m&&(F.binaryGeometry>0||F.popGeometry>0))for(U=0,X=0,G=b._vf.vertexCount.length;U<G;U++)this.drawElements(e,F.primType[U],b._vf.vertexCount[U],F.indexType,x3dom.Utils.getByteAwareOffset(X,F.indexType,e)),X+=b._vf.vertexCount[U];else if(F.binaryGeometry<0||F.popGeometry<0)for(U=0,X=0,G=b._vf.vertexCount.length;U<G;U++)this.drawArrays(e,F.primType[U],X,b._vf.vertexCount[U]),X+=b._vf.vertexCount[U];else if(m&&F.bufferGeometry>0)this.drawElements(e,F.primType[0],b._vf.vertexCount[0],F.indexType,T._indexOffset);else if(F.bufferGeometry<0)this.drawArrays(e,F.primType[0],0,b._vf.vertexCount[0]);else if(b.hasIndexOffset()){var z=T.tessellationProperties();for(U=0,G=z.length;U<G;U++)this.drawElements(e,F.primType,z[U].count,F.indexType,z[U].offset*x3dom.Utils.getOffsetMultiplier(F.indexType,e))}else 0==F.indexes[B].length?this.drawArrays(e,F.primType,0,F.positions[B].length/3):this.drawElements(e,F.primType,F.indexes[B].length,F.indexType,0);e.disableVertexAttribArray(E.position),void 0!==E.texcoord&&F.buffers[k+x3dom.BUFFER_IDX.TEXCOORD]&&e.disableVertexAttribArray(E.texcoord),void 0!==E.color&&F.buffers[k+x3dom.BUFFER_IDX.COLOR]&&e.disableVertexAttribArray(E.color),void 0!==E.id&&F.buffers[k+x3dom.BUFFER_IDX.ID]&&e.disableVertexAttribArray(E.id),this.disableVertexAttribEyeIdx(e,E)}}}}x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),I&&(this.stateManager.enable(e.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.depthRange(0,1)),e.flush();try{var H=new Uint8Array(4*h*l);e.readPixels(_,c,h,l,e.RGBA,e.UNSIGNED_BYTE,H),t._webgl.fboPick.pixelData=H}catch(e){t._webgl.fboPick.pixelData=[],x3dom.debug.logException(e+" (cannot pick)")}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null)},e.prototype.renderShape=function(e,t,i,s,o,n,r,a,d){var h=!1,l=e.shape,f=e.transform;if(l&&l._webgl&&f){var u=l._webgl,_=u.shader;if(_){var c=this.stateManager.useProgram(_),m=l._cf.appearance.node,p=l._cf.geometry.node,x=p._mesh,v=t._scene,g=null;u.coordType!=d.FLOAT?(!u.popGeometry&&x3dom.Utils.isUnsignedType(p._vf.coordType)?_.bgCenter=p.getMin().toGL():_.bgCenter=p._vf.position.toGL(),_.bgSize=p._vf.size.toGL(),_.bgPrecisionMax=p.getPrecisionMax("coordType")):(_.bgCenter=[0,0,0],_.bgSize=[1,1,1],_.bgPrecisionMax=1),u.colorType!=d.FLOAT?_.bgPrecisionColMax=p.getPrecisionMax("colorType"):_.bgPrecisionColMax=1,u.texCoordType!=d.FLOAT?_.bgPrecisionTexMax=p.getPrecisionMax("texCoordType"):_.bgPrecisionTexMax=1,u.normalType!=d.FLOAT?_.bgPrecisionNorMax=p.getPrecisionMax("normalType"):_.bgPrecisionNorMax=1,u.tangentType!=d.FLOAT?_.bgPrecisionTangentMax=p.getPrecisionMax("tangentType"):_.bgPrecisionTangentMax=1,u.binormalType!=d.FLOAT?_.bgPrecisionBinormalMax=p.getPrecisionMax("binormalType"):_.bgPrecisionBinormalMax=1;var y=v.getFog();y&&c&&(_.fogColor=y._vf.color.toGL(),_.fogRange=y._vf.visibilityRange,_.fogType="LINEAR"==y._vf.fogType?0:1);var S,T=m?m._cf.material.node:null,F=m?m._shader:null,b=!1,C=F&&x3dom.isa(F,x3dom.nodeTypes.ComposedShader);if(u.csshader?(_.diffuseColor=F._vf.diffuseFactor.toGL(),_.specularColor=F._vf.specularFactor.toGL(),_.emissiveColor=F._vf.emissiveFactor.toGL(),_.shininess=F._vf.shininessFactor,_.ambientIntensity=(F._vf.ambientFactor.x+F._vf.ambientFactor.y+F._vf.ambientFactor.z)/3,_.transparency=1-F._vf.alphaFactor,_.environmentFactor=F._vf.environmentFactor.x,_.normalBias=F._vf.normalBias.toGL(),F.getDisplacementMap()?(g=x3dom.Utils.findTextureByName(u.texture,"displacementMap"),_.displacementWidth=g.texture.width,_.displacementHeight=g.texture.height,_.displacementFactor=F._vf.displacementFactor,_.displacementAxis="x"==F._vf.displacementAxis?0:"y"==F._vf.displacementAxis?1:2):F.getDiffuseDisplacementMap()&&(g=x3dom.Utils.findTextureByName(u.texture,"diffuseDisplacementMap"),_.displacementWidth=g.texture.width,_.displacementHeight=g.texture.height,_.displacementFactor=F._vf.displacementFactor,_.displacementAxis="x"==F._vf.displacementAxis?0:"y"==F._vf.displacementAxis?1:2)):T&&x3dom.isa(T,x3dom.nodeTypes.PhysicalMaterial)?("roughnessMetallic"==T._vf.model?(_.diffuseColor=[T._vf.baseColorFactor.r,T._vf.baseColorFactor.g,T._vf.baseColorFactor.b],_.specularColor=[x3dom.Utils.lerp(.04,T._vf.baseColorFactor.r,T._vf.metallicFactor),x3dom.Utils.lerp(.04,T._vf.baseColorFactor.g,T._vf.metallicFactor),x3dom.Utils.lerp(.04,T._vf.baseColorFactor.b,T._vf.metallicFactor)],_.shininess=1-T._vf.roughnessFactor,_.metallicFactor=T._vf.metallicFactor,_.transparency=1-T._vf.baseColorFactor.a):(_.diffuseColor=[T._vf.diffuseFactor.r,T._vf.diffuseFactor.g,T._vf.diffuseFactor.b],_.specularColor=[T._vf.specularFactor.r,T._vf.specularFactor.g,T._vf.specularFactor.b],_.shininess=T._vf.glossinessFactor,_.transparency=1-T._vf.diffuseFactor.a),_.emissiveColor=T._vf.emissiveFactor.toGL(),_.normalBias=T._vf.normalBias.toGL(),_.ambientIntensity=1,_.alphaCutoff=T._vf.alphaCutoff):T?(_.diffuseColor=T._vf.diffuseColor.toGL(),_.specularColor=T._vf.specularColor.toGL(),_.emissiveColor=T._vf.emissiveColor.toGL(),_.shininess=T._vf.shininess,_.ambientIntensity=T._vf.ambientIntensity,_.transparency=T._vf.transparency,_.environmentFactor=0,_.alphaCutoff=m._vf.alphaClipThreshold.toFixed(2),x3dom.isa(T,x3dom.nodeTypes.TwoSidedMaterial)&&(b=!0,_.backDiffuseColor=T._vf.backDiffuseColor.toGL(),_.backSpecularColor=T._vf.backSpecularColor.toGL(),_.backEmissiveColor=T._vf.backEmissiveColor.toGL(),_.backShininess=T._vf.backShininess,_.backAmbientIntensity=T._vf.backAmbientIntensity,_.backTransparency=T._vf.backTransparency)):(_.diffuseColor=[1,1,1],_.specularColor=[0,0,0],_.emissiveColor=[0,0,0],_.shininess=0,_.ambientIntensity=1,_.transparency=0,_.alphaCutoff=.1),F)if(C){for(var M in F._vf)if(F._vf.hasOwnProperty(M)&&"language"!==M){var E=F._vf[M];null!=E&&(E.toGL?_[M]=E.toGL():_[M]=E)}}else x3dom.isa(F,x3dom.nodeTypes.CommonSurfaceShader)&&(u.csshader=F);for(var w=0;w<s&&c;w++){var A=o.mult(i[w].getCurrentTransform());x3dom.isa(i[w],x3dom.nodeTypes.DirectionalLight)?(_["light"+w+"_Type"]=0,_["light"+w+"_On"]=i[w]._vf.on?1:0,_["light"+w+"_Color"]=i[w]._vf.color.toGL(),_["light"+w+"_Intensity"]=i[w]._vf.intensity,_["light"+w+"_AmbientIntensity"]=i[w]._vf.ambientIntensity,_["light"+w+"_Direction"]=A.multMatrixVec(i[w]._vf.direction).toGL(),_["light"+w+"_Attenuation"]=[1,1,1],_["light"+w+"_Location"]=[1,1,1],_["light"+w+"_Radius"]=0,_["light"+w+"_BeamWidth"]=0,_["light"+w+"_CutOffAngle"]=0,_["light"+w+"_ShadowIntensity"]=i[w]._vf.shadowIntensity):x3dom.isa(i[w],x3dom.nodeTypes.PointLight)?(_["light"+w+"_Type"]=1,_["light"+w+"_On"]=i[w]._vf.on?1:0,_["light"+w+"_Color"]=i[w]._vf.color.toGL(),_["light"+w+"_Intensity"]=i[w]._vf.intensity,_["light"+w+"_AmbientIntensity"]=i[w]._vf.ambientIntensity,_["light"+w+"_Direction"]=[1,1,1],_["light"+w+"_Attenuation"]=i[w]._vf.attenuation.toGL(),_["light"+w+"_Location"]=A.multMatrixPnt(i[w]._vf.location).toGL(),_["light"+w+"_Radius"]=i[w]._vf.radius,_["light"+w+"_BeamWidth"]=0,_["light"+w+"_CutOffAngle"]=0,_["light"+w+"_ShadowIntensity"]=i[w]._vf.shadowIntensity):x3dom.isa(i[w],x3dom.nodeTypes.SpotLight)?(_["light"+w+"_Type"]=2,_["light"+w+"_On"]=i[w]._vf.on?1:0,_["light"+w+"_Color"]=i[w]._vf.color.toGL(),_["light"+w+"_Intensity"]=i[w]._vf.intensity,_["light"+w+"_AmbientIntensity"]=i[w]._vf.ambientIntensity,_["light"+w+"_Direction"]=A.multMatrixVec(i[w]._vf.direction).toGL(),_["light"+w+"_Attenuation"]=i[w]._vf.attenuation.toGL(),_["light"+w+"_Location"]=A.multMatrixPnt(i[w]._vf.location).toGL(),_["light"+w+"_Radius"]=i[w]._vf.radius,_["light"+w+"_BeamWidth"]=i[w]._vf.beamWidth,_["light"+w+"_CutOffAngle"]=i[w]._vf.cutOffAngle,_["light"+w+"_ShadowIntensity"]=i[w]._vf.shadowIntensity):x3dom.isa(i[w],x3dom.nodeTypes.PhysicalEnvironmentLight)&&(S=i[w],s--)}if(v.getNavigationInfo()._vf.headlight&&c&&(_["light"+(s=s||0)+"_Type"]=0,_["light"+s+"_On"]=1,_["light"+s+"_Color"]=[1,1,1],_["light"+s+"_Intensity"]=1,_["light"+s+"_AmbientIntensity"]=0,_["light"+s+"_Direction"]=[0,0,-1],_["light"+s+"_Attenuation"]=[1,1,1],_["light"+s+"_Location"]=[1,1,1],_["light"+s+"_Radius"]=0,_["light"+s+"_BeamWidth"]=0,_["light"+s+"_CutOffAngle"]=0,_["light"+s+"_ShadowIntensity"]=0),l._clipPlanes)for(var D=0;D<l._clipPlanes.length;D++){var N=l._clipPlanes[D].plane,R=l._clipPlanes[D].trafo;_["clipPlane"+D+"_Plane"]=R.multMatrixPlane(N._vf.plane).toGL(),_["clipPlane"+D+"_CappingStrength"]=N._vf.cappingStrength,_["clipPlane"+D+"_CappingColor"]=N._vf.cappingColor.toGL()}var I=m?m._cf.depthMode.node:null;I?I._vf.enableDepthTest?(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!I._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(d,I._vf.depthFunc)),this.stateManager.depthRange(I._vf.zNearRange,I._vf.zFarRange)):this.stateManager.disable(d.DEPTH_TEST):(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL));var P=m?m._cf.blendMode.node:null;if(P){var V=x3dom.Utils.blendFunc(d,P._vf.srcFactor),O=x3dom.Utils.blendFunc(d,P._vf.destFactor);V&&O?(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(V,O,d.ONE,d.ONE),this.stateManager.blendColor(P._vf.color.r,P._vf.color.g,P._vf.color.b,1-P._vf.colorTransparency),this.stateManager.blendEquation(x3dom.Utils.blendEquation(d,P._vf.equation))):this.stateManager.disable(d.BLEND)}else T&&x3dom.isa(T,x3dom.nodeTypes.PhysicalMaterial)?"BLEND"==T._vf.alphaMode?(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE)):this.stateManager.disable(d.BLEND):(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE));var L=m?m._cf.colorMaskMode.node:null;L?this.stateManager.colorMask(L._vf.maskR,L._vf.maskG,L._vf.maskB,L._vf.maskA):this.stateManager.colorMask(!0,!0,!0,!0);var B=m?m._cf.lineProperties.node:null;B?this.stateManager.lineWidth(B._vf.linewidthScaleFactor):x3dom.Utils.needLineWidth&&this.stateManager.lineWidth(1),l.isSolid()&&!b?(this.stateManager.enable(d.CULL_FACE),l.isCCW()?this.stateManager.frontFace(d.CCW):this.stateManager.frontFace(d.CW)):this.stateManager.disable(d.CULL_FACE);var U=o.mult(f),G=U.inverse();if(_.screenWidth=this.canvas.width,_.isOrthoView=1==a._33?1:0,_.modelMatrix=f.toGL(),_.modelViewMatrix=U.toGL(),_.viewMatrix=o.toGL(),_.normalMatrix=G.transpose().toGL(),_.modelViewMatrixInverse=G.toGL(),_.modelViewProjectionMatrix=n.mult(f).toGL(),_.modelViewProjectionInverseMatrix=n.mult(f).inverse().toGL(),_.viewMatrixInverse=o.inverse().toGL(),_.cameraPosWS=o.inverse().e3().toGL(),this.setTonemappingOperator(t,_),C&&(_.model=f.toGL(),_.projectionMatrix=a.toGL(),_.worldMatrix=f.toGL(),_.worldInverseTranspose=f.inverse().transpose().toGL()),2==this.VRMode){var X=t.getViewMatrices()[1],k=t.getProjectionMatrices()[1].mult(X),z=X.mult(f),H=z.inverse();_.viewMatrix2=X.toGL(),_.modelViewMatrix2=z.toGL(),_.normalMatrix2=H.transpose().toGL(),_.modelViewMatrixInverse2=H.toGL(),_.modelViewProjectionMatrix2=k.mult(f).toGL(),_.isVR=1}else _.isVR=0;u.popGeometry&&this.updatePopState(e,p,_,u,v,U,t,this.x3dElem.runtime.fps);for(var j=0,W=u.texture.length;j<W;j++)g=u.texture[j],d.activeTexture(d.TEXTURE0+j),d.bindTexture(g.type,g.texture),d.texParameteri(g.type,d.TEXTURE_WRAP_S,g.wrapS),d.texParameteri(g.type,d.TEXTURE_WRAP_T,g.wrapT),d.texParameteri(g.type,d.TEXTURE_MAG_FILTER,g.magFilter),d.texParameteri(g.type,d.TEXTURE_MIN_FILTER,g.minFilter),x3dom.caps.ANISOTROPIC&&d.texParameterf(g.type,x3dom.caps.ANISOTROPIC.TEXTURE_MAX_ANISOTROPY_EXT,g.anisotropicDegree),F&&C||_[g.samplerName]||(_[g.samplerName]=j);if(x3dom.isa(T,x3dom.nodeTypes.PhysicalMaterial)&&null!=S&&""!=S._vf.diffuse&&""!=S._vf.specular){var Y=S._nameSpace.getURL(S._vf.diffuse),q=S._nameSpace.getURL(S._vf.specular),Q=x3dom.BRDF_LUT,K=this.cache.getTexture2D(d,l._nameSpace.doc,Q,!1,"anonymous",!1,!1,!0),Z=this.cache.getTextureCube(d,l._nameSpace.doc,[Y],!1,"anonymous",!1,!1,!0),J=this.cache.getTextureCube(d,l._nameSpace.doc,[q],!1,"anonymous",!1,!1,!0);d.activeTexture(d.TEXTURE0+W),d.bindTexture(d.TEXTURE_2D,K),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),_.brdfMap=W++,Z.ready&&(d.activeTexture(d.TEXTURE0+W),d.bindTexture(d.TEXTURE_CUBE_MAP,Z),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),_.diffuseEnvironmentMap=W++),J.ready&&(d.activeTexture(d.TEXTURE0+W),d.bindTexture(d.TEXTURE_CUBE_MAP,J),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),_.specularEnvironmentMap=W++)}if(m&&m._cf.textureTransform.node){var $=m.texTransformMatrix();_.texTrafoMatrix=$.toGL()}var ee,te,ie,se,oe,ne=null,re=u.dynamicFields.length;for(ee=0;ee<re;ee++)void 0!==_[(ne=u.dynamicFields[ee]).name]&&(d.bindBuffer(d.ARRAY_BUFFER,ne.buf),d.vertexAttribPointer(_[ne.name],ne.numComponents,d.FLOAT,!1,0,0),d.enableVertexAttribArray(_[ne.name]));var ae=!1;x3dom.isa(p,x3dom.nodeTypes.ParticleSet)&&(ae=!0);var de=m?m._cf.pointProperties.node:null;if(de=de&&(x3dom.isa(p,x3dom.nodeTypes.PointSet)||x3dom.isa(p,x3dom.nodeTypes.BinaryGeometry))){var he=m._cf.pointProperties.node._vf;_.pointSizeAttenuation=he.attenuation.toGL(),_.pointSizeFactor=he.pointSizeScaleFactor,_.minPointSize=he.pointSizeMinValue,_.maxPointSize=he.pointSizeMaxValue}oe=u.positions.length;for(var le=0;le<oe;le++){var fe=6*le;if(h=!1,void 0!==_.position&&u.buffers[fe+x3dom.BUFFER_IDX.POSITION]&&u.indexes[le]){if(u.buffers[fe+x3dom.BUFFER_IDX.INDEX]){if(ae&&"any"!=p.drawOrder()){for(var ue,_e=[],ce=p._cf.coord.node.getPoints(),me=ce.length==u.indexes[le].length?u.indexes[le].length:0,pe=0;pe<me;pe++){var xe=U.multMatrixPnt(ce[pe]);_e.push([pe,xe.z])}for("backtofront"==p.drawOrder()?_e.sort((function(e,t){return e[1]-t[1]})):_e.sort((function(e,t){return t[1]-e[1]})),pe=0;pe<me;pe++)l._webgl.indexes[le][pe]=_e[pe][0];x3dom.caps.INDEX_UINT&&me>65535?(ue=new Uint32Array(l._webgl.indexes[le]),l._webgl.indexType=d.UNSIGNED_INT):(ue=new Uint16Array(l._webgl.indexes[le]),l._webgl.indexType=d.UNSIGNED_SHORT),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,u.buffers[fe+x3dom.BUFFER_IDX.INDEX]),d.bufferData(d.ELEMENT_ARRAY_BUFFER,ue,d.DYNAMIC_DRAW),ue=null}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,u.buffers[fe+x3dom.BUFFER_IDX.INDEX]),h=!0}this.setVertexAttribEyeIdx(d,_),this.setVertexAttribPointerPosition(d,l,fe,le),this.setVertexAttribPointerNormal(d,l,fe,le),this.setVertexAttribPointerTexCoord(d,l,fe,le),this.setVertexAttribPointerTexCoord2(d,l,fe,le),this.setVertexAttribPointerColor(d,l,fe,le),this.setVertexAttribPointerTangent(d,l,fe,le),this.setVertexAttribPointerBinormal(d,l,fe,le),void 0===_.id&&void 0===_.particleSize||!l._webgl.buffers[fe+x3dom.BUFFER_IDX.ID]||(d.bindBuffer(d.ARRAY_BUFFER,l._webgl.buffers[fe+x3dom.BUFFER_IDX.ID]),0!=u.binaryGeometry&&1==p._vf.idsPerVertex?(d.vertexAttribPointer(_.id,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(_.id)):ae&&(d.vertexAttribPointer(_.particleSize,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(_.particleSize))),0!=u.popGeometry&&u.buffers[fe+x3dom.BUFFER_IDX.ID]&&(d.bindBuffer(d.ARRAY_BUFFER,u.buffers[fe+x3dom.BUFFER_IDX.ID]),d.vertexAttribPointer(_.PG_vertexID,1,d.FLOAT,!1,4,0),d.enableVertexAttribArray(_.PG_vertexID));var ve,ge=t.getRenderMode(),ye=!!T&&(T._vf.transparency>0&&!l.isSolid()),Se=function(e,t){e.frontFace(l.isCCW()?d.CCW:d.CW),e.enable(d.CULL_FACE),e.cullFace(d.FRONT),t(),e.cullFace(d.BACK),t(),e.disable(d.CULL_FACE)};if(ge>0){var Te=1==ge?d.POINTS:d.LINES;if(h&&(u.binaryGeometry>0||u.popGeometry>0))for(te=0,se=0,ie=p._vf.vertexCount.length;te<ie;te++)this.drawElements(d,Te,p._vf.vertexCount[te],u.indexType,x3dom.Utils.getByteAwareOffset(se,u.indexType,d)),se+=p._vf.vertexCount[te];else if(u.binaryGeometry<0||u.popGeometry<0)for(te=0,se=0,ie=p._vf.vertexCount.length;te<ie;te++)this.drawArrays(d,Te,se,p._vf.vertexCount[te]),se+=p._vf.vertexCount[te];else if(h&&u.bufferGeometry>0)this.drawElements(d,u.primType[0],p._vf.vertexCount[0],u.indexType,l._indexOffset);else if(u.bufferGeometry<0)this.drawArrays(d,u.primType[0],0,p._vf.vertexCount[0]);else if(p.hasIndexOffset())for(te=0,ie=(ve=l.tessellationProperties()).length;te<ie;te++)this.drawElements(d,Te,ve[te].count,u.indexType,ve[te].offset*x3dom.Utils.getOffsetMultiplier(u.indexType,d));else 0==u.indexes[le].length?this.drawArrays(d,Te,0,u.positions[le].length/3):this.drawElements(d,Te,u.indexes[le].length,u.indexType,0)}else if(h&&(u.binaryGeometry>0||u.popGeometry>0))for(te=0,se=0,ie=p._vf.vertexCount.length;te<ie;te++)this.drawElements(d,u.primType[te],p._vf.vertexCount[te],u.indexType,x3dom.Utils.getByteAwareOffset(se,u.indexType,d)),se+=p._vf.vertexCount[te];else if(u.binaryGeometry<0||u.popGeometry<0)for(te=0,se=0,ie=p._vf.vertexCount.length;te<ie;te++)this.drawArrays(d,u.primType[te],se,p._vf.vertexCount[te]),se+=p._vf.vertexCount[te];else if(h&&u.bufferGeometry>0)this.drawElements(d,u.primType[0],p._vf.vertexCount[0],u.indexType,l._indexOffset);else if(u.bufferGeometry<0)this.drawArrays(d,u.primType[0],0,p._vf.vertexCount[0]);else if(p.hasIndexOffset())for(te=0,ie=(ve=l.tessellationProperties()).length;te<ie;te++)this.drawElements(d,u.primType,ve[te].count,u.indexType,ve[te].offset*x3dom.Utils.getOffsetMultiplier(u.indexType,d));else 0==u.indexes[le].length?ye?Se(this.stateManager,this.drawArrays.bind(this,d,u.primType,0,u.positions[le].length/3)):this.drawArrays(d,u.primType,0,u.positions[le].length/3):ye?Se(this.stateManager,this.drawElements.bind(this,d,u.primType,u.indexes[le].length,u.indexType,0)):this.drawElements(d,u.primType,u.indexes[le].length,u.indexType,0);d.disableVertexAttribArray(_.position),void 0!==_.normal&&d.disableVertexAttribArray(_.normal),this.disableVertexAttribEyeIdx(d,_),void 0!==_.texcoord&&d.disableVertexAttribArray(_.texcoord),void 0!==_.texcoord2&&d.disableVertexAttribArray(_.texcoord2),void 0!==_.color&&d.disableVertexAttribArray(_.color),void 0!==_.tangent&&d.disableVertexAttribArray(_.tangent),void 0!==_.binormal&&d.disableVertexAttribArray(_.binormal),u.buffers[fe+x3dom.BUFFER_IDX.ID]&&(void 0!==_.id?d.disableVertexAttribArray(_.id):void 0!==_.particleSize&&d.disableVertexAttribArray(_.particleSize)),0!=u.popGeometry&&void 0!==_.PG_vertexID&&d.disableVertexAttribArray(_.PG_vertexID)}}for(ee=0;ee<re;ee++)void 0!==_[(ne=u.dynamicFields[ee]).name]&&d.disableVertexAttribArray(_[ne.name]);this.numCoords+=x._numCoords,this.numFaces+=x._numFaces,u.binaryGeometry||u.popGeometry||u.bufferGeometry?this.numDrawCalls+=p._vf.vertexCount.length:p.hasIndexOffset()?this.numDrawCalls+=l.tessellationProperties().length:this.numDrawCalls+=oe,I&&(this.stateManager.enable(d.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(d.LEQUAL),this.stateManager.depthRange(0,1)),P&&(this.stateManager.enable(d.BLEND),this.stateManager.blendFuncSeparate(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA,d.ONE,d.ONE),this.stateManager.blendColor(1,1,1,1),this.stateManager.blendEquation(d.FUNC_ADD)),L&&this.stateManager.colorMask(!0,!0,!0,!0),B&&this.stateManager.lineWidth(1);var Fe=u.texture;for(W=Fe?Fe.length:0,j=0;j<W;j++)Fe[j]&&m&&m._cf.texture.node&&(g=m._cf.texture.node.getTexture(j),d.activeTexture(d.TEXTURE0+j),x3dom.isa(g,x3dom.nodeTypes.X3DEnvironmentTextureNode)?d.bindTexture(d.TEXTURE_CUBE_MAP,null):d.bindTexture(d.TEXTURE_2D,null))}else x3dom.debug.logError("[Context|RenderShape] No Shader is set!")}else x3dom.debug.logError("[Context|RenderShape] No valid Shape!")},e.prototype.updatePopState=function(e,t,i,s,o,n,r,a){var d=x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor*t._vf.precisionFactor;(a<=1||r.isMovingOrAnimating())&&(d*=x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove);var h=16;if(d>0){var l=o.getViewpoint(),f=l.getImgPlaneHeightAtDistOne(),u=l.getNear(),_=n.multMatrixPnt(t._vf.position),c=.5*n.multMatrixVec(t._vf.size).length(),m=2*(.5*n.multMatrixVec(t._vf.maxBBSize).length())/(d*(Math.max(-_.z-c,u)*(f/r._height)));h=(h=Math.ceil(Math.log(m)/.693147180559945))<1?1:h>16?16:h}var p=t._vf.minPrecisionLevel,x=t._vf.maxPrecisionLevel;h=-1!=p&&h<p?p:h,h=-1!=x&&h>x?x:h;var v=s.levelsAvailable<h?s.levelsAvailable:h;h=v,d<=1&&(h=h==t.getNumLevels()?16:h);var g=t._vf.indexedRendering,y=t._mesh;y._numCoords=0,y._numFaces=0;for(var S=0;S<v;++S){var T=s.numVerticesAtLevel[S];y._numCoords+=T,y._numFaces+=(g?t.getNumIndicesByLevel(S):T)/3}x3dom.nodeTypes.PopGeometry.numRenderedVerts+=y._numCoords,x3dom.nodeTypes.PopGeometry.numRenderedTris+=y._numFaces,y.currentLOD=h,t.adaptVertexCount(g?3*y._numFaces:y._numCoords),i.PG_maxBBSize=t._vf.maxBBSize.toGL(),i.PG_bbMin=t._bbMinBySize,i.PG_numAnchorVertices=t._vf.numAnchorVertices,i.PG_bbMaxModF=t._vf.bbMaxModF.toGL(),i.PG_bboxShiftVec=t._vf.bbShiftVec.toGL(),i.PG_precisionLevel=h,i.PG_powPrecision=x3dom.nodeTypes.PopGeometry.powLUT[h-1]},e.prototype.pickValue=function(e,t,i,s,o,n){x3dom.Utils.startMeasure("picking");var r=e._scene,a=this.ctx3d;if(!(a&&r&&r._webgl&&r.drawableCollection))return!1;var d,h,l=r._vf.pickMode.toLowerCase(),f=0;switch(l){case"box":return!1;case"idbuf":f=0;break;case"idbuf24":f=3;break;case"idbufid":f=4;break;case"color":f=1;break;case"texcoord":f=2}arguments.length>4?(d=o,h=n):(d=e._last_mat_view,h=e._last_mat_scene);var u=x3dom.fields.SFVec3f.copy(r._lastMin),_=x3dom.fields.SFVec3f.copy(r._lastMax),c=d.inverse().e3(),m=x3dom.fields.SFVec3f.copy(c),p=x3dom.fields.SFVec3f.copy(c);m.x>u.x&&(m.x=u.x),m.y>u.y&&(m.y=u.y),m.z>u.z&&(m.z=u.z),p.x<_.x&&(p.x=_.x),p.y<_.y&&(p.y=_.y),p.z<_.z&&(p.z=_.z),r._lastMin.setValues(m),r._lastMax.setValues(p);var x=r._lastMax.subtract(r._lastMin).length();r.getViewpoint().getFar()&&(x=Math.min(x,r.getViewpoint().getFar()));var v=e.getCCtoWCMatrix();r._lastMin.setValues(u),r._lastMax.setValues(_);var g=x3dom.nodeTypes.Shape.objectID+2;this.renderPickingPass(a,r,d,h,c,x,f,t,i,2,2);var y=r._webgl.fboPick.pixelData;if(y&&y.length){var S,T,F,b,C,M,E=new x3dom.fields.SFVec3f(0,0,0),w=new x3dom.fields.SFVec3f(0,0,1),A=0,D=y[A+3],N=1/r._webgl.pickScale,R=1/256;0==f?(D+=256*y[A+2],T=y[A]/255*R+y[A+1]/255,F=e.calcViewRay(t,i,v),E=c.add(F.dir.multiply(T*x)),T=y[A=4]/255*R+y[A+1]/255,b=e.calcViewRay(t+N,i,v),C=(C=c.add(b.dir.multiply(T*x))).subtract(E).normalize(),T=y[A=8]/255*R+y[A+1]/255,b=e.calcViewRay(t,i-N,v),M=(M=c.add(b.dir.multiply(T*x))).subtract(E).normalize(),w=C.cross(M).normalize()):3==f?(D+=256*y[A+2]+65536*y[A+1],T=y[A]/255,F=e.calcViewRay(t,i,v),E=c.add(F.dir.multiply(T*x)),T=y[A=4]/255,b=e.calcViewRay(t+N,i,v),C=(C=c.add(b.dir.multiply(T*x))).subtract(E).normalize(),T=y[A=8]/255,b=e.calcViewRay(t,i-N,v),M=(M=c.add(b.dir.multiply(T*x))).subtract(E).normalize(),w=C.cross(M).normalize()):4==f?(D+=256*y[A+2],S=y[A+1],S+=256*y[A],0==D&&S>0&&S<g&&(D=S)):(E.x=y[A],E.y=y[A+1],E.z=y[A+2]);var I,P,V="shadowObjectIdChanged",O=Math.max(s>>>8,255&s);if(D>=g){var L;D-=g;var B=t*e._inverseDevicePixelRatio,U=i*e._inverseDevicePixelRatio;if(4!=f?(e._pickingInfo.pickPos=E,e._pick.setValues(E),e._pickingInfo.pickNorm=w,e._pickNorm.setValues(w),e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null,L=r._xmlNode):(e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[S],L=e._pickingInfo.pickObj._xmlNode),I=e._pickingInfo.shadowObjectId!=D,e._pickingInfo.lastShadowObjectId=e._pickingInfo.shadowObjectId,e._pickingInfo.shadowObjectId=D,(I||O)&&r._xmlNode&&(r._xmlNode["on"+V]||r._xmlNode.hasAttribute("on"+V)||r._listeners[V])&&(P={target:r._xmlNode,type:V,button:O,mouseup:s>>>8>0,layerX:B,layerY:U,shadowObjectId:D,worldX:E.x,worldY:E.y,worldZ:E.z,normalX:w.x,normalY:w.y,normalZ:w.z,hitPnt:E.toGL(),hitObject:L,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},r.callEvtHandler("on"+V,P)),r._shadowIdMap&&r._shadowIdMap.mapping&&D<r._shadowIdMap.mapping.length){var G,X,k,z=r._shadowIdMap.mapping[D].usage;for(F||(F=e.calcViewRay(t,i,v)),X=0;X<z.length;X++)if((k=r._nameSpace.defMap[z[X]])&&k.doIntersect(F)){e._pickingInfo.pickObj=k;break}for(G=0;G<r._nameSpace.childSpaces.length;G++)for(X=0;X<z.length;X++)if((k=r._nameSpace.childSpaces[G].defMap[z[X]])&&k.doIntersect(F)){e._pickingInfo.pickObj=k;break}}}else I=-1!=e._pickingInfo.shadowObjectId,e._pickingInfo.shadowObjectId=-1,I&&r._xmlNode&&(r._xmlNode["on"+V]||r._xmlNode.hasAttribute("on"+V)||r._listeners[V])&&(P={target:r._xmlNode,type:V,button:O,mouseup:s>>>8>0,layerX:B,layerY:U,shadowObjectId:e._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},r.callEvtHandler("on"+V,P)),D>0?(e._pickingInfo.pickPos=E,e._pickingInfo.pickNorm=w,e._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[D]):(e._pickingInfo.pickObj=null,e._pickingInfo.lastClickObj=null)}var H=x3dom.Utils.stopMeasure("picking");return this.x3dElem.runtime.addMeasurement("PICKING",H),!0},e.prototype.pickRect=function(e,t,i,s,o){var n=this.ctx3d,r=e?e._scene:null;if(!(n&&r&&r._webgl&&r.drawableCollection))return!1;var a,d=e._last_mat_view.inverse().e3(),h=r._lastMax.subtract(r._lastMin).length(),l=t<=s?t:s,f=i>=o?i:o,u=(1+Math.abs(s-t))*r._webgl.pickScale,_=(1+Math.abs(o-i))*r._webgl.pickScale;this.renderPickingPass(n,r,e._last_mat_view,e._last_mat_scene,d,h,0,l,f,u<1?1:u,_<1?1:_);var c=[];for(a=0;r._webgl.fboPick.pixelData&&a<r._webgl.fboPick.pixelData.length;a+=4){var m=r._webgl.fboPick.pixelData[a+3]+256*r._webgl.fboPick.pixelData[a+2];m>0&&c.push(m)}c.sort(),c=function(e){for(var t=[],i=e.length,s=0;s<i;s++){for(var o=s+1;o<i;o++)e[s]===e[o]&&(o=++s);t.push(e[s])}return t}(c);var p,x=[],v=x3dom.nodeTypes.Shape.objectID+2;for(a=0;a<c.length;a++)(m=c[a])>=v?m-=v:(p=(p=x3dom.nodeTypes.Shape.idMap.nodeID[m])&&p._xmlNode?p._xmlNode:null)&&x.push(p);return x},e.prototype.renderScene=function(e,t){var i=this.ctx3d,s=e._scene;if(null!==i&&null!==s){var o,n,r,a,d,h,l,f,u,_,c,m=e._doc._nodeBag.renderTextures,p=m.length,x=null,v=i.UNSIGNED_BYTE,g=i.UNSIGNED_BYTE;x3dom.caps.FP_TEXTURES&&(v=i.FLOAT,g=i.FLOAT,x3dom.caps.FPL_TEXTURES||!0);var y=[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1];if(s.updateVolume(),s._webgl){var S=Math.round(this.canvas.width*s._webgl.pickScale),T=Math.round(this.canvas.height*s._webgl.pickScale);for(s._webgl._currFboWidth===S&&s._webgl._currFboHeight===T||(s._webgl._currFboWidth=S,s._webgl._currFboHeight=T,s._webgl.fboPick=x3dom.Utils.initFBO(i,S,T,s._webgl.fboPick.type,!1,!0),s._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+S+", "+T+")")),n=0;n<p;n++)(o=m[n])._webgl&&o._webgl.fbo&&o._webgl.fbo.width==o._vf.dimensions[0]&&o._webgl.fbo.height==o._vf.dimensions[1]||(o.invalidateGLObject(),o._cleanupGLObjects?o._cleanupGLObjects():o._cleanupGLObjects=function(e){e||i.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&i.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&i.deleteRenderbuffer(this._webgl.fbo.rbo),i.bindFramebuffer(i.FRAMEBUFFER,null),i.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},x=o._cf.textureProperties.node,_=o.requirePingPong()?i.UNSIGNED_BYTE:v,o._webgl={},o._webgl.fbo=x3dom.Utils.initFBO(i,o._vf.dimensions[0],o._vf.dimensions[1],_,x&&x._vf.generateMipMaps,o._vf.depthMap||!o.requirePingPong()),o.requirePingPong()&&(c=o._vf.dimensions[0]+"x"+o._vf.dimensions[1],void 0===s._webgl.refinement[c]&&(s._webgl.refinement[c]=x3dom.Utils.initFBO(i,o._vf.dimensions[0],o._vf.dimensions[1],_,!1,!1)),o._webgl.texture=null),x3dom.debug.logInfo("Init/resize RenderedTexture_"+n+" to size "+o._vf.dimensions[0]+" x "+o._vf.dimensions[1]));for(l=(r=e.getShadowedLights()).length,d=0;d<l;d++)if(f=r[d]._vf.shadowMapSize,a=x3dom.isa(r[d],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(r[d]._vf.shadowCascades,6)),void 0===s._webgl.fboShadow[d]||s._webgl.fboShadow[d].length!=a||s._webgl.fboShadow[d][0].height!=f)for(s._webgl.fboShadow[d]=[],h=0;h<a;h++)s._webgl.fboShadow[d][h]=x3dom.Utils.initFBO(i,f,f,g,!1,!0);for(d=0;d<l;d++){for(f=s._webgl.fboShadow[d][0].height,u=!1,h=0;h<s._webgl.fboBlur.length;h++)f==s._webgl.fboBlur[h].height&&(u=!0);u||(s._webgl.fboBlur[s._webgl.fboBlur.length]=x3dom.Utils.initFBO(i,f,f,g,!1,!0))}((x3dom.SSAO.isEnabled(s)||s._webgl.fboShadow.length>0)&&void 0===s._webgl.fboScene||s._webgl.fboScene&&(this.canvas.width!=s._webgl.fboScene.width||this.canvas.height!=s._webgl.fboScene.height))&&(s._webgl.fboScene=x3dom.Utils.initFBO(i,this.canvas.width,this.canvas.height,g,!1,!0))}else{for(s._webgl={},this.setupFgnds(i,s),s._webgl.pickScale=.5,s._webgl._currFboWidth=Math.round(this.canvas.width*s._webgl.pickScale),s._webgl._currFboHeight=Math.round(this.canvas.height*s._webgl.pickScale),s._webgl.fboPick=x3dom.Utils.initFBO(i,s._webgl._currFboWidth,s._webgl._currFboHeight,i.UNSIGNED_BYTE,!1,!0),s._webgl.fboPick.pixelData=null,s._webgl.normalShader=this.cache.getShader(i,x3dom.shader.NORMAL),s._webgl.fboShadow=[],l=(r=e.getShadowedLights()).length,d=0;d<l;d++)for(f=r[d]._vf.shadowMapSize,a=x3dom.isa(r[d],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(r[d]._vf.shadowCascades,6)),s._webgl.fboShadow[d]=[],h=0;h<a;h++)s._webgl.fboShadow[d][h]=x3dom.Utils.initFBO(i,f,f,g,!1,!0);for((s._webgl.fboShadow.length>0||x3dom.SSAO.isEnabled(s))&&(s._webgl.fboScene=x3dom.Utils.initFBO(i,this.canvas.width,this.canvas.height,g,!1,!0)),s._webgl.fboBlur=[],d=0;d<l;d++){for(f=s._webgl.fboShadow[d][0].height,u=!1,h=0;h<s._webgl.fboBlur.length;h++)f==s._webgl.fboBlur[h].height&&(u=!0);u||(s._webgl.fboBlur[s._webgl.fboBlur.length]=x3dom.Utils.initFBO(i,f,f,g,!1,!0))}for(s._webgl.ppBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,s._webgl.ppBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(y),i.STATIC_DRAW),s._webgl.refinement={stamps:new Array(2),positionBuffer:i.createBuffer()},i.bindBuffer(i.ARRAY_BUFFER,s._webgl.refinement.positionBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(y),i.STATIC_DRAW),n=0;n<p;n++)x=(o=m[n])._cf.textureProperties.node,_=o.requirePingPong()?i.UNSIGNED_BYTE:v,o._webgl={},o._webgl.fbo=x3dom.Utils.initFBO(i,o._vf.dimensions[0],o._vf.dimensions[1],_,x&&x._vf.generateMipMaps,o._vf.depthMap||!o.requirePingPong()),o._cleanupGLObjects=function(e){e||i.deleteTexture(this._webgl.fbo.tex),this._webgl.fbo.dtex&&i.deleteTexture(this._webgl.fbo.dtex),this._webgl.fbo.rbo&&i.deleteFramebuffer(this._webgl.fbo.rbo),i.bindFramebuffer(i.FRAMEBUFFER,null),i.deleteFramebuffer(this._webgl.fbo.fbo),this._webgl.fbo.rbo=null,this._webgl.fbo.fbo=null},o.requirePingPong()&&(c=o._vf.dimensions[0]+"x"+o._vf.dimensions[1],void 0===s._webgl.refinement[c]&&(s._webgl.refinement[c]=x3dom.Utils.initFBO(i,o._vf.dimensions[0],o._vf.dimensions[1],_,!1,!1)),o._webgl.texture=null);e._last_mat_view=x3dom.fields.SFMatrix4f.identity(),e._last_mat_proj=x3dom.fields.SFMatrix4f.identity(),e._last_mat_scene=x3dom.fields.SFMatrix4f.identity(),this._calledViewpointChangedHandler=!1}var F=s.getEnvironment();F.checkSanity();var b=s.getBackground();this.setupScene(i,b),this.numFaces=0,this.numCoords=0,this.numDrawCalls=0;var C=e.getProjectionMatrix(),M=e.getViewMatrix();if(!this._calledViewpointChangedHandler||!e._last_mat_view.equals(M)){var E=s.getViewpoint(),w="viewpointChanged";try{if(E.hasEventListener(w)||s.hasEventListener(w)){var A=E.getCurrentTransform(),D=(A=A.inverse().mult(M)).inverse(),N=new x3dom.fields.Quaternion(0,0,1,0);N.setValue(D);var R=D.e3(),I={target:E._xmlNode,type:w,matrix:A,position:R,orientation:N.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};E.hasEventListener(w)&&E.callEvtHandler("on"+w,I),s.hasEventListener(w)&&s.callEvtHandler("on"+w,I),E.callEvtHandler("on"+w,I),this._calledViewpointChangedHandler=!0}}catch(e){x3dom.debug.logException(e)}}e._last_mat_view=M,e._last_mat_proj=C;var P=C.mult(M);if(e._last_mat_scene=P,s.drawableCollection=null,!s.drawableCollection){var V={viewArea:e,sortTrans:F._vf.sortTrans,viewMatrix:M,projMatrix:C,sceneMatrix:P,frustumCulling:!0,smallFeatureThreshold:F._smallFeatureThreshold,context:this,gl:i};s.drawableCollection=new x3dom.DrawableCollection(V),x3dom.Utils.startMeasure("traverse"),s.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),s.drawableCollection,!0,!1,0,[]);var O=x3dom.Utils.stopMeasure("traverse");this.x3dElem.runtime.addMeasurement("TRAVERSE",O)}x3dom.Utils.startMeasure("sorting"),s.drawableCollection.sort();var L=x3dom.Utils.stopMeasure("sorting");this.x3dElem.runtime.addMeasurement("SORT",L);var B,U=e.getLights(),G=U.length,X=[],k=[],z=0;x3dom.Utils.startMeasure("shadow");for(var H=e.getLightMatrix(U),j=0;j<G;j++)if(U[j]._vf.shadowIntensity>0){var W=H[j],Y=s._webgl.fboShadow[z],q=Math.max(0,Math.min(1,U[j]._vf.shadowOffset));if(x3dom.isa(U[j],x3dom.nodeTypes.PointLight))for(B=e.getWCtoLCMatricesPointLight(W,U[j],C),d=0;d<6;d++)this.renderShadowPass(i,e,B[d],M,Y[d],q,!1);else{var Q=Math.max(1,Math.min(U[j]._vf.shadowCascades,6));for(B=e.getWCtoLCMatricesCascaded(W,U[j],C),d=0;d<Q;d++)this.renderShadowPass(i,e,B[d],M,Y[d],q,!1)}z++,X[X.length]=B,k[k.length]=W}if(z>0||x3dom.SSAO.isEnabled(s)){this.renderShadowPass(i,e,P,M,s._webgl.fboScene,0,!0);var K=x3dom.Utils.stopMeasure("shadow");this.x3dElem.runtime.addMeasurement("SHADOW",K)}else this.x3dElem.runtime.removeMeasurement("SHADOW");for(B=e.getWCtoLCMatrix(e.getLightMatrix()[0]),n=0;n<p;n++)this.renderRTPass(i,e,m[n]);for(x3dom.Utils.startMeasure("render"),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),b._webgl.render(i,M,C,e),x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,l=s.drawableCollection.length,F._vf.smallFeatureCulling&&F._lowPriorityThreshold<1&&e.isMovingOrAnimating()&&!(l=Math.floor(l*F._lowPriorityThreshold))&&s.drawableCollection.length&&(l=1),this.stateManager.unsetProgram(),d=0;d<l;d++){var Z=s.drawableCollection.get(d);this.renderShape(Z,e,U,G,M,P,B,C,i)}if(z>0&&this.renderShadows(i,e,r,X,k,M,C,P),this.stateManager.disable(i.BLEND),this.stateManager.disable(i.DEPTH_TEST),e._numRenderedNodes=l,x3dom.SSAO.isEnabled(s)&&x3dom.SSAO.renderSSAO(this.stateManager,i,s,this.canvas),void 0!==e._visDbgBuf&&e._visDbgBuf){var J=s._vf.pickMode.toLowerCase();0!=J.indexOf("idbuf")&&"color"!=J&&"texcoord"!=J||(this.stateManager.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),s._fgnd._webgl.render(i,s._webgl.fboPick.tex)),(z>0||x3dom.SSAO.isEnabled(s))&&(this.stateManager.viewport(this.canvas.width/4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),s._fgnd._webgl.render(i,s._webgl.fboScene.tex));var $=3,ee=2;for(d=0;d<z;d++){Y=s._webgl.fboShadow[d];for(h=0;h<Y.length;h++)this.stateManager.viewport(ee*this.canvas.width/4,$*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),s._fgnd._webgl.render(i,Y[h].tex),ee<2?ee++:(ee=0,$--)}for(n=0;n<p;n++)(o=m[n])._webgl.fbo.fbo&&(this.stateManager.viewport(n*this.canvas.width/8,5*this.canvas.height/8,this.canvas.width/8,this.canvas.height/8),s._fgnd._webgl.render(i,o._webgl.fbo.tex))}i.finish();var te=x3dom.Utils.stopMeasure("render");this.x3dElem.runtime.addMeasurement("RENDER",te),this.x3dElem.runtime.addMeasurement("DRAW",l?te/l:0),this.x3dElem.runtime.addInfo("#NODES:",s.drawableCollection.numberOfNodes),this.x3dElem.runtime.addInfo("#SHAPES:",e._numRenderedNodes),this.x3dElem.runtime.addInfo("#DRAWS:",this.numDrawCalls),this.x3dElem.runtime.addInfo("#POINTS:",this.numCoords),this.x3dElem.runtime.addInfo("#TRIS:",this.numFaces)}},e.prototype.renderPingPongPass=function(e,t,i){var s=t._scene,o=i._vf.dimensions[0]+"x"+i._vf.dimensions[1],n=s._webgl.refinement[o];if(0!=i._currLoadLevel||s._webgl.refinement.stamps[0]&&s._webgl.refinement.stamps[1]||(s._webgl.refinement.stamps[0]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp0),!1,"anonymous",!1,!1),s._webgl.refinement.stamps[1]=this.cache.getTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(i._vf.stamp1),!1,"anonymous",!1,!1)),i._currLoadLevel<i._loadLevel){i._currLoadLevel++,i._webgl.texture&&e.deleteTexture(i._webgl.texture);var r=i._vf.url[0]+"/"+i._currLoadLevel+"."+i._vf.format;i._webgl.texture=x3dom.Utils.createTexture2D(e,i._nameSpace.doc,i._nameSpace.getURL(r),!1,"anonymous",!1,!1),i._vf.iterations%2==0?i._currLoadLevel%2!=0?i._repeat.x*=2:i._repeat.y*=2:i._currLoadLevel%2==0?i._repeat.x*=2:i._repeat.y*=2}if(i._webgl.texture.ready&&s._webgl.refinement.stamps[0].ready&&s._webgl.refinement.stamps[1].ready){this.stateManager.bindFramebuffer(e.FRAMEBUFFER,n.fbo),this.stateManager.viewport(0,0,n.width,n.height),this.stateManager.disable(e.BLEND),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var a=this.cache.getShader(e,x3dom.shader.TEXTURE_REFINEMENT);this.stateManager.useProgram(a),e.bindBuffer(e.ARRAY_BUFFER,s._webgl.refinement.positionBuffer),e.vertexAttribPointer(a.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(a.position),a.stamp=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,s._webgl.refinement.stamps[(i._currLoadLevel+1)%2]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),i._currLoadLevel>1&&(a.lastTex=1,e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)),a.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,i._webgl.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),a.mode=i._currLoadLevel-1,a.repeat=i._repeat.toGL(),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),a.mode=0,a.curTex=2,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,n.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(a.position),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height),i._vf.autoRefinement&&i.nextLevel(),i._currLoadLevel==i._vf.maxLevel&&i._currLoadLevel++,i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),i.requirePingPong()||(e.deleteTexture(i._webgl.texture),delete i._webgl.texture,i._cleanupGLObjects(!0)),i._renderedImage++}},e.prototype.renderRTPass=function(e,t,i){if(x3dom.isa(i,x3dom.nodeTypes.RefinementTexture))i.requirePingPong()&&this.renderPingPongPass(e,t,i);else{switch(i._vf.update.toUpperCase()){case"NONE":return;case"NEXT_FRAME_ONLY":if(!i._needRenderUpdate)return;i._needRenderUpdate=!1}var s,o,n=t._scene,r=null,a=i.getViewMatrix(),d=i.getProjectionMatrix(),h=d.mult(a),l=t.getLightMatrix()[0],f=t.getWCtoLCMatrix(l),u=i._cf.excludeNodes.nodes,_=u.length,c=new Array(_);for(s=0;s<_;s++){var m=u[s].renderFlag&&u[s].renderFlag();c[s]=void 0===m?-1:!0===m?1:0,i._cf.excludeNodes.nodes[s]._vf.visible=!1}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i._webgl.fbo.fbo),this.stateManager.viewport(0,0,i._webgl.fbo.width,i._webgl.fbo.height),null===i._cf.background.node?(e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)):i._cf.background.node===n.getBackground()?(r=n.getBackground())._webgl.render(e,a,d,t):(r=i._cf.background.node,this.setupScene(e,r),r._webgl.render(e,a,d,t)),this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE),this.stateManager.enable(e.BLEND);var p,x=t.getLights(),v=x.length,g=i._cf.scene.node;if(g&&g!==n){var y={viewArea:t,sortTrans:n.getEnvironment()._vf.sortTrans,viewMatrix:a,projMatrix:d,sceneMatrix:h,frustumCulling:!1,smallFeatureThreshold:1,context:this,gl:e};if(g.numberOfNodes=0,g.drawableCollection=new x3dom.DrawableCollection(y),g.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),g.drawableCollection,!0,!1,0,[]),g.drawableCollection.sort(),o=g.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,g,n._webgl.normalShader,a,h);else for(this.stateManager.unsetProgram(),s=0;s<o;s++)(p=g.drawableCollection.get(s)).shape.renderFlag()&&this.renderShape(p,t,x,v,a,h,f,d,e)}else if(o=n.drawableCollection.length,i._vf.showNormals)this.renderNormals(e,n,n._webgl.normalShader,a,h);else for(this.stateManager.unsetProgram(),s=0;s<o;s++)p=n.drawableCollection.get(s),this.renderShape(p,t,x,v,a,h,f,d,e);for(this.stateManager.disable(e.BLEND),this.stateManager.disable(e.DEPTH_TEST),e.flush(),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),i._webgl.fbo.mipMap&&(e.bindTexture(e.TEXTURE_2D,i._webgl.fbo.tex),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),s=0;s<_;s++)0!==c[s]&&(i._cf.excludeNodes.nodes[s]._vf.visible=!0)}},e.prototype.renderNormals=function(e,t,i,s,o){if(i&&t){this.stateManager.depthFunc(e.LEQUAL),this.stateManager.enable(e.DEPTH_TEST),this.stateManager.enable(e.CULL_FACE),this.stateManager.disable(e.BLEND),this.stateManager.useProgram(i);for(var n=x3dom.fields.SFVec3f.NullVector.toGL(),r=x3dom.fields.SFVec3f.OneVector.toGL(),a=0,d=t.drawableCollection.length;a<d;a++){var h=t.drawableCollection.get(a),l=h.transform,f=h.shape,u=f._webgl;if(u&&f&&f.renderFlag()){var _=f._cf.geometry.node,c=_._mesh,m=s.mult(l).inverse();i.normalMatrix=m.transpose().toGL(),i.modelViewProjectionMatrix=o.mult(l).toGL(),u.coordType!=e.FLOAT?(0!=u.popGeometry||4==c._numPosComponents&&x3dom.Utils.isUnsignedType(_._vf.coordType)?i.bgCenter=_.getMin().toGL():i.bgCenter=_._vf.position.toGL(),i.bgSize=_._vf.size.toGL(),i.bgPrecisionMax=_.getPrecisionMax("coordType")):(i.bgCenter=n,i.bgSize=r,i.bgPrecisionMax=1),u.normalType!=e.FLOAT?i.bgPrecisionNorMax=_.getPrecisionMax("normalType"):i.bgPrecisionNorMax=1,f.isSolid()?(this.stateManager.enable(e.CULL_FACE),f.isCCW()?this.stateManager.frontFace(e.CCW):this.stateManager.frontFace(e.CW)):this.stateManager.disable(e.CULL_FACE);for(var p=0,x=u.positions.length;p<x;p++){var v,g,y,S=6*p;if(void 0!==i.position&&u.buffers[S+x3dom.BUFFER_IDX.POSITION]&&u.indexes[p]){if(u.buffers[S+x3dom.BUFFER_IDX.INDEX]&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u.buffers[S+x3dom.BUFFER_IDX.INDEX]),this.setVertexAttribPointerPosition(e,f,S,p),this.setVertexAttribPointerNormal(e,f,S,p),u.binaryGeometry>0||u.popGeometry>0)for(v=0,y=0,g=_._vf.vertexCount.length;v<g;v++)this.drawElements(e,u.primType[v],_._vf.vertexCount[v],u.indexType,x3dom.Utils.getByteAwareOffset(y,u.indexType,e)),y+=_._vf.vertexCount[v];else if(u.binaryGeometry<0||u.popGeometry<0)for(v=0,y=0,g=_._vf.vertexCount.length;v<g;v++)this.drawArrays(e,u.primType[v],y,_._vf.vertexCount[v]),y+=_._vf.vertexCount[v];else if(indicesReady&&u.bufferGeometry>0)this.drawElements(e,u.primType[0],_._vf.vertexCount[0],u.indexType,f._indexOffset);else if(u.bufferGeometry<0)this.drawArrays(e,u.primType[0],0,_._vf.vertexCount[0]);else if(_.hasIndexOffset()){var T=f.tessellationProperties();for(v=0,g=T.length;v<g;v++)this.drawElements(e,u.primType,T[v].count,u.indexType,T[v].offset*x3dom.Utils.getOffsetMultiplier(u.indexType,e))}else 0==u.indexes[p].length?this.drawArrays(e,u.primType,0,u.positions[p].length/3):this.drawElements(e,u.primType,u.indexes[p].length,u.indexType,0);e.disableVertexAttribArray(i.position),void 0!==i.normal&&e.disableVertexAttribArray(i.normal)}}}}}},e.prototype.shutdown=function(e){var t=this.ctx3d,i=e._scene;if(null!=t&&i){var s=i.getBackground();s._webgl&&void 0!==s._webgl.position&&(t.deleteBuffer(s._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),t.deleteBuffer(s._webgl.buffers[x3dom.BUFFER_IDX.POSITION]));var o=i._fgnd;void 0!==o._webgl.position&&(t.deleteBuffer(o._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),t.deleteBuffer(o._webgl.buffers[x3dom.BUFFER_IDX.POSITION]));for(var n=i.drawableCollection?i.drawableCollection.length:0,r=0;r<n;r++){var a=i.drawableCollection.get(r).shape;a._cleanupGLObjects&&a._cleanupGLObjects(!0)}this.cache.Release(t)}},e.prototype.renderShadows=function(e,t,i,s,o,n,r,a){var d=t._scene,h=x3dom.caps.MAX_TEXTURE_IMAGE_UNITS;if(!(h<7)){var l,f,u,_,c,m=1,p=[0];for(u=0;u<i.length;u++){var x=i[u]._vf.shadowFilterSize;for(f=(l=d._webgl.fboShadow[u]).length,_=0;_<f;_++)this.blurTex(e,d,l[_],x);(m+=6)>h&&(p[p.length]=u,m=7)}p[p.length]=i.length;var v=p.length-1,g=r.inverse(),y=a.inverse();this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.DST_COLOR,e.ZERO);for(var S=0;S<v;S++){var T=p[S],F=p[S+1],b=[];for(c=T;c<F;c++)b[b.length]=i[c];var C,M,E=this.cache.getShadowRenderingShader(e,b);this.stateManager.useProgram(E),e.bindBuffer(e.ARRAY_BUFFER,d._webgl.ppBuffer),e.vertexAttribPointer(E.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(E.position),E.sceneMap=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,d._webgl.fboScene.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),E.inverseProj=g.toGL(),E.inverseViewProj=y.toGL();for(var w=0,A=0,D=b.length;A<D;A++){for(M=o[A+T],C=s[A+T],l=d._webgl.fboShadow[A+T],f=C.length,u=0;u<f;u++)e.activeTexture(e.TEXTURE1+w),e.bindTexture(e.TEXTURE_2D,l[u].tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),E["light"+A+"_"+u+"_ShadowMap"]=w+1,E["light"+A+"_"+u+"_Matrix"]=C[u].toGL(),w++;if(E["light"+A+"_ViewMatrix"]=M.toGL(),!x3dom.isa(b[A],x3dom.nodeTypes.PointLight))for(_=0;_<f;_++){var N=Math.max(1,Math.min(b[A]._vf.shadowCascades,6)),R=Math.max(0,Math.min(b[A]._vf.shadowSplitFactor,1)),I=Math.max(0,Math.min(b[A]._vf.shadowSplitOffset,1)),P=t.getShadowSplitDepths(N,R,I,!1,r);E["light"+A+"_"+_+"_Split"]=P[_+1]}var V=n.mult(b[A].getCurrentTransform());x3dom.isa(b[A],x3dom.nodeTypes.DirectionalLight)?(E["light"+A+"_Type"]=0,E["light"+A+"_On"]=b[A]._vf.on?1:0,E["light"+A+"_Direction"]=V.multMatrixVec(b[A]._vf.direction).toGL(),E["light"+A+"_Attenuation"]=[1,1,1],E["light"+A+"_Location"]=[1,1,1],E["light"+A+"_Radius"]=0,E["light"+A+"_BeamWidth"]=0,E["light"+A+"_CutOffAngle"]=0,E["light"+A+"_ShadowIntensity"]=b[A]._vf.shadowIntensity,E["light"+A+"_ShadowCascades"]=b[A]._vf.shadowCascades,E["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,b[A]._vf.shadowOffset))):x3dom.isa(b[A],x3dom.nodeTypes.PointLight)?(E["light"+A+"_Type"]=1,E["light"+A+"_On"]=b[A]._vf.on?1:0,E["light"+A+"_Direction"]=[1,1,1],E["light"+A+"_Attenuation"]=b[A]._vf.attenuation.toGL(),E["light"+A+"_Location"]=V.multMatrixPnt(b[A]._vf.location).toGL(),E["light"+A+"_Radius"]=b[A]._vf.radius,E["light"+A+"_BeamWidth"]=0,E["light"+A+"_CutOffAngle"]=0,E["light"+A+"_ShadowIntensity"]=b[A]._vf.shadowIntensity,E["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,b[A]._vf.shadowOffset))):x3dom.isa(b[A],x3dom.nodeTypes.SpotLight)&&(E["light"+A+"_Type"]=2,E["light"+A+"_On"]=b[A]._vf.on?1:0,E["light"+A+"_Direction"]=V.multMatrixVec(b[A]._vf.direction).toGL(),E["light"+A+"_Attenuation"]=b[A]._vf.attenuation.toGL(),E["light"+A+"_Location"]=V.multMatrixPnt(b[A]._vf.location).toGL(),E["light"+A+"_Radius"]=b[A]._vf.radius,E["light"+A+"_BeamWidth"]=b[A]._vf.beamWidth,E["light"+A+"_CutOffAngle"]=b[A]._vf.cutOffAngle,E["light"+A+"_ShadowIntensity"]=b[A]._vf.shadowIntensity,E["light"+A+"_ShadowCascades"]=b[A]._vf.shadowCascades,E["light"+A+"_ShadowOffset"]=Math.max(0,Math.min(1,b[A]._vf.shadowOffset)))}e.drawArrays(e.TRIANGLES,0,6);var O=w+1;for(c=0;c<O;c++)e.activeTexture(e.TEXTURE0+c),e.bindTexture(e.TEXTURE_2D,null);e.disableVertexAttribArray(E.position)}this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)}},e.prototype.blurTex=function(e,t,i,s){if(!(s<=0)){s=s<5?3:s<7?5:7;for(var o=i.width,n=i.height,r=null,a=0,d=t._webgl.fboBlur.length;a<d;a++)if(n==t._webgl.fboBlur[a].height){r=t._webgl.fboBlur[a];break}this.stateManager.bindFramebuffer(e.FRAMEBUFFER,r.fbo),this.stateManager.viewport(0,0,o,n),this.stateManager.enable(e.BLEND),this.stateManager.blendFunc(e.ONE,e.ZERO),this.stateManager.disable(e.CULL_FACE),this.stateManager.disable(e.DEPTH_TEST),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var h=this.cache.getShader(e,x3dom.shader.BLUR);this.stateManager.useProgram(h),e.bindBuffer(e.ARRAY_BUFFER,t._webgl.ppBuffer),e.vertexAttribPointer(h.position,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h.position),h.pixelSizeHor=1/o,h.pixelSizeVert=1/n,h.filterSize=s,h.horizontal=!0,h.texture=0,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,i.fbo),e.clearColor(1,1,1,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),h.horizontal=!1,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r.tex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.disableVertexAttribArray(h.position),e.flush(),this.stateManager.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.stateManager.bindFramebuffer(e.FRAMEBUFFER,null),this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height)}},e.prototype.drawElements=function(e,t,i,s,o,n){if(n=null==n?1:n,n*=this.VRMode,2==x3dom.caps.WEBGL_VERSION)e.drawElementsInstanced(t,i,s,o,n);else if(x3dom.caps.INSTANCED_ARRAYS){this.ctx3d.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(t,i,s,o,n)}else e.drawElements(t,i,s,o)},e.prototype.drawArrays=function(e,t,i,s,o){if(o=null==o?1:o,o*=this.VRMode,2==x3dom.caps.WEBGL_VERSION)e.drawArraysInstanced(t,i,s,o);else if(x3dom.caps.INSTANCED_ARRAYS){this.ctx3d.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(t,i,s,o)}else e.drawArrays(t,i,s)},e.prototype.setVertexAttribEyeIdx=function(e,t){if(2==x3dom.caps.WEBGL_VERSION&&null!=t.eyeIdx)this.eyeIdxBuffer?(e.bindBuffer(e.ARRAY_BUFFER,this.eyeIdxBuffer),e.vertexAttribPointer(t.eyeIdx,1,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.eyeIdx),e.vertexAttribDivisor(t.eyeIdx,1)):(this.eyeIdxBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.eyeIdxBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,1]),e.STATIC_DRAW),e.vertexAttribPointer(t.eyeIdx,1,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.eyeIdx),e.vertexAttribDivisor(t.eyeIdx,1));else if(x3dom.caps.INSTANCED_ARRAYS&&null!=t.eyeIdx){var i=this.ctx3d.getExtension("ANGLE_instanced_arrays");this.eyeIdxBuffer?(e.bindBuffer(e.ARRAY_BUFFER,this.eyeIdxBuffer),e.vertexAttribPointer(t.eyeIdx,1,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.eyeIdx),i.vertexAttribDivisorANGLE(t.eyeIdx,1)):(this.eyeIdxBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.eyeIdxBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,1]),e.STATIC_DRAW),e.vertexAttribPointer(t.eyeIdx,1,e.FLOAT,!1,0,0),e.enableVertexAttribArray(t.eyeIdx),i.vertexAttribDivisorANGLE(t.eyeIdx,1))}},e.prototype.disableVertexAttribEyeIdx=function(e,t){if(2==x3dom.caps.WEBGL_VERSION&&null!=t.eyeIdx)e.disableVertexAttribArray(t.eyeIdx),e.vertexAttribDivisor(t.eyeIdx,0);else if(x3dom.caps.INSTANCED_ARRAYS&&null!=t.eyeIdx){var i=this.ctx3d.getExtension("ANGLE_instanced_arrays");e.disableVertexAttribArray(t.eyeIdx),i.vertexAttribDivisorANGLE(t.eyeIdx,0)}},e.prototype.setVertexAttribPointerPosition=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.position&&t._webgl.buffers[i+x3dom.BUFFER_IDX.POSITION]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.POSITION]),e.vertexAttribPointer(o.position,n._mesh._numPosComponents,t._webgl.coordType,t._webgl.coordNormalized,t._coordStrideOffset[0],t._coordStrideOffset[1]),e.enableVertexAttribArray(o.position)}},e.prototype.setVertexAttribPointerNormal=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.normal&&t._webgl.buffers[i+x3dom.BUFFER_IDX.NORMAL]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.NORMAL]),e.vertexAttribPointer(o.normal,n._mesh._numNormComponents,t._webgl.normalType,t._webgl.normalNormalized,t._normalStrideOffset[0],t._normalStrideOffset[1]),e.enableVertexAttribArray(o.normal)}},e.prototype.setVertexAttribPointerTexCoord=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.texcoord&&t._webgl.buffers[i+x3dom.BUFFER_IDX.TEXCOORD]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.TEXCOORD]),e.vertexAttribPointer(o.texcoord,n._mesh._numTexComponents,t._webgl.texCoordType,t._webgl.texCoordNormalized,t._texCoordStrideOffset[0],t._texCoordStrideOffset[1]),e.enableVertexAttribArray(o.texcoord)}},e.prototype.setVertexAttribPointerTexCoord2=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.texcoord2&&t._webgl.buffers[i+x3dom.BUFFER_IDX.TEXCOORD_1]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.TEXCOORD_1]),e.vertexAttribPointer(o.texcoord2,n._mesh._numTex2Components,t._webgl.texCoord2Type,t._webgl.texCoord2Normalized,t._texCoord2StrideOffset[0],t._texCoord2StrideOffset[1]),e.enableVertexAttribArray(o.texcoord2)}},e.prototype.setVertexAttribPointerColor=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.color&&t._webgl.buffers[i+x3dom.BUFFER_IDX.COLOR]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.COLOR]),e.vertexAttribPointer(o.color,n._mesh._numColComponents,t._webgl.colorType,t._webgl.colorNormalized,t._colorStrideOffset[0],t._colorStrideOffset[1]),e.enableVertexAttribArray(o.color)}},e.prototype.setVertexAttribPointerTangent=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.tangent&&t._webgl.buffers[i+x3dom.BUFFER_IDX.TANGENT]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.TANGENT]),e.vertexAttribPointer(o.tangent,n._mesh._numTangentComponents,t._webgl.tangentType,t._webgl.tangentNormalized,t._tangentStrideOffset[0],t._tangentStrideOffset[1]),e.enableVertexAttribArray(o.tangent)}},e.prototype.setVertexAttribPointerBinormal=function(e,t,i,s){var o=t._webgl.shader;if(void 0!==o.binormal&&t._webgl.buffers[i+x3dom.BUFFER_IDX.BITANGENT]){var n=t._cf.geometry.node;e.bindBuffer(e.ARRAY_BUFFER,t._webgl.buffers[i+x3dom.BUFFER_IDX.BITANGENT]),e.vertexAttribPointer(o.binormal,n._mesh._numBinormalComponents,t._webgl.binormalType,t._webgl.binormalNormalized,t._binormalStrideOffset[0],t._binormalStrideOffset[1]),e.enableVertexAttribArray(o.binormal)}},e.prototype.setTonemappingOperator=function(e,t){switch(e._scene.getEnvironment()._vf.tonemapping){case"none":t.tonemappingOperator=0;break;case"reinhard":t.tonemappingOperator=1;break;case"uncharted":t.tonemappingOperator=2;break;case"filmic":t.tonemappingOperator=3;break;default:t.tonemappingOperator=0}},function(t,i){var s=["webgl2","webgl","experimental-webgl","moz-webgl","webkit-3d"],o=/mac|ip(hone|od|ad)/i.test(navigator.platform),n=/safari/i.test(navigator.userAgent),r=/trident\//i.test(navigator.userAgent);o&&s.splice(0,1);for(var a=null,d=i.getElementsByTagName("Environment"),h={alpha:!0,depth:!0,stencil:!0,antialias:!!!(d&&d[0]&&d[0].hasAttribute("SSAO")&&"true"===d[0].getAttribute("SSAO").toLowerCase()),premultipliedAlpha:!1,preserveDrawingBuffer:!0,failIfMajorPerformanceCaveat:!0},l=0;l<s.length;l++)try{if(x3dom.caps.RENDERMODE="HARDWARE ("+s[l]+")",(a=t.getContext(s[l],h))||(x3dom.caps.RENDERMODE="SOFTWARE",h.failIfMajorPerformanceCaveat=!1,a=t.getContext(s[l],h),h.failIfMajorPerformanceCaveat=!0),a){var f=new e(a,t,"webgl",i);try{x3dom.caps.VENDOR=a.getParameter(a.VENDOR),x3dom.caps.VERSION=a.getParameter(a.VERSION),x3dom.caps.WEBGL_VERSION=-1===x3dom.caps.VERSION.indexOf("WebGL 2.0")?1:2,x3dom.caps.RENDERER=a.getParameter(a.RENDERER),x3dom.caps.SHADING_LANGUAGE_VERSION=a.getParameter(a.SHADING_LANGUAGE_VERSION),x3dom.caps.RED_BITS=a.getParameter(a.RED_BITS),x3dom.caps.GREEN_BITS=a.getParameter(a.GREEN_BITS),x3dom.caps.BLUE_BITS=a.getParameter(a.BLUE_BITS),x3dom.caps.ALPHA_BITS=a.getParameter(a.ALPHA_BITS),x3dom.caps.DEPTH_BITS=a.getParameter(a.DEPTH_BITS),x3dom.caps.MAX_VERTEX_ATTRIBS=a.getParameter(a.MAX_VERTEX_ATTRIBS),x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_VARYING_VECTORS=a.getParameter(a.MAX_VARYING_VECTORS),x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_TEXTURE_SIZE=a.getParameter(a.MAX_TEXTURE_SIZE),x3dom.caps.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE),x3dom.caps.COMPRESSED_TEXTURE_FORMATS=a.getParameter(a.COMPRESSED_TEXTURE_FORMATS),x3dom.caps.MAX_RENDERBUFFER_SIZE=a.getParameter(a.MAX_RENDERBUFFER_SIZE),x3dom.caps.MAX_VIEWPORT_DIMS=a.getParameter(a.MAX_VIEWPORT_DIMS),x3dom.caps.ALIASED_LINE_WIDTH_RANGE=a.getParameter(a.ALIASED_LINE_WIDTH_RANGE),x3dom.caps.ALIASED_POINT_SIZE_RANGE=a.getParameter(a.ALIASED_POINT_SIZE_RANGE),x3dom.caps.SAMPLES=a.getParameter(a.SAMPLES),x3dom.caps.COMPRESSED_TEXTURE=a.getExtension("WEBGL_compressed_texture_s3tc"),x3dom.caps.INDEX_UINT=a.getExtension("OES_element_index_uint"),x3dom.caps.FP_TEXTURES=a.getExtension("OES_texture_float"),x3dom.caps.FPL_TEXTURES=a.getExtension("OES_texture_float_linear"),x3dom.caps.HFP_TEXTURES=a.getExtension("OES_texture_half_float"),x3dom.caps.COLOR_BUFFER_FLOAT=a.getExtension("WEBGL_color_buffer_float"),x3dom.caps.HFPL_TEXTURES=a.getExtension("OES_texture_half_float_linear"),x3dom.caps.STD_DERIVATIVES=a.getExtension("OES_standard_derivatives"),x3dom.caps.DRAW_BUFFERS=a.getExtension("WEBGL_draw_buffers"),x3dom.caps.DEPTH_TEXTURE=a.getExtension("WEBGL_depth_texture"),x3dom.caps.DEBUGRENDERINFO=a.getExtension("WEBGL_debug_renderer_info"),x3dom.caps.ANISOTROPIC=a.getExtension("EXT_texture_filter_anisotropic"),x3dom.caps.TEXTURE_LOD=a.getExtension("EXT_shader_texture_lod"),x3dom.caps.INSTANCED_ARRAYS=a.getExtension("ANGLE_instanced_arrays"),x3dom.caps.ANISOTROPIC&&(x3dom.caps.MAX_ANISOTROPY=a.getParameter(x3dom.caps.ANISOTROPIC.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),x3dom.caps.EXTENSIONS=a.getSupportedExtensions(),x3dom.Utils.isWebGL2Enabled()&&(x3dom.caps.DEPTH_TEXTURE=null,x3dom.caps.INDEX_UINT=!0),x3dom.caps.DEBUGRENDERINFO?(x3dom.caps.UNMASKED_RENDERER_WEBGL=a.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_RENDERER_WEBGL),x3dom.caps.UNMASKED_VENDOR_WEBGL=a.getParameter(x3dom.caps.DEBUGRENDERINFO.UNMASKED_VENDOR_WEBGL)):(x3dom.caps.UNMASKED_RENDERER_WEBGL="",x3dom.caps.UNMASKED_VENDOR_WEBGL="");var u=x3dom.caps.EXTENSIONS.toString().replace(/,/g,", ");x3dom.debug.logInfo(s[l]+" context found\nVendor: "+x3dom.caps.VENDOR+" "+x3dom.caps.UNMASKED_VENDOR_WEBGL+", Renderer: "+x3dom.caps.RENDERER+" "+x3dom.caps.UNMASKED_RENDERER_WEBGL+", Version: "+x3dom.caps.VERSION+", ShadingLangV.: "+x3dom.caps.SHADING_LANGUAGE_VERSION+", MSAA samples: "+x3dom.caps.SAMPLES+"\nExtensions: "+u),x3dom.caps.INDEX_UINT&&(x3dom.Utils.maxIndexableCoords=4294967295),o&&(x3dom.caps.HFP_TEXTURES=!1,x3dom.caps.FP_TEXTURES=!1),n&&(x3dom.caps.TEXTURE_LOD=!1),r&&(x3dom.caps.INSTANCED_ARRAYS=!1)}catch(e){x3dom.debug.logWarning("Your browser probably supports an older WebGL version."),f=null}return f}}catch(e){x3dom.debug.logWarning(e)}return null}}(),x3dom.SSAO={},x3dom.SSAO.isEnabled=function(e){return e.getEnvironment()._vf.SSAO},x3dom.SSAO.reinitializeShadersIfNecessary=function(e){void 0===x3dom.SSAO.shaderProgram&&(x3dom.SSAO.shaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOShader(e),"ssao")),void 0===x3dom.SSAO.blurShaderProgram&&(x3dom.SSAO.blurShaderProgram=x3dom.Utils.wrapProgram(e,new x3dom.shader.SSAOBlurShader(e),"ssao-blur"))},x3dom.SSAO.reinitializeRandomTextureIfNecessary=function(e,t){var i=t.getEnvironment()._vf.SSAOrandomTextureSize!=x3dom.SSAO.currentRandomTextureSize;if(void 0===x3dom.SSAO.randomTexture&&(x3dom.SSAO.randomTexture=e.createTexture()),void 0===x3dom.SSAO.randomTexture||i){e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.randomTexture);for(var s=x3dom.SSAO.currentRandomTextureSize=t.getEnvironment()._vf.SSAOrandomTextureSize,o=new ArrayBuffer(s*s*4),n=new Uint8Array(o),r=0;r<s*s;++r){var a=2*Math.random()-1,d=2*Math.random()-1,h=Math.sqrt(a*a+d*d+0);a/=h,d/=h,n[4*r]=.5*(a+1)*255,n[4*r+1]=.5*(d+1)*255,n[4*r+2]=127.5,n[4*r+3]=255}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,s,s,0,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null)}},x3dom.SSAO.reinitializeFBOIfNecessary=function(e,t){var i=x3dom.SSAO.currentFBOWidth!=t.width||x3dom.SSAO.currentFBOHeight!=t.height;if(void 0===x3dom.SSAO.fbo||i){x3dom.SSAO.currentFBOWidth=t.width,x3dom.SSAO.currentFBOHeight=t.height;var s=e.getParameter(e.FRAMEBUFFER_BINDING);void 0===x3dom.SSAO.fbo&&(x3dom.SSAO.fbo=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,x3dom.SSAO.fbo),void 0===x3dom.SSAO.fbotex&&(x3dom.SSAO.fbotex=e.createTexture()),e.bindTexture(e.TEXTURE_2D,x3dom.SSAO.fbotex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,x3dom.SSAO.currentFBOWidth,x3dom.SSAO.currentFBOHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,x3dom.SSAO.fbotex,0),e.bindFramebuffer(e.FRAMEBUFFER,s)}},x3dom.SSAO.render=function(e,t,i,s,o,n){var r=t.getParameter(t.FRAMEBUFFER_BINDING);null!=n&&t.bindFramebuffer(t.FRAMEBUFFER,n),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var a=x3dom.SSAO.shaderProgram;e.useProgram(a),a.depthTexture=0,a.randomTexture=1,a.radius=i.getEnvironment()._vf.SSAOradius,a.randomTextureTilingFactor=[o.width/x3dom.SSAO.currentRandomTextureSize,o.height/x3dom.SSAO.currentRandomTextureSize];var d=i.getViewpoint(),h=d.getNear(),l=d.getFar();a.nearPlane=h,a.farPlane=l,a.depthReconstructionConstantA=(l+h)/(h-l),a.depthReconstructionConstantB=2*l*h/(h-l),a.depthBufferEpsilon=1e-4*(l-h),a.samples=[.03800223814729654,.10441029119843426,-.04479934806797181,-.03800223814729654,-.10441029119843426,.04479934806797181,-.17023209847088397,.1428416910414532,.6154407640895228,.17023209847088397,-.1428416910414532,-.6154407640895228,-.288675134594813,-.16666666666666646,-.3774214123135722,.288675134594813,.16666666666666646,.3774214123135722,.07717696785196887,-.43769233467209245,-.5201284112706428,-.07717696785196887,.43769233467209245,.5201284112706428,.5471154183401156,-.09647120981496134,-.15886420745887797,-.5471154183401156,.09647120981496134,.15886420745887797,.3333333333333342,.5773502691896253,-.8012446019636266,-.3333333333333342,-.5773502691896253,.8012446019636266,-.49994591864508653,.5958123446480936,-.15385106176844343,.49994591864508653,-.5958123446480936,.15385106176844343,-.8352823295874743,-.3040179051783715,.7825440557226517,.8352823295874743,.3040179051783715,-.7825440557226517],a.tex||(a.tex=0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,x3dom.SSAO.randomTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),t.vertexAttribPointer(a.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(a.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(a.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=n&&t.bindFramebuffer(t.FRAMEBUFFER,r)},x3dom.SSAO.blur=function(e,t,i,s,o,n,r){var a=t.getParameter(t.FRAMEBUFFER_BINDING);null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,r),e.frontFace(t.CCW),e.disable(t.CULL_FACE),e.disable(t.DEPTH_TEST);var d=x3dom.SSAO.blurShaderProgram;e.useProgram(d),d.SSAOTexture=0,d.depthTexture=1,d.depthThreshold=i.getEnvironment()._vf.SSAOblurDepthTreshold;var h=i.getViewpoint(),l=h.getNear(),f=h.getFar();d.nearPlane=l,d.farPlane=f,d.depthReconstructionConstantA=(f+l)/(l-f),d.depthReconstructionConstantB=2*f*l/(l-f),d.pixelSize=[1/n.width,1/n.height],d.amount=i.getEnvironment()._vf.SSAOamount,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i._fgnd._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),t.bindBuffer(t.ARRAY_BUFFER,i._fgnd._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),t.vertexAttribPointer(d.position,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(d.position),t.drawElements(i._fgnd._webgl.primType,i._fgnd._webgl.indexes.length,t.UNSIGNED_SHORT,0),t.disableVertexAttribArray(d.position),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),null!=r&&t.bindFramebuffer(t.FRAMEBUFFER,a)},x3dom.SSAO.renderSSAO=function(e,t,i,s){this.reinitializeShadersIfNecessary(t),this.reinitializeRandomTextureIfNecessary(t,i),this.reinitializeFBOIfNecessary(t,s),e.viewport(0,0,s.width,s.height),this.render(e,t,i,i._webgl.fboScene.tex,s,x3dom.SSAO.fbo),t.enable(t.BLEND),t.blendFunc(t.DST_COLOR,t.ONE_MINUS_SRC_ALPHA),this.blur(e,t,i,x3dom.SSAO.fbotex,i._webgl.fboScene.tex,s,null),t.disable(t.BLEND)},x3dom.runtime={},x3dom.Runtime=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0,this.VRMode=!1,this.states={measurements:[],infos:[]}},x3dom.Runtime.prototype.addMeasurement=function(e,t){this.states.measurements[e]=t},x3dom.Runtime.prototype.removeMeasurement=function(e){this.states.measurements[e]&&delete this.states.measurements[e]},x3dom.Runtime.prototype.addInfo=function(e,t){this.states.infos[e]=t},x3dom.Runtime.prototype.removeInfo=function(e){delete this.states.infos[e]},x3dom.Runtime.prototype.initialize=function(e,t){this.doc=e,this.canvas=t,this.config={},this.isReady=!1,this.fps=0},x3dom.Runtime.prototype.noBackendFound=function(){x3dom.debug.logInfo("No backend found. Unable to render.")},x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")},x3dom.Runtime.prototype.enterFrame=function(){},x3dom.Runtime.prototype.exitFrame=function(){},x3dom.Runtime.prototype.triggerRedraw=function(){this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.getActiveBindable=function(e){var t,i,s,o,n;if(t=this.canvas.doc._bindableBag._stacks,o=[],!(n=x3dom.nodeTypesLC[e.toLowerCase()]))return x3dom.debug.logError('No node of type "'+e+'" found.'),null;for(i=0;i<t.length;i++)void 0!==(s=t[i].getActive())._xmlNode&&x3dom.isa(s,n)&&o.push(s);return o[0]?o[0]._xmlNode:null},x3dom.Runtime.prototype.nextView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.prevView=function(){var e=this.canvas.doc._scene.getViewpoint()._stack;e?e.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")},x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()},x3dom.Runtime.prototype.viewMatrix=function(){return this.canvas.doc._viewarea.getViewMatrix()},x3dom.Runtime.prototype.projectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()},x3dom.Runtime.prototype.getWorldToCameraCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getWCtoCCMatrix()},x3dom.Runtime.prototype.getCameraToWorldCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getCCtoWCMatrix()},x3dom.Runtime.prototype.getViewingRay=function(e,t){return this.canvas.doc._viewarea.calcViewRay(e,t)},x3dom.Runtime.prototype.shootRay=function(e,t){var i=this.canvas.doc,s=i._viewarea._pickingInfo;return i.onPick(this.canvas.gl,e,t),{pickPosition:s.pickObj?s.pickPos:null,pickNormal:s.pickObj?s.pickNorm:null,pickObject:s.pickObj?s.pickObj._xmlNode:null}},x3dom.Runtime.prototype.getWidth=function(){return this.canvas.doc._viewarea._width},x3dom.Runtime.prototype.getHeight=function(){return this.canvas.doc._viewarea._height},x3dom.Runtime.prototype.mousePosition=function(e){var t=this.canvas.mousePosition(e);return[t.x,t.y]},x3dom.Runtime.prototype.calcCanvasPos=function(e,t,i){var s=window.devicePixelRatio||1,o=new x3dom.fields.SFVec3f(e,t,i),n=this.canvas.doc._viewarea.getWCtoCCMatrix().multFullMatrixPnt(o),r=this.canvas.doc._viewarea._width/s,a=this.canvas.doc._viewarea._height/s;return[Math.round((n.x+1)*(r-1)/2),Math.round((a-1)*(1-n.y)/2)]},x3dom.Runtime.prototype.calcPagePos=x3dom.Runtime.prototype.calcCanvasPos,x3dom.Runtime.prototype.getBBoxPoints=function(){var e=this.canvas.doc._scene;return e.updateVolume(),[{x:e._lastMin.x,y:e._lastMin.y,z:e._lastMin.z},{x:e._lastMax.x,y:e._lastMin.y,z:e._lastMin.z},{x:e._lastMin.x,y:e._lastMax.y,z:e._lastMin.z},{x:e._lastMax.x,y:e._lastMax.y,z:e._lastMin.z},{x:e._lastMin.x,y:e._lastMin.y,z:e._lastMax.z},{x:e._lastMax.x,y:e._lastMin.y,z:e._lastMax.z},{x:e._lastMin.x,y:e._lastMax.y,z:e._lastMax.z},{x:e._lastMax.x,y:e._lastMax.y,z:e._lastMax.z}]},x3dom.Runtime.prototype.getSceneBRect=function(){for(var e={x:Number.MAX_VALUE,y:Number.MAX_VALUE},t={x:Number.MIN_VALUE,y:Number.MIN_VALUE},i=this.getBBoxPoints(),s=0;s<i.length;s++){var o=this.calcCanvasPos(i[s].x,i[s].y,i[s].z);e.x=o[0]<e.x?o[0]:e.x,e.y=o[1]<e.y?o[1]:e.y,t.x=o[0]>t.x?o[0]:t.x,t.y=o[1]>t.y?o[1]:t.y}return{x:e.x,y:e.y,width:t.x-e.x,height:t.y-e.y}},x3dom.Runtime.prototype.calcClientPos=function(e,t,i){var s=this.canvas.canvas.offsetParent;if(!s)return x3dom.debug.logError("Can't calc client pos without offsetParent."),[0,0];var o=s.getBoundingClientRect(),n=this.calcCanvasPos(e,t,i),r=document.defaultView.getComputedStyle(s,null),a=parseFloat(r.getPropertyValue("padding-left")),d=parseFloat(r.getPropertyValue("border-left-width")),h=parseFloat(r.getPropertyValue("padding-top")),l=parseFloat(r.getPropertyValue("border-top-width"));return[o.left+a+d+n[0],o.top+h+l+n[1]]},x3dom.Runtime.prototype.getScreenshot=function(){var e="",t=this.canvas.backend,i=this.canvas.canvas;if(i)if("flash"==t)e=i.getScreenshot();else{var s=document.createElement("canvas");s.width=i.width,s.height=i.height;var o=s.getContext("2d");o.drawImage(i,0,0,i.width,i.height),o.scale(1,-1),o.translate(0,-i.height),e=s.toDataURL()}return e},x3dom.Runtime.prototype.getCanvas=function(){return this.canvas.canvas},x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()},x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()},x3dom.Runtime.prototype.lightView=function(){return this.canvas.doc._nodeBag.lights.length>0?(this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0):(x3dom.debug.logInfo("No lights to navigate to."),!1)},x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()},x3dom.Runtime.prototype.fitAll=function(e){void 0===e&&(e=!0);var t=this.canvas.doc._scene;t.updateVolume(),this.canvas.doc._viewarea.fit(t._lastMin,t._lastMax,e)},x3dom.Runtime.prototype.fitObject=function(e,t){if(e&&e._x3domNode){void 0===t&&(t=!0);var i=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN();e._x3domNode.getVolume().getBounds(i,s);var o=e._x3domNode.getCurrentTransform();if(i=o.multMatrixPnt(i),s=o.multMatrixPnt(s),x3dom.isa(e._x3domNode,x3dom.nodeTypes.X3DTransformNode)){var n=e._x3domNode._trafo.inverse();i=n.multMatrixPnt(i),s=n.multMatrixPnt(s)}this.canvas.doc._viewarea.fit(i,s,t)}},x3dom.Runtime.prototype.showAll=function(e,t){this.canvas.doc._viewarea.showAll(e,t)},x3dom.Runtime.prototype.showObject=function(e,t){if(e&&e._x3domNode){void 0===t&&(t="negZ");var i=x3dom.fields.SFVec3f.MAX(),s=x3dom.fields.SFVec3f.MIN();e._x3domNode.getVolume().getBounds(i,s);var o=e._x3domNode.getCurrentTransform();i=o.multMatrixPnt(i),s=o.multMatrixPnt(s);var n,r=this.canvas.doc._viewarea,a=r._width<r._height?r._width:r._height;switch(t){case"posX":n=new x3dom.fields.SFVec3f(1,0,0);break;case"negX":n=new x3dom.fields.SFVec3f(-1,0,0);break;case"posY":n=new x3dom.fields.SFVec3f(0,1,0);break;case"negY":n=new x3dom.fields.SFVec3f(0,-1,0);break;case"posZ":n=new x3dom.fields.SFVec3f(0,0,1);break;case"negZ":n=new x3dom.fields.SFVec3f(0,0,-1)}var d=this.canvas.doc._scene.getViewpoint(),h=d.getFieldOfView()/2,l=Math.tan(h);Math.abs(l)>x3dom.fields.Eps&&(a/=l);var f=r._width-1,u=r._height-1,_=.25,c=new x3dom.fields.SFVec2f(_*f,_*u);_=.75;var m=new x3dom.fields.SFVec2f(_*f,_*u),p=s.subtract(i).multiply(.5),x=p.length(),v=i.add(p),g=m.subtract(c).multiply(.5),y=1.5*g.length();g=g.add(c);var S=1;y>x3dom.fields.Eps&&(S=x/y*Math.sqrt(g.x*g.x+g.y*g.y+a*a)),n=(n=o.multMatrixVec(n).normalize()).multiply(S);var T=v.add(n),F=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,1),n).toMatrix(),b=x3dom.fields.SFMatrix4f.translation(T.negate()),C=x3dom.fields.SFMatrix4f.translation(T),M=(C=C.mult(F).mult(b).mult(C)).inverse();r.animateTo(M,d)}},x3dom.Runtime.prototype.animateViewpointTo=function(e,t){var i=this.canvas.doc._viewarea,s=this.canvas.doc._scene.getViewpoint();null!=e._x3domNode&&(e=e._x3domNode),i.animateTo(e,s,t)},x3dom.Runtime.prototype.getCenter=function(e){return e&&e._x3domNode&&(this.isA(e,"X3DShapeNode")||this.isA(e,"X3DGeometryNode"))?e._x3domNode.getCenter():null},x3dom.Runtime.prototype.getCurrentTransform=function(e){return e&&e._x3domNode?e._x3domNode.getCurrentTransform():null},x3dom.Runtime.prototype.getBBox=function(e){if(e&&e._x3domNode&&this.isA(e,"X3DBoundedObject")){var t=e._x3domNode.getVolume();return{min:x3dom.fields.SFVec3f.copy(t.min),max:x3dom.fields.SFVec3f.copy(t.max)}}return null},x3dom.Runtime.prototype.getSceneBBox=function(){var e=this.canvas.doc._scene;return e.updateVolume(),{min:x3dom.fields.SFVec3f.copy(e._lastMin),max:x3dom.fields.SFVec3f.copy(e._lastMax)}},x3dom.Runtime.prototype.debug=function(e){var t=this.canvas.doc;return void 0===t._viewarea._visDbgBuf&&(t._viewarea._visDbgBuf="true"===t._x3dElem.getAttribute("showLog")),arguments.length>0?!0===e?(t._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block"):(t._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none"):(t._viewarea._visDbgBuf=!t._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==t._viewarea._visDbgBuf?"block":"none"),t.needRender=!0,t._viewarea._visDbgBuf},x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()},x3dom.Runtime.prototype.noNav=function(){this.canvas.doc._scene.getNavigationInfo().setType("none")},x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")},x3dom.Runtime.prototype.turnTable=function(){this.canvas.doc._scene.getNavigationInfo().setType("turntable")},x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")},x3dom.Runtime.prototype.freeFly=function(){this.canvas.doc._scene.getNavigationInfo().setType("freefly")},x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")},x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")},x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")},x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")},x3dom.Runtime.prototype.helicopter=function(){this.canvas.doc._scene.getNavigationInfo().setType("helicopter")},x3dom.Runtime.prototype.resetExamin=function(){var e=this.canvas.doc._viewarea;e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0),e._needNavigationMatrixUpdate=!0,this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.disableKeys=function(){this.canvas.disableKeys=!0},x3dom.Runtime.prototype.enableKeys=function(){this.canvas.disableKeys=!1},x3dom.Runtime.prototype.disableLeftDrag=function(){this.canvas.disableLeftDrag=!0},x3dom.Runtime.prototype.enableLeftDrag=function(){this.canvas.disableLeftDrag=!1},x3dom.Runtime.prototype.disableRightDrag=function(){this.canvas.disableRightDrag=!0},x3dom.Runtime.prototype.enableRightDrag=function(){this.canvas.disableRightDrag=!1},x3dom.Runtime.prototype.disableMiddleDrag=function(){this.canvas.disableMiddleDrag=!0},x3dom.Runtime.prototype.enableMiddleDrag=function(){this.canvas.disableMiddleDrag=!1},x3dom.Runtime.prototype.togglePoints=function(e){var t=this.canvas.doc,i=!0===e?3:2;return t._viewarea._points=++t._viewarea._points%i,t.needRender=!0,t._viewarea._points},x3dom.Runtime.prototype.pickRect=function(e,t,i,s){return this.canvas.doc.onPickRect(this.canvas.gl,e,t,i,s)},x3dom.Runtime.prototype.pickMode=function(e){return e&&!0===e.internal?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()},x3dom.Runtime.prototype.changePickMode=function(e){switch(e=e.toLowerCase()){case"idbuf":e="idBuf";break;case"idbuf24":e="idBuf24";break;case"idbufid":e="idBufId";break;case"texcoord":e="texCoord";break;case"color":e="color";break;case"box":e="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+e+" unknown intersect type"),e=void 0}return void 0!==e&&(this.canvas.doc._scene._vf.pickMode=e,x3dom.debug.logInfo("Switched pickMode to '"+e+"'."),!0)},x3dom.Runtime.prototype.speed=function(e){var t=this.canvas.doc._scene.getNavigationInfo();return e&&(t._vf.speed=e,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed)),t._vf.speed},x3dom.Runtime.prototype.zoom=function(e){this.canvas.doc._viewarea.zoom(e),this.canvas.doc.needRender=!0},x3dom.Runtime.prototype.statistics=function(e){var t=this.canvas.stateViewer;return!!t&&(this.canvas.doc.needRender=!0,!0===e?(t.display(e),!0):!1===e?(t.display(e),!1):(t.display(!t.active),t.active))},x3dom.Runtime.prototype.processIndicator=function(e){var t=this.canvas.progressDiv;return!!t&&(!0===e?(t.style.display="flex",!0):!1===e?(t.style.display="none",!1):"none"!=t.style.display)},x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties},x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend},x3dom.Runtime.prototype.getFPS=function(){return this.fps},x3dom.Runtime.prototype.isA=function(e,t){var i=!1;return t&&e&&e._x3domNode&&(""===t&&(t="X3DNode"),i=x3dom.isa(e._x3domNode,x3dom.nodeTypesLC[t.toLowerCase()])),i},x3dom.Runtime.prototype.getPixelScale=function(){var e=this.viewpoint();if(!x3dom.isa(e,x3dom.nodeTypes.OrthoViewpoint))return x3dom.debug.logError("getPixelScale is only implemented for orthographic Viewpoints"),null;var t=e.getZoom(),i=t[0],s=t[1],o=t[2],n=t[3]-s,r=(o-i)/this.getWidth(),a=n/this.getHeight();return new x3dom.fields.SFVec3f(r,a,0)},x3dom.Runtime.prototype.onAnimationStarted=function(){},x3dom.Runtime.prototype.onAnimationFinished=function(){},x3dom.Runtime.prototype.enterVR=function(){this.canvas.vrDisplay&&!this.canvas.vrDisplay.isPresenting&&this.canvas.vrDisplay.requestPresent([{source:this.canvas.canvas}]).then(function(){this.canvas.doc.needRender=!0}.bind(this))},x3dom.Runtime.prototype.exitVR=function(){this.canvas.vrDisplay&&this.canvas.vrDisplay.isPresenting&&this.canvas.vrDisplay.exitPresent()},x3dom.Runtime.prototype.toggleVR=function(){this.canvas.vrDisplay&&!this.canvas.vrDisplay.isPresenting?this.enterVR():this.canvas.vrDisplay&&this.canvas.vrDisplay.isPresenting&&this.exitVR()},x3dom.Runtime.prototype.toggleProjection=function(e,t){var i,s=document.getElementById("x3d").runtime.canvas.doc._scene.getNavigationInfo(),o=s._vf.transitionTime,n=document.getElementById(e)._x3domNode,r=document.getElementById(t)._x3domNode;if(s._vf.transitionTime=0,r._bindAnimation=!1,n._bindAnimation=!1,n._vf.isActive)r._viewMatrix=n._viewMatrix,document.getElementById(t).setAttribute("set_bind","true"),i=n._viewMatrix.e3().length()/2.2,r.setZoom(i);else if(r._vf.isActive){n._viewMatrix=r._viewMatrix,document.getElementById(e).setAttribute("set_bind","true"),i=-2.2*r._fieldOfView[2];var a=r._viewMatrix.e2().normalize().multiply(i);n._viewMatrix.setTranslate(a)}return s._vf.transitionTime=o,r._bindAnimation=!0,n._bindAnimation=!0,n._vf.isActive?0:1},x3dom.Runtime.prototype.replaceWorld=function(e){for(var t,i,s=this.doc.cloneNode(!1);t=e.firstChild;)"HEAD"==(i=1===t.nodeType?t.localName.toUpperCase():null)||"SCENE"==i?s.appendChild(t):t.remove();this.doc.parentNode.replaceChild(s,this.doc),this.doc=s,x3dom.reload()},x3dom.Runtime.prototype.createX3DFromJS=function(e,t){return t&&(e=x3dom.protoExpander.prototypeExpander(t,e)),(new x3dom.JSONParser).parseJavaScript(e)},x3dom.Runtime.prototype.createX3DFromString=function(e,t){try{var i=JSON.parse(e);return this.createX3DFromJS(i,t)}catch(t){var s=new DOMParser,o=s.parseFromString(e,"application/xml"),n=o.querySelector("X3D");return null==n&&(n=(o=s.parseFromString(e,"text/html")).querySelector("X3D")),n}},x3dom.Runtime.prototype.createX3DFromURLPromise=function(e,t){this.canvas.doc.incrementDownloads();var i=this;return fetch(e).then((function(e){return e.text()})).then((function(e){return i.canvas.doc.decrementDownloads(),i.createX3DFromString(e,t)})).catch((function(e){return i.canvas.doc.decrementDownloads(),x3dom.debug.logError("fetch failed: "+e),null}))},x3dom.Runtime.prototype.loadURL=function(e,t){var i=this;this.createX3DFromURLPromise(e,t).then((function(t){null!=t?i.replaceWorld(t):x3dom.debug.logError("loadURL: could not fetch or parse "+e)}))},x3dom.userAgentFeature={supportsDOMAttrModified:!1},function(){"use strict";var e=function(){var e,t,i,s=document.getElementsByTagName("X3D"),o=[];for(e=0;e<s.length;e++)void 0===s[e].hasRuntime&&o.push(s[e]);var n,r,a,d,h,l,f,u=new x3dom.Properties,_=array_to_object(["showLog","showStat","showProgress","PrimitiveQuality","components","loadpath","disableDoubleClick","backend","altImg","runtimeEnabled","disableKeys","showTouchpoints","disableTouch","maxActiveDownloads","useGeoCache"]),c=!1;for(e=0;e<o.length;e++){for(u.setProperty("showLog",o[e].getAttribute("showLog")||"false"),u.setProperty("showStat",o[e].getAttribute("showStat")||"false"),u.setProperty("showProgress",o[e].getAttribute("showProgress")||"true"),u.setProperty("PrimitiveQuality",o[e].getAttribute("PrimitiveQuality")||"High"),u.setProperty("useGeoCache",o[e].getAttribute("useGeoCache")||"true"),i=o[e].getElementsByTagName("PARAM"),t=0;t<i.length;t++)i[t].getAttribute("name")in _&&u.setProperty(i[t].getAttribute("name"),i[t].getAttribute("value"));"true"===u.getProperty("showLog")&&(c=!0)}for(1==c?x3dom.debug.activate(!0):x3dom.debug.activate(!1),o=o.map((function(e){return e.hasRuntime=!0,e})),void 0!==x3dom.about&&x3dom.debug.logInfo("X3DOM "+x3dom.about.version+", Build: "+x3dom.about.build+", Revison: <a href='https://github.com/x3dom/x3dom/tree/"+x3dom.about.revision+"'>"+x3dom.about.revision+"</a>, Date: "+x3dom.about.date),x3dom.debug.logInfo("Found "+o.length+" X3D and nodes..."),e=0;e<o.length;e++)n=o[e],r=new x3dom.X3DCanvas(n,x3dom.canvases.length),x3dom.canvases.push(r),null!==r.gl?(l=(new Date).getTime(),o[e].runtime=new x3dom.Runtime(o[e],r),o[e].runtime.initialize(o[e],r),x3dom.runtime.ready&&(o[e].runtime.ready=x3dom.runtime.ready),""==r.backend&&x3dom.runtime.noBackendFound(),r.load(o[e],e,u),"true"===u.getProperty("showStat")?o[e].runtime.statistics(!0):o[e].runtime.statistics(!1),"true"===u.getProperty("showProgress")?("bar"===u.getProperty("showProgress")&&r.progressDiv.setAttribute("class","x3dom-progress bar"),o[e].runtime.processIndicator(!0)):o[e].runtime.processIndicator(!1),f=(new Date).getTime()-l,x3dom.debug.logInfo("Time for setup and init of GL element no. "+e+": "+f+" ms.")):((a=document.createElement("div")).setAttribute("class","x3dom-nox3d"),a.setAttribute("id","x3dom-nox3d"),(d=document.createElement("p")).appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),(h=document.createElement("a")).setAttribute("href","http://www.x3dom.org/?page_id=9"),h.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),a.appendChild(d),a.appendChild(h),r.x3dElem.appendChild(a),r.stateViewer&&n.removeChild(r.stateViewer.viewer));var m;m=null,document.createEvent?((m=document.createEvent("Events")).initEvent("load",!0,!0),document.dispatchEvent(m)):document.createEventObject&&(m=document.createEventObject(),document.body.fireEvent("onload",m))},t=function(){if(x3dom.canvases&&x3dom.canvases.length>0&&x3dom.canvases[0].doc){for(var e=0;e<x3dom.canvases.length;e++)x3dom.canvases[e].doc.shutdown(x3dom.canvases[e].gl);x3dom.canvases=[]}};x3dom.reload=function(){e()},window.addEventListener?(window.addEventListener("load",e,!1),window.addEventListener("unload",t,!1),window.addEventListener("reload",t,!1)):window.attachEvent&&(window.attachEvent("onload",e),window.attachEvent("onunload",t),window.attachEvent("onreload",t)),"complete"===document.readyState&&window.setTimeout((function(){e()}),20)}(),x3dom.Cache=function(){this.textures=[],this.shaders=[]},x3dom.Cache.prototype.getTexture2D=function(e,t,i,s,o,n,r,a,d){var h=i;return void 0===this.textures[h]&&(this.textures[h]=x3dom.Utils.createTexture2D(e,t,i,s,o,n,r,a,d)),this.textures[h]},x3dom.Cache.prototype.getTexture2DByDEF=function(e,t,i){var s=t.name+"_"+i;return void 0===this.textures[s]&&(this.textures[s]=e.createTexture()),this.textures[s]},x3dom.Cache.prototype.getTextureCube=function(e,t,i,s,o,n,r,a){for(var d="",h=0;h<i.length;++h)d+=i[h]+"|";return void 0===this.textures[d]&&(this.textures[d]=x3dom.Utils.createTextureCube(e,t,i,s,o,n,r,a)),this.textures[d]},x3dom.Cache.prototype.getShader=function(e,t){var i=null;if(void 0===this.shaders[t]){switch(t){case x3dom.shader.PICKING:i=new x3dom.shader.PickingShader(e);break;case x3dom.shader.PICKING_24:i=new x3dom.shader.Picking24Shader(e);break;case x3dom.shader.PICKING_ID:i=new x3dom.shader.PickingIdShader(e);break;case x3dom.shader.PICKING_COLOR:i=new x3dom.shader.PickingColorShader(e);break;case x3dom.shader.PICKING_TEXCOORD:i=new x3dom.shader.PickingTexcoordShader(e);break;case x3dom.shader.FRONTGROUND_TEXTURE:i=new x3dom.shader.FrontgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_TEXTURE:i=new x3dom.shader.BackgroundTextureShader(e);break;case x3dom.shader.BACKGROUND_SKYTEXTURE:i=new x3dom.shader.BackgroundSkyTextureShader(e);break;case x3dom.shader.BACKGROUND_CUBETEXTURE:i=new x3dom.shader.BackgroundCubeTextureShader(e);break;case x3dom.shader.BACKGROUND_CUBETEXTURE_DDS:i=new x3dom.shader.BackgroundCubeTextureDDSShader(e);break;case x3dom.shader.SHADOW:i=new x3dom.shader.ShadowShader(e);break;case x3dom.shader.BLUR:i=new x3dom.shader.BlurShader(e);break;case x3dom.shader.DEPTH:break;case x3dom.shader.NORMAL:i=new x3dom.shader.NormalShader(e);break;case x3dom.shader.TEXTURE_REFINEMENT:i=new x3dom.shader.TextureRefinementShader(e)}i?this.shaders[t]=x3dom.Utils.wrapProgram(e,i,t):x3dom.debug.logError("Couldn't create shader: "+t)}return this.shaders[t]},x3dom.Cache.prototype.getDynamicShader=function(e,t,i){var s=x3dom.Utils.generateProperties(t,i),o=s.id;if(void 0===this.shaders[o]){var n=null;n=-1!=s.CSHADER?new x3dom.shader.ComposedShader(e,i):new x3dom.shader.DynamicShader(e,s),this.shaders[o]=x3dom.Utils.wrapProgram(e,n,o)}return this.shaders[o]},x3dom.Cache.prototype.getShaderByProperties=function(e,t,i,s,o){var n=i.id;if(null!=s&&(n+=s),null!=o&&(n+="S"),void 0===this.shaders[n]){var r=null;if(null!=s)r=new x3dom.shader.DynamicShaderPicking(e,i,s);else if(null!=o)r=new x3dom.shader.DynamicShadowShader(e,i);else if(-1!=i.CSHADER)r=new x3dom.shader.ComposedShader(e,t);else if(null!=i.KHR_MATERIAL_COMMONS&&0!=i.KHR_MATERIAL_COMMONS)r=new x3dom.shader.KHRMaterialCommonsShader(e,i);else{if(null!=i.EMPTY_SHADER&&0!=i.EMPTY_SHADER)return{shaderID:n};r=new x3dom.shader.DynamicShader(e,i)}this.shaders[n]=x3dom.Utils.wrapProgram(e,r,n)}return this.shaders[n]},x3dom.Cache.prototype.getShadowRenderingShader=function(e,t){for(var i="shadow",s=0;s<t.length;s++)x3dom.isa(t[s],x3dom.nodeTypes.SpotLight)?i+="S":x3dom.isa(t[s],x3dom.nodeTypes.PointLight)?i+="P":i+="D";if(void 0===this.shaders[i]){var o=new x3dom.shader.ShadowRenderingShader(e,t);this.shaders[i]=x3dom.Utils.wrapProgram(e,o,i)}return this.shaders[i]},x3dom.Cache.prototype.Release=function(e){for(var t in this.textures)e.deleteTexture(this.textures[t]);for(var i in this.textures=[],this.shaders){for(var s=this.shaders[i],o=e.getAttachedShaders(s.program),n=0;n<o.length;++n)e.detachShader(s.program,o[n]),e.deleteShader(o[n]);e.deleteProgram(s.program)}this.shaders=[]},x3dom.Texture=function(e,t,i,s){this.gl=e,this.doc=t,this.cache=i,this.node=s,this.samplerName="diffuseMap",this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR,this.wrapS=e.REPEAT,this.wrapT=e.REPEAT,this.genMipMaps=!1,this.texture=null,this.ready=!1,this.anisotropicDegree=1,this.dashtexture=!1;var o=this.node;if(this.node._x3domTexture=this,x3dom.isa(o,x3dom.nodeTypes.MovieTexture)&&-1!==o._vf.url[0].indexOf("mpd",o._vf.url[0].length-"mpd".length)){this.dashtexture=!0;var n=document.getElementById("AdditionalDashVideoScript");n||((n=document.createElement("script")).setAttribute("type","text/javascript"),n.setAttribute("src",x3dom.Texture.dashVideoScriptFile),n.setAttribute("id","AdditionalDashVideoScript"),n.onload=function(){for(var e;e=x3dom.Texture.loadDashVideos.pop();)x3dom.Texture.textNum++,e.update();n.ready=!0},document.getElementsByTagName("head")[0].appendChild(n)),!0===n.ready?(x3dom.Texture.textNum++,this.update()):x3dom.Texture.loadDashVideos.push(this)}this.dashtexture||this.update()},x3dom.Texture.dashVideoScriptFile="dash.all.js",x3dom.Texture.loadDashVideos=[],x3dom.Texture.textNum=0,x3dom.Texture.clampFontSize=!1,x3dom.Texture.minFontQuality=.5,x3dom.Texture.maxFontQuality=10,x3dom.Texture.prototype.update=function(){x3dom.isa(this.node,x3dom.nodeTypes.Text)?this.updateText():this.updateTexture(),this.node.validateGLObject()},x3dom.Texture.prototype.setPixel=function(e,t,i,s){var o=this.gl,n=new Uint8Array(i);o.bindTexture(this.type,this.texture),o.pixelStorei(o.UNPACK_ALIGNMENT,1),o.texSubImage2D(this.type,0,e,t,1,1,this.format,o.UNSIGNED_BYTE,n),o.bindTexture(this.type,null),s&&(this.doc.needRender=!0)},x3dom.Texture.prototype.updateTexture=function(){var e=this.gl,t=this.doc,i=this.node;if(this.samplerName=i._type,x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.type=e.TEXTURE_CUBE_MAP:this.type=e.TEXTURE_2D,x3dom.isa(i,x3dom.nodeTypes.PixelTexture))switch(i._vf.image.comp){case 1:this.format=e.LUMINANCE;break;case 2:this.format=e.LUMINANCE_ALPHA;break;case 3:this.format=e.RGB;break;case 4:this.format=e.RGBA}else this.format=e.RGBA;if(null!==i._cf.textureProperties.node){var s=i._cf.textureProperties.node;this.wrapS=x3dom.Utils.boundaryModesDic(e,s._vf.boundaryModeS),this.wrapT=x3dom.Utils.boundaryModesDic(e,s._vf.boundaryModeT),this.minFilter=x3dom.Utils.minFilterDic(e,s._vf.minificationFilter),this.magFilter=x3dom.Utils.magFilterDic(e,s._vf.magnificationFilter),this.anisotropicDegree=Math.min(Math.max(s._vf.anisotropicDegree,1),x3dom.caps.MAX_ANISOTROPY),!0===s._vf.generateMipMaps?(this.genMipMaps=!0,this.minFilter==e.NEAREST?this.minFilter=e.NEAREST_MIPMAP_NEAREST:this.minFilter==e.LINEAR&&(this.minFilter=e.LINEAR_MIPMAP_LINEAR),this.texture&&(this.texture.ready||this.texture.textureCubeReady)&&(e.bindTexture(this.type,this.texture),e.generateMipmap(this.type),e.bindTexture(this.type,null))):(this.genMipMaps=!1,this.minFilter==e.LINEAR_MIPMAP_LINEAR||this.minFilter==e.LINEAR_MIPMAP_NEAREST?this.minFilter=e.LINEAR:this.minFilter!=e.NEAREST_MIPMAP_LINEAR&&this.minFilter!=e.NEAREST_MIPMAP_NEAREST||(this.minFilter=e.NEAREST))}else 0==i._vf.repeatS?this.wrapS=e.CLAMP_TO_EDGE:this.wrapS=e.REPEAT,0==i._vf.repeatT?this.wrapT=e.CLAMP_TO_EDGE:this.wrapT=e.REPEAT,"displacementMap"==this.samplerName&&(this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.minFilter=e.NEAREST,this.magFilter=e.NEAREST);var o=i._video&&!0===i._needPerFrameUpdate;if(i._isCanvas&&i._canvas)null==this.texture&&(this.texture=e.createTexture()),this.texture.width=i._canvas.width,this.texture.height=i._canvas.height,this.texture.ready=!0,e.bindTexture(this.type,this.texture),e.texImage2D(this.type,0,this.format,this.format,e.UNSIGNED_BYTE,i._canvas),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null);else if(x3dom.isa(i,x3dom.nodeTypes.RenderedTexture))i._webgl&&i._webgl.fbo?i._webgl.fbo.dtex&&i._vf.depthMap?this.texture=i._webgl.fbo.dtex:this.texture=i._webgl.fbo.tex:(this.texture=null,x3dom.debug.logError("Try updating RenderedTexture without FBO initialized!")),this.texture&&(this.texture.ready=!0);else if(x3dom.isa(i,x3dom.nodeTypes.PixelTexture)){0==i._vf.origChannelCount&&i.setOrigChannelCount(i._vf.image.comp),null==this.texture&&(this.node._DEF?this.texture=this.cache.getTexture2DByDEF(e,this.node._nameSpace,this.node._DEF):this.texture=e.createTexture()),this.texture.width=i._vf.image.width,this.texture.height=i._vf.image.height,this.texture.ready=!0;var n=i._vf.image.array,r=i._vf.image.width*i._vf.image.height*i._vf.image.comp,a=new Uint8Array(r);a.set(n),e.bindTexture(this.type,this.texture),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.texImage2D(this.type,0,this.format,i._vf.image.width,i._vf.image.height,0,this.format,e.UNSIGNED_BYTE,a),this.genMipMaps&&e.generateMipmap(this.type),e.bindTexture(this.type,null)}else if(x3dom.isa(i,x3dom.nodeTypes.MovieTexture)||o){var d=this,h=document.getElementsByTagName("body")[0];if(null==this.texture&&(this.texture=e.createTexture()),this.dashtexture){var l=document.createElement("div");l.setAttribute("class","dash-video-player"+x3dom.Texture.textNum),i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted");var f=document.createElement("script");f.setAttribute("type","text/javascript"),f.innerHTML='startDashVideo("'+i._vf.url[0]+'",".dash-video-player'+x3dom.Texture.textNum+' video")',l.appendChild(f),l.appendChild(i._video),h.appendChild(l),i._video.style.visibility="hidden",i._video.style.display="none"}else{o||(i._video=document.createElement("video"),i._video.setAttribute("preload","auto"),i._video.setAttribute("muted","muted"),h.appendChild(i._video),i._video.style.visibility="hidden",i._video.style.display="none");for(var u=0;u<i._vf.url.length;u++){var _=i._nameSpace.getURL(i._vf.url[u]);x3dom.debug.logInfo("Adding video file: "+_);var c=document.createElement("source");c.setAttribute("src",_),i._video.appendChild(c)}}var m=function(){e.bindTexture(d.type,d.texture),e.texImage2D(d.type,0,d.format,d.format,e.UNSIGNED_BYTE,i._video),d.genMipMaps&&e.generateMipmap(d.type),e.bindTexture(d.type,null),d.texture.ready=!0,t.needRender=!0};i._video.addEventListener("canplaythrough",(function(){i._video.play(),i._intervalID=setInterval(m,16)}),!0),i._video.addEventListener("ended",(function(){clearInterval(i._intervalID),!0===i._vf.loop&&(i._video.play(),i._intervalID=setInterval(m,16))}),!0)}else x3dom.isa(i,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.texture=this.cache.getTextureCube(e,t,i.getTexUrl(),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps,i._vf.flipY):this.texture=this.cache.getTexture2D(e,t,i._nameSpace.getURL(i._vf.url[0]),!1,i._vf.crossOrigin,i._vf.scale,this.genMipMaps,i._vf.flipY,i)},x3dom.Texture.prototype.updateText=function(){var e=this.gl;this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE,this.type=e.TEXTURE_2D,this.format=e.RGBA,this.magFilter=e.LINEAR,this.minFilter=e.LINEAR_MIPMAP_LINEAR,this.genMipMaps=!0,x3dom.caps.MAX_ANISOTROPY&&(this.anisotropicDegree=x3dom.caps.MAX_ANISOTROPY);var t=this.node._cf.fontStyle.node,i="serif",s="normal",o="left",n=1,r=1,a=2,d="FIRST";if(null!==t){var h=t._vf.family.toString();switch(i=(h=(h=h.trim().replace(/\'/g,"").replace(/\,/," ")).split(" ")).map((function(e){return"SANS"==e?"Verdana, sans-serif":"SERIF"==e?"Georgia, serif":"TYPEWRITER"==e?"monospace":""+e})).join(","),(s=t._vf.style.toString().replace(/\'/g,"")).toUpperCase()){case"PLAIN":s="normal";break;case"BOLD":s="bold";break;case"ITALIC":s="italic";break;case"BOLDITALIC":s="italic bold";break;default:s="normal"}var l=t._vf.leftToRight?"ltr":"rtl",f=t._vf.topToBottom,u="ltr"==l?"left":"right",_="ltr"==l?"right":"left";switch((o=t._vf.justify[0].toString().replace(/\'/g,"")).toUpperCase()){case"BEGIN":o=u;break;case"END":o=_;break;case"FIRST":o=u;break;case"MIDDLE":o="center";break;default:o=u}if(void 0===t._vf.justify[1])d="FIRST";else switch((d=t._vf.justify[1].toString().replace(/\'/g,"")).toUpperCase()){case"BEGIN":d="BEGIN";break;case"FIRST":d="FIRST";break;case"MIDDLE":d="MIDDLE";break;case"END":d="END";break;default:d="FIRST"}n=t._vf.size,r=t._vf.spacing,t._vf.horizontal,t._vf.language,a=t._vf.quality,a=Math.max(x3dom.Texture.minFontQuality,a),a=Math.min(x3dom.Texture.maxFontQuality,a),n<.1&&(n=.1),x3dom.Texture.clampFontSize&&n>2.3&&(n=2.3)}var c,m,p=this.node._vf.string,x=this.node._vf.maxExtent,v=[],g=o,y=document.createElement("canvas");y.dir=l;var S=32*n;document.body.appendChild(y);var T=y.getContext("2d");T.font=s+" "+S+"px "+i;var F,b,C,M=0;for(C=0;C<p.length;C++)(F=T.measureText(p[C]).width)>M&&(M=F),b=0|this.node._vf.length[C],x>0&&(b>x||0==b)&&(b=x),v[C]=b<=0?F:32*b;var E=.25*S,w=M+E,A=S+S*r*(p.length-1)+E;c=0,m=0;var D=0,N=0,R="alphabetic";switch(o){case"center":D=-w/2,c=w/2;break;case"left":D=0,c=0;break;case"right":D=-w,c=w}switch(d){case"MIDDLE":N=A/2-E/2,R="middle",m=S/2;break;case"BEGIN":N=f?0:A-E,R=f?"top":"bottom",m=f?0:S;break;case"FIRST":N=f?S:A-E,R=f?"alphabetic":"bottom",m=S;break;case"END":N=f?A-E:0,R=f?"bottom":"top",m=f?S:0}var I=w*(1/32),P=A*(1/32),V=x3dom.caps.MAX_TEXTURE_SIZE>>2;D*=1/32,N*=1/32,y.width=Math.min(x3dom.Utils.nextHighestPowerOfTwo(w*a),V),y.height=Math.min(x3dom.Utils.nextHighestPowerOfTwo(A*a),V),y.dir=l,T.scale(y.width/w,y.height/A),T.fillStyle="rgba(0,0,0,0)",T.fillRect(0,0,T.canvas.width,T.canvas.height),T.fillStyle="white",T.textBaseline=R,T.font=s+" "+S+"px "+i,T.textAlign=g;var O={font_style:s,font_family:i,font_spacing:r,paragraph:p,topToBottom:f,leftToRight:l,textX:c,textY:m,textHeight:S,lengths:v};this.renderScaledText(T,1,O),null===this.texture&&(this.texture=e.createTexture()),e.bindTexture(this.type,this.texture),this.uploadTextMipmap(y,O),e.bindTexture(this.type,null),document.body.removeChild(y),this.node._mesh._positions[0]=[0+D,-P+N,0,I+D,-P+N,0,I+D,0+N,0,0+D,0+N,0],this.node.invalidateVolume(),this.node._parentNodes.forEach((function(e){e.setAllDirty()}))},x3dom.Texture.prototype.renderScaledText=function(e,t,i){e.font=i.font_style+" "+i.textHeight/t+"px "+i.font_family;for(var s=i.textY,o=0;o<i.paragraph.length;o++){var n=i.topToBottom?o:i.paragraph.length-1-o,r=i.paragraph[n];"rtl"==i.leftToRight&&(r=""+r),e.fillText(r,i.textX/t,s/t,i.lengths[n]/t),s+=i.textHeight*i.font_spacing}},x3dom.Texture.prototype.uploadTextMipmap=function(e,t){for(var i=this.gl,s=e.width,o=e.height,n=0,r=1,a=s,d=o,h=e.getContext("2d");i.texImage2D(this.type,n++,this.format,this.format,i.UNSIGNED_BYTE,h.getImageData(0,0,a,d)),1!=a||1!=d;)a=Math.max(1,a>>1),d=Math.max(1,d>>1),h.clearRect(0,0,s,o),r*=2,this.renderScaledText(h,r,t)},x3dom.X3DDocument=function(e,t,i){this.canvas=e,this.ctx=t,this.properties=i,this.needRender=!0,this._x3dElem=null,this._scene=null,this._viewarea=null,this.downloadCount=0,this.previousDownloadCount=0,this.mutationObserver=new MutationObserver(this.onMutation.bind(this)),this.X3DMutationObserver=new MutationObserver(this.onX3DMutation.bind(this)),this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[],affectedPointingSensors:[]},this.onload=function(){},this.onerror=function(){}},x3dom.X3DDocument.prototype.load=function(e,t){var i={},s=[e],o=this;!function n(){if(0===s.length)return o._setup(i[e],i,t),void o.onload();var r=s.shift();!x3dom.isX3DElement(r)||"x3d"!==r.localName.toLowerCase()&&"websg"!==r.localName.toLowerCase()||(i[r]=r,o._x3dElem=r,n())}()},x3dom.findScene=function(e){for(var t=[],i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];s&&s.localName&&"scene"===s.localName.toLowerCase()&&t.push(s)}return t.length>1?(x3dom.debug.logError("X3D element has more than one Scene child (has "+e.childNodes.length+")."),null):t[0]},x3dom.X3DDocument.prototype._setup=function(e){var t=x3dom.findScene(e);this.X3DMutationObserver.observe(document,{attributes:!1,attributeOldValue:!1,childList:!0,subtree:!0}),this.mutationObserver.observe(e,{attributes:!1,attributeOldValue:!1,childList:!0,subtree:!1}),this.mutationObserver.observe(t,{attributes:!0,attributeOldValue:!0,childList:!0,subtree:!0}),this._bindableBag=new x3dom.BindableBag(this);var i=new x3dom.NodeNameSpace("scene",this).setupTree(t);this._scene=i,this._bindableBag.setRefNode(i),this._viewarea=new x3dom.Viewarea(this,i),this._viewarea._width=this.canvas.width,this._viewarea._height=this.canvas.height},x3dom.X3DDocument.prototype.advanceTime=function(e){var t=0;if(this._nodeBag.timer.length)for(t=0;t<this._nodeBag.timer.length;t++)this.needRender|=this._nodeBag.timer[t].tick(e);if(this._nodeBag.followers.length)for(t=0;t<this._nodeBag.followers.length;t++)this.needRender|=this._nodeBag.followers[t].tick(e);if(this._nodeBag.trans.length)for(t=0;t<this._nodeBag.trans.length;t++)this.needRender|=this._nodeBag.trans[t].tick(e);if(this._nodeBag.viewarea.length)for(t=0;t<this._nodeBag.viewarea.length;t++)this.needRender|=this._nodeBag.viewarea[t].tick(e)},x3dom.X3DDocument.prototype.render=function(e,t,i){e&&this._viewarea&&(this._viewarea.setVRFrameData(t),this._viewarea.updateGamepads(i),e.renderScene(this._viewarea))},x3dom.X3DDocument.prototype.onPick=function(e,t,i){e&&this._viewarea&&e.pickValue(this._viewarea,t,i,1)},x3dom.X3DDocument.prototype.onPickRect=function(e,t,i,s,o){return e&&this._viewarea?e.pickRect(this._viewarea,t,i,s,o):[]},x3dom.X3DDocument.prototype.onMove=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,i,s),this._viewarea.onMove(t,i,s))},x3dom.X3DDocument.prototype.onMoveView=function(e,t,i,s,o){e&&this._viewarea&&this._scene.getNavigationInfo()._impl.onTouchDrag(this._viewarea,t,i,s,o)},x3dom.X3DDocument.prototype.onDrag=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&!this._viewarea._isMoving&&e.pickValue(this._viewarea,t,i,s),this._viewarea.onDrag(t,i,s))},x3dom.X3DDocument.prototype.onWheel=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&e.pickValue(this._viewarea,t,s,0),this._viewarea.onDrag(t,i,2))},x3dom.X3DDocument.prototype.onMousePress=function(e,t,i,s){e&&this._viewarea&&(this._viewarea._scene.updateVolume(),e.pickValue(this._viewarea,t,i,s),this._viewarea.onMousePress(t,i,s))},x3dom.X3DDocument.prototype.onMouseRelease=function(e,t,i,s,o){if(e&&this._viewarea){var n=o<<8|s;e.pickValue(this._viewarea,t,i,n),this._viewarea.onMouseRelease(t,i,s,o)}},x3dom.X3DDocument.prototype.onMouseOver=function(e,t,i,s){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,s),this._viewarea.onMouseOver(t,i,s))},x3dom.X3DDocument.prototype.onMouseOut=function(e,t,i,s){e&&this._viewarea&&(e.pickValue(this._viewarea,t,i,s),this._viewarea.onMouseOut(t,i,s))},x3dom.X3DDocument.prototype.onDoubleClick=function(e,t,i){e&&this._viewarea&&this._viewarea.onDoubleClick(t,i)},x3dom.X3DDocument.prototype.onKeyDown=function(e){switch(e){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}},x3dom.X3DDocument.prototype.onKeyUp=function(e){var t=null;switch(e){case 13:x3dom.toggleFullScreen();break;case 33:(t=this._scene.getViewpoint()._stack)?t.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:(t=this._scene.getViewpoint()._stack)?t.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 35:(t=this._scene.getViewpoint()._stack)?t.switchTo("last"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 36:(t=this._scene.getViewpoint()._stack)?t.switchTo("first"):x3dom.debug.logError("No valid ViewBindable stack.")}},x3dom.X3DDocument.prototype.onKeyPress=function(e){var t=this._scene.getNavigationInfo(),i=this._scene.getEnvironment();switch(e){case 32:var s=this.canvas.parent.stateViewer;s&&s.display(),x3dom.debug.logInfo("a: show all | i: fit view | d: show helper buffers | s: small feature culling | t: light view | m: toggle render mode | c: frustum culling | p: intersect type | \ne: examine mode | f: fly mode | y: freefly mode | w: walk mode | h: helicopter mode | l: lookAt mode | o: lookaround | g: game mode | n: turntable | u: upright position | \nv: print viewpoint info | r: reset view | home: first view | end: last view | pageUp: next view | pageDown: prev. view | +: increase speed | -: decrease speed ");break;case 43:t._vf.speed=2*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 45:t._vf.speed=.5*t._vf.speed,x3dom.debug.logInfo("Changed navigation speed to "+t._vf.speed);break;case 51:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor+=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 52:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor-=.5,x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 54:t._vf.typeParams[1]+=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 55:t._vf.typeParams[1]-=1,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter height to "+t._vf.typeParams[1]);break;case 56:t._vf.typeParams[0]-=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 57:t._vf.typeParams[0]+=.02,t._heliUpdated=!1,x3dom.debug.logInfo("Changed helicopter angle to "+t._vf.typeParams[0]);break;case 97:this._viewarea.showAll();break;case 99:i._vf.frustumCulling=!i._vf.frustumCulling,x3dom.debug.logInfo("Viewfrustum culling "+(i._vf.frustumCulling?"on":"off"));break;case 100:void 0===this._viewarea._visDbgBuf&&(this._viewarea._visDbgBuf="true"===this._x3dElem.getAttribute("showLog")),this._viewarea._visDbgBuf=!this._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=1==this._viewarea._visDbgBuf?"block":"none";break;case 101:t.setType("examine",this._viewarea);break;case 102:t.setType("fly",this._viewarea);break;case 103:t.setType("game",this._viewarea);break;case 104:t.setType("helicopter",this._viewarea);break;case 105:this._viewarea.fit(this._scene._lastMin,this._scene._lastMax);break;case 108:t.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=++this._viewarea._points%2;break;case 110:t.setType("turntable",this._viewarea);break;case 111:t.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case"idbuf":this._scene._vf.pickMode="color";break;case"color":this._scene._vf.pickMode="texCoord";break;case"texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:i._vf.smallFeatureCulling=!i._vf.smallFeatureCulling,x3dom.debug.logInfo("Small feature culling "+(i._vf.smallFeatureCulling?"on":"off"));break;case 116:this._nodeBag.lights.length>0&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());break;case 117:this._viewarea.uprightView();break;case 118:var o=this;!function(){var e=o._viewarea._scene.getViewpoint(),t=o._viewarea.getViewMatrix().inverse(),i=new x3dom.fields.Quaternion(0,0,1,0);i.setValue(t);var s=i.toAxisAngle(),n=t.e3(),r=e.getCenterOfRotation();x3dom.debug.logInfo('\n&lt;Viewpoint position="'+n.x.toFixed(5)+" "+n.y.toFixed(5)+" "+n.z.toFixed(5)+'" orientation="'+s[0].x.toFixed(5)+" "+s[0].y.toFixed(5)+" "+s[0].z.toFixed(5)+" "+s[1].toFixed(5)+'" \n\tzNear="'+e.getNear().toFixed(5)+'" zFar="'+e.getFar().toFixed(5)+'" centerOfRotation="'+r.x.toFixed(5)+" "+r.y.toFixed(5)+" "+r.z.toFixed(5)+'" fieldOfView="'+e.getFieldOfView().toFixed(5)+'" description="'+e._vf.description+'"&gt;&lt;/Viewpoint&gt;')}();break;case 119:t.setType("walk",this._viewarea);break;case 121:t.setType("freefly",this._viewarea)}},x3dom.X3DDocument.prototype.shutdown=function(e){e&&e.shutdown(this._viewarea)},x3dom.X3DDocument.prototype.hasAnimationStateChanged=function(){return!!this._viewarea&&this._viewarea.hasAnimationStateChanged()},x3dom.X3DDocument.prototype.isAnimating=function(){return!!this._viewarea&&this._viewarea.isAnimating()},x3dom.X3DDocument.prototype.incrementDownloads=function(){this.downloadCount++},x3dom.X3DDocument.prototype.decrementDownloads=function(){this.downloadCount--},x3dom.X3DDocument.prototype.cleanNodeBag=function(e,t){for(var i=0,s=e.length;i<s;i++)if(e[i]===t){e.splice(i,1);break}},x3dom.X3DDocument.prototype.removeX3DOMBackendGraph=function(e){for(var t=e.childNodes,i=0,s=t.length;i<s;i++)this.removeX3DOMBackendGraph(t[i]);if(e._x3domNode){var o=e._x3domNode;if(x3dom.isa(o,x3dom.nodeTypes.X3DShapeNode))o._cleanupGLObjects&&o._cleanupGLObjects(!0),x3dom.nodeTypes.Shape.idMap.nodeID[o._objectID]&&delete x3dom.nodeTypes.Shape.idMap.nodeID[o._objectID];else if(x3dom.isa(o,x3dom.nodeTypes.TimeSensor))this.cleanNodeBag(this._nodeBag.timer,o);else if(x3dom.isa(o,x3dom.nodeTypes.X3DLightNode))this.cleanNodeBag(this._nodeBag.lights,o);else if(x3dom.isa(o,x3dom.nodeTypes.X3DFollowerNode))this.cleanNodeBag(this._nodeBag.followers,o);else if(x3dom.isa(o,x3dom.nodeTypes.X3DTransformNode))this.cleanNodeBag(this._nodeBag.trans,o);else if(x3dom.isa(o,x3dom.nodeTypes.RenderedTexture))this.cleanNodeBag(this._nodeBag.renderTextures,o),o._cleanupGLObjects&&o._cleanupGLObjects();else if(x3dom.isa(o,x3dom.nodeTypes.X3DPointingDeviceSensorNode))this.cleanNodeBag(this._nodeBag.affectedPointingSensors,o);else if(x3dom.isa(o,x3dom.nodeTypes.Texture))o.shutdown();else if(x3dom.isa(o,x3dom.nodeTypes.AudioClip))o.shutdown();else if(x3dom.isa(o,x3dom.nodeTypes.X3DBindableNode)){var n=o._stack;n&&(o.bind(!1),this.cleanNodeBag(n._bindBag,o)),o._cleanupGLObjects&&o._cleanupGLObjects()}else x3dom.isa(o,x3dom.nodeTypes.Scene)&&o._webgl&&(o._webgl=null);(e.getAttribute("use")||e.getAttribute("USE"))&&delete e._x3domNode}},x3dom.X3DDocument.prototype.getParentNode=function(e){return e&&"x3dommetagroup"==e.localName.toLowerCase()&&(e=this.getParentNode(e.parentNode)),e},x3dom.X3DDocument.prototype.onAttributeChanged=function(e,t,i){"_x3domNode"in e&&(e._x3domNode.updateField(t,i),this.needRender=!0)},x3dom.X3DDocument.prototype.onNodeRemoved=function(e,t){var i=e;if(i){i.querySelectorAll&&i.querySelectorAll("*").forEach((function(e){e.highlight=null,e.addEventListener=null,e.removeEventListener=null}));var s=this.getParentNode(t);if(s&&"_x3domNode"in s&&"_x3domNode"in i){var o=s._x3domNode,n=i._x3domNode,r=n.findX3DDoc();if(r){var a=r._viewarea._pickingInfo;a.firstObj=null,a.lastObj=null,a.lastClickObj=null,a.pickObj=null}o&&n&&(o.removeChild(n),o.nodeChanged(),this.removeX3DOMBackendGraph(i),this._viewarea&&this._viewarea._scene&&(this._viewarea._scene.nodeChanged(),this._viewarea._scene.updateVolume(),this.needRender=!0))}else if(i.localName&&"ROUTE"==i.localName.toUpperCase()&&i._nodeNameSpace){var d=i._nodeNameSpace.defMap[i.getAttribute("fromNode")],h=i._nodeNameSpace.defMap[i.getAttribute("toNode")];d&&h&&d.removeRoute(i.getAttribute("fromField"),h,i.getAttribute("toField"))}else if(i.localName&&"IMPORT"==i.localName.toUpperCase()&&i._nodeNameSpace){var l=i.getAttribute("inlineDEF")||i.getAttribute("inlinedef"),f=i.getAttribute("importedDEF")||i.getAttribute("importeddef"),u=i.getAttribute("AS")||i.getAttribute("as");if(!l||!f)return;u||(u=f);var _=i._nodeNameSpace.imports,c=_.get(l);c&&c.get(u)==f&&(delete i._nodeNameSpace.defMap[u],c.delete(u),0==c.size&&_.delete(l))}else if(i.localName&&"EXPORT"==i.localName.toUpperCase()&&i._nodeNameSpace){var m=i.getAttribute("localDEF")||i.getAttribute("localdef");u=i.getAttribute("AS")||i.getAttribute("as");if(!m)return;u||(u=m);var p=i._nodeNameSpace.exports;p.get(u)==m&&p.delete(u)}}},x3dom.X3DDocument.prototype.onX3DNodeRemoved=function(e,t){var i=[];"querySelector"in e&&e.querySelector("X3D")&&(i=e.querySelectorAll("X3D")),e.localName&&"X3D"==e.localName.toUpperCase()&&(i=[e]),i.forEach((function(e){var t=e.runtime;if(t&&t.canvas&&t.canvas.doc&&t.canvas.doc._scene){var i=t.canvas.doc._scene._xmlNode;this.removeX3DOMBackendGraph(i);for(var s=0;s<x3dom.canvases.length;s++)if(x3dom.canvases[s]===t.canvas){x3dom.canvases[s].doc.shutdown(x3dom.canvases[s].gl),x3dom.canvases.splice(s,1);break}t.canvas.doc._scene=null,t.canvas.doc._viewarea=null,t.canvas.doc=null,t.canvas=null,t=null,e.context=null,e.runtime=null}}),this)},x3dom.X3DDocument.prototype.onNodeAdded=function(e,t){var i=e,s=this.getParentNode(t);if((!s.tagName||"inline"!=s.tagName.toLowerCase())&&"_x3domNode"in s){var o=s._x3domNode;if(o&&o._nameSpace&&i instanceof Element){if("_x3domNode"in i){if(i._x3domNode._parentNodes.includes(o))return;o.removeChild(i._x3domNode),this.removeX3DOMBackendGraph(i)}x3dom.caps.DOMNodeInsertedEvent_perSubtree&&this.removeX3DOMBackendGraph(i);var n=o._nameSpace.setupTree(i);o.addChild(n,i.getAttribute("containerField")),o.nodeChanged();var r=s.parentNode;r&&r._x3domNode&&r._x3domNode.nodeChanged(),this._viewarea&&this._viewarea._scene&&(this._viewarea._scene.nodeChanged(),this._viewarea._scene.updateVolume(),this.needRender=!0)}else x3dom.debug.logWarning("No _nameSpace in onNodeAdded")}},x3dom.X3DDocument.prototype.onX3DNodeAdded=function(e,t){var i=e;i.localName&&i.localName.toUpperCase()},x3dom.X3DDocument.prototype.onMutation=function(e){for(var t=0,i=e.length;t<i;t++)if("attributes"===e[t].type&&e[t].oldValue)this.onAttributeChanged(e[t].target,e[t].attributeName,e[t].target[e[t].attributeName]);else if("childList"===e[t].type){if(e[t].removedNodes.length)for(var s=0,o=e[t].removedNodes.length;s<o;s++)this.onNodeRemoved(e[t].removedNodes[s],e[t].target);if(e[t].addedNodes.length)for(s=0,o=e[t].addedNodes.length;s<o;s++)this.onNodeAdded(e[t].addedNodes[s],e[t].target)}},x3dom.X3DDocument.prototype.onX3DMutation=function(e){for(var t=0,i=e.length;t<i;t++)if("childList"===e[t].type&&e[t].removedNodes.length)for(var s=0,o=e[t].removedNodes.length;s<o;s++)this.onX3DNodeRemoved(e[t].removedNodes[s],e[t].target)},x3dom.MatrixMixer=function(e,t){this.beginTime=e||0,this.endTime=t||1,this.isMixing=!1,this._beginMat=x3dom.fields.SFMatrix4f.identity(),this._beginInvMat=x3dom.fields.SFMatrix4f.identity(),this._beginLogMat=x3dom.fields.SFMatrix4f.identity(),this._endMat=x3dom.fields.SFMatrix4f.identity(),this._endLogMat=x3dom.fields.SFMatrix4f.identity(),this._beginRot=new x3dom.fields.Quaternion,this._endRot=new x3dom.fields.Quaternion,this._beginPos=new x3dom.fields.SFVec3f,this._endPos=new x3dom.fields.SFVec3f,this._result=x3dom.fields.SFMatrix4f.identity(),this._useQuaternion=!1,this._isVPtarget=!1},x3dom.MatrixMixer.prototype._calcFraction=function(e){var t=(e-this.beginTime)/(this.endTime-this.beginTime);return(Math.sin(t*Math.PI-Math.PI/2)+1)/2},x3dom.MatrixMixer.prototype._isValid=function(){var e=this._beginMat.inverse().mult(this._endMat).getEulerAngles();return Math.abs(e[0])!=Math.PI&&Math.abs(e[1])!=Math.PI&&Math.abs(e[2])!=Math.PI},x3dom.MatrixMixer.prototype._prepareQuaternionAnimation=function(){this._beginRot.setValue(this._beginMat),this._endRot.setValue(this._endMat),this._beginPos=this._beginMat.e3(),this._endPos=this._endMat.e3(),this._useQuaternion=!0},x3dom.MatrixMixer.prototype.reset=function(){this.beginTime=0,this.endTime=0,this._useQuaternion=!1,this.isMixing=!1},x3dom.MatrixMixer.prototype.isActive=function(){return this.beginTime>0},x3dom.MatrixMixer.prototype.setBeginMatrix=function(e){this._beginMat.setValues(e),this._beginInvMat=e.inverse(),this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()},x3dom.MatrixMixer.prototype.getBeginMatrix=function(e){return this._beginMat},x3dom.MatrixMixer.prototype.setEndMatrix=function(e){this._endMat.setValues(e),this._isValid()||this._prepareQuaternionAnimation(),this._endLogMat=this._endMat.mult(this._beginInvMat).log(),this._logDiffMat=this._endLogMat.addScaled(this._beginLogMat,-1)},x3dom.MatrixMixer.prototype.getEndMatrix=function(e){return this._endMat},x3dom.MatrixMixer.prototype._mixQuaternion=function(e){var t=this._beginRot.slerp(this._endRot,e),i=this._beginPos.addScaled(this._endPos.subtract(this._beginPos),e);return this._result.setRotate(t),this._result.setTranslate(i),this._result.copy()},x3dom.MatrixMixer.prototype._mixMatrix=function(e){return this._logDiffMat.multiply(e).add(this._beginLogMat).exp().mult(this._beginMat)},x3dom.MatrixMixer.prototype.mix=function(e){if(e<=this.beginTime)return this._beginMat;if(e>=this.endTime)return this.reset(),this._endMat;this.isMixing=!0;var t=this._calcFraction(e);return this._useQuaternion?this._mixQuaternion(t):this._mixMatrix(t)},x3dom.Mesh=function(e){this._parent=e,this._vol=new x3dom.fields.BoxVolume,this._invalidate=!0,this._numFaces=0,this._numCoords=0,this._primType="TRIANGLES",this._positions=[],this._normals=[],this._texCoords=[],this._texCoords2=[],this._colors=[],this._indices=[],this._tangents=[],this._binormals=[],this._positions[0]=[],this._normals[0]=[],this._texCoords[0]=[],this._texCoords2[0]=[],this._colors[0]=[],this._indices[0]=[],this._tangents[0]=[],this._binormals[0]=[]},x3dom.Mesh.prototype._dynamicFields={},x3dom.Mesh.prototype._numPosComponents=3,x3dom.Mesh.prototype._numTexComponents=2,x3dom.Mesh.prototype._numTex2Components=2,x3dom.Mesh.prototype._numColComponents=3,x3dom.Mesh.prototype._numNormComponents=3,x3dom.Mesh.prototype._numTangentComponents=3,x3dom.Mesh.prototype._numBinormalComponents=3,x3dom.Mesh.prototype._lit=!0,x3dom.Mesh.prototype._vol=null,x3dom.Mesh.prototype._invalidate=!0,x3dom.Mesh.prototype._numFaces=0,x3dom.Mesh.prototype._numCoords=0,x3dom.Mesh.prototype.getVolume=function(){if(1==this._invalidate&&!this._vol.isValid()){var e=this._positions[0],t=e.length;if(t>=3){var i=new x3dom.fields.SFVec3f(e[0],e[1],e[2]);this._vol.setBounds(i,i);for(var s=3;s<t;s+=3)this._vol.min.x>e[s]&&(this._vol.min.x=e[s]),this._vol.min.y>e[s+1]&&(this._vol.min.y=e[s+1]),this._vol.min.z>e[s+2]&&(this._vol.min.z=e[s+2]),this._vol.max.x<e[s]&&(this._vol.max.x=e[s]),this._vol.max.y<e[s+1]&&(this._vol.max.y=e[s+1]),this._vol.max.z<e[s+2]&&(this._vol.max.z=e[s+2]);this._invalidate=!1}}return this._vol},x3dom.Mesh.prototype.invalidate=function(){this._invalidate=!0,this._vol.invalidate()},x3dom.Mesh.prototype.isValid=function(){return this._vol.isValid()},x3dom.Mesh.prototype.getCenter=function(){return this.getVolume().getCenter()},x3dom.Mesh.prototype.getDiameter=function(){return this.getVolume().getDiameter()},x3dom.Mesh.prototype.doIntersect=function(e){var t=this.getVolume(),i=e.intersect(t.min,t.max);return i&&e.enter<e.dist&&(e.dist=e.enter,e.hitObject=this._parent,e.hitPoint=e.pos.add(e.dir.multiply(e.enter))),i},x3dom.Mesh.prototype.calcNormals=function(e,t){void 0===t&&(t=!0);var i,s,o,n,r=this._multiIndIndices&&this._multiIndIndices.length,a=r?this._multiIndIndices:this._indices[0],d=this._positions[0],h=[],l=[],f=d.length,u=null,_=void 0!==this._posSize&&this._posSize>f?this._posSize/3:f/3;for(_=3*(_-Math.floor(_)>0?Math.floor(_+1):_),i=0;i<_;++i)l[i]=[];for(_=a.length,i=0;i<_;i+=3){var c,m,p,x;r?(c=3*i,m=3*(i+1),p=3*(i+2),x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),o=new x3dom.fields.SFVec3f(d[c],d[c+1],d[c+2]).subtract(x),n=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2]))):(c=3*a[i],m=3*a[i+1],p=3*a[i+2],x=new x3dom.fields.SFVec3f(d[m],d[m+1],d[m+2]),o=new x3dom.fields.SFVec3f(d[c],d[c+1],d[c+2]).subtract(x),n=x.subtract(new x3dom.fields.SFVec3f(d[p],d[p+1],d[p+2])),c=3*i,m=3*(i+1),p=3*(i+2)),u=o.cross(n).normalize(),t||(u=u.negate()),e<=x3dom.fields.Eps?(h[c]=h[m]=h[p]=u.x,h[c+1]=h[m+1]=h[p+1]=u.y,h[c+2]=h[m+2]=h[p+2]=u.z):(l[a[i]].push(u),l[a[i+1]].push(u),l[a[i+2]].push(u))}if(e>x3dom.fields.Eps)for(i=0;i<f;i+=3){var v,g=i/3;for(_=(v=r?l[a[g]]:l[g]).length,u=new x3dom.fields.SFVec3f(0,0,0),s=0;s<_;++s)u=u.add(v[s]);u=u.normalize(),h[i]=u.x,h[i+1]=u.y,h[i+2]=u.z}this._normals[0]=h},x3dom.Mesh.prototype.splitMesh=function(e,t){var i,s;i=void 0===e?3:e,void 0===t&&(t=!1);var o=x3dom.Utils.maxIndexableCoords;if(o=Math.floor(o/i)*i,!(this._positions[0].length/3<=o)||t){s=!!t&&(this._multiIndIndices&&this._multiIndIndices.length);var n=this._positions[0],r=this._normals[0],a=this._texCoords[0],d=this._colors[0],h=s?this._multiIndIndices:this._indices[0],l=this._tangents[0],f=this._binormals[0],u=0;do{this._positions[u]=[],this._normals[u]=[],this._texCoords[u]=[],this._colors[u]=[],this._indices[u]=[],this._tangents[u]=[],this._binormals[u]=[];var _=h.length-(u+1)*o>=0;if(this._indices[u]=_?h.slice(u*o,(u+1)*o):h.slice(u*o),s)for(m=0,p=this._indices[u].length;m<p;m++)this._indices[u][m]=m;else if(u)for(var c=u*o,m=0,p=this._indices[u].length;m<p;m++)this._indices[u][m]-=c;this._positions[u]=_?n.slice(u*o*3,3*(u+1)*o):n.slice(u*o*3),r.length&&(this._normals[u]=_?r.slice(u*o*3,3*(u+1)*o):r.slice(u*o*3)),a.length&&(this._texCoords[u]=_?a.slice(u*o*this._numTexComponents,this._numTexComponents*(u+1)*o):a.slice(u*o*this._numTexComponents)),d.length&&(this._colors[u]=_?d.slice(u*o*this._numColComponents,this._numColComponents*(u+1)*o):d.slice(u*o*this._numColComponents)),l.length&&(this._tangents[u]=_?l.slice(u*o*3,3*(u+1)*o):l.slice(u*o*3)),f.length&&(this._binormals[u]=_?f.slice(u*o*3,3*(u+1)*o):f.slice(u*o*3))}while(n.length>++u*o*3)}},x3dom.Mesh.prototype.calcTexCoords=function(e){if(this._texCoords[0]=[],"sphere-local"===e.toLowerCase())for(var t=0,i=0,s=this._normals[0].length;t<s;t+=3)this._texCoords[0][i++]=.5+this._normals[0][t]/2,this._texCoords[0][i++]=.5+this._normals[0][t+1]/2;if("coord"===e.toLowerCase())for(var o=0,n=0,r=this._positions[0].length;o<r;o+=3)this._texCoords[0][n++]=this._positions[0][o],this._texCoords[0][n++]=this._positions[0][o+1];else{var a=new x3dom.fields.SFVec3f(0,0,0),d=new x3dom.fields.SFVec3f(0,0,0);this.getVolume().getBounds(a,d);var h=d.subtract(a),l=0,f=1;h.x>=h.y?h.x>=h.z?(l=0,f=h.y>=h.z?1:2):(l=2,f=0):h.y>=h.z?(l=1,f=h.x>=h.z?0:2):(l=2,f=1);var u=1,_=0,c=0;switch(l){case 0:u=h.x,_=a.x;break;case 1:u=h.y,_=a.y;break;case 2:u=h.z,_=a.z}switch(f){case 0:h.x,c=a.x;break;case 1:h.y,c=a.y;break;case 2:h.z,c=a.z}for(o=0,n=0,r=this._positions[0].length;o<r;o+=3)this._texCoords[0][n++]=(this._positions[0][o+l]-_)/u,this._texCoords[0][n++]=(this._positions[0][o+f]-c)/u}},x3dom.docs={},x3dom.docs.specURLMap={CADGeometry:"CADGeometry.html",Core:"core.html",DIS:"dis.html",CubeMapTexturing:"env_texture.html",EnvironmentalEffects:"enveffects.html",EnvironmentalSensor:"envsensor.html",Followers:"followers.html",Geospatial:"geodata.html",Geometry2D:"geometry2D.html",Geometry3D:"geometry3D.html",Grouping:"group.html","H-Anim":"hanim.html",Interpolation:"interp.html",KeyDeviceSensor:"keyboard.html",Layering:"layering.html",Layout:"layout.html",Lighting:"lighting.html",Navigation:"navigation.html",Networking:"networking.html",NURBS:"nurbs.html",ParticleSystems:"particle_systems.html",Picking:"picking.html",PointingDeviceSensor:"pointingsensor.html",Rendering:"rendering.html",RigidBodyPhysics:"rigid_physics.html",Scripting:"scripting.html",Shaders:"shaders.html",Shape:"shape.html",Sound:"sound.html",Text:"text.html",Texturing3D:"texture3D.html",Texturing:"texturing.html",Time:"time.html",EventUtilities:"utils.html",VolumeRendering:"volume.html"},x3dom.docs.specBaseURL="https://www.web3d.org/documents/specifications/19775-1/V3.3/Part01/components/",x3dom.docs.getNodeTreeInfo=function(){var e,t="",i=function(e,t){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1},s=function(e,i){for(var o=0;o<i;o++)t+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";for(var o in t+="<a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"#"+e+"' style='color:black; text-decoration:none; font-weight:bold;'>"+e+"</a> &nbsp; <a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[x3dom.nodeTypes[e]._compName]+"' style='color:black; text-decoration:none; font-style:italic;'>"+x3dom.nodeTypes[e]._compName+"</a><br/>",x3dom.nodeTypes[e].childTypes[e])s(x3dom.nodeTypes[e].childTypes[e][o],i+1)};for(e in x3dom.nodeTypes){var o;for(void 0===(o=x3dom.nodeTypes[e]).childTypes&&(o.childTypes={});o.superClass;)void 0===o.superClass.childTypes[o.superClass._typeName]&&(o.superClass.childTypes[o.superClass._typeName]=[]),i(o.superClass.childTypes[o.superClass._typeName],o._typeName)||o.superClass.childTypes[o.superClass._typeName].push(o._typeName),o=o.superClass}return s("X3DNode",0),"<div class='x3dom-doc-nodes-tree'>"+t+"</div>"},x3dom.docs.getComponentInfo=function(){var e,t,i,s=[],o="";for(t in x3dom.components)s.push(t);for(i in s.sort(),s){for(var n in t=s[i],e=x3dom.components[t],o+="<h2><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"' style='color:black; text-decoration:none; font-style:italic;'>"+t+"</a></h2>",o+="<ul style='list-style-type:circle;'>",e)o+="<li><a href='"+x3dom.docs.specBaseURL+x3dom.docs.specURLMap[t]+"#"+n+"' style='color:black; text-decoration:none; font-weight:bold;'>"+n+"</a></li>";o+="</ul>"}return o},x3dom.arc={},x3dom.arc.instance=null,x3dom.arc.Limits=function(e,t,i){this._min=e,this._max=t,this.getValue=function(e){return e=this._min+(this._max-this._min)*e,this._max>=e?this._min<=e?e:this._min:this._max}},x3dom.arc.ARF=function(e,t,i,s,o,n,r,a){this._name=e,this._stateValue=[.5,.5],this._limits=new x3dom.arc.Limits(t,i),this._factorGetterFunc=o,this._factorSetterFunc=n,this._setterFunc=a,this._getterFunc=r,this._dirFac=s,this.getFactor=function(){return this._factorGetterFunc()},this.update=function(e,t){var i=this._stateValue[e]+t*this._dirFac;this._stateValue[e]=0<=i?1>=i?i:1:0,this._setterFunc(this._limits.getValue(this._stateValue[e]))},this.reset=function(){this._stateValue[0]=.5,this._stateValue[1]=.5}},x3dom.arc.AdaptiveRenderControl=defineClass(null,(function(e){x3dom.arc.instance=this,this._scene=e,this._targetFrameRate=[],this._targetFrameRate[0]=this._scene._vf.minFrameRate,this._targetFrameRate[1]=this._scene._vf.maxFrameRate,this._currentState=0;var t=this._scene.getEnvironment();this._arfs=[],this._arfs.push(new x3dom.arc.ARF("smallFeatureCulling",0,10,-1,(function(){return t._vf.smallFeatureFactor}),(function(e){t._vf.smallFeatureFactor=e}),(function(){return t._vf.smallFeatureThreshold}),(function(e){t._vf.smallFeatureThreshold=e}))),this._arfs.push(new x3dom.arc.ARF("lowPriorityCulling",0,100,1,(function(){return t._vf.lowPriorityFactor}),(function(e){t._vf.lowPriorityFactor=e}),(function(){return 100*t._vf.lowPriorityThreshold}),(function(e){t._vf.lowPriorityThreshold=e/100}))),this._arfs.push(new x3dom.arc.ARF("tessellationDetailCulling",1,12,-1,(function(){return t._vf.tessellationErrorFactor}),(function(e){t._vf.tessellationErrorFactor=e}),(function(){return t.tessellationErrorThreshold}),(function(e){t.tessellationErrorThreshold=e}))),this._stepWidth=.1}),{update:function(e,t){this._currentState=e;var i=t-this._targetFrameRate[e];this._stepWidth=Math.abs(i)>10?.1:.01;var s,o=0,n=[],r=this._arfs.length;for(s=0;s<r;++s)n[s]=this._arfs[s].getFactor(),n[s]>0&&(o+=n[s]);var a=i<0?-1:1;for(s=0;s<r;++s)n[s]>0&&(n[s]/=o,this._arfs[s].update(e,this._stepWidth*n[s]*a))},reset:function(){for(var e=0,t=this._arfs.length;e<t;++e)this._arfs[e].reset()}}),x3dom.RequestManager={},x3dom.RequestManager.requests=[],x3dom.RequestManager.maxParallelRequests=50,x3dom.RequestManager.failedRequests=0,x3dom.RequestManager.loadedRequests=0,x3dom.RequestManager.totalRequests=0,x3dom.RequestManager.activeRequests=[],x3dom.RequestManager.requestHeaders=[],x3dom.RequestManager.withCredentials=!1,x3dom.RequestManager.onSendRequest=function(e){},x3dom.RequestManager.onAbortAllRequests=function(e){},x3dom.RequestManager.addRequestHeader=function(e,t){this.requestHeaders.push({header:e,value:t})},x3dom.RequestManager._sendRequest=function(){if(this.onSendRequest(this._getCounters()),!(this.activeRequests.length>this.maxParallelRequests)){var e=this.requests.pop();e&&(this.activeRequests.push(e),e.send(null),this._sendRequest())}},x3dom.RequestManager._getCounters=function(){return{loaded:this.loadedRequests,active:this.activeRequests.length,failed:this.failedRequests,total:this.totalRequests}},x3dom.RequestManager.addRequest=function(e){if(e instanceof XMLHttpRequest){this.totalRequests++,e.withCredentials=this.withCredentials;for(var t=0;t<this.requestHeaders.length;t++){var i=this.requestHeaders[t].header,s=this.requestHeaders[t].value;e.setRequestHeader(i,s)}e.addEventListener("load",this._onLoadHandler.bind(this)),e.addEventListener("error",this._onErrorHandler.bind(this)),this.requests.push(e),this._sendRequest()}},x3dom.RequestManager.abortAllRequests=function(){for(var e=0;e<this.activeRequests.length;e++)this.activeRequests[e].abort();this.requests=[],this.activeRequests=[],this.failedRequests=0,this.loadedRequests=0,this.totalRequests=0,this.onAbortAllRequests(this._getCounters())},x3dom.RequestManager._removeActiveRequest=function(e){var t=this.activeRequests.indexOf(e);return this.activeRequests.splice(t,1)},x3dom.RequestManager._onLoadHandler=function(e){this._removeActiveRequest(e.target),this.loadedRequests++,this._sendRequest()},x3dom.RequestManager._onErrorHandler=function(e){this._removeActiveRequest(e.target),this.failedRequests++,this._sendRequest()},x3dom.Properties=function(){this.properties={}},x3dom.Properties.prototype.setProperty=function(e,t){x3dom.debug.logInfo("Properties: Setting property '"+e+"' to value '"+t+"'"),this.properties[e]=t},x3dom.Properties.prototype.getProperty=function(e,t){return this.properties[e]?this.properties[e]:t},x3dom.Properties.prototype.merge=function(e){for(var t in e.properties)this.properties[t]=e.properties[t]},x3dom.Properties.prototype.toString=function(){var e="";for(var t in this.properties)e+="Name: "+t+" Value: "+this.properties[t]+"\n";return e},x3dom.DoublyLinkedList=function(){this.length=0,this.first=null,this.last=null},x3dom.DoublyLinkedList.ListNode=function(e,t,i,s,o){this.point=e,this.point_index=t,this.normals=i,this.colors=s,this.texCoords=o,this.next=null,this.prev=null},x3dom.DoublyLinkedList.prototype.appendNode=function(e){null===this.first?(e.prev=e,e.next=e,this.first=e,this.last=e):(e.prev=this.last,e.next=this.first,this.first.prev=e,this.last.next=e,this.last=e),this.length++},x3dom.DoublyLinkedList.prototype.insertAfterNode=function(e,t){t.prev=e,t.next=e.next,e.next.prev=t,e.next=t,t.prev==this.last&&(this.last=t),this.length++},x3dom.DoublyLinkedList.prototype.deleteNode=function(e){this.length>1?(e.prev.next=e.next,e.next.prev=e.prev,e==this.first&&(this.first=e.next),e==this.last&&(this.last=e.prev)):(this.first=null,this.last=null),e.prev=null,e.next=null,this.length--},x3dom.DoublyLinkedList.prototype.getNode=function(e){var t=null;if(e>this.length)return t;for(var i=0;i<this.length;i++)if(t=0==i?this.first:t.next,i==e)return t;return null},x3dom.DoublyLinkedList.prototype.invert=function(){for(var e=null,t=this.first,i=0;i<this.length;i++)e=t.prev,t.prev=t.next,t.next=e,t=t.prev;e=this.first,this.first=this.last,this.last=e},x3dom.EarClipping={getIndexes:function(e){var t,i,s,o,n,r=e.first.next,a=this.identifyPlane(r.prev.point,r.point,r.next.point);for(i=[],s=[],t=0;t<e.length;t++){switch(r=e.getNode(t),a){case"XY":o=r.point.x,n=r.point.y;break;case"XZ":o=r.point.z,n=r.point.x;break;default:o=r.point.y,n=r.point.z}i.push(n),i.push(o),s.push(r.point_index)}var d=x3dom.EarCut.triangulate(i,null,2);return d=d.map((function(e){return s[e]}))},getMultiIndexes:function(e){var t,i,s,o=e.first.next,n=this.identifyPlane(o.prev.point,o.point,o.next.point),r={indices:[],point:[],normals:[],colors:[],texCoords:[]},a={indices:[],point:[],normals:[],colors:[],texCoords:[]},d=[];for(t=0;t<e.length;t++){switch(o=e.getNode(t),n){case"XY":i=o.point.x,s=o.point.y;break;case"XZ":i=o.point.z,s=o.point.x;break;default:i=o.point.y,s=o.point.z}d.push(s),d.push(i),a.indices.push(o.point_index),a.point.push(o.point),o.normals&&a.normals.push(o.normals),o.colors&&a.colors.push(o.colors),o.texCoords&&a.texCoords.push(o.texCoords)}var h=x3dom.EarCut.triangulate(d,null,2);return r.indices=h.map((function(e){return a.indices[e]})),r.point=h.map((function(e){return a.point[e]})),o.normals&&(r.normals=h.map((function(e){return a.normals[e]}))),o.colors&&(r.colors=h.map((function(e){return a.colors[e]}))),o.texCoords&&(r.texCoords=h.map((function(e){return a.texCoords[e]}))),r},identifyPlane:function(e,t,i){var s,o,n,r,a,d,h,l,f;s=t.x-e.x,o=t.y-e.y,n=t.z-e.z,r=i.x-e.x,a=i.y-e.y,d=i.z-e.z,h=Math.abs(o*d-n*a),l=Math.abs(n*r-s*d),f=Math.abs(s*a-o*r);var u=Math.max(h,l,f);return u==h?"YZ":u==l?"XZ":u==f?"XY":"XZ"}},x3dom.EarCut={triangulate:function(e,t,i){return function(e,t,i){i=i||2;var r,a,d,h,u,c,m,p=t&&t.length,x=p?t[0]*i:e.length,v=function(e,t,i,s){var o,n,r=0;for(o=t,n=i-s;o<i;o+=s)r+=(e[n]-e[o])*(e[o+1]+e[n+1]),n=o;return r>0}(e,0,x,i),g=s(e,0,x,i,!0,v),y=[];if(!g)return y;p&&(g=function(e,t,i,n){var r,a,d,h,u,c=[];for(r=0,a=t.length;r<a;r++)d=t[r]*n,h=r<a-1?t[r+1]*n:e.length,(u=s(e,d,h,n,!1))===u.next&&(u.steiner=!0),c.push(_(u));for(c.sort(l),r=0;r<c.length;r++)f(c[r],i),i=o(i,i.next);return i}(e,t,g,i));if(e.length>80*i){r=d=e[0],a=h=e[1];for(var S=i;S<x;S+=i)u=e[S],c=e[S+1],u<r&&(r=u),c<a&&(a=c),u>d&&(d=u),c>h&&(h=c);m=Math.max(d-r,h-a)}n(g,y,i,r,a,m),!1===v&&y.reverse();return y}(e,t,i);function s(e,t,i,s,o,n){var r,a;if(o===n)for(r=t;r<i;r+=s)a=S(r,e[r],e[r+1],a);else for(r=i-s;r>=t;r-=s)a=S(r,e[r],e[r+1],a);return a}function o(e,t){if(!e)return e;t||(t=e);var i,s=e;do{if(i=!1,s.steiner||!x(s,s.next)&&0!==p(s.prev,s,s.next))s=s.next;else{if(T(s),(s=t=s.prev)===s.next)return null;i=!0}}while(i||s!==t);return t}function n(e,t,i,s,l,f,_){if(e){!_&&f&&function(e,t,i,s){var o=e;do{null===o.z&&(o.z=u(o.x,o.y,t,i,s)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,function(e){var t,i,s,o,n,r,a,d,h=1;do{for(i=e,e=null,n=null,r=0;i;){for(r++,s=i,a=0,t=0;t<h&&(a++,s=s.nextZ);t++);for(d=h;a>0||d>0&&s;)0===a?(o=s,s=s.nextZ,d--):0!==d&&s?i.z<=s.z?(o=i,i=i.nextZ,a--):(o=s,s=s.nextZ,d--):(o=i,i=i.nextZ,a--),n?n.nextZ=o:e=o,o.prevZ=n,n=o;i=s}n.nextZ=null,h*=2}while(r>1)}(o)}(e,s,l,f);for(var c,m,p=e;e.prev!==e.next;)if(c=e.prev,m=e.next,f?a(e,s,l,f):r(e))t.push(c.i/i),t.push(e.i/i),t.push(m.i/i),T(e),e=m.next,p=m.next;else if((e=m)===p){_?1===_?n(e=d(e,t,i),t,i,s,l,f,2):2===_&&h(e,t,i,s,l,f):n(o(e),t,i,s,l,f,1);break}}}function r(e){var t=e.prev,i=e,s=e.next;if(p(t,i,s)>=0)return!1;for(var o=e.next.next;o!==e.prev;){if(c(t.x,t.y,i.x,i.y,s.x,s.y,o.x,o.y)&&p(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function a(e,t,i,s){var o=e.prev,n=e,r=e.next;if(p(o,n,r)>=0)return!1;for(var a=o.x<n.x?o.x<r.x?o.x:r.x:n.x<r.x?n.x:r.x,d=o.y<n.y?o.y<r.y?o.y:r.y:n.y<r.y?n.y:r.y,h=o.x>n.x?o.x>r.x?o.x:r.x:n.x>r.x?n.x:r.x,l=o.y>n.y?o.y>r.y?o.y:r.y:n.y>r.y?n.y:r.y,f=u(a,d,t,i,s),_=u(h,l,t,i,s),m=e.nextZ;m&&m.z<=_;){if(m!==e.prev&&m!==e.next&&c(o.x,o.y,n.x,n.y,r.x,r.y,m.x,m.y)&&p(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(m=e.prevZ;m&&m.z>=f;){if(m!==e.prev&&m!==e.next&&c(o.x,o.y,n.x,n.y,r.x,r.y,m.x,m.y)&&p(m.prev,m,m.next)>=0)return!1;m=m.prevZ}return!0}function d(e,t,i){var s=e;do{var o=s.prev,n=s.next.next;v(o,s,s.next,n)&&g(o,n)&&g(n,o)&&(t.push(o.i/i),t.push(s.i/i),t.push(n.i/i),T(s),T(s.next),s=e=n),s=s.next}while(s!==e);return s}function h(e,t,i,s,r,a){var d=e;do{for(var h=d.next.next;h!==d.prev;){if(d.i!==h.i&&m(d,h)){var l=y(d,h);return d=o(d,d.next),l=o(l,l.next),n(d,t,i,s,r,a),void n(l,t,i,s,r,a)}h=h.next}d=d.next}while(d!==e)}function l(e,t){return e.x-t.x}function f(e,t){if(t=function(e,t){var i,s=t,o=e.x,n=e.y,r=-1/0;do{if(n<=s.y&&n>=s.next.y){var a=s.x+(n-s.y)*(s.next.x-s.x)/(s.next.y-s.y);a<=o&&a>r&&(r=a,i=s.x<s.next.x?s:s.next)}s=s.next}while(s!==t);if(!i)return null;var d,h=i,l=1/0;s=i.next;for(;s!==h;)o>=s.x&&s.x>=i.x&&c(n<i.y?o:r,n,i.x,i.y,n<i.y?r:o,n,s.x,s.y)&&((d=Math.abs(n-s.y)/(o-s.x))<l||d===l&&s.x>i.x)&&g(s,e)&&(i=s,l=d),s=s.next;return i}(e,t)){var i=y(t,e);o(i,i.next)}}function u(e,t,i,s,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/o)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)/o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function _(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function c(e,t,i,s,o,n,r,a){return(o-r)*(t-a)-(e-r)*(n-a)>=0&&(e-r)*(s-a)-(i-r)*(t-a)>=0&&(i-r)*(n-a)-(o-r)*(s-a)>=0}function m(e,t){return x(e,t)||e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&v(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&g(e,t)&&g(t,e)&&function(e,t){var i=e,s=!1,o=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&o<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==e);return s}(e,t)}function p(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function x(e,t){return e.x===t.x&&e.y===t.y}function v(e,t,i,s){return p(e,t,i)>0!=p(e,t,s)>0&&p(i,s,e)>0!=p(i,s,t)>0}function g(e,t){return p(e.prev,e,e.next)<0?p(e,t,e.next)>=0&&p(e,e.prev,t)>=0:p(e,t,e.prev)<0||p(e,e.next,t)<0}function y(e,t){var i=new F(e.i,e.x,e.y),s=new F(t.i,t.x,t.y),o=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=o,o.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function S(e,t,i,s){var o=new F(e,t,i);return s?(o.next=s.next,o.prev=s,s.next.prev=o,s.next=o):(o.prev=o,o.next=o),o}function T(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function F(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}},x3dom.FieldInterpolator=function(e,t,i,s){this.beginTime=e||0,this.endTime=t||1,this.beginValue=i||0,this.endValue=s||0,this.isInterpolating=!1},x3dom.FieldInterpolator.prototype.isActive=function(){return this.beginTime>0},x3dom.FieldInterpolator.prototype.calcFraction=function(e){var t=(e-this.beginTime)/(this.endTime-this.beginTime);return(Math.sin(t*Math.PI-Math.PI/2)+1)/2},x3dom.FieldInterpolator.prototype.reset=function(){this.isInterpolating=!1,this.beginTime=0,this.endTime=1,this.beginValue=0,this.endValue=0},x3dom.FieldInterpolator.prototype.interpolate=function(e){if(e<this.beginTime)return this.beginValue;if(e>=this.endTime){var t=this.endValue;return this.reset(),t}return this.isInterpolating=!0,this.beginValue+(this.endValue-this.beginValue)*this.calcFraction(e)},x3dom.Utils={},x3dom.Utils.maxIndexableCoords=65535,x3dom.Utils.needLineWidth=!1,x3dom.Utils.measurements=[],window.performance=window.performance||{},performance.now=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()},x3dom.Utils.startMeasure=function(e){var t=e.toUpperCase();x3dom.Utils.measurements[t]||(x3dom.Utils.measurements[t]=performance.now())},x3dom.Utils.stopMeasure=function(e){var t=e.toUpperCase();if(x3dom.Utils.measurements[t]){var i=x3dom.Utils.measurements[t];return delete x3dom.Utils.measurements[t],performance.now()-i}return 0},x3dom.Utils.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},x3dom.Utils.createTexture2D=function(e,t,i,s,o,n,r,a,d){a=a||!1;var h=e.createTexture(),l=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);e.bindTexture(e.TEXTURE_2D,h),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,l),r&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),h.ready=!1;var f=0;if(null==i||""==i)return h;var u=new Image;switch(o.toLowerCase()){case"anonymous":u.crossOrigin="anonymous";break;case"use-credentials":u.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i)&&(u.crossOrigin="anonymous")}var _=function(){if(d&&0===d.getOrigChannelCount()){var e=new XMLHttpRequest;e.open("GET",i),e.onloadstart=function(){e.responseType="arraybuffer"},e.onload=function(){var t=e.getResponseHeader("Content-Type"),i=new Uint8Array(e.response),s=x3dom.Utils.detectChannelCount(i,t);s&&d.setOrigChannelCount(s),u.src=x3dom.Utils.arrayBufferToObjectURL(i,t)},e.onerror=function(){x3dom.debug.logError("[Utils|createTexture2D] Can't http request: "+i),u.src=i},x3dom.RequestManager.addRequest(e)}else u.src=i;t.incrementDownloads()};return _(),u.onload=function(){h.originalWidth=u.width,h.originalHeight=u.height,n&&(u=x3dom.Utils.scaleImage(u)),1!=s&&1!=a||e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.bindTexture(e.TEXTURE_2D,h),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,u),r&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),1!=s&&1!=a||e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),h.width=u.width,h.height=u.height,h.ready=!0,t.decrementDownloads(),t.needRender=!0},u.onerror=function(s){x3dom.Utils.tryDDSLoading(h,e,t,i,r,a,d).then((function(){t.decrementDownloads(),t.needRender=!0}),(function(){x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.decrementDownloads(),f++,d&&f<d._vf.url.length&&(i=d._nameSpace.getURL(d._vf.url[f]),_())}))},h},x3dom.Utils.tryDDSLoading=function(e,t,i,s,o,n,r){return x3dom.DDSLoader.load(s).then((function(i){if(i&&(!i.isCompressed||x3dom.caps.COMPRESSED_TEXTURE)){for(var s in t.bindTexture(i.type,e),!1,x3dom.Utils.isPowerOfTwo(i.width)||x3dom.Utils.isPowerOfTwo(i.height)?i.generateMipmaps&&t.texParameteri(i.type,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR):(t.texParameteri(i.type,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(i.type,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(i.type,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i.type,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i.generateMipmaps=!1),i.data)for(var o=i.width,n=i.height,a=i.data[s],d=0;d<a.length;d++)0!=d&&(o=Math.max(.5*o,1),n=Math.max(.5*n,1)),i.format.internal<33776||i.format.internal>33779?t.texImage2D(+s,d,i.format.internal,o,n,0,i.format.format,i.format.type,a[d]):(t.compressedTexImage2D(+s,d,i.format.internal,o,n,0,a[d]),i.generateMipmaps=!1);i.generateMipmaps&&t.generateMipmap(i.type),t.bindTexture(i.type,null),e.width=i.width,e.height=i.height,e.ready=!0,e.textureCubeReady=!0,r&&i.channelCount&&r.setOrigChannelCount(i.channelCount)}}))},x3dom.Utils.createTextureCube=function(e,t,i,s,o,n,r,a){var d,h=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]),l=e.createTexture();d=s?[e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X]:[e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_X],l.ready=!1,l.pendingTextureLoads=-1,l.textureCubeReady=!1;for(var f=0,u=0,_=0;_<d.length;_++)e.bindTexture(e.TEXTURE_CUBE_MAP,l),e.texImage2D(d[_],0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,h),e.bindTexture(e.TEXTURE_CUBE_MAP,null);if(1==i.length)t.incrementDownloads(),x3dom.Utils.tryDDSLoading(l,e,t,i[0],r,a).then((function(){t.decrementDownloads(),t.needRender=!0}),(function(){x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+i),t.decrementDownloads()}));else if(6==i.length)for(_=0;_<d.length;_++){var c=d[_],m=new Image;switch(o.toLowerCase()){case"anonymous":m.crossOrigin="anonymous";break;case"use-credentials":m.crossOrigin="use-credentials";break;case"none":break;default:x3dom.Utils.forbiddenBySOP(i[_])&&(m.crossOrigin="anonymous")}l.pendingTextureLoads++,t.incrementDownloads(),m.onload=function(i,s,o,a){return function(){0==f&&0==u?(f=o.width,u=o.height):!n||f==o.width&&u==o.height||(x3dom.debug.logWarning("[Utils|createTextureCube] Rescaling CubeMap images, which are of different size!"),o=x3dom.Utils.rescaleImage(o,f,u)),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a),e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.texImage2D(s,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),e.bindTexture(e.TEXTURE_CUBE_MAP,null),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),i.pendingTextureLoads--,t.decrementDownloads(),i.pendingTextureLoads<0&&(i.width=f,i.height=u,i.textureCubeReady=!0,r&&(e.bindTexture(e.TEXTURE_CUBE_MAP,i),e.generateMipmap(e.TEXTURE_CUBE_MAP),e.bindTexture(e.TEXTURE_CUBE_MAP,null)),x3dom.debug.logInfo("[Utils|createTextureCube] Loading CubeMap finished..."),t.needRender=!0)}}(l,c,m,s),m.onerror=function(){t.decrementDownloads(),x3dom.debug.logError("[Utils|createTextureCube] Can't load CubeMap!")},m.src=i[_]}return l},x3dom.Utils.detectChannelCount=function(e,t){switch(t){case"image/jpeg":return x3dom.Utils.detectChannelCountJPG(e);case"image/png":return x3dom.Utils.detectChannelCountPNG(e);case"image/gif":return x3dom.Utils.detectChannelCountGIF(e)}},x3dom.Utils.detectChannelCountJPG=function(e){if(255==e[0]&&216==e[1])for(var t=2,i=new DataView(e.buffer,e.byteOffset,e.byteLength);t+4<e.byteLength;)if(255==e[t]){var s=e[t+1];if(255!=e[t+=2]){var o=i.getUint16(t);if(t+o>e.byteLength)return;if(o>=7&&(192==s||194==s))return e[t+7];t+=o}}else t+=1},x3dom.Utils.detectChannelCountPNG=function(e){if(!(e.byteLength<29)&&137==e[0]&&80==e[1]&&78==e[2]&&71==e[3]&&13==e[4]&&10==e[5]&&26==e[6]&&10==e[7]&&73==e[12]&&72==e[13]&&68==e[14]&&82==e[15])return 0==e[25]?1:2==e[25]?3:4==e[25]?2:6==e[25]?4:void 0},x3dom.Utils.detectChannelCountGIF=function(e){if(71==e[0]&&73==e[1]&&70==e[2]&&56==e[3]&&(55==e[4]||57==e[4])&&97==e[5]&&1&e[10]){for(var t=224&e[10],i=13;i<t;i+=3)if(e[i]!=e[i+1]||e[i]!=e[i+2]||e[i+1]!=e[i+2])return 3;return 1}},x3dom.Utils.initFBO=function(e,t,i,s,o,n,r){var a=e.createTexture();a.width=t,a.height=i,e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,s,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var d,h=null;if(x3dom.caps.DRAW_BUFFERS&&void 0!==r)for(h=[a],d=1;d<r;d++)h[d]=e.createTexture(),h[d].width=t,h[d].height=i,e.bindTexture(e.TEXTURE_2D,h[d]),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,s,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null);var l=e.createFramebuffer(),f=null,u=null;if(n&&(null!==x3dom.caps.DEPTH_TEXTURE?(f=e.createTexture(),e.bindTexture(e.TEXTURE_2D,f),e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,t,i,0,e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,null),o&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),f.width=t,f.height=i):(u=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,u),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.bindRenderbuffer(e.RENDERBUFFER,null))),e.bindFramebuffer(e.FRAMEBUFFER,l),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,a,0),x3dom.caps.DRAW_BUFFERS&&void 0!==r)for(d=1;d<r;d++)e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+d,e.TEXTURE_2D,h[d],0);n&&null!==x3dom.caps.DEPTH_TEXTURE?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,f,0):e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,u);var _=e.checkFramebufferStatus(e.FRAMEBUFFER);return _!=e.FRAMEBUFFER_COMPLETE&&x3dom.debug.logWarning("[Utils|InitFBO] FBO-Status: "+_),e.bindFramebuffer(e.FRAMEBUFFER,null),{fbo:l,dtex:f,rbo:u,tex:a,texTargets:h,width:t,height:i,type:s,mipMap:o}},x3dom.Utils.getFileName=function(e){return e.lastIndexOf("/")>-1?e.substr(e.lastIndexOf("/")+1):e.lastIndexOf("\\")>-1?e.substr(e.lastIndexOf("\\")+1):e},x3dom.Utils.isWebGL2Enabled=function(){var e=document.createElement("canvas");return!!(e.getContext("webgl2")||e.getContext("experimental-webgl2"))},x3dom.Utils.findTextureByName=function(e,t){for(var i=0;i<e.length;++i)if(t==e[i].samplerName)return e[i];return!1},x3dom.Utils.rescaleImage=function(e,t,i){var s=document.createElement("canvas");return s.width=t,s.height=i,s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,s.width,s.height),s},x3dom.Utils.scaleImage=function(e){if(!x3dom.Utils.isPowerOfTwo(e.width)||!x3dom.Utils.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=x3dom.Utils.nextHighestPowerOfTwo(e.width),t.height=x3dom.Utils.nextHighestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e},x3dom.Utils.isPowerOfTwo=function(e){return 0==(e&e-1)},x3dom.Utils.nextHighestPowerOfTwo=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},x3dom.Utils.nextBestPowerOfTwo=function(e){var t=Math.log(e)/.693147180559945;return Math.pow(2,Math.round(t))},x3dom.Utils.getDataTypeSize=function(e){switch(e){case"Int8":case"Uint8":return 1;case"Int16":case"Uint16":return 2;case"Int32":case"Uint32":case"Float32":return 4;case"Float64":default:return 8}},x3dom.Utils.getOffsetMultiplier=function(e,t){switch(e){case t.UNSIGNED_SHORT:return 1;case t.UNSIGNED_INT:return 2;case t.UNSIGNED_BYTE:return.5;default:return 1}},x3dom.Utils.getByteAwareOffset=function(e,t,i){switch(t){case i.UNSIGNED_SHORT:return 2*e;case i.UNSIGNED_INT:return 4*e;case i.UNSIGNED_BYTE:return e;default:return 2*e}},x3dom.Utils.getVertexAttribType=function(e,t){var i=t.NONE;switch(e){case"Int8":i=t.BYTE;break;case"Uint8":i=t.UNSIGNED_BYTE;break;case"Int16":i=t.SHORT;break;case"Uint16":i=t.UNSIGNED_SHORT;break;case"Int32":i=t.INT;break;case"Uint32":i=t.UNSIGNED_INT;break;case"Float32":i=t.FLOAT;break;case"Float64":default:x3dom.debug.logError("Can't find this.gl data type for "+e+", getting FLOAT..."),i=t.FLOAT}return i},x3dom.Utils.getArrayBufferView=function(e,t){var i=null;switch(e){case"Int8":i=new Int8Array(t);break;case"Uint8":i=new Uint8Array(t);break;case"Int16":i=new Int16Array(t);break;case"Uint16":i=new Uint16Array(t);break;case"Int32":i=new Int32Array(t);break;case"Uint32":i=new Uint32Array(t);break;case"Float32":i=new Float32Array(t);break;case"Float64":i=new Float64Array(t);break;default:x3dom.debug.logError("Can't create typed array view of type "+e+", trying Float32..."),i=new Float32Array(t)}return i},x3dom.Utils.isUnsignedType=function(e){return"Uint8"==e||"Uint16"==e||"Uint16"==e||"Uint32"==e},x3dom.Utils.checkDirtyLighting=function(e){return e.getLights().length+e._scene.getNavigationInfo()._vf.headlight},x3dom.Utils.checkDirtyPhysicalEnvironmentLight=function(e,t){return!!t.PHYSICALENVLIGHT!=e.hasPhysicalEnvironmentLight()},x3dom.Utils.checkDirtyEnvironment=function(e,t){var i=e._scene.getEnvironment();return t.GAMMACORRECTION!=i._vf.gammaCorrectionDefault},x3dom.Utils.minFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":return e.LINEAR;case"NEAREST_MIPMAP_NEAREST":return e.NEAREST_MIPMAP_NEAREST;case"NEAREST_MIPMAP_LINEAR":return e.NEAREST_MIPMAP_LINEAR;case"LINEAR_MIPMAP_NEAREST":return e.LINEAR_MIPMAP_NEAREST;case"LINEAR_MIPMAP_LINEAR":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL":return e.LINEAR;case"AVG_PIXEL_AVG_MIPMAP":return e.LINEAR_MIPMAP_LINEAR;case"AVG_PIXEL_NEAREST_MIPMAP":return e.LINEAR_MIPMAP_NEAREST;case"DEFAULT":return e.LINEAR_MIPMAP_LINEAR;case"FASTEST":case"NEAREST_PIXEL":return e.NEAREST;case"NEAREST_PIXEL_AVG_MIPMAP":return e.NEAREST_MIPMAP_LINEAR;case"NEAREST_PIXEL_NEAREST_MIPMAP":return e.NEAREST_MIPMAP_NEAREST;case"NICEST":return e.LINEAR_MIPMAP_LINEAR;default:return e.LINEAR}},x3dom.Utils.minFilterDicX3D=function(e){switch(e){case 9728:return"NEAREST";case 9729:return"LINEAR";case 9984:return"NEAREST_MIPMAP_NEAREST";case 9985:return"LINEAR_MIPMAP_NEAREST";case 9986:return"NEAREST_MIPMAP_LINEAR";case 9987:default:return"LINEAR_MIPMAP_LINEAR"}},x3dom.Utils.magFilterDic=function(e,t){switch(t.toUpperCase()){case"NEAREST":return e.NEAREST;case"LINEAR":case"AVG_PIXEL":case"DEFAULT":return e.LINEAR;case"FASTEST":case"NEAREST_PIXEL":return e.NEAREST;case"NICEST":default:return e.LINEAR}},x3dom.Utils.magFilterDicX3D=function(e){switch(e){case 9728:return"NEAREST";case 9729:default:return"LINEAR"}},x3dom.Utils.boundaryModesDicX3D=function(e){switch(e){case 10497:return"REPEAT";case 33071:return"CLAMP_TO_EDGE";case 33648:return"MIRRORED_REPEAT";default:return"REPEAT"}},x3dom.Utils.boundaryModesDic=function(e,t){switch(t.toUpperCase()){case"CLAMP":case"CLAMP_TO_EDGE":case"CLAMP_TO_BOUNDARY":return e.CLAMP_TO_EDGE;case"MIRRORED_REPEAT":return e.MIRRORED_REPEAT;case"REPEAT":default:return e.REPEAT}},x3dom.Utils.primTypeDic=function(e,t){switch(t.toUpperCase()){case"POINTS":return e.POINTS;case"LINES":return e.LINES;case"LINELOOP":return e.LINE_LOOP;case"LINESTRIP":return e.LINE_STRIP;case"TRIANGLES":return e.TRIANGLES;case"TRIANGLESTRIP":return e.TRIANGLE_STRIP;case"TRIANGLEFAN":return e.TRIANGLE_FAN;default:return e.TRIANGLES}},x3dom.Utils.depthFunc=function(e,t){switch(t.toUpperCase()){case"NEVER":return e.NEVER;case"ALWAYS":return e.ALWAYS;case"LESS":return e.LESS;case"EQUAL":return e.EQUAL;case"LEQUAL":return e.LEQUAL;case"GREATER":return e.GREATER;case"GEQUAL":return e.GEQUAL;case"NOTEQUAL":return e.NOTEQUAL;default:return e.LEQUAL}},x3dom.Utils.blendFunc=function(e,t){switch(t.toLowerCase()){case"zero":return e.ZERO;case"one":return e.ONE;case"dst_color":return e.DST_COLOR;case"dst_alpha":return e.DST_ALPHA;case"src_color":return e.SRC_COLOR;case"src_alpha":return e.SRC_ALPHA;case"one_minus_dst_color":return e.ONE_MINUS_DST_COLOR;case"one_minus_dst_alpha":return e.ONE_MINUS_DST_ALPHA;case"one_minus_src_color":return e.ONE_MINUS_SRC_COLOR;case"one_minus_src_alpha":return e.ONE_MINUS_SRC_ALPHA;case"src_alpha_saturate":return e.SRC_ALPHA_SATURATE;case"constant_color":return e.CONSTANT_COLOR;case"constant_alpha":return e.CONSTANT_ALPHA;case"one_minus_constant_color":return e.ONE_MINUS_CONSTANT_COLOR;case"one_minus_constant_alpha":return e.ONE_MINUS_CONSTANT_ALPHA;default:return 0}},x3dom.Utils.blendEquation=function(e,t){switch(t.toLowerCase()){case"func_add":return e.FUNC_ADD;case"func_subtract":return e.FUNC_SUBTRACT;case"func_reverse_subtract":return e.FUNC_REVERSE_SUBTRACT;case"min":case"max":case"logic_op":default:return 0}},x3dom.Utils.generateProperties=function(e,t){var i={},s=t._cf.geometry.node,o=t._cf.appearance.node,n=o?o._cf.texture.node:null,r=o?o._cf.material.node:null,a=e._scene.getEnvironment();return o&&o._shader&&x3dom.isa(o._shader,x3dom.nodeTypes.ComposedShader)?i.CSHADER=o._shader._id:s&&(i.CSHADER=-1,i.APPMAT=o&&(r||i.CSSHADER)?1:0,i.SOLID=t.isSolid()?1:0,i.TEXT=x3dom.isa(s,x3dom.nodeTypes.Text)?1:0,i.POPGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.PopGeometry)?1:0,i.BUFFERGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.BufferGeometry)?1:0,i.BINARYGEOMETRY=x3dom.isa(s,x3dom.nodeTypes.BinaryGeometry)?1:0,i.POINTLINE2D=s.needLighting()?0:1,i.VERTEXID=i.BINARYGEOMETRY&&s._vf.idsPerVertex?1:0,i.IS_PARTICLE=x3dom.isa(s,x3dom.nodeTypes.ParticleSet)?1:0,i.POINTPROPERTIES=o&&o._cf.pointProperties.node?1:0,i.TANGENTDATA=s._mesh._tangents[0].length>0&&s._mesh._binormals[0].length>0?1:0,i.PBR_MATERIAL=i.APPMAT&&x3dom.isa(r,x3dom.nodeTypes.PhysicalMaterial)?1:0,i.TWOSIDEDMAT=i.APPMAT&&x3dom.isa(r,x3dom.nodeTypes.TwoSidedMaterial)?1:0,i.SEPARATEBACKMAT=i.TWOSIDEDMAT&&r._vf.separateBackColor?1:0,i.SHADOW=e.getLightsShadow()?1:0,i.FOG=e._scene.getFog()._vf.visibilityRange>0?1:0,i.CSSHADER=o&&o._shader&&x3dom.isa(o._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,i.LIGHTS=!i.POINTLINE2D&&o&&t.isLit()&&(r||i.CSSHADER)?e.getLights().length+e._scene.getNavigationInfo()._vf.headlight:0,i.TEXTURED=n||i.TEXT||i.CSSHADER&&o._shader.needTexcoords()||i.PBR_MATERIAL&&r.hasTextures()?1:0,i.CUBEMAP=n&&x3dom.isa(n,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&o._shader.getEnvironmentMap()?1:0,i.PIXELTEX=n&&x3dom.isa(n,x3dom.nodeTypes.PixelTexture)?1:0,i.TEXTRAFO=o&&o._cf.textureTransform.node?1:0,i.DIFFUSEMAP=n&&!x3dom.isa(n,x3dom.nodeTypes.X3DEnvironmentTextureNode)||i.CSSHADER&&o._shader.getDiffuseMap()||i.PBR_MATERIAL&&r._cf.baseColorTexture.node?1:0,i.NORMALMAP=i.CSSHADER&&o._shader.getNormalMap()||i.PBR_MATERIAL&&r._cf.normalTexture.node?1:0,i.SPECMAP=i.CSSHADER&&o._shader.getSpecularMap()?1:0,i.SHINMAP=i.CSSHADER&&o._shader.getShininessMap()?1:0,i.EMISSIVEMAP=i.PBR_MATERIAL&&r._cf.emissiveTexture.node?1:0,i.OCCLUSIONMAP=i.PBR_MATERIAL&&r._cf.occlusionTexture.node?1:0,i.DISPLACEMENTMAP=i.CSSHADER&&o._shader.getDisplacementMap()?1:0,i.DIFFPLACEMENTMAP=i.CSSHADER&&o._shader.getDiffuseDisplacementMap()?1:0,i.ALPHAMODE=i.PBR_MATERIAL?r._vf.alphaMode:"BLEND",i.ISROUGHNESSMETALLIC=i.PBR_MATERIAL&&"roughnessMetallic"==r._vf.model?1:0,i.ROUGHNESSMETALLICMAP=i.PBR_MATERIAL&&r._cf.roughnessMetallicTexture.node?1:0,i.SPECULARGLOSSINESSMAP=i.PBR_MATERIAL&&r._cf.specularGlossinessTexture.node?1:0,i.OCCLUSIONROUGHNESSMETALLICMAP=i.PBR_MATERIAL&&r._cf.occlusionRoughnessMetallicTexture.node?1:0,i.PHYSICALENVLIGHT=e.hasPhysicalEnvironmentLight()?1:0,i.NORMALSPACE=i.NORMALMAP&&i.CSSHADER?o._shader._vf.normalSpace.toUpperCase():i.NORMALMAP&&i.PBR_MATERIAL?r._vf.normalSpace.toUpperCase():"TANGENT",i.BLENDING=i.TEXT||i.CUBEMAP||i.CSSHADER||i.PBR_MATERIAL||n&&n._blending?1:0,i.REQUIREBBOX=void 0!==s._vf.coordType&&"Float32"!=s._vf.coordType?1:0,i.REQUIREBBOXNOR=void 0!==s._vf.normalType&&"Float32"!=s._vf.normalType?1:0,i.REQUIREBBOXCOL=void 0!==s._vf.colorType&&"Float32"!=s._vf.colorType?1:0,i.REQUIREBBOXTEX=void 0!==s._vf.texCoordType&&"Float32"!=s._vf.texCoordType?1:0,i.COLCOMPONENTS=s._mesh._numColComponents,i.NORCOMPONENTS=s._mesh._numNormComponents,i.POSCOMPONENTS=s._mesh._numPosComponents,i.SPHEREMAPPING=void 0!==s._cf.texCoord&&null!==s._cf.texCoord.node&&s._cf.texCoord.node._vf.mode&&"sphere"==s._cf.texCoord.node._vf.mode.toLowerCase()?1:0,i.VERTEXCOLOR=s._mesh._colors[0].length>0||i.POPGEOMETRY&&s.hasColor()||i.BUFFERGEOMETRY&&s.hasColor()||void 0!==s._vf.color&&s._vf.color.length>0?1:0,i.CLIPPLANES=t._clipPlanes.length,i.ALPHATHRESHOLD=o?o._vf.alphaClipThreshold.toFixed(2):.1,i.MULTITEXCOORD=i.BUFFERGEOMETRY&&s.hasMultiTexCoord()?1:0,i.DIFFUSEMAPCHANNEL=i.PBR_MATERIAL&&i.DIFFUSEMAP&&1===r._cf.baseColorTexture.node._vf.channel?1:0,i.NORMALMAPCHANNEL=i.PBR_MATERIAL&&i.NORMALMAP&&1===r._cf.normalTexture.node._vf.channel?1:0,i.EMISSIVEMAPCHANNEL=i.PBR_MATERIAL&&i.EMISSIVEMAP&&1===r._cf.emissiveTexture.node._vf.channel?1:0,i.OCCLUSIONMAPCHANNEL=i.PBR_MATERIAL&&i.OCCLUSIONMAP&&1===r._cf.occlusionTexture.node._vf.channel?1:0,i.ROUGHNESSMETALLICMAPCHANNEL=i.PBR_MATERIAL&&i.ROUGHNESSMETALLICMAP&&1===r._cf.roughnessMetallicTexture.node._vf.channel?1:0,i.OCCLUSIONROUGHNESSMETALLICMAPCHANNEL=i.PBR_MATERIAL&&i.OCCLUSIONROUGHNESSMETALLICMAP&&1===r._cf.occlusionRoughnessMetallicTexture.node._vf.channel?1:0,i.SPECULARGLOSSINESSMAPCHANNEL=i.PBR_MATERIAL&&i.SPECULARGLOSSINESSMAP&&1===r._cf.specularGlossinessTexture.node._vf.channel?1:0,i.ALPHAMASK=i.PBR_MATERIAL&&"MASK"==r._vf.alphaMode?1:0,i.UNLIT=i.PBR_MATERIAL&&r._vf.unlit?1:0,i.GAMMACORRECTION=a._vf.gammaCorrectionDefault,i.KHR_MATERIAL_COMMONS=0),i.toIdentifier=function(){delete this.id;var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=this[t]);return this.id=e,e},i.toString=function(){var e="";for(var t in this)this[t]!=this.toIdentifier&&this[t]!=this.toString&&(e+=t+": "+this[t]+", ");return e},i.toIdentifier(),i},x3dom.Utils.lerp=function(e,t,i){return e+(t-e)*(i=(i=i<0?0:i)>1?1:i)},x3dom.Utils.wrapProgram=function(e,t,i){var s,o,n={shaderID:i,program:t,bind:function(){e.useProgram(t)}},r=null,a=null,d=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(s=0;s<d;++s){try{a=e.getActiveUniform(t,s)}catch(e){if(!a)continue}switch((o=e.getError())&&x3dom.debug.logError("GL-Error (on searching uniforms): name="+a.name+" type="+a.type+" size="+a.size+" Err="+o),r=e.getUniformLocation(t,a.name),a.type){case e.SAMPLER_2D:case e.SAMPLER_CUBE:case e.BOOL:n.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(r));break;case e.FLOAT:-1!=a.name.indexOf("[0]")?n.__defineSetter__(a.name.substring(0,a.name.length-3),function(t){return function(i){e.uniform1fv(t,new Float32Array(i))}}(r)):n.__defineSetter__(a.name,function(t){return function(i){e.uniform1f(t,i)}}(r));break;case e.FLOAT_VEC2:n.__defineSetter__(a.name,function(t){return function(i){e.uniform2f(t,i[0],i[1])}}(r));break;case e.FLOAT_VEC3:-1!=a.name.indexOf("[0]")?n.__defineSetter__(a.name.substring(0,a.name.length-3),function(t){return function(i){e.uniform3fv(t,new Float32Array(i))}}(r)):n.__defineSetter__(a.name,function(t){return function(i){e.uniform3f(t,i[0],i[1],i[2])}}(r));break;case e.FLOAT_VEC4:n.__defineSetter__(a.name,function(t){return function(i){e.uniform4f(t,i[0],i[1],i[2],i[3])}}(r));break;case e.FLOAT_MAT2:n.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix2fv(t,!1,new Float32Array(i))}}(r));break;case e.FLOAT_MAT3:n.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix3fv(t,!1,new Float32Array(i))}}(r));break;case e.FLOAT_MAT4:n.__defineSetter__(a.name,function(t){return function(i){e.uniformMatrix4fv(t,!1,new Float32Array(i))}}(r));break;case e.INT:n.__defineSetter__(a.name,function(t){return function(i){e.uniform1i(t,i)}}(r));break;default:x3dom.debug.logWarning("GLSL program variable "+a.name+" has unknown type "+a.type)}}var h=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(s=0;s<h;++s){try{a=e.getActiveAttrib(t,s)}catch(e){if(!a)continue}(o=e.getError())&&x3dom.debug.logError("GL-Error (on searching attributes): name="+a.name+" type="+a.type+" size="+a.size+" Err="+o),r=e.getAttribLocation(t,a.name),n[a.name]=r}return n},x3dom.Utils.arrayBufferToJSON=function(e,t,i){var s,o,n,r,a,d;for(t=null!=t?t:0,s="",n=i=null!=i?i:e.length,o=t;o<n;)switch((r=e[o++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:s+=String.fromCharCode(r);break;case 12:case 13:a=e[o++],s+=String.fromCharCode((31&r)<<6|63&a);break;case 14:a=e[o++],d=e[o++],s+=String.fromCharCode((15&r)<<12|(63&a)<<6|(63&d)<<0)}return JSON.parse(s)},x3dom.Utils.arrayBufferToObjectURL=function(e,t){return URL.createObjectURL(new Blob([new Uint8Array(e)],{type:t}))},x3dom.Utils.dataURIToObjectURL=function(e){if(-1==e.indexOf("data:"))return e;for(var t=e.split(","),i=t[0].split(":")[1].split(";")[0],s=t[1],o=window.atob(s),n=o.length,r=new Uint8Array(n),a=0;a<n;a++)r[a]=o.charCodeAt(a);return URL.createObjectURL(new Blob([r],{type:i}))},x3dom.Utils.arrayBufferToDataURL=function(e,t){for(var i="",s=new Uint8Array(e),o=0;o<s.byteLength;o++)i+=String.fromCharCode(s[o]);return"data:"+t+";base64,"+window.btoa(i)},x3dom.Utils.forbiddenBySOP=function(e){var t,i,s,o,n,r=(e=e.toLowerCase()).split("//"),a=""===document.location.port?"80":document.location.port;return 2===r.length&&(t=r[0],n=(s=(1===(i=r[1].split("/")[0].split("?")[0].split("#")[0].split("@")).length?i[0]:i[1]).split(":"))[0],o=s[1]),o=o||a,n=n||document.location.host,t=t||document.location.protocol,!(o===a&&n===document.location.host&&t===document.location.protocol)},x3dom.States=function(e){var t=this;this.active=!1,this.viewer=document.createElement("div"),this.viewer.id="x3dom-state-viewer";var i=document.createElement("div");i.className="x3dom-states-head",i.appendChild(document.createTextNode("x3dom"));var s=document.createElement("span");s.className="x3dom-states-head2",s.appendChild(document.createTextNode("stats")),i.appendChild(s),this.renderMode=document.createElement("div"),this.renderMode.className="x3dom-states-rendermode-hardware",this.measureList=document.createElement("ul"),this.measureList.className="x3dom-states-list",this.infoList=document.createElement("ul"),this.infoList.className="x3dom-states-list",this.requestList=document.createElement("ul"),this.requestList.className="x3dom-states-list",this.viewer.appendChild(this.renderMode),this.viewer.appendChild(this.measureList),this.viewer.appendChild(this.infoList),this.viewer.appendChild(this.requestList),this.disableContextMenu=function(e){return e.preventDefault(),e.stopPropagation(),e.returnValue=!1,!1},this.thousandSeperator=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.toFixed=function(e){return e.toFixed(2)},this.addItem=function(e,t,i){var s=document.createElement("li");s.className="x3dom-states-item";var o=document.createElement("div");o.className="x3dom-states-item-title",o.appendChild(document.createTextNode(t));var n=document.createElement("div");n.className="x3dom-states-item-value",n.appendChild(document.createTextNode(i)),s.appendChild(o),s.appendChild(n),e.appendChild(s)},this.update=function(){if(e.runtime||void 0===this.updateMethodID){var t=e.runtime.states.infos,i=e.runtime.states.measurements,s=x3dom.caps.RENDERMODE;for(var o in"HARDWARE"==s?(this.renderMode.innerHTML="Hardware-Rendering",this.renderMode.className="x3dom-states-rendermode-hardware"):"SOFTWARE"==s&&(this.renderMode.innerHTML="Software-Rendering",this.renderMode.className="x3dom-states-rendermode-software"),this.measureList.innerHTML="",i)i.hasOwnProperty(o)&&this.addItem(this.measureList,o,this.toFixed(i[o]));for(var n in this.infoList.innerHTML="",t)t.hasOwnProperty(n)&&this.addItem(this.infoList,n,this.thousandSeperator(t[n]));this.requestList.innerHTML="",this.addItem(this.requestList,"#ACTIVE",x3dom.RequestManager.activeRequests.length),this.addItem(this.requestList,"#TOTAL",x3dom.RequestManager.totalRequests),this.addItem(this.requestList,"#LOADED",x3dom.RequestManager.loadedRequests),this.addItem(this.requestList,"#FAILED",x3dom.RequestManager.failedRequests)}else clearInterval(this.updateMethodID)},this.updateMethodID=window.setInterval((function(){t.update()}),1e3),this.viewer.addEventListener("contextmenu",t.disableContextMenu)},x3dom.States.prototype.display=function(e){this.active=void 0!==e?e:!this.active,this.viewer.style.display=this.active?"block":"none"},x3dom.StateManager=function(e){this.gl=e,this.states=[],this.initStates()},x3dom.StateManager.prototype.initStates=function(){this.states.shaderID=null,this.states.colorMask={red:null,green:null,blue:null,alpha:null},this.states.depthMask=null,this.states.stencilMask=null,this.states.cullFace=null,this.states.frontFace=null,this.states.lineWidth=null,this.states.blendColor={red:null,green:null,blue:null,alpha:null},this.states.blendEquation=null,this.states.blendEquationSeparate={modeRGB:null,modeAlpha:null},this.states.blendFunc={sfactor:null,dfactor:null},this.states.blendFuncSeparate={srcRGB:null,dstRGB:null,srcAlpha:null,dstAlpha:null},this.states.depthFunc=null,this.states.viewport={x:null,y:null,width:null,height:null},this.states.depthRange={zNear:null,zFar:null}},x3dom.StateManager.prototype.useProgram=function(e){return this.states.shaderID!=e.shaderID&&(this.gl.useProgram(e.program),this.states.shaderID=e.shaderID,!0)},x3dom.StateManager.prototype.unsetProgram=function(){this.states.shaderID=null},x3dom.StateManager.prototype.enable=function(e){!0!==this.states[e]&&(this.gl.enable(e),this.states[e]=!0)},x3dom.StateManager.prototype.disable=function(e){!1!==this.states[e]&&(this.gl.disable(e),this.states[e]=!1)},x3dom.StateManager.prototype.colorMask=function(e,t,i,s){this.states.colorMask.red==e&&this.states.colorMask.green==t&&this.states.colorMask.blue==i&&this.states.colorMask.alpha==s||(this.gl.colorMask(e,t,i,s),this.states.colorMask.red=e,this.states.colorMask.green=t,this.states.colorMask.blue=i,this.states.colorMask.alpha=s)},x3dom.StateManager.prototype.depthMask=function(e){this.states.depthMask!=e&&(this.gl.depthMask(e),this.states.depthMask=e)},x3dom.StateManager.prototype.stencilMask=function(e){this.states.stencilMask!=e&&(this.gl.stencilMask(e),this.states.stencilMask=e)},x3dom.StateManager.prototype.cullFace=function(e){this.states.cullFace!=e&&(this.gl.cullFace(e),this.states.cullFace=e)},x3dom.StateManager.prototype.frontFace=function(e){this.states.frontFace!=e&&(this.gl.frontFace(e),this.states.frontFace=e)},x3dom.StateManager.prototype.lineWidth=function(e){e=e<=1?1:e,this.states.lineWidth!=e&&(this.gl.lineWidth(e),this.states.lineWidth=e)},x3dom.StateManager.prototype.blendColor=function(e,t,i,s){this.states.blendColor.red==e&&this.states.blendColor.green==t&&this.states.blendColor.blue==i&&this.states.blendColor.alpha==s||(this.gl.blendColor(e,t,i,s),this.states.blendColor.red=e,this.states.blendColor.green=t,this.states.blendColor.blue=i,this.states.blendColor.alpha=s)},x3dom.StateManager.prototype.blendEquation=function(e){e&&this.states.blendEquation!=e&&(this.gl.blendEquation(e),this.states.blendEquation=e)},x3dom.StateManager.prototype.blendEquationSeparate=function(e,t){this.states.blendEquationSeparate.modeRGB==e&&this.states.blendEquationSeparate.modeAlpha==t||(this.gl.blendEquationSeparate(e,t),this.states.blendEquationSeparate.modeRGB=e,this.states.blendEquationSeparate.modeAlpha=t)},x3dom.StateManager.prototype.blendFunc=function(e,t){this.states.blendFunc.sfactor==e&&this.states.blendFunc.dfactor==t||(this.gl.blendFunc(e,t),this.states.blendFunc.sfactor=e,this.states.blendFunc.dfactor=t)},x3dom.StateManager.prototype.blendFuncSeparate=function(e,t,i,s){this.states.blendFuncSeparate.srcRGB==e&&this.states.blendFuncSeparate.dstRGB==t&&this.states.blendFuncSeparate.srcAlpha==i&&this.states.blendFuncSeparate.dstAlpha==s||(this.gl.blendFuncSeparate(e,t,i,s),this.states.blendFuncSeparate.srcRGB=e,this.states.blendFuncSeparate.dstRGB=t,this.states.blendFuncSeparate.srcAlpha=i,this.states.blendFuncSeparate.dstAlpha=s)},x3dom.StateManager.prototype.depthFunc=function(e){this.states.depthFunc!=e&&(this.gl.depthFunc(e),this.states.depthFunc=e)},x3dom.StateManager.prototype.depthRange=function(e,t){e<0||t<0||e>t||(e=e>1?1:e,t=t>1?1:t,this.states.depthRange.zNear==e&&this.states.depthRange.zFar==t||(this.gl.depthRange(e,t),this.states.depthRange.zNear=e,this.states.depthRange.zFar=t))},x3dom.StateManager.prototype.viewport=function(e,t,i,s){this.states.viewport.x==e&&this.states.viewport.y==t&&this.states.viewport.width==i&&this.states.viewport.height==s||(this.gl.viewport(e,t,i,s),this.states.viewport.x=e,this.states.viewport.y=t,this.states.viewport.width=i,this.states.viewport.height=s)},x3dom.StateManager.prototype.bindFramebuffer=function(e,t){this.gl.bindFramebuffer(e,t),this.initStates()},x3dom.BinaryContainerLoader={outOfMemory:!1,checkError:function(e){var t=e.getError();t&&(t==e.OUT_OF_MEMORY?(this.outOfMemory=!0,x3dom.debug.logError("GL-Error "+t+" on loading binary container (out of memory)."),console.error("WebGL: OUT_OF_MEMORY")):x3dom.debug.logError("GL-Error "+t+" on loading binary container."))}},x3dom.BinaryContainerLoader.setupBinGeo=function(e,t,i,s,o){if(!this.outOfMemory){var n=(new Date).getTime(),r=this,a=e._cf.geometry.node;e._webgl.binaryGeometry=-1,e._webgl.internalDownloadCount=(a._vf.index.length>0?1:0)+(a._hasStrideOffset&&a._vf.coord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.coord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.normal.length>0?1:0)+(!a._hasStrideOffset&&a._vf.texCoord.length>0?1:0)+(!a._hasStrideOffset&&a._vf.color.length>0?1:0);var d=0==a._vf.normalPerVertex||a._vf.index.length>0&&("Int32"==a._vf.indexType||"Uint32"==a._vf.indexType&&!x3dom.caps.INDEX_UINT);if(e._webgl.makeSeparateTris={index:null,coord:null,normal:null,texCoord:null,color:null,pushBuffer:function(t,i){this[t]=i,0==--e._webgl.internalDownloadCount&&(this.coord&&this.createMesh(),e._nameSpace.doc.needRender=!0),0==--e._nameSpace.doc.downloadCount&&(e._nameSpace.doc.needRender=!0)},createMesh:function(){var n=a;if(n._hasStrideOffset)x3dom.debug.logError(n._vf.indexType+" index type and per-face normals not supported for interleaved arrays.");else{for(var d=0;d<e._webgl.primType.length;d++)if(e._webgl.primType[d]==i.TRIANGLE_STRIP)return void x3dom.debug.logError("makeSeparateTris: triangle strips not yet supported for per-face normals.");var h,l,f=n._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(f,i),e._webgl.coordType!=i.FLOAT?(4==n._mesh._numPosComponents&&x3dom.Utils.isUnsignedType(n._vf.coordType)?x3dom.fields.SFVec3f.copy(n.getMin()):x3dom.fields.SFVec3f.copy(n._vf.position),h=x3dom.fields.SFVec3f.copy(n._vf.size),l=n.getPrecisionMax("coordType")):(new x3dom.fields.SFVec3f(0,0,0),h=new x3dom.fields.SFVec3f(1,1,1),l=1);var u=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(n._vf.coordType);u=0==u?3:u,x3dom.debug.logWarning("makeSeparateTris.createMesh called with coord length "+u),this.color&&u!=e._colorStrideOffset[0]/x3dom.Utils.getDataTypeSize(n._vf.colorType)&&(this.color=null,x3dom.debug.logWarning("Color format not supported."));var _=this.texCoord?e._texCoordStrideOffset[0]/x3dom.Utils.getDataTypeSize(n._vf.texCoordType):0;n._vf.normalType="Float32",e._webgl.normalType=i.FLOAT,n._mesh._numNormComponents=3,e._normalStrideOffset=[0,0];var c,m,p,x=[],v=[],g=[],y=[],S=this.index?this.index.length-2:this.coord.length/3-2;for(c=0;c<S;c+=3){m=u*(this.index?this.index[c]:c);var T=new x3dom.fields.SFVec3f(h.x*this.coord[m]/l,h.y*this.coord[m+1]/l,h.z*this.coord[m+2]/l);x.push(this.coord[m]),x.push(this.coord[m+1]),x.push(this.coord[m+2]),u>3&&x.push(this.coord[m+3]),this.color&&(y.push(this.color[m]),y.push(this.color[m+1]),y.push(this.color[m+2]),u>3&&y.push(this.color[m+3])),this.texCoord&&(p=_*(this.index?this.index[c]:c),g.push(this.texCoord[p]),g.push(this.texCoord[p+1]),_>3&&(g.push(this.texCoord[p+2]),g.push(this.texCoord[p+3]))),m=u*(this.index?this.index[c+1]:c+1);var F=new x3dom.fields.SFVec3f(h.x*this.coord[m]/l,h.y*this.coord[m+1]/l,h.z*this.coord[m+2]/l);x.push(this.coord[m]),x.push(this.coord[m+1]),x.push(this.coord[m+2]),u>3&&x.push(this.coord[m+3]),this.color&&(y.push(this.color[m]),y.push(this.color[m+1]),y.push(this.color[m+2]),u>3&&y.push(this.color[m+3])),this.texCoord&&(p=_*(this.index?this.index[c+1]:c+1),g.push(this.texCoord[p]),g.push(this.texCoord[p+1]),_>3&&(g.push(this.texCoord[p+2]),g.push(this.texCoord[p+3]))),m=u*(this.index?this.index[c+2]:c+2);var b=new x3dom.fields.SFVec3f(h.x*this.coord[m]/l,h.y*this.coord[m+1]/l,h.z*this.coord[m+2]/l);x.push(this.coord[m]),x.push(this.coord[m+1]),x.push(this.coord[m+2]),u>3&&x.push(this.coord[m+3]),this.color&&(y.push(this.color[m]),y.push(this.color[m+1]),y.push(this.color[m+2]),u>3&&y.push(this.color[m+3])),this.texCoord&&(p=_*(this.index?this.index[c+2]:c+2),g.push(this.texCoord[p]),g.push(this.texCoord[p+1]),_>3&&(g.push(this.texCoord[p+2]),g.push(this.texCoord[p+3])));var C=T.subtract(F),M=F.subtract(b),E=C.cross(M).normalize();for(m=0;m<3;m++)v.push(E.x),v.push(E.y),v.push(E.z)}var w=i.createBuffer();e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=w,i.bindBuffer(i.ARRAY_BUFFER,w),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(n._vf.coordType,x),i.STATIC_DRAW),i.vertexAttribPointer(t.position,n._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),w=i.createBuffer(),e._webgl.buffers[x3dom.BUFFER_IDX.NORMAL]=w,i.bindBuffer(i.ARRAY_BUFFER,w),i.bufferData(i.ARRAY_BUFFER,new Float32Array(v),i.STATIC_DRAW),i.vertexAttribPointer(t.normal,n._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal),this.texCoord&&(w=i.createBuffer(),e._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]=w,i.bindBuffer(i.ARRAY_BUFFER,w),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(n._vf.texCoordType,g),i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,n._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),this.color&&(w=i.createBuffer(),e._webgl.buffers[x3dom.BUFFER_IDX.COLOR]=w,i.bindBuffer(i.ARRAY_BUFFER,w),i.bufferData(i.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(n._vf.colorType,y),i.STATIC_DRAW),i.vertexAttribPointer(t.color,n._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),n._vf.vertexCount=[],n._vf.vertexCount[0]=x.length/u,n._mesh._numCoords=n._vf.vertexCount[0],n._mesh._numFaces=n._vf.vertexCount[0]/3,e._webgl.primType=[],e._webgl.primType[0]=i.TRIANGLES,x=null,v=null,g=null,y=null,this.index=null,this.coord=null,this.normal=null,this.texCoord=null,this.color=null,r.checkError(i),delete e._webgl.shader,e._webgl.shader=o.cache.getDynamicShader(i,s,e)}}},a._vf.index.length>0){e._webgl.binaryGeometry=1;var h=new XMLHttpRequest;h.open("GET",e._nameSpace.getURL(a._vf.index),!0),h.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(h),h.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==h.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var t=h.response,s=a,o=s._vf.indexType,l=x3dom.Utils.getArrayBufferView(o,t);if(d)e._webgl.makeSeparateTris.pushBuffer("index",l);else{var f=i.createBuffer();x3dom.caps.INDEX_UINT&&"Uint32"==o?e._webgl.indexType=i.UNSIGNED_INT:e._webgl.indexType=i.UNSIGNED_SHORT,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,f),i.bufferData(i.ELEMENT_ARRAY_BUFFER,l,i.STATIC_DRAW),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),0==s._vf.vertexCount[0]&&(s._vf.vertexCount[0]=l.length),s._mesh._numFaces=0;for(var u=0;u<s._vf.vertexCount.length;u++)e._webgl.primType[u]==i.TRIANGLE_STRIP?s._mesh._numFaces+=s._vf.vertexCount[u]-2:s._mesh._numFaces+=s._vf.vertexCount[u]/3;l=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var _=(new Date).getTime()-n;x3dom.debug.logInfo("XHR0/ index load time: "+_+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.INDEX]=f}}}else x3dom.debug.logError("XHR1/ index load failed with status: "+h.status)}}if(a._hasStrideOffset&&a._vf.coord.length>0){var l=new XMLHttpRequest;l.open("GET",e._nameSpace.getURL(a._vf.coord),!0),l.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(l),l.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==l.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var s=l.response,o=a,d=o._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(d,i),e._webgl.normalType=e._webgl.coordType,e._webgl.texCoordType=e._webgl.coordType,e._webgl.colorType=e._webgl.coordType;var h=x3dom.Utils.getArrayBufferView(d,s),f=e._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(d);if(f&&(o._mesh._numCoords=h.length/f),0==o._vf.index.length)for(var u=0;u<o._vf.vertexCount.length;u++)e._webgl.primType[u]==i.TRIANGLE_STRIP?o._mesh._numFaces+=o._vf.vertexCount[u]-2:o._mesh._numFaces+=o._vf.vertexCount[u]/3;var _=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.vertexAttribPointer(t.position,o._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),o._vf.normal.length>0&&(e._webgl.buffers[x3dom.BUFFER_IDX.NORMAL]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.vertexAttribPointer(t.normal,o._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),o._vf.texCoord.length>0&&(e._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.vertexAttribPointer(t.texcoord,o._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),o._vf.color.length>0&&(e._webgl.buffers[x3dom.BUFFER_IDX.COLOR]=_,i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW),i.vertexAttribPointer(t.color,o._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),h=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var c=(new Date).getTime()-n;x3dom.debug.logInfo("XHR/ interleaved array load time: "+c+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=_}}else x3dom.debug.logError("XHR1/ interleaved array load failed with status: "+l.status)}}if(!a._hasStrideOffset&&a._vf.coord.length>0){var f=new XMLHttpRequest;f.open("GET",e._nameSpace.getURL(a._vf.coord),!0),f.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(f),f.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==f.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var s=f.response,o=a,h=0,l=o._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(l,i);var u=x3dom.Utils.getArrayBufferView(l,s);if(d)e._webgl.makeSeparateTris.pushBuffer("coord",u);else{i.bindAttribLocation(t.program,0,"position");var _=i.createBuffer();if(i.bindBuffer(i.ARRAY_BUFFER,_),i.bufferData(i.ARRAY_BUFFER,u,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o._mesh._numCoords=u.length/o._mesh._numPosComponents,0==o._vf.index.length)for(h=0;h<o._vf.vertexCount.length;h++)e._webgl.primType[h]==i.TRIANGLE_STRIP?o._mesh._numFaces+=o._vf.vertexCount[h]-2:o._mesh._numFaces+=o._vf.vertexCount[h]/3;if("Float32"==l&&(e._vf.bboxSize.x<0||e._vf.bboxSize.y<0||e._vf.bboxSize.z<0)){var c=new x3dom.fields.SFVec3f(u[0],u[1],u[2]),m=new x3dom.fields.SFVec3f(u[0],u[1],u[2]);for(h=3;h<u.length;h+=3)c.x>u[h+0]&&(c.x=u[h+0]),c.y>u[h+1]&&(c.y=u[h+1]),c.z>u[h+2]&&(c.z=u[h+2]),m.x<u[h+0]&&(m.x=u[h+0]),m.y<u[h+1]&&(m.y=u[h+1]),m.z<u[h+2]&&(m.z=u[h+2]);e._vf.bboxCenter.setValues(c.add(m).multiply(.5)),e._vf.bboxSize.setValues(m.subtract(c))}u=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var p=(new Date).getTime()-n;x3dom.debug.logInfo("XHR1/ coord load time: "+p+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=_}}}else x3dom.debug.logError("XHR1/ coord load failed with status: "+f.status)}}if(!a._hasStrideOffset&&a._vf.normal.length>0){var u=new XMLHttpRequest;u.open("GET",e._nameSpace.getURL(a._vf.normal),!0),u.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(u),u.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==u.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var t=u.response,s=a._vf.normalType;e._webgl.normalType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)e._webgl.makeSeparateTris.pushBuffer("normal",o);else{var h=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,h),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var l=(new Date).getTime()-n;x3dom.debug.logInfo("XHR2/ normal load time: "+l+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.NORMAL]=h}}}else x3dom.debug.logError("XHR2/ normal load failed with status: "+u.status)}}if(!a._hasStrideOffset&&a._vf.texCoord.length>0){var _=new XMLHttpRequest;_.open("GET",e._nameSpace.getURL(a._vf.texCoord),!0),_.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(_),_.onload=function(){var t,s;if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==_.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var o=_.response,h=a._vf.texCoordType;e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(h,i);var l=x3dom.Utils.getArrayBufferView(h,o);if(d)e._webgl.makeSeparateTris.pushBuffer("texCoord",l);else{if(a._vf.idsPerVertex){var f=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,f);var u=x3dom.Utils.getArrayBufferView("Float32",l.length/2);for(t=0,s=0;t<l.length;t+=2,s++)u[s]=65536*l[t+1]+l[t];i.bufferData(i.ARRAY_BUFFER,u,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[x3dom.BUFFER_IDX.ID]=f}else{var c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,l,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),e._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]=c}l=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var m=(new Date).getTime()-n;x3dom.debug.logInfo("XHR3/ texCoord load time: "+m+" ms")}}}else x3dom.debug.logError("XHR3/ texcoord load failed with status: "+_.status)}}if(!a._hasStrideOffset&&a._vf.color.length>0){var c=new XMLHttpRequest;c.open("GET",e._nameSpace.getURL(a._vf.color),!0),c.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(c),c.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==c.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var t=c.response,s=a._vf.colorType;e._webgl.colorType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)e._webgl.makeSeparateTris.pushBuffer("color",o);else{var h=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,h),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var l=(new Date).getTime()-n;x3dom.debug.logInfo("XHR4/ color load time: "+l+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.COLOR]=h}}}else x3dom.debug.logError("XHR4/ color load failed with status: "+c.status)}}if(!a._hasStrideOffset&&a._vf.tangent.length>0){var m=new XMLHttpRequest;m.open("GET",e._nameSpace.getURL(a._vf.normal),!0),m.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(m),m.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==m.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var t=m.response,s=a._vf.tangentType;e._webgl.tangentType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)e._webgl.makeSeparateTris.pushBuffer("tangent",o);else{var h=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,h),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var l=(new Date).getTime()-n;x3dom.debug.logInfo("XHR5/ normal load time: "+l+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.TANGENT]=h}}}else x3dom.debug.logError("XHR2/ normal load failed with status: "+m.status)}}if(!a._hasStrideOffset&&a._vf.binormal.length>0){var p=new XMLHttpRequest;p.open("GET",e._nameSpace.getURL(a._vf.normal),!0),p.responseType="arraybuffer",e._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(p),p.onload=function(){if(e._nameSpace.doc.decrementDownloads(),e._webgl.internalDownloadCount-=1,200==p.status){if(e._webgl)if(a._vf.compressed)x3dom.debug.logError("x3dom 1.8.2+ do not support compressed BinaryGeometries anymore");else{var t=p.response,s=a._vf.binormalType;e._webgl.binormalType=x3dom.Utils.getVertexAttribType(s,i);var o=x3dom.Utils.getArrayBufferView(s,t);if(d)e._webgl.makeSeparateTris.pushBuffer("binormal",o);else{var h=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,h),i.bufferData(i.ARRAY_BUFFER,o,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null),o=null,0==e._webgl.internalDownloadCount&&(e._nameSpace.doc.needRender=!0),r.checkError(i);var l=(new Date).getTime()-n;x3dom.debug.logInfo("XHR6/ normal load time: "+l+" ms"),e._webgl.buffers[x3dom.BUFFER_IDX.BITANGENT]=h}}}else x3dom.debug.logError("XHR6/ normal load failed with status: "+p.status)}}}},x3dom.BinaryContainerLoader.setupPopGeo=function(e,t,i,s,o){if(!this.outOfMemory){var n=e._cf.geometry.node;if(n.hasIndex()){e._webgl.popGeometry=1,e._webgl.buffers[x3dom.BUFFER_IDX.INDEX]=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),i.bufferData(i.ELEMENT_ARRAY_BUFFER,2*n.getTotalNumberOfIndices(),i.STATIC_DRAW),e._webgl.buffers[x3dom.BUFFER_IDX.ID]=i.createBuffer();var r=new Float32Array(n._vf.vertexBufferSize);!function(){for(var e=0;e<r.length;++e)r[e]=e}(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[x3dom.BUFFER_IDX.ID]),i.bufferData(i.ARRAY_BUFFER,r,i.STATIC_DRAW)}else e._webgl.popGeometry=-1;e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),i.bufferData(i.ARRAY_BUFFER,n._vf.attributeStride*n._vf.vertexBufferSize,i.STATIC_DRAW);var a=n._vf.coordType;e._webgl.coordType=x3dom.Utils.getVertexAttribType(a,i),e._coordStrideOffset[0]=n.getAttributeStride(),e._coordStrideOffset[1]=n.getPositionOffset(),i.vertexAttribPointer(t.position,e._cf.geometry.node._mesh._numPosComponents,e._webgl.coordType,!1,e._coordStrideOffset[0],e._coordStrideOffset[1]),i.enableVertexAttribArray(t.position),n.hasNormal()&&(a=n._vf.normalType,e._webgl.normalType=x3dom.Utils.getVertexAttribType(a,i),e._normalStrideOffset[0]=n.getAttributeStride(),e._normalStrideOffset[1]=n.getNormalOffset(),e._webgl.buffers[x3dom.BUFFER_IDX.NORMAL]=e._webgl.buffers[x3dom.BUFFER_IDX.POSITION],i.vertexAttribPointer(t.normal,e._cf.geometry.node._mesh._numNormComponents,e._webgl.normalType,!1,e._normalStrideOffset[0],e._normalStrideOffset[1]),i.enableVertexAttribArray(t.normal)),n.hasTexCoord()&&(a=n._vf.texCoordType,e._webgl.texCoordType=x3dom.Utils.getVertexAttribType(a,i),e._webgl.buffers[x3dom.BUFFER_IDX.TEXCOORD]=e._webgl.buffers[x3dom.BUFFER_IDX.POSITION],e._texCoordStrideOffset[0]=n.getAttributeStride(),e._texCoordStrideOffset[1]=n.getTexCoordOffset(),i.vertexAttribPointer(t.texcoord,e._cf.geometry.node._mesh._numTexComponents,e._webgl.texCoordType,!1,e._texCoordStrideOffset[0],e._texCoordStrideOffset[1]),i.enableVertexAttribArray(t.texcoord)),n.hasColor()&&(a=n._vf.colorType,e._webgl.colorType=x3dom.Utils.getVertexAttribType(a,i),e._webgl.buffers[x3dom.BUFFER_IDX.COLOR]=e._webgl.buffers[x3dom.BUFFER_IDX.POSITION],e._colorStrideOffset[0]=n.getAttributeStride(),e._colorStrideOffset[1]=n.getColorOffset(),i.vertexAttribPointer(t.color,e._cf.geometry.node._mesh._numColComponents,e._webgl.colorType,!1,e._colorStrideOffset[0],e._colorStrideOffset[1]),i.enableVertexAttribArray(t.color)),e._webgl.currentNumIndices=0,e._webgl.currentNumVertices=0,e._webgl.numVerticesAtLevel=[],e._webgl.levelsAvailable=0,this.checkError(i),e._webgl.levelLoaded=[],function(){for(var t=0;t<n.getNumLevels();++t)e._webgl.levelLoaded.push(!1)}();var d=function(t,s){if(e._webgl.levelLoaded[s]=!0,e._webgl.numVerticesAtLevel[s]=0,t){var o=0,r=!1;if(n.hasIndex()&&(o=2*n.getNumIndicesByLevel(s))>0){r=!0;var a=new Uint8Array(t,0,o);i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e._webgl.buffers[x3dom.BUFFER_IDX.INDEX]),function(){for(var e=0,t=0;t<s;++t)e+=n.getNumIndicesByLevel(t);i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,2*e,a)}()}var d=t.byteLength-o;if(d>0){r=!0;var h=new Uint8Array(t,o,d);i.bindBuffer(i.ARRAY_BUFFER,e._webgl.buffers[x3dom.BUFFER_IDX.POSITION]),n.hasIndex()?i.bufferSubData(i.ARRAY_BUFFER,n.getVertexDataBufferOffset(s)*n.getAttributeStride(),h):i.bufferSubData(i.ARRAY_BUFFER,e._webgl.currentNumVertices*n.getAttributeStride(),h),e._webgl.numVerticesAtLevel[s]=d/n.getAttributeStride(),e._webgl.currentNumVertices+=e._webgl.numVerticesAtLevel[s]}!function(){for(var t=0,i=e._webgl.levelsAvailable;i<n.getNumLevels()&&!1!==e._webgl.levelLoaded[i];++i)t+=n.getNumIndicesByLevel(i),++e._webgl.levelsAvailable;e._webgl.currentNumIndices=t}(),n._mesh._numCoords=e._webgl.currentNumVertices,n._mesh._numFaces=(n.hasIndex()?e._webgl.currentNumIndices:e._webgl.currentNumVertices)/3,n.adaptVertexCount(n.hasIndex()?3*n._mesh._numFaces:n._mesh._numCoords),r&&(e._nameSpace.doc.needRender=!0)}},h=n.getDataURLs();e._webgl.downloadStartTimer=(new Date).getTime();for(var l=0;l<h.length;++l){e._nameSpace.doc.incrementDownloads();var f=new XMLHttpRequest;f.responseType="arraybuffer",f.open("GET",h[l]),f.onload=function(t,i){e._nameSpace.doc.decrementDownloads(),d(t.response,i)}.bind(this,f,l),x3dom.RequestManager.addRequest(f)}}},x3dom.BinaryContainerLoader.bufferGeoCache={},x3dom.BinaryContainerLoader.setupBufferGeo=function(e,t,i,s,o){var n,r=e._cf.geometry.node,a=null,d=null,h=!0;e._webgl.bufferGeometry=r._indexed?1:-1,r._mesh._numCoords=r._vf.vertexCount[0],r._mesh._numFaces=r._vf.vertexCount[0]/3;var l=function(t){if(0!=h){var s=function(e){var t;if(d){var i=r._cf.views.nodes[d._vf.view],s=d._vf.byteOffset+i._vf.byteOffset,o=d._vf.count*d._vf.components;t=x3dom.BinaryContainerLoader.getArrayBufferFromType(d._vf.componentType,e,s,o)}return t}(t),o=function(e){var t;if(a){var i=r._cf.views.nodes[a._vf.view],s=a._vf.byteOffset+i._vf.byteOffset,o=a._vf.count*a._vf.components;t=x3dom.BinaryContainerLoader.getArrayBufferFromType(a._vf.componentType,e,s,o)}return t}(t),n=new Float32Array(3*d._vf.count),l=new x3dom.fields.SFVec3f,f=new x3dom.fields.SFVec3f,u=new x3dom.fields.SFVec3f,_=new x3dom.fields.SFVec3f,c=new x3dom.fields.SFVec3f;if(o)for(var m,p,x,v=0;v<o.length;v+=3)m=3*o[v],p=3*o[v+1],x=3*o[v+2],l.set(s[m],s[m+1],s[m+2]),f.set(s[p],s[p+1],s[p+2]),u.set(s[x],s[x+1],s[x+2]),_=_.subtractVectors(l,f),c=(c=(c=c.subtractVectors(u,f)).cross(_)).normalize(),n[m]=n[p]=n[x]=c.x,n[m+1]=n[p+1]=n[x+1]=c.y,n[m+2]=n[p+2]=n[x+2]=c.z;else if(s)for(v=0;v<s.length;v+=9)l.set(s[v],s[v+1],s[v+2]),f.set(s[v+3],s[v+4],s[v+5]),u.set(s[v+6],s[v+7],s[v+8]),_=_.subtractVectors(l,f),c=(c=(c=c.subtractVectors(u,f)).cross(_)).normalize(),n[v]=n[v+3]=n[v+6]=c.x,n[v+1]=n[v+4]=n[v+7]=c.y,n[v+2]=n[v+5]=n[v+8]=c.z;var g=i.createBuffer();i.bindBuffer(34962,g),i.bufferData(34962,n,i.STATIC_DRAW),i.bindBuffer(34962,null),e._webgl.buffers[x3dom.BUFFER_IDX.NORMAL]=g,e._normalStrideOffset=[12,0],e._webgl.normalType=5126,r._mesh._numNormComponents=3}};""!=r._vf.buffer&&(n=e._nameSpace.getURL(r._vf.buffer),null==x3dom.BinaryContainerLoader.bufferGeoCache[n]&&(e._nameSpace.doc.incrementDownloads(),x3dom.BinaryContainerLoader.bufferGeoCache[n]={},x3dom.BinaryContainerLoader.bufferGeoCache[n].buffers=[],x3dom.BinaryContainerLoader.bufferGeoCache[n].shapes=[],x3dom.BinaryContainerLoader.bufferGeoCache[n].decrementDownload=!0,x3dom.BinaryContainerLoader.bufferGeoCache[n].promise=new Promise((function(e,t){var i=new XMLHttpRequest;i.open("GET",n),i.responseType="arraybuffer",i.onload=function(s){200!=i.status?t():e(i.response)},i.onerror=function(e){t()},x3dom.RequestManager.addRequest(i)}))),x3dom.BinaryContainerLoader.bufferGeoCache[n].promise.then((function(t){null!=e._webgl?(!function(e){for(var t=r._cf.views.nodes,s=0;s<t.length;s++){var o=t[s],a=o._vf.id,d=o._vf.byteOffset,h=o._vf.byteLength;if(null==x3dom.BinaryContainerLoader.bufferGeoCache[n].buffers[a]||!i.isBuffer(x3dom.BinaryContainerLoader.bufferGeoCache[n].buffers[a])){var l=new Uint8Array(e,d,h),f=i.createBuffer();i.bindBuffer(o._vf.target,f),i.bufferData(o._vf.target,l,i.STATIC_DRAW),i.bindBuffer(o._vf.target,null),x3dom.BinaryContainerLoader.bufferGeoCache[n].buffers[a]=f}}}(t),function(){for(var t=r._cf.accessors.nodes,i=0;i<t.length;i++){var s=t[i],o=s._vf.byteOffset,l=s._vf.byteStride,f=s._vf.bufferType,u=s._vf.components,_=s._vf.componentType,c=s._vf.normalized,m=s._vf.view;switch(f){case"INDEX":a=s,e._webgl.indexType=_,e._indexOffset=o;break;case"POSITION":d=s,e._coordStrideOffset=[l,o],e._webgl.coordType=_,e._webgl.coordNormalized=c,r._mesh._numPosComponents=u;break;case"NORMAL":h=!1,e._normalStrideOffset=[l,o],e._webgl.normalType=_,e._webgl.normalNormalized=c,r._mesh._numNormComponents=u;break;case"TEXCOORD_0":case"TEXCOORD":e._texCoordStrideOffset=[l,o],e._webgl.texCoordType=_,e._webgl.texCoordNormalized=c,r._mesh._numTexComponents=u;break;case"TEXCOORD_1":e._texCoord2StrideOffset=[l,o],e._webgl.texCoord2Type=_,e._webgl.texCoord2Normalized=c,r._mesh._numTex2Components=u;break;case"COLOR":case"COLOR_0":e._colorStrideOffset=[l,o],e._webgl.colorType=_,e._webgl.colorNormalized=c,r._mesh._numColComponents=u;break;case"TANGENT":e._tangentStrideOffset=[l,o],e._webgl.tangentType=_,e._webgl.tangentNormalized=c,r._mesh._numTangentComponents=u;break;case"BITANGENT":e._binormalStrideOffset=[l,o],e._webgl.binormalType=_,e._webgl.binormalNormalized=c,r._mesh._numBinormalComponents=u}var p=x3dom.BUFFER_IDX[s._vf.bufferType],x=r._cf.views.nodes[m]._vf.id;e._webgl.buffers[p]=x3dom.BinaryContainerLoader.bufferGeoCache[n].buffers[x]}}(),l(t),function(t){t.shapes.push(e),e._webgl._bufferGeoCache=t;var i=e._cleanupGLObjects;e._cleanupGLObjects=function(e,t){var s=this._webgl._bufferGeoCache,o=s.shapes.indexOf(this);o>-1&&s.shapes.splice(o,1),s.shapes.length>0||i.call(this,e,t)}}(x3dom.BinaryContainerLoader.bufferGeoCache[n]),x3dom.BinaryContainerLoader.bufferGeoCache[n].decrementDownload&&(x3dom.BinaryContainerLoader.bufferGeoCache[n].decrementDownload=!1,e._nameSpace.doc.decrementDownloads(),e._nameSpace.doc.needRender=!0)):x3dom.BinaryContainerLoader.bufferGeoCache[n]=void 0})).catch((function(){x3dom.BinaryContainerLoader.bufferGeoCache[n].decrementDownload&&(x3dom.BinaryContainerLoader.bufferGeoCache[n].decrementDownload=!1,e._nameSpace.doc.decrementDownloads())})))},x3dom.BinaryContainerLoader.setupBufferInterpolator=function(e){var t=function(e,t,i){for(var s=e._cf.views.nodes[t._vf.view],o=t._vf.byteOffset+s._vf.byteOffset,n=t._vf.count*t._vf.components,r=t._vf.componentType,a=x3dom.BinaryContainerLoader.getArrayBufferFromType(r,i,o,n),d=0,h=a.length;d<h;d++)a[d]=a[d]/e._vf.duration;return new x3dom.fields.MFFloat(a)},i=function(e,t,i){var s=e._cf.views.nodes[t._vf.view],o=t._vf.byteOffset+s._vf.byteOffset,n=t._vf.count*t._vf.components,r=t._vf.componentType,a=x3dom.BinaryContainerLoader.getArrayBufferFromType(r,i,o,n);return e.keyValueFromAccessor(a,r)},s=e._nameSpace.getURL(e._vf.buffer);null==x3dom.BinaryContainerLoader.bufferGeoCache[s]&&(e._nameSpace.doc.incrementDownloads(),x3dom.BinaryContainerLoader.bufferGeoCache[s]={},x3dom.BinaryContainerLoader.bufferGeoCache[s].buffers=[],x3dom.BinaryContainerLoader.bufferGeoCache[s].decrementDownload=!0,x3dom.BinaryContainerLoader.bufferGeoCache[s].promise=new Promise((function(e,t){var i=new XMLHttpRequest;i.open("GET",s),i.responseType="arraybuffer",i.onload=function(s){200!=i.status?t():e(i.response)},i.onerror=function(e){t()},x3dom.RequestManager.addRequest(i)}))),x3dom.BinaryContainerLoader.bufferGeoCache[s].promise.then((function(o){null!=e?(!function(s){for(var o,n,r=e._cf.accessors.nodes,a=0;a<r.length;a++){var d=r[a];switch(d._vf.bufferType){case"SAMPLER_INPUT":o=t(e,d,s),e._vf.key=o;break;case"SAMPLER_OUTPUT":n=i(e,d,s)}}if("STEP"===e._vf.interpolation){for(var h=o.copy(),l=n.copy(),f=(a=1,o.length);a<f;a++)h.splice(2*a,0,o[a]);for(a=0,f=n.length;a<f;a++)l.splice(2*a+1,0,n[a]);o=h,n=l}e._vf.keyValue=n}(o),x3dom.BinaryContainerLoader.bufferGeoCache[s].decrementDownload&&(x3dom.BinaryContainerLoader.bufferGeoCache[s].decrementDownload=!1,e._nameSpace.doc.decrementDownloads(),e._nameSpace.doc.needRender=!0)):x3dom.BinaryContainerLoader.bufferGeoCache[s]=void 0})).catch((function(){x3dom.BinaryContainerLoader.bufferGeoCache[s].decrementDownload&&(x3dom.BinaryContainerLoader.bufferGeoCache[s].decrementDownload=!1,e._nameSpace.doc.decrementDownloads())}))},x3dom.BinaryContainerLoader.getArrayBufferFromType=function(e,t,i,s){switch(e){case 5120:return new Int8Array(t,i,s);case 5121:return new Uint8Array(t,i,s);case 5122:return new Int16Array(t,i,s);case 5123:return new Uint16Array(t,i,s);case 5125:return new Uint32Array(t,i,s);case 5126:return new Float32Array(t,i,s)}},x3dom.DrawableCollection=function(e){this.collection=[],this.viewMatrix=e.viewMatrix,this.projMatrix=e.projMatrix,this.sceneMatrix=e.sceneMatrix,this.viewarea=e.viewArea;var t=this.viewarea._scene,i=t.getEnvironment(),s=t.getViewpoint();this.near=s.getNear(),this.pixelHeightAtDistOne=s.getImgPlaneHeightAtDistOne()/this.viewarea._height,this.context=e.context,this.gl=e.gl,this.viewFrustum=this.viewarea.getViewfrustum(this.sceneMatrix),this.worldVol=new x3dom.fields.BoxVolume,this.frustumCulling=e.frustumCulling&&null!=this.viewFrustum,this.smallFeatureThreshold=e.smallFeatureThreshold,this.sortOpaque=this.smallFeatureThreshold>0&&i._lowPriorityThreshold<1,this.sortTrans=e.sortTrans,this.prioLevels=10,this.maxTreshold=100,this.sortBySortKey=!1,this.sortByPriority=!1,this.numberOfNodes=0,this.length=0},x3dom.DrawableCollection.prototype.cull=function(e,t,i,s){var o=t.boundedNode;if(!o||!o.renderFlag())return-1;var n,r=o.getVolume();if(this.frustumCulling&&t.needCulling){if(i&&!t.worldVolume.isValid()?(t.worldVolume.transformFrom(e,r),n=t.worldVolume):s<63&&(this.worldVol.transformFrom(e,r),n=this.worldVol),s<63&&(s=this.viewFrustum.intersect(n,s)),-1==s)return-1}else s=63;if(t.coverage=-1,this.smallFeatureThreshold>0||o.forceUpdateCoverage()){var a=this.viewMatrix.mult(e);t.center=a.multMatrixPnt(r.getCenter());var d=a.multMatrixVec(r.getRadialVec()).length(),h=Math.max(-t.center.z-d,this.near)*this.pixelHeightAtDistOne;if(t.coverage=2*d/h,this.smallFeatureThreshold>0&&t.coverage<this.smallFeatureThreshold&&t.needCulling)return-1}return this.numberOfNodes++,s},x3dom.DrawableCollection.prototype.addShape=function(e,t,i){var s={};s.shape=e,s.transform=t,s.localTransform=i.localMatrix,s.localVolume=i.volume,s.worldVolume=x3dom.fields.BoxVolume.copy(i.worldVolume),s.priority=Math.max(0,i.coverage),s.shaderID=e.getShaderProperties(this.viewarea).id;var o=e._cf.appearance.node;if(s.sortType=o?o._vf.sortType.toLowerCase():"opaque",s.sortKey=o?o._vf.sortKey:0,"transparent"==s.sortType)if(this.smallFeatureThreshold>0)s.zPos=i.center.z;else{var n=t.multMatrixPnt(e.getCenter());n=this.viewMatrix.multMatrixPnt(n),s.zPos=n.z}this.sortBySortKey||0==s.sortKey||(this.sortBySortKey=!0),void 0===this.collection[s.sortType]&&(this.collection[s.sortType]=[]),this.collection[s.sortType].push(s),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,s,this.viewarea)},x3dom.DrawableCollection.prototype.addDrawable=function(e){e.shaderID=e.shape.getShaderProperties(this.viewarea).id;var t=e.shape._cf.appearance.node;if(e.sortType=t?t._vf.sortType.toLowerCase():"opaque",e.sortKey=t?t._vf.sortKey:0,"transparent"==e.sortType){var i=e.transform.multMatrixPnt(e.shape.getCenter());i=this.viewMatrix.multMatrixPnt(i),e.zPos=i.z}this.sortBySortKey||0==e.sortKey||(this.sortBySortKey=!0),void 0===this.collection[e.sortType]&&(this.collection[e.sortType]=[]),this.collection[e.sortType].push(e),this.length++,this.context&&this.gl&&this.context.setupShape(this.gl,e,this.viewarea)},x3dom.DrawableCollection.prototype.calculatePriority=function(e){var t=Math.max(0,e.coverage),i=this.prioLevels-1;return t=Math.min(Math.round(t/(this.maxTreshold/i)),i)},x3dom.DrawableCollection.prototype.concat=function(){var e=void 0!==this.collection.opaque?this.collection.opaque:[],t=void 0!==this.collection.transparent?this.collection.transparent:[];this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.get=function(e){return this.collection[e]},x3dom.DrawableCollection.prototype.sort=function(){var e=[],t=[],i=this;void 0!==this.collection.opaque&&(this.sortOpaque&&this.collection.opaque.sort((function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:t.priority-e.priority})),e=this.collection.opaque),void 0!==this.collection.transparent&&(this.sortTrans&&this.collection.transparent.sort((function(e,t){return e.sortKey!=t.sortKey&&i.sortBySortKey?e.sortKey-t.sortKey:e.priority!=t.priority&&i.sortByPriority?t.priority-e.priority:e.zPos-t.zPos})),t=this.collection.transparent),this.collection=e.concat(t)},x3dom.DrawableCollection.prototype.forEach=function(e,t){var i,s,o,n;for(t=void 0!==t?Math.min(t,this.prioLevels):this.prioLevels,i=0;i<this.collection.opaque.length;++i)if(void 0!==this.collection.opaque[i])for(s=this.collection.opaque[i].length;s>0;--s)if(void 0!==this.collection.opaque[i][s])for(o in this.collection.opaque[i][s])for(n=0;n<this.collection.opaque[i][s][o].length;++n)e(this.collection.opaque[i][s][o][n]);for(i=0;i<this.collection.transparent.length;++i)if(void 0!==this.collection.transparent[i])for(s=this.collection.transparent[i].length;s>0;--s)if(void 0!==this.collection.transparent[i][s])for(var r in this.collection.transparent[i][s])for(this.collection.transparent[i][s][r].sort((function(e,t){return e.zPos-t.zPos})),n=0;n<this.collection.transparent[i][s][r].length;++n)e(this.collection.transparent[i][s][r][n])},x3dom.Moveable=function(e,t,i,s,o){this._x3domRoot=e,this._runtime=e.runtime,this._callback=i,this._gridSize=s||0,this._moveable=t,this._drag=!1,this._w=0,this._h=0,this._uPlane=null,this._vPlane=null,this._pPlane=null,this._isect=null,this._translationOffset=null,this._rotationOffset=null,this._scaleOffset=null,this._lastX=0,this._lastY=0,this._buttonState=0,this._mode=o&&o.length?o.toLowerCase():"translation",this._firstRay=null,this._matrixTrafo=null,this._navType="examine",this.attachHandlers()},x3dom.Moveable.prototype.setGridSize=function(e){this._gridSize=e},x3dom.Moveable.prototype.setMode=function(e){this._mode=e.toLowerCase()},x3dom.Moveable.prototype.attachHandlers=function(){this._moveable._iMove=this,this._x3domRoot._iMove||(this._x3domRoot._iMove=[]),this._x3domRoot._iMove.push(this),this._moveable.addEventListener("mousedown",this.start,!1),this._moveable.addEventListener("mouseover",this.over,!1),this._moveable.addEventListener("mouseout",this.out,!1),1==this._x3domRoot._iMove.length&&(this._x3domRoot.addEventListener("mouseup",this.stop,!1),this._x3domRoot.addEventListener("mouseout",this.stop,!1),this._x3domRoot.addEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.addEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.addEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.addEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.addEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.addEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.addEventListener("touchend",this.touchEndHandler,!1)))},x3dom.Moveable.prototype.detachHandlers=function(){var e=this._x3domRoot._iMove;if(e)for(var t=0,i=e.length;t<i;t++)if(e[t]==this){e.splice(t,1);break}this._moveable.removeEventListener("mousedown",this.start,!1),this._moveable.removeEventListener("mouseover",this.over,!1),this._moveable.removeEventListener("mouseout",this.out,!1),0==e.length&&(this._x3domRoot.removeEventListener("mouseup",this.stop,!1),this._x3domRoot.removeEventListener("mouseout",this.stop,!1),this._x3domRoot.removeEventListener("mousemove",this.move,!0),this._runtime.canvas.disableTouch||(this._x3domRoot.removeEventListener("MozTouchDown",this.touchStartHandlerMoz,!1),this._x3domRoot.removeEventListener("MozTouchMove",this.touchMoveHandlerMoz,!0),this._x3domRoot.removeEventListener("MozTouchUp",this.touchEndHandlerMoz,!1),this._x3domRoot.removeEventListener("touchstart",this.touchStartHandler,!1),this._x3domRoot.removeEventListener("touchmove",this.touchMoveHandler,!0),this._x3domRoot.removeEventListener("touchend",this.touchEndHandler,!1))),this._moveable._iMove&&delete this._moveable._iMove},x3dom.Moveable.prototype.calcViewPlane=function(e){this._w=this._runtime.getWidth(),this._h=this._runtime.getHeight();var t=this._runtime.getViewingRay(0,this._h-1),i=t.pos.add(t.dir),s=(t=this._runtime.getViewingRay(this._w-1,this._h-1)).pos.add(t.dir),o=(t=this._runtime.getViewingRay(0,0)).pos.add(t.dir);this._uPlane=s.subtract(i).normalize(),this._vPlane=o.subtract(i).normalize(),this._pPlane=0===arguments.length?i:x3dom.fields.SFVec3f.copy(e)},x3dom.Moveable.prototype.det=function(e){return e[0][0]*e[1][1]*e[2][2]+e[0][1]*e[1][2]*e[2][0]+e[0][2]*e[2][1]*e[1][0]-e[2][0]*e[1][1]*e[0][2]-e[0][0]*e[2][1]*e[1][2]-e[1][0]*e[0][1]*e[2][2]},x3dom.Moveable.prototype.translateXY=function(e){for(var t=null,i=[],s=[],o=0;o<3;o++)i[o]=[],s[o]=[],i[o][0]=this._uPlane.at(o),s[o][0]=i[o][0],i[o][1]=this._vPlane.at(o),s[o][1]=i[o][1],i[o][2]=e.pos.subtract(this._pPlane).at(o),s[o][2]=-e.dir.at(o);var n=this.det(s);if(0!==n){var r=this.det(i)/n;t=e.pos.addScaled(e.dir,r)}return t&&(this._isect&&(t=t.subtract(this._isect)),t=t.add(this._translationOffset)),t},x3dom.Moveable.prototype.translateZ=function(e,t){var i=this._runtime.getSceneBBox(),s=(t<this._lastY?1:-1)*i.max.subtract(i.min).length()/100;return this._translationOffset=this._translationOffset.addScaled(e.dir,s),this._translationOffset},x3dom.Moveable.prototype.rotate=function(e,t){var i=2*Math.PI,s=(t-this._lastY)*i/this._w,o=(e-this._lastX)*i/this._h,n=x3dom.fields.Quaternion.axisAngle(this._uPlane,s),r=n.toMatrix();this._rotationOffset=r.mult(this._rotationOffset),r=(n=x3dom.fields.Quaternion.axisAngle(this._vPlane,o)).toMatrix(),this._rotationOffset=r.mult(this._rotationOffset);var a=this._rotationOffset.mult(x3dom.fields.SFMatrix4f.scale(this._scaleOffset)),d=new x3dom.fields.Quaternion(0,0,1,0);return d.setValue(a),d},x3dom.Moveable.prototype.over=function(e){this._iMove._runtime.getCanvas().style.cursor="crosshair"},x3dom.Moveable.prototype.out=function(e){var t=this._iMove;t._drag||(t._runtime.getCanvas().style.cursor="pointer")},x3dom.Moveable.prototype.start=function(e){var t=this._iMove;switch(t._mode){case"translation":t._buttonState=4==e.button?1:3&e.button;break;case"rotation":t._buttonState=4;break;case"all":default:t._buttonState=e.button}if(!t._drag&&t._buttonState){t._lastX=e.layerX,t._lastY=e.layerY,t._drag=!0,t._navType=t._runtime.navigationType(),t._runtime.noNav(),t._isect=new x3dom.fields.SFVec3f(e.worldX,e.worldY,e.worldZ),t.calcViewPlane(t._isect),t._firstRay=t._runtime.getViewingRay(e.layerX,e.layerY);var i=t._moveable.getAttribute("translation");if(t._matrixTrafo=null,i){t._translationOffset=x3dom.fields.SFVec3f.parse(i);var s=t._moveable.getAttribute("rotation");s=s?x3dom.fields.Quaternion.parseAxisAngle(s):new x3dom.fields.Quaternion(0,0,1,0),t._rotationOffset=s.toMatrix();var o=t._moveable.getAttribute("scale");t._scaleOffset=o?x3dom.fields.SFVec3f.parse(o):new x3dom.fields.SFVec3f(1,1,1)}else if(i=t._moveable.getAttribute("matrix")){t._matrixTrafo=x3dom.fields.SFMatrix4f.parse(i).transpose();var n=new x3dom.fields.SFVec3f(0,0,0),r=new x3dom.fields.SFVec3f(1,1,1),a=new x3dom.fields.Quaternion(0,0,1,0),d=new x3dom.fields.Quaternion(0,0,1,0);t._matrixTrafo.getTransform(n,a,r,d),t._translationOffset=n,t._rotationOffset=a.toMatrix(),t._scaleOffset=r}else t._translationOffset=new x3dom.fields.SFVec3f(0,0,0),t._rotationOffset=new x3dom.fields.SFMatrix4f,t._scaleOffset=new x3dom.fields.SFVec3f(1,1,1);t._runtime.getCanvas().style.cursor="crosshair"}},x3dom.Moveable.prototype.move=function(e){for(var t=0,i=this._iMove.length;t<i;t++){var s=this._iMove[t];if(s._drag){var o=s._runtime.mousePosition(e),n=s._runtime.getViewingRay(o[0],o[1]),r=null;if(r=2==s._buttonState?s.translateZ(s._firstRay,o[1]):1==s._buttonState?s.translateXY(n):s.rotate(o[0],o[1])){if(s._gridSize>0&&4!=s._buttonState){var a=s._gridSize*Math.round(r.x/s._gridSize),d=s._gridSize*Math.round(r.y/s._gridSize),h=s._gridSize*Math.round(r.z/s._gridSize);r=new x3dom.fields.SFVec3f(a,d,h)}s._matrixTrafo?(4==s._buttonState?s._matrixTrafo.setRotate(r):s._matrixTrafo.setTranslate(r),s._moveable.setAttribute("matrix",s._matrixTrafo.toGL().toString())):4==s._buttonState?s._moveable.setAttribute("rotation",r.toAxisAngle().toString()):s._moveable.setAttribute("translation",r.toString()),s._callback&&s._callback(s._moveable,r)}s._lastX=o[0],s._lastY=o[1]}}},x3dom.Moveable.prototype.stop=function(e){for(var t=0,i=this._iMove.length;t<i;t++){var s=this._iMove[t];if(s._drag)s._lastX=e.layerX,s._lastY=e.layerY,s._isect=null,s._drag=!1,s._runtime.canvas.doc._scene.getNavigationInfo().setType(s._navType),s._runtime.getCanvas().style.cursor="pointer"}},x3dom.Moveable.prototype.touchStartHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchStartHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandler=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchMoveHandlerMoz=function(e){e.preventDefault()},x3dom.Moveable.prototype.touchEndHandler=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},x3dom.Moveable.prototype.touchEndHandlerMoz=function(e){if(this._iMove.length){var t=this._iMove[0];t.stop.apply(t._x3domRoot,[e])}e.preventDefault()},function(){"use strict";function e(e){return"function"==typeof e}function t(){var e=setTimeout;return function(){return e(i,1)}}function i(){for(var e=0;e<x;e+=2)(0,M[e])(M[e+1]),M[e]=void 0,M[e+1]=void 0;x=0}function s(e,t){var i=this,s=new this.constructor(n);void 0===s[w]&&m(s);var o=i._state;if(o){var r=arguments[o-1];y((function(){return c(o,s,r,i._result)}))}else u(i,s,e,t);return s}function o(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(n);return d(t,e),t}function n(){}function r(e){try{return e.then}catch(e){return R.error=e,R}}function a(t,i,n){i.constructor===t.constructor&&n===s&&i.constructor.resolve===o?function(e,t){t._state===D?l(e,t._result):t._state===N?f(e,t._result):u(t,void 0,(function(t){return d(e,t)}),(function(t){return f(e,t)}))}(t,i):n===R?(f(t,R.error),R.error=null):void 0===n?l(t,i):e(n)?function(e,t,i){y((function(e){var s=!1,o=function(e,t,i,s){try{e.call(t,i,s)}catch(e){return e}}(i,t,(function(i){s||(s=!0,t!==i?d(e,i):l(e,i))}),(function(t){s||(s=!0,f(e,t))}),e._label);!s&&o&&(s=!0,f(e,o))}),e)}(t,i,n):l(t,i)}function d(e,t){e===t?f(e,new TypeError("You cannot resolve a promise with itself")):function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)?a(e,t,r(t)):l(e,t)}function h(e){e._onerror&&e._onerror(e._result),_(e)}function l(e,t){e._state===A&&(e._result=t,e._state=D,0!==e._subscribers.length&&y(_,e))}function f(e,t){e._state===A&&(e._state=N,e._result=t,y(h,e))}function u(e,t,i,s){var o=e._subscribers,n=o.length;e._onerror=null,o[n]=t,o[n+D]=i,o[n+N]=s,0===n&&e._state&&y(_,e)}function _(e){var t=e._subscribers,i=e._state;if(0!==t.length){for(var s=void 0,o=void 0,n=e._result,r=0;r<t.length;r+=3)s=t[r],o=t[r+i],s?c(i,s,o,n):o(n);e._subscribers.length=0}}function c(t,i,s,o){var n=e(s),r=void 0,a=void 0,h=void 0,u=void 0;if(n){if((r=function(e,t){try{return e(t)}catch(e){return R.error=e,R}}(s,o))===R?(u=!0,a=r.error,r.error=null):h=!0,i===r)return void f(i,new TypeError("A promises callback cannot return that same promise."))}else r=o,h=!0;i._state!==A||(n&&h?d(i,r):u?f(i,a):t===D?l(i,r):t===N&&f(i,r))}function m(e){e[w]=I++,e._state=void 0,e._result=void 0,e._subscribers=[]}var p=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},x=0,v=void 0,g=void 0,y=function(e,t){M[x]=e,M[x+1]=t,2===(x+=2)&&(g?g(i):E())},S="undefined"!=typeof window?window:void 0,T=S||{},F=T.MutationObserver||T.WebKitMutationObserver,b="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),C="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,M=new Array(1e3),E=void 0;E=b?function(){return process.nextTick(i)}:F?function(){var e=0,t=new F(i),s=document.createTextNode("");return t.observe(s,{characterData:!0}),function(){s.data=e=++e%2}}():C?function(){var e=new MessageChannel;return e.port1.onmessage=i,function(){return e.port2.postMessage(0)}}():void 0===S&&"function"==typeof require?function(){try{var e=Function("return this")().require("vertx");return void 0!==(v=e.runOnLoop||e.runOnContext)?function(){v(i)}:t()}catch(e){return t()}}():t();var w=Math.random().toString(36).substring(2),A=void 0,D=1,N=2,R={error:null},I=0,P=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(n),this.promise[w]||m(this.promise),p(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?l(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&l(this.promise,this._result))):f(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===A&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var i=this._instanceConstructor,d=i.resolve;if(d===o){var h=r(e);if(h===s&&e._state!==A)this._settledAt(e._state,t,e._result);else if("function"!=typeof h)this._remaining--,this._result[t]=e;else if(i===V){var l=new i(n);a(l,e,h),this._willSettleAt(l,t)}else this._willSettleAt(new i((function(t){return t(e)})),t)}else this._willSettleAt(d(e),t)},e.prototype._settledAt=function(e,t,i){var s=this.promise;s._state===A&&(this._remaining--,e===N?f(s,i):this._result[t]=i),0===this._remaining&&l(s,this._result)},e.prototype._willSettleAt=function(e,t){var i=this;u(e,void 0,(function(e){return i._settledAt(D,t,e)}),(function(e){return i._settledAt(N,t,e)}))},e}(),V=function(){function e(t){this[w]=I++,this._result=this._state=void 0,this._subscribers=[],n!==t&&("function"!=typeof t&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof e?function(e,t){try{t((function(t){d(e,t)}),(function(t){f(e,t)}))}catch(t){f(e,t)}}(this,t):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(e){var t=this.constructor;return this.then((function(i){return t.resolve(e()).then((function(){return i}))}),(function(i){return t.resolve(e()).then((function(){throw i}))}))},e}();V.prototype.then=s,V.all=function(e){return new P(this,e).promise},V.race=function(e){var t=this;return new t(p(e)?function(i,s){for(var o=e.length,n=0;n<o;n++)t.resolve(e[n]).then(i,s)}:function(e,t){return t(new TypeError("You must pass an array to race."))})},V.resolve=o,V.reject=function(e){var t=new this(n);return f(t,e),t},V._setScheduler=function(e){g=e},V._setAsap=function(e){y=e},V._asap=y,V.polyfill=function(){var e=void 0;if("undefined"!=typeof global)e=global;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var i=null;try{i=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===i&&!t.cast)return}e.Promise=V},V.Promise=V,V.polyfill()}(),x3dom.glTF2Loader=function(e){this._nameSpace=e,this._definitions={}},x3dom.glTF2Loader.prototype.load=function(e,t){this._gltf=this._getGLTF(e,t);var i=this._generateX3DScene(),s=this._gltf.scene||0,o=this._gltf.scenes[s];this._generateX3DWorldInfo(o,i);for(var n=0;n<o.nodes.length;n++){var r=this._gltf.nodes[o.nodes[n]];this._traverseNodes(r,i,o.nodes[n])}if(this._gltf.animations)for(n=0;n<this._gltf.animations.length;n++){var a=this._gltf.animations[n],d="glTF_ANIMATION_"+n;this._generateX3DAnimationNodes(i,a,d)}return i},x3dom.glTF2Loader.prototype._generateX3DWorldInfo=function(e,t){if(this._gltf.asset){var i,s,o=this._gltf.asset,n=["copyright","generator","version","minversion"],r=document.createElement("worldinfo"),a=new x3dom.fields.MFString;for(s=0;s<n.length;s++)o[i=n[s]]&&a.push('"'+n[s]+":"+o[i]+'"');r.setAttribute("info",a.toString()),o.extras&&o.extras.title&&r.setAttribute("title",o.extras.title);var d=document.createElement("MetadataSet");d.setAttribute("name","global"),d.setAttribute("containerfield","metadata"),this._generateX3DMetadata(o,d,"asset_extras","value"),this._generateX3DMetadata(e,d,"scene_extras","value"),d.hasChildNodes()&&r.appendChild(d),t.appendChild(r)}},x3dom.glTF2Loader.prototype._generateX3DMetadata=function(e,t,i,s){if(e.extras){s=s||"metadata";var o=n(i=i||"extras",e.extras,s);t.appendChild(o)}else;function n(e,t,i){var s=typeof t;return"string"==s||null===t||"undefined"==s?r("MetadataString",e,JSON.stringify(t),i):"number"==s?r("MetadataFloat",e,t,i):"boolean"==s?r("MetadataBoolean",e,t,i):"object"==s?function(e,t,i){var s=document.createElement("MetadataSet");s.setAttribute("name",e),s.setAttribute("containerfield",i);var o,r,a=Object.keys(t);for(r=0;r<a.length;r++)o=a[r],s.appendChild(n(o,t[o],"value"));return s}(e,t,i):r("MetadataString",e,t,i)}function r(e,t,i,s){var o=document.createElement(e);return o.setAttribute("name",t),o.setAttribute("value",i),o.setAttribute("containerfield",s),o}},x3dom.glTF2Loader.prototype._traverseNodes=function(e,t,i){var s=this._generateX3DNode(e,i);if(t.appendChild(s),e.children)for(var o=0;o<e.children.length;o++){var n=this._gltf.nodes[e.children[o]];this._traverseNodes(n,s,e.children[o])}},x3dom.glTF2Loader.prototype._generateX3DNode=function(e,t){var i;if(e.name=e.name?e.name:t,i=null!=e.matrix?this._generateX3DMatrixTransform(e):(null!=e.translation||null!=e.rotation||e.scale,this._generateX3DTransform(e)),this._generateX3DMetadata(e,i),null!=e.mesh)for(var s=this._gltf.meshes[e.mesh],o=0;o<s.primitives.length;o++)i.appendChild(this._generateX3DShape(s.primitives[o]));if(null!=e.model){var n=this._gltf.models[e.model];null!=n.uri&&i.appendChild(this._generateX3DInline(n))}return null!=e.camera&&i.appendChild(this._generateX3DViewpoint(e)),i},x3dom.glTF2Loader.prototype._generateX3DScene=function(){return document.createElement("scene")},x3dom.glTF2Loader.prototype._generateX3DTransform=function(e){var t=document.createElement("transform");return null!=e.translation&&t.setAttribute("translation",e.translation.join(" ")),null!=e.rotation&&t.setAttribute("rotation",this._toAxisAngle(e.rotation).join(" ")),null!=e.scale&&t.setAttribute("scale",e.scale.join(" ")),null!=e.name&&t.setAttribute("DEF","glTF_NODE_"+e.name),t},x3dom.glTF2Loader.prototype._generateX3DMatrixTransform=function(e){var t=document.createElement("matrixtransform");return null!=e.matrix&&t.setAttribute("matrix",e.matrix.join(" ")),null!=e.name&&t.setAttribute("DEF","glTF_NODE_"+e.name),t},x3dom.glTF2Loader.prototype._generateX3DGroup=function(e){return document.createElement("group")},x3dom.glTF2Loader.prototype._generateX3DInline=function(e){var t=document.createElement("inline");return t.setAttribute("url",e.uri),null!=e.mimeType&&t.setAttribute("contentType",e.mimeType),t},x3dom.glTF2Loader.prototype._generateX3DViewpoint=function(e){var t=this._gltf.cameras[e.camera],i="glTF_CAMERA_"+e.camera;switch(t.type){case"orthographic":return this._generateX3DOrthoViewpoint(i,t.orthographic);case"perspective":default:return this._generateX3DPerspectiveViewpoint(i,t.perspective)}},x3dom.glTF2Loader.prototype._generateX3DPerspectiveViewpoint=function(e,t){var i=document.createElement("viewpoint");this._generateX3DMetadata(t,i);var s=t.yfov||.785398,o=t.znear||-1,n=t.zfar||-1;return n/o>1e5&&(n=o=-1),i.setAttribute("DEF",e),i.setAttribute("fieldOfView",s),i.setAttribute("zNear",o),i.setAttribute("zFar",n),i.setAttribute("position","0 0 0"),i},x3dom.glTF2Loader.prototype._generateX3DOrthoViewpoint=function(e,t){var i=document.createElement("orthoviewpoint");this._generateX3DMetadata(t,i);var s=t.xmag||1,o=t.ymag||1,n=t.znear||-1,r=t.zfar||-1,a=[-s,-o,s,o];return i.setAttribute("DEF",e),i.setAttribute("fieldOfView",a),i.setAttribute("zNear",n),i.setAttribute("zFar",r),i.setAttribute("position","0 0 0"),i},x3dom.glTF2Loader.prototype._generateX3DShape=function(e){var t=document.createElement("shape");this._generateX3DMetadata(e,t);var i=null!=e.material?this._gltf.materials[e.material]:{name:"DEFAULT"};return null==i.name&&(i.name=e.material),t.appendChild(this._generateX3DAppearance(i)),t.appendChild(this._generateX3DBufferGeometry(e)),t},x3dom.glTF2Loader.prototype._generateX3DAppearance=function(e){var t=document.createElement("appearance");return this._generateX3DMetadata(e,t),"BLEND"===e.alphaMode?t.setAttribute("sortType","transparent"):t.setAttribute("sortType","opaque"),t.appendChild(this._generateX3DPhysicalMaterial(e)),this._textureTransform&&(t.appendChild(this._textureTransform),this._textureTransform=void 0),t},x3dom.glTF2Loader.prototype._generateX3DPhysicalMaterial=function(e){var t=document.createElement("physicalmaterial");if(this._USEorDEF(t,"glTF_MATERIAL_"+e.name))return t;var i,s,o=[1,1,1,1],n=e.emissiveFactor||[0,0,0],r=1,a=1,d=e.alphaMode||"OPAQUE",h=e.alphaCutoff||.5,l=!0,f=void 0,u=void 0,_=0;if(e.pbrMetallicRoughness?(u=e.pbrMetallicRoughness,f="roughnessMetallic"):e.extensions&&e.extensions.KHR_materials_pbrSpecularGlossiness&&(u=e.extensions.KHR_materials_pbrSpecularGlossiness,f="specularGlossiness"),"roughnessMetallic"==f){o=u.baseColorFactor||[1,1,1,1],r=null!=u.metallicFactor?u.metallicFactor:1,a=null!=u.roughnessFactor?u.roughnessFactor:1;u.baseColorTexture&&(_=u.baseColorTexture.texCoord?1:0,i=this._gltf.textures[u.baseColorTexture.index],s=u.baseColorTexture.extensions&&u.baseColorTexture.extensions.KHR_texture_transform?u.baseColorTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"baseColorTexture",_,s))),u.metallicRoughnessTexture&&(_=u.metallicRoughnessTexture.texCoord?1:0,i=this._gltf.textures[u.metallicRoughnessTexture.index],s=u.metallicRoughnessTexture.extensions&&u.metallicRoughnessTexture.extensions.KHR_texture_transform?u.metallicRoughnessTexture.extensions.KHR_texture_transform:void 0,e.occlusionTexture&&e.occlusionTexture.index==u.metallicRoughnessTexture.index?(l=!1,t.appendChild(this._generateX3DImageTexture(i,"occlusionRoughnessMetallicTexture",_,s))):t.appendChild(this._generateX3DImageTexture(i,"roughnessMetallicTexture",_,s))),t.setAttribute("baseColorFactor",o.join(" ")),t.setAttribute("metallicFactor",r),t.setAttribute("roughnessFactor",a)}else if("specularGlossiness"==f){var c=u.diffuseFactor||[1,1,1,1],m=u.specularFactor||[1,1,1],p=null!=u.glossinessFactor?u.glossinessFactor:1;u.diffuseTexture&&(_=u.diffuseTexture.texCoord?1:0,i=this._gltf.textures[u.diffuseTexture.index],s=u.diffuseTexture.extensions&&u.diffuseTexture.extensions.KHR_texture_transform?u.diffuseTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"baseColorTexture",_,s))),u.specularGlossinessTexture&&(_=u.specularGlossinessTexture.texCoord?1:0,i=this._gltf.textures[u.specularGlossinessTexture.index],s=u.specularGlossinessTexture.extensions&&u.specularGlossinessTexture.extensions.KHR_texture_transform?u.specularGlossinessTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"specularGlossinessTexture",_,s))),t.setAttribute("diffuseFactor",c.join(" ")),t.setAttribute("specularFactor",m.join(" ")),t.setAttribute("glossinessFactor",p)}return e.normalTexture&&(_=e.normalTexture.texCoord?1:0,i=this._gltf.textures[e.normalTexture.index],s=e.normalTexture.extensions&&e.normalTexture.extensions.KHR_texture_transform?e.normalTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"normalTexture",_,s))),e.emissiveTexture&&(_=e.emissiveTexture.texCoord?1:0,i=this._gltf.textures[e.emissiveTexture.index],s=e.emissiveTexture.extensions&&e.emissiveTexture.extensions.KHR_texture_transform?e.emissiveTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"emissiveTexture",_,s))),e.occlusionTexture&&l&&(_=e.occlusionTexture.texCoord?1:0,i=this._gltf.textures[e.occlusionTexture.index],s=e.occlusionTexture.extensions&&e.occlusionTexture.extensions.KHR_texture_transform?e.occlusionTexture.extensions.KHR_texture_transform:void 0,t.appendChild(this._generateX3DImageTexture(i,"occlusionTexture",_,s))),e.extensions&&e.extensions.KHR_materials_unlit&&t.setAttribute("unlit",!0),t.setAttribute("emissiveFactor",n.join(" ")),t.setAttribute("alphaMode",d),t.setAttribute("alphaCutoff",h),t.setAttribute("model",f),t},x3dom.glTF2Loader.prototype._generateX3DImageTexture=function(e,t,i,s){var o=this._gltf.images[e.source],n=document.createElement("imagetexture");if(this._generateX3DMetadata(e,n),n.setAttribute("origChannelCount","2"),n.setAttribute("flipY","true"),t&&n.setAttribute("containerField",t),null!=o.uri&&n.setAttribute("url",x3dom.Utils.dataURIToObjectURL(o.uri)),null!=e.sampler){var r=this._gltf.samplers[e.sampler];n.appendChild(this._createX3DTextureProperties(r))}return i&&n.setAttribute("channel","1"),s&&(this._textureTransform=this._createX3DTextureTransform(n,s)),n},x3dom.glTF2Loader.prototype._createX3DTextureProperties=function(e){var t=document.createElement("textureproperties");return t.setAttribute("boundaryModeS",x3dom.Utils.boundaryModesDicX3D(e.wrapS)),t.setAttribute("boundaryModeT",x3dom.Utils.boundaryModesDicX3D(e.wrapT)),t.setAttribute("magnificationFilter",x3dom.Utils.magFilterDicX3D(e.magFilter)),t.setAttribute("minificationFilter",x3dom.Utils.minFilterDicX3D(e.minFilter)),(null==e.minFilter||e.minFilter>=9984&&e.minFilter<=9987)&&t.setAttribute("generateMipMaps","true"),t},x3dom.glTF2Loader.prototype._createX3DTextureTransform=function(e,t){var i=document.createElement("matrixtexturetransform"),s=t.offset||[0,0],o=t.rotation||0,n=t.scale||[1,1],r=new x3dom.fields.SFVec3f(-0,-0,0),a=new x3dom.fields.SFVec3f(0,0,0),d=new x3dom.fields.SFVec3f(s[0],s[1],0),h=new x3dom.fields.SFVec3f(n[0],n[1],0),l=x3dom.fields.SFMatrix4f.translation(a.add(d)).mult(x3dom.fields.SFMatrix4f.rotationZ(-1*o)).mult(x3dom.fields.SFMatrix4f.scale(h)).mult(x3dom.fields.SFMatrix4f.translation(r));return i.setAttribute("matrix",l.toString()),t.texCoord&&e.setAttribute("channel",texCoord),i},x3dom.glTF2Loader.prototype._generateX3DBufferGeometry=function(e){var t=[],i=document.createElement("buffergeometry"),s=this._getCenterAndSize(e);(i.setAttribute("buffer",this._bufferURI(e)),i.setAttribute("position",s.center.join(" ")),i.setAttribute("size",s.size.join(" ")),i.setAttribute("vertexCount",this._getVertexCount(e)),i.setAttribute("primType",this._primitiveType(e.mode)),null!=e.material)&&(this._gltf.materials[e.material].doubleSided&&i.setAttribute("solid","false"));if(null!=e.indices){var o=this._gltf.accessors[e.indices];(a=this._gltf.bufferViews[o.bufferView]).id=o.bufferView,a.target=34963;var n=t.indexOf(a);null!=a.target&&-1==n&&(n=t.push(a)-1),i.appendChild(this._generateX3DBufferAccessor("INDEX",o,n))}for(var r in e.attributes){var a;o=this._gltf.accessors[e.attributes[r]];(a=this._gltf.bufferViews[o.bufferView]).target=34962,a.id=o.bufferView;n=t.indexOf(a);null!=a.target&&-1==n&&(n=t.push(a)-1),i.appendChild(this._generateX3DBufferAccessor(r,o,n))}for(var d=0;d<t.length;d++)i.appendChild(this._generateX3DBufferView(t[d]));return i},x3dom.glTF2Loader.prototype._generateX3DBufferView=function(e){var t=document.createElement("bufferview");return t.setAttribute("target",e.target),t.setAttribute("byteOffset",e.byteOffset||0),t.setAttribute("byteLength",e.byteLength),t.setAttribute("id",e.id),t},x3dom.glTF2Loader.prototype._generateX3DBufferAccessor=function(e,t,i){var s=this._componentsOf(t.type),o=this._gltf.bufferViews[t.bufferView],n=t.byteOffset,r=document.createElement("bufferaccessor");return r.setAttribute("bufferType",e.replace("_0","")),r.setAttribute("view",i),r.setAttribute("byteOffset",n||0),r.setAttribute("byteStride",o.byteStride||0),r.setAttribute("normalized",t.normalized||!1),r.setAttribute("components",s),r.setAttribute("componentType",t.componentType),r.setAttribute("count",t.count),r},x3dom.glTF2Loader.prototype._generateX3DAnimationNodes=function(e,t,i){var s=this._animationDuration(t),o=i+"_TIMESENSOR";e.appendChild(this._generateX3DTimeSensor(o,s));for(var n=0;n<t.channels.length;n++){var r=t.channels[n],a=r.target.path,d=r.target.node,h=t.samplers[r.sampler],l="glTF_NODE_"+this._gltf.nodes[d].name,f=i+"_INTERPOLATOR_"+n;e.appendChild(this._generateX3DInterpolator(f,a,h,s)),e.appendChild(this._createX3DRoute("fraction_changed",o,"set_fraction",f)),e.appendChild(this._createX3DRoute("value_changed",f,"set_"+a,l))}},x3dom.glTF2Loader.prototype._generateX3DTimeSensor=function(e,t){var i=document.createElement("TimeSensor");return i.setAttribute("loop","true"),i.setAttribute("cycleInterval",t),i.setAttribute("DEF",e),i},x3dom.glTF2Loader.prototype._generateX3DInterpolator=function(e,t,i,s){var o,n=i.interpolation||"LINEAR",r=this._gltf.accessors[i.input],a=this._gltf.accessors[i.output],d=this._gltf.bufferViews[r.bufferView],h=this._gltf.bufferViews[a.bufferView];switch(t){case"scale":case"translation":o=document.createElement("PositionInterpolator");break;case"rotation":o=document.createElement("OrientationInterpolator");break;case"weights":o=document.createElement("ScalarInterpolator")}return o.setAttribute("DEF",e),o.setAttribute("buffer",this._bufferURI(i)),o.setAttribute("interpolation",n),o.setAttribute("duration",s),o.appendChild(this._generateX3DBufferAccessor("SAMPLER_INPUT",r,0)),o.appendChild(this._generateX3DBufferAccessor("SAMPLER_OUTPUT",a,1)),o.appendChild(this._generateX3DBufferView(d)),o.appendChild(this._generateX3DBufferView(h)),o},x3dom.glTF2Loader.prototype._createX3DRoute=function(e,t,i,s){var o=document.createElement("ROUTE");return o.setAttribute("fromField",e),o.setAttribute("fromNode",t),o.setAttribute("toField",i),o.setAttribute("toNode",s),o},x3dom.glTF2Loader.prototype._getCenterAndSize=function(e){var t=[1,1,1],i=[0,0,0];if(null!=e.attributes.POSITION){var s=this._gltf.accessors[e.attributes.POSITION];t[0]=s.max[0]-s.min[0],t[1]=s.max[1]-s.min[1],t[2]=s.max[2]-s.min[2],i[0]=s.min[0]+.5*t[0],i[1]=s.min[1]+.5*t[1],i[2]=s.min[2]+.5*t[2]}return{center:i,size:t}},x3dom.glTF2Loader.prototype._getVertexCount=function(e){var t=0;return null!=e.indices?t=this._gltf.accessors[e.indices].count:null!=e.attributes.POSITION&&(t=this._gltf.accessors[e.attributes.POSITION].count),t},x3dom.glTF2Loader.prototype._sizeInBytes=function(e){switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5125:case 5126:return 4}},x3dom.glTF2Loader.prototype._componentsOf=function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},x3dom.glTF2Loader.prototype._bufferURI=function(e){var t,i="";if(null!=e.attributes&&null!=e.attributes.POSITION?t=e.attributes.POSITION:e.input&&(t=e.input),null!=t){var s=this._gltf.accessors[t],o=this._gltf.bufferViews[s.bufferView],n=this._gltf.buffers[o.buffer];i=x3dom.Utils.dataURIToObjectURL(n.uri)}return i},x3dom.glTF2Loader.prototype._USEorDEF=function(e,t){return null!=this._definitions[t]?(e.setAttribute("USE",t),!0):(e.setAttribute("DEF",t),this._definitions[t]=t,!1)},x3dom.glTF2Loader.prototype._primitiveType=function(e){switch(e){case 0:return"POINTS";case 1:return"LINES";case 2:return"LINE_LOOP";case 3:return"LINE_STRIP";case 4:return"TRIANGLES";case 5:return"TRIANGLE_STRIP";case 6:return"TRIANGLE_FAN";default:return"TRIANGLES"}},x3dom.glTF2Loader.prototype._isDefaultSampler=function(e){return 10497==e.wrapS&&10497==e.wrapT&&9729==e.magFilter&&9729==e.minFilter},x3dom.glTF2Loader.prototype._toAxisAngle=function(e){var t=[],i=(e=new x3dom.fields.Quaternion(e[0],e[1],e[2],e[3])).toAxisAngle();return t[0]=i[0].x,t[1]=i[0].y,t[2]=i[0].z,t[3]=i[1],t},x3dom.glTF2Loader.prototype._getGLTF=function(e,t){if(!t)return"string"==typeof e?JSON.parse(e):e;var i=0,s=new Uint32Array(e,i,3);if(1179937895==s[0]||2==s[1]){i+=12;var o=new Uint32Array(e,i,2);if(1313821514==o[1]){i+=8;var n=new Uint8Array(e,i,o[0]);i+=o[0];var r=new Uint32Array(e,i,2);if(5130562==r[1]){i+=8;var a=new Uint8Array(e,i,r[0]),d=x3dom.Utils.arrayBufferToJSON(n);return d.buffers[0].uri=x3dom.Utils.arrayBufferToObjectURL(a,"application/octet-stream"),this._convertBinaryImages(d,e,i),d}}}},x3dom.glTF2Loader.prototype._convertBinaryImages=function(e,t,i){if(null!=e.images)for(var s=0;s<e.images.length;s++){var o=e.images[s];if(null!=o.bufferView){var n=e.bufferViews[o.bufferView];n.byteOffset=n.byteOffset||0;var r=new Uint8Array(t,i+n.byteOffset,n.byteLength);o.uri=x3dom.Utils.arrayBufferToObjectURL(r,o.mimeType)}}},x3dom.glTF2Loader.prototype._animationDuration=function(e){for(var t=-1,i=0;i<e.channels.length;i++){var s=e.channels[i],o=e.samplers[s.sampler],n=this._gltf.accessors[o.input];t=Math.max(n.max[0],t)}return t},x3dom.DDSLoader={},x3dom.DDSLoader.load=function(e){return new Promise((function(t,i){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){var e=x3dom.DDSLoader._read(s.response);e?t(e):i(e)},s.onerror=function(){i()},x3dom.RequestManager.addRequest(s)}))},x3dom.DDSLoader._read=function(e){if(!(void 0===e||e.byteLength<148)){var t={isCompressed:!1,isVolume:!1,isCubeMap:!1,targets:[],data:[]},i=new Uint32Array(e,0,32);if(t.header=x3dom.DDSLoader._readHeader(i),i=new Uint32Array(e,128,5),t.header10=x3dom.DDSLoader._readHeader10(t,i),542327876==t.header.dwMagic&&124==t.header.dwSize&&x3dom.DDSLoader._readFormat(t))return x3dom.DDSLoader._readMipmapCount(t),x3dom.DDSLoader._readType(t),this._readData(t,e),t}},x3dom.DDSLoader._readHeader=function(e){return{dwMagic:e[0],dwSize:e[1],dwFlags:x3dom.DDSLoader._readDDSFlags(e[2]),dwHeight:e[3],dwWidth:e[4],dwPitchOrLinearSize:e[5],dwDepth:e[6],dwMipMapCount:e[7],dwReserved1:"UNUSED",ddspf:{dwSize:e[19],dwFlags:x3dom.DDSLoader._readPFFlags(e[20]),dwFourCC:x3dom.DDSLoader.int32ToFourCC(e[21]),dwRGBBitCount:e[22],dwRBitMask:e[23],dwGBitMask:e[24],dwBBitMask:e[25],dwABitMask:e[26]},dwCaps:x3dom.DDSLoader._readCapsFlags(e[27]),dwCaps2:x3dom.DDSLoader._readCaps2Flags(e[28]),dwCaps3:"UNUSED",dwCaps4:"UNUSED",dwReserved2:"UNUSED"}},x3dom.DDSLoader._readHeader10=function(e,t){return"DX10"!=e.header.ddspf.dwFourCC?null:{dxgiFormat:t[0],resourceDimension:x3dom.DDSLoader._readResourceDimension(t[1]),miscFlags:x3dom.DDSLoader._readMiscFlags(t[2]),arraySize:t[3],miscFlags2:x3dom.DDSLoader._readMiscFlags2(t[4])}},x3dom.DDSLoader._readMipmapCount=function(e){e.numberOfMipmaps=e.header.dwFlags.DDSD_MIPMAPCOUNT?e.header.dwMipMapCount:1},x3dom.DDSLoader._readType=function(e){e.header.dwFlags.DDSD_DEPTH&&e.header.dwCaps2.DDSCAPS2_VOLUME?(e.type=32879,e.numberOfImages=e.header.dwCaps.DDSD_DEPTH):e.header.dwCaps2.DDSCAPS2_CUBEMAP?(e.type=34067,e.header.dwCaps2.DDSCAPS2_CUBEMAP_POSITIVEX&&e.targets.push(34069),e.header.dwCaps2.DDSCAPS2_CUBEMAP_NEGATIVEX&&e.targets.push(34070),e.header.dwCaps2.DDSCAPS2_CUBEMAP_POSITIVEY&&e.targets.push(34071),e.header.dwCaps2.DDSCAPS2_CUBEMAP_NEGATIVEY&&e.targets.push(34072),e.header.dwCaps2.DDSCAPS2_CUBEMAP_POSITIVEZ&&e.targets.push(34073),e.header.dwCaps2.DDSCAPS2_CUBEMAP_NEGATIVEZ&&e.targets.push(34074),e.numberOfImages=e.targets.length):(e.type=3553,e.targets.push(3553),e.numberOfImages=e.targets.length)},x3dom.DDSLoader._readDDSFlags=function(e){return{DDSD_CAPS:!!(1&e),DDSD_HEIGHT:!!(2&e),DDSD_WIDTH:!!(4&e),DDSD_PITCH:!!(8&e),DDSD_PIXELFORMAT:!!(4096&e),DDSD_MIPMAPCOUNT:!!(131072&e),DDSD_LINEARSIZE:!!(524288&e),DDSD_DEPTH:!!(8388608&e)}},x3dom.DDSLoader._readPFFlags=function(e){return{DDPF_ALPHAPIXELS:!!(1&e),DDPF_ALPHA:!!(2&e),DDPF_FOURCC:!!(4&e),DDPF_RGB:!!(64&e),DDPF_YUV:!!(512&e),DDPF_LUMINANCE:!!(131072&e)}},x3dom.DDSLoader._readCapsFlags=function(e){return{DDSCAPS_COMPLEX:!!(8&e),DDSCAPS_MIPMAP:!!(4194304&e),DDSCAPS_TEXTURE:!!(4096&e)}},x3dom.DDSLoader._readCaps2Flags=function(e){return{DDSCAPS2_CUBEMAP:!!(512&e),DDSCAPS2_CUBEMAP_POSITIVEX:!!(1024&e),DDSCAPS2_CUBEMAP_NEGATIVEX:!!(2048&e),DDSCAPS2_CUBEMAP_POSITIVEY:!!(4096&e),DDSCAPS2_CUBEMAP_NEGATIVEY:!!(8192&e),DDSCAPS2_CUBEMAP_POSITIVEZ:!!(16384&e),DDSCAPS2_CUBEMAP_NEGATIVEZ:!!(32768&e),DDSCAPS2_VOLUME:!!(131072&e)}},x3dom.DDSLoader._readResourceDimension=function(e){switch(e){case 0:return"D3D10_RESOURCE_DIMENSION_UNKNOWN";case 1:return"D3D10_RESOURCE_DIMENSION_BUFFER";case 2:return"D3D10_RESOURCE_DIMENSION_TEXTURE1D";case 3:return"D3D10_RESOURCE_DIMENSION_TEXTURE2D";case 4:return"D3D10_RESOURCE_DIMENSION_TEXTURE3D"}},x3dom.DDSLoader._readMiscFlags=function(e){return{D3D11_RESOURCE_MISC_GENERATE_MIPS:!!(1&e),D3D11_RESOURCE_MISC_SHARED:!!(2&e),D3D11_RESOURCE_MISC_TEXTURECUBE:!!(4&e),D3D11_RESOURCE_MISC_DRAWINDIRECT_ARGS:!!(16&e),D3D11_RESOURCE_MISC_BUFFER_ALLOW_RAW_VIEWS:!!(32&e),D3D11_RESOURCE_MISC_BUFFER_STRUCTURED:!!(64&e),D3D11_RESOURCE_MISC_RESOURCE_CLAMP:!!(128&e),D3D11_RESOURCE_MISC_SHARED_KEYEDMUTEX:!!(256&e),D3D11_RESOURCE_MISC_GDI_COMPATIBLE:!!(512&e),D3D11_RESOURCE_MISC_SHARED_NTHANDLE:!!(2048&e),D3D11_RESOURCE_MISC_RESTRICTED_CONTENT:!!(4096&e),D3D11_RESOURCE_MISC_RESTRICT_SHARED_RESOURCE:!!(8192&e),D3D11_RESOURCE_MISC_RESTRICT_SHARED_RESOURCE_DRIVER:!!(16384&e),D3D11_RESOURCE_MISC_GUARDED:!!(32768&e),D3D11_RESOURCE_MISC_TILE_POOL:!!(131072&e),D3D11_RESOURCE_MISC_TILED:!!(262144&e),D3D11_RESOURCE_MISC_HW_PROTECTED:!!(524288&e)}},x3dom.DDSLoader._readMiscFlags2=function(e){var t={};switch(e){case 0:case 1:case 2:case 3:case 4:t.alphaMode="DDS_ALPHA_MODE_UNKNOWN"}return t},x3dom.DDSLoader._readData=function(e,t,i,s){var o,n,r,a=e.header10?148:128;e.width=e.header.dwWidth,e.height=e.header.dwHeight,e.generateMipmaps=e.numberOfMipmaps<=1&&!e.isCompressed;for(var d=0;d<e.numberOfImages;d++){n=e.header.dwWidth,r=e.header.dwHeight,e.data[e.targets[d]]=[];for(var h=0;h<e.numberOfMipmaps;h++)0!=h&&(n=Math.max(.5*n,1),r=Math.max(.5*r,1)),e.isCompressed?(o=this._readCompressedData(t,n,r,a,e.blockSize),e.data[e.targets[d]][h]=o):(o=this._readUncompressedData(t,n,r,a,e.format),e.data[e.targets[d]][h]=o),a+=o.length*o.BYTES_PER_ELEMENT*e.format.bytesPerElementFactor}return e.format.overwriteType&&(e.format.type=e.format.overwriteType),e.format.overwriteInternalType&&(e.format.internal=e.format.overwriteInternalType),e},x3dom.DDSLoader._readCompressedData=function(e,t,i,s,o){var n=Math.max(1,parseInt((t+3)/4))*Math.max(1,parseInt((i+3)/4))*o;return new Uint8Array(e.slice(s,s+n))},x3dom.DDSLoader._readUncompressedData=function(e,t,i,s,o,n){if(o.bytesPerElementFactor=1,6406==o.internal)return new Uint8Array(e.slice(s,s+t*i));if(6409==o.internal)return new Uint8Array(e.slice(s,s+t*i));if(6410==o.internal)return new Uint8Array(e.slice(s,s+t*i*2));if(6407==o.internal)return x3dom.DDSLoader.R8G8B8_To_B8G8R8(new Uint8Array(e.slice(s,s+t*i*3)));if(36194==o.internal)return new Uint16Array(e.slice(s,s+t*i*2));if(6408==o.internal&&36193!=o.type&&5126!=o.type)return x3dom.DDSLoader.A8R8G8B8_To_A8B8G8R8(new Uint8Array(e.slice(s,s+t*i*4)));if(32854==o.internal)return x3dom.DDSLoader.A4R4G4B4_To_A4B4G4R4(new Uint16Array(e.slice(s,s+t*i*2)));if(32855==o.internal)return x3dom.DDSLoader.A1R5G5B5_To_A1B5G5R5(new Uint16Array(e.slice(s,s+t*i*2)));if(34842==o.internal||36193==o.type)return x3dom.caps.HFP_TEXTURES||2==x3dom.caps.WEBGL_VERSION?new Uint16Array(e.slice(s,s+t*i*4*2)):x3dom.caps.FP_TEXTURES?(o.overwriteType=5126,o.overwriteInternalType=2==x3dom.caps.WEBGL_VERSION?34836:6408,o.bytesPerElementFactor=.5,x3dom.DDSLoader.UI16_To_F32(new Uint16Array(e.slice(s,s+t*i*4*2)))):(o.overwriteType=5121,o.overwriteInternalType=6408,o.bytesPerElementFactor=2,x3dom.DDSLoader.UI16_To_UI8(new Uint16Array(e.slice(s,s+t*i*4*2))));if(34836==o.internal||5126==o.type){if(x3dom.caps.FP_TEXTURES||2==x3dom.caps.WEBGL_VERSION)return new Float32Array(e.slice(s,s+t*i*4*4))}else if(35898==o.internal)return new Uint8Array(e.slice(s,s+t*i*3))},x3dom.DDSLoader._readFormat=function(e){var t=e.header.ddspf;if(t.dwFlags.DDPF_FOURCC)if("DXT1"==t.dwFourCC)e.channelCount=3,e.blockSize=8,e.isCompressed=!0,e.format={internal:33776,format:6407,type:5121};else if("DXT3"==t.dwFourCC)e.channelCount=3,e.blockSize=16,e.isCompressed=!0,e.format={internal:33778,format:6408,type:5121};else if("DXT5"==t.dwFourCC)e.channelCount=4,e.blockSize=16,e.isCompressed=!0,e.format={internal:33779,format:6408,type:5121};else if("t"==t.dwFourCC)e.channelCount=4,2==x3dom.caps.WEBGL_VERSION?e.format={internal:34836,format:6408,type:5126}:e.format={internal:6408,format:6408,type:5126};else{if("q"!=t.dwFourCC&&"$"!=t.dwFourCC)return!1;e.channelCount=4,2==x3dom.caps.WEBGL_VERSION?e.format={internal:34842,format:6408,type:5131}:e.format={internal:6408,format:6408,type:36193}}else if(t.dwFlags.DDPF_RGB&&!t.dwFlags.DDPF_ALPHAPIXELS)if(e.channelCount=3,24==t.dwRGBBitCount&&16711680==t.dwRBitMask&&65280==t.dwGBitMask&&255==t.dwBBitMask)e.format={internal:6407,format:6407,type:5121};else{if(16!=t.dwRGBBitCount||63488!=t.dwRBitMask||2016!=t.dwGBitMask||31!=t.dwBBitMask)return!1;e.format={internal:36194,format:6407,type:33635}}else if(t.dwFlags.DDPF_RGB&&t.dwFlags.DDPF_ALPHAPIXELS)if(e.channelCount=4,32==t.dwRGBBitCount&&16711680==t.dwRBitMask&&65280==t.dwGBitMask&&255==t.dwBBitMask&&4278190080==t.dwABitMask)e.format={internal:6408,format:6408,type:5121};else if(16==t.dwRGBBitCount&&3840==t.dwRBitMask&&240==t.dwGBitMask&&15==t.dwBBitMask&&61440==t.dwABitMask)e.format={internal:32854,format:6408,type:32819};else{if(16!=t.dwRGBBitCount||31744!=t.dwRBitMask||992!=t.dwGBitMask||31!=t.dwBBitMask||32768!=t.dwABitMask)return!1;e.format={internal:32855,format:6408,type:32820}}else if(t.dwFlags.DDPF_LUMINANCE&&!t.dwFlags.DDPF_ALPHAPIXELS){if(8!=t.dwRGBBitCount||255!=t.dwRBitMask)return!1;e.format={internal:6409,format:6409,type:5121},e.channelCount=1}else if(t.dwFlags.DDPF_LUMINANCE&&t.dwFlags.DDPF_ALPHAPIXELS){if(16!=t.dwRGBBitCount||255!=t.dwRBitMask||65280!=t.dwABitMask)return!1;e.format={internal:6410,format:6410,type:5121},e.channelCount=2}else{if(!t.dwFlags.DDPF_ALPHA)return!1;if(8!=t.dwRGBBitCount||255!=t.dwABitMask)return!1;e.format={internal:6406,format:6406,type:5121},e.channelCount=1}return!0},x3dom.DDSLoader.int32ToFourCC=function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255).replace(/[\x00]/g,"")},x3dom.DDSLoader.R8G8B8_To_B8G8R8=function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i+=3)t[i]=e[i+1],t[i+1]=e[i+0],t[i+2]=e[i+2];return t},x3dom.DDSLoader.A8R8G8B8_To_A8B8G8R8=function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i+=4)t[i]=e[i+2],t[i+1]=e[i+1],t[i+2]=e[i+0],t[i+3]=e[i+3];return t},x3dom.DDSLoader.UI16_To_UI8=function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i+=4)t[i]=255*x3dom.DDSLoader.UI16_To_UI8_2(e[i]),t[i+1]=255*x3dom.DDSLoader.UI16_To_UI8_2(e[i+1]),t[i+2]=255*x3dom.DDSLoader.UI16_To_UI8_2(e[i+2]),t[i+3]=255*x3dom.DDSLoader.UI16_To_UI8_2(e[i+3]);return t},x3dom.DDSLoader.UI16_To_F32=function(e){for(var t=new Float32Array(e.length),i=0;i<e.length;i+=4)t[i]=x3dom.DDSLoader.UI16_To_F16(e[i]),t[i+1]=x3dom.DDSLoader.UI16_To_F16(e[i+1]),t[i+2]=x3dom.DDSLoader.UI16_To_F16(e[i+2]),t[i+3]=x3dom.DDSLoader.UI16_To_F16(e[i+3]);return t},x3dom.DDSLoader.UI16_To_F16=function(e){var t=e>>15&1,i=e>>10&1023,s=e&Math.pow(2,10)-1;return 0!==i?Math.pow(-1,t)*(1+s/Math.pow(2,10))*Math.pow(2,i-15):0===s?0:Math.pow(-1,t)*s/Math.pow(2,10)*Math.pow(2,-14)},x3dom.DDSLoader.UI16_To_UI8_2=function(e){var t=x3dom.DDSLoader.UI16_To_F16(e);return t/(t+1)},x3dom.DDSLoader.A4R4G4B4_To_A4B4G4R4=function(e){for(var t,i,s,o,n=new Uint16Array(e.length),r=0;r<e.length;r++)t=e[r]>>12&15,i=e[r]>>8&15,s=e[r]>>4&15,o=15&e[r],n[r]=i<<12&s<<8&o<<4&t;return n},x3dom.DDSLoader.A1R5G5B5_To_A1B5G5R5=function(e){for(var t,i,s,o,n=new Uint16Array(e.length),r=0;r<e.length;r++)t=e[r]>>15&1,i=e[r]>>10&31,s=e[r]>>5&95,o=95&e[r],n[r]=i<<11&s<<6&o<<1&t;return n},x3dom.VRControllerManager=function(){this.leftInline=void 0,this.leftTransform=void 0,this.rightInline=void 0,this.rightTransform=void 0,this.leftGamepadIdx=void 0,this.rightGamepadIdx=void 0,this.vrDisplay=void 0,this.wasPresenting=!1,this.controllers={"HTC Vive MV":{left:"https://x3dom.org/download/assets/vr/vive.glb",right:"https://x3dom.org/download/assets/vr/vive.glb",scaleFactor:new x3dom.fields.SFVec3f(40,40,40),offset:new x3dom.fields.SFVec3f,axesScale:[1,1]},"Oculus Oculus Rift CV1":{left:"https://x3dom.org/download/assets/vr/oculus-touch-left.glb",right:"https://x3dom.org/download/assets/vr/oculus-touch-right.glb",scaleFactor:new x3dom.fields.SFVec3f(39.5,39.5,39.5),offset:new x3dom.fields.SFVec3f,axesScale:[1,1]},"Oculus Go":{left:"https://x3dom.org/download/assets/vr/oculus-go.glb",right:"https://x3dom.org/download/assets/vr/oculus-go.glb",scaleFactor:new x3dom.fields.SFVec3f(1,1,1),offset:new x3dom.fields.SFVec3f(.2,-.3,-.3),axesScale:[1,-1]},"Emulated HTC Vive DVT":{left:"https://x3dom.org/download/assets/vr/vive.glb",right:"https://x3dom.org/download/assets/vr/vive.glb",scaleFactor:new x3dom.fields.SFVec3f(40,40,40),offset:new x3dom.fields.SFVec3f,axesScale:[1,1]},"WindowsMR DELL VISOR VR118":{left:"https://x3dom.org/download/assets/vr/microsoft-left.glb",right:"https://x3dom.org/download/assets/vr/microsoft-right.glb",scaleFactor:new x3dom.fields.SFVec3f(40,40,40),offset:new x3dom.fields.SFVec3f,axesScale:[1,1]}},this._addInlines(),this._addGamePadListeners()},x3dom.VRControllerManager.prototype._addGamePadListeners=function(){window.addEventListener("gamepadconnected",this._onGamePadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this._onGamePadDisconnected.bind(this))},x3dom.VRControllerManager.prototype._onGamePadConnected=function(e){var t=e.gamepad;navigator.getVRDisplays().then(function(e){var i=e[0];if(i&&t.displayId==i.displayId){var s=this.controllers[i.displayName];if(!s)return;"left"==t.hand?(this.leftGamepadIdx=t.index,this.leftInline.setAttribute("url",s.left)):"right"==t.hand&&(this.rightGamepadIdx=t.index,this.rightInline.setAttribute("url",s.right,s.scaleFactor))}}.bind(this))},x3dom.VRControllerManager.prototype._onGamePadDisconnected=function(e){console.log(e)},x3dom.VRControllerManager.prototype._addInlines=function(){var e=document.querySelector("scene")||document.querySelector("Scene");e&&(this.leftTransform=document.createElement("matrixtransform"),this.leftInline=document.createElement("inline"),this.rightTransform=document.createElement("matrixtransform"),this.rightInline=document.createElement("inline"),this.leftInline.setAttribute("render","false"),this.rightInline.setAttribute("render","false"),this.leftTransform.appendChild(this.leftInline),this.rightTransform.appendChild(this.rightInline),e.appendChild(this.leftTransform),e.appendChild(this.rightTransform))},x3dom.VRControllerManager.prototype.fit=function(e,t){var i=e._scene._lastMin,s=e._scene._lastMax.subtract(i).multiply(.5).length(),o=e.vrLeftViewMatrix.e2(),n=Math.min(e._width/e._height,1),r=s/Math.tan(.5*Math.PI/2)/n;e._movement=o.multiply(-r)},x3dom.VRControllerManager.prototype.update=function(e,t){if(!t||t&&!t.isPresenting)this.wasPresenting&&(this.leftInline.setAttribute("render","false"),this.rightInline.setAttribute("render","false"),this.wasPresenting=!1);else{this.wasPresenting||(this.leftInline.setAttribute("render","true"),this.rightInline.setAttribute("render","true"),this.fit(e,t)),this.wasPresenting=!0;var i=navigator.getGamepads(),s={};if(null!=this.leftGamepadIdx&&i[this.leftGamepadIdx]){var o=i[this.leftGamepadIdx];s.left=o}if(null!=this.rightGamepadIdx&&i[this.rightGamepadIdx]){o=i[this.rightGamepadIdx];s.right=o}this.onUpdate(e,t,s)}},x3dom.VRControllerManager.prototype.onUpdate=function(e,t,i){var s=new x3dom.fields.SFMatrix4f,o=new x3dom.fields.SFMatrix4f,n=[0,0],r=this.controllers[t.displayName].axesScale;i.left&&(n[0]+=i.left.axes[0]*r[0],n[1]+=i.left.axes[1]*r[1],i.left.buttons[1].pressed&&this.fit(e)),i.right&&(n[0]+=i.right.axes[0]*r[0],n[1]+=i.right.axes[1]*r[1],i.right.buttons[1].pressed&&this.fit(e));var a=5*n[0],d=5*n[1],h=e.vrLeftViewMatrix.e2(),l=e.vrLeftViewMatrix.e0(),f=e._scene._lastMax.subtract(e._scene._lastMin).length();f=f<x3dom.fields.Eps?1:f,h=new x3dom.fields.SFVec3f(-h.x,-h.y,h.z).multiply(f*(d/e._height)),l=new x3dom.fields.SFVec3f(-l.x,-l.y,l.z).multiply(f*(a/e._width)),e._movement=e._movement.add(l).add(h),s=x3dom.fields.SFMatrix4f.translation(e._movement),e.vrLeftViewMatrix=e.vrLeftViewMatrix.mult(s).mult(o),e.vrRightViewMatrix=e.vrRightViewMatrix.mult(s).mult(o),this._updateControllerModels(e,t,i)},x3dom.VRControllerManager.prototype._updateControllerModels=function(e,t,i){if(!t||t&&!t.isPresenting)return this.leftInline.setAttribute("render","false"),void this.rightInline.setAttribute("render","false");if(this.leftInline.setAttribute("render","true"),this.rightInline.setAttribute("render","true"),i.left){var s=(a=i.left.pose).orientation?x3dom.fields.Quaternion.fromArray(a.orientation):new x3dom.fields.Quaternion,o=a.position?x3dom.fields.SFVec3f.fromArray(a.position):this.controllers[t.displayName].offset,n=this.controllers[t.displayName].scaleFactor;o=o.subtract(e._movement);var r=x3dom.fields.SFMatrix4f.fromRotationTranslationScale(s,o,n);this.leftTransform.setAttribute("matrix",r.toString())}if(i.right){var a;s=(a=i.right.pose).orientation?x3dom.fields.Quaternion.fromArray(a.orientation):new x3dom.fields.Quaternion,o=a.position?x3dom.fields.SFVec3f.fromArray(a.position):this.controllers[t.displayName].offset,n=this.controllers[t.displayName].scaleFactor;o=o.subtract(e._movement);r=x3dom.fields.SFMatrix4f.fromRotationTranslationScale(s,o,n);this.rightTransform.setAttribute("matrix",r.toString())}},x3dom.JSONParser=function(e){this.x3djsonNS="http://www.web3d.org/specifications/x3d-namespace"},x3dom.JSONParser.prototype.constructor=x3dom.JSONParser,x3dom.JSONParser.prototype.parseJavaScript=function(e){var t=this.CreateElement("X3D");return this.ConvertToX3DOM(e,"",t),t},x3dom.JSONParser.prototype.elementSetAttribute=function(e,t,i){"SON schema"===t||"ncoding"===t||"function"==typeof e.setAttribute&&e.setAttribute(t,i)},x3dom.JSONParser.prototype.ConvertChildren=function(e,t,i){var s;for(s in t)"object"==typeof t[s]&&(isNaN(parseInt(s))?this.ConvertObject(s,t,i,e.substr(1)):this.ConvertToX3DOM(t[s],s,i,e.substr(1)))},x3dom.JSONParser.prototype.CreateElement=function(e,t){var i=null;return void 0===this.x3djsonNS?i=document.createElement(e):null==(i=document.createElementNS(this.x3djsonNS,e))&&(console.error("Trouble creating element for",e),i=document.createElement(e)),void 0!==t&&this.elementSetAttribute(i,"containerField",t),i},x3dom.JSONParser.prototype.CDATACreateFunction=function(e,t,i){var s=i.trim().replace(/\\"/g,'\\"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");do{s=(i=s).replace(/'([^'\r\n]*)\n([^']*)'/g,"'$1\\n$2'")}while(s!=i);var o="<script> <![CDATA[ "+s+" ]]> <\/script>",n=(new DOMParser).parseFromString(o,"application/xml").children[0].childNodes[1];t.appendChild(n)},x3dom.JSONParser.prototype.ConvertObject=function(e,t,i,s){var o;if(null!==t&&"object"==typeof t[e])if(e.startsWith("@"))this.ConvertToX3DOM(t[e],e,i);else if(e.startsWith("-"))this.ConvertChildren(e,t[e],i);else if("#comment"===e)for(var n in t[e])o=document.createComment(this.CommentStringToXML(t[e][n])),i.appendChild(o);else if("#sourceText"===e||"#sourceCode"===e)this.CDATACreateFunction(document,i,t[e].join("\r\n")+"\r\n");else if("connect"===e||"fieldValue"===e||"field"===e||"meta"===e||"component"===e)for(var r in t[e])"object"==typeof t[e][r]&&(o=this.CreateElement(e,s),this.ConvertToX3DOM(t[e][r],r,o),i.appendChild(o),i.appendChild(document.createTextNode("\n")));else o=this.CreateElement(e,s),this.ConvertToX3DOM(t[e],e,o),i.appendChild(o),i.appendChild(document.createTextNode("\n"))},x3dom.JSONParser.prototype.CommentStringToXML=function(e){return e=e.replace(/\\\\/g,"\\")},x3dom.JSONParser.prototype.SFStringToXML=function(e){return e=(e=e.replace(/\\/g,"\\\\")).replace(/"/g,'\\"')},x3dom.JSONParser.prototype.JSONStringToXML=function(e){return e=(e=e.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")},x3dom.JSONParser.prototype.ConvertToX3DOM=function(e,t,i,s){var o,n=[],r=!1,a=!1;for(o in e)if(r=!isNaN(parseInt(o)))"number"==typeof e[o]?n.push(e[o]):"string"==typeof e[o]?(n.push(e[o]),a=!0):"boolean"==typeof e[o]?n.push(e[o]):"object"==typeof e[o]?this.ConvertToX3DOM(e[o],o,i):void 0===e[o]||console.error("Unknown type found in array "+typeof e[o]);else if("object"==typeof e[o])if("X3D"===o)this.ConvertToX3DOM(e[o],o,i);else if("-skin"===o||"-skeleton"===o||"-value"===o){var d=e[o][0];for(var h in d)d[h]["@containerField"]=o.substr(1),console.log(d[h]),this.ConvertObject(o,e,i,d[h]["@containerField"])}else 0===o.indexOf("HAnim")&&"HAnimHumanoid"!==o&&void 0!==e[o]["@USE"]?(e[o]["@containerField"]=o.substr(5).toLowerCase()+"s",this.ConvertObject(o,e,i,e[o]["@containerField"])):this.ConvertObject(o,e,i);else if("number"==typeof e[o])this.elementSetAttribute(i,o.substr(1),e[o]);else if("string"==typeof e[o])if("#comment"!==o)this.elementSetAttribute(i,o.substr(1),this.JSONStringToXML(e[o]));else{var l=document.createComment(this.CommentStringToXML(e[o]));i.appendChild(l)}else"boolean"==typeof e[o]?this.elementSetAttribute(i,o.substr(1),e[o]):void 0===e[o]||(console.error("Unknown type found in object "+typeof e[o]),console.error(e));if(r&&t.startsWith("@"))if(a){for(var f in n)n[f]=this.SFStringToXML(n[f]);this.elementSetAttribute(i,t.substr(1),'"'+n.join('" "')+'"')}else this.elementSetAttribute(i,t.substr(1),n.join(" "));return i},x3dom.PROTOS=function(){this.protos={},this.names={},this.protoField={},this.scriptField={},this.interfaceField={},this.envField={},this.scopecount=0,this.privatescope=[],this.defs={},this.founddef=null,this.SFNodes={"-appearance":1,"-body":1,"-child":1,"-collidable":1,"-collider":1,"-color":1,"-composableRenderStyle":1,"-coord":1,"-emitter":1,"-fillProperties":1,"-fogCoord":1,"-fontStyle":1,"-geometry":1,"-geoOrigin":1,"-layout":1,"-lineProperties":1,"-massDensityModel":1,"-material":1,"-metadata":1,"-normal":1,"-nurbsCurve":1,"-nurbsCurve2D":1,"-pickingGeometry":1,"-renderStyle":1,"-shape":1,"-source":1,"-texCoord":1,"-texCoordNurbs":1,"-texCoordRamp":1,"-texture":1,"-texture2D":1,"-texture2DMulti":1,"-texture3D":1,"-textureProperties":1,"-textureTransform":1,"-transferFunction":1,"-viewport":1}},x3dom.PROTOS.prototype={flattenerArray:function(e,t){var i=[],s=0;for(var o in e){var n=this.flattener(e[o],i,e.length);if(Array.isArray(n)){for(var r in n)i[parseInt(o)+s+parseInt(r)]=n[r];s+=n.length-1}else i[parseInt(o)+s]=n}return i},flattenerObject:function(e,t,i){var s={};for(var o in e){var n=this.flattener(e[o],t,i);if(Array.isArray(n))if(this.SFNodes[o]){if(s[o]=n[0],n.length>1){t[i]={Switch:{"@whichChoice":-1,"-children":[{Group:{"-children":[]}}]}};for(var r=1;r<n.length;r++)t[i].Switch["-children"][0].Group["-children"][r-1]=n[r]}}else s[o]=n;else this.SFNodes[o]&&"object"==typeof n&&n["#comment"]?s["-children"]?(s[o]={},s["-children"].push(n)):(s[o]={},s["-children"]=[n]):s[o]=n}return s},flattener:function(e,t,i){if("object"==typeof e){if(Array.isArray(e))var s=this.flattenerArray(e,t);else s=this.flattenerObject(e,t,i);return s}return e},pushScope:function(e){this.privatescope.push(e)},popScope:function(){this.privatescope.pop()},saveDef:function(e){return this.defs[e]=this.getScope(),this.getScope(e)},getDef:function(e){return this.defs[e]},getField:function(e,t){return e+"_"+t},getScope:function(e){var t,i=(t=e?this.defs[e]?this.defs[e]+"_"+e:e:this.privatescope.join("_")).lastIndexOf("DECL");return i>0&&(t=t.substring(i)),t},scopeLength:function(){return this.privatescope.length},upScope:function(e){return this.privatescope.slice(0,this.privatescope.length-e).join("_")},setValueFromInterface:function(e,t,i){var s=this.getInterface(e),o="@";if(void 0!==s&&void 0!==s[0]&&(o=s[0].substr(0,1)),"@"===o&&"children"===i&&(o="-"),"-"===o&&"value"===i&&(o="@"),i=o+i,void 0!==s&&void 0!==s[1]&&void 0!==s[0]&&void 0!==s[1][s[0]]){var n=s[1][s[0]];return Array.isArray(n)&&"SFNode"===s[1]["@type"]&&"-children"!==i&&(console.error("SFNode is array, reducing",n),n=n[0]),Array.isArray(n)||"-children"!==i||(i="@value"),t[i]=n,[s[1]["@type"],s[2]]}},getObjectField:function(e,t){var i="value";for(var s in 1===t.indexOf("FNode")&&(i="children"),e)"@value"!==s&&"-children"!==s||(i=s.substr(1));return i},findFieldByName:function(e,t){for(var i in e){var s=e[i];if(s["@name"]===t)return s}throw"Can't find "+t},getScriptFieldFieldTypeFieldByNameAttribute:function(e,t){var i=this.findFieldByName(e,t),s=i["@name"],o=i["@type"];return[i,s,o,t=this.getObjectField(i,o)]},getScriptFieldFieldTypeField:function(e,t){var i=e[t],s=i["@name"],o=i["@type"];return[i,s,o,this.getObjectField(i,o)]},setScriptFields:function(e,t){var i=this.getScope();for(var s in e){var o=this.getScriptFieldFieldTypeField(e,s),n=o[0],r=o[1],a=o[2],d=o[3],h=this.setValueFromInterface(r,n,d);this.setScriptField(i,r,n,d,a,t),void 0!==h&&this.setScriptField(h[1],r,n,d,a,t)}},setScriptField:function(e,t,i,s,o,n){void 0===this.scriptField[this.getField(e,t)]&&(this.scriptField[this.getField(e,t)]=[]),this.scriptField[this.getField(e,t)][this.scriptField[this.getField(e,t)].length]=[i,s,o,n]},setEnv:function(e,t,i,s,o,n){var r=this.getInterface(t);void 0!==r&&(e=r[2]),void 0===this.envField[this.getField(e,t)]&&(this.envField[this.getField(e,t)]=[]),this.envField[this.getField(e,t)][this.envField[this.getField(e,t)].length]=[i,s,o,n]},getEnv:function(e,t){return this.envField[this.getField(e,t)]},setConnectField:function(e,t,i,s,o,n){void 0===this.protoField[this.getField(e,t)]&&(this.protoField[this.getField(e,t)]=[]),this.protoField[this.getField(e,t)][this.protoField[this.getField(e,t)].length]=[i,s,o,n]},setConnectFields:function(e,t,i){var s=e["@DEF"],o=this.saveDef(s),n=e[t].connect,r=this.getScope();for(var a in n){var d=n[a];if(d){var h=this.getScope(d["@protoField"]),l=d["@nodeField"],f=this.setValueFromInterface(h,i,l),u=void 0;void 0!==f?(u=f[0],this.setEnv(r,h,i,l,u,o),this.setConnectField(r,h,i,l,u,o),this.setConnectField(f[1],h,i,l,u,o)):(this.setEnv(r,h,i,l,u,o),this.setConnectField(r,h,i,l,u,o))}}},setScriptConnectFields:function(e,t,i,s){var o=t[i].connect,n=this.getScope(),r=t["@DEF"];s.field=this.realPrototypeExpander(e,t.field,!0);s["@DEF"];for(var a in o){var d=o[a];if(d){var h=this.getScope(d["@protoField"]),l=d["@nodeField"],f=this.getScriptFieldFieldTypeFieldByNameAttribute(s.field,l);d=f[0];f[1];var u=f[2];l=f[3];var _=this.setValueFromInterface(h,d,l);void 0!==_?(u=_[0],this.setScriptField(n,h,d,l,u,r),this.setScriptField(_[1],h,d,l,u,r)):this.setScriptField(n,h,d,l,u,r)}}},getInterface:function(e){for(var t=0;t<this.scopeLength();t++){var i=this.upScope(t);if(!i)break;var s=this.interfaceField[this.getField(i,e)];if(s)return s}},setInterface:function(e,t){var i=this.getScope();this.interfaceField[this.getField(i,e["@name"])]=[t,e,i]},clearScope:function(e,t){var i=this.getScope();delete this.scriptField[this.getField(i,e)],delete this.protoField[this.getField(i,e)],this.zap(e,t)},extractConnectedDef:function(e,t){var i;for(var s in this.scriptField[this.getField(e,t)])if(void 0===i){var o=this.scriptField[this.getField(e,t)][s];if(void 0!==o&&void 0!==o[3]){var n=this.getField(e,o[3]);-1==n.indexOf("DECL",1)&&(i=[n,o[0]["@name"]])}}if(void 0===i)for(var r in this.protoField[this.getField(e,t)]){var a=this.protoField[this.getField(e,t)][r];void 0!==a&&(i=[a[3],a[1]])}if(void 0===i)for(var d in this.protoField[this.getField(e,"__DEF_FIELD__")]){var h=this.protoField[this.getField(e,"__DEF_FIELD__")][d];void 0!==h&&(i=[h[3],t])}return void 0===i&&(i=[e,t]),i},setObjectValues:function(e,t,i,s){var o=!1;for(var n in this.protoField[this.getField(e,t)]){var r=this.protoField[this.getField(e,t)][n];void 0!==r&&(this.setObjectValue(e,t,r,i,s),o=!0)}for(var a in this.scriptField[this.getField(e,t)]){var d=this.scriptField[this.getField(e,t)][a];void 0!==d&&(this.setObjectValue(e,t,d,i,s),o=!0)}if(!o)for(var h=0;h<this.scopeLength();h++){var l=this.upScope(h);if(!l)break;var f=this.getEnv(l,t);for(var u in f){var _=f[u];void 0!==_&&_[3].indexOf(l)===_[3].lastIndexOf(l)&&this.setObjectValue(l,_[1],_,i,s)}}},setObjectValue:function(e,t,i,s,o){Array.isArray(o)&&void 0!==i[2]&&("SFNode"===i[2]?o=o[0]:i[2]);var n=i[1].substr(0,1);"@"===(n="-"!==n&&"@"!==n?s.substr(0,1):"")&&"children"===i[1]&&(n="-"),"-"===n&&"value"===i[1]&&(n="@"),Array.isArray(o)||"children"!==i[1]||(o=[o]),i[0][n+i[1]]=o},zap:function(e,t){var i;if("object"==typeof t)for(i in t)if("is"===i.toLowerCase()){var s=t[i].connect;for(var o in s){var n=s[o];n&&n["@protoField"]===e&&delete s[o]}}else this.zap(e,t[i]);return t},zapIs:function(e){var t;if("object"==typeof e)for(t in e)"is"===t.toLowerCase()?delete e[t]:this.zapIs(e[t]);return e},prototypeExpander:function(e,t){return t},readCode:function(e,t,i,s,o,n){void 0!==e&&(n[o]["#sourceText"]=e.split(/\r?\n/),delete n[o]["@url"])},handleScript:function(e,t,i,s){s[i]=this.realPrototypeExpander(e,t[i],!0),this.setScriptFields(s[i].field,s[i]["@DEF"]);var o=s[i]["@url"];this.loadURLs(e,o,this.readCode,null,(function(){}),i,s)},handleProtoDeclare:function(e,t,i){var s=t[i]["@name"],o=t[i]["@DEF"];return this.protos[s]=t[i],this.saveDef(o),void 0!==t[i]["@appinfo"]&&(this.protos[s]["@appinfo"]=t[i]["@appinfo"]),void 0!==t[i]["@documentation"]&&(this.protos[s]["@documentation"]=t[i]["@documentation"]),this.pushScope("DECL"+s),this.names[o]=s,this.realPrototypeExpander(e,t[i],!1),this.popScope(),t},handleProtoInterface:function(e,t,i){var s=t[i].field;for(var o in s){var n=s[o];void 0!==n["@value"]?this.setInterface(n,"@value"):void 0!==n["-children"]?this.setInterface(n,"-children"):this.setInterface(n)}return t},handleProtoInstance:function(e,t,i){var s=t[i]["@name"],o=t[i]["@DEF"],n=t[i]["@USE"];this.names[o]=s,void 0===s&&void 0!==n&&(s=this.names[n]),this.pushScope("DECL"+s);var r,a={};if(void 0===o&&void 0===n&&(o="INSTANCE"),this.getDef(o)&&void 0===n&&(this.scopecount+=1e3,o+=""+this.scopecount),void 0!==o){this.saveDef(o);this.pushScope(o)}if(void 0===this.protos[s]||void 0===this.protos[s].ProtoBody)console.error("ProtoBody undefined for",s);else{var d=this.protos[s].ProtoBody["-children"];for(var h in d){var l=d[h];for(var f in l)if(void 0===r&&(r=l[f]["@DEF"],void 0!==n)){this.saveDef(n);this.pushScope(n)}}a=JSON.parse(JSON.stringify(d))}for(var u=a;Array.isArray(u)&&null!==u[0]&&void 0!==u[0];)u=u[0];if(void 0!==n&&"object"==typeof u){(_={})[f]={},_[f]["@USE"]=this.getScope(),void 0!==r&&this.popScope()}else{var _=this.realPrototypeExpander(e,a,!1),c=t[i].fieldValue;for(var m in c){var p=c[m],x=p["@name"],v="@value",g=p[v];for(var y in p)"@name"!==y&&(g=p[v=y],this.pushScope("FIELD"+x),"object"==typeof u&&void 0!==u[f]&&(u[f]["@DEF"]=this.getScope()),g=this.realPrototypeExpander(e,g,!1),this.popScope(),this.getInterface(x),this.setObjectValues(this.getScope(),x,v,g))}}return void 0!==n&&this.popScope(),void 0!==o&&this.popScope(),this.popScope(),_},realPrototypeExpander:function(e,t,i){if("object"==typeof t){var s=null;for(var o in s=Array.isArray(t)?[]:{},t){var n=o.toLowerCase();if("script"===n)this.handleScript(e,t,o,s);else if("protodeclare"===n)this.handleProtoDeclare(e,t,o);else if("protointerface"===n)this.handleProtoInterface(e,t,o);else if("protobody"===n)this.realPrototypeExpander(e,t[o],i);else if("protoinstance"===n)s=this.handleProtoInstance(e,t,o);else if("connect"===n)this.realPrototypeExpander(e,t[o],i);else if("fieldvalue"===n)this.realPrototypeExpander(e,t[o],i);else if("field"===n)s[o]=this.realPrototypeExpander(e,t[o],i);else if("@value"===n)s[o]=this.realPrototypeExpander(e,t[o],i);else if("-children"===n)s[o]=this.realPrototypeExpander(e,t[o],i);else if("is"===n)i?this.setScriptConnectFields(e,t,o,s):this.setConnectFields(t,o,s),this.realPrototypeExpander(e,t[o],i);else if("route"===n){s[o]={};var r=this.extractConnectedDef(this.getScope(t[o]["@fromNode"]),t[o]["@fromField"]);s[o]["@fromNode"]=r[0],s[o]["@fromField"]=r[1];var a=this.extractConnectedDef(this.getScope(t[o]["@toNode"]),t[o]["@toField"]);s[o]["@toNode"]=a[0],s[o]["@toField"]=a[1]}else"@name"===n?s[o]=t[o]:"@def"===n?(s[o]=this.saveDef(t[o]),this.setConnectField(this.getScope(),"__DEF_FIELD__",s,t[o],"SFString",s[o])):s[o]="@use"===n?this.getScope(t[o]):this.realPrototypeExpander(e,t[o],i)}return s}return t},searchForProtoDeclare:function(e,t){var i,s;if("object"==typeof e)for(i in e)"ProtoDeclare"===i&&(e[i]["@name"]===t&&(s=e),void 0===s&&null===this.founddef&&(this.founddef=e)),void 0===s&&(s=this.searchForProtoDeclare(e[i],t));return s},searchAndReplaceProto:function(e,t,i,s,o,n){var r=this.searchForProtoDeclare(t,i);if(void 0===r&&(r=s),null===r||void 0===r.ProtoDeclare)console.error("ProtoDeclare is still null or undefined",e,i,JSON.stringify(t));else{var a=o["@name"],d=o["@appinfo"],h=o["@description"];r.ProtoDeclare["@name"]=a,r.ProtoDeclare["@appinfo"]=d,r.ProtoDeclare["@description"]=h}n(r)},loadedProto:function(e,t,i,s,o,n){if(void 0!==e)try{this.founddef=null;var r={};try{r=JSON.parse(e),o.searchAndReplaceProto(s,r,t,o.founddef,i,n)}catch(r){if("function"==typeof DOM2JSONSerializer)try{var a=(new DOM2JSONSerializer).serializeToString(null,e.firstElementChild,s,mapToMethod,fieldTypes);o.searchAndReplaceProto(s,JSON.parse(a),t,o.founddef,i,n)}catch(e){"function"==typeof alert&&alert(e),console.error("Convert failed",e)}else console.error("Did not convert XML to JSON.  Oops!")}}catch(e){console.error("Failed to parse JSON in ",s,e)}else console.error("data is undefined for file",s)},doLoad:function(e,t,i,s,o,n){var r=n["@name"],a=t.indexOf("#"),d=r;a>=0&&(d=t.substring(a+1));try{i.loadedProto(e,d,n,t,i,(function(e){s(o,e,i)}))}catch(e){console.error("Error searching for proto",e)}},processURLs:function(e,t){var i;for(i in e){if(0===e[i].indexOf("http://")||0===e[i].indexOf("https://"));else if(0===e[i].indexOf("urn:web3d:media:textures/panoramas/")){var s=e[i].lastIndexOf("/");s>0&&(e[i]="examples/Basic/UniversalMediaPanoramas/"+e[i].substring(s+1))}else{var o=e[i].indexOf("#"),n=t.lastIndexOf("/"),r=t;for(n>=0&&(r=t.substring(0,n));e[i].startsWith("../");){e[i]=e[i].substr(3);n=r.lastIndexOf("/");r=n>=0?r.substring(0,n):""}e[i]=0==o?t+e[i]:r+"/"+e[i]}var a=e[i].lastIndexOf("#"),d="";a>=0&&(d=e[i].substring(a),e[i]=e[i].substring(0,a));var h=e[i].lastIndexOf(".wrl");h===e[i].length-4&&(e[i]=e[i].substring(0,h)+".json"+d);var l=e[i].lastIndexOf(".wrz");l===e[i].length-4&&(e[i]=e[i].substring(0,l)+".json"+d)}return e},loadURLs:function(e,t,i,s,o,n,r){if(void 0!==t)for(var a in t=this.processURLs(t,e))try{!function(t){var a=t.indexOf("://"),d="file",h="localhost",l="/"+e;if(a>0){d=t.substring(0,a);var f=t.indexOf("/",a+3);h=t.substring(a+3,f),l=t.substring(f)}if("http"===d){if("undefined"!=typeof http)http.get({host:h,path:l},(function(e){var a="";e.on("data",(function(e){a+=e})),e.on("end",(function(){i(a,t,s,o,n,r)}))}));else if((_=new XMLHttpRequest).open("GET",t,!1),_.send(null),200===_.status){var u=_.responseText;i(u,t,s,o,n,r)}}else if("https"===d){if("undefined"!=typeof https)https.get({host:h,path:l},(function(e){var a="";e.on("data",(function(e){a+=e})),e.on("end",(function(){i(a,t,s,o,n,r)}))}));else if((_=new XMLHttpRequest).open("GET",t,!1),_.send(null),200===_.status){u=_.responseText;i(u,t,s,o,n,r)}}else if("undefined"==typeof fs||d.startsWith("http")){var _;if((_=new XMLHttpRequest).open("GET",t,!1),_.send(null),200===_.status){u=_.responseText;i(u,t,s,o,n,r)}else console.error("Didn't load",t,".  No file system or http request.")}else{var c=t.indexOf("#");c>0&&(t=t.substring(0,c));try{var u=fs.readFileSync(t);i(u.toString(),t,s,o,n,r)}catch(e){var m=t;m.endsWith(".json")&&(m=m.substring(0,m.lastIndexOf("."))+".x3d","function"==typeof runAndSend&&runAndSend(["---silent",m],(function(e){u=JSON.stringify(e),i(u,m,s,o,n,r)})))}}}(t[a])}catch(e){console.error(e)}},load:function(e,t,i,s,o){var n=i[e],r=n["@url"];this.loadURLs(t,r,s.doLoad,s,o,e,n)},externalPrototypeExpander:function(e,t){if("object"==typeof t){var i=null;for(var s in i=Array.isArray(t)?[]:{},t)"ExternProtoDeclare"===s?this.load(s,e,t,this,(function(t,s,o){null!=s&&void 0!==s&&(i.ProtoDeclare=o.externalPrototypeExpander(e,s).ProtoDeclare)})):i[s]=this.externalPrototypeExpander(e,t[s]);for(var o=Object.keys(t).length;o>Object.keys(i).length+1;);return setTimeout((function(){}),50),i}return t}},x3dom.protoExpander=new x3dom.PROTOS,x3dom.ProtoDeclaration=function(e,t,i,s,o,n){this._nameSpace=e,this.name=t,this._protoBody=i||null,this.fields=s||[],this.isExternProto=o||!1,this.url=n||[],this.needsLoading=!0,this.instanceQueue=[]},x3dom.ProtoDeclaration.prototype.registerNode=function(){var e=this;x3dom.registerNodeType(e.name,"Core",defineClass(x3dom.nodeTypes.X3DNode,(function(t){x3dom.nodeTypes[e.name].superClass.call(this,t),this._cf_hash={},e.fields.forEach((function(i){if(i.dataType.endsWith("ode")){t&&t.xmlNode&&0==t.xmlNode.querySelectorAll("[containerField='"+i.name+"']").length&&i.cfValue.forEach((function(e){t.xmlNode.appendChild(e.cloneNode(!0))}));var s=x3dom.nodeTypes.X3DNode,o=e._protoBody._ISRoutes;if(i.name in o){var n=o[i.name][0],r=n.nodeField,a=e._protoBody.querySelector("[DEF="+n.nodeDEF+"]"),d=a.localName.toLowerCase();if(d in x3dom.nodeTypesLC){var h={doc:t.doc,runtime:t.runtime,xmlNode:a.cloneNode(!0),nameSpace:t.nameSpace},l=new x3dom.nodeTypesLC[d](h);r in l._cf&&(s=l._cf[r].type)}}else x3dom.debug.logWarning(e.name+" Proto: field without IS connection - "+i.name);this["addField_"+i.dataType](i.name,s),this._cf_hash[i.name]="trigger"}else t&&t.xmlNode&&!t.xmlNode.hasAttribute(i.name)&&i.value&&t.xmlNode.setAttribute(i.name,i.value),this["addField_"+i.dataType](t,i.name,i.value)}),this);var i="protoNS";t.xmlNode.hasAttribute("DEF")&&(i=t.xmlNode.getAttribute("DEF")+"NS"),this.innerNameSpace=new x3dom.NodeNameSpace(i,t.doc),this.innerNameSpace.setBaseURL(t.nameSpace.baseURL+e.name),e._nameSpace.addSpace(this.innerNameSpace),e._nameSpace.protos.forEach((function(e){this.innerNameSpace.protos.push(e)}),this),this.nodes=[],this.protoBodyClone=e._protoBody.cloneNode(!0),this.declaration=e,this.isProtoInstance=!0,this._changing=!1,this._externTries=0,this._maxTries=5}),{nodeChanged:function(e){if(!this._changing){this._changing=!0;var t=this.protoBodyClone;t.querySelectorAll(":scope > *").forEach((function(e){var i=e.localName.toLowerCase();"protodeclare"==i?this.innerNameSpace.protoDeclare(e):"externprotodeclare"==i?this.innerNameSpace.externProtoDeclare(e):"protoinstance"==i&&this.innerNameSpace.protoInstance(e,t)}),this);var i,s=this.protoBodyClone.childNodes;for(i=0;i<s.length;i++){var o=this.innerNameSpace.setupTree.call(this.innerNameSpace,s[i],this);null!=o&&this.nodes.push(o)}this.typeNode=this.nodes[0],this.helperNodes=this.nodes.slice(1);var n,r=this._xmlNode.attributes;for(i=0;i<r.length;i++)(n=r[i]).name.startsWith("on")&&this.typeNode._xmlNode.setAttribute(n.name,n.value);for(var a in this._vf)this.fieldChanged(a);for(a in this._cf){"nodes"in this._cf[a]&&this._cf_hash[a]===this._get_cf_hash(a)&&a!=e||this.fieldChanged(a)}for(a in this._vf){a in this.declaration._protoBody._ISRoutes&&this._setupFieldWatchers(a)}for(a in this._changing=!1,this._cf)"nodes"in this._cf[a]&&(this._cf_hash[a]=this._get_cf_hash(a))}},fieldChanged:function(e){try{var t=this.declaration._protoBody._ISRoutes;if(!(e in t))return;t[e].forEach((function(t){var i=this.innerNameSpace.defMap[t.nodeDEF];if(null!=i){this._externTries=0;var s=this._normalizeName(t.nodeField,i);if(e in this._vf)i._vf[s]=this._vf[e],i.fieldChanged(s);else if(e in this._cf){i._cf[s]=this._cf[e];var o=[];if("MFNode"==i._cfFieldTypes[s]?o=this._cf[e].nodes:"SFNode"==i._cfFieldTypes[s]&&this._cf[e].node?o=[this._cf[e].node]:x3dom.debug.logWarning("Unexpected field type: "+i._cfFieldTypes[s]),i._childNodes.forEach((function(e){i.removeChild(e,s,"force")})),o.forEach((function(e){i.addChild(e,s)})),"MFNode"==i._cfFieldTypes[s])for(var n=0;n<o.length;n++)for(var r=o[n],a=o.length-1;a>n;a--)r==o[a]&&o.splice(a,1);i.nodeChanged(s)}}else{if("protoinstance"==this.protoBodyClone.querySelector("[DEF="+t.nodeDEF+"]").tagName.toLowerCase()&&this._externTries++<this._maxTries){x3dom.debug.logWarning(" ExternProto instance attempt: "+this._externTries);setTimeout(this.fieldChanged.bind(this),1e3,e)}}}),this)}catch(e){x3dom.debug.logWarning("Proto warning: "+e)}},_normalizeName:function(e,t){return e in t._vf?e:e.replace(/^set_/,"").replace(/_changed$/,"")},_setupFieldWatchers:function(e){this.declaration._protoBody._ISRoutes[e].forEach((function(t){var i=this.innerNameSpace.defMap[t.nodeDEF];if(null!=i){var s=this._normalizeName(t.nodeField,i);i._fieldWatchers[s]||(i._fieldWatchers[s]=[]);var o=this.postMessage.bind(this,e),n=i._fieldWatchers[s];n.push(o);var r=n.length-1;this._fieldWatchers[e]||(this._fieldWatchers[e]=[]);var a=function(e){n.splice(r,1),i.postMessage(s,e),n.push(o),r=n.length-1}.bind(i);this._fieldWatchers[e].push(a)}else{if("protoinstance"==this.protoBodyClone.querySelector("[DEF="+t.nodeDEF+"]").tagName.toLowerCase()&&this._externTries++<this._maxTries){x3dom.debug.logWarning(" retrying ExternProto: "+this._externTries);setTimeout(this._setupFieldWatchers.bind(this),1e3,e)}}}),this)},_get_cf_hash:function(e){return this._cf[e].nodes.length}}))},x3dom.shader={},x3dom.shader.PICKING="picking",x3dom.shader.PICKING_24="picking24",x3dom.shader.PICKING_ID="pickingId",x3dom.shader.PICKING_COLOR="pickingColor",x3dom.shader.PICKING_TEXCOORD="pickingTexCoord",x3dom.shader.FRONTGROUND_TEXTURE="frontgroundTexture",x3dom.shader.BACKGROUND_TEXTURE="backgroundTexture",x3dom.shader.BACKGROUND_SKYTEXTURE="backgroundSkyTexture",x3dom.shader.BACKGROUND_CUBETEXTURE="backgroundCubeTexture",x3dom.shader.BACKGROUND_CUBETEXTURE_DDS="backgroundCubeTextureDDS",x3dom.shader.BLUR="blur",x3dom.shader.DEPTH="depth",x3dom.shader.NORMAL="normal",x3dom.shader.TEXTURE_REFINEMENT="textureRefinement",x3dom.shader.SSAO="ssao",x3dom.shader.material=function(){return"uniform vec3  diffuseColor;\nuniform vec3  specularColor;\nuniform vec3  emissiveColor;\nuniform float shininess;\nuniform float transparency;\nuniform float ambientIntensity;\n"},x3dom.shader.physicalMaterial=function(){return"uniform vec3  baseColorFacor;\nuniform vec3  emissiveFactor;\nuniform float metallicFactor;\nuniform float roughnessFactor;\n"},x3dom.shader.twoSidedMaterial=function(){return"uniform vec3  backDiffuseColor;\nuniform vec3  backSpecularColor;\nuniform vec3  backEmissiveColor;\nuniform float backShininess;\nuniform float backTransparency;\nuniform float backAmbientIntensity;\n"},x3dom.shader.fog=function(){return"uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nvarying vec3 fragEyePosition;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}\n"},x3dom.shader.clipPlanes=function(e){var t,i="";for(t=0;t<e;t++)i+="uniform vec4 clipPlane"+t+"_Plane;\n",i+="uniform float clipPlane"+t+"_CappingStrength;\n",i+="uniform vec3 clipPlane"+t+"_CappingColor;\n";for(i+="vec3 calculateClipPlanes() {\n",t=0;t<e;t++)i+="vec4 clipPlane"+t+";\n",i+="if(fragEyeIdx == 1.0){\n",i+="    clipPlane"+t+" = clipPlane"+t+"_Plane * viewMatrixInverse2;\n",i+="}else{\n",i+="    clipPlane"+t+" = clipPlane"+t+"_Plane * viewMatrixInverse;\n",i+="}\n",i+="float dist"+t+" = dot(fragPosition, clipPlane"+t+");\n";for(i+="    if( ",t=0;t<e;t++)0!=t&&(i+=" || "),i+="dist"+t+" < 0.0";for(i+=" ) ",i+="{ discard; }\n",t=0;t<e;t++)i+="    if( abs(dist"+t+") < clipPlane"+t+"_CappingStrength ) ",i+="{ return clipPlane"+t+"_CappingColor; }\n";return i+="    return vec3(-1.0, -1.0, -1.0);\n",i+="}\n"},x3dom.shader.gammaCorrectionDecl=function(e){var t="";return"none"===e.GAMMACORRECTION||("fastlinear"===e.GAMMACORRECTION?(t+="vec4 gammaEncode(vec4 color){\n  vec4 tmp = sqrt(color);\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec4 gammaDecode(vec4 color){\n  vec4 tmp = color * color;\n  return vec4(tmp.rgb, color.a);\n}\n",t+="vec3 gammaEncode(vec3 color){\n  return sqrt(color);\n}\n",t+="vec3 gammaDecode(vec3 color){\n  return (color * color);\n}\n"):(t+="const vec4 gammaEncode4Vector = vec4(0.4545454545454545, 0.4545454545454545, 0.4545454545454545, 1.0);\n",t+="const vec4 gammaDecode4Vector = vec4(2.2, 2.2, 2.2, 1.0);\n",t+="vec4 gammaEncode(vec4 color){\n    return pow(abs(color), gammaEncode4Vector);\n}\n",t+="vec4 gammaDecode(vec4 color){\n    return pow(abs(color), gammaDecode4Vector);\n}\n",t+="const vec3 gammaEncode3Vector = vec3(0.4545454545454545, 0.4545454545454545, 0.4545454545454545);\n",t+="const vec3 gammaDecode3Vector = vec3(2.2, 2.2, 2.2);\n",t+="vec3 gammaEncode(vec3 color){\n    return pow(abs(color), gammaEncode3Vector);\n}\n",t+="vec3 gammaDecode(vec3 color){\n    return pow(abs(color), gammaDecode3Vector);\n}\n")),t},x3dom.shader.encodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaEncode ("+t+")"},x3dom.shader.decodeGamma=function(e,t){return"none"===e.GAMMACORRECTION?t:"gammaDecode ("+t+")"},x3dom.shader.rgbaPacking=function(){return"vec4 packDepth(float depth){\n    depth = (depth + 1.0)*0.5;\n    vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n    outVal = fract(outVal);\n      outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n      return outVal;\n}\n","float unpackDepth(vec4 color){\n    float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n    return (2.0*depth - 1.0);\n}\n","vec4 packDepth(float depth){\n    depth = (depth + 1.0)*0.5;\n    vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n    outVal = fract(outVal);\n      outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n      return outVal;\n}\nfloat unpackDepth(vec4 color){\n    float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n    return (2.0*depth - 1.0);\n}\n"};x3dom.shader.calcMipLevel=function(){return"vec2 dirToCubeUV( vec3 dir ) {\n    vec2 uv = vec2(0.0);\n    vec3 absDir = abs(dir);\n    if( absDir.x >= absDir.y && absDir.x >= absDir.z) {\n        if(dir.x < 0.0) {\n           uv.x = 1.0 - (((dir.z/absDir.x) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.x) + 1.0) * 0.5);\n       } else {\n           uv.x = 1.0 - (((-dir.z/absDir.x) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.x) + 1.0) * 0.5);\n       }\n   } else if( absDir.y >= absDir.x && absDir.y >= absDir.z) {\n       if(dir.y < 0.0) {\n              uv.x = ((dir.x/absDir.y) + 1.0) * 0.5;\n           uv.y = ((-dir.z/absDir.y) + 1.0) * 0.5;\n       } else {\n           uv.x = ((dir.x/absDir.y) + 1.0) * 0.5;\n           uv.y = ((dir.z/absDir.y) + 1.0) * 0.5;\nif(uv.y == 0.0) { uv.x = 1.0; uv.y = 0.0; }\n       }\n   } else if( absDir.z >= absDir.x && absDir.z >= absDir.y) {\n       if(dir.z < 0.0) {\n           uv.x = (((-dir.x/absDir.z) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.z) + 1.0) * 0.5);\n       } else {\n           uv.x = ((dir.x/absDir.z) + 1.0) * 0.5;\n           uv.y = 1.0 - (((-dir.y/absDir.z) + 1.0) * 0.5);\n       }\n   }\n   float a = pow(64.0,2.0) / pow(64.0,3.0);\n    uv.x = a * pow(uv.x, 3.0) + uv.x;\n    uv.y = a * pow(uv.y, 3.0) + uv.y;\n   return uv;\n}\n","float calcMipLevel( vec2 uv ) {\n    vec2  dx_vtc        = dFdx(uv) * 64.0;\n    vec2  dy_vtc        = dFdy(uv) * 64.0;\n    float delta_max_sqr = max(dot(dx_vtc, dx_vtc), dot(dy_vtc, dy_vtc));\n    return 0.5 * log2(delta_max_sqr);\n}\n","vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 64.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}","vec2 dirToCubeUV( vec3 dir ) {\n    vec2 uv = vec2(0.0);\n    vec3 absDir = abs(dir);\n    if( absDir.x >= absDir.y && absDir.x >= absDir.z) {\n        if(dir.x < 0.0) {\n           uv.x = 1.0 - (((dir.z/absDir.x) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.x) + 1.0) * 0.5);\n       } else {\n           uv.x = 1.0 - (((-dir.z/absDir.x) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.x) + 1.0) * 0.5);\n       }\n   } else if( absDir.y >= absDir.x && absDir.y >= absDir.z) {\n       if(dir.y < 0.0) {\n              uv.x = ((dir.x/absDir.y) + 1.0) * 0.5;\n           uv.y = ((-dir.z/absDir.y) + 1.0) * 0.5;\n       } else {\n           uv.x = ((dir.x/absDir.y) + 1.0) * 0.5;\n           uv.y = ((dir.z/absDir.y) + 1.0) * 0.5;\nif(uv.y == 0.0) { uv.x = 1.0; uv.y = 0.0; }\n       }\n   } else if( absDir.z >= absDir.x && absDir.z >= absDir.y) {\n       if(dir.z < 0.0) {\n           uv.x = (((-dir.x/absDir.z) + 1.0) * 0.5);\n           uv.y = 1.0 - (((-dir.y/absDir.z) + 1.0) * 0.5);\n       } else {\n           uv.x = ((dir.x/absDir.z) + 1.0) * 0.5;\n           uv.y = 1.0 - (((-dir.y/absDir.z) + 1.0) * 0.5);\n       }\n   }\n   float a = pow(64.0,2.0) / pow(64.0,3.0);\n    uv.x = a * pow(uv.x, 3.0) + uv.x;\n    uv.y = a * pow(uv.y, 3.0) + uv.y;\n   return uv;\n}\nfloat calcMipLevel( vec2 uv ) {\n    vec2  dx_vtc        = dFdx(uv) * 64.0;\n    vec2  dy_vtc        = dFdy(uv) * 64.0;\n    float delta_max_sqr = max(dot(dx_vtc, dx_vtc), dot(dy_vtc, dy_vtc));\n    return 0.5 * log2(delta_max_sqr);\n}\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 64.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}"},x3dom.shader.shadowRendering=function(){var e="";return e+="float getLightInfluence(float lType, float lShadowIntensity, float lOn, vec3 lLocation, vec3 lDirection, float lCutOffAngle, float lBeamWidth, vec3 lAttenuation, float lRadius, vec3 eyeCoords) {\n    if (lOn == 0.0 || lShadowIntensity == 0.0){ return 0.0;\n    } else if (lType == 0.0) {\n        return 1.0;\n    } else {\n       float attenuation = 0.0;\n       vec3 lightVec = (lLocation - (eyeCoords));\n       float distance = length(lightVec);\n        lightVec = normalize(lightVec);\n        eyeCoords = normalize(-eyeCoords);\n       if(lRadius == 0.0 || distance <= lRadius) {\n           attenuation = 1.0 / max(lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance), 1.0);\n        }\n         if (lType == 1.0) return attenuation;\n       float spotAngle = acos(max(0.0, dot(-lightVec, normalize(lDirection))));\n       if(spotAngle >= lCutOffAngle) return 0.0;\n       else if(spotAngle <= lBeamWidth) return attenuation;\n       else return attenuation * (spotAngle - lCutOffAngle) / (lBeamWidth - lCutOffAngle);\n    }\n}\n",e+="void getShadowValues(inout vec4 shadowMapValues, inout float viewSampleDepth, in mat4 lightMatrix, in vec4 worldCoords, in sampler2D shadowMap){\n    vec4 lightSpaceCoords = lightMatrix*worldCoords;\n    vec3 lightSpaceCoordsCart = lightSpaceCoords.xyz / lightSpaceCoords.w;\n    vec2 textureCoords = (lightSpaceCoordsCart.xy + 1.0)*0.5;\n    viewSampleDepth = lightSpaceCoordsCart.z;\n    shadowMapValues = texture2D(shadowMap, textureCoords);\n",x3dom.caps.FP_TEXTURES||(e+="    shadowMapValues = vec4(1.0,1.0,unpackDepth(shadowMapValues),1.0);\n"),e+="}\n",e+="void getShadowValuesPointLight(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec3 lLocation, in vec4 worldCoords, in mat4 lightViewMatrix,in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2, in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5,in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2, in sampler2D shadowMap_3,in sampler2D shadowMap_4, in sampler2D shadowMap_5){\n    vec4 transformed = lightViewMatrix * worldCoords;\n    vec3 lightVec = normalize(transformed.xyz/transformed.w);\n    vec3 lightVecAbs = abs(lightVec);\n    float maximum = max(max(lightVecAbs.x, lightVecAbs.y),lightVecAbs.z);\n    if (lightVecAbs.x == maximum) {\n        if (lightVec.x < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3,worldCoords,shadowMap_3);\n        else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1,worldCoords,shadowMap_1);\n    }\n    else if (lightVecAbs.y == maximum) {\n        if (lightVec.y < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4,worldCoords,shadowMap_4);\n        else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5,worldCoords,shadowMap_5);\n    }\n    else if (lightVec.z < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0,worldCoords,shadowMap_0);\n    else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2,worldCoords,shadowMap_2);\n}\n",e+="void getShadowValuesCascaded(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec4 worldCoords, in float eyeDepth, in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2,in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5, in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2,in sampler2D shadowMap_3, in sampler2D shadowMap_4, in sampler2D shadowMap_5, in float split_0, in float split_1, in float split_2, in float split_3, in float split_4){\n    if (eyeDepth < split_0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0, worldCoords, shadowMap_0);\n    else if (eyeDepth < split_1) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1, worldCoords, shadowMap_1);\n    else if (eyeDepth < split_2) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2, worldCoords, shadowMap_2);\n    else if (eyeDepth < split_3) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3, worldCoords, shadowMap_3);\n    else if (eyeDepth < split_4) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4, worldCoords, shadowMap_4);\n    else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5, worldCoords, shadowMap_5);\n}\n",e+="float ESM(float shadowMapDepth, float viewSampleDepth, float offset){\n",x3dom.caps.FP_TEXTURES?e+="    return shadowMapDepth * exp(-80.0*(1.0-offset)*viewSampleDepth);\n":e+="    return exp(-80.0*(1.0-offset)*(viewSampleDepth - shadowMapDepth));\n",e+="}\n",e+="float VSM(vec2 moments, float viewSampleDepth, float offset){\n    viewSampleDepth = (viewSampleDepth + 1.0) * 0.5;\n    if (viewSampleDepth <= moments.x) return 1.0;\n    float variance = moments.y - moments.x * moments.x;\n    variance = max(variance, 0.00002 + offset*0.01);\n    float d = viewSampleDepth - moments.x;\n    return variance/(variance + d*d);\n}\n"},x3dom.shader.light=function(e){for(var t="",i=0;i<e;i++)t+="uniform float light"+i+"_On;\nuniform float light"+i+"_Type;\nuniform vec3  light"+i+"_Location;\nuniform vec3  light"+i+"_Direction;\nuniform vec3  light"+i+"_Color;\nuniform vec3  light"+i+"_Attenuation;\nuniform float light"+i+"_Radius;\nuniform float light"+i+"_Intensity;\nuniform float light"+i+"_AmbientIntensity;\nuniform float light"+i+"_BeamWidth;\nuniform float light"+i+"_CutOffAngle;\nuniform float light"+i+"_ShadowIntensity;\n";return t+="void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 positionVS, in vec3 N, in vec3 V, float shin, float ambIntensity, vec3 reflectivity, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n        V = normalize(V);\n        attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n        L = normalize(L);\n        V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n           attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n        }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = clamp(dot(L, N), 0.0, 1.0);\n   float NdotH = clamp(dot(H, N), 0.0, 1.0);\n   float ambientFactor  = lAmbientIntensity * ambIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shin*128.0);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n"},x3dom.shader.lightPBR=function(e){for(var t="",i=0;i<e;i++)t+="uniform float light"+i+"_On;\nuniform float light"+i+"_Type;\nuniform vec3  light"+i+"_Location;\nuniform vec3  light"+i+"_Direction;\nuniform vec3  light"+i+"_Color;\nuniform vec3  light"+i+"_Attenuation;\nuniform float light"+i+"_Radius;\nuniform float light"+i+"_Intensity;\nuniform float light"+i+"_AmbientIntensity;\nuniform float light"+i+"_BeamWidth;\nuniform float light"+i+"_CutOffAngle;\nuniform float light"+i+"_ShadowIntensity;\n";return t+="void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 positionVS, in vec3 N, in vec3 V, float shin, float ambIntensity, vec3 reflectivity, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n        V = normalize(V);\n        attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n        L = normalize(L);\n        V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n           attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n        }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  fresnel = vec3(1.0, 1.0, 1.0);\n   vec3  H = normalize( L + V );\n   float NoL = clamp( dot( N, L ), 0.0, 1.0 );\n   float NoH = clamp( dot( N, H ), 0.0, 1.0 );\n   float NoV = clamp( dot( N, V ), 0.0, 1.0 );\n   float VoH = clamp( dot( V, H ), 0.0, 1.0 );\n   float ambientFactor  = lAmbientIntensity * ambIntensity;\n   float diffuseFactor  = lIntensity * NoL;\n   float spec  = lIntensity * NoL;\n   float roughness = 1.0 - shin;\n   float a = max( roughness * roughness, 5e-4 );\n   float a2 = a * a;\n   float denom = NoH * NoH * ( a2 - 1.0 ) + 1.0;\n   float D = a2 / ( denom * denom );\n   float k = a / 2.0;\n   float G_V = ( NoV * ( 1.0 - k ) + k );\n   float G_L = ( NoL * ( 1.0 - k ) + k );\n   float G = 0.25 / ( G_V * G_L );\n   vec3 F = reflectivity + (fresnel - fresnel*reflectivity) * exp2( (-5.55473 * VoH - 6.98316) * VoH );\n   vec3 specularFactor = (D * G) * (F * spec);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n"},x3dom.shader.TBNCalculation=function(){return"mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\n","vec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord, vec3 bias )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = 2.0 * map - 1.0;\n    map = map * bias;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n","mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\nvec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord, vec3 bias )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = 2.0 * map - 1.0;\n    map = map * bias;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n"},x3dom.shader.toneMapping=function(){return"uniform float tonemappingOperator;\n","vec3 tonemapReinhard(vec3 color) { \n    return color / (color + vec3(1.0));\n}\n\n","vec3 uncharted2Tonemap(vec3 color) { \n    float A = 0.15;\n    float B = 0.50;\n    float C = 0.10;\n    float D = 0.20;\n    float E = 0.02;\n    float F = 0.30;\n    return ((color*(A*color+C*B)+D*E)/(color*(A*color+B)+D*F))-E/F;\n}\n\n","vec3 tonemapUncharted2(vec3 color) { \n    float W = 11.2;\n   float exposureBias = 2.0;\n    vec3 curr = uncharted2Tonemap(exposureBias * color);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W));\n    return curr * whiteScale;\n}\n\n","vec3 tonemapeFilmic(vec3 color) { \n    const float a = 2.51;\n    const float b = 0.03;\n    const float c = 2.43;\n    const float d = 0.59;\n    const float e = 0.14;\n    return clamp((color * (a * color + b)) / (color * (c * color + d ) + e), 0.0, 1.0);\n}\n\n","vec3 tonemap(vec3 color) { \n    if(tonemappingOperator == 0.0) {\n       return color;\n    }\n    if(tonemappingOperator == 1.0) {\n       return tonemapReinhard(color);\n    }\n    if(tonemappingOperator == 2.0) {\n       return tonemapUncharted2(color);\n    }\n    if(tonemappingOperator == 3.0) {\n       return tonemapeFilmic(color);\n    }\n}\n\n","uniform float tonemappingOperator;\nvec3 tonemapReinhard(vec3 color) { \n    return color / (color + vec3(1.0));\n}\n\nvec3 uncharted2Tonemap(vec3 color) { \n    float A = 0.15;\n    float B = 0.50;\n    float C = 0.10;\n    float D = 0.20;\n    float E = 0.02;\n    float F = 0.30;\n    return ((color*(A*color+C*B)+D*E)/(color*(A*color+B)+D*F))-E/F;\n}\n\nvec3 tonemapUncharted2(vec3 color) { \n    float W = 11.2;\n   float exposureBias = 2.0;\n    vec3 curr = uncharted2Tonemap(exposureBias * color);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W));\n    return curr * whiteScale;\n}\n\nvec3 tonemapeFilmic(vec3 color) { \n    const float a = 2.51;\n    const float b = 0.03;\n    const float c = 2.43;\n    const float d = 0.59;\n    const float e = 0.14;\n    return clamp((color * (a * color + b)) / (color * (c * color + d ) + e), 0.0, 1.0);\n}\n\nvec3 tonemap(vec3 color) { \n    if(tonemappingOperator == 0.0) {\n       return color;\n    }\n    if(tonemappingOperator == 1.0) {\n       return tonemapReinhard(color);\n    }\n    if(tonemappingOperator == 2.0) {\n       return tonemapUncharted2(color);\n    }\n    if(tonemappingOperator == 3.0) {\n       return tonemapeFilmic(color);\n    }\n}\n\n"},x3dom.shader.DynamicShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t,x3dom.caps.WEBGL_VERSION),s=this.generateFragmentShader(e,t,x3dom.caps.WEBGL_VERSION);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShader.prototype.generateVertexShader=function(e,t,i){var s="";s+="uniform mat4 modelMatrix;\n",s+="uniform mat4 modelViewMatrix;\n",s+="uniform mat4 modelViewProjectionMatrix;\n",s+="uniform mat4 modelViewMatrix2;\n",s+="uniform mat4 modelViewProjectionMatrix2;\n",s+="uniform float isVR;\n",s+="attribute float eyeIdx;\n",s+="varying float vrOffset;\n",s+="varying float fragEyeIdx;\n",3==t.POSCOMPONENTS?s+="attribute vec3 position;\n":4==t.POSCOMPONENTS&&(s+="attribute vec4 position;\n"),t.POPGEOMETRY&&(s+="uniform float PG_precisionLevel;\n",s+="uniform float PG_powPrecision;\n",s+="uniform vec3 PG_maxBBSize;\n",s+="uniform vec3 PG_bbMin;\n",s+="uniform vec3 PG_bbMaxModF;\n",s+="uniform vec3 PG_bboxShiftVec;\n",s+="uniform float PG_numAnchorVertices;\n",s+="attribute float PG_vertexID;\n"),(t.LIGHTS||t.PBR_MATERIAL)&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="varying vec3 fragNormal;\n",s+="uniform mat4 normalMatrix;\n",s+="uniform mat4 normalMatrix2;\n",2==t.NORCOMPONENTS?4!=t.POSCOMPONENTS&&(s+="attribute vec2 normal;\n"):3==t.NORCOMPONENTS&&(s+="attribute vec3 normal;\n"))),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?(s+="attribute vec3 color;\n",s+="varying vec3 fragColor;\n"):4==t.COLCOMPONENTS&&(s+="attribute vec4 color;\n",s+="varying vec4 fragColor;\n")),t.TEXTURED&&(s+="varying vec2 fragTexcoord;\n",t.MULTITEXCOORD&&(s+="varying vec2 fragTexcoord2;\n"),t.SPHEREMAPPING||t.IS_PARTICLE||(s+="attribute vec2 texcoord;\n",t.MULTITEXCOORD&&(s+="attribute vec2 texcoord2;\n")),t.TEXTRAFO&&(s+="uniform mat4 texTrafoMatrix;\n"),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&(t.TANGENTDATA||x3dom.caps.STD_DERIVATIVES||x3dom.debug.logWarning("Your System doesn't support the 'OES_STANDARD_DERIVATIVES' Extension. You must set tangents and binormals manually via the FloatVertexAttribute-Node to use normal maps"),s+="attribute vec3 tangent;\n",s+="attribute vec3 binormal;\n",s+="varying vec3 fragTangent;\n",s+="varying vec3 fragBinormal;\n"),t.DISPLACEMENTMAP&&(s+="uniform sampler2D displacementMap;\n",s+="uniform float displacementFactor;\n",s+="uniform float displacementWidth;\n",s+="uniform float displacementHeight;\n",s+="uniform float displacementAxis;\n"),t.DIFFPLACEMENTMAP&&(s+="uniform sampler2D diffuseDisplacementMap;\n",s+="uniform float displacementFactor;\n",s+="uniform float displacementWidth;\n",s+="uniform float displacementHeight;\n",s+="uniform float displacementAxis;\n")),(t.CUBEMAP||t.PBR_MATERIAL)&&(s+="varying vec3 fragViewDir;\n",s+="uniform mat4 viewMatrix;\n",s+="uniform mat4 viewMatrix2;\n"),t.VERTEXID&&(s+="attribute float id;\n",s+="varying float fragID;\n"),t.IS_PARTICLE&&(s+="attribute vec3 particleSize;\n"),t.POINTPROPERTIES&&(s+="uniform vec3 pointSizeAttenuation;\n",s+="uniform float pointSizeFactor;\n",s+="uniform float minPointSize;\n",s+="uniform float maxPointSize;\n"),(t.LIGHTS||t.FOG||t.CLIPPLANES||t.POINTPROPERTIES)&&(s+="uniform vec3 eyePosition;\n",s+="varying vec4 fragPosition;\n",s+="varying vec4 fragPositionWS;\n",t.FOG&&(s+="varying vec3 fragEyePosition;\n")),t.REQUIREBBOX&&(s+="uniform vec3 bgCenter;\n",s+="uniform vec3 bgSize;\n",s+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXNOR&&(s+="uniform float bgPrecisionNorMax;\n"),t.REQUIREBBOXCOL&&(s+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(s+="uniform float bgPrecisionTexMax;\n"),s+="void main(void) {\n",s+="mat4 mat_mvp = modelViewProjectionMatrix;\n",s+="mat4 mat_mv  = modelViewMatrix;\n",s+="fragEyeIdx = eyeIdx;\n",(t.CUBEMAP||t.PBR_MATERIAL)&&(s+="mat4 mat_v   = viewMatrix;\n"),(t.LIGHTS||t.PBR_MATERIAL)&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="mat4 mat_n   = normalMatrix;\n")),s+="if(eyeIdx == 1.0){\n",s+="    mat_mvp = modelViewProjectionMatrix2;\n",(t.CUBEMAP||t.PBR_MATERIAL)&&(s+="    mat_v   = viewMatrix2;\n"),(t.LIGHTS||t.PBR_MATERIAL)&&(t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="mat4 mat_n   = normalMatrix2;\n")),s+="}\n",s+="vec3 vertPosition = position.xyz;\n",t.POPGEOMETRY?(s+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",s+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",s+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",s+="   vertPosition /= (65536.0 - PG_powPrecision);\n",s+="}\n",s+="else {\n",s+="   vertPosition /= bgPrecisionMax;\n",s+="}\n",s+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(s+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n"),t.LIGHTS&&(2==t.NORCOMPONENTS?(4==t.POSCOMPONENTS?(s+="vec3 vertNormal = vec3(position.w / 256.0); \n",s+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",s+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):t.REQUIREBBOXNOR&&(s+="vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n"),s+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",s+="vec4 sinCosThetaPhi = sin( vec4(thetaPhi, thetaPhi + 1.5707963267949) ); \n",s+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",s+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",s+="vertNormal.z = sinCosThetaPhi.z; \n"):t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="vec3 vertNormal = normal;\n",t.REQUIREBBOXNOR&&(s+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),t.POPGEOMETRY&&(s+="vertNormal = 2.0*vertNormal - 1.0;\n"))),t.VERTEXCOLOR&&(s+="fragColor = color;\n",t.REQUIREBBOXCOL&&(s+="fragColor = fragColor / bgPrecisionColMax;\n")),t.TEXTURED&&!t.SPHEREMAPPING&&(t.IS_PARTICLE||t.POINTPROPERTIES?s+="vec2 vertTexCoord = vec2(0.0);\n":(s+="vec2 vertTexCoord = texcoord;\n",t.MULTITEXCOORD&&(s+="vec2 vertTexCoord2 = texcoord2;\n"),t.REQUIREBBOXTEX&&(s+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"))),t.LIGHTS&&(!t.DISPLACEMENTMAP&&!t.DIFFPLACEMENTMAP||t.NORMALMAP?t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="fragNormal = (mat_n * vec4(vertNormal, 0.0)).xyz;\n"):(s+="float dx = 1.0 / displacementWidth;\n",s+="float dy = 1.0 / displacementHeight;\n",t.DISPLACEMENTMAP?(s+="float s1 = texture2D(displacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).r;\n",s+="float s2 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).r;\n",s+="float s3 = texture2D(displacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).r;\n",s+="float s4 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).r;\n"):t.DIFFPLACEMENTMAP&&(s+="float s1 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).a;\n",s+="float s2 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).a;\n",s+="float s3 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).a;\n",s+="float s4 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).a;\n"),s+="float coef = displacementFactor;\n",s+="vec3 calcNormal;\n",s+="if (displacementAxis == 0.0) {\n",s+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",s+="} else if(displacementAxis == 1.0) {\n",s+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",s+="} else {\n",s+="calcNormal = vec3((s1 - s3) * coef, -(s2 - s4) * coef, 5.0);\n",s+="}\n",s+="calcNormal = normalize(calcNormal);\n",s+="fragNormal = (mat_n * vec4(calcNormal, 0.0)).xyz;\n")),(t.CUBEMAP||t.PBR_MATERIAL)&&(s+="fragViewDir = (mat_v[3].xyz);\n"),t.TEXTURED&&(t.SPHEREMAPPING?(s+=" fragTexcoord = 0.5 + fragNormal.xy / 2.0;\n",t.TEXTRAFO&&(s+=" fragTexcoord = (texTrafoMatrix * vec4(fragTexcoord, 1.0, 1.0)).xy;\n")):t.TEXTRAFO?s+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(s+=" fragTexcoord = vertTexCoord;\n",t.MULTITEXCOORD&&(s+=" fragTexcoord2 = vertTexCoord2;\n"),t.POPGEOMETRY&&!0===x3dom.debug.usePrecisionLevelAsTexCoord&&(s+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")),t.NORMALMAP&&"TANGENT"==t.NORMALSPACE&&t.TANGENTDATA&&(s+="fragTangent  = (mat_n * vec4(tangent, 0.0)).xyz;\n",s+="fragBinormal = (mat_n * vec4(binormal, 0.0)).xyz;\n")),(t.LIGHTS||t.FOG||t.CLIPPLANES||t.POINTPROPERTIES)&&(s+="fragPosition = (mat_mv * vec4(vertPosition, 1.0));\n",s+="fragPositionWS = (modelMatrix * vec4(vertPosition, 1.0));\n",t.FOG&&(s+="fragEyePosition = eyePosition - fragPosition.xyz;\n")),t.DISPLACEMENTMAP?s+="vertPosition += normalize(vertNormal) * texture2D(displacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).r * displacementFactor;\n":t.DIFFPLACEMENTMAP&&(s+="vertPosition += normalize(vertNormal) * texture2D(diffuseDisplacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).a * displacementFactor;\n"),s+="gl_Position = mat_mvp * vec4(vertPosition, 1.0);\n",s+="if(isVR == 1.0){\n",s+="    vrOffset = eyeIdx * 0.5;\n",s+="    gl_Position.x *= 0.5;\n",s+="    gl_Position.x += vrOffset * gl_Position.w;\n",s+="}\n",t.IS_PARTICLE?(s+="float spriteDist = (gl_Position.w > 0.000001) ? gl_Position.w : 0.000001;\n",s+="float pointSize = floor(length(particleSize) * 256.0 / spriteDist + 0.5);\n",s+="gl_PointSize = clamp(pointSize, 2.0, 256.0);\n"):t.POINTPROPERTIES?(s+="float r = length( fragPosition.xyz );\n",s+="vec3 a = pointSizeAttenuation;\n",s+="float attFactor = ( a.x + a.y * r + a.z * r * r );\n",s+="float pointSize =  pointSizeFactor * 1.0 / attFactor;\n",s+="gl_PointSize = clamp(pointSize, minPointSize, maxPointSize);\n"):s+="gl_PointSize = 2.0;\n",s+="}\n",2==i&&(s=x3dom.shader.convertVertexShader(s));var o=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,s),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+s),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(o))),o},x3dom.shader.DynamicShader.prototype.generateFragmentShader=function(e,t,i){var s="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";if(s+=" precision highp float;\n",s+="#else\n",s+=" precision mediump float;\n",s+="#endif\n\n",t.PBR_MATERIAL&&x3dom.caps.TEXTURE_LOD&&(s+="#extension GL_EXT_shader_texture_lod : enable\n"),(t.PBR_MATERIAL||t.NORMALMAP)&&x3dom.caps.STD_DERIVATIVES&&(s+="#extension GL_OES_standard_derivatives:enable\n"),s+="//@insertFragColor\n",s+="uniform float isVR;\n",s+="varying float vrOffset;\n",s+="varying float fragEyeIdx;\n",s+="uniform float screenWidth;\n",s+="uniform vec3 cameraPosWS;\n",s+="uniform float alphaCutoff;\n",s+=x3dom.shader.material(),s+=x3dom.shader.toneMapping(),t.PBR_MATERIAL&&!x3dom.caps.TEXTURE_LOD&&1==x3dom.caps.WEBGL_VERSION&&(s+=x3dom.shader.calcMipLevel()),t.TWOSIDEDMAT&&(s+=x3dom.shader.twoSidedMaterial()),t.PBR_MATERIAL&&(t.ISROUGHNESSMETALLIC&&(s+="uniform float metallicFactor;\n"),s+="uniform sampler2D brdfMap;\n",s+="uniform samplerCube diffuseEnvironmentMap;\n",s+="uniform samplerCube specularEnvironmentMap;\n"),t.VERTEXCOLOR&&(3==t.COLCOMPONENTS?s+="varying vec3 fragColor;  \n":4==t.COLCOMPONENTS&&(s+="varying vec4 fragColor;  \n")),(t.CUBEMAP||t.CLIPPLANES||t.PBR_MATERIAL)&&(s+="uniform mat4 viewMatrixInverse;\n",s+="uniform mat4 viewMatrixInverse2;\n",s+="uniform mat4 modelViewMatrixInverse;\n",s+="uniform mat4 modelViewMatrixInverse2;\n"),t.VERTEXID&&(s+="varying float fragID;\n"),t.TEXTURED&&(s+="varying vec2 fragTexcoord;\n",t.MULTITEXCOORD&&(s+="varying vec2 fragTexcoord2;\n"),(t.TEXTURED||t.DIFFUSEMAP)&&(s+="uniform sampler2D diffuseMap;\n"),(t.CUBEMAP||t.PBR_MATERIAL)&&(s+="uniform samplerCube environmentMap;\n",s+="varying vec3 fragViewDir;\n",t.CSSHADER&&(s+="uniform float environmentFactor;\n")),t.EMISSIVEMAP&&(s+="uniform sampler2D emissiveMap;\n"),t.OCCLUSIONMAP&&(s+="uniform sampler2D occlusionMap;\n"),t.ROUGHNESSMETALLICMAP&&(s+="uniform sampler2D roughnessMetallicMap;\n"),t.SPECULARGLOSSINESSMAP&&(s+="uniform sampler2D specularGlossinessMap;\n"),t.OCCLUSIONROUGHNESSMETALLICMAP&&(s+="uniform sampler2D occlusionRoughnessMetallicMap;\n"),t.SPECMAP&&(s+="uniform sampler2D specularMap;\n"),t.SHINMAP&&(s+="uniform sampler2D shininessMap;\n"),t.DISPLACEMENTMAP&&(s+="uniform sampler2D displacementMap;\n",s+="uniform float displacementWidth;\n",s+="uniform float displacementHeight;\n"),t.DIFFPLACEMENTMAP&&(s+="uniform sampler2D diffuseDisplacementMap;\n",s+="uniform float displacementWidth;\n",s+="uniform float displacementHeight;\n"),t.NORMALMAP&&(s+="uniform sampler2D normalMap;\n",s+="uniform vec3 normalBias;\n","TANGENT"==t.NORMALSPACE?x3dom.caps.STD_DERIVATIVES||2==x3dom.caps.WEBGL_VERSION?s+=x3dom.shader.TBNCalculation():(s+="varying vec3 fragTangent;\n",s+="varying vec3 fragBinormal;\n"):"OBJECT"==t.NORMALSPACE&&(s+="uniform mat4 normalMatrix;\n",s+="uniform mat4 normalMatrix2;\n"))),t.FOG&&(s+=x3dom.shader.fog()),(t.LIGHTS||t.CLIPPLANES)&&(s+="varying vec4 fragPosition;\n",s+="varying vec4 fragPositionWS;\n",s+="uniform float isOrthoView;\n"),t.LIGHTS){t.NORMALMAP&&"OBJECT"==t.NORMALSPACE||(s+="varying vec3 fragNormal;\n");var o=t.LIGHTS;t.PHYSICALENVLIGHT&&o--,t.PBR_MATERIAL&&o?s+=x3dom.shader.lightPBR(t.LIGHTS):o&&(s+=x3dom.shader.light(t.LIGHTS))}if(t.CLIPPLANES&&(s+=x3dom.shader.clipPlanes(t.CLIPPLANES)),s+=x3dom.shader.gammaCorrectionDecl(t),s+="void main(void) {\n",(t.CUBEMAP||t.CLIPPLANES||t.PBR_MATERIAL)&&(s+="mat4 mat_mvi = modelViewMatrixInverse;\n",s+="mat4 mat_vi  = viewMatrixInverse;\n"),"OBJECT"==t.NORMALSPACE&&(s+="mat4 mat_n = normalMatrix;\n"),s+="if(fragEyeIdx == 1.0){\n",(t.CUBEMAP||t.CLIPPLANES)&&(s+="    mat_mvi   = modelViewMatrixInverse2;\n",s+="    mat_vi    = viewMatrixInverse2;\n"),"OBJECT"==t.NORMALSPACE&&(s+="    mat_n   = normalMatrix2;\n"),s+="}\n",s+="if ( isVR == 1.0) {\n",s+="    if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n",s+="}\n",t.CLIPPLANES&&(s+="vec3 cappingColor = calculateClipPlanes();\n"),s+="vec4 color;\n",s+="vec4 texColor;\n",s+="color.rgb = diffuseColor;\n",s+="color.a = 1.0 - transparency;\n",s+="vec3 _emissiveColor     = emissiveColor;\n",s+="float _shininess        = shininess;\n",s+="vec3 _specularColor     = specularColor;\n",s+="float _ambientIntensity = ambientIntensity;\n",s+="float _transparency     = transparency;\n",s+="float _occlusion        = 1.0;\n","OPAQUE"==t.ALPHAMODE&&(s+="color.a = 1.0;\n"),t.PBR_MATERIAL&&t.ISROUGHNESSMETALLIC&&(s+="float _metallic         = metallicFactor;\n"),t.SEPARATEBACKMAT&&(s+="  if(!gl_FrontFacing) {\n",s+="    color.rgb = backDiffuseColor;\n",s+="    color.a = 1.0 - backTransparency;\n",s+="    _transparency = 1.0 - backTransparency;\n",s+="    _shininess = backShininess;\n",s+="    _emissiveColor = backEmissiveColor;\n",s+="    _specularColor = backSpecularColor;\n",s+="    _ambientIntensity = backAmbientIntensity;\n",s+="  }\n"),t.VERTEXCOLOR&&(3!==t.COLCOMPONENTS&&"OPAQUE"!=t.ALPHAMODE||!t.PBR_MATERIAL?3!==t.COLCOMPONENTS||t.PBR_MATERIAL?4===t.COLCOMPONENTS&&t.PBR_MATERIAL?s+="color *= fragColor;\n":4!==t.COLCOMPONENTS||t.PBR_MATERIAL||(s+="color = fragColor;\n"):s+="color.rgb = fragColor.rgb;\n":s+="color.rgb *= fragColor.rgb;\n"),t.IS_PARTICLE||t.POINTPROPERTIES?(s+="vec2 texcoord = clamp(gl_PointCoord, 0.01, 0.99);\n",t.MULTITEXCOORD&&(s+="vec2 texcoord2 = texcoord;\n")):t.TEXTURED&&(s+="vec2 texcoord = fragTexcoord;\n",t.MULTITEXCOORD&&(s+="vec2 texcoord2 = fragTexcoord2;\n")),t.UNLIT)t.DIFFUSEMAP&&(t.DIFFUSEMAPCHANNEL?s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, vec2(texcoord2.x, 1.0 - texcoord2.y))")+";\n":s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, vec2(texcoord.x, 1.0 - texcoord.y))")+";\n","OPAQUE"==t.ALPHAMODE&&(s+="texColor.a = 1.0;\n"),s+="color *= texColor;\n");else if(t.LIGHTS){if(s+="vec3 ambient   = vec3(0.0, 0.0, 0.0);\n",s+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n",s+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n",s+="vec3 eye;\n",s+="vec3 positionVS = fragPosition.rgb;\n",s+="if ( isOrthoView > 0.0 ) {\n",s+="    eye = vec3(0.0, 0.0, 1.0);\n",s+="} else {\n",s+="    eye = -fragPosition.xyz;\n",s+="}\n",t.NORMALMAP&&(s+="vec3 _normalBias = normalBias;\n"),t.NORMALMAP&&"OBJECT"==t.NORMALSPACE?s+="vec3 normal = vec3(0.0, 0.0, 0.0);\n":s+="vec3 normal = normalize(fragNormal);\n",t.SOLID&&!t.TWOSIDEDMAT||(s+="if (dot(normalize(fragNormal), eye) < 0.0) {\n",s+="  normal *= -1.0;\n",t.NORMALMAP&&(s+="  _normalBias = _normalBias * _normalBias;\n"),s+="}\n"),t.TEXTURED&&(t.NORMALMAP&&("TANGENT"==t.NORMALSPACE?(s+="vec3 n = normal;\n",t.TANGENTDATA||!x3dom.caps.STD_DERIVATIVES&&2!=x3dom.caps.WEBGL_VERSION?(s+="vec3 t = normalize( fragTangent );\n",s+="vec3 b = normalize( fragBinormal );\n",s+="mat3 tangentToWorld = mat3(t, b, n);\n",s+="normal = texture2D( normalMap, vec2(texcoord.x, 1.0-texcoord.y) ).rgb;\n",s+="normal = 2.0 * normal - 1.0;\n",s+="normal = normalize( normal * tangentToWorld );\n"):s+="normal = perturb_normal( n, fragPosition.xyz, vec2(texcoord.x, 1.0 - texcoord.y), _normalBias);\n"):"OBJECT"==t.NORMALSPACE&&(s+="normal = texture2D( normalMap, vec2(texcoord.x, 1.0-texcoord.y) ).rgb;\n",s+="normal = 2.0 * normal - 1.0;\n",s+="normal = (mat_n * vec4(normal, 0.0)).xyz;\n",s+="normal = normalize(normal);\n")),t.CUBEMAP?(s+="vec3 viewDir = normalize(fragViewDir);\n",s+="vec3 reflected = reflect(-eye, normal);\n",s+="reflected = (mat_mvi * vec4(reflected, 0.0)).xyz;\n",s+="texColor = "+x3dom.shader.decodeGamma(t,"textureCube(environmentMap, reflected)")+";\n"):t.DIFFPLACEMENTMAP?s+="texColor = texture2D(diffuseDisplacementMap, vec2(texcoord.x, 1.0-texcoord.y));\n":(t.DIFFUSEMAP||t.TEXT)&&(t.PIXELTEX?t.DIFFUSEMAPCHANNEL?s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texcoord2)")+";\n":s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texcoord)")+";\n":t.DIFFUSEMAPCHANNEL?s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, vec2(texcoord2.x, 1.0 - texcoord2.y))")+";\n":s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, vec2(texcoord.x, 1.0 - texcoord.y))")+";\n"),"OPAQUE"==t.ALPHAMODE&&(s+="texColor.a = 1.0;\n"),t.BLENDING&&(t.DIFFUSEMAP||t.TEXT||t.DIFFPLACEMENTMAP||t.CUBEMAP)?t.CUBEMAP&&t.CSSHADER?s+="color.rgb *= mix(vec3(1.0,1.0,1.0), texColor.rgb, environmentFactor);\n":s+="color *= texColor;\n":!t.BLENDING&&(t.DIFFUSEMAP||t.TEXT||t.DIFFPLACEMENTMAP||t.CUBEMAP)&&(s+="color = texColor;\n"),t.SHINMAP&&(s+="_shininess *= texture2D( shininessMap, vec2(texcoord.x, 1.0-texcoord.y) ).r;\n"),t.SPECMAP&&(s+="_specularColor = texture2D(specularMap, vec2(texcoord.x, 1.0-texcoord.y)).rgb;\n"),t.EMISSIVEMAP&&(t.EMISSIVEMAPCHANNEL?s+="_emissiveColor = _emissiveColor * texture2D(emissiveMap, vec2(texcoord2.x, 1.0-texcoord2.y)).rgb;\n":s+="_emissiveColor = _emissiveColor * texture2D(emissiveMap, vec2(texcoord.x, 1.0-texcoord.y)).rgb;\n"),t.ROUGHNESSMETALLICMAP&&(t.ROUGHNESSMETALLICMAPCHANNEL?s+="vec3 roughnessMetallic = texture2D(roughnessMetallicMap, vec2(texcoord2.x, 1.0-texcoord2.y)).rgb;\n":s+="vec3 roughnessMetallic = texture2D(roughnessMetallicMap, vec2(texcoord.x, 1.0-texcoord.y)).rgb;\n",s+="_shininess = 1.0 - (roughnessMetallic.g * (1.0 - _shininess));\n",s+="_metallic  = roughnessMetallic.b * metallicFactor;\n"),t.SPECULARGLOSSINESSMAP&&(t.SPECULARGLOSSINESSMAPCHANNEL?s+="vec4 specularGlossiness = "+x3dom.shader.decodeGamma(t,"texture2D(specularGlossinessMap, vec2(texcoord2.x, 1.0 - texcoord2.y))")+";\n":s+="vec4 specularGlossiness = "+x3dom.shader.decodeGamma(t,"texture2D(specularGlossinessMap, vec2(texcoord.x, 1.0 - texcoord.y))")+";\n",s+="_shininess = specularGlossiness.a * _shininess;\n"),t.OCCLUSIONROUGHNESSMETALLICMAP&&(t.OCCLUSIONROUGHNESSMETALLICMAPCHANNEL?s+="vec3 occlusionRoughnessMetallic = texture2D(occlusionRoughnessMetallicMap, vec2(texcoord2.x, 1.0-texcoord2.y)).rgb;\n":s+="vec3 occlusionRoughnessMetallic = texture2D(occlusionRoughnessMetallicMap, vec2(texcoord.x, 1.0-texcoord.y)).rgb;\n",s+="_occlusion = occlusionRoughnessMetallic.r;\n",s+="_shininess = 1.0 - occlusionRoughnessMetallic.g;\n",s+="_metallic  = occlusionRoughnessMetallic.b;\n"),t.OCCLUSIONMAP&&(t.OCCLUSIONMAPCHANNEL?s+="_occlusion = texture2D(occlusionMap, vec2(texcoord2.x, 1.0-texcoord2.y)).r;\n":s+="_occlusion = texture2D(occlusionMap, vec2(texcoord.x, 1.0-texcoord.y)).r;\n")),t.PBR_MATERIAL&&t.ISROUGHNESSMETALLIC?(s+="_specularColor = mix(vec3(0.04, 0.04, 0.04), color.rgb, _metallic);\n",s+="color.rgb *= (1.0 - _metallic);\n"):t.PBR_MATERIAL&&t.SPECULARGLOSSINESSMAP&&(s+="_specularColor = specularGlossiness.rgb * _specularColor;\n"),o){for(var n=0;n<o;n++){s+=" lighting(light"+n+"_Type, light"+n+"_Location, light"+n+"_Direction, "+("light"+n+"_Color")+", light"+n+"_Attenuation, light"+n+"_Radius, light"+n+"_Intensity, light"+n+"_AmbientIntensity, light"+n+"_BeamWidth, light"+n+"_CutOffAngle, positionVS, normal, eye, _shininess, _ambientIntensity, _specularColor, ambient, diffuse, specular);\n"}s+="ambient = max(ambient, 0.0);\n",s+="diffuse = max(diffuse, 0.0);\n",s+="specular = max(specular, 0.0);\n"}t.PBR_MATERIAL&&t.PHYSICALENVLIGHT&&(s+="float camDistance = length(cameraPosWS.xyz - fragPositionWS.xyz);\n",s+="vec3 N = (mat_vi * vec4(normal, 0.0)).rgb;\n",s+="vec3 V = normalize ( cameraPosWS.xyz - fragPositionWS.xyz );\n",s+="vec3 R = normalize( reflect ( -V, N ) );\n",s+="float roughness  =  1.0 - _shininess;\n",s+="float NoV = clamp(dot( N, V ), 0.0, 1.0);\n",s+="float lod = roughness * 6.0;",s+="diffuse = textureCube( diffuseEnvironmentMap, N ).rgb;\n",x3dom.caps.TEXTURE_LOD||2==x3dom.caps.WEBGL_VERSION?s+="specular = textureCubeLodEXT( specularEnvironmentMap, R, lod ).rgb;\n":(s+="float level = calcMipLevel(dirToCubeUV(R));\n",s+="float bias  = lod - level;\n",s+="specular    = textureCube( specularEnvironmentMap, R, bias ).rgb;\n"),s+="vec3 brdf      = texture2D( brdfMap, vec2( NoV, roughness ) ).rgb;\n",s+="_specularColor = ( _specularColor * brdf.x + brdf.y );\n"),s+="color.rgb = _emissiveColor + ((ambient + diffuse) * color.rgb + specular * _specularColor) * _occlusion;\n",(t.IS_PARTICLE||t.POINTPROPERTIES)&&(t.TEXTURED?s+="if (color.a < 0.01 ) discard;\n":(s+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",s+="if ( pAlpha < 0.01 ) discard;\n"))}else!t.APPMAT||t.VERTEXCOLOR||t.TEXTURED||t.PBR_MATERIAL||(s+="color = vec4(0.0, 0.0, 0.0, 1.0 - _transparency);\n"),t.TEXTURED&&(t.DIFFUSEMAP||t.DIFFPLACEMENTMAP||t.TEXT)?(t.PIXELTEX?t.IS_PARTICLE||t.POINTPROPERTIES?s+="vec2 texCoord = clamp(gl_PointCoord, 0.01, 0.99);\n":s+="vec2 texCoord = fragTexcoord;\n":t.IS_PARTICLE||t.POINTPROPERTIES?(s+="vec2 texCoord = clamp(gl_PointCoord, 0.01, 0.99);\n",s+="texCoord.y = 1.0 - texCoord.y;\n"):s+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",s+="texColor = "+x3dom.shader.decodeGamma(t,"texture2D(diffuseMap, texCoord)")+";\n",s+="color.a = texColor.a;\n",t.BLENDING||t.IS_PARTICLE||t.POINTPROPERTIES?(s+="if (color.a < 0.01 ) discard;\n",s+="color.rgb += _emissiveColor.rgb;\n",s+="color.rgb *= texColor.rgb;\n"):s+="color = texColor;\n"):t.VERTEXCOLOR||t.PBR_MATERIAL||t.POINTLINE2D?(t.VERTEXCOLOR||t.PBR_MATERIAL||!t.POINTLINE2D||(s+="color.rgb = _emissiveColor;\n"),t.IS_PARTICLE?(s+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",s+="color.rgb *= vec3(pAlpha);\n",s+="color.a = pAlpha;\n"):t.POINTPROPERTIES&&!t.TEXTURED&&(s+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",s+="if ( pAlpha < 0.01 ) discard;\n")):s+="color.rgb += _emissiveColor;\n";t.CLIPPLANES&&(s+="if (cappingColor.r != -1.0) {\n",s+="    color.rgb = cappingColor;\n",s+="}\n"),t.TEXT?s+="if (color.a < (1.0 - _transparency) * 0.5) discard;\n":t.ALPHAMASK?(s+="if (color.a <= alphaCutoff) discard;\n",s+="color.a = 1.0;\n"):t.ALPHATHRESHOLD&&(s+="if (color.a <= alphaCutoff) discard;\n"),s+="if(tonemappingOperator == 1.0) {\n",s+="       color.rgb = tonemapReinhard(color.rgb);\n",s+="    }\n",s+="    if(tonemappingOperator == 2.0) {\n",s+="       color.rgb = tonemapUncharted2(color.rgb);\n",s+="    }\n",s+="    if(tonemappingOperator == 3.0) {\n",s+="       color.rgb = tonemapeFilmic(color.rgb);\n",s+="    }\n",s+="color = "+x3dom.shader.encodeGamma(t,"color")+";\n",t.FOG&&(s+="float f0 = calcFog(fragEyePosition);\n",s+="color.rgb = fogColor * (1.0-f0) + f0 * (color.rgb);\n"),s+="gl_FragColor = color;\n",s+="}\n",2==i&&(s=x3dom.shader.convertFragmentShader(s));var r=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(r,s),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+s),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(r))),r},x3dom.shader.DynamicShaderPicking=function(e,t,i){this.program=e.createProgram();var s=this.generateVertexShader(e,t,i),o=this.generateFragmentShader(e,t,i);return e.attachShader(this.program,s),e.attachShader(this.program,o),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShaderPicking.prototype.generateVertexShader=function(e,t,i){var s="";s+="uniform mat4 modelMatrix;\n",s+="uniform mat4 modelViewProjectionMatrix;\n",s+="uniform mat4 modelMatrix2;\n",s+="uniform mat4 modelViewProjectionMatrix2;\n",s+="uniform float isVR;\n",s+="attribute float eyeIdx;\n",s+="varying float vrOffset;\n",s+="varying float fragEyeIdx;\n",s+="attribute vec3 position;\n",s+="uniform vec3 from;\n",s+="varying vec3 worldCoord;\n",1==i?(s+="attribute vec3 color;\n",s+="varying vec3 fragColor;\n"):2==i&&(s+="attribute vec2 texcoord;\n",s+="varying vec3 fragColor;\n"),t.REQUIREBBOX&&(s+="uniform vec3 bgCenter;\n",s+="uniform vec3 bgSize;\n",s+="uniform float bgPrecisionMax;\n"),t.REQUIREBBOXCOL&&(s+="uniform float bgPrecisionColMax;\n"),t.REQUIREBBOXTEX&&(s+="uniform float bgPrecisionTexMax;\n"),t.VERTEXID&&(s+="uniform float shadowIDs;\n",s+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",s+="varying float fragID;\n",s+="attribute float id;\n"),t.POPGEOMETRY&&(s+="uniform float PG_precisionLevel;\n",s+="uniform float PG_powPrecision;\n",s+="uniform vec3 PG_maxBBSize;\n",s+="uniform vec3 PG_bbMin;\n",s+="uniform vec3 PG_bbMaxModF;\n",s+="uniform vec3 PG_bboxShiftVec;\n",s+="uniform float PG_numAnchorVertices;\n",s+="attribute float PG_vertexID;\n"),t.IS_PARTICLE&&(s+="attribute vec3 particleSize;\n"),t.POINTPROPERTIES&&(s+="uniform vec3 pointSizeAttenuation;\n",s+="uniform float pointSizeFactor;\n",s+="uniform float minPointSize;\n",s+="uniform float maxPointSize;\n"),(t.CLIPPLANES||t.POINTPROPERTIES)&&(s+="uniform mat4 modelViewMatrix;\n",s+="uniform mat4 modelViewMatrix2;\n",s+="uniform vec3 eyePosition;\n",s+="varying vec4 fragPosition;\n",s+="varying vec4 fragPositionWS;\n"),s+="void main(void) {\n",s+="fragEyeIdx = eyeIdx;\n",s+="vec3 pos = position;\n",t.VERTEXID&&(0==i?(s+="idCoord = vec2((id + shadowIDs) / 256.0);\n",s+="idCoord.x = floor(idCoord.x) / 255.0;\n",s+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",s+="fragID = id;\n"):3==i?(s+="float ID = id + shadowIDs;\n",s+="float h = floor(ID / 256.0);\n",s+="idCoord.x = ID - (h * 256.0);\n",s+="idCoord.z = floor(h / 256.0);\n",s+="idCoord.y = h - (idCoord.z * 256.0);\n",s+="idCoord = idCoord.zyx / 255.0;\n",s+="fragID = id;\n"):4==i&&(s+="idCoord = vec2((id + shadowIDs) / 256.0);\n",s+="idCoord.x = floor(idCoord.x) / 255.0;\n",s+="idCoord.y = fract(idCoord.y) * 1.00392156862745;\n",s+="fragID = id;\n")),t.POPGEOMETRY?(s+="vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",s+="if (PG_precisionLevel <= 2.0) {\n",s+="pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",s+="pos /= (65536.0 - PG_powPrecision);\n",s+="}\n",s+="else {\n",s+="pos /= bgPrecisionMax;\n",s+="}\n",s+="pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):(t.REQUIREBBOX&&(s+="pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),1!=i||t.REQUIREBBOXCOL?1==i&&t.REQUIREBBOXCOL?s+="fragColor = color / bgPrecisionColMax;\n":2!=i||t.REQUIREBBOXTEX?2==i&&t.REQUIREBBOXTEX&&(s+="vec2 texCoord = texcoord / bgPrecisionTexMax;\n",s+="fragColor = vec3(abs(texCoord.x), abs(texCoord.y), 0.0);\n"):s+="fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);\n":s+="fragColor = color;\n"),(t.CLIPPLANES||t.POINTPROPERTIES)&&(s+="if(eyeIdx == 1.0){\n",s+="    fragPosition = (modelViewMatrix2 * vec4(pos, 1.0));\n",s+="}else{\n",s+="    fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n",s+="}\n"),t.IS_PARTICLE?(s+="float spriteDist = (gl_Position.w > 0.000001) ? gl_Position.w : 0.000001;\n",s+="float pointSize = floor(length(particleSize) * 256.0 / spriteDist + 0.5);\n",s+="gl_PointSize = clamp(pointSize, 2.0, 256.0);\n"):t.POINTPROPERTIES?(s+="float r = length( fragPosition.xyz );\n",s+="vec3 a = pointSizeAttenuation;\n",s+="float attFactor = ( a.x + a.y * r + a.z * r * r );\n",s+="float pointSize =  pointSizeFactor * 1.0 / attFactor;\n",s+="gl_PointSize = clamp(pointSize, minPointSize, maxPointSize);\n"):s+="gl_PointSize = 2.0;\n",s+="worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n",s+="if(eyeIdx == 1.0){\n",s+="    gl_Position = modelViewProjectionMatrix2 * vec4(pos, 1.0);\n",s+="}else{\n",s+="    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n",s+="}\n",s+="if(isVR == 1.0){\n",s+="    vrOffset = eyeIdx * 0.5;\n",s+="    gl_Position.x *= 0.5;\n",s+="    gl_Position.x += vrOffset * gl_Position.w;\n",s+="}\n",s+="}\n";var o=e.createShader(e.VERTEX_SHADER);return e.shaderSource(o,s),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||(x3dom.debug.logInfo("VERTEX:\n"+s),x3dom.debug.logError("VertexShader "+e.getShaderInfoLog(o))),o},x3dom.shader.DynamicShaderPicking.prototype.generateFragmentShader=function(e,t,i){var s="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";s+=" precision highp float;\n",s+="#else\n",s+=" precision mediump float;\n",s+="#endif\n\n",s+="uniform float highBit;\n",s+="uniform float lowBit;\n",s+="uniform float sceneSize;\n",s+="varying vec3 worldCoord;\n",s+="uniform float isVR;\n",s+="varying float vrOffset;\n",s+="varying float fragEyeIdx;\n",s+="uniform float screenWidth;\n",1!=i&&2!=i||(s+="varying vec3 fragColor;\n"),t.VERTEXID&&(s+=3==i?"varying vec3 idCoord;\n":"varying vec2 idCoord;\n",s+="varying float fragID;\n"),t.CLIPPLANES&&(s+="uniform mat4 viewMatrixInverse;\n",s+="uniform mat4 viewMatrixInverse2;\n",s+="varying vec4 fragPosition;\n"),t.CLIPPLANES&&(s+=x3dom.shader.clipPlanes(t.CLIPPLANES)),s+="void main(void) {\n",s+="if ( isVR == 1.0) {\n",s+="    if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n",s+="}\n",t.CLIPPLANES&&(s+="calculateClipPlanes();\n"),s+=1==i||2==i?"vec4 color = vec4(fragColor, lowBit);\n":4==i?"vec4 color = vec4(highBit, lowBit, 0.0, 0.0);\n":"vec4 color = vec4(0.0, 0.0, highBit, lowBit);\n",t.VERTEXID&&(0==i||4==i?s+="color.ba = idCoord;\n":3==i&&(s+="color.gba = idCoord;\n")),1!=i&&2!=i&&(s+="float d = length(worldCoord) / sceneSize;\n"),0==i?(s+="vec2 comp = fract(d * vec2(256.0, 1.0));\n",s+="color.rg = comp - (comp.rr * vec2(0.0, 1.0/256.0));\n"):3==i&&(s+="color.r = d;\n"),!t.POINTPROPERTIES&&!t.IS_PARTICLE||t.TEXTURED||(s+="float pAlpha = 1.0 - clamp(length((gl_PointCoord - 0.5) * 2.0), 0.0, 1.0);\n",s+="if ( pAlpha < 0.01 ) discard;\n"),s+="gl_FragColor = color;\n",s+="}\n";var o=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(o,s),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)||(x3dom.debug.logInfo("FRAGMENT:\n"+s),x3dom.debug.logError("FragmentShader "+e.getShaderInfoLog(o))),o},x3dom.shader.DynamicShadowShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.DynamicShadowShader.prototype.generateVertexShader=function(e,t){var i="";i+="attribute vec3 position;\n",i+="uniform mat4 modelViewProjectionMatrix;\n",i+="varying vec4 projCoords;\n",t.VERTEXID&&(i+="varying float fragID;\n",i+="attribute float id;\n"),t.REQUIREBBOX&&(i+="uniform vec3 bgCenter;\n",i+="uniform vec3 bgSize;\n",i+="uniform float bgPrecisionMax;\n"),t.POPGEOMETRY&&(i+="uniform float PG_precisionLevel;\n",i+="uniform float PG_powPrecision;\n",i+="uniform vec3 PG_maxBBSize;\n",i+="uniform vec3 PG_bbMin;\n",i+="uniform vec3 PG_bbMaxModF;\n",i+="uniform vec3 PG_bboxShiftVec;\n",i+="uniform float PG_numAnchorVertices;\n",i+="attribute float PG_vertexID;\n"),t.CLIPPLANES&&(i+="uniform mat4 modelViewMatrix;\n",i+="varying vec4 fragPosition;\n"),i+="void main(void) {\n",i+="    vec3 pos = position;\n",t.POPGEOMETRY?(i+="    vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",i+="    if (PG_precisionLevel <= 2.0) {\n",i+="        pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n",i+="        pos /= (65536.0 - PG_powPrecision);\n",i+="    }\n",i+="    else {\n",i+="        pos /= bgPrecisionMax;\n",i+="    }\n",i+="    pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):t.REQUIREBBOX&&(i+="    pos = bgCenter + bgSize * pos / bgPrecisionMax;\n"),t.VERTEXID&&(i+="    fragID = id;\n"),t.CLIPPLANES&&(i+="    fragPosition = (modelViewMatrix * vec4(pos, 1.0));\n"),i+="    projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n",i+="    gl_Position = projCoords;\n",i+="}\n";var s=e.createShader(e.VERTEX_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] VertexShader "+e.getShaderInfoLog(s)),s},x3dom.shader.DynamicShadowShader.prototype.generateFragmentShader=function(e,t){var i="";i+="#ifdef GL_FRAGMENT_PRECISION_HIGH\n",i+="    precision highp float;\n",i+="#else\n",i+="    precision mediump float;\n",i+="#endif\n\n",i+="varying vec4 projCoords;\n",i+="uniform float offset;\n",i+="uniform bool cameraView;\n",t.VERTEXID&&(i+="varying float fragID;\n"),t.CLIPPLANES&&(i+="uniform mat4 viewMatrixInverse;\n",i+="varying vec4 fragPosition;\n",i+=x3dom.shader.clipPlanes(t.CLIPPLANES)),x3dom.caps.FP_TEXTURES||(i+=x3dom.shader.rgbaPacking()),i+="void main(void) {\n",t.CLIPPLANES&&(i+="calculateClipPlanes();\n"),i+="    vec3 proj = (projCoords.xyz / projCoords.w);\n",x3dom.caps.FP_TEXTURES?(i+="       if (!cameraView){\n",i+="           proj.z = (proj.z + 1.0)*0.5;\n",i+="           proj.y = proj.z * proj.z;\n",i+="       }\n",i+="    gl_FragColor = vec4(proj, 1.0);\n"):i+="    gl_FragColor = packDepth(proj.z);\n",i+="}\n";var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ComposedShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e,t),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ComposedShader.prototype.generateVertexShader=function(e,t){var i=t._cf.appearance.node._shader._vertex._vf.url[0];i=this.injectVRPartsVS(i);var s=e.createShader(e.VERTEX_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] VertexShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ComposedShader.prototype.generateFragmentShader=function(e,t){var i=t._cf.appearance.node._shader._fragment._vf.url[0];i=this.injectVRPartsFS(i);var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ComposedShader.prototype.injectVRPartsVS=function(e){var t=this.extractShaderSections(e);return t.before+"attribute float eyeIdx;\nuniform   float isVR;\nuniform   mat4  modelViewProjectionMatrix2;\nuniform   mat4  modelViewProjectionInverseMatrix;\nvarying   float vrOffset;\nvarying   float fragEyeIdx;\n"+t.mainStart+t.main+"fragEyeIdx = eyeIdx;\nif(isVR == 1.0)\n{\n    vec4 webVRPos = modelViewProjectionInverseMatrix * gl_Position;\n    webVRPos.xyz = webVRPos.xyz / webVRPos.w;\n    if(fragEyeIdx == 1.0) {\n        gl_Position = modelViewProjectionMatrix2 * webVRPos;\n    } else {\n        gl_Position = modelViewProjectionMatrix  * webVRPos;\n    }\n    vrOffset = fragEyeIdx * 0.5;\n    gl_Position.x *= 0.5;\n    gl_Position.x += vrOffset * gl_Position.w;\n}"+t.mainEnd},x3dom.shader.ComposedShader.prototype.injectVRPartsFS=function(e){var t=this.extractShaderSections(e);return t.before+"uniform   float isVR;\nuniform   float screenWidth;\nvarying   float vrOffset;\nvarying   float fragEyeIdx;\n"+t.mainStart+"if ( isVR == 1.0) {\n    if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n}\n"+t.main+t.mainEnd},x3dom.shader.ComposedShader.prototype.extractShaderSections=function(e){var t=/void\s*main\s*\(\s*(?:void)?\s*\)\s*{[\s\S]*}/.exec(e),i=t[0].indexOf("{")+t.index+1,s=t[0].lastIndexOf("}")+t.index;return{before:e.substring(0,t.index),mainStart:e.substring(t.index,i),main:e.substring(i,s),mainEnd:e.substring(s,e.length)}},x3dom.shader.NormalShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.NormalShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nattribute vec3 normal;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float bgPrecisionNorMax;\nuniform mat4 normalMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    fragNormal = (normalMatrix * vec4(normal / bgPrecisionNorMax, 0.0)).xyz;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.NormalShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n precision mediump float;\n#endif\n\nvarying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4(normalize(fragNormal) / 2.0 + 0.5, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.FrontgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.FrontgroundTextureShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.FrontgroundTextureShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n precision mediump float;\n#endif\n\nuniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec4 col = texture2D(tex, fragTexCoord);\n    gl_FragColor = vec4(col.rgb, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundTextureShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nvarying vec2 fragTexCoord;\nuniform vec2 scale;\nuniform vec2 translation;\nuniform float isVR;\nattribute float eyeIdx;\nvarying float vrOffset;\nvarying float fragEyeIdx;\n\nvoid main(void) {\n   vec2 texCoord = (position.xy + 1.0) * 0.5;\n   fragTexCoord = texCoord * scale + translation;\n    fragEyeIdx = eyeIdx;\n   gl_Position = vec4(position.xy, 0.0, 1.0);\n    if(isVR == 1.0){\n        vrOffset = eyeIdx * 0.5;\n        gl_Position.x *= 0.5;\n        gl_Position.x += vrOffset * gl_Position.w;\n    }\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundTextureShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n precision mediump float;\n#endif\n\nuniform float isVR;\nvarying float vrOffset;\nvarying float fragEyeIdx;\nuniform float screenWidth;\nuniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n       if ( isVR == 1.0 ) {\n        if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n       }\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundSkyTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundSkyTextureShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nattribute vec2 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewProjectionMatrix2;\nvarying vec2 fragTexCoord;\nuniform float isVR;\nattribute float eyeIdx;\nvarying float vrOffset;\nvarying float fragEyeIdx;\n\nvoid main(void) {\n    fragTexCoord = texcoord;\n     fragEyeIdx = eyeIdx;\n     if(eyeIdx == 1.0){\n       gl_Position = modelViewProjectionMatrix2 * vec4(position, 1.0);\n     } else {\n       gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n     }\n     if(isVR == 1.0){\n        vrOffset = eyeIdx * 0.5;\n        gl_Position.x *= 0.5;\n        gl_Position.x += vrOffset * gl_Position.w;\n     }\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundSkyTextureShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n precision mediump float;\n#endif\n\nuniform float isVR;\nvarying float vrOffset;\nvarying float fragEyeIdx;\nuniform float screenWidth;\nuniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    if ( isVR == 1.0 ) {\n        if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n    }\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundCubeTextureShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BackgroundCubeTextureShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    fragNormal = normalize(position);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundCubeTextureShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n precision mediump float;\n#endif\n\nuniform samplerCube tex;\nvarying vec3 fragNormal;\n\nfloat magn(float val) {\n    return ((val >= 0.0) ? val : -1.0 * val);\n}\nvoid main(void) {\n    gl_FragColor = textureCube(tex, fragNormal);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundCubeTextureDDSShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);if(e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),!e.getProgramParameter(this.program,e.LINK_STATUS))throw"Error linking shaders:"+e.getProgramInfoLog(this.program);return this.program},x3dom.shader.BackgroundCubeTextureDDSShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewProjectionMatrix2;\nvarying vec3 fragNormal;\nuniform float isVR;\nattribute float eyeIdx;\nvarying float vrOffset;\nvarying float fragEyeIdx;\n\nvoid main(void) {\n    fragEyeIdx = eyeIdx;\n   fragNormal = normalize(position);\n    if(eyeIdx == 1.0){\n       gl_Position = modelViewProjectionMatrix2 * vec4(position, 1.0);\n    } else {\n       gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n    }\n    if(isVR == 1.0){\n        vrOffset = eyeIdx * 0.5;\n        gl_Position.x *= 0.5;\n        gl_Position.x += vrOffset * gl_Position.w;\n    }\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureDDSShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BackgroundCubeTextureDDSShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+=x3dom.shader.toneMapping();var i={GAMMACORRECTION:e.canvas.parent.doc._viewarea._scene.getEnvironment()._vf.gammaCorrectionDefault};t+=x3dom.shader.gammaCorrectionDecl(i),t+="uniform float isVR;\nvarying float vrOffset;\nvarying float fragEyeIdx;\nuniform float screenWidth;\nuniform samplerCube tex;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    if ( isVR == 1.0 ) {\n       if ( ( step( 0.5, gl_FragCoord.x / screenWidth ) - 0.5 ) * vrOffset < 0.0 ) discard;\n    }\n   vec4 color = textureCube(tex, fragNormal);\n    if(tonemappingOperator == 1.0) {\n       color.rgb = tonemapReinhard(color.rgb);\n    }\n    if(tonemappingOperator == 2.0) {\n       color.rgb = tonemapUncharted2(color.rgb);\n    }\n    if(tonemappingOperator == 3.0) {\n       color.rgb = tonemapeFilmic(color.rgb);\n    }\n   color = "+x3dom.shader.encodeGamma(i,"color")+";\n   gl_FragColor = color;\n}\n";var s=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(s,t),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureDDSShader] FragmentShader "+e.getShaderInfoLog(s)),s},x3dom.shader.ShadowRenderingShader=function(e,t){this.program=e.createProgram();var i=this.generateVertexShader(e),s=this.generateFragmentShader(e,t);return e.attachShader(this.program,i),e.attachShader(this.program,s),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.ShadowRenderingShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec2 position;\nvarying vec2 vPosition;\nvoid main(void) {\n vPosition = position;\n gl_Position = vec4(position, -1.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.ShadowRenderingShader.prototype.generateFragmentShader=function(e,t){var i="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";i+="precision highp float;\n",i+="#else\n",i+=" precision mediump float;\n",i+="#endif\n\n",i+="uniform mat4 inverseViewProj;\n",i+="uniform mat4 inverseProj;\n",i+="varying vec2 vPosition;\n",i+="uniform sampler2D sceneMap;\n";for(var s=0;s<5;s++)i+="uniform float cascade"+s+"_Depth;\n";for(var o=0;o<t.length;o++){i+="uniform float light"+o+"_On;\nuniform float light"+o+"_Type;\nuniform vec3  light"+o+"_Location;\nuniform vec3  light"+o+"_Direction;\nuniform vec3  light"+o+"_Attenuation;\nuniform float light"+o+"_Radius;\nuniform float light"+o+"_BeamWidth;\nuniform float light"+o+"_CutOffAngle;\nuniform float light"+o+"_ShadowIntensity;\nuniform float light"+o+"_ShadowOffset;\nuniform mat4 light"+o+"_ViewMatrix;\n";for(var n=0;n<6;n++)i+="uniform mat4 light"+o+"_"+n+"_Matrix;\n",i+="uniform sampler2D light"+o+"_"+n+"_ShadowMap;\n";for(n=0;n<5;n++)i+="uniform float light"+o+"_"+n+"_Split;\n"}x3dom.caps.FP_TEXTURES||(i+=x3dom.shader.rgbaPacking()),i+=x3dom.shader.shadowRendering(),i+=x3dom.shader.gammaCorrectionDecl({}),i+="void main(void) {\n    float shadowValue = 1.0;\n    vec2 texCoordsSceneMap = (vPosition + 1.0)*0.5;\n    vec4 projCoords = texture2D(sceneMap, texCoordsSceneMap);\n    if (projCoords != vec4(1.0,1.0,1.0,0.0)){\n",x3dom.caps.FP_TEXTURES||(i+="    projCoords.z = unpackDepth(projCoords);\n    projCoords.w = 1.0;\n"),i+="    projCoords = projCoords / projCoords.w;\n    projCoords.xy = vPosition;\n    vec4 eyeCoords = inverseProj*projCoords;\n    vec4 worldCoords = inverseViewProj*projCoords;\n    float lightInfluence = 0.0;\n";for(o=0;o<t.length;o++)i+="    lightInfluence = getLightInfluence(light"+o+"_Type, light"+o+"_ShadowIntensity, light"+o+"_On, light"+o+"_Location, light"+o+"_Direction, light"+o+"_CutOffAngle, light"+o+"_BeamWidth, light"+o+"_Attenuation, light"+o+"_Radius, eyeCoords.xyz/eyeCoords.w);\n    if (lightInfluence != 0.0){\n        vec4 shadowMapValues;\n        float viewSampleDepth;\n",x3dom.isa(t[o],x3dom.nodeTypes.PointLight)?i+="        getShadowValuesPointLight(shadowMapValues, viewSampleDepth, light"+o+"_Location, worldCoords, light"+o+"_ViewMatrix, light"+o+"_0_Matrix,light"+o+"_1_Matrix,light"+o+"_2_Matrix,light"+o+"_3_Matrix,light"+o+"_4_Matrix,light"+o+"_5_Matrix,light"+o+"_0_ShadowMap,light"+o+"_1_ShadowMap,light"+o+"_2_ShadowMap,light"+o+"_3_ShadowMap,light"+o+"_4_ShadowMap,light"+o+"_5_ShadowMap);\n":i+="        getShadowValuesCascaded(shadowMapValues, viewSampleDepth, worldCoords, -eyeCoords.z/eyeCoords.w,light"+o+"_0_Matrix,light"+o+"_1_Matrix,light"+o+"_2_Matrix,light"+o+"_3_Matrix,light"+o+"_4_Matrix,light"+o+"_5_Matrix,light"+o+"_0_ShadowMap,light"+o+"_1_ShadowMap,light"+o+"_2_ShadowMap,light"+o+"_3_ShadowMap,light"+o+"_4_ShadowMap,light"+o+"_5_ShadowMap, light"+o+"_0_Split, light"+o+"_1_Split, light"+o+"_2_Split, light"+o+"_3_Split, \nlight"+o+"_4_Split);\n",x3dom.caps.FP_TEXTURES?i+="     shadowValue *= clamp(VSM(shadowMapValues.zy, viewSampleDepth, light"+o+"_ShadowOffset),                 1.0 - light"+o+"_ShadowIntensity*lightInfluence, 1.0);\n":i+="    shadowValue *= clamp(ESM(shadowMapValues.z, viewSampleDepth, light"+o+"_ShadowOffset),                 1.0 - light"+o+"_ShadowIntensity*lightInfluence, 1.0);\n",i+="    }\n";i+="}\n    gl_FragColor = "+x3dom.shader.encodeGamma({},"vec4(shadowValue, shadowValue, shadowValue, 1.0)")+";\n}\n";var r=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(r,i),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] FragmentShader "+e.getShaderInfoLog(r)),r},x3dom.shader.TextureRefinementShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.TextureRefinementShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec2 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = (position.xy + 1.0) / 2.0;\n    gl_Position = vec4(position, -1.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.TextureRefinementShader.prototype.generateFragmentShader=function(e){var t=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(t,"#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n#else\n precision mediump float;\n#endif\n\nuniform sampler2D stamp;\nuniform sampler2D lastTex;\nuniform sampler2D curTex;\nuniform int mode;\nuniform vec2 repeat;\nvarying vec2 fragTexCoord;\n\nvoid init(void);\nvoid refine(void);\n\nvoid main(void) {\n    if (mode == 0) { init(); }\n    else { refine(); }\n}\n\nvoid init(void) {\n    gl_FragColor = texture2D(curTex, fragTexCoord);\n}\n\nvoid refine(void) {\n    vec3 red = texture2D(stamp, repeat * fragTexCoord).rgb;\n    vec3 v1  = texture2D(lastTex, fragTexCoord).rgb;\n    vec3 v2  = texture2D(curTex, fragTexCoord).rgb;\n    if (red.r <= 0.5) {\n        gl_FragColor = vec4(v1, 1.0);\n    }\n    else {\n        gl_FragColor = vec4(v2, 1.0);\n    }\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[TextureRefinementShader] FragmentShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.BlurShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec2 position;\nvarying vec2 vPosition;\nvoid main(void) {\n vPosition = position;\n gl_Position = vec4(position, -1.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.BlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="varying vec2 vPosition;\nuniform sampler2D texture;\nuniform bool horizontal;\nuniform float pixelSizeHor;\nuniform float pixelSizeVert;\nuniform int filterSize;\n",x3dom.caps.FP_TEXTURES?t+="void main(void) {\n    vec2 texCoords = (vPosition + 1.0)*0.5;\n    vec2 offset;\n    if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n    else offset = vec2(0.0, pixelSizeVert);\n    vec4 color = texture2D(texture, texCoords);\n    if (filterSize == 3){\n        color = color * 0.3844;\n        color += 0.3078*texture2D(texture, texCoords-offset);\n        color += 0.3078*texture2D(texture, texCoords+offset);\n    } else if (filterSize == 5){\n        color = color * 0.2921;\n        color += 0.2339*texture2D(texture, texCoords-offset);\n        color += 0.2339*texture2D(texture, texCoords+offset);\n        color += 0.1201*texture2D(texture, texCoords-2.0*offset);\n        color += 0.1201*texture2D(texture, texCoords+2.0*offset);\n    } else if (filterSize == 7){\n        color = color * 0.2161;\n        color += 0.1907*texture2D(texture, texCoords-offset);\n        color += 0.1907*texture2D(texture, texCoords+offset);\n        color += 0.1311*texture2D(texture, texCoords-2.0*offset);\n        color += 0.1311*texture2D(texture, texCoords+2.0*offset);\n        color += 0.0702*texture2D(texture, texCoords-3.0*offset);\n        color += 0.0702*texture2D(texture, texCoords+3.0*offset);\n    }\n    gl_FragColor = color;\n}\n":t+=x3dom.shader.rgbaPacking()+"void main(void) {\n    vec2 texCoords = (vPosition + 1.0)*0.5;\n    vec2 offset;\n    if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n    else offset = vec2(0.0, pixelSizeVert);\n    float depth = unpackDepth(texture2D(texture, texCoords));\n    if (filterSize == 3){\n        depth = depth * 0.3844;\n        depth += 0.3078*unpackDepth(texture2D(texture, texCoords-offset));\n        depth += 0.3078*unpackDepth(texture2D(texture, texCoords+offset));\n    } else if (filterSize == 5){\n        depth = depth * 0.2921;\n        depth += 0.2339*unpackDepth(texture2D(texture, texCoords-offset));\n        depth += 0.2339*unpackDepth(texture2D(texture, texCoords+offset));\n        depth += 0.1201*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n        depth += 0.1201*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n    } else if (filterSize == 7){\n        depth = depth * 0.2161;\n        depth += 0.1907*unpackDepth(texture2D(texture, texCoords-offset));\n        depth += 0.1907*unpackDepth(texture2D(texture, texCoords+offset));\n        depth += 0.1311*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n        depth += 0.1311*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n        depth += 0.0702*unpackDepth(texture2D(texture, texCoords-3.0*offset));\n        depth += 0.0702*unpackDepth(texture2D(texture, texCoords+3.0*offset));\n    }\n    gl_FragColor = packDepth(depth);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\nuniform vec2 randomTextureTilingFactor;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    depthTexCoord = texCoord;\n     randomTexCoord = randomTextureTilingFactor*texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.SSAOShader.depthReconsructionFunctionCode=function(){var e="uniform float depthReconstructionConstantA;\nuniform float depthReconstructionConstantB;\n";return x3dom.caps.FP_TEXTURES||(e+=x3dom.shader.rgbaPacking()),e+="float getDepth(vec2 depthTexCoord) {\n    vec4 col = texture2D(depthTexture, depthTexCoord);\n    float d;\n",x3dom.caps.FP_TEXTURES?e+="    d = col.b;\n":e+="    d = unpackDepth(col);\n",e+="    return depthReconstructionConstantB/(depthReconstructionConstantA+d);\n",e+="}\n"},x3dom.shader.SSAOShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D depthTexture;\nuniform sampler2D randomTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float radius;\nuniform float depthBufferEpsilon;\nuniform vec3 samples[16];\nvarying vec2 depthTexCoord;\nvarying vec2 randomTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float referenceDepth = getDepth(depthTexCoord);\n    if(referenceDepth == 1.0)\n    {\n        gl_FragColor = vec4(1.0,1.0,1.0, 1.0);\n        return;\n    }\n    int numOcclusions = 0;\n    for(int i = 0; i<16; ++i){\n        float scale  = 1.0/referenceDepth;\n        vec3 samplepos = reflect(samples[i],texture2D(randomTexture,randomTexCoord).xyz*2.0-vec3(1.0,1.0,1.0));\n        float sampleDepth = getDepth(depthTexCoord+samplepos.xy*scale*radius);\n        //if(abs(sampleDepth-referenceDepth)<=radius*(1.0/nearPlane))\n        if( sampleDepth < referenceDepth-depthBufferEpsilon) {\n            ++numOcclusions;\n        }\n    }\n    float r = 1.0-float(numOcclusions)/16.0;\n    r*=2.0;\n    gl_FragColor = vec4(r,r,r, 1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.SSAOBlurShader=function(e){this.program=e.createProgram();var t=this.generateVertexShader(e),i=this.generateFragmentShader(e);return e.attachShader(this.program,t),e.attachShader(this.program,i),e.bindAttribLocation(this.program,0,"position"),e.linkProgram(this.program),this.program},x3dom.shader.SSAOBlurShader.prototype.generateVertexShader=function(e){var t=e.createShader(e.VERTEX_SHADER);return e.shaderSource(t,"attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n"),e.compileShader(t),e.getShaderParameter(t,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOShader] VertexShader "+e.getShaderInfoLog(t)),t},x3dom.shader.SSAOBlurShader.prototype.generateFragmentShader=function(e){var t="#ifdef GL_FRAGMENT_PRECISION_HIGH\n";t+="precision highp float;\n",t+="#else\n",t+=" precision mediump float;\n",t+="#endif\n\n",t+="uniform sampler2D SSAOTexture;\nuniform sampler2D depthTexture;\nuniform float nearPlane;\nuniform float farPlane;\nuniform float amount;\nuniform vec2 pixelSize;\nuniform float depthThreshold;\nvarying vec2 fragTexCoord;\n",t+=x3dom.shader.SSAOShader.depthReconsructionFunctionCode(),t+="void main(void) {\n    float sum = 0.0;\n    float numSamples = 0.0;\n    float referenceDepth = getDepth(fragTexCoord);\n    for(int i = -2; i<2;i++){\n        for(int j = -2; j<2;j++){\n            vec2 sampleTexCoord = fragTexCoord+vec2(pixelSize.x*float(i),pixelSize.y*float(j));\n            if(abs(referenceDepth - getDepth(sampleTexCoord))<depthThreshold){\n                sum+= texture2D(SSAOTexture,sampleTexCoord).r;\n                numSamples++;\n    }}}\n    float intensity = mix(1.0,sum/numSamples,amount);\n    gl_FragColor = vec4(intensity,intensity,intensity,1.0);\n}\n";var i=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||x3dom.debug.logError("[SSAOhader] FragmentShader "+e.getShaderInfoLog(i)),i},x3dom.shader.FRAG_COLOR="x3dom_fragColor",x3dom.shader.convertVertexShader=function(e){return"#version 300 es\n"+(e=(e=(e=e.replace(/attribute/g,"in")).replace(/varying/g,"out")).replace(/texture2D/g,"texture"))},x3dom.shader.convertFragmentShader=function(e){return"#version 300 es\n"+(e=(e=(e=(e=(e=e.replace(/varying/g,"in")).replace(/textureCubeLodEXT/g,"textureLod")).replace(/texture2D|textureCube/g,"texture")).replace(/\/\/@insertFragColor/g,"out vec4 "+x3dom.shader.FRAG_COLOR+";\n")).replace(/gl_FragColor/g,x3dom.shader.FRAG_COLOR))},x3dom.registerNodeType("X3DNode","Core",defineClass(null,(function(e){this._xmlNode=null,this._runtime=e&&e.runtime?e.runtime:null,this._DEF=null,this._nameSpace=e&&e.nameSpace?e.nameSpace:null,this._vf={},this._vfFieldTypes={},this._cf={},this._cfFieldTypes={},this._fieldWatchers={},this._routes={},this._listeners={},this._parentNodes=[],this._childNodes=[],this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)}),{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(e,t){if(e&&"isProtoInstance"in e){if(this.addChild(e.typeNode,t),e.helperNodes.length>0){var i=new x3dom.nodeTypes.Switch;i._nameSpace=this._nameSpace,e.helperNodes.forEach((function(e){i.addChild(e,"children")})),this.addChild2(i)}}else this.addChild2(e,t)},addChild2:function(e,t){if(e){var i=null;if(t)i=this._cf[t];else for(var s in this._cf)if(this._cf.hasOwnProperty(s)){var o=this._cf[s];if(x3dom.isa(e,o.type)){i=o;break}}if(i&&i.addLink(e))return e._parentNodes.push(this),this._childNodes.push(e),"isProtoInstance"in this||e.parentAdded(this),!0;if("isProtoInstance"in this)if("isProtoInstance"in e)this.nodes.concat(e.nodes);else{this.nodes.push(e),that=this,function e(t){Object.keys(t).forEach((function(i){t[i].node&&t[i].node._DEF&&(that.innerNameSpace.defMap[t[i].node._DEF]=t[i].node),t[i].node&&t[i].node._cf&&e(t[i].node._cf)}))}({child:{node:e}})}}return!1},removeChild:function(e,t,i){if(t=t||"any",e)for(var s in this._cf){if(this._cf.hasOwnProperty(s)&&("any"==t||s==t))if(this._cf[s].rmLink(e)||i){for(var o=e._parentNodes.length-1;o>=0;o--)e._parentNodes[o]===this&&(e._parentNodes.splice(o,1),e.parentRemoved(this));for(var n=this._childNodes.length-1;n>=0;n--)if(this._childNodes[n]===e)return e.onRemove(),this._childNodes.splice(n,1),!0}}return!1},onRemove:function(){},parentAdded:function(e){},parentRemoved:function(e){if(0===this._parentNodes.length){x3dom.debug.logInfo(this.typeName()+": "+this._DEF+" is no longer used.");for(var t=this._childNodes.length-1;t>=0;--t)this.removeChild(this._childNodes[t]);var i=this._nameSpace;if(i){i.removeNode(this._DEF);var s=i.superInlineNode;if(s&&s._nameSpace){var o=s._nameSpace.imports,n=i.exports,r=o.get(s._DEF);r&&n.forEach((function(e,t){this._DEF==e&&r.forEach((function(e,i){t==e&&delete s._nameSpace.defMap[i]}))}))}}this._xmlNode&&(delete this._xmlNode._x3domNode,this._xmlNode=null)}},getCurrentTransform:function(){return this._parentNodes.length>=1?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(e){return e},getVolume:function(){return null},invalidateVolume:function(){},invalidateCache:function(){},volumeValid:function(){return!1},collectDrawableObjects:function(e,t,i,s,o,n){},highlight:function(e,t){this._vf.hasOwnProperty("diffuseColor")&&(e?(void 0===this._actDiffuseColor&&(this._actDiffuseColor=new x3dom.fields.SFColor,this._highlightOn=!1),this._highlightOn||(this._actDiffuseColor.setValues(this._vf.diffuseColor),this._highlightOn=!0),this._vf.diffuseColor.setValues(t)):void 0!==this._actDiffuseColor&&(this._vf.diffuseColor.setValues(this._actDiffuseColor),this._highlightOn=!1,delete this._actDiffuseColor));for(var i=0,s=this._childNodes.length;i<s;i++)this._childNodes[i]&&this._childNodes[i].highlight(e,t)},getRuntime:function(){return this._runtime},findX3DDoc:function(){return this._nameSpace?this._nameSpace.doc:null},doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},postMessage:function(e,t){this._vf[e]=t;var i=this._fieldWatchers[e],s=this;i&&i.forEach((function(e){e.call(s,t)}));var o={target:s._xmlNode,type:"outputchange",fieldName:e,value:t};this.callEvtHandler("onoutputchange",o)},updateField:function(e,t){var i=this._vf[e];if(void 0===i){for(var s in this._vf)if(s.toLowerCase()==e){e=s,i=this._vf[e];break}if(void 0===i&&0==e.indexOf("set_")){var o=e.substr("set_".length,e.length-1);void 0!==this._vf[o]&&(e=o,i=this._vf[e])}void 0===i&&(i=null,this._vf[e]=i)}if(null!==i){try{this._vf[e].setValueByStr(t)}catch(s){try{switch((typeof this._vf[e]).toString()){case"number":this._vf[e]="number"==typeof t?t:+t;break;case"boolean":this._vf[e]="boolean"==typeof t?t:"true"==t.toLowerCase();break;case"string":this._vf[e]=t}}catch(e){x3dom.debug.logError("updateField: setValueByStr() NYI for "+typeof i)}}this.fieldChanged(e)}},setupRoute:function(e,t,i){var s,o="set_",n="_changed";this._vf[e]||(0===e.indexOf(o)?(s=e.substr(o.length,e.length-1),void 0!==this._vf[s]&&(e=s)):e.indexOf(n)>0&&(s=e.substr(0,e.length-n.length),void 0!==this._vf[s]&&(e=s))),t._vf[i]||(0===i.indexOf(o)?(s=i.substr(o.length,i.length-1),void 0!==t._vf[s]&&(i=s)):i.indexOf(n)>0&&(s=i.substr(0,i.length-n.length),void 0!==t._vf[s]&&(i=s)));var r=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[r]||(this._fieldWatchers[e]||(this._fieldWatchers[e]=[]),this._fieldWatchers[e].push((function(e){t.postMessage(i,e)})),t._fieldWatchers[i]||(t._fieldWatchers[i]=[]),t._fieldWatchers[i].push((function(e){t._vf[i]=e,t.fieldChanged(i)})),this._routes[r]={from:this._fieldWatchers[e].length-1,to:t._fieldWatchers[i].length-1})},removeRoute:function(e,t,i){var s,o="set_",n="_changed";this._vf[e]||(0===e.indexOf(o)?(s=e.substr(o.length,e.length-1),void 0!==this._vf[s]&&(e=s)):e.indexOf(n)>0&&(s=e.substr(0,e.length-n.length),void 0!==this._vf[s]&&(e=s))),t._vf[i]||(0===i.indexOf(o)?(s=i.substr(o.length,i.length-1),void 0!==t._vf[s]&&(i=s)):i.indexOf(n)>0&&(s=i.substr(0,i.length-n.length),void 0!==t._vf[s]&&(i=s)));var r=this._DEF+"&"+e+"&"+t._DEF+"&"+i;this._routes[r]&&(this._fieldWatchers[e].splice(this._routes[r].from,1),t._fieldWatchers[i].splice(this._routes[r].to,1),delete this._routes[r])},fieldChanged:function(e){},nodeChanged:function(){},callEvtHandler:function(e,t){var i=this._xmlNode;if(!this._xmlNode)return t.cancelBubble;if(!i.getAttribute(e)&&!i[e]&&!this._listeners[t.type])return t.cancelBubble;try{var s=i[e];if(t.target=i,"function"==typeof s)s.call(this._xmlNode,t);else if(i.hasAttribute(e)){var o=i.getAttribute(e);new Function("event",o).call(i,t)}var n=this._listeners[t.type];if(n)for(var r=0;r<n.length;r++)n[r].call(i,t)}catch(e){x3dom.debug.logException(e)}return t.cancelBubble},hasEventListener:function(e){return this._xmlNode&&(this._xmlNode["on"+e]||this._xmlNode.hasAttribute("on"+e)||this._listeners[e])},initSetter:function(e,t){if(e&&t){var i=t.toLowerCase();if(e.__defineSetter__&&e.__defineGetter__?(e.__defineSetter__(t,(function(i){e.setAttribute(t,i)})),e.__defineGetter__(t,(function(){return e.getAttribute(t)})),i!=t&&(e.__defineSetter__(i,(function(i){e.setAttribute(t,i)})),e.__defineGetter__(i,(function(){return e.getAttribute(t)})))):Object.defineProperty(e,t,{set:function(i){e.setAttribute(t,i)},get:function(){return e.getAttribute(t)},configurable:!0,enumerable:!0}),this._vf[t]&&!e.attributes[t]&&!e.attributes[t.toLowerCase()]){var s="";try{s=this._vf[t].toGL?this._vf[t].toGL().toString():this._vf[t].toString()}catch(e){s=this._vf[t].toString()}s||(s=""),e.setAttribute(t,s)}}},addField_SFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?parseInt(e.xmlNode.getAttribute(t),10):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFInt32"},addField_SFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFFloat"},addField_SFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFDouble"},addField_SFTime:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?+e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFTime"},addField_SFBool:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?"true"===e.xmlNode.getAttribute(t).toLowerCase():i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFBool"},addField_SFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?e.xmlNode.getAttribute(t):i,e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFString"},addField_SFColor:function(e,t,i,s,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColor(i,s,o),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColor"},addField_SFColorRGBA:function(e,t,i,s,o,n){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFColorRGBA(i,s,o,n),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFColorRGBA"},addField_SFVec2f:function(e,t,i,s){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec2f(i,s),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec2f"},addField_SFVec3f:function(e,t,i,s,o){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec3f(i,s,o),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec3f"},addField_SFVec4f:function(e,t,i,s,o,n){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFVec4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFVec4f(i,s,o,n),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFVec4f"},addField_SFVec3d:function(e,t,i,s,o){this.addField_SFVec3f(e,t,i,s,o),this._vfFieldTypes[t]="SFVec3d"},addField_SFRotation:function(e,t,i,s,o,n){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.Quaternion.parseAxisAngle(e.xmlNode.getAttribute(t)):x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(i,s,o),n),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFRotation"},addField_SFMatrix4f:function(e,t,i,s,o,n,r,a,d,h,l,f,u,_,c,m,p,x){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFMatrix4f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFMatrix4f(i,s,o,n,r,a,d,h,l,f,u,_,c,m,p,x),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFMatrix4f"},addField_SFImage:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.SFImage.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.SFImage(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="SFImage"},addField_MFString:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFString.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFString(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFString"},addField_MFBoolean:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFBoolean.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFBoolean(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFBoolean"},addField_MFInt32:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFInt32.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFInt32(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFInt32"},addField_MFFloat:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFFloat"},addField_MFDouble:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFFloat.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFFloat(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFDouble"},addField_MFColor:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColor.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColor(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColor"},addField_MFColorRGBA:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFColorRGBA.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFColorRGBA(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFColorRGBA"},addField_MFVec2f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec2f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec2f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec2f"},addField_MFVec3f:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFVec3f(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFVec3f"},addField_MFVec3d:function(e,t,i){this.addField_MFVec3f(e,t,i),this._vfFieldTypes[t]="MFVec3d"},addField_MFRotation:function(e,t,i){this._vf[t]=e&&e.xmlNode&&e.xmlNode.hasAttribute(t)?x3dom.fields.MFRotation.parse(e.xmlNode.getAttribute(t)):new x3dom.fields.MFRotation(i),e&&e.xmlNode&&this.initSetter(e.xmlNode,t),this._vfFieldTypes[t]="MFRotation"},addField_SFNode:function(e,t){this._cf[e]=new x3dom.fields.SFNode(t),this._cfFieldTypes[e]="SFNode"},addField_MFNode:function(e,t){this._cf[e]=new x3dom.fields.MFNode(t),this._cfFieldTypes[e]="MFNode"}})),x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"reference","")}))),x3dom.registerNodeType("MetadataBoolean","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataBoolean.superClass.call(this,e),this.addField_MFBoolean(e,"value",[])}))),x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataDouble.superClass.call(this,e),this.addField_MFDouble(e,"value",[])}))),x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataFloat.superClass.call(this,e),this.addField_MFFloat(e,"value",[])}))),x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataInteger.superClass.call(this,e),this.addField_MFInt32(e,"value",[])}))),x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataSet.superClass.call(this,e),this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)}))),x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,(function(e){x3dom.nodeTypes.MetadataString.superClass.call(this,e),this.addField_MFString(e,"value",[])}))),x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.Field.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"type",""),this.addField_SFString(e,"value","")}),{fieldChanged:function(e){var t=this;"value"===e&&this._parentNodes.forEach((function(e){e.fieldChanged(t._vf.name)}))}})),x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DChildNode.superClass.call(this,e)}))),x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,e),this.addField_SFBool(e,"bind",!1),this.addField_SFString(e,"description",""),this.addField_SFBool(e,"isActive",!1),this._autoGen=!(!e||!e.autoGen),this._autoGen&&(this._vf.description="default"+this.constructor.superClass._typeName),this._stack=null,this._bindAnimation=!0}),{bind:function(e){this._stack?e?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in "+this.typeName()+"Bindable")},activate:function(e){this.postMessage("isActive",!0),x3dom.debug.logInfo("activate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},deactivate:function(e){this.postMessage("isActive",!1),x3dom.debug.logInfo("deactivate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},fieldChanged:function(e){e.indexOf("bind")>=0&&this.bind(this._vf.bind)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this)}})),x3dom.registerNodeType("X3DInfoNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DInfoNode.superClass.call(this,e)}))),x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DInfoNode,(function(e){x3dom.nodeTypes.WorldInfo.superClass.call(this,e),this.addField_MFString(e,"info",[]),this.addField_SFString(e,"title",""),x3dom.debug.logInfo(this._vf.info),x3dom.debug.logInfo(this._vf.title)}))),x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0)}))),x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.Param.superClass.call(this,e),x3dom.debug.logWarning('DEPRECATED: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')}))),x3dom.registerNodeType("X3DBoundedObject","Grouping",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DBoundedObject.superClass.call(this,e),this.addField_SFBool(e,"render",!0),this.addField_SFBool(e,"visible",!0),this.addField_SFVec3f(e,"bboxCenter",0,0,0),this.addField_SFVec3f(e,"bboxSize",-1,-1,-1),this._graph={boundedNode:this,localMatrix:x3dom.fields.SFMatrix4f.identity(),globalMatrix:null,volume:new x3dom.fields.BoxVolume,lastVolume:new x3dom.fields.BoxVolume,worldVolume:new x3dom.fields.BoxVolume,center:new x3dom.fields.SFVec3f(0,0,0),coverage:-1,needCulling:!0},this._render=!0}),{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&this.invalidateVolume()},nodeChanged:function(){this.invalidateVolume()},parentAdded:function(e){this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag())for(var t=0,i=this._childNodes.length;t<i;t++){var s=this._childNodes[t];if(s&&(!s.renderFlag||!0===s.renderFlag())){var o=s.getVolume();o&&o.isValid()&&e.extendBounds(o.min,o.max)}}if(!e.equals(this._graph.lastVolume)){this._graph.lastVolume=x3dom.fields.BoxVolume.copy(e);var n={target:this._xmlNode,type:"volumechanged",volume:x3dom.fields.BoxVolume.copy(e)};this.callEvtHandler("onvolumechanged",n)}return e},invalidateVolume:function(){var e=this._graph;e.volume.invalidate(),e.worldVolume.invalidate(),e.globalMatrix=null;for(var t=0,i=this._parentNodes.length;t<i;t++){var s=this._parentNodes[t];s&&s.invalidateVolume()}},invalidateCache:function(){var e=this._graph;e.worldVolume.invalidate(),e.globalMatrix=null},cacheInvalid:function(){return null==this._graph.globalMatrix||!this._graph.worldVolume.isValid()},volumeValid:function(){return this._graph.volume.isValid()},graphState:function(){return this._graph},forceUpdateCoverage:function(){return!1},renderFlag:function(){return this._render!==this._vf.render?(this._vf.visible=this._vf.render,this._render=this._vf.visible):this._render!==this._vf.visible&&(this._vf.render=this._vf.visible,this._render=this._vf.visible),this._render}})),x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DBoundedObject,(function(e){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,e),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)}),{collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){var r,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e);var d=this._childNodes.length;if(x3dom.nodeTypes.ClipPlane.count>0){for(var h=[],l=0;l<d;l++)(r=this._childNodes[l])&&x3dom.isa(r,x3dom.nodeTypes.ClipPlane)&&r._vf.on&&r._vf.enabled&&h.push({plane:r,trafo:a});n=h.concat(n)}for(var f=0;f<d;f++)(r=this._childNodes[f])&&r.collectDrawableObjects(a,t,i,s,o,n)}}})),x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Switch.superClass.call(this,e),this.addField_SFInt32(e,"whichChoice",-1)}),{fieldChanged:function(e){"whichChoice"==e&&this.invalidateVolume()},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag()&&this._vf.whichChoice>=0&&this._vf.whichChoice<this._childNodes.length){var t=this._childNodes[this._vf.whichChoice],i=t&&t.renderFlag&&!0===t.renderFlag()?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},collectDrawableObjects:function(e,t,i,s,o,n){var r,a;(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length||(o=t.cull(e,this.graphState(),i,o))<0)||(i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e),(r=this._childNodes[this._vf.whichChoice])&&r.collectDrawableObjects(a,t,i,s,o,n))},doIntersect:function(e){if(this._vf.whichChoice<0||this._vf.whichChoice>=this._childNodes.length)return!1;var t=this._childNodes[this._vf.whichChoice];return!!t&&t.doIntersect(e)}})),x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,e),e?e.doc._nodeBag.trans.push(this):x3dom.debug.logWarning("X3DTransformNode: No runtime context found!"),this._trafo=null,this._needCssStyleUpdates=!0}),{tick:function(e){var t=this._xmlNode;if(t&&(t.ontransform||t.hasAttribute("ontransform")||this._listeners.transform)){var i=this.getCurrentTransform(),s={target:t,type:"transform",worldX:i._03,worldY:i._13,worldZ:i._23,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};this.callEvtHandler("ontransform",s)}if(this._needCssStyleUpdates&&t){var o=x3dom.getStyle(t,"-webkit-transform")||x3dom.getStyle(t,"-moz-transform")||x3dom.getStyle(t,"-ms-transform")||x3dom.getStyle(t,"transform");if(o&&"none"!=o)return this._trafo.setValueByStr(o),this.invalidateVolume(),!0;this._needCssStyleUpdates=!1}return!1},transformMatrix:function(e){return e.mult(this._trafo)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag()){this._graph.localMatrix=this._trafo;for(var t=0,i=this._childNodes.length;t<i;t++){var s=this._childNodes[t];if(s&&(!s.renderFlag||!0===s.renderFlag())){var o=s.getVolume();o&&o.isValid()&&e.extendBounds(o.min,o.max)}}e.isValid()&&e.transform(this._trafo)}return e},doIntersect:function(e){var t=!1,i=this._trafo.inverse(),s=new x3dom.fields.SFVec3f(e.pos.x,e.pos.y,e.pos.z),o=new x3dom.fields.SFVec3f(e.dir.x,e.dir.y,e.dir.z);e.pos=i.multMatrixPnt(e.pos),e.dir=i.multMatrixVec(e.dir),e.hitObject&&(e.dist*=e.dir.length());for(var n=0;n<this._childNodes.length;n++)this._childNodes[n]&&(t=this._childNodes[n].doIntersect(e)||t);return e.pos.setValues(s),e.dir.setValues(o),t&&(e.hitPoint=this._trafo.multMatrixPnt(e.hitPoint),e.dist*=e.dir.length()),t},parentRemoved:function(e){var t,i,s=this.findX3DDoc();if(s)for(t=0,i=s._nodeBag.trans.length;t<i;t++)s._nodeBag.trans[t]===this&&s._nodeBag.trans.splice(t,1);x3dom.nodeTypes.X3DGroupingNode.prototype.parentRemoved.call(this,e)}})),x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,(function(e){x3dom.nodeTypes.Transform.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0),this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))}),{fieldChanged:function(e){"center"==e||"translation"==e||"rotation"==e||"scale"==e||"scaleOrientation"==e?(this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate())),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,(function(e){x3dom.nodeTypes.MatrixTransform.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix.transpose()}),{fieldChanged:function(e){"matrix"==e?(this._trafo=this._vf.matrix.transpose(),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Group.superClass.call(this,e)}))),x3dom.registerNodeType("Block","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Block.superClass.call(this,e),this.addField_MFString(e,"nameSpaceName",[])}))),x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.StaticGroup.superClass.call(this,e),x3dom.debug.logWarning("StaticGroup erroneously also bakes parent transforms, if happens use Group node!"),this.addField_SFBool(e,"debug",!1),this.addField_SFBool(e,"showDebugBoxVolumes",!1),this.addField_SFString(e,"bvhType","jsBIH"),this.addField_SFInt32(e,"maxObjectsPerNode",1),this.addField_SFInt32(e,"maxDepth",-1),this.addField_SFFloat(e,"minRelativeBBoxSize",.01),this.needBvhRebuild=!0,this.drawableCollection=null,this.bvh=null}),{getMaxDepth:function(){return-1==this._vf.maxDepth?"jsBIH"==this._vf.bvhType?50:4:this._vf.maxDepth},collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){var r,a;if(i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e),this.needBvhRebuild){var d={viewArea:t.viewarea,sortTrans:t.sortTrans,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,sceneMatrix:t.sceneMatrix,frustumCulling:!1,smallFeatureThreshold:0,context:t.context};this.drawableCollection=new x3dom.DrawableCollection(d);var h,l=this._childNodes.length;for(h=0;h<l;h++)(r=this._childNodes[h])&&r.collectDrawableObjects(a,this.drawableCollection,i,s,o,n);this.drawableCollection.concat();var f=this._nameSpace.doc._scene,u=new x3dom.bvh.Settings(this._vf.debug,this._vf.showDebugBoxVolumes,this._vf.bvhType,this._vf.maxObjectsPerNode,this.getMaxDepth(),this._vf.minRelativeBBoxSize);for(this.bvh="jsBIH"==this._vf.bvhType?new x3dom.bvh.BIH(f,u):new x3dom.bvh.Culler(this.drawableCollection,f,u),(this._vf.debug||this._vf.showDebugBoxVolumes)&&(this.bvh=new x3dom.bvh.DebugDecorator(this.bvh,f,u)),l=this.drawableCollection.length,h=0;h<l;h++)this.bvh.addDrawable(this.drawableCollection.get(h));this.bvh.compile(),this._vf.debug&&this.bvh.showCompileStats(),this.needBvhRebuild=!1}x3dom.Utils.startMeasure("bvhTraverse"),this.bvh.collectDrawables(t);var _=x3dom.Utils.stopMeasure("bvhTraverse");this._nameSpace.doc.ctx.x3dElem.runtime.addMeasurement("BVH",_),this.bvh.showTraverseStats(this._nameSpace.doc.ctx.x3dElem.runtime)}}})),x3dom.registerNodeType("RemoteSelectionGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.RemoteSelectionGroup.superClass.call(this,e),this.addField_MFString(e,"url",["ws://localhost:35668/cstreams/0"]),this.addField_MFString(e,"label",[]),this.addField_SFInt32(e,"maxRenderedIds",-1),this.addField_SFBool(e,"reconnect",!0),this.addField_SFFloat(e,"scaleRenderedIdsOnMove",1),this.addField_SFBool(e,"enableCulling",!0),this.addField_MFString(e,"invisibleNodes",[]),this._idList=[],this._websocket=null,this._nameObjMap={},this._createTime=[],this._visibleList=[],e?this.initializeSocket():x3dom.debug.logWarning("RemoteSelectionGroup: No runtime context found!")}),{initializeSocket:function(){var e=this;if("WebSocket"in window){var t="ws://localhost:35668/cstreams/0";this._vf.url.length&&this._vf.url[0].length&&(t=this._vf.url[0]),this._websocket=new WebSocket(t),this._websocket._lastMsg=null,this._websocket._lastData="",this._websocket.onopen=function(t){x3dom.debug.logInfo("WS Connected");var i=e._nameSpace.doc._viewarea.getViewMatrix();this._lastMsg=i.toGL().toString(),i=e._nameSpace.doc._viewarea.getProjectionMatrix(),this._lastMsg+=","+i.toGL().toString(),this.send(this._lastMsg),x3dom.debug.logInfo("WS Sent: "+this._lastMsg),this._lastMsg="",this._lastData=""},this._websocket.onclose=function(t){x3dom.debug.logInfo("WS Disconnected"),e._vf.reconnect&&window.setTimeout((function(){e.initializeSocket()}),2e3)},this._websocket.onmessage=function(t){if(e._vf.maxRenderedIds<0)e._idList=x3dom.fields.MFString.parse(t.data);else if(e._vf.maxRenderedIds>0){e._idList=[];for(var i=x3dom.fields.MFString.parse(t.data),s=Math.min(i.length,Math.abs(e._vf.maxRenderedIds)),o=0;o<s;++o)e._idList[o]=i[o]}0!=e._vf.maxRenderedIds&&this._lastData!=t.data&&(this._lastData=t.data,e._nameSpace.doc.needRender=!0,e.invalidateVolume())},this._websocket.onerror=function(e){x3dom.debug.logError(e.data)},this._websocket.updateCamera=function(){var t=e._nameSpace.doc._viewarea.getViewMatrix(),i=t.toGL().toString();i+=","+(t=e._nameSpace.doc._viewarea.getProjectionMatrix()).toGL().toString(),null!=this._lastMsg&&this._lastMsg!=i&&(this._lastMsg=i,this.send(i))}}else x3dom.debug.logError("Browser has no WebSocket support!")},nodeChanged:function(){var e=this._vf.label.length;this._nameObjMap={},this._createTime=new Array(e),this._visibleList=new Array(e);for(var t=0;t<e;++t){var i=this._childNodes[t];i&&x3dom.isa(i,x3dom.nodeTypes.X3DShapeNode)?(this._nameObjMap[this._vf.label[t]]={shape:i,pos:t},this._visibleList[t]=!0):(this._visibleList[t]=!1,x3dom.debug.logError("Invalid children: "+this._vf.label[t])),this._createTime[t]=0}this.invalidateVolume(),x3dom.debug.logInfo("RemoteSelectionGroup has "+e+" entries.")},fieldChanged:function(e){if("url"==e)this._websocket&&(this._websocket.close(),this._websocket=null),this.initializeSocket();else if("invisibleNodes"==e){for(var t=0,i=this._vf.label.length;t<i;++t){var s=this._childNodes[t];if(s&&x3dom.isa(s,x3dom.nodeTypes.X3DShapeNode)){this._visibleList[t]=!0;for(var o=0,n=this._vf.invisibleNodes.length;o<n;++o){var r=this._vf.invisibleNodes[o],a=r.lastIndexOf("*"),d=!1;if(a>0&&(r=r.substring(0,a),d=!0),!(r.length<=1)&&(d&&0==this._vf.label[t].indexOf(r)||this._vf.label[t]==r)){this._visibleList[t]=!1;break}}}else this._visibleList[t]=!1}this.invalidateVolume()}else"render"==e&&this.invalidateVolume()},getNumRenderedObjects:function(e,t){var i=e;if(this._vf.maxRenderedIds>0){var s=Math.max(this._vf.maxRenderedIds,16),o=1;t&&(o=Math.min(this._vf.scaleRenderedIdsOnMove,1)),s=Math.max(Math.round(o*s),0),i=Math.min(i,s)}return i},collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<=0)){var r,a,d=this._nameSpace.doc._viewarea.isMovingOrAnimating(),h=(new Date).getTime(),l=this._childNodes.length;if(this._vf.enableCulling){if(this._websocket&&this._websocket.updateCamera(),this._vf.label.length){for(a=this.getNumRenderedObjects(this._idList.length,d),r=0;r<a;r++){var f=this._nameObjMap[this._idList[r]];f&&f.shape?(f.shape.collectDrawableObjects(e,t,i,s,o,n),this._createTime[f.pos]=h):x3dom.debug.logError("Invalid label: "+this._idList[r])}for(r=0;r<this._childNodes.length;r++)this._childNodes[r]&&!d&&this._createTime[r]>0&&h-this._createTime[r]>1e4&&this._childNodes[r]._cleanupGLObjects&&(this._childNodes[r]._cleanupGLObjects(!0),this._createTime[r]=0)}}else{a=this.getNumRenderedObjects(l,d);var u=0;for(r=0;r<l;r++){var _=this._childNodes[r];if(_){var c=!0;this._visibleList[r]&&u<a&&_.collectDrawableObjects(e,t,i,s,o,n)&&(this._createTime[r]=h,u++,c=!1),c&&!d&&this._createTime[r]>0&&h-this._createTime[r]>1e4&&_._cleanupGLObjects&&(_._cleanupGLObjects(!0),this._createTime[r]=0)}}}}}})),x3dom.registerNodeType("Scene","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Scene.superClass.call(this,e),this.addField_SFString(e,"pickMode","idBuf"),this.addField_SFBool(e,"doPickPass",!0),this.addField_SFString(e,"shadowObjectIdMapping",""),this._lastMin=new x3dom.fields.SFVec3f(0,0,0),this._lastMax=new x3dom.fields.SFVec3f(1,1,1),this._shadowIdMap=null,this.loadMapping()}),{fieldChanged:function(e){"shadowObjectIdMapping"==e&&this.loadMapping()},updateVolume:function(){var e=this.getVolume();e.isValid()&&(this._lastMin=x3dom.fields.SFVec3f.copy(e.min),this._lastMax=x3dom.fields.SFVec3f.copy(e.max))},loadMapping:function(){if(this._shadowIdMap=null,0!=this._vf.shadowObjectIdMapping.length){var e=this,t=new XMLHttpRequest;t.open("GET",this._nameSpace.getURL(this._vf.shadowObjectIdMapping),!0),x3dom.RequestManager.addRequest(t),t.onload=function(){e._shadowIdMap=JSON.parse(t.response),e._shadowIdMap&&e._shadowIdMap.mapping?x3dom.debug.assert(e._shadowIdMap.maxID<=e._shadowIdMap.mapping.length,"Too few ID map entries in "+e._vf.shadowObjectIdMapping+", length of mapping array is only "+e._shadowIdMap.mapping.length+" instead of "+e._shadowIdMap.ids.length+"!"):x3dom.debug.logWarning("Invalid ID map: "+e._vf.shadowObjectIdMapping)}}}})),x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"solid",!0),this.addField_SFBool(e,"ccw",!0),this.addField_SFBool(e,"useGeoCache",!!this._nameSpace&&"true"==this._nameSpace.doc.properties.getProperty("useGeoCache","true").toLowerCase()),this.addField_SFBool(e,"lit",!0),this._mesh=new x3dom.Mesh(this)}),{getVolume:function(){return this._mesh.getVolume()},invalidateVolume:function(){this._mesh.invalidate()},getCenter:function(){return this._mesh.getCenter()},getDiameter:function(){return this._mesh.getDiameter()},doIntersect:function(e){return this._mesh.doIntersect(e)},forceUpdateCoverage:function(){return!1},hasIndexOffset:function(){return!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null},parentAdded:function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._cleanupGLObjects&&e._cleanupGLObjects(!0),e.setAllDirty(),e.invalidateVolume())},needLighting:function(){var e=this._mesh._primType.indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.Mesh.superClass.call(this,e),this.addField_SFString(e,"primType","triangle"),this.addField_MFInt32(e,"index",[]),this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)}),{nodeChanged:function(){var e,t=(new Date).getTime(),i=this._cf.vertexAttributes.nodes.length;for(e=0;e<i;e++){var s=this._cf.vertexAttributes.nodes[e]._vf.name;switch(s.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[s]={},this._mesh._dynamicFields[s].numComponents=this._cf.vertexAttributes.nodes[e]._vf.numComponents,this._mesh._dynamicFields[s].value=this._cf.vertexAttributes.nodes[e]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL(),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var o=(new Date).getTime()-t;x3dom.debug.logWarning("Mesh load time: "+o+" ms")}})),x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.PointSet.superClass.call(this,e),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this._mesh._primType="POINTS"}),{nodeChanged:function(){var e=(new Date).getTime(),t=this._cf.coord.node;x3dom.debug.assert(t,"PointSet without coord node!");var i=t.getPoints(),s=3,o=this._cf.color.node,n=new x3dom.fields.MFColor;o&&(n=o._vf.color,x3dom.debug.assert(i.length==n.length,"Size of color and coord array differs!"),x3dom.isa(o,x3dom.nodeTypes.ColorRGBA)&&(s=4));var r=this._cf.normal.node,a=new x3dom.fields.MFVec3f;r&&(a=r._vf.vector),this._mesh._numColComponents=s,this._mesh._lit=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=i.toGL(),this._mesh._colors[0]=n.toGL(),this._mesh._normals[0]=a.toGL(),this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()},fieldChanged:function(e){var t=null;"coord"==e?(t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))):"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.colors=!0})))},needLighting:function(){return this._vf.lit&&this._cf.normal.node}})),x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFString(e,"normalUpdateMode","fast"),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)}),{handleAttribs:function(){var e,t=this._cf.attrib.nodes.length;for(e=0;e<t;e++){var i=this._cf.attrib.nodes[e]._vf.name;switch(i.toLowerCase()){case"position":this._mesh._positions[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"normal":this._mesh._normals[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;case"color":this._mesh._colors[0]=this._cf.attrib.nodes[e]._vf.value.toGL();break;default:this._mesh._dynamicFields[i]={},this._mesh._dynamicFields[i].numComponents=this._cf.attrib.nodes[e]._vf.numComponents,this._mesh._dynamicFields[i].value=this._cf.attrib.nodes[e]._vf.value.toGL()}}}})),x3dom.registerNodeType("LineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.LineSet.superClass.call(this,e),this.addField_MFInt32(e,"vertexCount",[]),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0}),{nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e);var t=e.getPoints();this._mesh._positions[0]=t.toGL();var i=this._cf.color.node;if(i){var s=i._vf.color;this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=3,x3dom.isa(i,x3dom.nodeTypes.ColorRGBA)&&(this._mesh._numColComponents=4)}var o=0;this._mesh._indices[0]=[];for(var n=0,r=this._vf.vertexCount.length;n<r;n++){var a=this._vf.vertexCount[n];if(a<2){x3dom.debug.logError("LineSet.vertexCount must not be smaller than 2!");break}for(var d=a-2;d>=0;d--)this._mesh._indices[0].push(o++,o),0==d&&o++}},fieldChanged:function(e){if("coord"==e){var t=this._cf.coord.node.getPoints();this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else if("color"==e){var i=this._cf.color.node._vf.color;this._mesh._colors[0]=i.toGL(),this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}}})),x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this._mesh._primType="LINES",x3dom.Utils.needLineWidth=!0}),{_buildGeometry:function(){var e=(new Date).getTime(),t=this._vf.coordIndex;-1!=t.slice(-1)[0]&&t.push(-1);var i=t.filter((function(e){return-1==e})).length,s=this._vf.colorPerVertex,o=this._vf.colorIndex;if(0==o.length&&!s)for(;o.length<i;)o.push(o.length);var n,r,a=!1,d=!1;s&&o.length>=t.length&&(d=!0),!s&&o.length>=i&&(d=!0);var h=this._cf.coord.node;x3dom.debug.assert(h),n=h.getPoints();var l,f,u,_,c,m,p,x,v=3,g=this._cf.color.node;if(g&&(a=!0,r=g._vf.color,x3dom.isa(g,x3dom.nodeTypes.ColorRGBA)&&(v=4)),this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._colors[0]=[],a&&d||n.length>x3dom.Utils.maxIndexableCoords){for(f=0,u=0,_=0,l=0;l<t.length;++l)if(!(t[l]>n.length-1))if(-1!==t[l])switch(d&&x3dom.debug.assert(-1!=o[l]),f){case 0:c=+t[l],p=d&&s?+o[l]:d&&!s?+o[_]:c,f=1;break;case 1:S(this._mesh),f=2;break;case 2:c=m,p=x,S(this._mesh)}else f=0,_+=s?0:1;n.length>x3dom.Utils.maxIndexableCoords&&this._mesh.splitMesh(2)}else{var y=t.length;for(f=0,l=0;l<y;++l)if(-1!=t[l])switch(f){case 0:c=+t[l],f=1;break;case 1:m=+t[l],f=2,this._mesh._indices[0].push(c,m);break;case 2:c=m,m=+t[l],this._mesh._indices[0].push(c,m)}else f=0;this._mesh._positions[0]=n.toGL(),a&&(this._mesh._colors[0]=r.toGL(),this._mesh._numColComponents=v)}for(this.invalidateVolume(),this._mesh._numCoords=0,l=0;l<this._mesh._indices.length;l++)this._mesh._numCoords+=this._mesh._positions[l].length/3;(new Date).getTime();function S(e){m=+t[l],x=d&&s?+o[l]:d&&!s?+o[_]:m,e._indices[0].push(u++,u++),e._positions[0].push(n[c].x),e._positions[0].push(n[c].y),e._positions[0].push(n[c].z),e._positions[0].push(n[m].x),e._positions[0].push(n[m].y),e._positions[0].push(n[m].z),a&&(s||(p=x),e._colors[0].push(r[p].r),e._colors[0].push(r[p].g),e._colors[0].push(r[p].b),e._colors[0].push(r[x].r),e._colors[0].push(r[x].g),e._colors[0].push(r[x].b)),_+=s?1:0}},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))):"color"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.colors=!0}))):"coordIndex"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.indexes=!0,e.invalidateVolume()}))):"colorIndex"==e&&(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.colors=!0,e.invalidateVolume()})))}})),x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])}),{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,s,o,n=this._vf.colorPerVertex,r=this._vf.normalPerVertex,a=this._vf.ccw,d=this._vf.index,h=!1,l=!1,f=!1,u=this._cf.coord.node;x3dom.debug.assert(u),t=u._vf.point;var _=this._cf.normal.node;_?(h=!0,i=_._vf.vector):h=!1;var c="",m=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(l=!0,s=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3)):p._vf.mode&&(c=p._vf.mode):l=!1;var x,v,g,y,S,T,F,b,C,M,E,w,A,D,N,R,I,P=3,V=this._cf.color.node;for(V?(f=!0,o=V._vf.color,x3dom.isa(V,x3dom.nodeTypes.ColorRGBA)&&(P=4)):f=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];t.length%3>0;)t.push(t.length-1);if(S=t.length,!r||!n||S>x3dom.Utils.maxIndexableCoords){for(v=0,g=0,y=0,this._mesh._multiIndIndices=[],this._mesh._posSize=t.length,x=0;x<d.length;++x)switch(x>0&&x%3==0&&(v=0,y++),v){case 0:T=+d[x],r?C=T:r||(C=y),w=T,n?N=T:n||(N=y),v=1;break;case 1:F=+d[x],r?M=F:r||(M=y),A=F,n?R=F:n||(R=y),v=2;break;case 2:b=+d[x],r?E=b:r||(E=y),D=b,n?I=b:n||(I=y),v=3,this._mesh._indices[0].push(g++,g++,g++),this._mesh._positions[0].push(t[T].x),this._mesh._positions[0].push(t[T].y),this._mesh._positions[0].push(t[T].z),this._mesh._positions[0].push(t[F].x),this._mesh._positions[0].push(t[F].y),this._mesh._positions[0].push(t[F].z),this._mesh._positions[0].push(t[b].x),this._mesh._positions[0].push(t[b].y),this._mesh._positions[0].push(t[b].z),h?(this._mesh._normals[0].push(i[C].x),this._mesh._normals[0].push(i[C].y),this._mesh._normals[0].push(i[C].z),this._mesh._normals[0].push(i[M].x),this._mesh._normals[0].push(i[M].y),this._mesh._normals[0].push(i[M].z),this._mesh._normals[0].push(i[E].x),this._mesh._normals[0].push(i[E].y),this._mesh._normals[0].push(i[E].z)):this._mesh._multiIndIndices.push(T,F,b),f&&(this._mesh._colors[0].push(o[N].r),this._mesh._colors[0].push(o[N].g),this._mesh._colors[0].push(o[N].b),4===P&&this._mesh._colors[0].push(o[N].a),this._mesh._colors[0].push(o[R].r),this._mesh._colors[0].push(o[R].g),this._mesh._colors[0].push(o[R].b),4===P&&this._mesh._colors[0].push(o[R].a),this._mesh._colors[0].push(o[I].r),this._mesh._colors[0].push(o[I].g),this._mesh._colors[0].push(o[I].b),4===P&&this._mesh._colors[0].push(o[I].a)),l&&(this._mesh._texCoords[0].push(s[w].x),this._mesh._texCoords[0].push(s[w].y),3===m&&this._mesh._texCoords[0].push(s[w].z),this._mesh._texCoords[0].push(s[A].x),this._mesh._texCoords[0].push(s[A].y),3===m&&this._mesh._texCoords[0].push(s[A].z),this._mesh._texCoords[0].push(s[D].x),this._mesh._texCoords[0].push(s[D].y),3===m&&this._mesh._texCoords[0].push(s[D].z))}h||this._mesh.calcNormals(r?Math.PI:0),l||this._mesh.calcTexCoords(c),this._mesh.splitMesh()}else{for(y=0,x=0;x<d.length;x++)x>0&&x%3==0&&y++,this._mesh._indices[0].push(d[x]),!r&&h&&(this._mesh._normals[0].push(i[y].x),this._mesh._normals[0].push(i[y].y),this._mesh._normals[0].push(i[y].z)),!n&&f&&(this._mesh._colors[0].push(o[y].r),this._mesh._colors[0].push(o[y].g),this._mesh._colors[0].push(o[y].b),4===P&&this._mesh._colors[0].push(o[y].a));this._mesh._positions[0]=t.toGL(),h?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(r?Math.PI:0,a),l?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=m):this._mesh.calcTexCoords(c),f&&n&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=P)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,x=0;x<this._mesh._indices.length;x++)this._mesh._numFaces+=this._mesh._indices[x].length/3,this._mesh._numCoords+=this._mesh._positions[x].length/3;(new Date).getTime()},fieldChanged:function(e){var t=this._cf.coord.node._vf.point;if(t.length>x3dom.Utils.maxIndexableCoords)x3dom.debug.logWarning("IndexedTriangleSet: fieldChanged with too many coordinates not yet implemented!");else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}));else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var i=0,s=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(s=4),this._mesh._colors[0]=[];for(var o=this._vf.index,n=0;n<o.length;++n)n>0&&n%3==0&&i++,this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b),4===s&&this._mesh._colors[0].push(t[i].a)}this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){o=this._vf.index;this._mesh._normals[0]=[];for(i=0,n=0;n<o.length;++n)n>0&&n%3==0&&i++,this._mesh._normals[0].push(t[i].x),this._mesh._normals[0].push(t[i].y),this._mesh._normals[0].push(t[i].z)}this._parentNodes.forEach((function(e){e._dirty.normals=!0}))}else if("texCoord"==e){var r=this._cf.texCoord.node;x3dom.isa(r,x3dom.nodeTypes.MultiTextureCoordinate)&&r._cf.texCoord.nodes.length&&(r=r._cf.texCoord.nodes[0]),t=r._vf.point,this._mesh._texCoords[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}))}}})),x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[]),this._hasIndexOffset=!1,this._indexOffset=null}),{hasIndexOffset:function(){return this._hasIndexOffset},nodeChanged:function(){this.handleAttribs();var e,t,i,s,o=!1,n=!1,r=!1,a=this._vf.colorPerVertex,d=this._vf.normalPerVertex,h=this._vf.index;h.length&&-1!=h[h.length-1]&&h.push(-1);var l=this._cf.coord.node;x3dom.debug.assert(l),e=l._vf.point;var f=this._cf.normal.node;f?(o=!0,t=f._vf.vector):o=!1;var u="",_=2,c=this._cf.texCoord.node;x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c?c._vf.point?(n=!0,i=c._vf.point,x3dom.isa(c,x3dom.nodeTypes.TextureCoordinate3D)&&(_=3)):c._vf.mode&&(u=c._vf.mode):n=!1,this._mesh._numTexComponents=_;var m=3,p=this._cf.color.node;p?(r=!0,s=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):r=!1,this._mesh._numColComponents=m,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[],this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0;var x=0,v=0;if(o&&e.length<=x3dom.Utils.maxIndexableCoords){this._hasIndexOffset=!0,this._indexOffset=[],this._mesh._primType="TRIANGLESTRIP";var g=[0];for(P=0;P<h.length;P++)-1==h[P]?(x++,g.push(this._mesh._indices[0].length)):(this._mesh._indices[0].push(+h[P]),d||(this._mesh._normals[0].push(t[x].x),this._mesh._normals[0].push(t[x].y),this._mesh._normals[0].push(t[x].z)),a||(this._mesh._colors[0].push(s[x].r),this._mesh._colors[0].push(s[x].g),this._mesh._colors[0].push(s[x].b),4===m&&this._mesh._colors[0].push(s[x].a)));for(this._mesh._positions[0]=e.toGL(),d&&(this._mesh._normals[0]=t.toGL()),n?(this._mesh._texCoords[0]=i.toGL(),this._mesh._numTexComponents=_):x3dom.debug.logWarning("IndexedTriangleStripSet: no texCoords given and won't calculate!"),r&&(a&&(this._mesh._colors[0]=s.toGL()),this._mesh._numColComponents=m),P=1;P<g.length;P++){var y=g[P]-g[P-1];this._indexOffset.push({count:y,offset:2*g[P-1]}),this._mesh._numFaces+=y-2}this._mesh._numCoords=this._mesh._positions[0].length/3}else{var S,T,F,b,C,M,E,w,A,D,N,R;this._hasIndexOffset=!1;for(var I=!1,P=1;P<h.length-2;++P)-1!=h[P+1]?(I?(S=h[P],T=h[P-1],F=h[P+1]):(S=h[P-1],T=h[P],F=h[P+1]),I=!I,d?(b=S,C=T,M=F):b=C=M=x,E=S,w=T,A=F,a?(D=S,N=T,R=F):D=N=R=x,this._mesh._indices[0].push(v++,v++,v++),this._mesh._positions[0].push(e[S].x),this._mesh._positions[0].push(e[S].y),this._mesh._positions[0].push(e[S].z),this._mesh._positions[0].push(e[T].x),this._mesh._positions[0].push(e[T].y),this._mesh._positions[0].push(e[T].z),this._mesh._positions[0].push(e[F].x),this._mesh._positions[0].push(e[F].y),this._mesh._positions[0].push(e[F].z),o&&(this._mesh._normals[0].push(t[b].x),this._mesh._normals[0].push(t[b].y),this._mesh._normals[0].push(t[b].z),this._mesh._normals[0].push(t[C].x),this._mesh._normals[0].push(t[C].y),this._mesh._normals[0].push(t[C].z),this._mesh._normals[0].push(t[M].x),this._mesh._normals[0].push(t[M].y),this._mesh._normals[0].push(t[M].z)),r&&(this._mesh._colors[0].push(s[D].r),this._mesh._colors[0].push(s[D].g),this._mesh._colors[0].push(s[D].b),4===m&&this._mesh._colors[0].push(s[D].a),this._mesh._colors[0].push(s[N].r),this._mesh._colors[0].push(s[N].g),this._mesh._colors[0].push(s[N].b),4===m&&this._mesh._colors[0].push(s[N].a),this._mesh._colors[0].push(s[R].r),this._mesh._colors[0].push(s[R].g),this._mesh._colors[0].push(s[R].b),4===m&&this._mesh._colors[0].push(s[R].a)),n&&(this._mesh._texCoords[0].push(i[E].x),this._mesh._texCoords[0].push(i[E].y),3===_&&this._mesh._texCoords[0].push(i[E].z),this._mesh._texCoords[0].push(i[w].x),this._mesh._texCoords[0].push(i[w].y),3===_&&this._mesh._texCoords[0].push(i[w].z),this._mesh._texCoords[0].push(i[A].x),this._mesh._texCoords[0].push(i[A].y),3===_&&this._mesh._texCoords[0].push(i[A].z))):(P+=2,x++);for(o||this._mesh.calcNormals(Math.PI),n||this._mesh.calcTexCoords(u),this._mesh.splitMesh(),this.invalidateVolume(),P=0;P<this._mesh._indices.length;P++)this._mesh._numFaces+=this._mesh._indices[P].length/3,this._mesh._numCoords+=this._mesh._positions[P].length/3}},fieldChanged:function(e){if("coord"==e||"normal"==e||"texCoord"==e||"color"==e){var t=this._cf.coord.node._vf.point;if(null===this._cf.normal.node||t.length>x3dom.Utils.maxIndexableCoords){if("coord"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var i,s,o,n,r=!1,a=!1,d=!1,h=this._vf.colorPerVertex,l=this._vf.normalPerVertex,f=this._vf.index,u=this._cf.coord.node;x3dom.debug.assert(u),i=u._vf.point;var _=this._cf.normal.node;_?(r=!0,s=_._vf.vector):r=!1;var c="",m=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p?p._vf.point?(a=!0,o=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3)):p._vf.mode&&(c=p._vf.mode):a=!1,this._mesh._numTexComponents=m;var x=3,v=this._cf.color.node;v?(d=!0,n=v._vf.color,x3dom.isa(v,x3dom.nodeTypes.ColorRGBA)&&(x=4)):d=!1,this._mesh._numColComponents=x,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var g,y,S,T,F,b,C,M,E,w=0,A=0,D=!1;if(r||a||d){for(var N=1;N<f.length-2;++N)-1!=f[N+1]?(D?(g=f[N],y=f[N-1],S=f[N+1]):(g=f[N-1],y=f[N],S=f[N+1]),D=!D,l?(V=g,T=y,F=S):V=T=F=w,L=g,b=y,C=S,h?(I=g,M=y,E=S):I=M=E=w,this._mesh._indices[0].push(A++,A++,A++),this._mesh._positions[0].push(i[g].x),this._mesh._positions[0].push(i[g].y),this._mesh._positions[0].push(i[g].z),this._mesh._positions[0].push(i[y].x),this._mesh._positions[0].push(i[y].y),this._mesh._positions[0].push(i[y].z),this._mesh._positions[0].push(i[S].x),this._mesh._positions[0].push(i[S].y),this._mesh._positions[0].push(i[S].z),r&&(this._mesh._normals[0].push(s[V].x),this._mesh._normals[0].push(s[V].y),this._mesh._normals[0].push(s[V].z),this._mesh._normals[0].push(s[T].x),this._mesh._normals[0].push(s[T].y),this._mesh._normals[0].push(s[T].z),this._mesh._normals[0].push(s[F].x),this._mesh._normals[0].push(s[F].y),this._mesh._normals[0].push(s[F].z)),d&&(this._mesh._colors[0].push(n[I].r),this._mesh._colors[0].push(n[I].g),this._mesh._colors[0].push(n[I].b),4===x&&this._mesh._colors[0].push(n[I].a),this._mesh._colors[0].push(n[M].r),this._mesh._colors[0].push(n[M].g),this._mesh._colors[0].push(n[M].b),4===x&&this._mesh._colors[0].push(n[M].a),this._mesh._colors[0].push(n[E].r),this._mesh._colors[0].push(n[E].g),this._mesh._colors[0].push(n[E].b),4===x&&this._mesh._colors[0].push(n[E].a)),a&&(this._mesh._texCoords[0].push(o[L].x),this._mesh._texCoords[0].push(o[L].y),3===m&&this._mesh._texCoords[0].push(o[L].z),this._mesh._texCoords[0].push(o[b].x),this._mesh._texCoords[0].push(o[b].y),3===m&&this._mesh._texCoords[0].push(o[b].z),this._mesh._texCoords[0].push(o[C].x),this._mesh._texCoords[0].push(o[C].y),3===m&&this._mesh._texCoords[0].push(o[C].z))):(N+=2,w++);r||this._mesh.calcNormals(Math.PI),a||this._mesh.calcTexCoords(c),this._mesh.splitMesh()}else{for(D=!1,N=1;N<f.length;++N)-1!=f[N+1]?(D?(this._mesh._indices[0].push(f[N]),this._mesh._indices[0].push(f[N-1]),this._mesh._indices[0].push(f[N+1])):(this._mesh._indices[0].push(f[N-1]),this._mesh._indices[0].push(f[N]),this._mesh._indices[0].push(f[N+1])),D=!D):N+=2;this._mesh._positions[0]=i.toGL(),this._mesh.calcNormals(Math.PI),this._mesh.calcTexCoords(c)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,N=0;N<this._mesh._indices.length;N++)this._mesh._numFaces+=this._mesh._indices[N].length/3,this._mesh._numCoords+=this._mesh._positions[N].length/3;this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()}))}else if("color"==e){var R=this._cf.color.node._vf.color,I=(w=0,M=E=0);x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];f=this._vf.index,D=!1;for(N=1;N<f.length-2;++N)-1!=f[N+1]?(this._vf.colorPerVertex?(D?(I=f[N],M=f[N-1],E=f[N+1]):(I=f[N-1],M=f[N],E=f[N+1]),D=!D):this._vf.colorPerVertex||(I=M=E=w),this._mesh._colors[0].push(R[I].r),this._mesh._colors[0].push(R[I].g),this._mesh._colors[0].push(R[I].b),4===x&&this._mesh._colors[0].push(R[I].a),this._mesh._colors[0].push(R[M].r),this._mesh._colors[0].push(R[M].g),this._mesh._colors[0].push(R[M].b),4===x&&this._mesh._colors[0].push(R[M].a),this._mesh._colors[0].push(R[E].r),this._mesh._colors[0].push(R[E].g),this._mesh._colors[0].push(R[E].b),4===x&&this._mesh._colors[0].push(R[E].a)):(N+=2,w++);this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}else if("normal"==e){var P=this._cf.normal.node._vf.vector,V=(w=0,T=F=0);this._mesh._normals[0]=[];f=this._vf.index,D=!1;for(N=1;N<f.length-2;++N)-1!=f[N+1]?(this._vf.normalPerVertex?(D?(V=f[N],T=f[N-1],F=f[N+1]):(V=f[N-1],T=f[N],F=f[N+1]),D=!D):this._vf.normalPerVertex||(V=T=F=w),this._mesh._normals[0].push(P[V].x),this._mesh._normals[0].push(P[V].y),this._mesh._normals[0].push(P[V].z),this._mesh._normals[0].push(P[T].x),this._mesh._normals[0].push(P[T].y),this._mesh._normals[0].push(P[T].z),this._mesh._normals[0].push(P[F].x),this._mesh._normals[0].push(P[F].y),this._mesh._normals[0].push(P[F].z)):(N+=2,w++);this._parentNodes.forEach((function(e){e._dirty.normals=!0}))}else if("texCoord"==e){p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]);var O=p._vf.point,L=b=C=0;m=2;x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3),this._mesh._texCoords[0]=[];f=this._vf.index,D=!1;for(N=1;N<f.length-2;++N)-1!=f[N+1]?(D?(L=f[N],b=f[N-1],C=f[N+1]):(L=f[N-1],b=f[N],C=f[N+1]),D=!D,this._mesh._texCoords[0].push(O[L].x),this._mesh._texCoords[0].push(O[L].y),3===m&&this._mesh._texCoords[0].push(O[L].z),this._mesh._texCoords[0].push(O[b].x),this._mesh._texCoords[0].push(O[b].y),3===m&&this._mesh._texCoords[0].push(O[b].z),this._mesh._texCoords[0].push(O[C].x),this._mesh._texCoords[0].push(O[C].y),3===m&&this._mesh._texCoords[0].push(O[C].z)):N+=2;this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}))}}else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}));else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){w=0,x=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(x=4),this._mesh._colors[0]=[];f=this._vf.index;for(N=0;N<f.length;++N)-1!=f[N]?(this._mesh._colors[0].push(t[w].r),this._mesh._colors[0].push(t[w].g),this._mesh._colors[0].push(t[w].b),4===x&&this._mesh._colors[0].push(t[w].a)):w++}this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){f=this._vf.index;this._mesh._normals[0]=[];w=0;for(N=0;N<f.length;++N)-1!=f[N]?(this._mesh._normals[0].push(t[w].x),this._mesh._normals[0].push(t[w].y),this._mesh._normals[0].push(t[w].z)):w++}this._parentNodes.forEach((function(e){e._dirty.normals=!0}))}else if("texCoord"==e){p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),t=p._vf.point,this._mesh._texCoords[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}))}}else x3dom.debug.logWarning("IndexedTriangleStripSet: fieldChanged for "+e+" not yet implemented!")}})),x3dom.registerNodeType("TriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.TriangleSet.superClass.call(this,e)}),{_buildGeometry:function(){var e,t,i,s,o=this._vf.colorPerVertex,n=this._vf.normalPerVertex,r=this._vf.ccw,a=!1,d=!1,h=!1,l=this._cf.coord.node;if(x3dom.debug.assert(l),!l||l._vf.point.length<3)this._vf.visible=!1;else{e=l._vf.point;var f=this._cf.normal.node;f?(a=!0,t=f._vf.vector):a=!1;var u="",_=2,c=this._cf.texCoord.node;x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c?c._vf.point?(d=!0,i=c._vf.point,x3dom.isa(c,x3dom.nodeTypes.TextureCoordinate3D)&&(_=3)):c._vf.mode&&(u=c._vf.mode):d=!1;var m=3,p=this._cf.color.node;for(p?(h=!0,s=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):h=!1;e.length%3>0;)e.pop();this._mesh._indices[0]=new Array(e.length),this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var x,v=e.length/3,g=0;for(x=0;x<v;x++)this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,this._mesh._indices[0][g]=g++,!n&&a&&(this._mesh._normals[0].push(t[x].x),this._mesh._normals[0].push(t[x].y),this._mesh._normals[0].push(t[x].z)),!o&&h&&(this._mesh._colors[0].push(s[x].r),this._mesh._colors[0].push(s[x].g),this._mesh._colors[0].push(s[x].b),4===m&&this._mesh._colors[0].push(s[x].a));this._mesh._positions[0]=e.toGL(),a?this._mesh._normals[0]=t.toGL():this._mesh.calcNormals(n?Math.PI:0,r),d?(this._mesh._texCoords[0]=i.toGL(),this._mesh._numTexComponents=_):this._mesh.calcTexCoords(u),h&&o&&(this._mesh._colors[0]=s.toGL(),this._mesh._numColComponents=m),this._mesh._numFaces=v,this._mesh._numCoords=e.length,this.invalidateVolume()}},nodeChanged:function(){this._buildGeometry()},fieldChanged:function(e){"coord"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))):"color"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.colors=!0}))):"normal"==e?(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.normals=!0}))):"texCoord"==e&&(this._buildGeometry(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0})))}})),x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,e)}))),x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,e)}),{fieldChanged:function(e){"coord"!==e&&"point"!==e||this._parentNodes.forEach((function(e){e.fieldChanged("coord")}))},parentAdded:function(e){e._mesh&&e._cf.coord&&e._cf.coord.node!==this&&e.fieldChanged("coord")}})),x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,(function(e){x3dom.nodeTypes.Coordinate.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])}),{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("CoordinateDouble","Nurbs",defineClass(x3dom.nodeTypes.X3DCoordinateNode,(function(e){x3dom.nodeTypes.CoordinateDouble.superClass.call(this,e),this.addField_MFVec3d(e,"point",[])}),{getPoints:function(){return this._vf.point}})),x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.Normal.superClass.call(this,e),this.addField_MFVec3f(e,"vector",[])}),{fieldChanged:function(e){"normal"!==e&&"vector"!==e||this._parentNodes.forEach((function(e){e.fieldChanged("normal")}))},parentAdded:function(e){e._mesh&&e._cf.normal.node!==this&&e.fieldChanged("normal")}})),x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.X3DColorNode.superClass.call(this,e)}),{fieldChanged:function(e){"color"===e&&this._parentNodes.forEach((function(e){e.fieldChanged("color")}))},parentAdded:function(e){e._mesh&&e._cf.color.node!==this&&e.fieldChanged("color")}})),x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,(function(e){x3dom.nodeTypes.Color.superClass.call(this,e),this.addField_MFColor(e,"color",[])}))),x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,(function(e){x3dom.nodeTypes.ColorRGBA.superClass.call(this,e),this.addField_MFColorRGBA(e,"color",[])}))),x3dom.registerNodeType("ParticleSet","Rendering",defineClass(x3dom.nodeTypes.PointSet,(function(e){x3dom.nodeTypes.ParticleSet.superClass.call(this,e),this.addField_SFString(e,"mode","ViewDirQuads"),this.addField_SFString(e,"drawOrder","Any"),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_MFVec3f(e,"size",[]),this.addField_MFInt32(e,"index",[]),this.addField_MFFloat(e,"textureZ",[]),this._mesh._primType="POINTS"}),{drawOrder:function(){return this._vf.drawOrder.toLowerCase()},nodeChanged:function(){var e=this._cf.coord.node;x3dom.debug.assert(e,"ParticleSet without coord node!");var t=e.getPoints(),i=3,s=this._cf.color.node,o=new x3dom.fields.MFColor;s&&(o=s._vf.color,x3dom.debug.assert(t.length==o.length,"Size of color and coord array differs!"),x3dom.isa(s,x3dom.nodeTypes.ColorRGBA)&&(i=4));var n=this._cf.normal.node,r=new x3dom.fields.MFVec3f;n&&(r=n._vf.vector);var a=[];if("any"!=this.drawOrder()&&0==(a=this._vf.index.toGL()).length){var d,h=t.length;for(a=new Array(h),d=0;d<h;d++)a[d]=d}this._mesh._numColComponents=i,this._mesh._lit=!1,this._mesh._indices[0]=a,this._mesh._positions[0]=t.toGL(),this._mesh._colors[0]=o.toGL(),this._mesh._normals[0]=r.toGL(),this._mesh._texCoords[0]=[],this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){var t=null;if("index"==e)this._mesh._indices[0]=this._vf.index.toGL(),this._parentNodes.forEach((function(e){e._dirty.indexes=!0}));else if("size"==e)this._parentNodes.forEach((function(e){e._dirty.specialAttribs=!0}));else if("coord"==e){t=this._cf.coord.node.getPoints(),this._mesh._positions[0]=t.toGL();var i=[];if("any"!=this.drawOrder()&&0==(i=this._vf.index.toGL()).length){var s,o=t.length;for(i=new Array(o),s=0;s<o;s++)i[s]=s}this._mesh._indices[0]=i,this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()}))}else"color"==e&&(t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.colors=!0})))}})),x3dom.registerNodeType("ClipPlane","Rendering",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.ClipPlane.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFVec4f(e,"plane",0,1,0,0),this.addField_SFFloat(e,"cappingStrength",0),this.addField_SFColor(e,"cappingColor",1,1,1),this.addField_SFBool(e,"on",!0)}),{fieldChanged:function(e){},nodeChanged:function(){x3dom.nodeTypes.ClipPlane.count++},onRemove:function(){x3dom.nodeTypes.ClipPlane.count--},parentAdded:function(e){},parentRemoved:function(e){x3dom.nodeTypes.X3DChildNode.parentRemoved.prototype.call(this,e)}})),x3dom.nodeTypes.ClipPlane.count=0,x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,e)}))),x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,(function(e){x3dom.nodeTypes.Appearance.superClass.call(this,e),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode),this.addField_SFNode("lineProperties",x3dom.nodeTypes.LineProperties),this.addField_SFNode("pointProperties",x3dom.nodeTypes.PointProperties),this.addField_SFNode("colorMaskMode",x3dom.nodeTypes.ColorMaskMode),this.addField_SFNode("blendMode",x3dom.nodeTypes.BlendMode),this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode),this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode),this.addField_SFString(e,"sortType","auto"),this.addField_SFInt32(e,"sortKey",0),this.addField_SFFloat(e,"alphaClipThreshold",.1),this._shader=null}),{fieldChanged:function(e){"alphaClipThreshold"==e&&this._parentNodes.forEach((function(e){e.setAppDirty()}))},nodeChanged:function(){this._cf.material.node,this._cf.shaders.nodes.length?this._shader=this._cf.shaders.nodes[0]:this._shader&&(this._shader=null),this._parentNodes.forEach((function(e){e.setAppDirty()})),this.checkSortType()},checkSortType:function(){if("auto"==this._vf.sortType)if(this._cf.material.node&&(this._cf.material.node._vf.transparency>0||this._cf.material.node._vf.backTransparency&&this._cf.material.node._vf.backTransparency>0))this._vf.sortType="transparent";else if(this._cf.texture.node&&this._cf.texture.node._vf.url.length)this._cf.texture.node._vf.url[0].toLowerCase().indexOf(".png")>=0?this._vf.sortType="transparent":this._vf.sortType="opaque";else if(x3dom.isa(this._cf.material.node,x3dom.nodeTypes.PhysicalMaterial)){var e=this._cf.material.node;"OPAQUE"==e._vf.alphaMode?this._vf.sortType="opaque":"BLEND"!=e._vf.alphaMode&&"MASK"!=e._vf.alphaMode||(this._vf.sortType="transparent");var t=e._cf.baseColorTexture.node;"opaque"==this._vf.sortType&&t&&t._vf.url.length&&t._vf.url[0].toLowerCase().indexOf(".png")>=0&&(this._vf.sortType="transparent")}else this._vf.sortType="opaque"},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()},parentAdded:function(e){this!=x3dom.nodeTypes.Appearance._defaultNode&&e.setAppDirty()}})),x3dom.nodeTypes.Appearance.defaultNode=function(){return x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged()),x3dom.nodeTypes.Appearance._defaultNode},x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,e)}))),x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.BlendMode.superClass.call(this,e),this.addField_SFString(e,"srcFactor","src_alpha"),this.addField_SFString(e,"destFactor","one_minus_src_alpha"),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"colorTransparency",0),this.addField_SFString(e,"alphaFunc","none"),this.addField_SFFloat(e,"alphaFuncValue",0),this.addField_SFString(e,"equation","none")}))),x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.DepthMode.superClass.call(this,e),this.addField_SFBool(e,"enableDepthTest",!0),this.addField_SFString(e,"depthFunc","none"),this.addField_SFBool(e,"readOnly",!1),this.addField_SFFloat(e,"zNearRange",-1),this.addField_SFFloat(e,"zFarRange",-1)}))),x3dom.registerNodeType("ColorMaskMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.ColorMaskMode.superClass.call(this,e),this.addField_SFBool(e,"maskR",!0),this.addField_SFBool(e,"maskG",!0),this.addField_SFBool(e,"maskB",!0),this.addField_SFBool(e,"maskA",!0)}))),x3dom.registerNodeType("LineProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.LineProperties.superClass.call(this,e),this.addField_SFBool(e,"applied",!0),this.addField_SFInt32(e,"linetype",1),this.addField_SFFloat(e,"linewidthScaleFactor",0)}))),x3dom.registerNodeType("PointProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.PointProperties.superClass.call(this,e),this.addField_SFFloat(e,"pointSizeScaleFactor",1),this.addField_SFFloat(e,"pointSizeMinValue",1),this.addField_SFFloat(e,"pointSizeMaxValue",1),this.addField_SFVec3f(e,"attenuation",1,0,0)}),{nodeChanged:function(){this._vf.pointSizeMinValue>this._vf.pointSizeMaxValue&&(x3dom.debug.logWarning("pointSizeMinValue is larger than pointSizeMaxValue, will set to MaxValue"),this._vf.pointSizeMinValue=this._vf.pointSizeMaxValue)},fieldChanged:function(e){this._nodeChanged()}})),x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,e)}),{_fieldChanged:function(e,t){t.indexOf(e)>-1&&this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.material=!0)})),x3dom.isa(e,x3dom.nodeTypes.X3DAppearanceNode)&&e.checkSortType()}))}})),x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,(function(e){x3dom.nodeTypes.Material.superClass.call(this,e),this.addField_SFFloat(e,"ambientIntensity",.2),this.addField_SFColor(e,"diffuseColor",.8,.8,.8),this.addField_SFColor(e,"emissiveColor",0,0,0),this.addField_SFFloat(e,"shininess",.2),this.addField_SFColor(e,"specularColor",0,0,0),this.addField_SFFloat(e,"transparency",0)}),{fieldChanged:function(e){this._fieldChanged(e,["ambientIntensity","diffuseColor","emissiveColor","shininess","specularColor","transparency"])}})),x3dom.nodeTypes.Material.defaultNode=function(){return x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged()),x3dom.nodeTypes.Material._defaultNode},x3dom.registerNodeType("TwoSidedMaterial","Shape",defineClass(x3dom.nodeTypes.Material,(function(e){x3dom.nodeTypes.TwoSidedMaterial.superClass.call(this,e),this.addField_SFFloat(e,"backAmbientIntensity",.2),this.addField_SFColor(e,"backDiffuseColor",.8,.8,.8),this.addField_SFColor(e,"backEmissiveColor",0,0,0),this.addField_SFFloat(e,"backShininess",.2),this.addField_SFColor(e,"backSpecularColor",0,0,0),this.addField_SFFloat(e,"backTransparency",0),this.addField_SFBool(e,"separateBackColor",!1)}),{fieldChanged:function(e){this._fieldChanged(e,["ambientIntensity","diffuseColor","emissiveColor","shininess","specularColor","transparency","backAmbientIntensity","backDiffuseColor","backEmissiveColor","backShininess","backSpecularColor","backTransparency","separateBackColor"])}})),x3dom.registerNodeType("PhysicalMaterial","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,(function(e){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,e),this.addField_SFString(e,"model","roughnessMetallic"),this.addField_SFColorRGBA(e,"baseColorFactor",1,1,1,1),this.addField_SFFloat(e,"metallicFactor",0),this.addField_SFFloat(e,"roughnessFactor",.2),this.addField_SFColorRGBA(e,"diffuseFactor",1,1,1,1),this.addField_SFColor(e,"specularFactor",1,1,1),this.addField_SFFloat(e,"glossinessFactor",1),this.addField_SFColor(e,"emissiveFactor",0,0,0),this.addField_SFString(e,"normalSpace","TANGENT"),this.addField_SFString(e,"alphaMode","OPAQUE"),this.addField_SFFloat(e,"alphaCutoff",.5),this.addField_SFVec3f(e,"normalBias",-1,-1,1),this.addField_SFFloat(e,"normalScale",1),this.addField_SFBool(e,"unlit",!1),this.addField_SFNode("baseColorTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("roughnessMetallicTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularGlossinessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("occlusionRoughnessMetallicTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("occlusionTexture",x3dom.nodeTypes.X3DTextureNode)}),{fieldChanged:function(e){this._fieldChanged(e,["baseColorFactor","metallicFactor","roughnessFactor","emissiveFactor"]),"alphaMode"==e&&this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.shader=!0)})),x3dom.isa(e,x3dom.nodeTypes.X3DAppearanceNode)&&e.checkSortType()}))},hasTextures:function(){return this._cf.baseColorTexture.node||this._cf.normalTexture.node||this._cf.occlusionTexture.node||this._cf.emissiveTexture.node||this._cf.roughnessMetallicTexture.node},getTextures:function(){var e=[];return this._cf.baseColorTexture.node&&(this._cf.baseColorTexture.node._type="diffuseMap",e.push(this._cf.baseColorTexture.node)),this._cf.normalTexture.node&&(this._cf.normalTexture.node._type="normalMap",e.push(this._cf.normalTexture.node)),this._cf.occlusionTexture.node&&(this._cf.occlusionTexture.node._type="occlusionMap",e.push(this._cf.occlusionTexture.node)),this._cf.emissiveTexture.node&&(this._cf.emissiveTexture.node._type="emissiveMap",e.push(this._cf.emissiveTexture.node)),this._cf.roughnessMetallicTexture.node&&(this._cf.roughnessMetallicTexture.node._type="roughnessMetallicMap",e.push(this._cf.roughnessMetallicTexture.node)),this._cf.specularGlossinessTexture.node&&(this._cf.specularGlossinessTexture.node._type="specularGlossinessMap",e.push(this._cf.specularGlossinessTexture.node)),this._cf.occlusionRoughnessMetallicTexture.node&&(this._cf.occlusionRoughnessMetallicTexture.node._type="occlusionRoughnessMetallicMap",e.push(this._cf.occlusionRoughnessMetallicTexture.node)),e}})),x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DBoundedObject,(function(e){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,e),this.addField_SFBool(e,"isPickable",!0),this.addField_SFInt32(e,"idOffset",0),this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode),this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode),this._objectID=0,this._shaderProperties=null,this._clipPlanes=[],this._cleanupGLObjects=null,this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,tangents:!0,binormals:!0,specialAttribs:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0,ids:!0},this._indexOffset=0,this._coordStrideOffset=[0,0],this._normalStrideOffset=[0,0],this._texCoordStrideOffset=[0,0],this._texCoord2StrideOffset=[0,0],this._colorStrideOffset=[0,0],this._idStrideOffset=[0,0],this._tangentStrideOffset=[0,0],this._binormalStrideOffset=[0,0],this._tessellationProperties=[]}),{collectDrawableObjects:function(e,t,i,s,o,n){var r=this.graphState();return i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!(!this._cf.geometry.node||t.cull(e,r,i,o)<=0)&&(i&&!this._graph.globalMatrix&&(this._graph.globalMatrix=e),this._clipPlanes.length!=n.length&&(this._dirty.shader=!0),this._clipPlanes=n,t.addShape(this,e,r),!0)},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag()){var t=this._cf.geometry.node,i=t?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},getCenter:function(){var e=this._cf.geometry.node;return e?e.getCenter():new x3dom.fields.SFVec3f(0,0,0)},getDiameter:function(){var e=this._cf.geometry.node;return e?e.getDiameter():0},doIntersect:function(e){return this._cf.geometry.node.doIntersect(e)},forceUpdateCoverage:function(){var e=this._cf.geometry.node;return!!e&&e.forceUpdateCoverage()},tessellationProperties:function(){var e=this._cf.geometry.node;return e&&e._indexOffset?e._indexOffset:this._tessellationProperties},isLit:function(){return this._cf.geometry.node._vf.lit},isSolid:function(){var e=this._cf.appearance.node&&this._cf.appearance.node._cf.material.node&&x3dom.isa(this._cf.appearance.node._cf.material.node,x3dom.nodeTypes.TwoSidedMaterial);return this._cf.geometry.node._vf.solid&&!e},isCCW:function(){return this._cf.geometry.node._vf.ccw},parentRemoved:function(e){x3dom.nodeTypes.X3DBoundedObject.prototype.parentRemoved.call(this,e),e&&e.invalidateVolume(),this._parentNodes.length>0&&this.invalidateVolume(),this._cleanupGLObjects&&this._cleanupGLObjects()},unsetDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.tangents=!1,this._dirty.binormals=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1,this._dirty.texture=!1,this._dirty.material=!1,this._dirty.text=!1,this._dirty.shader=!1},unsetGeoDirty:function(){this._dirty.positions=!1,this._dirty.normals=!1,this._dirty.texcoords=!1,this._dirty.colors=!1,this._dirty.tangents=!1,this._dirty.binormals=!1,this._dirty.specialAttribs=!1,this._dirty.indexes=!1},setAllDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.tangents=!0,this._dirty.binormals=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this._dirty.texture=!0,this._dirty.material=!0,this._dirty.text=!0,this._dirty.shader=!0,this.invalidateVolume()},setAppDirty:function(){this._dirty.texture=!0,this._dirty.material=!0,this._dirty.shader=!0},setGeoDirty:function(){this._dirty.positions=!0,this._dirty.normals=!0,this._dirty.texcoords=!0,this._dirty.colors=!0,this._dirty.tangents=!0,this._dirty.binormals=!0,this._dirty.specialAttribs=!0,this._dirty.indexes=!0,this.invalidateVolume()},getShaderProperties:function(e){return(null==this._shaderProperties||1==this._dirty.shader||x3dom.Utils.checkDirtyEnvironment(e,this._shaderProperties)||x3dom.Utils.checkDirtyPhysicalEnvironmentLight(e,this._shaderProperties)||void 0!==this._webgl&&this._webgl.dirtyLighting!=x3dom.Utils.checkDirtyLighting(e))&&(this._shaderProperties=x3dom.Utils.generateProperties(e,this),this._dirty.shader=!1,void 0!==this._webgl&&(this._webgl.dirtyLighting=x3dom.Utils.checkDirtyLighting(e))),this._shaderProperties},getTextures:function(){var e=[],t=this._cf.appearance.node;if(t){var i=t._cf.texture.node;i&&(x3dom.isa(i,x3dom.nodeTypes.MultiTexture)?e=e.concat(i.getTextures()):e.push(i));var s=t._cf.shaders.nodes[0];s&&x3dom.isa(s,x3dom.nodeTypes.CommonSurfaceShader)&&(e=e.concat(s.getTextures()));var o=t._cf.material.node;o&&x3dom.isa(o,x3dom.nodeTypes.PhysicalMaterial)&&(e=e.concat(o.getTextures()))}var n=this._cf.geometry.node;return n&&x3dom.isa(n,x3dom.nodeTypes.Text)&&(e=e.concat(n)),e}})),x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,(function(e){x3dom.nodeTypes.Shape.superClass.call(this,e)}),{nodeChanged:function(){this._cf.appearance.node,this._cf.geometry.node?this._objectID||(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):this._DEF&&x3dom.debug.logError("No geometry given in Shape/"+this._DEF),this.setAllDirty()}})),x3dom.nodeTypes.Shape.shaderPartID=0,x3dom.nodeTypes.Shape.objectID=0,x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(e){for(var t in this.nodeID)if(this.nodeID.hasOwnProperty(t)){var i=this.nodeID[t];i._objectID&&e._objectID&&i._objectID===e._objectID&&(delete this.nodeID[t],x3dom.debug.logInfo("Unreg "+i._objectID))}}},x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DLightNode.superClass.call(this,e),e?e.doc._nodeBag.lights.push(this):x3dom.debug.logWarning("X3DLightNode: No runtime context found!"),this._lightID=0,this._dirty=!0,this.addField_SFFloat(e,"ambientIntensity",0),this.addField_SFColor(e,"color",1,1,1),this.addField_SFFloat(e,"intensity",1),this.addField_SFBool(e,"global",!1),this.addField_SFBool(e,"on",!0),this.addField_SFFloat(e,"shadowIntensity",0),this.addField_SFInt32(e,"shadowMapSize",1024),this.addField_SFInt32(e,"shadowFilterSize",0),this.addField_SFFloat(e,"shadowOffset",0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1)}),{getViewMatrix:function(e){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(this._dirty=!0,this.postMessage(e+"_changed",this._vf[e]))},onRemove:function(){}})),x3dom.nodeTypes.X3DLightNode.lightID=0,x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,(function(e){x3dom.nodeTypes.DirectionalLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1)}),{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize();return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,(function(e){x3dom.nodeTypes.PointLight.superClass.call(this,e),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this._vf.global=!0}),{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixPnt(this._vf.location);return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),e).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,(function(e){x3dom.nodeTypes.SpotLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFVec3f(e,"attenuation",1,0,0),this.addField_SFVec3f(e,"location",0,0,0),this.addField_SFFloat(e,"radius",100),this.addField_SFFloat(e,"beamWidth",3*Math.PI/16),this.addField_SFFloat(e,"cutOffAngle",Math.PI/2),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1),this._vf.global=!0}),{getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixPnt(this._vf.location),i=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize();return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),i).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(t.negate()))}})),x3dom.registerNodeType("PhysicalEnvironmentLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,(function(e){x3dom.nodeTypes.PhysicalEnvironmentLight.superClass.call(this,e),this.addField_SFVec3f(e,"direction",0,0,-1),this.addField_SFString(e,"diffuse","https://x3dom.org/download/assets/pbr/papermillDiffuse.dds"),this.addField_SFString(e,"specular","https://x3dom.org/download/assets/pbr/papermillSpecular.dds"),this.addField_SFInt32(e,"shadowCascades",1),this.addField_SFFloat(e,"shadowSplitFactor",1),this.addField_SFFloat(e,"shadowSplitOffset",.1)}),{fieldChanged:function(e){},getViewMatrix:function(e){var t=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize();return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),t).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(e.negate()))}})),x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,e),e?e.doc._nodeBag.followers.push(this):x3dom.debug.logWarning("X3DFollowerNode: No runtime context found!"),this.addField_SFBool(e,"isActive",!1),this._eps=x3dom.fields.Eps}),{parentRemoved:function(e){if(0===this._parentNodes.length){var t=this.findX3DDoc();if(t)for(var i=0,s=t._nodeBag.followers.length;i<s;i++)t._nodeBag.followers[i]===this&&t._nodeBag.followers.splice(i,1)}x3dom.nodeTypes.X3DChildNode.prototype.parentRemoved.call(this,e)},tick:function(e){return!1},stepResponse:function(e){return e<=0?0:e>=this._vf.duration?1:this.stepResponseCore(e/this._vf.duration)},stepResponseCore:function(e){return.5-.5*Math.cos(e*Math.PI)}})),x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,(function(e){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,e),this.addField_SFTime(e,"duration",1),this._initDone=!1,this._stepTime=0,this._currTime=0,this._bufferEndTime=0,this._numSupports=60}))),x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,(function(e){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,e),this.addField_SFTime(e,"tau",.3),this.addField_SFFloat(e,"tolerance",-1),this.addField_SFInt32(e,"order",3),this._eps=this._vf.tolerance<0?this._eps:this._vf.tolerance,this._lastTick=0}))),x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,(function(e){x3dom.nodeTypes.ColorChaser.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFColor,this._previousValue=new x3dom.fields.SFColor(0,0,0),this._value=new x3dom.fields.SFColor(0,0,0),this.initialize()}),{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var n=this._buffer.length-2;n>=0;n--)o=(s=this._buffer[n].subtract(this._buffer[n+1])).multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(o-=i=Math.floor(o),i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.ColorDamper.superClass.call(this,e),this.addField_SFColor(e,"initialDestination",.8,.8,.8),this.addField_SFColor(e,"initialValue",.8,.8,.8),this.addField_SFColor(e,"value",0,0,0),this.addField_SFColor(e,"destination",0,0,0),this._value0=new x3dom.fields.SFColor(0,0,0),this._value1=new x3dom.fields.SFColor(0,0,0),this._value2=new x3dom.fields.SFColor(0,0,0),this._value3=new x3dom.fields.SFColor(0,0,0),this._value4=new x3dom.fields.SFColor(0,0,0),this._value5=new x3dom.fields.SFColor(0,0,0),this.initialize()}),{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},distance:function(e,t){var i=e.subtract(t);return Math.sqrt(i.r*i.r+i.g*i.g+i.b*i.b)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFColor(this._value3.r,this._value3.g,this._value3.b),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);var s=this.distance(this._value1,this._value0);if(this._vf.order>1){var o=this.distance(this._value2,this._value1);o>s&&(s=o)}if(this._vf.order>2){var n=this.distance(this._value3,this._value2);n>s&&(s=n)}if(this._vf.order>3){var r=this.distance(this._value4,this._value3);r>s&&(s=r)}if(this._vf.order>4){var a=this.distance(this._value5,this._value4);a>s&&(s=a)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,(function(e){x3dom.nodeTypes.OrientationChaser.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._numSupports=30,this._buffer=new x3dom.fields.MFRotation,this._previousValue=new x3dom.fields.Quaternion(0,1,0,0),this._value=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()}),{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.Quaternion.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.Quaternion.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._previousValue=x3dom.fields.Quaternion.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.Quaternion.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.Quaternion.copy(this._previousValue),s=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]);i=i.slerp(i.multiply(s),this.stepResponse((this._buffer.length-1+t)*this._stepTime));for(var o=this._buffer.length-2;o>=0;o--)s=this._buffer[o+1].inverse().multiply(this._buffer[o]),i=i.slerp(i.multiply(s),this.stepResponse((o+t)*this._stepTime));return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(i=i.normalize(i),this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(o-=i=Math.floor(o),i<this._buffer.length){for(this._previousValue=x3dom.fields.Quaternion.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.Quaternion.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._vf.destination.slerp(this._buffer[i],s)}else for(this._previousValue=x3dom.fields.Quaternion.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.Quaternion.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.OrientationDamper.superClass.call(this,e),this.addField_SFRotation(e,"initialDestination",0,1,0,0),this.addField_SFRotation(e,"initialValue",0,1,0,0),this.addField_SFRotation(e,"value",0,1,0,0),this.addField_SFRotation(e,"destination",0,1,0,0),this._value0=new x3dom.fields.Quaternion(0,1,0,0),this._value1=new x3dom.fields.Quaternion(0,1,0,0),this._value2=new x3dom.fields.Quaternion(0,1,0,0),this._value3=new x3dom.fields.Quaternion(0,1,0,0),this._value4=new x3dom.fields.Quaternion(0,1,0,0),this._value5=new x3dom.fields.Quaternion(0,1,0,0),this.initialize()}),{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.slerp(this._value1,i):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w),this._value2=this._vf.order>1&&this._vf.tau?this._value1.slerp(this._value2,i):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w),this._value3=this._vf.order>2&&this._vf.tau?this._value2.slerp(this._value3,i):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w),this._value4=this._vf.order>3&&this._vf.tau?this._value3.slerp(this._value4,i):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w),this._value5=this._vf.order>4&&this._vf.tau?this._value4.slerp(this._value5,i):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);var s=Math.abs(this._value1.inverse().multiply(this._value0).angle());if(this._vf.order>1){var o=Math.abs(this._value2.inverse().multiply(this._value1).angle());o>s&&(s=o)}if(this._vf.order>2){var n=Math.abs(this._value3.inverse().multiply(this._value2).angle());n>s&&(s=n)}if(this._vf.order>3){var r=Math.abs(this._value4.inverse().multiply(this._value3).angle());r>s&&(s=r)}if(this._vf.order>4){var a=Math.abs(this._value5.inverse().multiply(this._value4).angle());a>s&&(s=a)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,(function(e){x3dom.nodeTypes.PositionChaser.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._buffer=new x3dom.fields.MFVec3f,this._previousValue=new x3dom.fields.SFVec3f(0,0,0),this._value=new x3dom.fields.SFVec3f(0,0,0),this.initialize()}),{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec3f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec3f.copy(this._previousValue),s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var n=this._buffer.length-2;n>=0;n--)o=(s=this._buffer[n].subtract(this._buffer[n+1])).multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(o-=i=Math.floor(o),i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec3f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=x3dom.fields.SFVec3f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec3f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,(function(e){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._buffer=new x3dom.fields.MFVec2f,this._previousValue=new x3dom.fields.SFVec2f(0,0),this._value=new x3dom.fields.SFVec2f(0,0),this.initialize()}),{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue.setValues(this._vf.value);for(var t=1;t<this._buffer.length;t++)this._buffer[t].setValues(this._vf.value);this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=x3dom.fields.SFVec2f.copy(this._vf.initialDestination),this._buffer.length=this._numSupports,this._buffer[0]=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);for(var e=1;e<this._buffer.length;e++)this._buffer[e]=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this._stepTime=this._vf.duration/this._numSupports;var t=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=x3dom.fields.SFVec2f.copy(this._previousValue),s=this._buffer[this._buffer.length-1].subtract(this._previousValue),o=s.multiply(this.stepResponse((this._buffer.length-1+t)*this._stepTime));i=i.add(o);for(var n=this._buffer.length-2;n>=0;n--)o=(s=this._buffer[n].subtract(this._buffer[n+1])).multiply(this.stepResponse((n+t)*this._stepTime)),i=i.add(o);return i.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(i),this.postMessage("value",this._value)),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(o-=i=Math.floor(o),i<this._buffer.length){for(this._previousValue=x3dom.fields.SFVec2f.copy(this._buffer[this._buffer.length-i]),t=this._buffer.length-1;t>=i;t--)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._buffer[t-i]);for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i].multiply(s).add(this._vf.destination.multiply(1-s))}else for(this._previousValue=x3dom.fields.SFVec2f.copy(i==this._buffer.length?this._buffer[0]:this._vf.destination),t=0;t<this._buffer.length;t++)this._buffer[t]=x3dom.fields.SFVec2f.copy(this._vf.destination);this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.PositionDamper.superClass.call(this,e),this.addField_SFVec3f(e,"initialDestination",0,0,0),this.addField_SFVec3f(e,"initialValue",0,0,0),this.addField_SFVec3f(e,"value",0,0,0),this.addField_SFVec3f(e,"destination",0,0,0),this._value0=new x3dom.fields.SFVec3f(0,0,0),this._value1=new x3dom.fields.SFVec3f(0,0,0),this._value2=new x3dom.fields.SFVec3f(0,0,0),this._value3=new x3dom.fields.SFVec3f(0,0,0),this._value4=new x3dom.fields.SFVec3f(0,0,0),this._value5=new x3dom.fields.SFVec3f(0,0,0),this.initialize()}),{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);var s=this._value1.subtract(this._value0).length();if(this._vf.order>1){var o=this._value2.subtract(this._value1).length();o>s&&(s=o)}if(this._vf.order>2){var n=this._value3.subtract(this._value2).length();n>s&&(s=n)}if(this._vf.order>3){var r=this._value4.subtract(this._value3).length();r>s&&(s=r)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>s&&(s=a)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,e),this.addField_SFVec2f(e,"initialDestination",0,0),this.addField_SFVec2f(e,"initialValue",0,0),this.addField_SFVec2f(e,"value",0,0),this.addField_SFVec2f(e,"destination",0,0),this._value0=new x3dom.fields.SFVec2f(0,0),this._value1=new x3dom.fields.SFVec2f(0,0),this._value2=new x3dom.fields.SFVec2f(0,0),this._value3=new x3dom.fields.SFVec2f(0,0),this._value4=new x3dom.fields.SFVec2f(0,0),this._value5=new x3dom.fields.SFVec2f(0,0),this.initialize()}),{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination),this._value1.setValues(this._vf.initialValue),this._value2.setValues(this._vf.initialValue),this._value3.setValues(this._vf.initialValue),this._value4.setValues(this._vf.initialValue),this._value5.setValues(this._vf.initialValue),this._lastTick=0;var e=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(i)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z),this._value2=this._vf.order>1&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(i)):new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z),this._value3=this._vf.order>2&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(i)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z),this._value4=this._vf.order>3&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(i)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z),this._value5=this._vf.order>4&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(i)):new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);var s=this._value1.subtract(this._value0).length();if(this._vf.order>1){var o=this._value2.subtract(this._value1).length();o>s&&(s=o)}if(this._vf.order>2){var n=this._value3.subtract(this._value2).length();n>s&&(s=n)}if(this._vf.order>3){var r=this._value4.subtract(this._value3).length();r>s&&(s=r)}if(this._vf.order>4){var a=this._value5.subtract(this._value4).length();a>s&&(s=a)}return s<=this._eps?(this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,(function(e){x3dom.nodeTypes.ScalarChaser.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._buffer=[],this._previousValue=0,this._value=0,this.initialize()}),{fieldChanged:function(e){if(e.indexOf("destination")>=0)this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(e.indexOf("value")>=0){this.initialize(),this._previousValue=this._vf.value;for(var t=1;t<this._buffer.length;t++)this._buffer[t]=this._vf.value;this.postMessage("value",this._vf.value),this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0,this._vf.destination=this._vf.initialDestination,this._buffer.length=this._numSupports,this._buffer[0]=this._vf.initialDestination;for(var e=1;e<this._buffer.length;e++)this._buffer[e]=this._vf.initialValue;this._previousValue=this._vf.initialValue,this._stepTime=this._vf.duration/this._numSupports;var t=Math.abs(this._buffer[0]-this._buffer[1])>this._eps;this._vf.isActive!==t&&this.postMessage("isActive",t)}},tick:function(e){if(this.initialize(),this._currTime=e,!this._bufferEndTime)return this._bufferEndTime=e,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;var t=this.updateBuffer(e),i=this._previousValue,s=this._buffer[this._buffer.length-1]-this._previousValue,o=s*this.stepResponse((this._buffer.length-1+t)*this._stepTime);i+=o;for(var n=this._buffer.length-2;n>=0;n--)i+=o=(s=this._buffer[n]-this._buffer[n+1])*this.stepResponse((n+t)*this._stepTime);return Math.abs(i-this._value)>this._eps?(this._value=i,this.postMessage("value",this._value)):this.postMessage("isActive",!1),this._vf.isActive},updateBuffer:function(e){var t,i,s,o=(e-this._bufferEndTime)/this._stepTime;if(o>=1){if(o-=i=Math.floor(o),i<this._buffer.length){for(this._previousValue=this._buffer[this._buffer.length-i],t=this._buffer.length-1;t>=i;t--)this._buffer[t]=this._buffer[t-i];for(t=0;t<i;t++)s=t/i,this._buffer[t]=this._buffer[i]*s+this._vf.destination*(1-s)}else for(this._previousValue=i==this._buffer.length?this._buffer[0]:this._vf.destination,t=0;t<this._buffer.length;t++)this._buffer[t]=this._vf.destination;this._bufferEndTime+=i*this._stepTime}return o}})),x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.ScalarDamper.superClass.call(this,e),this.addField_SFFloat(e,"initialDestination",0),this.addField_SFFloat(e,"initialValue",0),this.addField_SFFloat(e,"value",0),this.addField_SFFloat(e,"destination",0),this._value0=0,this._value1=0,this._value2=0,this._value3=0,this._value4=0,this._value5=0,this.initialize()}),{fieldChanged:function(e){"tolerance"===e?this._eps=this._vf.tolerance<0?.001:this._vf.tolerance:e.indexOf("destination")>=0?Math.abs(this._value0-this._vf.destination)>this._eps&&(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):e.indexOf("value")>=0&&(this._value1=this._vf.value,this._value2=this._vf.value,this._value3=this._vf.value,this._value4=this._vf.value,this._value5=this._vf.value,this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination,this._value1=this._vf.initialValue,this._value2=this._vf.initialValue,this._value3=this._vf.initialValue,this._value4=this._vf.initialValue,this._value5=this._vf.initialValue,this._lastTick=0;var e=Math.abs(this._value0-this._value1)>this._eps;this._vf.isActive!==e&&this.postMessage("isActive",e)},tick:function(e){if(!this._lastTick)return this._lastTick=e,!1;var t=e-this._lastTick,i=Math.exp(-t/this._vf.tau);this._value1=this._vf.order>0&&this._vf.tau?this._value0+i*(this._value1-this._value0):this._value0,this._value2=this._vf.order>1&&this._vf.tau?this._value1+i*(this._value2-this._value1):this._value1,this._value3=this._vf.order>2&&this._vf.tau?this._value2+i*(this._value3-this._value2):this._value2,this._value4=this._vf.order>3&&this._vf.tau?this._value3+i*(this._value4-this._value3):this._value3,this._value5=this._vf.order>4&&this._vf.tau?this._value4+i*(this._value5-this._value4):this._value4;var s=Math.abs(this._value1-this._value0);if(this._vf.order>1){var o=Math.abs(this._value2-this._value1);o>s&&(s=o)}if(this._vf.order>2){var n=Math.abs(this._value3-this._value2);n>s&&(s=n)}if(this._vf.order>3){var r=Math.abs(this._value4-this._value3);r>s&&(s=r)}if(this._vf.order>4){var a=Math.abs(this._value5-this._value4);a>s&&(s=a)}return s<=this._eps?(this._value1=this._value0,this._value2=this._value0,this._value3=this._value0,this._value4=this._value0,this._value5=this._value0,this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1):(this.postMessage("value",this._value5),this._lastTick=e,!0)}})),x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,e),this.addField_MFVec3f(e,"initialDestination",[]),this.addField_MFVec3f(e,"initialValue",[]),this.addField_MFVec3f(e,"value",[]),this.addField_MFVec3f(e,"destination",[]),x3dom.debug.logWarning("CoordinateDamper NYI")}))),x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,(function(e){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,e),this.addField_MFVec2f(e,"initialDestination",[]),this.addField_MFVec2f(e,"initialValue",[]),this.addField_MFVec2f(e,"value",[]),this.addField_MFVec2f(e,"destination",[]),x3dom.debug.logWarning("TexCoordDamper2D NYI")}))),x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,e),this.addField_MFFloat(e,"key",[]),this.addField_SFFloat(e,"set_fraction",0),this.addField_SFString(e,"buffer",""),this.addField_SFString(e,"interpolation","LINEAR"),this.addField_SFFloat(e,"duration",1),this.addField_MFNode("views",x3dom.nodeTypes.BufferView),this.addField_MFNode("accessors",x3dom.nodeTypes.BufferAccessor),this._lastValue=void 0,this.normalizeFromType={5120:function(e){return Math.max(e/127,-1)},5121:function(e){return e/255},5122:function(e){return Math.max(e/32767,-1)},5123:function(e){return e/65535},5125:function(e){return e/4294967295},5126:function(e){return e}}}),{nodeChanged:function(){this._vf.buffer&&x3dom.BinaryContainerLoader.setupBufferInterpolator(this)},linearInterp:function(e,t){var i=this._vf.key,s=this._vf.keyValue;if(0!=i.length){if(e<=i[0])return t(s[0],s[0],0);if(e>=i[i.length-1])return t(s[i.length-1],s[i.length-1],1);for(var o=0,n=i.length-1;o<n;++o)if(i[o]<e&&e<=i[o+1])return t(s[o],s[o+1],(e-i[o])/(i[o+1]-i[o]));return s[0]}},cubicSplineInterp:function(e,t){if(0!=this._vf.key.length){var i,s,o,n,r,a,d;if(e<=this._vf.key[0])return this._vf.keyValue[1];if(e>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.keyValue.length-2];for(i=0,o=this._vf.key.length-1;i<o;++i)if(this._vf.key[i]<e&&e<=this._vf.key[i+1])return s=3*i,n=this._vf.key[i+1]-this._vf.key[i],a=(e-this._vf.key[i])/n,d=n*this._vf.duration,r=this.cubicSplineBasis(a,d),t(this._vf.keyValue[s+2],this._vf.keyValue[s+1],this._vf.keyValue[s+3],this._vf.keyValue[s+4],r.h00,r.h10,r.h01,r.h11);return this._vf.keyValue[0]}},cubicSplineBasis:function(e,t){var i=e*e,s=i*e,o=-2*s+3*i,n=s-i;return{h00:1-o,h10:t*(n-i+e),h01:o,h11:t*n}},keyValueFromArray:function(e){return e}})),x3dom.XHRCache={},x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,e),this.addField_MFRotation(e,"keyValue",[])}),{fieldChanged:function(e){var t;"set_fraction"===e&&(null!=(t="CUBICSPLINE"===this._vf.interpolation?this.cubicSplineInterp(this._vf.set_fraction,(function(e,t,i,s,o,n,r,a){function d(d){return o*t[d]+n*e[d]+r*s[d]+a*i[d]}var h=new x3dom.fields.Quaternion(0,0,0,0);h.x=d("x"),h.y=d("y"),h.z=d("z"),h.w=d("w");var l=Math.sqrt(1/h.dot(h));return h.x*=l,h.y*=l,h.z*=l,h.w*=l,h})):this.linearInterp(this._vf.set_fraction,(function(e,t,i){return e.slerp(t,i)})))&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t)))},keyValueFromAccessor:function(e,t){var i=new x3dom.fields.MFRotation,s=this.normalizeFromType[t];return e.forEach((function(t,o){o%4==3&&i.push(new x3dom.fields.Quaternion(s(e[o-3]),s(e[o-2]),s(e[o-1]),s(t)))})),i}})),x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[])}),{fieldChanged:function(e){var t;"set_fraction"===e&&(null!=(t="CUBICSPLINE"===this._vf.interpolation?this.cubicSplineInterp(this._vf.set_fraction,(function(e,t,i,s,o,n,r,a){function d(d){return o*t[d]+n*e[d]+r*s[d]+a*i[d]}var h=new x3dom.fields.SFVec3f;return h.x=d("x"),h.y=d("y"),h.z=d("z"),h})):this.linearInterp(this._vf.set_fraction,(function(e,t,i){var s=e.multiply(1-i);return s.x+=i*t.x,s.y+=i*t.y,s.z+=i*t.z,s})))&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t)))},keyValueFromAccessor:function(e){var t=new x3dom.fields.MFVec3f;return e.forEach((function(i,s){s%3==2&&t.push(new x3dom.fields.SFVec3f(e[s-2],e[s-1],i))})),t}})),x3dom.registerNodeType("PositionInterpolator2D","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.PositionInterpolator2D.superClass.call(this,e),this.addField_MFVec2f(e,"keyValue",[])}),{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,(function(e,t,i){return e.multiply(1-i).add(t.multiply(i))}));this.postMessage("value_changed",t)}}})),x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){if(x3dom.nodeTypes.NormalInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),e&&e.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];for(var t=x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")),i=this._vf.key.length>0?this._vf.key.length:1,s=t.length/i,o=0;o<i;o++){for(var n=new x3dom.fields.MFVec3f,r=0;r<s;r++)n.push(t[o*s+r]);this._vf.keyValue.push(n)}}}),{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,(function(e,t,i){for(var s=new x3dom.fields.MFVec3f,o=0;o<e.length;o++)s.push(e[o].multiply(1-i).add(t[o].multiply(i)).normalize());return s}));null!=t&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t))}},keyValueFromAccessor:function(e){var t=new x3dom.fields.MFVec3f;e.forEach((function(i,s){s%3==2&&t.push(new x3dom.fields.SFVec3f(e[s-2],e[s-1],i))}));for(var i=this._vf.key.length>0?this._vf.key.length:1,s=t.length/i,o=[],n=0;n<i;n++){for(var r=new x3dom.fields.MFVec3f,a=0;a<s;a++)r.push(t[n*s+a]);o.push(r)}return o}})),x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,e),this.addField_MFColor(e,"keyValue",[]),this.addField_SFBool(e,"RGB",!1),this._lastValue=new x3dom.fields.SFColor(-1,-1,-1),this.fieldChanged("keyValue")}),{fieldChanged:function(e){var t,i;"set_fraction"===e&&(this._vf.RGB?t=this.linearInterp(this._vf.set_fraction,(function(e,t,s){return i=e.multiply(1-s).add(t.multiply(s))})):(this._vf.keyValue=this._keyValueHSV,t=this.linearInterp(this._vf.set_fraction,(function(e,t,s){var o=e.copy(),n=t.copy();return n.r=n.r>o.r?n.r:n.r+360,n.r-o.r<180||(o.r=o.r+360),(i=o.multiply(1-s).add(n.multiply(s))).setHSV(i.r%360,i.g,i.b)})),this._vf.keyValue=this._keyValue),null==t||t.equals(this._lastValue,x3dom.fields.Eps)||(this._lastValue=t,this.postMessage("value_changed",t)));"keyValue"===e&&(this._keyValueHSV=this._vf.keyValue.map((function(e){var t=e.getHSV();return new x3dom.fields.SFColor(t[0],t[1],t[2])})),this._keyValue=this._vf.keyValue.copy())},keyValueFromAccessor:function(e){var t=new x3dom.fields.MFColor;return e.forEach((function(i,s){s%3==2&&t.push(new x3dom.fields.SFColor(e[s-2],e[s-1],i))})),this._vf.keyValue=t,this.fieldChanged("keyValue"),t}})),x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,e),this.addField_MFFloat(e,"keyValue",[])}),{fieldChanged:function(e){if("set_fraction"===e){var t;if("CUBICSPLINE"===this._vf.interpolation){t=this.cubicSplineInterp(this._vf.set_fraction,(function(e,t,i,s,o,n,r,a){return o*t+n*e+r*s+a*i}))}else t=this.linearInterp(this._vf.set_fraction,(function(e,t,i){return(1-i)*e+i*t}));null!=t&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t))}},keyValueFromAccessor:function(e,t){var i=this.normalizeFromType[t];return e.map((function(e){return i(e)}))}})),x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){if(x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),e&&e.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];for(var t=x3dom.fields.MFVec3f.parse(e.xmlNode.getAttribute("keyValue")),i=this._vf.key.length>0?this._vf.key.length:1,s=t.length/i,o=0;o<i;o++){for(var n=new x3dom.fields.MFVec3f,r=0;r<s;r++)n.push(t[o*s+r]);this._vf.keyValue.push(n)}}}),{fieldChanged:function(e){if("set_fraction"===e){var t=this.linearInterp(this._vf.set_fraction,(function(e,t,i){for(var s=new x3dom.fields.MFVec3f,o=0;o<e.length;o++)s.push(e[o].multiply(1-i).add(t[o].multiply(i)));return s}));null!=t&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t))}},keyValueFromAccessor:function(e){var t=new x3dom.fields.MFVec3f;e.forEach((function(i,s){s%3==2&&t.push(new x3dom.fields.SFVec3f(e[s-2],e[s-1],i))}));for(var i=this._vf.key.length>0?this._vf.key.length:1,s=t.length/i,o=[],n=0;n<i;n++){for(var r=new x3dom.fields.MFVec3f,a=0;a<s;a++)r.push(t[n*s+a]);o.push(r)}return o}})),x3dom.registerNodeType("SplinePositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.SplinePositionInterpolator.superClass.call(this,e),this.addField_MFVec3f(e,"keyValue",[]),this.addField_MFVec3f(e,"keyVelocity",[]),this.addField_SFBool(e,"closed",!1),this.addField_SFBool(e,"normalizeVelocity",!1),this.dtot=0,this.T0=[],this.T1=[],this.checkSanity=function(){this._vf.key.length==this._vf.keyValue.length&&(this._vf.key.length==this._vf.keyVelocity.length||2==this._vf.keyVelocity.length&&this._vf.key.length>=2||0==this._vf.keyVelocity.length)||x3dom.debug.logWarning("SplinePositionInterpolator Node: 'key' , 'keyValue' and/or 'keyVelocity' fields have inappropriate sizes")},this.calcDtot=function(){this.dtot=0;for(var e=0;e<this._vf.key.length-1;e++)this.dtot+=Math.abs(this._vf.key[e]-this._vf.key[e+1])},this.calcAdjustedKeyVelocity=function(){var e,t,i,s,o=this._vf.key.length;if(this._vf.keyVelocity.length==o)for(e=0;e<o;e++)t=this._vf.keyVelocity[e],this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==o-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=0==e||e==o-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s);else if(2==this._vf.keyVelocity.length&&o>2)for(e=0;e<o;e++)t=0==e?this._vf.keyVelocity[0]:e==o-1?this._vf.keyVelocity[1]:this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),this._vf.normalizeVelocity&&(t=t.multiply(this.dtot/t.length())),i=0==e||e==o-1?1:2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=0==e||e==o-1?1:2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1]),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s);else{var n=this._vf.closed&&this._vf.keyValue[0].equals(this._vf.keyValue[o-1],1e-5);for(e=0;e<o;e++)0!=e&&e!=o-1||n?(0!=e&&e!=o-1||!n?(t=this._vf.keyValue[e+1].subtract(this._vf.keyValue[e-1]).multiply(.5),i=2*(this._vf.key[e]-this._vf.key[e-1])/(this._vf.key[e+1]-this._vf.key[e-1]),s=2*(this._vf.key[e+1]-this._vf.key[e])/(this._vf.key[e+1]-this._vf.key[e-1])):(t=this._vf.keyValue[1].subtract(this._vf.keyValue[o-2]).multiply(.5),0==e?(i=2*(this._vf.key[0]-this._vf.key[o-2])/(this._vf.key[1]-this._vf.key[o-2]),s=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[1]-this._vf.key[o-2])):(i=2*(this._vf.key[o-1]-this._vf.key[o-2])/(this._vf.key[1]-this._vf.key[o-2]),s=2*(this._vf.key[1]-this._vf.key[o-1])/(this._vf.key[1]-this._vf.key[o-2])),i=2*(this._vf.key[o-1]-this._vf.key[o-2])/(this._vf.key[o-2]-this._vf.key[1]),s=2*(this._vf.key[1]-this._vf.key[0])/(this._vf.key[o-2]-this._vf.key[1])),this.T0[e]=t.multiply(i),this.T1[e]=t.multiply(s)):(this.T0[e]=new x3dom.fields.SFVec3f(0,0,0),this.T1[e]=new x3dom.fields.SFVec3f(0,0,0))}},this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity()}),{fieldChanged:function(e){switch(e){case"key":case"keyValue":case"keyVelocity":this.checkSanity(),this.calcDtot(),this.calcAdjustedKeyVelocity();break;case"closed":case"normalizeVelocity":this.calcAdjustedKeyVelocity();break;case"set_fraction":var t;this._vf.key.length>0&&(this._vf.set_fraction<=this._vf.key[0]?t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[0]):this._vf.set_fraction>=this._vf.key[this._vf.key.length-1]&&(t=x3dom.fields.SFVec3f.copy(this._vf.keyValue[this._vf.key.length-1])));for(var i=0;i<this._vf.key.length-1;i++)if(this._vf.key[i]<this._vf.set_fraction&&this._vf.set_fraction<=this._vf.key[i+1]){var s=(this._vf.set_fraction-this._vf.key[i])/(this._vf.key[i+1]-this._vf.key[i]),o=new x3dom.fields.SFVec4f(2*s*s*s-3*s*s+1,-2*s*s*s+3*s*s,s*s*s-2*s*s+s,s*s*s-s*s);t=new x3dom.fields.SFVec3f(o.x*this._vf.keyValue[i].x+o.y*this._vf.keyValue[i+1].x+o.z*this.T0[i].x+o.w*this.T1[i+1].x,o.x*this._vf.keyValue[i].y+o.y*this._vf.keyValue[i+1].y+o.z*this.T0[i].y+o.w*this.T1[i+1].y,o.x*this._vf.keyValue[i].z+o.y*this._vf.keyValue[i+1].z+o.z*this.T0[i].z+o.w*this.T1[i+1].z);break}null!=t&&t!=this._lastValue&&(this._lastValue=t,this.postMessage("value_changed",t))}}})),x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,(function(e){x3dom.nodeTypes.TimeSensor.superClass.call(this,e),e?e.doc._nodeBag.timer.push(this):x3dom.debug.logWarning("TimeSensor: No runtime context found!"),this.addField_SFTime(e,"cycleInterval",1),this.addField_SFBool(e,"loop",!1),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0),this.addField_SFTime(e,"pauseTime",0),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"cycleTime",0),this.addField_SFTime(e,"elapsedTime",0),this.addField_SFFloat(e,"fraction_changed",0),this.addField_SFBool(e,"isActive",!1),this.addField_SFBool(e,"isPaused",!1),this.addField_SFTime(e,"time",0),this.addField_SFBool(e,"first",!0),this.addField_SFFloat(e,"firstCycle",0),this._prevCycle=-1,this._lastTime=0,this._cycleStopTime=0,this._activatedTime=0,this._vf.startTime>0&&this._updateCycleStopTime(),this._backupStartTime=this._vf.startTime,this._backupStopTime=this._vf.stopTime,this._backupCycleInterval=this._vf.cycleInterval}),{tick:function(e){if(!this._vf.enabled)return this._lastTime=e,!1;var t=this._vf.cycleInterval>0&&e>=this._vf.startTime&&(e<this._vf.stopTime||this._vf.stopTime<=this._vf.startTime)&&(1==this._vf.loop||0==this._vf.loop&&e<this._cycleStopTime);if(t&&!this._vf.isActive&&(this.postMessage("isActive",!0),this._activatedTime=e),t||this._vf.isActive){this.postMessage("elapsedTime",e-this._activatedTime);var i=e>=this._vf.pauseTime&&this._vf.pauseTime>this._vf.resumeTime;if(i&&!this._vf.isPaused?(this.postMessage("isPaused",!0),this.postMessage("pauseTime",e)):!i&&this._vf.isPaused&&(this.postMessage("isPaused",!1),this.postMessage("resumeTime",e)),!i){var s=this._getCycleAt(e),o=Math.floor(s),n=this._vf.startTime+o*this._vf.cycleInterval,r=0;this._vf.stopTime>this._vf.startTime&&this._lastTime<this._vf.stopTime&&e>=this._vf.stopTime?r=this._vf.stopTime:this._lastTime<n&&e>=n&&(r=n),r>0&&(e=r,s=this._getCycleAt(e),o=Math.floor(s));var a=s-o;a<x3dom.fields.Eps&&(a=this._lastTime<this._vf.startTime?0:1,this.postMessage("cycleTime",e)),this._fraction=a,this.postMessage("fraction_changed",a),this.postMessage("time",e)}}return!t&&this._vf.isActive&&this.postMessage("isActive",!1),this._lastTime=e,!0},fieldChanged:function(e){if("enabled"==e)!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1);else if("startTime"==e){if(this._vf.isActive)return void(this._vf.startTime=this._backupStartTime);this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()}else if("stopTime"==e){if(this._vf.isActive&&this._vf.stopTime<=this._vf.startTime)return void(this._vf.stopTime=this._backupStopTime);this._backupStopTime=this._vf.stopTime}else if("cycleInterval"==e){if(this._vf.isActive)return void(this._vf.cycleInterval=this._backupCycleInterval);this._backupCycleInterval=this._vf.cycleInterval}else if("loop"==e)this._updateCycleStopTime();else if("resumeTime"==e){if(this._vf.resumeTime<this._vf.pauseTime||this._vf.resumeTime<this._vf.startTime||!this._vf.enabled)return;this._vf.startTime=this._vf.resumeTime-this._fraction*this._vf.cycleInterval,this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()}},parentRemoved:function(e){if(0===this._parentNodes.length){var t=this.findX3DDoc();if(t)for(var i=0,s=t._nodeBag.timer.length;i<s;i++)t._nodeBag.timer[i]===this&&t._nodeBag.timer.splice(i,1)}x3dom.nodeTypes.X3DSensorNode.prototype.parentRemoved.call(this,e)},_getCycleAt:function(e){return Math.max(0,e-this._vf.startTime)/this._vf.cycleInterval},_updateCycleStopTime:function(){if(0==this._vf.loop){var e=(new Date).getTime()/1e3,t=Math.floor(this._getCycleAt(e))+1;this._cycleStopTime=this._vf.startTime+t*this._vf.cycleInterval}else this._cycleStopTime=0}})),x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,e),this.addField_SFBool(e,"loop",!1),this.addField_SFString(e,"description","")}))),x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Anchor.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_MFString(e,"parameter",[]),this.addField_SFString(e,"description",""),this.urlIndex=0}),{nodeChanged:function(){this.updateUrlIndex()},fieldChanged:function(e){"url"==e&&this.updateUrlIndex()},updateUrlIndex:function(){this.urlIndex=0,that=this,function e(){var t=that._nameSpace.doc,i=that._vf.url[that.urlIndex],s=i.lastIndexOf("."),o=i.substr(s).toLowerCase();if(i.startsWith("javascript")||!(o.includes("x3d")||o.includes("json")||o.includes("html")))return i;t.incrementDownloads(),fetch(that._nameSpace.getURL(i)).then((function(e){if(!e.ok)throw new Error("Network response was not OK: "+e.status);return e.text()})).then((function(e){return t.decrementDownloads(),e})).catch((function(s){if(x3dom.debug.logWarning(i+": Anchor fetch failed: "+s),t.decrementDownloads(),that.urlIndex++,!(that.urlIndex<that._vf.url.length))return x3dom.debug.logError("Anchor fetch failed for all x3d urls."),null;e()}))}()},doIntersect:function(e){for(var t=!1,i=0;i<this._childNodes.length;i++)this._childNodes[i]&&(t=this._childNodes[i].doIntersect(e)||t);return t},handleTouch:function(){var e=this._vf.url.length?this._vf.url[this.urlIndex]:"",t=e.search("#"),i="";t>=0&&(i=e.slice(t+1));var s=this._vf.parameter.length>this.urlIndex?this._vf.parameter[this.urlIndex]:"",o=s.search("target="),n="";(o>=0&&(n=s.slice(o+7)),x3dom.debug.logInfo("Anchor url="+e+", target="+n+", #viewpoint="+i),i.length>0&&e=="#"+i)?i in this._nameSpace.defMap?this._nameSpace.defMap[i]._xmlNode.setAttribute("bind","true"):x3dom.debug.logWarning("Anchor #viewpoint="+i+" not in DEF list."):e.includes(".x3d")||e.includes(".json")?this.getRuntime().loadURL(this._nameSpace.getURL(e)):0!=n.length||"_self"!=n?window.open(this._nameSpace.getURL(e),n):window.location=this._nameSpace.getURL(e)}})),x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Inline.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"load",!0),this.addField_SFString(e,"description",""),this.addField_MFString(e,"nameSpaceName",[]),this.addField_SFString(e,"contentType",""),this.addField_SFBool(e,"mapDEFToID",!1),this.initDone=!1,this.urlIndex=0,this.count=0,this.numRetries=x3dom.nodeTypes.Inline.MaximumRetries,this.ContentType={X3D:"model/x3d+xml",GLTF:"model/gltf+json",GLB:"model/gltf-binary",X3DJ:"model/x3d+json"}}),{fieldChanged:function(e){if("url"==e||"load"==e){for(var t=this._childNodes.length-1;t>=0;--t)this.removeChild(this._childNodes[t]);if(0!=this._vf.nameSpaceName.length){var i=this._xmlNode;if(i&&i.hasChildNodes())for(;i.childNodes.length>=1;)i.removeChild(i.firstChild)}this.urlIndex=0,this.loadInline()}else"render"==e&&this.invalidateVolume()},nodeChanged:function(){this.initDone||(this.initDone=!0,this.urlIndex=0,this.loadInline())},parentRemoved:function(e){for(var t of this._childNodes)this._nameSpace.removeSpace(t._nameSpace);x3dom.nodeTypes.X3DGroupingNode.prototype.parentRemoved.call(this,e)},fireEvents:function(e){if(this._xmlNode&&(this._xmlNode["on"+e]||this._xmlNode.hasAttribute("on"+e)||this._listeners[e])){var t=this._xmlNode,i={target:t,type:e,error:"error"==e?"XMLHttpRequest Error":"",cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};try{var s=t["on"+e];if("function"==typeof s)s.call(t,i);else if(t.hasAttribute("on"+e)){var o=t.getAttribute("on"+e);new Function("event",o).call(t,i)}var n=this._listeners[e];if(n)for(var r=0;r<n.length;r++)n[r].call(t,i)}catch(e){x3dom.debug.logException(e)}}},isValidContentType:function(e){for(var t in this.ContentType)if(e===this.ContentType[t])return!0;return!1},getContentType:function(){if(""!=this._vf.contentType&&this.isValidContentType(this._vf.contentType))return this._vf.contentType;if(this._vf.url.length&&this._vf.url[this.urlIndex].length){var e=this._vf.url[this.urlIndex],t=e.lastIndexOf(".");if(-1!=t)switch(e.substr(t).toLowerCase()){case".x3d":return this.ContentType.X3D;case".gltf":return this.ContentType.GLTF;case".glb":return this.ContentType.GLB;case".json":return this.ContentType.X3DJ}}},loadX3D:function(e,t){if(this._vf.load){var i=this,s=null;if(e){if((s=t.setupTree(e))._nameSpace.superInlineNode=i,0!=i._vf.nameSpaceName.length)for(;e.children.length;){var o=e.children[0];setNamespace(i._vf.nameSpaceName,o,i._vf.mapDEFToID),i._xmlNode.appendChild(o)}}else x3dom.debug.logError("No Scene in resource");var n=x3dom.getGlobal();for(i._childNodes.length>0&&i._childNodes[0]&&i._childNodes[0]._nameSpace&&i._nameSpace.removeSpace(i._childNodes[0]._nameSpace);0!==i._childNodes.length;)n._remover=i.removeChild(i._childNodes[0]);if(delete n._remover,s){i.addChild(s),i.invalidateVolume();var r=i._nameSpace.doc._scene;r&&(r.invalidateVolume(),window.setTimeout((function(){i.invalidateVolume(),r.updateVolume(),i._nameSpace.doc.needRender=!0,i._nameSpace.doc.decrementDownloads(),i._nameSpace.doc.needRender=!0,x3dom.debug.logInfo("Inline: added "+i._vf.url[i.urlIndex]+" to scene.")}),1e3)),i._nameSpace.importNodes(s._nameSpace),i.fireEvents("load")}s=null,t=null,e=null}else x3dom.debug.logInfo("Inline: load field prevented loading of "+this._vf.url[this.urlIndex])},loadInline:function(){var e=this,t=this.getContentType(),i=!1,s=new window.XMLHttpRequest;if(s.onreadystatechange=function(){if(4==s.readyState)if(s.status===x3dom.nodeTypes.Inline.AwaitTranscoding)if(e.count<e.numRetries){e.count++;var o=+s.getResponseHeader("Refresh")||5;x3dom.debug.logInfo("XHR status: "+s.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): Next request in "+o+" seconds"),window.setTimeout((function(){e._nameSpace.doc.decrementDownloads(),e.loadInline()}),1e3*o)}else x3dom.debug.logError("XHR status: "+s.status+" - Await Transcoding ("+e.count+"/"+e.numRetries+"): No Retries left"),e._nameSpace.doc.decrementDownloads(),e.count=0;else if(200==s.status||0==s.status){var n;x3dom.debug.logInfo("Inline: downloading "+e._vf.url[e.urlIndex]+" done."),null==t&&(t=s.getResponseHeader("Content-Type")),e.count=0;var r=e.addNameSpace();if(t==e.ContentType.GLTF||t==e.ContentType.GLB)if(s.response)n=new x3dom.glTF2Loader(r).load(s.response,i),e.loadX3D(n,r);else e.nextUrlOrError("Invalid XHR response for glTF");else if(t==e.ContentType.X3DJ)if(s.response){var a=x3dom.protoExpander.prototypeExpander(s.responseURL,s.response);null!=(d=(new x3dom.JSONParser).parseJavaScript(a))?(n=d.getElementsByTagName("Scene")[0]||d.getElementsByTagName("scene")[0],e.loadX3D(n,r)):e.nextUrlOrError("Invalid XML parsing of JSON")}else e.nextUrlOrError("Invalid XHR response for JSON");else if(t==e.ContentType.X3D){var d;null!=(d="Microsoft Internet Explorer"==navigator.appName?(new DOMParser).parseFromString(s.responseText,"text/xml"):s.responseXML)?(n=d.getElementsByTagName("Scene")[0]||d.getElementsByTagName("scene")[0],e.loadX3D(n,r)):e.nextUrlOrError("Invalid xml parsing for X3D")}}else e.nextUrlOrError(e._vf.url[e.urlIndex]+" status: "+s.status+" - XMLHttpRequest requires web server running!")},this._vf.url.length&&this._vf.url[this.urlIndex].length){var o=this._nameSpace.getURL(this._vf.url[this.urlIndex]);s.open("GET",o,!0),s.setRequestHeader("Accept","model/x3d+xml; q=1.0, model/gltf+json; q=0.5, model/gltf-binary; q=0.5"),s.overrideMimeType&&(t==this.ContentType.X3D&&s.overrideMimeType("text/xml"),t==this.ContentType.X3DJ?(s.overrideMimeType("application/json"),s.responseType="json"):t==this.ContentType.GLTF?(i=!1,s.responseType="json"):t==this.ContentType.GLB&&(i=!0,s.responseType="arraybuffer"));try{this._nameSpace.doc.incrementDownloads(),x3dom.RequestManager.addRequest(s)}catch(t){e.nextUrlOrError(this._vf.url[this.urlIndex]+": "+t)}}},nextUrlOrError:function(e){x3dom.debug.logWarning(e),this._nameSpace.doc.decrementDownloads(),this.urlIndex++,this.urlIndex<this._vf.url.length?this.loadInline():(this.fireEvents("error"),this.count=0)},addNameSpace:function(){var e=0!=this._vf.nameSpaceName.length?this._vf.nameSpaceName.toString().replace(" ",""):"",t=new x3dom.NodeNameSpace(e,this._nameSpace.doc),i=this._vf.url.length?this._vf.url[0]:"";return"/"===i[0]||i.indexOf(":")>=0?t.setBaseURL(i):t.setBaseURL(this._nameSpace.baseURL+i),this._nameSpace.addSpace(t),t}})),x3dom.nodeTypes.Inline.AwaitTranscoding=202,x3dom.nodeTypes.Inline.MaximumRetries=15,x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,(function(e){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,e);var t=e&&e.autoGen?1:0;this.addField_SFString(e,"crossOrigin",""),this.addField_MFColor(e,"groundColor",[]),this.addField_MFFloat(e,"groundAngle",[]),this.addField_MFColor(e,"skyColor",[new x3dom.fields.SFColor(0,0,0)]),this.addField_MFFloat(e,"skyAngle",[]),this.addField_SFFloat(e,"transparency",t),this._dirty=!0}),{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}})),x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,(function(e){x3dom.nodeTypes.X3DFogNode.superClass.call(this,e),this.addField_SFColor(e,"color",1,1,1),this.addField_SFString(e,"fogType","LINEAR"),this.addField_SFFloat(e,"visibilityRange",0)}),{})),x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,(function(e){x3dom.nodeTypes.Fog.superClass.call(this,e)}),{})),x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,(function(e){x3dom.nodeTypes.Background.superClass.call(this,e),this.addField_MFString(e,"backUrl",[]),this.addField_MFString(e,"bottomUrl",[]),this.addField_MFString(e,"frontUrl",[]),this.addField_MFString(e,"leftUrl",[]),this.addField_MFString(e,"rightUrl",[]),this.addField_MFString(e,"topUrl",[]),this.addField_SFBool(e,"scaling",!1)}),{fieldChanged:function(e){e.indexOf("Url")>0||"transparency"==e||e.search("sky")>=0||e.search("ground")>=0?this._dirty=!0:e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}})),x3dom.registerNodeType("X3DEnvironmentNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,(function(e){x3dom.nodeTypes.X3DEnvironmentNode.superClass.call(this,e)}))),x3dom.registerNodeType("Environment","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DEnvironmentNode,(function(e){x3dom.nodeTypes.Environment.superClass.call(this,e),this.addField_SFBool(e,"sortTrans",!0),this.addField_SFBool(e,"shadowExcludeTransparentObjects",!1),this.addField_SFString(e,"gammaCorrectionDefault","linear"),this.addField_SFString(e,"tonemapping","none"),this.addField_SFBool(e,"frustumCulling",!0),this.addField_SFBool(e,"smallFeatureCulling",!1),this.addField_SFFloat(e,"smallFeatureThreshold",1),this.addField_SFBool(e,"occlusionCulling",!1),this.addField_SFFloat(e,"occlusionVisibilityThreshold",0),this.addField_SFBool(e,"lowPriorityCulling",!1),this.addField_SFFloat(e,"lowPriorityThreshold",1),this.addField_SFBool(e,"tessellationDetailCulling",!1),this.addField_SFFloat(e,"tessellationErrorThreshold",0),this.addField_SFBool(e,"enableARC",!1),this.addField_SFFloat(e,"minFrameRate",1),this.addField_SFFloat(e,"maxFrameRate",62.5),this.addField_SFFloat(e,"userDataFactor",-1),this.addField_SFFloat(e,"smallFeatureFactor",-1),this.addField_SFFloat(e,"occlusionVisibilityFactor",-1),this.addField_SFFloat(e,"lowPriorityFactor",-1),this.addField_SFFloat(e,"tessellationErrorFactor",-1),this.addField_SFBool(e,"SSAO",!1),this.addField_SFFloat(e,"SSAOradius",.7),this.addField_SFFloat(e,"SSAOamount",.3),this.addField_SFInt32(e,"SSAOrandomTextureSize",4),this.addField_SFInt32(e,"SSAOblurDepthTreshold",1),this._validGammaCorrectionTypes=["none","fastlinear","linear"],this.checkSanity()}),{checkSanity:function(){var e=function(e,t,i,s){return e&&t==s?i:e||t==s?t:s};this._smallFeatureThreshold=e(this._vf.smallFeatureCulling,this._vf.smallFeatureThreshold,10,0),this._lowPriorityThreshold=e(this._vf.lowPriorityCulling,this._vf.lowPriorityThreshold,.5,1),this._occlusionVisibilityThreshold=e(this._vf.occlusionCulling,this._vf.occlusionVisibilityThreshold,1,0),this._tessellationErrorThreshold=e(this._vf.tessellationDetailCulling,this._vf.tessellationErrorThreshold,1,0);this._vf.gammaCorrectionDefault=function(e,t){return e=e.toLowerCase(),t._validGammaCorrectionTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" gammaCorrectionDefault may only be linear (default), fastLinear, or none"),t._validGammaCorrectionTypes[0])}(this._vf.gammaCorrectionDefault,this)}})),x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,(function(e){if(x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,e),this.addField_SFFloat(e,"nearClippingPlane",-1),this.addField_SFFloat(e,"farClippingPlane",-1),this.addField_SFBool(e,"viewAll",!1),this.addField_SFNode("navigationInfo",x3dom.nodeTypes.NavigationInfo),e&&e.xmlNode){var t=e.xmlNode;t.resetView||t.getFieldOfView||t.getNear||t.getFar||(t.resetView=function(){var e=this._x3domNode;e.resetView(),e._nameSpace.doc.needRender=!0},t.getFieldOfView=function(){return this._x3domNode.getFieldOfView()},t.getNear=function(){return this._x3domNode.getNear()},t.getFar=function(){return this._x3domNode.getFar()})}}),{activate:function(e){var t=this._nameSpace.doc._viewarea;e=e||this;var i=this;if(this._bindAnimation){if(this._vf.viewAll){var s=this._runtime.getSceneBBox();i=t.getFitViewMatrix(s.min,s.max,e,!0)}t.animateTo(i,e._autoGen?null:e)}t._needNavigationMatrixUpdate=!0,this._cf.navigationInfo.node&&this._cf.navigationInfo.node.bind(!0),x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,e)},deactivate:function(e){x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,e)},getTransformation:function(){return this.getCurrentTransform()},getCenterOfRotation:function(){return new x3dom.fields.SFVec3f(0,0,0)},setCenterOfRotation:function(e){this._vf.centerOfRotation.setValues(e)},getFieldOfView:function(){return Math.PI/2},setView:function(e){var t=this.getCurrentTransform();this._viewMatrix=e.mult(t)},setViewAbsolute:function(e){this._viewMatrix=e},setProjectionMatrix:function(e){},resetView:function(){},getNear:function(){return.1},getFar:function(){return 1e4},getImgPlaneHeightAtDistOne:function(){return 2},getViewMatrix:function(){return null},getProjectionMatrix:function(e){return null},setZoom:function(e){}})),x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,(function(e){x3dom.nodeTypes.Viewpoint.superClass.call(this,e),this.addField_SFFloat(e,"fieldOfView",.785398),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,1,0),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1),this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._projMatrix=null,this._lastAspect=1,this._vf.nearClippingPlane>-1&&(this._vf.zNear=this._vf.nearClippingPlane),this._vf.farClippingPlane>-1&&(this._vf.zFar=this._vf.farClippingPlane),this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)}),{fieldChanged:function(e){"nearClippingPlane"==e?(this._vf.zNear=this._vf.nearClippingPlane,e="zNear"):"farClippingPlane"==e&&(this._vf.zFar=this._vf.farClippingPlane,e="zFar"),"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):e.indexOf("bind")>=0?(this.bind(this._vf.bind),this._cf.navigationInfo.node&&this._cf.navigationInfo.node.bind(this._vf.bind)):"viewAll"==e&&this._vf.viewAll&&this._nameSpace.doc._x3dElem.runtime.fitAll()},setProjectionMatrix:function(e){this._projMatrix=e},getCenterOfRotation:function(){return this._vf.centerOfRotation},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse(),this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(e){var t=this._vf.fieldOfView,i=this._vf.zFar,s=this._vf.zNear;if(s<=0||i<=0){var o=.8,n=1.2,r=this._nameSpace.doc._viewarea,a=r._scene,d=x3dom.fields.SFVec3f.copy(a._lastMin),h=x3dom.fields.SFVec3f.copy(a._lastMax).subtract(d),l=h.length()/2,f=r.getViewMatrix().inverse(),u=f.e3(),_=new x3dom.fields.SFVec3f(0,0,0),c=new x3dom.fields.SFVec3f(1,1,1),m=new x3dom.fields.Quaternion(0,0,1,0),p=new x3dom.fields.Quaternion(0,0,1,0);f.getTransform(_,m,c,p);var x=c.x,v=c.x;v<c.y&&(v=c.y),x>c.y&&(x=c.y),v<c.z&&(v=c.z),x>c.z&&(x=c.z),v>1?o/=v:x>x3dom.fields.Eps&&x<1&&(n/=x);var g=d.add(h.multiply(.5)),y=u.subtract(g).length();l?(s=y>l?(y-l)*o:0,i=(y+l)*n):(s=.1,i=1e5);var S=i/this._zRatio;s=Math.max(s,Math.max(x3dom.fields.Eps,S)),i>this._vf.zNear&&this._vf.zNear>0&&(s=this._vf.zNear),this._vf.zFar>s&&(i=this._vf.zFar),i<=s&&(i=s+1)}if(null==this._projMatrix)this._projMatrix=x3dom.fields.SFMatrix4f.perspective(t,e,s,i);else if(this._zNear!=s||this._zFar!=i){var T=s-i;this._projMatrix._22=(s+i)/T,this._projMatrix._23=2*s*i/T}else this._lastAspect!=e&&(this._projMatrix._00=1/Math.tan(t/2)/e,this._lastAspect=e);return this._zNear=s,this._zFar=i,this._projMatrix}})),x3dom.registerNodeType("OrthoViewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,(function(e){x3dom.nodeTypes.OrthoViewpoint.superClass.call(this,e),this.addField_MFFloat(e,"fieldOfView",[-1,-1,1,1]),this.addField_SFVec3f(e,"position",0,0,10),this.addField_SFRotation(e,"orientation",0,0,0,1),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1),this._viewMatrix=null,this._projMatrix=null,this._lastAspect=1,this._vf.nearClippingPlane>-1&&(this._vf.zNear=this._vf.nearClippingPlane),this._vf.farClippingPlane>-1&&(this._vf.zFar=this._vf.farClippingPlane),this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._fieldOfView=this._vf.fieldOfView.slice(0),this.resetView()}),{fieldChanged:function(e){"nearClippingPlane"==e?(this._vf.zNear=this._vf.nearClippingPlane,e="zNear"):"farClippingPlane"==e&&(this._vf.zFar=this._vf.farClippingPlane,e="zFar"),"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e?(this._fieldOfView=this._vf.fieldOfView,this._projMatrix=null):"zNear"==e||"zFar"==e?(this._projMatrix=null,this.resetView()):e.indexOf("bind")>=0?(this.bind(this._vf.bind),this._cf.navigationInfo.node&&this._cf.navigationInfo.node.bind(this._vf.bind)):"viewAll"==e&&this._vf.viewAll&&this._nameSpace.doc._x3dElem.runtime.fitAll()},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getViewMatrix:function(){return this._viewMatrix},resetView:function(){x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f((this._vf.fieldOfView[0]+this._vf.fieldOfView[2])/2,(this._vf.fieldOfView[1]+this._vf.fieldOfView[3])/2,0));this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()),this._viewMatrix=this._viewMatrix.inverse(),this._projMatrix=null,this._vf.isActive&&this._nameSpace&&this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._vf.zNear},getFar:function(){return this._vf.zFar},getFieldOfView:function(){return.785},setZoom:function(e){this._fieldOfView[0]=-e,this._fieldOfView[1]=-e,this._fieldOfView[2]=e,this._fieldOfView[3]=e,this._projMatrix=null},getZoom:function(e){return this._fieldOfView},getProjectionMatrix:function(e){var t=this.getFieldOfView(),i=this._vf.zFar,s=this._vf.zNear;if(s<=0||i<=0){var o=this._nameSpace.doc._viewarea._scene,n=x3dom.fields.SFVec3f.copy(o._lastMin),r=x3dom.fields.SFVec3f.copy(o._lastMax).subtract(n),a=Math.tan(t/2),d=r.y/2/a+r.z+this._fieldOfView[2],h=r.x/2/a+r.z+this._fieldOfView[2],l=d>h?d:h;i=4*l,s=1e-4,this._viewMatrix._23=-2*l}if(null==this._projMatrix||this._lastAspect!=e||this._zNear!=s||this._zFar!=i){var f=this._zNear=s,u=this._zFar=i,_=this._fieldOfView[0],c=this._fieldOfView[1],m=this._fieldOfView[2],p=this._fieldOfView[3];this._projMatrix=x3dom.fields.SFMatrix4f.ortho(_,m,c,p,f,u,e)}return this._lastAspect=e,this._projMatrix}})),x3dom.registerNodeType("Viewfrustum","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,(function(e){x3dom.nodeTypes.Viewfrustum.superClass.call(this,e),this.addField_SFMatrix4f(e,"modelview",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.addField_SFMatrix4f(e,"projection",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._viewMatrix=this._vf.modelview.transpose().inverse(),this._projMatrix=this._vf.projection.transpose(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)}),{fieldChanged:function(e){"modelview"==e?this.resetView():"projection"==e?this._projMatrix=this._vf.projection.transpose():e.indexOf("bind")>=0&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._centerOfRotation)},setCenterOfRotation:function(e){this._centerOfRotation.setValues(e)},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return 2*Math.atan(1/this._projMatrix._11)},getImgPlaneHeightAtDistOne:function(){return 2/this._projMatrix._11},resetView:function(){this._viewMatrix=this._vf.modelview.transpose().inverse(),this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},getProjectionMatrix:function(e){return this._projMatrix}})),x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,(function(e){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,e)}))),x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,(function(e){x3dom.nodeTypes.NavigationInfo.superClass.call(this,e),this.addField_SFBool(e,"headlight",!0),this.addField_SFBool(e,"reverseScroll",!1),this.addField_MFString(e,"type",["EXAMINE","ANY"]),this.addField_MFFloat(e,"typeParams",[-.4,60,.05,2.8]),this.addField_SFString(e,"explorationMode","all"),this.addField_MFFloat(e,"avatarSize",[.25,1.6,.75]),this.addField_SFFloat(e,"walkDamping",2),this.addField_SFFloat(e,"visibilityLimit",0),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"transitionTime",1),this.addField_MFString(e,"transitionType",["LINEAR"]),this._validTypes=["none","examine","turntable","fly","freefly","lookat","lookaround","walk","game","helicopter","any"],this._typeMapping={default:x3dom.DefaultNavigation,turntable:x3dom.TurntableNavigation,walk:x3dom.WalkNavigation},this._heliUpdated=!1;var t=this.setType(this.getType());x3dom.debug.logInfo("NavType: "+t)}),{fieldChanged:function(e){"typeParams"==e?this._heliUpdated=!1:"type"==e?this.setType(this.getType()):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},setType:function(e,t){var i=this.checkType(e.toLowerCase());if(this.checkType(this.getType())!==i||null==this._impl){switch(null==this._typeMapping[i]?this._impl=new this._typeMapping.default(this):this._impl=new this._typeMapping[i](this),i){case"game":t?t.initMouseState():this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.initMouseState();break;case"helicopter":this._heliUpdated=!1;break;case"turntable":t?t.initMouseState():this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.initMouseState()}this._nameSpace.doc._viewarea&&this._impl.init(this._nameSpace.doc._viewarea,!1)}this._vf.type[0]=i,x3dom.debug.logInfo("Switch to "+i+" mode.")},getType:function(){var e=this._vf.type[0].toLowerCase();return e.length<=1?e="none":"any"==e&&(e="examine"),e},getTypeParams:function(){var e=this._vf.typeParams.length,t=[e>=1?this._vf.typeParams[0]:-.4,e>=2?this._vf.typeParams[1]:60,e>=3?this._vf.typeParams[2]:x3dom.fields.Eps,e>=4?this._vf.typeParams[3]:Math.PI-x3dom.fields.Eps];return e>=5&&(t=t.concat(this._vf.typeParams.slice(4))),t},setTypeParams:function(e){for(var t=0;t<e.length;t++)this._vf.typeParams[t]=e[t]},checkType:function(e){return this._validTypes.indexOf(e)>-1?e:(x3dom.debug.logWarning(e+" is no valid navigation type, use one of "+this._validTypes.toString()),"examine")},getExplorationMode:function(){switch(this._vf.explorationMode.toLowerCase()){case"all":return 7;case"rotate":return 1;case"zoom":return 2;case"pan":return 4;case"-rotate":return 6;case"-zoom":return 5;case"-pan":return 3;case"none":return 0;default:return 7}}})),x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Billboard.superClass.call(this,e),this.addField_SFVec3f(e,"axisOfRotation",0,1,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0),this._eyeLook=new x3dom.fields.SFVec3f(0,0,0)}),{collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){i=!1;var r=this.getVolume(),a=x3dom.fields.SFVec3f.MAX(),d=x3dom.fields.SFVec3f.MIN();r.getBounds(a,d);var h=t.viewMatrix,l=new x3dom.fields.SFVec3f(0,0,0);l=h.inverse().multMatrixPnt(l);var f=h.mult(e);this._eye=e.inverse().multMatrixPnt(l),this._eyeViewUp=new x3dom.fields.SFVec3f(f._10,f._11,f._12),this._eyeLook=new x3dom.fields.SFVec3f(f._20,f._21,f._22);var u=x3dom.fields.SFMatrix4f.identity(),_=d.add(a).multiply(.5),c=this._eye.subtract(_);if(this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var m=(u=x3dom.fields.Quaternion.rotateFromTo(c,new x3dom.fields.SFVec3f(0,0,1)).toMatrix().transpose()).multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),p=u.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize();if(!this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)){var x=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,p),v=x.toMatrix().transpose().multMatrixVec(m),g=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,v);u=x.toMatrix().transpose().mult(u),u=g.toMatrix().transpose().mult(u)}}else{var y=this._vf.axisOfRotation.cross(c).normalize();this._eye.z<0&&(y=y.multiply(-1));var S=Math.asin(y.dot(new x3dom.fields.SFVec3f(0,0,1)));this._eye.z<0&&(S+=Math.PI),u=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+-1*S)}for(var T=this.transformMatrix(e.mult(u)),F=0,b=this._childNodes.length;F<b;F++){var C=this._childNodes[F];C&&C.collectDrawableObjects(T,t,i,s,o,n)}}}})),x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Collision.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode),this.addField_SFTime(e,"collideTime",0),this.addField_SFBool(e,"isActive",!0)}),{collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){var r,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e);for(var d=0,h=this._childNodes.length;d<h;d++)(r=this._childNodes[d])&&r!==this._cf.proxy.node&&r.collectDrawableObjects(a,t,i,s,o,n)}}})),x3dom.registerNodeType("X3DLODNode","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.X3DLODNode.superClass.call(this,e),this.addField_SFBool(e,"forceTransitions",!1),this.addField_SFVec3f(e,"center",0,0,0),this._eye=new x3dom.fields.SFVec3f(0,0,0)}),{collectDrawableObjects:function(e,t,i,s,o,n){i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),(o=t.cull(e,this.graphState(),i,o))<0||(i=!1,this.visitChildren(e,t,i,s,o,n))},visitChildren:function(e,t,i,s,o,n){}})),x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,(function(e){x3dom.nodeTypes.LOD.superClass.call(this,e),this.addField_MFFloat(e,"range",[]),this.addField_SFInt32(e,"level_changed",0),this._lastRangePos=-1}),{visitChildren:function(e,t,i,s,o,n){var r=0,a=this._childNodes.length,d=t.viewMatrix,h=new x3dom.fields.SFVec3f(0,0,0);h=d.inverse().multMatrixPnt(h),this._eye=e.inverse().multMatrixPnt(h);for(var l=this._vf.center.subtract(this._eye).length();r<this._vf.range.length&&l>this._vf.range[r];)r++;r&&r>=a&&(r=a-1),r!==this._lastRangePos&&this.postMessage("level_changed",r),this._lastRangePos=r;var f=this._childNodes[r];if(a&&f){var u=this.transformMatrix(e);f.collectDrawableObjects(u,t,i,s,o,n)}},getVolume:function(){var e,t,i=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag())if(this._lastRangePos>=0)(t=(e=this._childNodes[this._lastRangePos])&&e.renderFlag&&!0===e.renderFlag()?e.getVolume():null)&&t.isValid()&&i.extendBounds(t.min,t.max);else for(var s=0,o=this._childNodes.length;s<o;s++)!(e=this._childNodes[s])||e.renderFlag&&!0!==e.renderFlag()||(t=e.getVolume())&&t.isValid()&&i.extendBounds(t.min,t.max);return i},nodeChanged:function(){this.invalidateVolume()},fieldChanged:function(e){"render"!=e&&"center"!=e&&"range"!=e||this.invalidateVolume()}})),x3dom.registerNodeType("DynamicLOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,(function(e){x3dom.nodeTypes.DynamicLOD.superClass.call(this,e),this.addField_SFFloat(e,"subScale",.5),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFNode("root",x3dom.nodeTypes.X3DShapeNode),this.addField_SFString(e,"urlHead","http://r"),this.addField_SFString(e,"urlCenter",".ortho.tiles.virtualearth.net/tiles/h"),this.addField_SFString(e,"urlTail",".png?g=-1"),this.rootGeometry=new x3dom.nodeTypes.Plane(e),this.level=0,this.quadrant=4,this.cell=""}),{nodeChanged:function(){var e=this._cf.root.node;null!=e&&null==e._cf.geometry.node&&(this.rootGeometry._vf.size.setValues(this._vf.size),this.rootGeometry._vf.subdivision.setValues(this._vf.subdivision),this.rootGeometry._vf.center.setValues(this._vf.center),this.rootGeometry.fieldChanged("subdivision"),this._cf.root.node.addChild(this.rootGeometry),this.rootGeometry.nodeChanged(),this._cf.root.node.nodeChanged(),this._nameSpace.doc.needRender=!0)},visitChildren:function(e,t,i,s,o,n){var r=this._cf.root.node;if(null!=r){var a=t.viewMatrix,d=new x3dom.fields.SFVec3f(0,0,0);d=a.inverse().multMatrixPnt(d),this._eye=e.inverse().multMatrixPnt(d);var h,l=this._vf.center.subtract(this._eye).length();if(l>x3dom.fields.Eps&&l*this._vf.subScale<=this._vf.size.length())if(this._childNodes.length<=1){var f=new Array(new x3dom.fields.SFVec3f(-.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(-.25*this._vf.size.x,-.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(.25*this._vf.size.x,-.25*this._vf.size.y,0));for(h=0;h<4;h++){var u=new x3dom.nodeTypes.DynamicLOD;u._nameSpace=this._nameSpace,u._eye.setValues(this._eye),u.level=this.level+1,u.quadrant=h,u.cell=this.cell+h,u._vf.urlHead=this._vf.urlHead,u._vf.urlCenter=this._vf.urlCenter,u._vf.urlTail=this._vf.urlTail,u._vf.center=this._vf.center.add(f[h]),u._vf.size=this._vf.size.multiply(.5),u._vf.subdivision.setValues(this._vf.subdivision);var _=new x3dom.nodeTypes.Appearance,c=new x3dom.nodeTypes.ImageTexture;c._nameSpace=this._nameSpace,c._vf.url[0]=this._vf.urlHead+u.quadrant+this._vf.urlCenter+u.cell+this._vf.urlTail,_.addChild(c),c.nodeChanged();var m=new x3dom.nodeTypes.Shape;m._nameSpace=this._nameSpace,m.addChild(_),_.nodeChanged(),u.addChild(m,"root"),m.nodeChanged(),this.addChild(u),u.nodeChanged()}}else for(h=1;h<this._childNodes.length;h++)this._childNodes[h].collectDrawableObjects(e,t,i,s,o,n);else r.collectDrawableObjects(e,t,i,s,o,n)}},getVolume:function(){var e=this._graph.volume;return e.isValid()||(e.min.setValues(this._vf.center),e.min.x-=.5*this._vf.size.x,e.min.y-=.5*this._vf.size.y,e.min.z-=x3dom.fields.Eps,e.max.setValues(this._vf.center),e.max.x+=.5*this._vf.size.x,e.max.y+=.5*this._vf.size.y,e.max.z+=x3dom.fields.Eps),e}})),x3dom.DefaultNavigation=function(e){this.navi=e},x3dom.DefaultNavigation.prototype.onMousePress=function(e,t,i,s){},x3dom.DefaultNavigation.prototype.onMouseReleased=function(e,t,i,s,o){},x3dom.DefaultNavigation.prototype.init=function(e,t){},x3dom.DefaultNavigation.prototype.zoom=function(e,t){var i=this.navi,s=e._scene.getViewpoint(),o=e._scene._lastMax.subtract(e._scene._lastMin).length();o=((o=Math.min(o,s.getFar()))<x3dom.fields.Eps?1:o)*i._vf.speed;var n=new x3dom.fields.SFVec3f(0,0,o*t/e._height);if(x3dom.isa(s,x3dom.nodeTypes.OrthoViewpoint)&&s.setZoom(Math.abs(s._fieldOfView[0])-n.z),i._vf.typeParams.length>=6){var r=-i._vf.typeParams[5],a=i._vf.typeParams[4];e._movement.z=Math.min(Math.max(e._movement.z,r),a)}e._movement=e._movement.add(n);var d=e.getViewpointMatrix().mult(e._transMat);e._transMat=d.inverse().mult(x3dom.fields.SFMatrix4f.translation(e._movement)).mult(d)},x3dom.DefaultNavigation.prototype.moveForward=function(e){var t=this.navi;if("game"===t.getType()){var i=.25;t._vf.avatarSize.length>2&&(i=t._vf.avatarSize[0]);var s=5*e._deltaT*t._vf.speed,o=e._yaw/180*Math.PI,n=e._pitch/180*Math.PI,r=e._flyMat.inverse();e._scene._nameSpace.doc.ctx.pickValue(e,e._width/2,e._height/2,e._lastButton),e._pickingInfo.pickObj&&(e._pickingInfo.pickPos.subtract(r.e3()).length()<=2*i||(e._eyePos.x-=Math.sin(o)*s,e._eyePos.z+=Math.cos(o)*s,e._eyePos.y+=Math.sin(n)*s))}},x3dom.DefaultNavigation.prototype.moveBackwards=function(e){var t=this.navi;if("game"===t.getType()){var i=5*e._deltaT*t._vf.speed,s=e._yaw/180*Math.PI,o=e._pitch/180*Math.PI;e._eyePos.x+=Math.sin(s)*i,e._eyePos.z-=Math.cos(s)*i,e._eyePos.y-=Math.sin(o)*i}},x3dom.DefaultNavigation.prototype.strafeLeft=function(e){var t=this.navi;if("game"===t.getType()){var i=5*e._deltaT*t._vf.speed,s=e._yaw/180*Math.PI;e._eyePos.x+=Math.cos(s)*i,e._eyePos.z+=Math.sin(s)*i}},x3dom.DefaultNavigation.prototype.strafeRight=function(e){var t=this.navi;if("game"===t.getType()){var i=5*e._deltaT*t._vf.speed,s=e._yaw/180*Math.PI;e._eyePos.x-=Math.cos(s)*i,e._eyePos.z-=Math.sin(s)*i}},x3dom.DefaultNavigation.prototype.navigateTo=function(e,t){var i=this.navi,s=i.getType(),o=null,n=e._currentInputType==x3dom.InputTypes.NAVIGATION&&("game"===s||e._lastButton>0&&(s.indexOf("fly")>=0||"walk"===s||"helicopter"===s||"looka"===s.substr(0,5)));e._deltaT=t-e._lastTS;var r=function(e,t){return e>0?e<=t?0:e-t:e<=0?e>=-t?0:e+t:void 0},a=function(e,t){return(t<0?-1:1)*Math.pow(e*Math.abs(t),1.65)};if(n){null!==e._pickingInfo.pickObj&&(o={pickPos:e._pickingInfo.pickPos,pickNorm:e._pickingInfo.pickNorm,pickObj:e._pickingInfo.pickObj,firstObj:e._pickingInfo.firstObj,lastObj:e._pickingInfo.lastObj,lastClickObj:e._pickingInfo.lastClickObj,shadowObjectId:e._pickingInfo.shadowObjectId});var d=.25,h=1.6;i._vf.avatarSize.length>2&&(d=i._vf.avatarSize[0],h=i._vf.avatarSize[1],i._vf.avatarSize[2]);var l=e.getViewMatrix(),f=0,u=Math.min(e._width,e._height),_=r((e._pressX-e._lastX)/u,.01),c=r((e._pressY-e._lastY)/u,.01),m=a(1,_),p=a(1,c),x=2&e._lastButton?-1:1;x*=e._deltaT*i._vf.speed;e._deltaT,i._vf.speed;var v=e._deltaT*i._vf.speed*p,g=Math.PI*e._deltaT*m,y=Math.PI*e._deltaT*p;if(!0===e._needNavigationMatrixUpdate){e._needNavigationMatrixUpdate=!1,e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0);var S=0,T=Math.asin(l._02),F=Math.cos(T);Math.abs(F)>1e-4&&(S=Math.atan2(-l._12/F,l._22/F)),e._flyMat=l.inverse(),e._from=e._flyMat.e3(),e._at=e._from.subtract(e._flyMat.e2()),"helicopter"===s&&(e._at.y=e._from.y),e._up=e._flyMat.e1(),e._pitch=180*S/Math.PI,e._yaw=180*T/Math.PI,e._eyePos=e._from.negate()}var b,C,M,E,w,A=null,D=null,N=null;if("game"===s){e._pitch+=e._dy,e._yaw+=e._dx,e._pitch>=89&&(e._pitch=89),e._pitch<=-89&&(e._pitch=-89),e._yaw>=360&&(e._yaw-=360),e._yaw<0&&(e._yaw=360+e._yaw),e._dx=0,e._dy=0;var R=x3dom.fields.SFMatrix4f.rotationX(e._pitch/180*Math.PI),I=x3dom.fields.SFMatrix4f.rotationY(e._yaw/180*Math.PI),P=x3dom.fields.SFMatrix4f.translation(e._eyePos);e._flyMat=R.mult(I).mult(P);var V=e._flyMat.inverse(),O=V.e3();return D=new x3dom.fields.SFVec3f(0,-1,0),A=O.add(D),D=V.e0().cross(D).normalize(),N=(N=x3dom.fields.SFMatrix4f.lookAt(O,A,D)).inverse(),e._scene._nameSpace.doc.ctx.pickValue(e,e._width/2,e._height/2,e._lastButton,N,e.getProjectionMatrix().mult(N)),e._pickingInfo.pickObj&&(f=e._pickingInfo.pickPos.subtract(O).length(),O.y+=h-f,V.setTranslate(O),e._eyePos=V.e3().negate(),e._flyMat=V.inverse(),e._pickingInfo.pickObj=null),e._scene.getViewpoint().setView(e._flyMat),n}if("helicopter"===s){var L=i.getTypeParams();if(2&e._lastButton){var B=200*v;L[1]+=B,i.setTypeParams(L)}x=1&e._lastButton?300*v:0,y=L[0],e._from.y=L[1],e._at.y=e._from.y,b=x3dom.fields.Quaternion.axisAngle(e._up,g).toMatrix(),C=(C=x3dom.fields.SFMatrix4f.translation(e._from)).mult(b),b=x3dom.fields.SFMatrix4f.translation(e._from.negate()),C=C.mult(b),e._at=C.multMatrixPnt(e._at),w=(E=(M=e._at.subtract(e._from).normalize()).cross(e._up).normalize()).cross(M).normalize(),M=M.multiply(x),e._from=e._from.add(M),e._at=e._at.add(M),b=x3dom.fields.Quaternion.axisAngle(E,y).toMatrix(),C=(C=x3dom.fields.SFMatrix4f.translation(e._from)).mult(b),b=x3dom.fields.SFMatrix4f.translation(e._from.negate());var U=(C=C.mult(b)).multMatrixPnt(e._at);return e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,U,w),e._scene.getViewpoint().setView(e._flyMat.inverse()),n}if(b=x3dom.fields.Quaternion.axisAngle(e._up,g).toMatrix(),C=(C=x3dom.fields.SFMatrix4f.translation(e._from)).mult(b),b=x3dom.fields.SFMatrix4f.translation(e._from.negate()),C=C.mult(b),e._at=C.multMatrixPnt(e._at),w=(E=(M=e._at.subtract(e._from).normalize()).cross(e._up).normalize()).cross(M).normalize(),b=x3dom.fields.Quaternion.axisAngle(E,y).toMatrix(),C=(C=x3dom.fields.SFMatrix4f.translation(e._from)).mult(b),b=x3dom.fields.SFMatrix4f.translation(e._from.negate()),C=C.mult(b),e._at=C.multMatrixPnt(e._at),"looka"!==s.substr(0,5)){var G=e.getProjectionMatrix();"freefly"!==s&&(x<0?((N=new x3dom.fields.SFMatrix4f).setValue(e._last_mat_view.e0(),e._last_mat_view.e1(),e._last_mat_view.e2().negate(),e._last_mat_view.e3()),e._scene._nameSpace.doc.ctx.pickValue(e,e._width/2,e._height/2,e._lastButton,N,G.mult(N))):e._scene._nameSpace.doc.ctx.pickValue(e,e._width/2,e._height/2,e._lastButton),e._pickingInfo.pickObj&&(f=e._pickingInfo.pickPos.subtract(e._from).length())<=d+x&&(x=0)),M=e._at.subtract(e._from).normalize().multiply(x),e._at=e._at.add(M),e._from=e._from.add(M),"walk"===s&&(w.x=0,w.y=1,w.z=0,A=e._from.addScaled(w,-1),D=E.cross(w.negate()).normalize(),N=(N=x3dom.fields.SFMatrix4f.lookAt(e._from,A,D)).inverse(),e._scene._nameSpace.doc.ctx.pickValue(e,e._width/2,e._height/2,e._lastButton,N,G.mult(N)),e._pickingInfo.pickObj&&(f=(h-(f=e._pickingInfo.pickPos.subtract(e._from).length()))/i._vf.walkDamping,e._at=e._at.add(w.multiply(f)),e._from=e._from.add(w.multiply(f)))),e._pickingInfo.pickObj=null}e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,e._at,w),e._scene.getViewpoint().setView(e._flyMat.inverse()),null!==o&&(e._pickingInfo=o)}return n},x3dom.DefaultNavigation.prototype.animateTo=function(e,t,i,s){var o,n=this.navi;e._mixer._isVPtarget=x3dom.isa(t,x3dom.nodeTypes.X3DViewpointNode),e._mixer._isVPtarget&&(t=t.getViewMatrix().mult(t.getCurrentTransform().inverse())),"teleport"!==n._vf.transitionType[0].toLowerCase()&&0!=s&&"game"!==n.getType()&&i&&x3dom.isa(i,x3dom.nodeTypes.X3DViewpointNode)?(o=i.getViewMatrix().mult(i.getCurrentTransform().inverse()).mult(e._transMat).mult(e._rotMat),e._mixer.isActive()&&(i.setView(e._mixer.getEndMatrix()),e._mixer.reset()),e._mixer.beginTime=e._lastTS,e._mixer.endTime=arguments.length>=4&&null!=arguments[3]?e._lastTS+s:e._lastTS+n._vf.transitionTime,e._mixer.setBeginMatrix(o),e._mixer.setEndMatrix(t),e._scene.getViewpoint().setView(o)):e._scene.getViewpoint().setView(t),e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0),e._needNavigationMatrixUpdate=!0},x3dom.DefaultNavigation.prototype.orthoAnimateTo=function(e,t,i,s){var o=this.navi;s=s||o._vf.transitionTime,e._interpolator.beginValue=i,e._interpolator.endValue=t,e._interpolator.beginTime=e._lastTS,e._interpolator.endTime=e._lastTS+s},x3dom.DefaultNavigation.prototype.resetView=function(e){var t=this.navi;if("teleport"!==t._vf.transitionType[0].toLowerCase()&&"game"!==t.getType()){var i=e._scene.getViewpoint();e._mixer.beginTime=e._lastTS,e._mixer.endTime=e._lastTS+t._vf.transitionTime,e._mixer.setBeginMatrix(e.getViewMatrix()),x3dom.isa(i,x3dom.nodeTypes.OrthoViewpoint)&&this.orthoAnimateTo(e,Math.abs(i._vf.fieldOfView[0]),Math.abs(i._fieldOfView[0]));var s=e._scene.getViewpoint();s.resetView(),s=s.getViewMatrix().mult(s.getCurrentTransform().inverse()),e._mixer.setEndMatrix(s)}else e._scene.getViewpoint().resetView();e.resetNavHelpers(),t._heliUpdated=!1},x3dom.DefaultNavigation.prototype.onDrag=function(e,t,i,s){var o=this.navi,n=o.getType(),r=o.getExplorationMode();if("none"!==n&&0!=r){var a=e._scene.getViewpoint(),d=t-e._lastX,h=i-e._lastY;if(e._dx=d,e._dy=h,e._lastX=t,e._lastY=i,"examine"===n){var l,f,u,_,c=null;if(1&(s&=r)){u=2*h*Math.PI/e._width,_=2*d*Math.PI/e._height,c=e.getViewMatrix();var m=x3dom.fields.SFMatrix4f.rotationX(u),p=x3dom.fields.SFMatrix4f.rotationY(_),x=a.getCenterOfRotation();c.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),e._rotMat=e._rotMat.mult(x3dom.fields.SFMatrix4f.translation(x)).mult(c.inverse()).mult(m).mult(p).mult(c).mult(x3dom.fields.SFMatrix4f.translation(x.negate()))}if(4&s&&(l=e._scene._lastMax.subtract(e._scene._lastMin).length(),l=((l=Math.min(l,a.getFar()))<x3dom.fields.Eps?1:l)*o._vf.speed,f=new x3dom.fields.SFVec3f(l*d/e._width,l*-h/e._height,0),e._movement=e._movement.add(f),c=e.getViewpointMatrix().mult(e._transMat),e._transMat=c.inverse().mult(x3dom.fields.SFMatrix4f.translation(e._movement)).mult(c)),2&s){if(l=e._scene._lastMax.subtract(e._scene._lastMin).length(),l=((l=Math.min(l,a.getFar()))<x3dom.fields.Eps?1:l)*o._vf.speed,f=new x3dom.fields.SFVec3f(0,0,l*(d+h)/e._height),x3dom.isa(a,x3dom.nodeTypes.OrthoViewpoint)&&a.setZoom(Math.abs(a._fieldOfView[0])-f.z),o._vf.typeParams.length>=6){var v=-o._vf.typeParams[5],g=o._vf.typeParams[4];e._movement.z=Math.min(Math.max(e._movement.z,v),g)}e._movement=e._movement.add(f),c=e.getViewpointMatrix().mult(e._transMat),e._transMat=c.inverse().mult(x3dom.fields.SFMatrix4f.translation(e._movement)).mult(c)}e._isMoving=!0}}},x3dom.DefaultNavigation.prototype.onTouchStart=function(e,t,i){},x3dom.DefaultNavigation.prototype.onTouchDrag=function(e,t,i,s,o){if(e._currentInputType==x3dom.InputTypes.NAVIGATION){var n=this.navi,r=e._scene.getViewpoint(),a=n.getExplorationMode();if("examine"===n.getType()&&0!==a){if(s&&4&a){var d=e._scene._lastMax.subtract(e._scene._lastMin).length();d=((d=Math.min(d,r.getFar()))<x3dom.fields.Eps?1:d)*n._vf.speed,s=s.multiply(d),x3dom.isa(r,x3dom.nodeTypes.OrthoViewpoint)&&(r.setZoom(Math.abs(r._fieldOfView[0])-s.z),s.z=0),e._movement=e._movement.add(s),e._transMat=r.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(e._movement)).mult(r.getViewMatrix())}if(o&&1&a){var h=r.getCenterOfRotation(),l=e.getViewMatrix();l.setTranslate(new x3dom.fields.SFVec3f(0,0,0)),e._rotMat=e._rotMat.mult(x3dom.fields.SFMatrix4f.translation(h)).mult(l.inverse()).mult(o).mult(l).mult(x3dom.fields.SFMatrix4f.translation(h.negate()))}e._isMoving=!0}}},x3dom.DefaultNavigation.prototype.onTouchEnd=function(e,t){},x3dom.DefaultNavigation.prototype.onDoubleClick=function(e,t,i){if((!e._doc._x3dElem.hasAttribute("disableDoubleClick")||"true"!==e._doc._x3dElem.getAttribute("disableDoubleClick"))&&"none"!=e._scene.getNavigationInfo().getType()){var s=e._scene._vf.pickMode.toLowerCase();if("color"!=s&&"texcoord"!=s){var o=e._scene.getViewpoint();o.setCenterOfRotation(e._pick),x3dom.debug.logInfo("New center of Rotation:  "+e._pick);var n=e.getViewMatrix().inverse(),r=n.e3(),a=e._pick,d=n.e1(),h=n.e0().cross(d).normalize(),l=h.dot(e._pick.subtract(r));r=a.addScaled(h,-l),n=x3dom.fields.SFMatrix4f.lookAt(r,a,d),x3dom.debug.logInfo("New camera position:  "+r),e.animateTo(n.inverse(),o)}}},x3dom.TurntableNavigation=function(e){x3dom.DefaultNavigation.call(this,e),this.panAxisX=null,this.panAxisY=null,this.panEnabled=!0},x3dom.TurntableNavigation.prototype=Object.create(x3dom.DefaultNavigation.prototype),x3dom.TurntableNavigation.prototype.constructor=x3dom.TurntableNavigation,x3dom.TurntableNavigation.prototype.onDrag=function(e,t,i,s){var o=this.navi;e._flyMat||this.initTurnTable(e,!1);var n=o.getType(),r=o.getExplorationMode();if("none"!==n&&0!=r){var a,d,h=t-e._lastX,l=i-e._lastY,f=null;if(1&(s&=r))a=2*l*Math.PI/e._height,d=2*h*Math.PI/e._width,this.rotate(e,a,d);else if(2&s){var u=(f=((f=e._scene._lastMax.subtract(e._scene._lastMin).length())<x3dom.fields.Eps?1:f)*o._vf.speed)*(h+l)/e._height;this.zoom(e,u)}else if(4&s&&1==this.panEnabled){var _=-(f=((f=e._scene._lastMax.subtract(e._scene._lastMin).length())<x3dom.fields.Eps?1:f)*o._vf.speed*.75)*h/e._width,c=f*l/e._height;this.pan(e,_,c)}e._isMoving=!0,e._dx=h,e._dy=l,e._lastX=t,e._lastY=i}},x3dom.TurntableNavigation.prototype.pan=function(e,t,i){var s=e._scene.getViewpoint();if(null!=this.target){var o=this.target._x3domNode.getVolume();e._up=e._flyMat.e1(),e._from=e._flyMat.e3();var n=r=(r=e._at).addScaled(this.panAxisY,i);r.y>o.max.y||r.y<o.min.y?n=e._at:e._from=e._from.addScaled(this.panAxisY,i),(r=n.addScaled(this.panAxisX,t)).x>o.max.x||r.x<o.min.x?r=n:e._from=e._from.addScaled(this.panAxisX,t),e._at=r,e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,r,e._up),s.setViewAbsolute(e._flyMat.inverse())}else if(null!=this.panAxisX&&null!=this.panAxisY){e._up=e._flyMat.e1(),e._from=e._flyMat.e3();n=r=(r=e._at).addScaled(this.panAxisY,i);e._from=e._from.addScaled(this.panAxisY,i),r=n.addScaled(this.panAxisX,t),e._from=e._from.addScaled(this.panAxisX,t),e._at=r,e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,r,e._up),s.setViewAbsolute(e._flyMat.inverse())}else{e._up=e._flyMat.e1(),e._from=e._flyMat.e3();var r,a=e._up.cross(e._from).normalize(),d=e._from.cross(a).normalize();n=r=(r=e._at).addScaled(d,i);e._from=e._from.addScaled(d,i),r=n.addScaled(a,t),e._from=e._from.addScaled(a,t),e._at=r,e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,r,e._up),s.setViewAbsolute(e._flyMat.inverse())}},x3dom.TurntableNavigation.prototype.rotate=function(e,t,i){var s=e._scene.getViewpoint();e._flyMat=this.calcOrbit(e,t,i),s.setView(e._flyMat.inverse())},x3dom.TurntableNavigation.prototype.zoom=function(e,t){var i=this.navi,s=e._scene.getViewpoint();e._up=e._flyMat.e1(),e._from=e._flyMat.e3();var o=e._at,n=o.subtract(e._from),r=n.length();n=n.normalize();var a=t;i._vf.typeParams[6]&&(a=Math.min(t,r-i._vf.typeParams[6])),i._vf.typeParams[7]&&(a=Math.max(a,r-i._vf.typeParams[7])),e._from=e._from.addScaled(n,a),e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,o,e._up),s.setViewAbsolute(e._flyMat.inverse())},x3dom.TurntableNavigation.prototype.calcOrbit=function(e,t,i,s){var o=this.navi;e._up=e._flyMat.e1(),e._from=e._flyMat.e3();var n,r,a=e._from.subtract(e._at);1==s?(n=i,r=t):(n=Math.atan2(a.x,a.z),r=Math.atan2(Math.sqrt(a.x*a.x+a.z*a.z),a.y),n-=i,r-=t),r=Math.max(o._vf.typeParams[2],Math.min(o._vf.typeParams[3],r)),o._vf.typeParams[4]<=o._vf.typeParams[5]?n=Math.max(o._vf.typeParams[4],Math.min(o._vf.typeParams[5],n)):i>0&&n<o._vf.typeParams[4]&&n>o._vf.typeParams[5]?n=o._vf.typeParams[4]:i<0&&n>o._vf.typeParams[5]&&n<o._vf.typeParams[4]&&(n=o._vf.typeParams[5]);var d=a.length(),h=d*Math.sin(r);a.x=h*Math.sin(n),a.y=d*Math.cos(r),a.z=h*Math.cos(n),a=e._at.add(a),r-=Math.PI/2;var l=Math.sin(r),f=Math.cos(r),u=new x3dom.fields.SFVec3f(l*Math.sin(n),f,l*Math.cos(n));return u.y<0&&(u=u.negate()),x3dom.fields.SFMatrix4f.lookAt(a,e._at,u)},x3dom.TurntableNavigation.prototype.initTurnTable=function(e,t){var i=this.navi;t=null==t||t;var s=e.getViewMatrix();e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity();var o=e._scene.getViewpoint(),n=x3dom.fields.SFVec3f.copy(o.getCenterOfRotation());e._flyMat=s.inverse(),e._from=o._vf.position,e._at=n,e._up=new x3dom.fields.SFVec3f(0,1,0),e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,e._at,e._up);var r=s.inverse().e3().subtract(e._at),a=Math.atan2(r.x,r.z),d=Math.atan2(Math.sqrt(r.x*r.x+r.z*r.z),r.y);e._flyMat=this.calcOrbit(e,d,a,!0);var h=0;t&&(h=.2/i._vf.speed,this.animateTo(e,e._flyMat.inverse(),s,h)),e.resetNavHelpers()},x3dom.TurntableNavigation.prototype.onMousePress=function(e,t,i,s){e._flyMat||this.initTurnTable(e,!1)},x3dom.TurntableNavigation.prototype.init=function(e,t){this.initTurnTable(e,!0)},x3dom.TurntableNavigation.prototype.resetView=function(e){e._mixer.beginTime=e._lastTS,e._mixer.endTime=e._lastTS+this.navi._vf.transitionTime,e._mixer.setBeginMatrix(e.getViewMatrix());var t=e._scene.getViewpoint();t.resetView(),t=x3dom.fields.SFMatrix4f.lookAt(t._vf.position,t.getCenterOfRotation(),new x3dom.fields.SFVec3f(0,1,0)),e._mixer.setEndMatrix(t.inverse()),this.updateFlyMat(e)},x3dom.TurntableNavigation.prototype.updateFlyMat=function(e,t,i){e._flyMat||this.initTurnTable(e,!1);var s=e.getViewMatrix(),o=t;null!=o&&x3dom.isa(o,x3dom.nodeTypes.X3DViewpointNode)||(o=e._scene.getViewpoint());var n=x3dom.fields.SFVec3f.copy(o.getCenterOfRotation());e._flyMat=s.inverse(),e._from=i?i.inverse().e3():o._vf.position,e._at=n,e._up=new x3dom.fields.SFVec3f(0,1,0),e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,e._at,e._up);var r=s.inverse().e3().subtract(e._at),a=Math.atan2(r.x,r.z),d=Math.atan2(Math.sqrt(r.x*r.x+r.z*r.z),r.y);e._flyMat=this.calcOrbit(e,d,a,!0)},x3dom.TurntableNavigation.prototype.animateTo=function(e,t,i,s){var o,n=this.navi;o=x3dom.isa(t,x3dom.nodeTypes.X3DViewpointNode)?x3dom.fields.SFMatrix4f.lookAt(t._vf.position,t.getCenterOfRotation(),new x3dom.fields.SFVec3f(0,1,0)):t,"teleport"!==n._vf.transitionType[0].toLowerCase()&&0!=s&&"game"!==n.getType()?i&&x3dom.isa(i,x3dom.nodeTypes.X3DViewpointNode)?(i=i.getViewMatrix().mult(i.getCurrentTransform().inverse()).mult(e._transMat).mult(e._rotMat),e._mixer.beginTime=e._lastTS,e._mixer.endTime=arguments.length>=4&&null!=arguments[3]?e._lastTS+s:e._lastTS+n._vf.transitionTime,e._mixer.setBeginMatrix(i),e._mixer.setEndMatrix(o),e._scene.getViewpoint().setViewAbsolute(i)):i?(e._mixer.beginTime=e._lastTS,e._mixer.endTime=arguments.length>=4&&null!=arguments[3]?e._lastTS+s:e._lastTS+n._vf.transitionTime,e._mixer.setBeginMatrix(i),e._mixer.setEndMatrix(o),e._scene.getViewpoint().setViewAbsolute(i)):e._scene.getViewpoint().setViewAbsolute(o):e._scene.getViewpoint().setViewAbsolute(t),e._rotMat=x3dom.fields.SFMatrix4f.identity(),e._transMat=x3dom.fields.SFMatrix4f.identity(),e._movement=new x3dom.fields.SFVec3f(0,0,0),e._needNavigationMatrixUpdate=!0,this.updateFlyMat(e,t,o)},x3dom.TurntableNavigation.prototype.onTouchStart=function(e,t,i){e._numTouches=t.touches.length,e._lastX=t.touches[0].screenX,e._lastY=t.touches[0].screenY},x3dom.TurntableNavigation.prototype.onTouchDrag=function(e,t,i,s,o){if(e._currentInputType==x3dom.InputTypes.NAVIGATION)if(1==t.touches.length){var n=t.touches[0].screenX-e._lastX,r=2*(t.touches[0].screenY-e._lastY)*Math.PI/e._height,a=2*n*Math.PI/e._width;this.rotate(e,r,a),e._lastX=t.touches[0].screenX,e._lastY=t.touches[0].screenY}else t.touches.length>=2&&(1==this.panEnabled&&this.pan(e,4*-s.x,4*-s.y),this.zoom(e,4*s.z))},x3dom.TurntableNavigation.prototype.onTouchEnd=function(e,t,i){2==e._numTouches&&1==t.touches.length&&(e._lastX=t.touches[0].screenX,e._lastY=t.touches[0].screenY),e._numTouches=t.touches.length},x3dom.TurntableNavigation.prototype.setPanTarget=function(e){this.target=e},x3dom.TurntableNavigation.prototype.setPanAxis=function(e,t){this.panAxisX=e,this.panAxisY=t},x3dom.TurntableNavigation.prototype.setPanEnabled=function(e){this.panEnabled=e},x3dom.TurntableNavigation.prototype.onDoubleClick=function(e,t,i){if((!e._doc._x3dElem.hasAttribute("disableDoubleClick")||"true"!==e._doc._x3dElem.getAttribute("disableDoubleClick"))&&"none"!=e._scene.getNavigationInfo().getType()){var s=e._scene._vf.pickMode.toLowerCase();if("color"!=s&&"texcoord"!=s){e._scene.getViewpoint().setCenterOfRotation(e._pick),x3dom.debug.logInfo("New center of Rotation:  "+e._pick);var o=e.getViewMatrix().inverse();e._from=o.e3(),e._up=o.e1(),e._at=e._pick,e._flyMat=x3dom.fields.SFMatrix4f.lookAt(e._from,e._at,e._up);var n=e._from.subtract(e._at),r=Math.atan2(n.x,n.z),a=Math.atan2(Math.sqrt(n.x*n.x+n.z*n.z),n.y);e._flyMat=this.calcOrbit(e,a,r,!0),x3dom.debug.logInfo("New camera position:  "+e._from),this.animateTo(e,e._flyMat.inverse(),e.getViewMatrix())}}},x3dom.WalkNavigation=function(e){x3dom.DefaultNavigation.call(this,e)},x3dom.WalkNavigation.prototype=Object.create(x3dom.DefaultNavigation.prototype),x3dom.WalkNavigation.prototype.constructor=x3dom.WalkNavigation,x3dom.WalkNavigation.prototype.onDrag=function(e,t,i,s){var o=this.navi,n=o.getType();if(0!==o.getExplorationMode()){e._scene.getViewpoint();var r=t-e._lastX,a=i-e._lastY;e._dx=r,e._dy=a,e._lastX=t,e._lastY=i,"walk"!==n&&console.log("#### CHECK: in WalkNavigation but nav. type is not walk !")}},x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,e)}))),x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,(function(e){x3dom.nodeTypes.FontStyle.superClass.call(this,e),this.addField_MFString(e,"family",["SERIF"]),this.addField_SFBool(e,"horizontal",!0),this.addField_MFString(e,"justify",["BEGIN","FIRST"]),this.addField_SFString(e,"language",""),this.addField_SFBool(e,"leftToRight",!0),this.addField_SFFloat(e,"size",1),this.addField_SFFloat(e,"spacing",1),this.addField_SFString(e,"style","PLAIN"),this.addField_SFBool(e,"topToBottom",!0),this.addField_SFFloat(e,"quality",2)}),{fieldChanged:function(e){"family"!=e&&"horizontal"!=e&&"justify"!=e&&"language"!=e&&"leftToRight"!=e&&"size"!=e&&"spacing"!=e&&"style"!=e&&"topToBottom"!=e||this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){e.setAllDirty()}))}))}})),x3dom.nodeTypes.FontStyle.defaultNode=function(){return x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged()),x3dom.nodeTypes.FontStyle._defaultNode},x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.Text.superClass.call(this,e),this.addField_MFString(e,"string",[]),this.addField_MFFloat(e,"length",[]),this.addField_SFFloat(e,"maxExtent",0),this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode),this._mesh._positions[0]=[0,0,0,1,0,0,1,1,0,0,1,0],this._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1],this._mesh._texCoords[0]=[0,0,1,0,1,1,0,1],this._mesh._colors[0]=[],this._mesh._indices[0]=[0,1,2,2,3,0],this._mesh._invalidate=!0,this._mesh._numFaces=2,this._mesh._numCoords=4}),{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode()),this.invalidateVolume()},fieldChanged:function(e){"string"!=e&&"length"!=e&&"maxExtent"!=e||(this.invalidateVolume(),this._parentNodes.forEach((function(e){e.setAllDirty()})))},validateGLObject:function(){this._parentNodes.forEach((function(e){e._dirty.texture=!1})),this._nameSpace.doc.needRender=!0}})),x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,e)}))),x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,(function(e){x3dom.nodeTypes.Sound.superClass.call(this,e),this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)}),{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{this._xmlNode.childNodes.forEach((function(e){if(1===e.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+e.nodeName+"&gt; tag."),"audio"===e.localName.toLowerCase())){var t=e.getAttribute("loop");t=!!t&&"loop"===t.toLowerCase();var i=e.cloneNode(!1);e.parentNode.removeChild(e),e=null,"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(i);i.addEventListener("canplaythrough",(function(){i.play()}),!0),i.addEventListener("ended",(function(){t&&i.play()}),!0)}}))}catch(e){x3dom.debug.logException(e)}}}})),x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,(function(e){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,e)}))),x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,(function(e){x3dom.nodeTypes.AudioClip.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"enabled",!1),this.addField_SFBool(e,"loop",!1),this._audio=document.createElement("audio"),"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio),this._sources=[]}),{nodeChanged:function(){this._createSources=function(){this._sources=[];for(var e=0;e<this._vf.url.length;e++){var t=this._nameSpace.getURL(this._vf.url[e]);x3dom.debug.logInfo("Adding sound file: "+t);var i=document.createElement("source");i.setAttribute("src",t),this._sources.push(i),this._audio.appendChild(i)}};var e=this,t=0;this._startAudio=function(){!0===e._vf.enabled&&e._audio.play().then((function(e){clearTimeout(t)})).catch((function(i){x3dom.debug.logError(i),t=setTimeout(e._startAudio,100)}))},this._stopAudio=function(){e._audio.pause()},this._audioEnded=function(){!0===e._vf.enabled&&!0===e._vf.loop&&e._startAudio()};this._audio.addEventListener("canplaythrough",this._startAudio,!0),this._audio.addEventListener("ended",this._audioEnded,!0),this._audio.addEventListener("error",(function(e){x3dom.debug.logWarning("MediaEvent error:"+e)}),!0),this._audio.addEventListener("pause",this._audioEnded,!0),this._createSources()},fieldChanged:function(e){if("enabled"===e)!0===this._vf.enabled?this._startAudio():this._stopAudio();else if("loop"===e);else if("url"===e){for(this._stopAudio();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(var t=0;t<this._vf.url.length;t++){var i=this._nameSpace.getURL(this._vf.url[t]);x3dom.debug.logInfo("Adding sound file: "+i);var s=document.createElement("source");s.setAttribute("src",i),this._audio.appendChild(s)}this._audio.load()}},shutdown:function(){if(this._audio){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);document.body.removeChild(this._audio),this._audio=null}}})),x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,e)}),{texTransformMatrix:function(){return this._trafo}})),x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,(function(e){x3dom.nodeTypes.TextureTransform.superClass.call(this,e),this.addField_SFVec2f(e,"center",0,0),this.addField_SFFloat(e,"rotation",0),this.addField_SFVec2f(e,"scale",1,1),this.addField_SFVec2f(e,"translation",0,0),this._calcTrafo()}),{fieldChanged:function(e){"center"!=e&&"rotation"!=e&&"scale"!=e&&"translation"!=e||this._calcTrafo()},_calcTrafo:function(){var e=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,0),t=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),i=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),s=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(e).mult(x3dom.fields.SFMatrix4f.scale(s)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(t.add(i)))}})),x3dom.registerNodeType("MatrixTextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,(function(e){x3dom.nodeTypes.MatrixTextureTransform.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._trafo=this._vf.matrix.transpose()}),{fieldChanged:function(e){"matrix"==e&&(this._trafo=this._vf.matrix.transpose())}})),x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.TextureProperties.superClass.call(this,e),this.addField_SFFloat(e,"anisotropicDegree",1),this.addField_SFColorRGBA(e,"borderColor",0,0,0,0),this.addField_SFInt32(e,"borderWidth",0),this.addField_SFString(e,"boundaryModeS","REPEAT"),this.addField_SFString(e,"boundaryModeT","REPEAT"),this.addField_SFString(e,"boundaryModeR","REPEAT"),this.addField_SFString(e,"magnificationFilter","FASTEST"),this.addField_SFString(e,"minificationFilter","FASTEST"),this.addField_SFString(e,"textureCompression","FASTEST"),this.addField_SFFloat(e,"texturePriority",0),this.addField_SFBool(e,"generateMipMaps",!1)}),{fieldChanged:function(e){this._vf.hasOwnProperty(e)&&(this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){e._dirty.texture=!0}))}))})),this._nameSpace.doc.needRender=!0)}})),x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,e),this.addField_SFInt32(e,"origChannelCount",0),this.addField_MFString(e,"url",[]),this.addField_SFBool(e,"repeatS",!0),this.addField_SFBool(e,"repeatT",!0),this.addField_SFBool(e,"scale",!0),this.addField_SFString(e,"crossOrigin",""),this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties),this.addField_SFBool(e,"flipY",!1),this.addField_SFInt32(e,"channel",0),this._needPerFrameUpdate=!1,this._isCanvas=!1,this._type="diffuseMap",this._blending=1==this._vf.origChannelCount||2==this._vf.origChannelCount}),{invalidateGLObject:function(){this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.texture=!0)}))}))}))})),this._nameSpace.doc.needRender=!0},validateGLObject:function(){this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!1:e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!1:e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)&&(e._dirty.texture=!1)}))}))}))})),this._nameSpace.doc.needRender=!0},parentAdded:function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.Shape)?e._dirty.texture=!0:e._parentNodes.forEach((function(e){e._dirty.texture=!0}))}))},parentRemoved:function(e){e._parentNodes.forEach((function(e){x3dom.isa(e,x3dom.nodeTypes.X3DShapeNode)?e._dirty.texture=!0:e._parentNodes.forEach((function(e){e._dirty.texture=!0}))})),x3dom.nodeTypes.X3DAppearanceChildNode.prototype.parentRemoved.call(this,e)},fieldChanged:function(e){if("url"==e||"origChannelCount"==e||"repeatS"==e||"repeatT"==e||"scale"==e||"crossOrigin"==e||"image"==e){var t=this;t._blending=1==t._vf.origChannelCount||2==t._vf.origChannelCount,this._parentNodes.forEach((function(e){if(x3dom.isa(e,x3dom.nodeTypes.X3DAppearanceNode))e.nodeChanged();else if(x3dom.isa(e,x3dom.nodeTypes.MultiTexture))e._parentNodes.forEach((function(e){e.nodeChanged()}));else if(x3dom.isa(e,x3dom.nodeTypes.ComposedCubeMapTexture))e._parentNodes.forEach((function(e){e.nodeChanged()}));else if(x3dom.isa(e,x3dom.nodeTypes.PhysicalMaterial))e._parentNodes.forEach((function(e){e.nodeChanged()}));else if(void 0!==x3dom.nodeTypes.X3DVolumeDataNode)if(x3dom.isa(e,x3dom.nodeTypes.X3DVolumeRenderStyleNode)){if(t._xmlNode&&t._xmlNode.hasAttribute("containerField"))if(e._volumeDataParent)e._volumeDataParent._dirty.texture=!0;else{for(var i=e._parentNodes[0];!x3dom.isa(i,x3dom.nodeTypes.X3DVolumeDataNode)&&x3dom.isa(i,x3dom.nodeTypes.X3DNode);)i=i._parentNodes[0];x3dom.isa(i,x3dom.nodeTypes.X3DNode)&&(i._dirty.texture=!0)}}else x3dom.isa(e,x3dom.nodeTypes.X3DVolumeDataNode)&&t._xmlNode&&t._xmlNode.hasAttribute("containerField")&&(e._dirty.texture=!0)}))}},getTexture:function(e){return 0===e?this:null},size:function(){return 1},setOrigChannelCount:function(e){this._vf.origChannelCount=e,this.fieldChanged("origChannelCount")},getOrigChannelCount:function(){return this._vf.origChannelCount}})),x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.MultiTexture.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)}),{getTexture:function(e){return e>=0&&e<this._cf.texture.nodes.length?this._cf.texture.nodes[e]:null},getTextures:function(){return this._cf.texture.nodes},size:function(){return this._cf.texture.nodes.length}})),x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.Texture.superClass.call(this,e),this.addField_SFBool(e,"hideChildren",!0),this._video=null,this._intervalID=0,this._canvas=null}),{nodeChanged:function(){if(!(this._vf.url.length&&this._vf.url[0].length||!this._xmlNode)){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var e=this;try{this._xmlNode.childNodes.forEach((function(t){if(1===t.nodeType){var i=t.getAttribute("src");if(i){if(e._vf.url.push(i),x3dom.debug.logInfo(e._vf.url[e._vf.url.length-1]),"video"===t.localName.toLowerCase())e._needPerFrameUpdate=!0,e._video=document.createElement("video"),e._video.setAttribute("preload","auto"),e._video.setAttribute("muted","muted"),document.getElementsByTagName("body")[0].appendChild(e._video),e._video.style.display="none",e._video.style.visibility="hidden"}else"canvas"===t.localName.toLowerCase()&&(e._needPerFrameUpdate=!0,e._isCanvas=!0,e._canvas=t);t.style&&e._vf.hideChildren&&(t.style.display="none",t.style.visibility="hidden"),x3dom.debug.logInfo("### Found &lt;"+t.nodeName+"&gt; tag.")}}))}catch(e){x3dom.debug.logException(e)}}},shutdown:function(){if(this._video){for(this._video.pause();this._video.hasChildNodes();)this._video.removeChild(this._video.firstChild);document.body.removeChild(this._video),this._video=null}}})),x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.RenderedTexture.superClass.call(this,e),e?e.doc._nodeBag.renderTextures.push(this):x3dom.debug.logWarning("RenderedTexture: No runtime context found!"),this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode),this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode),this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode),this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode),this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode),this.addField_MFInt32(e,"dimensions",[128,128,4]),this.addField_SFString(e,"update","NONE"),this.addField_SFBool(e,"showNormals",!1),this.addField_SFString(e,"stereoMode","NONE"),this.addField_SFFloat(e,"interpupillaryDistance",.064),this.addField_SFFloat(e,"eyeToScreenDistance",.041),this.addField_SFFloat(e,"vScreenSize",.07074),this.addField_SFVec3f(e,"lensCenter",.15197,0,0),this.addField_SFBool(e,"depthMap",!1),this.addField_SFBool(e,"oculusRiftVersion",1),x3dom.debug.assert(this._vf.dimensions.length>=3,"RenderedTexture.dimensions requires at least 3 entries."),this._clearParents=!0,this._needRenderUpdate=!0,this.checkDepthTextureSupport=function(){this._vf.depthMap&&null===x3dom.caps.DEPTH_TEXTURE&&x3dom.debug.logWarning("RenderedTexture Node: depth texture extension not supported")},this.checkDepthTextureSupport()}),{nodeChanged:function(){this._clearParents=!0,this._needRenderUpdate=!0},fieldChanged:function(e){switch(e){case"excludeNodes":this._clearParents=!0;break;case"update":"NEXT_FRAME_ONLY"!=this._vf.update.toUpperCase()&&"ALWAYS"!=this._vf.update.toUpperCase()||(this._needRenderUpdate=!0);break;case"depthMap":this.checkDepthTextureSupport(),this._x3domTexture.updateTexture(),this._needRenderUpdate=!0}},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var e=this;this._cf.excludeNodes.nodes.forEach((function(t){for(var i=0,s=t._parentNodes.length;i<s;i++)t._parentNodes[i]===e&&(t._parentNodes.splice(i,1),t.parentRemoved(e))})),this._clearParents=!1}var t=this._cf.scene.node,i=this._nameSpace.doc._scene,s=i.getViewpoint(),o=this._cf.viewpoint.node,n=null;if(null===o||o===s)n=this._nameSpace.doc._viewarea.getViewMatrix();else if(t&&t!==i)n=o.getViewMatrix();else{var r=o.getCurrentTransform();n=o.getViewMatrix().mult(r.inverse())}var a=this._vf.stereoMode.toUpperCase();if("NONE"!=a){var d=this._vf.interpupillaryDistance/2;"RIGHT_EYE"==a&&(d=-d),n=new x3dom.fields.SFMatrix4f(1,0,0,d,0,1,0,0,0,0,1,0,0,0,0,1).mult(n)}return n},getProjectionMatrix:function(){var e,t=this._nameSpace.doc,i=t._scene.getViewpoint(),s=this._cf.viewpoint.node,o=null,n=this._vf.dimensions[0],r=this._vf.dimensions[1],a=this._vf.stereoMode.toUpperCase(),d="NONE"!=a;if(null===s||s===i?(o=x3dom.fields.SFMatrix4f.copy(t._viewarea.getProjectionMatrix()),d?(e=2*Math.atan(this._vf.vScreenSize/(2*this._vf.eyeToScreenDistance)),e=1/Math.tan(e/2)):e=1/Math.tan(i._vf.fieldOfView/2),o._00=e/(n/r),o._11=e):o=s.getProjectionMatrix(n/r),d){var h=this._vf.lensCenter.copy();"RIGHT_EYE"==a&&(h.x=-h.x),o=new x3dom.fields.SFMatrix4f(1,0,0,h.x,0,1,0,h.y,0,0,1,h.z,0,0,0,1).mult(o)}return o},getWCtoCCMatrix:function(){var e=this.getViewMatrix();return this.getProjectionMatrix().mult(e)},parentRemoved:function(e){if(0===this._parentNodes.length){var t=this.findX3DDoc();if(t)for(var i=0,s=t._nodeBag.renderTextures.length;i<s;i++)t._nodeBag.renderTextures[i]===this&&t._nodeBag.renderTextures.splice(i,1)}this._cf.scene.node&&this._cf.scene.node.parentRemoved(this),x3dom.nodeTypes.X3DTextureNode.prototype.parentRemoved.call(this,e)},requirePingPong:function(){return!1}})),x3dom.registerNodeType("RefinementTexture","Texturing",defineClass(x3dom.nodeTypes.RenderedTexture,(function(e){if(x3dom.nodeTypes.RefinementTexture.superClass.call(this,e),this.addField_SFString(e,"stamp0","gpuii/stamps/0.gif"),this.addField_SFString(e,"stamp1","gpuii/stamps/1.gif"),this.addField_SFBool(e,"autoRefinement",!0),this.addField_SFString(e,"format","jpg"),this.addField_SFInt32(e,"iterations",7),this.addField_SFInt32(e,"maxLevel",this._vf.iterations),this._vf.iterations%2==0){var t=this._vf.stamp0;this._vf.stamp0=this._vf.stamp1,this._vf.stamp1=t}this._vf.iterations=this._vf.iterations>11?11:this._vf.iterations,this._vf.iterations=this._vf.iterations<3?3:this._vf.iterations,this._vf.maxLevel=this._vf.maxLevel>11?11:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel<3?3:this._vf.maxLevel,this._vf.maxLevel=this._vf.maxLevel>this._vf.iterations?this._vf.iterations:this._vf.maxLevel;var i=[{x:4,y:8},{x:8,y:8},{x:8,y:16},{x:16,y:16},{x:16,y:32},{x:32,y:32},{x:32,y:64},{x:64,y:64},{x:64,y:128}];this._repeat=new x3dom.fields.SFVec2f(this._vf.dimensions[0]/i[this._vf.iterations-3].x,this._vf.dimensions[1]/i[this._vf.iterations-3].y),this._renderedImage=0,this._currLoadLevel=0,this._loadLevel=1}),{nextLevel:function(){this._loadLevel<this._vf.maxLevel&&(this._loadLevel++,this._nameSpace.doc.needRender=!0)},requirePingPong:function(){return this._currLoadLevel<=this._vf.maxLevel&&this._renderedImage<this._loadLevel}})),x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.PixelTexture.superClass.call(this,e),this.addField_SFImage(e,"image",0,0,0)}),{getWidth:function(){return this._vf.image.width},getHeight:function(){return this._vf.image.height},getComponents:function(){return this._vf.image.comp},setPixel:function(e,t,i,s){s=null==s||s,this._x3domTexture?(this._x3domTexture.setPixel(e,t,[255*i.r,255*i.g,255*i.b,255*i.a],s),this._vf.image.setPixel(e,t,i)):(this._vf.image.setPixel(e,t,i),s&&this.invalidateGLObject())},getPixel:function(e,t){return this._vf.image.getPixel(e,t)},setPixels:function(e,t){t=null==t||t,this._vf.image.setPixels(e),t&&this.invalidateGLObject()},getPixels:function(){return this._vf.image.getPixels()}})),x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,(function(e){x3dom.nodeTypes.ImageTexture.superClass.call(this,e)}))),x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,(function(e){x3dom.nodeTypes.MovieTexture.superClass.call(this,e),this.addField_SFBool(e,"loop",!1),this.addField_SFFloat(e,"speed",1),this.addField_SFTime(e,"pauseTime",0),this.addField_SFFloat(e,"pitch",1),this.addField_SFTime(e,"resumeTime",0),this.addField_SFTime(e,"startTime",0),this.addField_SFTime(e,"stopTime",0)}))),x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,e)}),{fieldChanged:function(e){"texCoord"!==e&&"point"!==e&&"parameter"!==e&&"mode"!==e||this._parentNodes.forEach((function(e){e.fieldChanged("texCoord")}))},parentAdded:function(e){e._mesh&&e._cf.texCoord.node!==this&&e.fieldChanged("texCoord")}})),x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,(function(e){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,e),this.addField_MFVec2f(e,"point",[])}))),x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,(function(e){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,e),this.addField_SFString(e,"mode","SPHERE"),this.addField_MFFloat(e,"parameter",[])}))),x3dom.registerNodeType("MultiTextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,(function(e){x3dom.nodeTypes.MultiTextureCoordinate.superClass.call(this,e),this.addField_MFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)}))),x3dom.registerNodeType("ImageTextureAtlas","Texturing",defineClass(x3dom.nodeTypes.Texture,(function(e){x3dom.nodeTypes.ImageTextureAtlas.superClass.call(this,e),this.addField_SFInt32(e,"numberOfSlices",0),this.addField_SFInt32(e,"slicesOverX",0),this.addField_SFInt32(e,"slicesOverY",0)}))),x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,e)}),{getTexUrl:function(){return[]},getTexSize:function(){return-1}})),x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,(function(e){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,e),this.addField_SFNode("back",x3dom.nodeTypes.Texture),this.addField_SFNode("front",x3dom.nodeTypes.Texture),this.addField_SFNode("bottom",x3dom.nodeTypes.Texture),this.addField_SFNode("top",x3dom.nodeTypes.Texture),this.addField_SFNode("left",x3dom.nodeTypes.Texture),this.addField_SFNode("right",x3dom.nodeTypes.Texture),this._type="environmentMap"}),{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}})),x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,(function(e){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,e),this.addField_SFInt32(e,"size",128),this.addField_SFString(e,"update","NONE"),this._type="cubeMap",x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")}),{getTexSize:function(){return this._vf.size}})),x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,(function(e){x3dom.nodeTypes.Uniform.superClass.call(this,e)}))),x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,e),this.addField_SFInt32(e,"textureCoordinatesId",0),this.addField_SFString(e,"channelMask","DEFAULT"),this.addField_SFBool(e,"isSRGB",!1),this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)}))),x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,(function(e){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,e),this.addField_SFString(e,"language","")}))),x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,(function(e){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,e),this.addField_SFInt32(e,"tangentTextureCoordinatesId",-1),this.addField_SFInt32(e,"binormalTextureCoordinatesId",-1),this.addField_SFVec3f(e,"emissiveFactor",0,0,0),this.addField_SFInt32(e,"emissiveTextureId",-1),this.addField_SFInt32(e,"emissiveTextureCoordinatesId",0),this.addField_SFString(e,"emissiveTextureChannelMask","rgb"),this.addField_SFVec3f(e,"ambientFactor",.2,.2,.2),this.addField_SFInt32(e,"ambientTextureId",-1),this.addField_SFInt32(e,"ambientTextureCoordinatesId",0),this.addField_SFString(e,"ambientTextureChannelMask","rgb"),this.addField_SFVec3f(e,"diffuseFactor",.8,.8,.8),this.addField_SFInt32(e,"diffuseTextureId",-1),this.addField_SFInt32(e,"diffuseTextureCoordinatesId",0),this.addField_SFString(e,"diffuseTextureChannelMask","rgb"),this.addField_SFVec3f(e,"specularFactor",0,0,0),this.addField_SFInt32(e,"specularTextureId",-1),this.addField_SFInt32(e,"specularTextureCoordinatesId",0),this.addField_SFString(e,"specularTextureChannelMask","rgb"),this.addField_SFFloat(e,"shininessFactor",.2),this.addField_SFInt32(e,"shininessTextureId",-1),this.addField_SFInt32(e,"shininessTextureCoordinatesId",0),this.addField_SFString(e,"shininessTextureChannelMask","a"),this.addField_SFString(e,"normalFormat","UNORM"),this.addField_SFString(e,"normalSpace","TANGENT"),this.addField_SFInt32(e,"normalTextureId",-1),this.addField_SFInt32(e,"normalTextureCoordinatesId",0),this.addField_SFString(e,"normalTextureChannelMask","rgb"),this.addField_SFVec3f(e,"reflectionFactor",0,0,0),this.addField_SFInt32(e,"reflectionTextureId",-1),this.addField_SFInt32(e,"reflectionTextureCoordinatesId",0),this.addField_SFString(e,"reflectionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"transmissionFactor",0,0,0),this.addField_SFInt32(e,"transmissionTextureId",-1),this.addField_SFInt32(e,"transmissionTextureCoordinatesId",0),this.addField_SFString(e,"transmissionTextureChannelMask","rgb"),this.addField_SFVec3f(e,"environmentFactor",1,1,1),this.addField_SFInt32(e,"environmentTextureId",-1),this.addField_SFInt32(e,"environmentTextureCoordinatesId",0),this.addField_SFString(e,"environmentTextureChannelMask","rgb"),this.addField_SFFloat(e,"relativeIndexOfRefraction",1),this.addField_SFFloat(e,"fresnelBlend",0),this.addField_SFString(e,"displacementAxis","y"),this.addField_SFFloat(e,"displacementFactor",255),this.addField_SFInt32(e,"displacementTextureId",-1),this.addField_SFInt32(e,"displacementTextureCoordinatesId",0),this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("displacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFNode("diffuseDisplacementTexture",x3dom.nodeTypes.X3DTextureNode),this.addField_SFVec3f(e,"normalScale",2,2,2),this.addField_SFVec3f(e,"normalBias",-1,-1,1),this.addField_SFFloat(e,"alphaFactor",1),this.addField_SFBool(e,"invertAlphaTexture",!1),this.addField_SFInt32(e,"alphaTextureId",-1),this.addField_SFInt32(e,"alphaTextureCoordinatesId",0),this.addField_SFString(e,"alphaTextureChannelMask","a"),this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode),this._dirty={}}),{getDiffuseMap:function(){return this._cf.diffuseTexture.node?x3dom.isa(this._cf.diffuseTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseTexture.node._cf.texture.node._type="diffuseMap",this._cf.diffuseTexture.node._cf.texture.node):(this._cf.diffuseTexture.node._type="diffuseMap",this._cf.diffuseTexture.node):null},getEnvironmentMap:function(){return this._cf.environmentTexture.node?x3dom.isa(this._cf.environmentTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.environmentTexture.node._cf.texture.node._type="environmentMap",this._cf.environmentTexture.node._cf.texture.node):(this._cf.environmentTexture.node._type="environmentMap",this._cf.environmentTexture.node):null},getNormalMap:function(){return this._cf.normalTexture.node?x3dom.isa(this._cf.normalTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.normalTexture.node._cf.texture.node._type="normalMap",this._cf.normalTexture.node._cf.texture.node):(this._cf.normalTexture.node._type="normalMap",this._cf.normalTexture.node):null},getAmbientMap:function(){return this._cf.ambientTexture.node?x3dom.isa(this._cf.ambientTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.ambientTexture.node._cf.texture.node._type="ambientMap",this._cf.ambientTexture.node._cf.texture.node):(this._cf.ambientTexture.node._type="ambientMap",this._cf.ambientTexture.node):null},getSpecularMap:function(){return this._cf.specularTexture.node?x3dom.isa(this._cf.specularTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.specularTexture.node._cf.texture.node._type="specularMap",this._cf.specularTexture.node._cf.texture.node):(this._cf.specularTexture.node._type="specularMap",this._cf.specularTexture.node):null},getShininessMap:function(){return this._cf.shininessTexture.node?x3dom.isa(this._cf.shininessTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.shininessTexture.node._cf.texture.node._type="shininessMap",this._cf.shininessTexture.node._cf.texture.node):(this._cf.shininessTexture.node._type="shininessMap",this._cf.shininessTexture.node):null},getAlphaMap:function(){return this._cf.alphaTexture.node?x3dom.isa(this._cf.alphaTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.alphaTexture.node._cf.texture.node._type="alphaMap",this._cf.alphaTexture.node._cf.texture.node):(this._cf.alphaTexture.node._type="alphaMap",this._cf.alphaTexture.node):null},getDisplacementMap:function(){return this._cf.displacementTexture.node?x3dom.isa(this._cf.displacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.displacementTexture.node._cf.texture.node._type="displacementMap",this._cf.displacementTexture.node._cf.texture.node):(this._cf.displacementTexture.node._type="displacementMap",this._cf.displacementTexture.node):null},getDiffuseDisplacementMap:function(){return this._cf.diffuseDisplacementTexture.node?x3dom.isa(this._cf.diffuseDisplacementTexture.node,x3dom.nodeTypes.SurfaceShaderTexture)?(this._cf.diffuseDisplacementTexture.node._cf.texture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node._cf.texture.node):(this._cf.diffuseDisplacementTexture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node):null},getTextures:function(){var e=[],t=this.getDiffuseMap();t&&e.push(t);var i=this.getNormalMap();i&&e.push(i);var s=this.getSpecularMap();s&&e.push(s);var o=this.getShininessMap();o&&e.push(o);var n=this.getEnvironmentMap();n&&e.push(n);var r=this.getDisplacementMap();r&&e.push(r);var a=this.getDiffuseDisplacementMap();return a&&e.push(a),e},needTexcoords:function(){return!!(this.getDiffuseMap()||this.getNormalMap()||this.getSpecularMap()||this.getShininessMap()||this.getDisplacementMap()||this.getDiffuseDisplacementMap()||this.getEnvironmentMap())}})),x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,(function(e){x3dom.nodeTypes.ComposedShader.superClass.call(this,e),this.addField_MFNode("fields",x3dom.nodeTypes.Field),this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart),this._vertex=null,this._fragment=null,this._id=null,x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown||(x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n(see also <a href='http://x3dom.org/x3dom/doc/help/composedShader.html'>http://x3dom.org/x3dom/doc/help/composedShader.html</a>)\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n"),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!0)}),{nodeChanged:function(){var e,t=this._cf.parts.nodes.length;for(e=0;e<t;e++)"vertex"==this._cf.parts.nodes[e]._vf.type.toLowerCase()?(this._vertex=this._cf.parts.nodes[e],this._id=this._cf.parts.nodes[e]._id):"fragment"==this._cf.parts.nodes[e]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[e],this._id+=" - "+this._cf.parts.nodes[e]._id);var i={};for(t=this._cf.fields.nodes.length,e=0;e<t;e++){var s=this._cf.fields.nodes[e]._vf.name;i.xmlNode=this._cf.fields.nodes[e]._xmlNode;var o=!1;void 0!==i.xmlNode&&null!==i.xmlNode||(i.xmlNode=document.createElement("field"),o=!0),i.xmlNode.setAttribute(s,this._cf.fields.nodes[e]._vf.value),this["addField_"+this._cf.fields.nodes[e]._vf.type](i,s),o&&(i.xmlNode=null)}this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){e._cleanupGLObjects&&e._cleanupGLObjects(),e.setAllDirty()}))}))},fieldChanged:function(e){var t,i=this._cf.fields.nodes.length;for(t=0;t<i;t++){var s=this._cf.fields.nodes[t]._vf.name;if(s===e){var o=this._cf.fields.nodes[t]._vf.value;try{this._vf[s].setValueByStr(o)}catch(e){try{switch((typeof this._vf[s]).toString()){case"number":this._vf[s]=+o;break;case"boolean":this._vf[s]="true"===o.toLowerCase();break;case"string":this._vf[s]=o}}catch(e){x3dom.debug.logError("setValueByStr() NYI for "+typeof this._vf[s])}}break}}if("url"===e){for(t=0;t<i;t++)"vertex"==this._cf.parts.nodes[t]._vf.type.toLowerCase()?(this._vertex=this._cf.parts.nodes[t],this._id=this._cf.parts.nodes[t]._id):"fragment"==this._cf.parts.nodes[t]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[t],this._id+=" - "+this._cf.parts.nodes[t]._id);this._parentNodes.forEach((function(e){e._parentNodes.forEach((function(e){e._cleanupGLObjects&&e._cleanupGLObjects(),e.setAllDirty()}))}))}},parentAdded:function(e){e.nodeChanged()}})),x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!1,x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.ShaderPart.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_SFString(e,"type","VERTEX"),this._id=e&&e.xmlNode&&""!=e.xmlNode.id?e.xmlNode.id:++x3dom.nodeTypes.Shape.shaderPartID,x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase(),"Unknown shader part type!")}),{nodeChanged:function(){var e={};if(e.xmlNode=this._xmlNode,void 0!==e.xmlNode&&null!==e.xmlNode){var t=this;if(t._vf.url.length&&-1==t._vf.url[0].indexOf("\n")){var i=new XMLHttpRequest,s=t._nameSpace.getURL(t._vf.url[0]),o=t._id;t._id="default",t._vf.url=new x3dom.fields.MFString([this._getDefaultShader()]),i.open("GET",s,!1),i.onload=function(){t._vf.url=new x3dom.fields.MFString([]),t._vf.url.push(i.response),t._id=o,t.fieldChanged("url")},i.onerror=function(){x3dom.debug.logError("Could not load file '"+t._vf.url[0]+"'.")},x3dom.RequestManager.addRequest(i)}else{t._vf.url.length&&(t._vf.url=new x3dom.fields.MFString([]));try{t._vf.url.push(e.xmlNode.childNodes[1].nodeValue),e.xmlNode.removeChild(e.xmlNode.childNodes[1])}catch(i){e.xmlNode.childNodes.forEach((function(e){3===e.nodeType?t._vf.url.push(e.nodeValue):4===e.nodeType&&t._vf.url.push(e.data),e.parentNode.removeChild(e)}))}}}this._parentNodes.forEach((function(e){e.nodeChanged()}))},fieldChanged:function(e){"url"===e&&this._parentNodes.forEach((function(e){e.fieldChanged("url")}))},parentAdded:function(e){e.nodeChanged()},_getDefaultShader:function(){return"vertex"==this._vf.type.toLowerCase()?"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n":"fragment"==this._vf.type.toLowerCase()?"precision highp float;\nvoid main(void) {\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n":void 0}})),x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,e),this.addField_SFString(e,"name","")}))),x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,(function(e){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,e),this.addField_SFInt32(e,"numComponents",4),this.addField_MFFloat(e,"value",[])}))),x3dom.registerNodeType("X3DSpatialGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.X3DSpatialGeometryNode.superClass.call(this,e)}))),x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Plane.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFVec3f(e,"center",0,0,0),this.addField_MFString(e,"primType",["TRIANGLES"]),this._vf.primType.length&&(this._mesh._primType=this._vf.primType[0]);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y,n=this._vf.ccw,r=["Plane",t,i,s,o,this._vf.center.x,this._vf.center.y,this._vf.center.z,n].join("-");if(e&&this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{var a=0,d=0,h=t/s,l=i/o,f=n?1:-1;for(t/=2,i/=2,d=0;d<=o;d++)for(a=0;a<=s;a++)this._mesh._positions[0].push(this._vf.center.x+a*h-t),this._mesh._positions[0].push(this._vf.center.y+d*l-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*f),this._mesh._texCoords[0].push(a/s),this._mesh._texCoords[0].push(d/o);for(d=1;d<=o;d++)for(a=0;a<s;a++)this._mesh._indices[0].push((d-1)*(s+1)+a),this._mesh._indices[0].push((d-1)*(s+1)+a+1),this._mesh._indices[0].push(d*(s+1)+a),this._mesh._indices[0].push(d*(s+1)+a),this._mesh._indices[0].push((d-1)*(s+1)+a+1),this._mesh._indices[0].push(d*(s+1)+a+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}}),{fieldChanged:function(e){if("size"==e||"center"==e){this._mesh._positions[0]=[];var t=this._vf.size.x,i=this._vf.size.y,s=0,o=0,n=t/(a=this._vf.subdivision.x),r=i/(d=this._vf.subdivision.y);for(t/=2,i/=2,o=0;o<=d;o++)for(s=0;s<=a;s++)this._mesh._positions[0].push(this._vf.center.x+s*n-t),this._mesh._positions[0].push(this._vf.center.y+o*r-i),this._mesh._positions[0].push(this._vf.center.z);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else if("subdivision"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];t=this._vf.size.x,i=this._vf.size.y;var a=this._vf.subdivision.x,d=this._vf.subdivision.y,h=this._vf.ccw?1:-1;s=0,o=0,n=t/a,r=i/d;for(t/=2,i/=2,o=0;o<=d;o++)for(s=0;s<=a;s++)this._mesh._positions[0].push(this._vf.center.x+s*n-t),this._mesh._positions[0].push(this._vf.center.y+o*r-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*h),this._mesh._texCoords[0].push(s/a),this._mesh._texCoords[0].push(o/d);for(o=1;o<=d;o++)for(s=0;s<a;s++)this._mesh._indices[0].push((o-1)*(a+1)+s),this._mesh._indices[0].push((o-1)*(a+1)+s+1),this._mesh._indices[0].push(o*(a+1)+s),this._mesh._indices[0].push(o*(a+1)+s),this._mesh._indices[0].push((o-1)*(a+1)+s+1),this._mesh._indices[0].push(o*(a+1)+s+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()}))}}})),x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Box.superClass.call(this,e),this.addField_SFVec3f(e,"size",2,2,2),this.addField_SFBool(e,"hasHelperColors",!1);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.size.z,o=this._vf.ccw,n=["Box",t,i,s,o].join("-");this._vf.useGeoCache&&void 0!==x3dom.geoCache[n]?this._mesh=x3dom.geoCache[n]:(t/=2,i/=2,s/=2,this._mesh._positions[0]=[-t,-i,-s,-t,i,-s,t,i,-s,t,-i,-s,-t,-i,s,-t,i,s,t,i,s,t,-i,s,-t,-i,-s,-t,-i,s,-t,i,s,-t,i,-s,t,-i,-s,t,-i,s,t,i,s,t,i,-s,-t,i,-s,-t,i,s,t,i,s,t,i,-s,-t,-i,-s,-t,-i,s,t,-i,s,t,-i,-s],this._mesh._normals[0]=o?[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._vf.hasHelperColors&&(this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]),this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[n]=this._mesh)}),{fieldChanged:function(e){if("size"===e){var t=this._vf.size.x/2,i=this._vf.size.y/2,s=this._vf.size.z/2;this._mesh._positions[0]=[-t,-i,-s,-t,i,-s,t,i,-s,t,-i,-s,-t,-i,s,-t,i,s,t,i,s,t,-i,s,-t,-i,-s,-t,-i,s,-t,i,s,-t,i,-s,t,-i,-s,t,-i,s,t,i,s,t,i,-s,-t,i,-s,-t,i,s,t,i,s,t,i,-s,-t,-i,-s,-t,-i,s,t,-i,s,t,-i,-s],this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else"hasHelperColors"===e&&(this._vf.hasHelperColors?this._mesh._colors[0]=[0,0,0,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0,1,0,0,1,0,1,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,0,1,1,0,0]:this._mesh._colors[0]=[],this._parentNodes.forEach((function(e){e._dirty.colors=!0})))}})),x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Sphere.superClass.call(this,e),this.addField_SFFloat(e,"radius",e?1:1e3),this.addField_SFVec2f(e,"subdivision",24,24),this._qfactors={low:.3,medium:.5,high:1},void 0===e&&this.nodeChanged()}),{nodeChanged:function(){var e=1;this._nameSpace&&(e=this._nameSpace.doc.properties.getProperty("PrimitiveQuality","Medium")),e=x3dom.Utils.isNumber(e)?parseFloat(e):this._qfactors[e.toLowerCase()]||.5,this._quality=e;var t=["Sphere",this._vf.radius,this._vf.subdivision.x,this._vf.subdivision.y,e,this._vf.ccw].join("-");this._vf.useGeoCache&&void 0!==x3dom.geoCache[t]?this._mesh=x3dom.geoCache[t]:(this._regenerateMesh(),this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[t]=this._mesh)},_regenerateMesh:function(){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];var e,t,i,s,o,n,r,a,d,h,l=this._vf.radius,f=this._vf.ccw?1:-1,u=this._vf.subdivision.x,_=this._vf.subdivision.y,c=Math.floor(u*this._quality),m=Math.floor(_*this._quality);for(e=0;e<=c;e++)for(i=e*Math.PI/c,s=Math.sin(i),o=Math.cos(i),t=0;t<=m;t++)n=this._calcXYZ(t,m,s,o),r=this._uFromlong(t,m),a=e/c,this._mesh._positions[0].push(l*n.x,l*n.y,l*n.z),this._mesh._normals[0].push(f*n.x,f*n.y,f*n.z),this._mesh._texCoords[0].push(r,a);for(e=0;e<c;e++)for(t=0;t<m;t++)h=(d=e*(m+1)+t)+m+1,this._mesh._indices[0].push(d,h,d+1),this._mesh._indices[0].push(h,h+1,d+1)},_calcXYZ:function(e,t,i,s){var o=.5*Math.PI+2*e*Math.PI/t;return{x:-Math.cos(o)*i,y:-s,z:-Math.sin(o)*i}},_uFromlong:function(e,t){return 1-e/t},fieldChanged:function(e){if("radius"===e){this._mesh._positions[0]=[];var t,i,s,o,n,r,a=this._vf.radius,d=this._vf.subdivision.x,h=this._vf.subdivision.y,l=this._quality,f=Math.floor(d*l),u=Math.floor(h*l);for(t=0;t<=f;t++)for(s=t*Math.PI/f,o=Math.sin(s),n=Math.cos(s),i=0;i<=u;i++)r=this._calcXYZ(i,u,o,n),this._mesh._positions[0].push(a*r.x,a*r.y,a*r.z);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else if("subdivision"===e){this._regenerateMesh(),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3;var _="Sphere_"+(a=this._vf.radius)+"-"+(d=this._vf.subdivision.x)+"-"+(h=this._vf.subdivision.y);x3dom.geoCache[_]=this._mesh,this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()}))}}})),x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Torus.superClass.call(this,e);var t=2*Math.PI;this.addField_SFFloat(e,"innerRadius",.5),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFFloat(e,"angle",t),this.addField_SFBool(e,"caps",!0),this.addField_SFVec2f(e,"subdivision",24,24),this.addField_SFBool(e,"insideOutsideRadius",!1),this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t),this._origCCW=this._vf.ccw;var i=this._vf.innerRadius,s=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>s){var o=i;i=s,s=o}var n=(s-i)/2;s=i+n,i=n,this._vf.ccw=!this._origCCW}var r=this._vf.subdivision.x,a=this._vf.subdivision.y,d=this._vf.ccw?1:-1;r=Math.max(3,Math.round(this._vf.angle/t*r));var h=["Torus_",i,s,this._vf.angle,this._vf.subdivision,this._vf.caps,d].join("_");if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[h])this._mesh=x3dom.geoCache[h];else{var l,f,u,_,c,m,p,x,v,g=this._vf.angle/r,y=t/a;for(l=0,u=0;l<=r;l++,u+=g)for(c=Math.cos(u),m=Math.sin(u),f=0,_=0;f<=a;f++,_+=y)p=Math.cos(_),x=Math.sin(_),v=s+i*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*v,i*x,-m*v),this._mesh._normals[0].push(d*c*p,d*x,d*-m*p)):(this._mesh._positions[0].push(c*v,-m*v,i*x),this._mesh._normals[0].push(d*c*p,d*-m*p,d*x)),this._mesh._texCoords[0].push(-l/r,f/a);for(l=0;l<a;l++)for(f=0;f<r;f++)this._mesh._indices[0].push(f*(a+1)+l),this._mesh._indices[0].push(f*(a+1)+l+1),this._mesh._indices[0].push((f+1)*(a+1)+l),this._mesh._indices[0].push(f*(a+1)+l+1),this._mesh._indices[0].push((f+1)*(a+1)+l+1),this._mesh._indices[0].push((f+1)*(a+1)+l);if(this._vf.angle<t&&1==this._vf.caps){var S=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,0,1*d)):(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,1*d,0)),this._mesh._texCoords[0].push(.5,.5),f=0,_=0;f<=a;f++,_+=y)p=Math.cos(_),x=Math.sin(_),v=s+i*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(v,x*i,0),this._mesh._normals[0].push(0,0,1*d)):(this._mesh._positions[0].push(v,0,x*i),this._mesh._normals[0].push(0,1*d,0)),this._mesh._texCoords[0].push(.5*(1+p),.5*(1-x)),f>0&&(this._mesh._indices[0].push(S),this._mesh._indices[0].push(S+f),this._mesh._indices[0].push(S+f-1)),f==a&&(this._mesh._indices[0].push(S),this._mesh._indices[0].push(S+1),this._mesh._indices[0].push(S+f));c=Math.cos(this._vf.angle),m=Math.sin(this._vf.angle),S=this._mesh._positions[0].length/3;var T=-m,F=-c;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*s,0,-m*s),this._mesh._normals[0].push(d*T,0,d*F)):(this._mesh._positions[0].push(c*s,-m*s,0),this._mesh._normals[0].push(d*T,d*F,0)),this._mesh._texCoords[0].push(.5,.5),f=0,_=0;f<=a;f++,_+=y)p=Math.cos(_),x=Math.sin(_),v=s+i*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(c*v,x*i,-m*v),this._mesh._normals[0].push(d*T,0,d*F)):(this._mesh._positions[0].push(c*v,-m*v,x*i),this._mesh._normals[0].push(d*T,d*F,0)),this._mesh._texCoords[0].push(1-.5*(1+p),.5*(1-x)),f>0&&(this._mesh._indices[0].push(S),this._mesh._indices[0].push(S+f-1),this._mesh._indices[0].push(S+f)),f==a&&(this._mesh._indices[0].push(S),this._mesh._indices[0].push(S+f),this._mesh._indices[0].push(S+1))}this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[h]=this._mesh}}),{fieldChanged:function(e){if("innerRadius"==e||"outerRadius"==e||"subdivision"==e||"angle"==e||"insideOutsideRadius"==e||"caps"==e){var t=2*Math.PI;this._vf.angle<0?this._vf.angle=0:this._vf.angle>t&&(this._vf.angle=t);var i=this._vf.innerRadius,s=this._vf.outerRadius;if(1==this._vf.insideOutsideRadius){if(i>s){var o=i;i=s,s=o}var n=(s-i)/2;s=i+n,i=n,this._vf.ccw=!this._origCCW}else this._vf.ccw=this._origCCW;var r=this._vf.subdivision.x,a=this._vf.subdivision.y,d=this._vf.ccw?1:-1;r=Math.max(3,Math.round(this._vf.angle/t*r));var h,l,f,u,_,c,m,p,x,v=this._vf.angle/r,g=t/a;for(this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[],h=0,f=0;h<=r;h++,f+=v)for(_=Math.cos(f),c=Math.sin(f),l=0,u=0;l<=a;l++,u+=g)m=Math.cos(u),p=Math.sin(u),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*x,i*p,-c*x),this._mesh._normals[0].push(d*_*m,d*p,d*-c*m)):(this._mesh._positions[0].push(_*x,-c*x,i*p),this._mesh._normals[0].push(d*_*m,d*-c*m,d*p)),this._mesh._texCoords[0].push(-h/r,l/a);for(h=0;h<a;h++)for(l=0;l<r;l++)this._mesh._indices[0].push(l*(a+1)+h),this._mesh._indices[0].push(l*(a+1)+h+1),this._mesh._indices[0].push((l+1)*(a+1)+h),this._mesh._indices[0].push(l*(a+1)+h+1),this._mesh._indices[0].push((l+1)*(a+1)+h+1),this._mesh._indices[0].push((l+1)*(a+1)+h);if(this._vf.angle<t&&1==this._vf.caps){var y=this._mesh._positions[0].length/3;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,0,1*d)):(this._mesh._positions[0].push(s,0,0),this._mesh._normals[0].push(0,1*d,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;l<=a;l++,u+=g)m=Math.cos(u),p=Math.sin(u),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(x,p*i,0),this._mesh._normals[0].push(0,0,1*d)):(this._mesh._positions[0].push(x,0,p*i),this._mesh._normals[0].push(0,1*d,0)),this._mesh._texCoords[0].push(.5*(1+m),.5*(1-p)),l>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+l),this._mesh._indices[0].push(y+l-1)),l==a&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+1),this._mesh._indices[0].push(y+l));_=Math.cos(this._vf.angle),c=Math.sin(this._vf.angle),y=this._mesh._positions[0].length/3;var S=-c,T=-_;for(this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*s,0,-c*s),this._mesh._normals[0].push(d*S,0,d*T)):(this._mesh._positions[0].push(_*s,-c*s,0),this._mesh._normals[0].push(d*S,d*T,0)),this._mesh._texCoords[0].push(.5,.5),l=0,u=0;l<=a;l++,u+=g)m=Math.cos(u),p=Math.sin(u),x=s+i*m,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(_*x,p*i,-c*x),this._mesh._normals[0].push(d*S,0,d*T)):(this._mesh._positions[0].push(_*x,-c*x,p*i),this._mesh._normals[0].push(d*S,d*T,0)),this._mesh._texCoords[0].push(1-.5*(1+m),.5*(1-p)),l>0&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+l-1),this._mesh._indices[0].push(y+l)),l==a&&(this._mesh._indices[0].push(y),this._mesh._indices[0].push(y+l),this._mesh._indices[0].push(y+1))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()}))}}})),x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Cone.superClass.call(this,e),this.addField_SFFloat(e,"bottomRadius",1),this.addField_SFFloat(e,"topRadius",0),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"side",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32);var t=["Cone",this._vf.bottomRadius,this._vf.height,this._vf.top,this._vf.bottom,this._vf.side,this._vf.topRadius,this._vf.subdivision,this._vf.ccw].join("_");this._vf.useGeoCache&&void 0!==x3dom.geoCache[t]?this._mesh=x3dom.geoCache[t]:(this._calcMesh(),this._mesh._invalidate=!0,x3dom.geoCache[t]=this._mesh)}),{_calcMesh:function(){var e,t,i,s,o,n=this._vf.bottomRadius,r=this._vf.height,a=this._vf.topRadius,d=this._vf.subdivision,h=this._vf.ccw?1:-1,l=2*Math.PI/d,f=(n-a)/r,u=1/Math.sqrt(1+f*f),_=0,c=0;if(this._vf.side&&r>0){var m=0,p=0;for(_=0,c=0;_<=d;_++)e=_*l,t=Math.sin(e),i=-Math.cos(e),a>x3dom.fields.Eps&&(m=t*a,p=i*a),this._mesh._positions[0].push(m,r/2,p),this._mesh._normals[0].push(h*t/u,h*f/u,h*i/u),this._mesh._texCoords[0].push(1-_/d,1),this._mesh._positions[0].push(t*n,-r/2,i*n),this._mesh._normals[0].push(h*t/u,h*f/u,h*i/u),this._mesh._texCoords[0].push(1-_/d,0),_>0&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+2),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+2),this._mesh._indices[0].push(c+3),c+=2)}if(this._vf.bottom&&n>0){for(o=this._mesh._positions[0].length/3,_=d-1;_>=0;_--)e=_*l,t=n*Math.sin(e),i=-n*Math.cos(e),this._mesh._positions[0].push(t,-r/2,i),this._mesh._normals[0].push(0,-1*h,0),this._mesh._texCoords[0].push(t/n/2+.5,i/n/2+.5);for(s=o+1,_=2;_<d;_++)this._mesh._indices[0].push(s),this._mesh._indices[0].push(o),s=o+_,this._mesh._indices[0].push(s)}if(this._vf.top&&a>x3dom.fields.Eps){for(o=this._mesh._positions[0].length/3,_=d-1;_>=0;_--)e=_*l,t=a*Math.sin(e),i=-a*Math.cos(e),this._mesh._positions[0].push(t,r/2,i),this._mesh._normals[0].push(0,1*h,0),this._mesh._texCoords[0].push(t/a/2+.5,1-i/a/2+.5);for(s=o+1,_=2;_<d;_++)this._mesh._indices[0].push(o),this._mesh._indices[0].push(s),s=o+_,this._mesh._indices[0].push(s)}this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"bottomRadius"!=e&&"topRadius"!=e&&"height"!=e&&"subdivision"!=e&&"bottom"!=e&&"top"!=e&&"side"!=e||(this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._calcMesh(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Cylinder.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32),this.addField_SFBool(e,"side",!0);var t=this._vf.subdivision,i=this._vf.ccw,s=["Cylinder",this._vf.radius,this._vf.height,this._vf.bottom,this._vf.top,this._vf.side,t,i].join("_");this._vf.useGeoCache&&void 0!==x3dom.geoCache[s]?this._mesh=x3dom.geoCache[s]:(this._calcMesh(),this._mesh._invalidate=!0,x3dom.geoCache[s]=this._mesh)}),{_calcMesh:function(){var e,t,i,s,o=this._vf.radius,n=this._vf.height/2,r=this._vf.subdivision,a=this._vf.ccw?1:-1,d=2*Math.PI/r,h=0;if(this._vf.side)for(s=0,h=0;s<=r;s++)e=s*d,t=Math.sin(e),i=-Math.cos(e),this._mesh._positions[0].push(t*o,-n,i*o),this._mesh._normals[0].push(a*t,0,a*i),this._mesh._texCoords[0].push(1-s/r,0),this._mesh._positions[0].push(t*o,n,i*o),this._mesh._normals[0].push(a*t,0,a*i),this._mesh._texCoords[0].push(1-s/r,1),s>0&&(this._mesh._indices[0].push(h+0,h+1,h+2),this._mesh._indices[0].push(h+2,h+1,h+3),h+=2);if(o>0){var l,f=this._mesh._positions[0].length/3;if(this._vf.top){for(s=r-1;s>=0;s--)e=s*d,t=o*Math.sin(e),i=-o*Math.cos(e),this._mesh._positions[0].push(t,n,i),this._mesh._normals[0].push(0,1*a,0),this._mesh._texCoords[0].push(t/o/2+.5,-i/o/2+.5);for(l=f+1,s=2;s<r;s++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(l),l=f+s,this._mesh._indices[0].push(l);f=this._mesh._positions[0].length/3}if(this._vf.bottom){for(s=r-1;s>=0;s--)e=s*d,t=o*Math.sin(e),i=-o*Math.cos(e),this._mesh._positions[0].push(t,-n,i),this._mesh._normals[0].push(0,-1*a,0),this._mesh._texCoords[0].push(t/o/2+.5,i/o/2+.5);for(l=f+1,s=2;s<r;s++)this._mesh._indices[0].push(l),this._mesh._indices[0].push(f),l=f+s,this._mesh._indices[0].push(l)}}this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){if("radius"===e||"height"===e){this._mesh._positions[0]=[];var t,i,s,o,n=this._vf.radius,r=this._vf.height/2,a=this._vf.subdivision,d=2*Math.PI/a;if(this._vf.side)for(o=0;o<=a;o++)t=o*d,i=Math.sin(t),s=-Math.cos(t),this._mesh._positions[0].push(i*n,-r,s*n),this._mesh._positions[0].push(i*n,r,s*n);if(n>0){this._mesh._positions[0].length;if(this._vf.top)for(o=a-1;o>=0;o--)t=o*d,i=n*Math.sin(t),s=-n*Math.cos(t),this._mesh._positions[0].push(i,r,s)}if(this._vf.bottom)for(o=a-1;o>=0;o--)t=o*d,i=n*Math.sin(t),s=-n*Math.cos(t),this._mesh._positions[0].push(i,-r,s);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else"subdivision"!==e&&"bottom"!==e&&"top"!==e&&"side"!==e||(this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._calcMesh(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("X3DBinaryContainerGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.X3DBinaryContainerGeometryNode.superClass.call(this,e),this.addField_SFVec3f(e,"position",0,0,0),this.addField_SFVec3f(e,"size",1,1,1),this.addField_MFInt32(e,"vertexCount",[0]),this.addField_MFString(e,"primType",["TRIANGLES"]),this._mesh._invalidate=!1,this._mesh._numCoords=0,this._mesh._numFaces=0,this._diameter=this._vf.size.length()}),{getMin:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.min},getMax:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e.max},getVolume:function(){var e=this._mesh._vol;return e.isValid()||e.setBoundsByCenterSize(this._vf.position,this._vf.size),e},invalidateVolume:function(){},getCenter:function(){return this._vf.position},getDiameter:function(){return this._diameter},needLighting:function(){var e=this._vf.primType.length&&this._vf.primType[0].indexOf("TRIANGLE")>=0;return this._vf.lit&&e}})),x3dom.registerNodeType("BinaryGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,(function(e){x3dom.nodeTypes.BinaryGeometry.superClass.call(this,e),this.addField_SFString(e,"index",""),this.addField_SFString(e,"coord",""),this.addField_SFString(e,"normal",""),this.addField_SFString(e,"texCoord",""),this.addField_SFString(e,"color",""),this.addField_SFString(e,"tangent",""),this.addField_SFString(e,"binormal",""),this.addField_SFString(e,"indexType","Uint16"),this.addField_SFString(e,"coordType","Float32"),this.addField_SFString(e,"normalType","Float32"),this.addField_SFString(e,"texCoordType","Float32"),this.addField_SFString(e,"colorType","Float32"),this.addField_SFString(e,"tangentType","Float32"),this.addField_SFString(e,"binormalType","Float32"),this.addField_SFBool(e,"normalAsSphericalCoordinates",!1),this.addField_SFBool(e,"rgbaColors",!1),this.addField_SFInt32(e,"numTexCoordComponents",2),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFBool(e,"idsPerVertex",!1),this.addField_SFBool(e,"compressed",!1),this._hasStrideOffset=!1,this._mesh._numPosComponents=this._vf.normalAsSphericalCoordinates?4:3,this._mesh._numTexComponents=this._vf.numTexCoordComponents,this._mesh._numColComponents=this._vf.rgbaColors?4:3,this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3,this._vertexCountSum=0;for(var t=0;t<this._vf.vertexCount.length;++t)this._vertexCountSum+=this._vf.vertexCount[t]}),{parentAdded:function(e){var t,i,s,o;t=this._vf.coord.lastIndexOf("#"),i=this._vf.coord.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.coord.substring(++t,i),o=+this._vf.coord.substring(i),e._coordStrideOffset=[o,s],this._hasStrideOffset=!0,s/8-Math.floor(s/8)==0&&(this._mesh._numPosComponents=4)):i>=0&&(o=+this._vf.coord.substring(i),e._coordStrideOffset=[o,0],o/8-Math.floor(o/8)==0&&(this._mesh._numPosComponents=4)),t=this._vf.normal.lastIndexOf("#"),i=this._vf.normal.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.normal.substring(++t,i),o=+this._vf.normal.substring(i),e._normalStrideOffset=[o,s]):i>=0&&(o=+this._vf.normal.substring(i),e._normalStrideOffset=[o,0]),t=this._vf.texCoord.lastIndexOf("#"),i=this._vf.texCoord.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.texCoord.substring(++t,i),o=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[o,s]):i>=0&&(o=+this._vf.texCoord.substring(i),e._texCoordStrideOffset=[o,0]),t=this._vf.color.lastIndexOf("#"),i=this._vf.color.lastIndexOf("+"),t>=0&&i>=0?(s=+this._vf.color.substring(++t,i),o=+this._vf.color.substring(i),e._colorStrideOffset=[o,s]):i>=0&&(o=+this._vf.color.substring(i),e._colorStrideOffset=[o,0]),"Uint16"==this._vf.indexType||x3dom.caps.INDEX_UINT||x3dom.debug.logWarning("Index type "+this._vf.indexType+" problematic")},doIntersect:function(e){var t=this.getMin(),i=this.getMax();return!!(e.intersect(t,i)&&e.enter<e.dist)&&(e.dist=e.enter,e.hitObject=this,e.hitPoint=e.pos.add(e.dir.multiply(e.enter)),!0)},getPrecisionMax:function(e){switch(this._vf[e]){case"Int8":return 127;case"Uint8":return 255;case"Int16":return 32767;case"Uint16":return 65535;case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("PopGeometryLevel","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.PopGeometryLevel.superClass.call(this,e),this.addField_SFString(e,"src",""),this.addField_SFInt32(e,"numIndices",0),this.addField_SFInt32(e,"vertexDataBufferOffset",0)}),{getSrc:function(){return this._vf.src},getNumIndices:function(){return this._vf.numIndices},getVertexDataBufferOffset:function(){return this._vf.vertexDataBufferOffset}})),x3dom.registerNodeType("PopGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,(function(e){x3dom.nodeTypes.PopGeometry.superClass.call(this,e),this.addField_SFVec3f(e,"tightSize",1,1,1),this.addField_SFVec3f(e,"maxBBSize",1,1,1),this.addField_SFVec3f(e,"bbMinModF",0,0,0),this.addField_SFVec3f(e,"bbMaxModF",1,1,1),this.addField_SFVec3f(e,"bbMin",0,0,0),this.addField_SFVec3f(e,"bbShiftVec",0,0,0),this._vf.bbMinModF.x>this._vf.bbMaxModF.x&&(this._vf.bbShiftVec.x=1),this._vf.bbMinModF.y>this._vf.bbMaxModF.y&&(this._vf.bbShiftVec.y=1),this._vf.bbMinModF.z>this._vf.bbMaxModF.z&&(this._vf.bbShiftVec.z=1),this.addField_MFNode("levels",x3dom.nodeTypes.PopGeometryLevel),this.addField_SFInt32(e,"attributeStride",0),this.addField_SFInt32(e,"positionOffset",0),this.addField_SFInt32(e,"normalOffset",0),this.addField_SFInt32(e,"texcoordOffset",0),this.addField_SFInt32(e,"colorOffset",0),this.addField_SFInt32(e,"numAnchorVertices",0),this.addField_SFInt32(e,"positionPrecision",2),this.addField_SFInt32(e,"normalPrecision",1),this.addField_SFInt32(e,"texcoordPrecision",2),this.addField_SFInt32(e,"colorPrecision",1),this.addField_SFInt32(e,"minPrecisionLevel",-1),this.addField_SFInt32(e,"maxPrecisionLevel",-1),this.addField_SFFloat(e,"precisionFactor",1),this.addField_SFString(e,"coordType","Uint16"),this.addField_SFString(e,"normalType","Uint8"),this.addField_SFString(e,"texCoordType","Uint16"),this.addField_SFString(e,"colorType","Uint8"),this.addField_SFInt32(e,"vertexBufferSize",0),this.addField_SFBool(e,"indexedRendering",!0),this.addField_SFBool(e,"sphericalNormals",!1),this.addField_MFInt32(e,"originalVertexCount",[0]);for(var t=0;t<this._vf.vertexCount.length;++t)this._vf.originalVertexCount[t]=this._vf.vertexCount[t];this._vf.maxBBSize=x3dom.fields.SFVec3f.copy(this._vf.size),this._vf.size=this._vf.tightSize,this._diameter=this._vf.size.length(),this._bbMinBySize=[Math.floor(this._vf.bbMin.x/this._vf.maxBBSize.x),Math.floor(this._vf.bbMin.y/this._vf.maxBBSize.y),Math.floor(this._vf.bbMin.z/this._vf.maxBBSize.z)],this._volRadius=this._vf.size.length()/2,this._volLargestRadius=this._vf.maxBBSize.length()/2,this._mesh._numPosComponents=this._vf.sphericalNormals?4:3,this._mesh._numNormComponents=this._vf.sphericalNormals?2:3,this._mesh._numTexComponents=2,this._mesh._numColComponents=3,x3dom.nodeTypes.PopGeometry.numTotalVerts+=this.getVertexCount(),x3dom.nodeTypes.PopGeometry.numTotalTris+=(this.hasIndex()?this.getTotalNumberOfIndices():this.getVertexCount())/3}),{forceUpdateCoverage:function(){return!0},getBBoxShiftVec:function(){return this._vf.bbShiftVec},getBBoxSize:function(){return this._vf.size},hasIndex:function(){return this._vf.indexedRendering},getTotalNumberOfIndices:function(){if(this._vf.indexedRendering){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e}return 0},getVertexCount:function(){for(var e=0,t=0;t<this._vf.originalVertexCount.length;++t)e+=this._vf.originalVertexCount[t];return e},adaptVertexCount:function(e){for(var t=0,i=0;i<this._vf.originalVertexCount.length;++i){if(!(this._vf.originalVertexCount[i]+t<=e)){this._vf.vertexCount[i]=e-t;break}this._vf.vertexCount[i]=this._vf.originalVertexCount[i],t+=this._vf.originalVertexCount[i]}},hasNormal:function(){return 0!=this._vf.normalOffset&&!this._vf.sphericalNormals},hasTexCoord:function(){return 0!=this._vf.texcoordOffset},hasColor:function(){return 0!=this._vf.colorOffset},getPositionPrecision:function(){return this._vf.positionPrecision},getNormalPrecision:function(){return this._vf.normalPrecision},getTexCoordPrecision:function(){return this._vf.texcoordPrecision},getColorPrecision:function(){return this._vf.colorPrecision},getAttributeStride:function(){return this._vf.attributeStride},getPositionOffset:function(){return this._vf.positionOffset},getNormalOffset:function(){return this._vf.normalOffset},getTexCoordOffset:function(){return this._vf.texcoordOffset},getColorOffset:function(){return this._vf.colorOffset},getBufferTypeStringFromByteCount:function(e){switch(e){case 1:return"Uint8";case 2:return"Uint16";default:return 0}},getDataURLs:function(){for(var e=[],t=0;t<this._cf.levels.nodes.length;++t)e.push(this._cf.levels.nodes[t].getSrc());return e},getNumIndicesByLevel:function(e){return this._cf.levels.nodes[e].getNumIndices()},getNumLevels:function(e){return this._cf.levels.nodes.length},getVertexDataBufferOffset:function(e){return this._cf.levels.nodes[e].getVertexDataBufferOffset()},getPrecisionMax:function(e){switch(this._vf[e]){case"Uint8":return 255;case"Uint16":return 65535;default:return 1}}})),x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor=1,x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove=1,x3dom.nodeTypes.PopGeometry.numRenderedVerts=0,x3dom.nodeTypes.PopGeometry.numRenderedTris=0,x3dom.nodeTypes.PopGeometry.numTotalVerts=0,x3dom.nodeTypes.PopGeometry.numTotalTris=0,x3dom.nodeTypes.PopGeometry.powLUT=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1],x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,e),this.addField_SFFloat(e,"creaseAngle",0),this.addField_SFBool(e,"convex",!0),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFInt32(e,"normalIndex",[]),this.addField_MFInt32(e,"colorIndex",[]),this.addField_MFInt32(e,"texCoordIndex",[])}),{nodeChanged:function(){(new Date).getTime();this.handleAttribs();var e=this._vf.coordIndex;e.length&&-1!=e[e.length-1]&&e.push(-1);var t,i,s,o,n=this._vf.normalIndex,r=this._vf.texCoordIndex,a=this._vf.colorIndex,d=!1,h=!1,l=!1,f=!1,u=!1,_=!1,c=this._vf.colorPerVertex,m=this._vf.normalPerVertex;n.length>0&&(h=!0),r.length>0&&(f=!0),a.length>0&&(_=!0);var p=this._cf.coord.node;x3dom.debug.assert(p),t=p.getPoints();var x=this._cf.normal.node;x?(d=!0,i=x._vf.vector):d=!1;var v="",g=2,y=this._cf.texCoord.node;if(x3dom.isa(y,x3dom.nodeTypes.MultiTextureCoordinate)&&y._cf.texCoord.nodes.length&&(y=y._cf.texCoord.nodes[0]),y)if(y._vf.point){if(l=!0,s=y._vf.point,!f){var S=s.length;for(T=S;T<t.length;T++)s.push(s[T%S])}x3dom.isa(y,x3dom.nodeTypes.TextureCoordinate3D)&&(g=3)}else y._vf.mode&&(v=y._vf.mode);else l=!1;this._mesh._numTexComponents=g;var T,F,b,C,M,E,w,A,D,N,R,I,P,V,O,L,B=3,U=this._cf.color.node;if(U?(u=!0,o=U._vf.color,x3dom.isa(U,x3dom.nodeTypes.ColorRGBA)&&(B=4)):u=!1,this._mesh._numColComponents=B,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[],this._vf.creaseAngle<=x3dom.fields.Eps||t.length>x3dom.Utils.maxIndexableCoords||d&&h||l&&f||u&&_){if(this._vf.creaseAngle<=x3dom.fields.Eps&&x3dom.debug.logWarning("Fallback to inefficient multi-index mode since creaseAngle=0."),this._vf.convex)for(b=0,0,C=0,this._mesh._multiIndIndices=[],this._mesh._posSize=t.length,T=0;T<e.length;++T)if(-1!=e[T])switch(h&&x3dom.debug.assert(-1!=n[T]),f&&x3dom.debug.assert(-1!=r[T]),_&&x3dom.debug.assert(-1!=a[T]),b){case 0:M=+e[T],A=h&&m?+n[T]:h&&!m?+n[C]:m?M:C,R=f?+r[T]:M,V=_&&c?+a[T]:_&&!c?+a[C]:c?M:C,b=1;break;case 1:E=+e[T],D=h&&m?+n[T]:h&&!m?+n[C]:m?E:C,I=f?+r[T]:E,O=_&&c?+a[T]:_&&!c?+a[C]:c?E:C,b=2;break;case 2:w=+e[T],N=h&&m?+n[T]:h&&!m?+n[C]:m?w:C,P=f?+r[T]:w,L=_&&c?+a[T]:_&&!c?+a[C]:c?w:C,b=3,this._mesh._positions[0].push(t[M].x),this._mesh._positions[0].push(t[M].y),this._mesh._positions[0].push(t[M].z),this._mesh._positions[0].push(t[E].x),this._mesh._positions[0].push(t[E].y),this._mesh._positions[0].push(t[E].z),this._mesh._positions[0].push(t[w].x),this._mesh._positions[0].push(t[w].y),this._mesh._positions[0].push(t[w].z),d&&(this._mesh._normals[0].push(i[A].x),this._mesh._normals[0].push(i[A].y),this._mesh._normals[0].push(i[A].z),this._mesh._normals[0].push(i[D].x),this._mesh._normals[0].push(i[D].y),this._mesh._normals[0].push(i[D].z),this._mesh._normals[0].push(i[N].x),this._mesh._normals[0].push(i[N].y),this._mesh._normals[0].push(i[N].z)),this._mesh._multiIndIndices.push(M,E,w),u&&(this._mesh._colors[0].push(o[V].r),this._mesh._colors[0].push(o[V].g),this._mesh._colors[0].push(o[V].b),4===B&&this._mesh._colors[0].push(o[V].a),this._mesh._colors[0].push(o[O].r),this._mesh._colors[0].push(o[O].g),this._mesh._colors[0].push(o[O].b),4===B&&this._mesh._colors[0].push(o[O].a),this._mesh._colors[0].push(o[L].r),this._mesh._colors[0].push(o[L].g),this._mesh._colors[0].push(o[L].b),4===B&&this._mesh._colors[0].push(o[L].a)),l&&(this._mesh._texCoords[0].push(s[R].x),this._mesh._texCoords[0].push(s[R].y),3===g&&this._mesh._texCoords[0].push(s[R].z),this._mesh._texCoords[0].push(s[I].x),this._mesh._texCoords[0].push(s[I].y),3===g&&this._mesh._texCoords[0].push(s[I].z),this._mesh._texCoords[0].push(s[P].x),this._mesh._texCoords[0].push(s[P].y),3===g&&this._mesh._texCoords[0].push(s[P].z));break;case 3:E=w,I=P,m&&(D=N),c&&(O=L),w=+e[T],h&&m?N=+n[T]:h&&!m||(N=m?w:C),P=f?+r[T]:w,_&&c?L=+a[T]:_&&!c||(L=c?w:C),this._mesh._positions[0].push(t[M].x),this._mesh._positions[0].push(t[M].y),this._mesh._positions[0].push(t[M].z),this._mesh._positions[0].push(t[E].x),this._mesh._positions[0].push(t[E].y),this._mesh._positions[0].push(t[E].z),this._mesh._positions[0].push(t[w].x),this._mesh._positions[0].push(t[w].y),this._mesh._positions[0].push(t[w].z),d&&(this._mesh._normals[0].push(i[A].x),this._mesh._normals[0].push(i[A].y),this._mesh._normals[0].push(i[A].z),this._mesh._normals[0].push(i[D].x),this._mesh._normals[0].push(i[D].y),this._mesh._normals[0].push(i[D].z),this._mesh._normals[0].push(i[N].x),this._mesh._normals[0].push(i[N].y),this._mesh._normals[0].push(i[N].z)),this._mesh._multiIndIndices.push(M,E,w),u&&(this._mesh._colors[0].push(o[V].r),this._mesh._colors[0].push(o[V].g),this._mesh._colors[0].push(o[V].b),4===B&&this._mesh._colors[0].push(o[V].a),this._mesh._colors[0].push(o[O].r),this._mesh._colors[0].push(o[O].g),this._mesh._colors[0].push(o[O].b),4===B&&this._mesh._colors[0].push(o[O].a),this._mesh._colors[0].push(o[L].r),this._mesh._colors[0].push(o[L].g),this._mesh._colors[0].push(o[L].b),4===B&&this._mesh._colors[0].push(o[L].a)),l&&(this._mesh._texCoords[0].push(s[R].x),this._mesh._texCoords[0].push(s[R].y),3===g&&this._mesh._texCoords[0].push(s[R].z),this._mesh._texCoords[0].push(s[I].x),this._mesh._texCoords[0].push(s[I].y),3===g&&this._mesh._texCoords[0].push(s[I].z),this._mesh._texCoords[0].push(s[P].x),this._mesh._texCoords[0].push(s[P].y),3===g&&this._mesh._texCoords[0].push(s[P].z))}else b=0,C++;else{var G=new x3dom.DoublyLinkedList,X={};for(0,C=0,this._mesh._multiIndIndices=[],T=0;T<e.length;++T)if(-1!=e[T])d&&(X.normals=h&&m?i[n[T]]:h&&!m?i[n[C]]:i[e[T]]),u&&(X.colors=_&&c?o[a[T]]:_&&!c?o[a[C]]:c?o[e[T]]:o[C]),l&&(X.texCoords=f?s[r[T]]:s[e[T]]),G.appendNode(new x3dom.DoublyLinkedList.ListNode(t[e[T]],e[T],X.normals,X.colors,X.texCoords));else{var k=x3dom.EarClipping.getMultiIndexes(G);for(F=0;F<k.indices.length;F++)this._mesh._multiIndIndices.push(k.indices[F]),this._mesh._positions[0].push(k.point[F].x,k.point[F].y,k.point[F].z),d&&this._mesh._normals[0].push(k.normals[F].x,k.normals[F].y,k.normals[F].z),u&&(this._mesh._colors[0].push(k.colors[F].r,k.colors[F].g,k.colors[F].b),4===B&&this._mesh._colors[0].push(k.colors[F].a)),l&&(this._mesh._texCoords[0].push(k.texCoords[F].x,k.texCoords[F].y),3===g&&this._mesh._texCoords[0].push(k.texCoords[F].z));G=new x3dom.DoublyLinkedList,C++}this._mesh.splitMesh()}d||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),l||this._mesh.calcTexCoords(v)}else{if(b=0,this._vf.convex)for(T=0;T<e.length;++T)if(-1!=e[T])switch(b){case 0:A=+e[T],b=1;break;case 1:D=+e[T],b=2;break;case 2:N=+e[T],b=3,this._mesh._indices[0].push(A,D,N);break;case 3:D=N,N=+e[T],this._mesh._indices[0].push(A,D,N)}else b=0;else for(G=new x3dom.DoublyLinkedList,T=0;T<e.length;++T)if(-1!=e[T])G.appendNode(new x3dom.DoublyLinkedList.ListNode(t[e[T]],e[T]));else{var z=x3dom.EarClipping.getIndexes(G);for(F=0;F<z.length;F++)this._mesh._indices[0].push(z[F]);G=new x3dom.DoublyLinkedList}this._mesh._positions[0]=t.toGL(),d?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),l?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=g):this._mesh.calcTexCoords(v),u&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=B)}for(this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,T=0;T<this._mesh._positions.length;T++){var H=this._mesh._indices[T].length,j=this._mesh._positions[T].length/3;this._mesh._numCoords+=j,this._mesh._numFaces+=H>0?H/3:j/3}},fieldChanged:function(e){if("coord"==e||"normal"==e||"texCoord"==e||"color"==e||"coordIndex"==e){var t=this._cf.coord.node._vf.point,i=t.length,s=this._cf.texCoord.node;if(x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),(this._vf.creaseAngle<=x3dom.fields.Eps||i>x3dom.Utils.maxIndexableCoords||this._vf.normalIndex.length>0&&this._cf.normal.node||this._vf.texCoordIndex.length>0&&s||this._vf.colorIndex.length>0&&this._cf.color.node)&&this._mesh._multiIndIndices){var o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();if(i=this._mesh._multiIndIndices.length,this._mesh._positions[0]=[],this._mesh._indices[0]=[],"coord"==e&&i){for(R=0;R<i;R+=3){var n=this._mesh._multiIndIndices[R],r=this._mesh._multiIndIndices[R+1],a=this._mesh._multiIndIndices[R+2],d=t[n],h=t[r],l=t[a];this._mesh._positions[0].push(d.x,d.y,d.z),this._mesh._positions[0].push(h.x,h.y,h.z),this._mesh._positions[0].push(l.x,l.y,l.z)}return o&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),void this._parentNodes.forEach((function(e){e._dirty.positions=!0,o&&(e._dirty.normals=!0)}))}this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var f,u,_,c,m=this._vf.coordIndex,p=this._vf.normalIndex,x=this._vf.texCoordIndex,v=this._vf.colorIndex,g=!1,y=!1,S=!1,T=!1,F=!1,b=!1,C=this._vf.colorPerVertex,M=this._vf.normalPerVertex;p.length>0&&(y=!0),x.length>0&&(T=!0),v.length>0&&(b=!0);var E=this._cf.coord.node;x3dom.debug.assert(E),f=E.getPoints();var w=this._cf.normal.node;w?(g=!0,u=w._vf.vector):g=!1;var A="",D=2;if(s=this._cf.texCoord.node,x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),s)if(s._vf.point){if(S=!0,_=s._vf.point,!T){var N=_.length;for(R=N;R<f.length;R++)_.push(_[R%N])}x3dom.isa(s,x3dom.nodeTypes.TextureCoordinate3D)&&(D=3)}else s._vf.mode&&(A=s._vf.mode);else S=!1;this._mesh._numTexComponents=D;var R,I,P,V,O,L,B,U,G,X,k,z,H,j,W,Y,q,Q=3,K=this._cf.color.node;if(K?(F=!0,c=K._vf.color,x3dom.isa(K,x3dom.nodeTypes.ColorRGBA)&&(Q=4)):F=!1,this._mesh._numColComponents=Q,this._vf.convex)for(P=0,V=0,O=0,this._mesh._multiIndIndices=[],this._mesh._posSize=f.length,R=0;R<m.length;++R)if(-1!=m[R])switch(y&&x3dom.debug.assert(-1!=p[R]),T&&x3dom.debug.assert(-1!=x[R]),b&&x3dom.debug.assert(-1!=v[R]),P){case 0:L=+m[R],G=y&&M?+p[R]:y&&!M?+p[O]:M?L:O,z=T?+x[R]:L,W=b&&C?+v[R]:b&&!C?+v[O]:C?L:O,P=1;break;case 1:B=+m[R],X=y&&M?+p[R]:y&&!M?+p[O]:M?B:O,H=T?+x[R]:B,Y=b&&C?+v[R]:b&&!C?+v[O]:C?B:O,P=2;break;case 2:U=+m[R],k=y&&M?+p[R]:y&&!M?+p[O]:M?U:O,j=T?+x[R]:U,q=b&&C?+v[R]:b&&!C?+v[O]:C?U:O,P=3,this._mesh._positions[0].push(f[L].x),this._mesh._positions[0].push(f[L].y),this._mesh._positions[0].push(f[L].z),this._mesh._positions[0].push(f[B].x),this._mesh._positions[0].push(f[B].y),this._mesh._positions[0].push(f[B].z),this._mesh._positions[0].push(f[U].x),this._mesh._positions[0].push(f[U].y),this._mesh._positions[0].push(f[U].z),g&&(this._mesh._normals[0].push(u[G].x),this._mesh._normals[0].push(u[G].y),this._mesh._normals[0].push(u[G].z),this._mesh._normals[0].push(u[X].x),this._mesh._normals[0].push(u[X].y),this._mesh._normals[0].push(u[X].z),this._mesh._normals[0].push(u[k].x),this._mesh._normals[0].push(u[k].y),this._mesh._normals[0].push(u[k].z)),this._mesh._multiIndIndices.push(L,B,U),F&&(this._mesh._colors[0].push(c[W].r),this._mesh._colors[0].push(c[W].g),this._mesh._colors[0].push(c[W].b),4===Q&&this._mesh._colors[0].push(c[W].a),this._mesh._colors[0].push(c[Y].r),this._mesh._colors[0].push(c[Y].g),this._mesh._colors[0].push(c[Y].b),4===Q&&this._mesh._colors[0].push(c[Y].a),this._mesh._colors[0].push(c[q].r),this._mesh._colors[0].push(c[q].g),this._mesh._colors[0].push(c[q].b),4===Q&&this._mesh._colors[0].push(c[q].a)),S&&(this._mesh._texCoords[0].push(_[z].x),this._mesh._texCoords[0].push(_[z].y),3===D&&this._mesh._texCoords[0].push(_[z].z),this._mesh._texCoords[0].push(_[H].x),this._mesh._texCoords[0].push(_[H].y),3===D&&this._mesh._texCoords[0].push(_[H].z),this._mesh._texCoords[0].push(_[j].x),this._mesh._texCoords[0].push(_[j].y),3===D&&this._mesh._texCoords[0].push(_[j].z));break;case 3:B=U,H=j,M&&(X=k),C&&(Y=q),U=+m[R],y&&M?k=+p[R]:y&&!M||(k=M?U:O),j=T?+x[R]:U,b&&C?q=+v[R]:b&&!C||(q=C?U:O),this._mesh._positions[0].push(f[L].x),this._mesh._positions[0].push(f[L].y),this._mesh._positions[0].push(f[L].z),this._mesh._positions[0].push(f[B].x),this._mesh._positions[0].push(f[B].y),this._mesh._positions[0].push(f[B].z),this._mesh._positions[0].push(f[U].x),this._mesh._positions[0].push(f[U].y),this._mesh._positions[0].push(f[U].z),g&&(this._mesh._normals[0].push(u[G].x),this._mesh._normals[0].push(u[G].y),this._mesh._normals[0].push(u[G].z),this._mesh._normals[0].push(u[X].x),this._mesh._normals[0].push(u[X].y),this._mesh._normals[0].push(u[X].z),this._mesh._normals[0].push(u[k].x),this._mesh._normals[0].push(u[k].y),this._mesh._normals[0].push(u[k].z)),this._mesh._multiIndIndices.push(L,B,U),F&&(this._mesh._colors[0].push(c[W].r),this._mesh._colors[0].push(c[W].g),this._mesh._colors[0].push(c[W].b),4===Q&&this._mesh._colors[0].push(c[W].a),this._mesh._colors[0].push(c[Y].r),this._mesh._colors[0].push(c[Y].g),this._mesh._colors[0].push(c[Y].b),4===Q&&this._mesh._colors[0].push(c[Y].a),this._mesh._colors[0].push(c[q].r),this._mesh._colors[0].push(c[q].g),this._mesh._colors[0].push(c[q].b),4===Q&&this._mesh._colors[0].push(c[q].a)),S&&(this._mesh._texCoords[0].push(_[z].x),this._mesh._texCoords[0].push(_[z].y),3===D&&this._mesh._texCoords[0].push(_[z].z),this._mesh._texCoords[0].push(_[H].x),this._mesh._texCoords[0].push(_[H].y),3===D&&this._mesh._texCoords[0].push(_[H].z),this._mesh._texCoords[0].push(_[j].x),this._mesh._texCoords[0].push(_[j].y),3===D&&this._mesh._texCoords[0].push(_[j].z))}else P=0,O++;else{var Z=new x3dom.DoublyLinkedList,J={};for(V=0,O=0,R=0;R<m.length;++R)if(-1!=m[R])g&&(J.normals=y&&M?u[p[R]]:y&&!M?u[p[O]]:u[m[R]]),F&&(J.colors=b&&C?c[v[R]]:b&&!C?c[v[O]]:c[m[R]]),S&&(J.texCoords=T?_[x[R]]:_[m[R]]),Z.appendNode(new x3dom.DoublyLinkedList.ListNode(f[m[R]],m[R],J.normals,J.colors,J.texCoords));else{var $=x3dom.EarClipping.getMultiIndexes(Z);for(I=0;I<$.indices.length;I++)this._mesh._indices[0].push(V),V++,this._mesh._positions[0].push($.point[I].x,$.point[I].y,$.point[I].z),g&&this._mesh._normals[0].push($.normals[I].x,$.normals[I].y,$.normals[I].z),F&&(this._mesh._colors[0].push($.colors[I].r,$.colors[I].g,$.colors[I].b),4===Q&&this._mesh._colors[0].push($.colors[I].a)),S&&(this._mesh._texCoords[0].push($.texCoords[I].x,$.texCoords[I].y),3===D&&this._mesh._texCoords[0].push($.texCoords[I].z));Z=new x3dom.DoublyLinkedList,O++}this._mesh.splitMesh()}for(g||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),S||this._mesh.calcTexCoords(A),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,R=0;R<this._mesh._positions.length;R++){var ee=this._mesh._indices[R].length,te=this._mesh._positions[R].length/3;this._mesh._numCoords+=te,this._mesh._numFaces+=ee>0?ee/3:te/3}this._parentNodes.forEach((function(e){e.setGeoDirty()}))}else if("coord"==e){o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();this._mesh._positions[0]=t.toGL(),o&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,o&&(e._dirty.normals=!0),e.invalidateVolume()}))}else if("color"==e)t=this._cf.color.node._vf.color,this._mesh._colors[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.colors=!0}));else if("normal"==e)t=this._cf.normal.node._vf.vector,this._mesh._normals[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.normals=!0}));else if("texCoord"==e)s=this._cf.texCoord.node,x3dom.isa(s,x3dom.nodeTypes.MultiTextureCoordinate)&&s._cf.texCoord.nodes.length&&(s=s._cf.texCoord.nodes[0]),t=s._vf.point,this._mesh._texCoords[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}));else if("coordIndex"==e){for(o=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),P=0,i=(m=this._vf.coordIndex).length,this._mesh._indices[0]=[],R=0;R<i;++R)if(-1==m[R])P=0;else switch(P){case 0:L=+m[R],P=1;break;case 1:B=+m[R],P=2;break;case 2:U=+m[R],P=3,this._mesh._indices[0].push(L,B,U);break;case 3:B=U,U=+m[R],this._mesh._indices[0].push(L,B,U)}o&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this._parentNodes.forEach((function(e){e._dirty.indexes=!0,o&&(e._dirty.normals=!0)}))}}else x3dom.debug.logWarning("IndexedFaceSet: fieldChanged for "+e+" not yet implemented!")}})),x3dom.registerNodeType("BufferGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,(function(e){x3dom.nodeTypes.BufferGeometry.superClass.call(this,e),this.addField_SFString(e,"buffer",""),this.addField_MFNode("views",x3dom.nodeTypes.BufferView),this.addField_MFNode("accessors",x3dom.nodeTypes.BufferAccessor),this._hasColor=!1,this._hasMultiTexCoord=!1,this._indexed=!1}),{parentAdded:function(e){},nodeChanged:function(){},doIntersect:function(e){var t=this.getMin(),i=this.getMax();return!!(e.intersect(t,i)&&e.enter<e.dist)&&(e.dist=e.enter,e.hitObject=this,e.hitPoint=e.pos.add(e.dir.multiply(e.enter)),!0)},hasColor:function(){return this._hasColor},hasMultiTexCoord:function(){return this._hasMultiTexCoord},getPrecisionMax:function(e){switch(this._vf[e]){case"Int8":return 127;case"Uint8":return 255;case"Int16":return 32767;case"Uint16":return 65535;case"Int32":return 2147483647;case"Uint32":return 4294967295;case"Float32":case"Float64":default:return 1}}})),x3dom.registerNodeType("BufferView","Geometry3D",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.BufferView.superClass.call(this,e),this.addField_SFInt32(e,"target",34962),this.addField_SFInt32(e,"byteOffset",0),this.addField_SFInt32(e,"byteStride",0),this.addField_SFInt32(e,"byteLength",0),this.addField_SFInt32(e,"id",0)}),{parentAdded:function(e){}})),x3dom.registerNodeType("BufferAccessor","Geometry3D",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.BufferAccessor.superClass.call(this,e),this.addField_SFString(e,"bufferType",""),this.addField_SFInt32(e,"view",0),this.addField_SFInt32(e,"byteOffset",0),this.addField_SFInt32(e,"byteStride",0),this.addField_SFInt32(e,"components",0),this.addField_SFInt32(e,"componentType",5126),this.addField_SFInt32(e,"count",0),this.addField_SFBool(e,"normalized",!1)}),{parentAdded:function(e){switch(this._vf.bufferType){case"COLOR_0":case"COLOR":e._hasColor=!0;break;case"INDEX":e._indexed=!0;break;case"TEXCOORD_1":e._hasMultiTexCoord=!0}}})),x3dom.registerNodeType("X3DTexture3DNode","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureNode,(function(e){x3dom.nodeTypes.X3DTexture3DNode.superClass.call(this,e)}))),x3dom.registerNodeType("ComposedTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,(function(e){x3dom.nodeTypes.ComposedTexture3D.superClass.call(this,e),this.addField_MFNode("texture",x3dom.nodeTypes.X3DTexture3DNode)}))),x3dom.registerNodeType("ImageTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,(function(e){x3dom.nodeTypes.ImageTexture3D.superClass.call(this,e)}))),x3dom.registerNodeType("PixelTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,(function(e){x3dom.nodeTypes.PixelTexture3D.superClass.call(this,e)}))),x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,(function(e){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,e),this.addField_MFVec3f(e,"point",[])}))),x3dom.registerNodeType("TextureTransform3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,(function(e){x3dom.nodeTypes.TextureTransform3D.superClass.call(this,e),this.addField_SFVec3f(e,"center",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0)}))),x3dom.registerNodeType("TextureTransformMatrix3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,(function(e){x3dom.nodeTypes.TextureTransformMatrix3D.superClass.call(this,e),this.addField_SFMatrix4f(e,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}))),x3dom.registerNodeType("X3DPointingDeviceSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DSensorNode,(function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.superClass.call(this,e),this._isOver=!1}),{pointerPressedOverSibling:function(e){this._vf.enabled&&(this._vf.isActive=!0,this.postMessage("isActive",!0),this._isOver=!0)},pointerMoved:function(e){},pointerMovedOver:function(e){this._vf.enabled&&this.postMessage("isOver",!0)},pointerMovedOut:function(e){this._vf.enabled&&(this.postMessage("isOver",!1),this._isOver=!1)},pointerReleased:function(){this._vf.enabled&&(this._vf.isActive=!1,this.postMessage("isActive",!1),this._isOver&&this.postMessage("touchTime",Date.now()/1e3))}})),x3dom.registerNodeType("X3DDragSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,(function(e){x3dom.nodeTypes.X3DDragSensorNode.superClass.call(this,e),this.addField_SFBool(e,"autoOffset",!0),this._lastX=-1,this._lastY=-1}),{pointerPressedOverSibling:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerPressedOverSibling.call(this,e),this._lastX=e.layerX,this._lastY=e.layerY,this._startDragging(e.viewarea,e.layerX,e.layerX,e.worldX,e.worldY,e.worldZ)},pointerMoved:function(e){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerMoved.call(this,e),this._vf.isActive&&this._vf.enabled&&this._process2DDrag(e.layerX,e.layerY,e.layerX-this._lastX,e.layerY-this._lastY)},pointerReleased:function(){x3dom.nodeTypes.X3DPointingDeviceSensorNode.prototype.pointerReleased.call(this),this._stopDragging()},_startDragging:function(e,t,i,s,o,n){},_process2DDrag:function(e,t,i,s){},_stopDragging:function(){}})),x3dom.registerNodeType("X3DTouchSensorNode","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DPointingDeviceSensorNode,(function(e){x3dom.nodeTypes.X3DTouchSensorNode.superClass.call(this,e)}),{})),x3dom.registerNodeType("TouchSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DTouchSensorNode,(function(e){x3dom.nodeTypes.TouchSensor.superClass.call(this,e),this._hitPoint=new x3dom.fields.SFVec3f,this._hitNormal=new x3dom.fields.SFVec3f,this._hitRotation=new x3dom.fields.Quaternion,this._up=new x3dom.fields.SFVec3f(0,1,0)}),{pointerMoved:function(e){this._vf.enabled&&(this.postMessage("hitPoint_changed",this._hitPoint.fromArray(e.hitPnt)),this._hitNormal.set(e.normalX,e.normalY,e.normalZ),this.postMessage("hitNormal_changed",this._hitNormal),this.postMessage("hitRotation_changed",x3dom.fields.Quaternion.rotateFromTo(this._up,this._hitNormal)))}})),x3dom.registerNodeType("PlaneSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,(function(e){x3dom.nodeTypes.PlaneSensor.superClass.call(this,e),this.addField_SFRotation(e,"axisRotation",0,0,1,0),this.addField_SFVec2f(e,"minPosition",0,0),this.addField_SFVec2f(e,"maxPosition",-1,-1),this.addField_SFVec3f(e,"offset",0,0,0),this.addField_SFString(e,"planeOrientation","XY"),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._worldToLocalMatrix=null,this._initialPlaneIntersection=null,this._planeNormal=null,this._viewArea=null,this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0),this._lineModeAxis=null,this._vf.minPosition.x==this._vf.maxPosition.x&&(this._lineModeAxis=new x3dom.fields.SFVec3f(0,1,0)),this._vf.minPosition.y==this._vf.maxPosition.y&&(this._lineModeAxis=new x3dom.fields.SFVec3f(1,0,0))}),{getCurrentTransform:function(){var e=x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this);return this._rotationMatrix.mult(e)},_startDragging:function(e,t,i,s,o,n){var r;if(x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,n),this._viewArea=e,this._viewMat=this._viewArea.getViewMatrix(),this._viewMatInv=this._viewMat.inverse(),this._currentTranslation=new x3dom.fields.SFVec3f(0,0,0).add(this._vf.offset),this._localToWorldMatrix=this.getCurrentTransform(),this._worldToLocalMatrix=this._localToWorldMatrix.inverse(),this._initialPlaneIntersection=this._worldToLocalMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,n)),this._planeNormal=new x3dom.fields.SFVec3f(0,0,1),"screen"==this._vf.planeOrientation)r=e.calcViewRay(e._width/2,e._height/2),this._planeNormal=this._worldToLocalMatrix.multMatrixVec(r.dir.normalize());else if(this._lineModeAxis){r=e.calcViewRay(t,i);var a=this._worldToLocalMatrix.multMatrixVec(r.dir.normalize()),d=this._lineModeAxis;this._planeNormal=d.cross(d.cross(a))}},_process2DDrag:function(e,t,i,s){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s);var o,n,r=null;if(this._initialPlaneIntersection){var a=this._viewArea.calcViewRay(e,t);if(a.pos=this._worldToLocalMatrix.multMatrixPnt(a.pos),a.dir=this._worldToLocalMatrix.multMatrixVec(a.dir.normalize()),Math.abs(this._planeNormal.dot(a.dir))<.1)return;if((r=a.intersectPlane(this._initialPlaneIntersection,this._planeNormal))||(r=a.intersectPlane(this._initialPlaneIntersection,this._planeNormal.negate())),r){if(this._currentTranslation=r.subtract(this._initialPlaneIntersection),this._currentTranslation=this._currentTranslation.add(this._vf.offset),o=this._vf.minPosition,n=this._vf.maxPosition,"screen"==this._vf.planeOrientation){if(o.x<=n.x||o.y<=n.y){var d=this._localToWorldMatrix.multMatrixVec(this._currentTranslation);h(d=this._viewMat.multMatrixVec(d),o,n),d=this._viewMatInv.multMatrixVec(d),this._currentTranslation=this._worldToLocalMatrix.multMatrixVec(d)}}else h(this._currentTranslation,o,n),this._currentTranslation.z=0;this.postMessage("translation_changed",x3dom.fields.SFVec3f.copy(this._currentTranslation)),this.postMessage("trackPoint_changed",r)}}function h(e,t,i){t.x<=i.x&&(e.x=Math.min(e.x,i.x),e.x=Math.max(e.x,t.x)),t.y<=i.y&&(e.y=Math.min(e.y,i.y),e.y=Math.max(e.y,t.y))}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=x3dom.fields.SFVec3f.copy(this._currentTranslation),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.registerNodeType("SphereSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,(function(e){x3dom.nodeTypes.SphereSensor.superClass.call(this,e),this.addField_SFRotation(e,"offset",0,1,0,0),this._currentRotation=null,this._rotationMatrix=this._vf.offset.toMatrix()}),{getCurrentTransform:function(){return x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this).mult(this._rotationMatrix)},_startDragging:function(e,t,i,s,o,n){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,n),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._localOrigin=new x3dom.fields.SFVec3f(0,0,0),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var r=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,n));this._initialSphereIntersectionVector=r.subtract(this._localOrigin),this._sphereRadius=this._initialSphereIntersectionVector.length(),this._initialSphereIntersectionVector=this._initialSphereIntersectionVector.normalize()},_process2DDrag:function(e,t,i,s){x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s);var o=this._viewArea.calcViewRay(e,t);o.pos=this._inverseToWorldMatrix.multMatrixPnt(o.pos),o.dir=this._inverseToWorldMatrix.multMatrixVec(o.dir);var n,r,a=o.dir.dot(o.dir),d=2*o.dir.dot(o.pos.subtract(this._localOrigin)),h=d*d-4*a*(o.pos.dot(o.pos)-2*this._localOrigin.dot(o.pos)+this._localOrigin.dot(this._localOrigin)-this._sphereRadius*this._sphereRadius);if(h>=0&&(n=(-d+Math.sqrt(h))/(2*a),r=(-d-Math.sqrt(h))/(2*a),(n=Math.min(n,r))>=1)){var l=o.pos.add(o.dir.multiply(n)).subtract(this._localOrigin).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialSphereIntersectionVector,l),this._currentRotation=this._currentRotation.multiply(this._vf.offset),this.postMessage("rotation_changed",this._currentRotation)}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation,this.postMessage("offset_changed",this._vf.offset)),this._currentRotation=new x3dom.fields.Quaternion}})),x3dom.registerNodeType("CylinderSensor","PointingDeviceSensor",defineClass(x3dom.nodeTypes.X3DDragSensorNode,(function(e){x3dom.nodeTypes.CylinderSensor.superClass.call(this,e),this.addField_SFFloat(e,"offset",0),this.addField_SFRotation(e,"axisRotation",0,1,0,0),this.addField_SFFloat(e,"diskAngle",.262),this.addField_SFFloat(e,"minAngle",0),this.addField_SFFloat(e,"maxAngle",-1),this._rotationMatrix=this._vf.axisRotation.toMatrix(),this._inverseToWorldMatrix=null,this._initialCylinderIntersectionVector=null,this._viewArea=null,this._cylinderRadius=0,this._yAxisLine=null,this._cylinderMode=!0,this._currentRotationAngle=0}),{getCurrentTransform:function(){return x3dom.nodeTypes.X3DDragSensorNode.prototype.getCurrentTransform.call(this).mult(this._rotationMatrix)},_startDragging:function(e,t,i,s,o,n){x3dom.nodeTypes.X3DDragSensorNode.prototype._startDragging.call(this,e,t,i,s,o,n),this._currentRotation=new x3dom.fields.Quaternion,this._viewArea=e,this._yAxisLine=new x3dom.fields.Line(new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,1,0)),this._inverseToWorldMatrix=this.getCurrentTransform().inverse();var r=this._inverseToWorldMatrix.multMatrixPnt(new x3dom.fields.SFVec3f(s,o,n)),a=this._yAxisLine.closestPoint(r);this._initialCylinderIntersectionVector=r.subtract(a),this._cylinderRadius=this._initialCylinderIntersectionVector.length(),this._initialCylinderIntersectionVector=this._initialCylinderIntersectionVector.normalize()},_process2DDrag:function(e,t,i,s){if(x3dom.nodeTypes.X3DDragSensorNode.prototype._process2DDrag.call(this,e,t,i,s),this._cylinderMode){var o=this._viewArea.calcViewRay(e,t);o.pos=this._inverseToWorldMatrix.multMatrixPnt(o.pos),o.dir=this._inverseToWorldMatrix.multMatrixVec(o.dir);var n,r,a=o.dir.subtract(this._yAxisLine.dir.multiply(o.dir.dot(this._yAxisLine.dir))),d=o.pos.subtract(this._yAxisLine.pos).add(this._yAxisLine.dir.multiply(this._yAxisLine.dir.dot(this._yAxisLine.pos.subtract(o.pos)))),h=2*a.dot(d)/a.dot(a),l=h*h*.25-(d.dot(d)-this._cylinderRadius*this._cylinderRadius)/a.dot(a);if(l>=0&&(n=.5*-h+(l=Math.sqrt(l)),r=.5*-h-l,(n=Math.min(n,r))>0)){var f=o.pos.add(o.dir.multiply(n)),u=this._yAxisLine.closestPoint(f),_=f.subtract(u).normalize();this._currentRotation=x3dom.fields.Quaternion.rotateFromTo(this._initialCylinderIntersectionVector,_);var c=x3dom.fields.Quaternion.axisAngle(this._yAxisLine.dir,this._vf.offset);this._currentRotation=this._currentRotation.multiply(c),this.postMessage("rotation_changed",this._currentRotation)}}},_stopDragging:function(){x3dom.nodeTypes.X3DDragSensorNode.prototype._stopDragging.call(this),this._vf.autoOffset&&(this._vf.offset=this._currentRotation.angle(),this.postMessage("offset_changed",this._vf.offset))}})),x3dom.registerNodeType("X3DSequencerNode","EventUtilities",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DSequencerNode.superClass.call(this,e),this.addField_SFBool(e,"next",!1),this.addField_SFBool(e,"previous",!1),this.addField_MFFloat(e,"key",[]),this.addField_SFFloat(e,"set_fraction",0),this._keyIndex=-1,this._key_changed=!1,this._keyValue_changed=!1}),{findInterval:function(e){var t=this._vf.key.length-1;if(e<this._vf.key[0])return 0;if(e>=this._vf.key[t])return t;for(var i=0;i<t;++i)if(this._vf.key[i]<=e&&e<this._vf.key[i+1])return i;return 0},fieldChanged:function(e){if("set_fraction"!==e)return"next"===e&&this._vf.next?(this._keyIndex=(this._keyIndex+1)%this._vf.key.length,void this.postMessage("value_changed",this._vf.keyValue[this._keyIndex])):"previous"===e&&this._vf.previous?(this._keyIndex=(this._keyIndex-1+this._vf.key.length)%this._vf.key.length,void this.postMessage("value_changed",this._vf.keyValue[this._keyIndex])):"key"===e?this._key_changed?void(this._key_changed=!1):(this._key_changed=!0,void this.postMessage("key",this._vf.key)):"keyValue"===e?this._keyValue_changed?void(this._keyValue_changed=!1):(this._keyValue_changed=!0,void this.postMessage("keyValue",this._vf.keyValue)):void 0;var t=this.findInterval(this._vf.set_fraction);t!==this._keyIndex&&(this._keyIndex=t,this.postMessage("value_changed",this._vf.keyValue[t]))}})),x3dom.registerNodeType("X3DTriggerNode","EventUtilities",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.X3DTriggerNode.superClass.call(this,e)}))),x3dom.registerNodeType("BooleanFilter","EventUtilities",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.BooleanFilter.superClass.call(this,e),this.addField_SFBool(e,"set_boolean"),this.addField_SFBool(e,"inputFalse"),this.addField_SFBool(e,"inputTrue"),this.addField_SFBool(e,"inputNegate")}),{fieldChanged:function(e){if("set_boolean"===e){var t=this._vf.set_boolean;return this._vf.inputNegate=!t,this.postMessage("inputNegate",!t),t?(this._vf.inputTrue=!0,void this.postMessage("inputTrue",!0)):(this._vf.inputFalse=!1,void this.postMessage("inputFalse",!1))}}})),x3dom.registerNodeType("BooleanSequencer","EventUtilities",defineClass(x3dom.nodeTypes.X3DSequencerNode,(function(e){x3dom.nodeTypes.BooleanSequencer.superClass.call(this,e),this.addField_MFBoolean(e,"keyValue",[])}),{})),x3dom.registerNodeType("BooleanToggle","EventUtilities",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.BooleanToggle.superClass.call(this,e),this.addField_SFBool(e,"set_boolean"),this.addField_SFBool(e,"toggle",!1)}),{fieldChanged:function(e){if("set_boolean"!==e)"toggle"===e&&this.postMessage("toggle",this._vf.toggle);else if(this._vf.set_boolean){var t=!this._vf.toggle;this._vf.toggle=t,this.postMessage("toggle",t)}}})),x3dom.registerNodeType("BooleanTrigger","EventUtilities",defineClass(x3dom.nodeTypes.X3DTriggerNode,(function(e){x3dom.nodeTypes.BooleanTrigger.superClass.call(this,e),this.addField_SFTime(e,"set_triggerTime")}),{fieldChanged:function(e){"set_triggerTime"===e&&this.postMessage("triggerTrue",!0)}})),x3dom.registerNodeType("IntegerSequencer","EventUtilities",defineClass(x3dom.nodeTypes.X3DSequencerNode,(function(e){x3dom.nodeTypes.IntegerSequencer.superClass.call(this,e),this.addField_MFInt32(e,"keyValue",[])}),{})),x3dom.registerNodeType("IntegerTrigger","EventUtilities",defineClass(x3dom.nodeTypes.X3DTriggerNode,(function(e){x3dom.nodeTypes.IntegerTrigger.superClass.call(this,e),this.addField_SFBool(e,"set_boolean"),this.addField_SFInt32(e,"integerKey",-1)}),{fieldChanged:function(e){"set_boolean"===e&&this.postMessage("triggerValue",this._vf.integerKey)}})),x3dom.registerNodeType("TimeTrigger","EventUtilities",defineClass(x3dom.nodeTypes.X3DTriggerNode,(function(e){x3dom.nodeTypes.TimeTrigger.superClass.call(this,e),this.addField_SFBool(e,"set_boolean")}),{fieldChanged:function(e){"set_boolean"===e&&this.postMessage("triggerTime",Date.now()/1e3)}})),x3dom.registerNodeType("GeoCoordinate","Geospatial",defineClass(x3dom.nodeTypes.X3DCoordinateNode,(function(e){x3dom.nodeTypes.GeoCoordinate.superClass.call(this,e),this.addField_MFVec3f(e,"point",[]),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin)}),{elipsoideParameters:{AA:["Airy 1830","6377563.396","299.3249646"],AM:["Modified Airy","6377340.189","299.3249646"],AN:["Australian National","6378160","298.25"],BN:["Bessel 1841 (Namibia)","6377483.865","299.1528128"],BR:["Bessel 1841 (Ethiopia Indonesia...)","6377397.155","299.1528128"],CC:["Clarke 1866","6378206.4","294.9786982"],CD:["Clarke 1880","6378249.145","293.465"],EA:["Everest (India 1830)","6377276.345","300.8017"],EB:["Everest (Sabah & Sarawak)","6377298.556","300.8017"],EC:["Everest (India 1956)","6377301.243","300.8017"],ED:["Everest (W. Malaysia 1969)","6377295.664","300.8017"],EE:["Everest (W. Malaysia & Singapore 1948)","6377304.063","300.8017"],EF:["Everest (Pakistan)","6377309.613","300.8017"],FA:["Modified Fischer 1960","6378155","298.3"],HE:["Helmert 1906","6378200","298.3"],HO:["Hough 1960","6378270","297"],ID:["Indonesian 1974","6378160","298.247"],IN:["International 1924","6378388","297"],KA:["Krassovsky 1940","6378245","298.3"],RF:["Geodetic Reference System 1980 (GRS 80)","6378137","298.257222101"],SA:["South American 1969","6378160","298.25"],WD:["WGS 72","6378135","298.26"],WE:["WGS 84","6378137","298.257223563"]},fieldChanged:function(e){"point"!=e&&"geoSystem"!=e||this._parentNodes.forEach((function(e){e.fieldChanged("coord")}))},isLogitudeFirst:function(e){for(var t=0;t<e.length;++t)if("longitude_first"==e[t])return!0;return!1},getElipsoideCode:function(e){for(var t=0;t<e.length;++t){var i=e[t];if(this.elipsoideParameters[i])return i}return"WE"},getElipsoide:function(e){return this.elipsoideParameters[this.getElipsoideCode(e)]},getReferenceFrame:function(e){for(var t=0;t<e.length;++t){var i=e[t];if("GD"==i||"GDC"==i)return"GD";if("GC"==i||"GCC"==i)return"GC";if("UTM"==i)return"UTM";x3dom.debug.logError("Unknown GEO system: ["+e+"]")}return"GD"},getUTMZone:function(e){for(var t=0;t<e.length;++t){var i=e[t];if("Z"==i[0])return i.substring(1)}x3dom.debug.logError("no UTM zone but is required:"+e)},getUTMHemisphere:function(e){for(var t=0;t<e.length;++t){var i=e[t];if("S"==i)return i}return"N"},isUTMEastingFirst:function(e){for(var t=0;t<e.length;++t){if("easting_first"==e[t])return!0}return!1},UTMtoGC:function(e,t){var i=this.getUTMZone(e);if(i<1||i>60||void 0===i)return x3dom.debug.logError("invalid UTM zone: "+i+" in geosystem "+e);for(var s,o,n,r,a,d,h,l,f,u,_,c,m,p,x,v,g,y,S=this.getUTMHemisphere(e),T=this.isUTMEastingFirst(e),F=this.getElipsoide(e),b=F[1],C=b*(1-1/F[2]),M=1-C/b*(C/b),E=Math.sqrt(M),w=(Math.sqrt(1-M),M/(1-M)),A=3+6*(i-1)-180,D=(1-Math.sqrt(1-M))/(1+Math.sqrt(1-M)),N=D*D,R=new x3dom.fields.MFVec3f,I=180/Math.PI,P=1-M*(.25+M*(3/64+5/256*M)),V=D*(1.5-27/32*N),O=N*(21/16-55/32*N),L=0;L<t.length;++L)o=T?t[L].x:t[L].y,n=T?t[L].y:t[L].x,a=(r=("S"==S?n-1e7:n)/.9996/(b*P))+V*Math.sin(2*r)+O*Math.sin(4*r),a+=D*(N*(Math.sin(6*r)*(151/96)+Math.sin(8*r)*(1097/512))),h=w*(d=Math.cos(a))*d,u=(f=(l=Math.tan(a))*l)*f,c=1-(_=E*Math.sin(a))*_,g=(x=(p=(o-5e5)/(.9996*(m=b/Math.sqrt(c))))*p)*(.5-x*(5+3*f+10*h-4*(v=h*h)-9*w)/24),g=a-m*l/(m*(1-M)/c)*(g+=Math.pow(p,6)*(61+90*f+298*h+45*u-252*w-3*v)/720),y=p*(1+x*((-1-2*f-h)/6+x*(5-2*h+28*f-3*v+8*w+24*u)/120))/d,(s=new x3dom.fields.SFVec3f).x=A+I*y,s.y=I*g,s.z=t[L].z,R.push(s);var B=new x3dom.fields.MFString;return B.push("GD"),B.push(this.getElipsoideCode(e)),B.push("longitude_first"),this.GDtoGC(B,R)},GCtoUTM:function(e,t){var i=this.GCtoGD(e,t),s=this.getUTMZone(e);if(s<1||s>60||void 0===s)return x3dom.debug.logError("invalid UTM zone: "+s+" in geosystem "+e);var o,n,r,a,d,h,l,f,u,_,c,m,p,x,v=this.getUTMHemisphere(e),g=this.isUTMEastingFirst(e),y=this.getElipsoide(e),S=y[1],T=S*(1-1/y[2]),F=1-T/S*(T/S),b=Math.sqrt(F),C=F/(1-F),M=Math.PI/180,E=(3+6*(s-1)-180)*M,w=new x3dom.fields.MFVec3f,A=1-F*(1/4+F*(3/64+5*F/256)),D=F*(3/8+F*(3/32+45*F/1024)),N=F*F*(15/256+45*F/1024),R=F*F*F*(35/3072);for(p=0;p<i.length;++p)x=new x3dom.fields.SFVec3f,f=i[p].y*M,u=i[p].x*M,_=Math.cos(f),c=Math.tan(f),o=S/Math.sqrt(1-Math.pow(b*Math.sin(f),2)),n=Math.pow(c,2),r=C*Math.pow(_,2),a=(u-E)*_,d=f*A,d-=Math.sin(2*f)*D,d+=Math.sin(4*f)*N,d-=Math.sin(6*f)*R,h=.9996*o*a*(1+(m=a*a)*((1-n+r)/6+m*(5-n*(18+n)+72*r-58*C)/120)),h+=5e5,(l=.9996*((d*=S)-0+o*c*(m*(.5+m*((5-n+9*r+4*r*r)/24+m*(61-n*(58+n)+600*r-330*C)/720)))))<0&&("N"==v&&x3dom.debug.logError("UTM zone in northern hemisphere but coordinates in southern!"),l=1e7+l),x.x=g?h:l,x.y=g?l:h,x.z=i[p].z,w.push(x);return w},GDtoGC:function(e,t){var i,s,o,n,r,a,d,h,l,f=new x3dom.fields.MFVec3f,u=this.getElipsoide(e),_=u[1],c=u[2],m=this.isLogitudeFirst(e),p=1/c,x=_*(1-p),v=x*x/(_*_),g=p*(2-p);for(i=0;i<t.length;++i)s=new x3dom.fields.SFVec3f,o=.017453292519943295*(1==m?t[i].y:t[i].x),n=.017453292519943295*(1==m?t[i].x:t[i].y),a=(r=Math.sin(o))*r,d=Math.cos(o),l=(h=_/Math.sqrt(1-g*a))+t[i].z,s.x=l*d*Math.cos(n),s.y=l*d*Math.sin(n),s.z=(v*h+t[i].z)*r,f.push(s);return f},GCtoGD:function(e,t){var i,s,o,n,r,a,d,h,l,f,u,_=new x3dom.fields.MFVec3f,c=180/Math.PI,m=this.getElipsoide(e),p=m[1],x=p*(1-1/m[2]),v=1-x/p*(x/p),g=v/(1-v);for(i=0;i<t.length;++i)o=t[i].x,n=t[i].y,r=t[i].z,a=Math.sqrt(o*o+n*n),d=Math.atan(r*p/(a*x)),h=Math.atan((r+g*x*Math.pow(Math.sin(d),3))/(a-v*p*Math.pow(Math.cos(d),3))),l=p/Math.sqrt(1-v*Math.pow(Math.sin(h),2)),f=a/Math.cos(h)-l,u=Math.atan2(n,o),(s=new x3dom.fields.SFVec3f).x=u*c,s.y=h*c,s.z=f,_.push(s);return _},GEOtoGC:function(e,t,i){var s=this.getReferenceFrame(e);if("GD"==s)return this.GDtoGC(e,i);if("UTM"==s)return this.UTMtoGC(e,i);if("GC"==s){if(t.node){for(var o=new x3dom.fields.MFVec3f,n=0;n<i.length;++n){var r=new x3dom.fields.SFVec3f;r.x=i[n].x,r.y=i[n].y,r.z=i[n].z,o.push(r)}return o}return i}return x3dom.debug.logError("Unknown geoSystem: "+e[0]),new x3dom.fields.MFVec3f},GCtoGEO:function(e,t,i){var s=this.getReferenceFrame(e);if("GD"==s){var o=this.GCtoGD(e,i);if(!this.isLogitudeFirst(e))for(var n,r=0;r<o.length;++r)n=o[r].x,o[r].x=o[r].y,o[r].y=n;return o}if("UTM"==s)return this.GCtoUTM(e,i);if("GC"==s){if(t.node){var a=new x3dom.fields.MFVec3f;for(r=0;r<i.length;++r){var d=new x3dom.fields.SFVec3f;d.x=i[r].x,d.y=i[r].y,d.z=i[r].z,a.push(d)}return a}return i}return x3dom.debug.logError("Unknown geoSystem: "+e[0]),new x3dom.fields.MFVec3f},OriginToGC:function(e){var t=e.node._vf.geoCoords,i=e.node._vf.geoSystem,s=new x3dom.fields.SFVec3f;s.x=t.x,s.y=t.y,s.z=t.z;var o=new x3dom.fields.MFVec3f;return o.push(s),this.GEOtoGC(i,e,o)[0]},GCtoX3D:function(e,t,i){var s=i;if(t.node){var o=this.OriginToGC(t),n=x3dom.fields.SFMatrix4f.translation(o.negate());if(t.node._vf.rotateYUp)n=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(e,o).inverse().mult(n);for(var r=0;r<i.length;++r)s[r]=n.multMatrixPnt(i[r])}return s},GEOtoX3D:function(e,t,i){var s=this.GEOtoGC(e,t,i);return this.GCtoX3D(e,t,s)},getPoints:function(){return this.GEOtoX3D(this._vf.geoSystem,this._cf.geoOrigin,this._vf.point)}})),x3dom.registerNodeType("GeoElevationGrid","Geospatial",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.GeoElevationGrid.superClass.call(this,e),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFVec3f(e,"geoGridOrigin",0,0,0),this.addField_MFDouble(e,"height",0,0),this.addField_SFBool(e,"ccw",!0),this.addField_SFDouble(e,"creaseAngle",0),this.addField_SFInt32(e,"xDimension",0),this.addField_SFDouble(e,"xSpacing",1),this.addField_SFFloat(e,"yScale",1),this.addField_SFInt32(e,"zDimension",0),this.addField_SFDouble(e,"zSpacing",1),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this.addField_SFBool(e,"lit",!0)}),{nodeChanged:function(){var e=this._vf.geoSystem,t=this._cf.geoOrigin,i=this._vf.height,s=this._vf.yScale,o=this._vf.xDimension,n=this._vf.zDimension,r=this._vf.xSpacing,a=this._vf.zSpacing,d=this._vf.geoGridOrigin;i.length!==o*n&&x3dom.debug.logError("GeoElevationGrid: height.length("+i.length+") != x/zDimension("+o+"*"+n+")");var h,l=x3dom.nodeTypes.GeoCoordinate.prototype.isLogitudeFirst(e),f=x3dom.nodeTypes.GeoCoordinate.prototype.isUTMEastingFirst(e),u=this._vf.ccw,_=1/(o-1),c=1/(n-1),m=2,p=this._cf.texCoord.node;x3dom.isa(p,x3dom.nodeTypes.MultiTextureCoordinate)&&p._cf.texCoord.nodes.length&&(p=p._cf.texCoord.nodes[0]),p&&p._vf.point&&(h=p._vf.point,x3dom.isa(p,x3dom.nodeTypes.TextureCoordinate3D)&&(m=3));for(var x=new x3dom.fields.MFVec3f,v=new x3dom.fields.MFVec2f,g=0;g<n;++g)for(var y=0;y<o;++y){var S=new x3dom.fields.SFVec2f;S.x=y*_,S.y=g*c,v.push(S);var T=new x3dom.fields.SFVec3f;l||f?(T.x=y*r,T.y=g*a):(T.x=g*a,T.y=y*r),T.z=i[g*o+y]*s,T=T.add(d),x.push(T)}var F=new x3dom.fields.MFInt32;for(g=0;g<n-1;g++)for(y=0;y<o-1;y++){var b=y+g*o,C=y+g*o+1,M=y+(g+1)*o+1,E=y+(g+1)*o;u?(F.push(b),F.push(C),F.push(M),F.push(b),F.push(M),F.push(E)):(F.push(b),F.push(E),F.push(M),F.push(b),F.push(M),F.push(C))}var w=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(e,t,x);if(this._vf.creaseAngle<=x3dom.fields.Eps){var A=this;!function(){var e=new x3dom.fields.MFInt32,t=new x3dom.fields.MFVec3f,i=new x3dom.fields.MFVec2f;h?A.generateNonIndexedTriangleData(F,w,null,h,null,t,null,i,null):A.generateNonIndexedTriangleData(F,w,null,v,null,t,null,i,null);for(var s=0;s<t.length;++s)e.push(s);A._mesh._indices[0]=e.toGL(),A._mesh._positions[0]=t.toGL(),A._mesh._texCoords[0]=i.toGL(),A._mesh._numTexComponents=2}(),this._mesh.calcNormals(0)}else this._mesh._indices[0]=F.toGL(),this._mesh._positions[0]=w.toGL(),this._mesh._texCoords[0]=h?h.toGL():v.toGL(),this._mesh._numTexComponents=m,this._mesh.calcNormals(Math.PI);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},generateNonIndexedTriangleData:function(e,t,i,s,o,n,r,a,d){for(var h=0;h<e.length;h+=3){var l=e[h],f=e[h+1],u=e[h+2];if(t){var _=new x3dom.fields.SFVec3f,c=new x3dom.fields.SFVec3f,m=new x3dom.fields.SFVec3f;_.setValues(t[l]),c.setValues(t[f]),m.setValues(t[u]),n.push(_),n.push(c),n.push(m)}if(i){var p=new x3dom.fields.SFVec3f,x=new x3dom.fields.SFVec3f,v=new x3dom.fields.SFVec3f;p.setValues(i[l]),x.setValues(i[f]),v.setValues(i[u]),r.push(p),r.push(x),r.push(v)}if(s){var g=new x3dom.fields.SFVec2f,y=new x3dom.fields.SFVec2f,S=new x3dom.fields.SFVec2f;g.setValues(s[l]),y.setValues(s[f]),S.setValues(s[u]),a.push(g),a.push(y),a.push(S)}if(o){var T=new x3dom.fields.SFVec3f,F=new x3dom.fields.SFVec3f,b=new x3dom.fields.SFVec3f;T.setValues(s[l]),F.setValues(s[f]),F.setValues(s[u]),d.push(T),d.push(F),d.push(b)}}}})),x3dom.registerNodeType("GeoLOD","Geospatial",defineClass(x3dom.nodeTypes.X3DBoundedObject,(function(e){x3dom.nodeTypes.GeoLOD.superClass.call(this,e),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_MFString(e,"rootUrl",[]),this.addField_MFString(e,"child1Url",[]),this.addField_MFString(e,"child2Url",[]),this.addField_MFString(e,"child3Url",[]),this.addField_MFString(e,"child4Url",[]),this.addField_SFFloat(e,"range",10),this.addField_SFInt32(e,"level_changed",0),this.addField_SFString(e,"referenceBindableDescription",[]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this.addField_MFNode("rootNode",x3dom.nodeTypes.X3DChildNode),this.addField_SFVec3f(e,"center",0,0,0),this._eye=new x3dom.fields.SFVec3f(0,0,0),this._x3dcenter=new x3dom.fields.SFVec3f(0,0,0),this._child1added=!1,this._child2added=!1,this._child3added=!1,this._child4added=!1,this._rootNodeLoaded=!0,this._childUrlNodes=new x3dom.fields.MFNode(x3dom.nodeTypes.X3DChildNode),this._lastRangePos=-1}),{collectDrawableObjects:function(e,t,i,s,o,n){i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),(o=t.cull(e,this.graphState(),i,o))<=0||(i=!1,this.visitChildren(e,t,i,s,o,n))},visitChildren:function(e,t,i,s,o,n){var r,a,d,h=0,l=t.viewMatrix,f=new x3dom.fields.SFVec3f(0,0,0);if(f=l.inverse().multMatrixPnt(f),this._eye=e.inverse().multMatrixPnt(f),this._x3dcenter.subtract(this._eye).length()>this._vf.range?(h=0,this._rootNodeLoaded||(this._rootNodeLoaded=!0),a=this._cf.rootNode.nodes):(h=1,this._child1added||(this._child1added=!0,this.addInlineChild(this._vf.child1Url)),this._child2added||(this._child2added=!0,this.addInlineChild(this._vf.child2Url)),this._child3added||(this._child3added=!0,this.addInlineChild(this._vf.child3Url)),this._child4added||(this._child4added=!0,this.addInlineChild(this._vf.child4Url)),this._rootNodeLoaded&&(this._rootNodeLoaded=!1),a=this._childUrlNodes.nodes),h!==this._lastRangePos&&this.postMessage("level_changed",h),this._lastRangePos=h,(r=a.length)&&a){var u=this.transformMatrix(e);for(h=0;h<r;h++)(d=a[h])&&d.collectDrawableObjects(u,t,i,s,o,n)}},addInlineChild:function(e){var t=this.newInlineNode(e);this._childUrlNodes.addLink(t)},newInlineNode:function(e){var t=new x3dom.nodeTypes.Inline;return t._vf.url=e,t._nameSpace=this._nameSpace,x3dom.debug.logInfo("add url: "+e),t.nodeChanged(),t},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag())for(var t,i,s=0,o=this._childNodes.length;s<o;s++)!(t=this._childNodes[s])||t.renderFlag&&!0!==t.renderFlag()||(i=t.getVolume())&&i.isValid()&&e.extendBounds(i.min,i.max);return e},nodeChanged:function(){var e=new x3dom.fields.MFVec3f;if(e.push(this._vf.center),this._x3dcenter=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(this._vf.geoSystem,this._cf.geoOrigin,e)[0],!this._cf.rootNode.nodes.length){var t=this.newInlineNode(this._vf.rootUrl);this._cf.rootNode.addLink(t)}this.invalidateVolume()},fieldChanged:function(e){if("render"!=e&&"range"!=e||this.invalidateVolume(),"center"==fieldname){var t=new x3dom.fields.MFVec3f;t.push(this._vf.center),this._x3dcenter=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(this._vf.geoSystem,this._cf.geoOrigin,t)[0],this.invalidateVolume()}}})),x3dom.registerNodeType("GeoLocation","Geospatial",defineClass(x3dom.nodeTypes.X3DTransformNode,(function(e){x3dom.nodeTypes.GeoLocation.superClass.call(this,e),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFVec3d(e,"geoCoords",0,0,0),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin)}),{nodeChanged:function(){var e=this._vf.geoCoords,t=this._vf.geoSystem,i=this._cf.geoOrigin;this._trafo=this.getGeoTransRotMat(t,i,e)},getGeoRotMat:function(e,t){var i=new x3dom.fields.MFVec3f;i.push(t);var s=x3dom.nodeTypes.GeoCoordinate.prototype.GCtoGD(e,i)[0],o=new x3dom.fields.SFVec3f(1,0,0),n=180-s.y,r=Math.PI/180,a=x3dom.fields.Quaternion.axisAngle(o,n*r),d=new x3dom.fields.SFVec3f(0,0,1),h=90+s.x;return x3dom.fields.Quaternion.axisAngle(d,h*r).multiply(a).toMatrix()},getGeoTransRotMat:function(e,t,i){var s=new x3dom.fields.MFVec3f;s.push(i);var o=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoGC(e,t,s)[0],n=this.getGeoRotMat(e,o);if(t.node){var r=x3dom.nodeTypes.GeoCoordinate.prototype.OriginToGC(t);return t.node._vf.rotateYUp?this.getGeoRotMat(e,r).inverse().mult(x3dom.fields.SFMatrix4f.translation(o.subtract(r)).mult(n)):x3dom.fields.SFMatrix4f.translation(o.subtract(r)).mult(n)}return x3dom.fields.SFMatrix4f.translation(o).mult(n)},fieldChanged:function(e){if("geoSystem"==e||"geoCoords"==e||"geoOrigin"==e){var t=this._vf.geoCoords,i=this._vf.geoSystem,s=this._cf.geoOrigin;this._trafo=this.getGeoTransRotMat(i,s,t),this.invalidateVolume()}else"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("GeoMetadata","Geospatial",defineClass(x3dom.nodeTypes.X3DInfoNode,(function(e){x3dom.nodeTypes.GeoMetadata.superClass.call(this,e),this.addField_MFString(e,"url",[]),this.addField_MFNode("data",x3dom.nodeTypes.X3DInfoNode),this.addField_MFString(e,"summary",[])}))),x3dom.registerNodeType("GeoOrigin","Geospatial",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.GeoOrigin.superClass.call(this,e),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFVec3d(e,"geoCoords",0,0,0),this.addField_SFBool(e,"rotateYUp",!1)}))),x3dom.registerNodeType("GeoPositionInterpolator","Geospatial",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,(function(e){x3dom.nodeTypes.GeoPositionInterpolator.superClass.call(this,e),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_MFVec3f(e,"keyValue",[]),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this.addField_SFBool(e,"onGreatCircle",!1)}),{linearInterpHintKeyValue:function(e,t,i,s,o){var n=i.length;if(e<=i[0])return[0,s[0]];if(e>=i[n-1])return[n-1,s[n-1]];for(var r,a=t,d=0;d<n-1;++d){if(i[r=(a+d)%n]<e&&e<=i[r+1])return[r,o(s[r],s[r+1],(e-i[r])/(i[r+1]-i[r]))];if(i[r=(a-d+n)%n]<e&&e<=i[r+1])return[r,o(s[r],s[r+1],(e-i[r])/(i[r+1]-i[r]))]}return[0,s[0]]},slerp:function(e,t,i){var s,o,n,r=e.dot(t)/(e.length()*t.length());if(s=new x3dom.fields.SFVec3f(t.x,t.y,t.z),1-r>1e-5){var a=Math.acos(r),d=Math.sin(a);o=Math.sin((1-i)*a)/d,n=Math.sin(i*a)/d}else o=1-i,n=i;return e.multiply(o).add(s.multiply(n))},nodeChanged:function(){this._keyValueGC=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoGC(this._vf.geoSystem,this._cf.geoOrigin,this._vf.keyValue),this._keyHint=0},fieldChanged:function(e){if("set_fraction"===e){var t,i,s,o,n;this._vf.onGreatCircle?(i=this.linearInterpHintKeyValue(this._vf.set_fraction,this._keyHint,this._vf.key,this._keyValueGC,x3dom.nodeTypes.GeoPositionInterpolator.prototype.slerp),this._keyHint=i[0],s=i[1],(n=new x3dom.fields.MFVec3f).push(s),t=x3dom.nodeTypes.GeoCoordinate.prototype.GCtoGEO(this._vf.geoSystem,this._cf.geoOrigin,n)[0]):(i=this.linearInterpHintKeyValue(this._vf.set_fraction,this._keyHint,this._vf.key,this._vf.keyValue,(function(e,t,i){return e.multiply(1-i).add(t.multiply(i))})),this._keyHint=i[0],t=i[1],(n=new x3dom.fields.MFVec3f).push(t),s=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoGC(this._vf.geoSystem,this._cf.geoOrigin,n)[0]),(n=new x3dom.fields.MFVec3f).push(s);var r=new x3dom.fields.MFString;r.push("GC"),r.push(x3dom.nodeTypes.GeoCoordinate.prototype.getElipsoideCode(this._vf.geoSystem)),o=x3dom.nodeTypes.GeoCoordinate.prototype.GCtoX3D(r,this._cf.geoOrigin,n)[0],this.postMessage("value_changed",o),this.postMessage("geovalue_changed",t)}}})),x3dom.registerNodeType("GeoTransform","Geospatial",defineClass(x3dom.nodeTypes.X3DTransformNode,(function(e){x3dom.nodeTypes.GeoTransform.superClass.call(this,e),this.addField_SFVec3d(e,"geoCenter",0,0,0),this.addField_SFRotation(e,"rotation",0,0,1,0),this.addField_SFVec3f(e,"scale",1,1,1),this.addField_SFRotation(e,"scaleOrientation",0,0,1,0),this.addField_SFVec3f(e,"translation",0,0,0),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFBool(e,"globalGeoOrigin",!1)}),{nodeChanged:function(){this._trafo=this.getGeoTransform()},getGeoTransform:function(){var e,t,i,s,o,n,r,a,d;if(a=this._vf.geoSystem,d=this._cf.geoOrigin,t=this._vf.geoCenter,i=this._vf.globalGeoOrigin,s=this._vf.scaleOrientation.toMatrix(),(n=new x3dom.fields.MFVec3f).push(t),r=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoGC(a,d,n)[0],e=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(a,r),o=x3dom.fields.SFMatrix4f.translation(r).mult(e).mult(x3dom.fields.SFMatrix4f.translation(this._vf.translation)).mult(this._vf.rotation.toMatrix()).mult(s).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(s.inverse()).mult(e.inverse()).mult(x3dom.fields.SFMatrix4f.translation(r.negate())),d.node){var h=x3dom.nodeTypes.GeoCoordinate.prototype.OriginToGC(d);if(i||(o=o.mult(x3dom.fields.SFMatrix4f.translation(h))),d.node._vf.rotateYUp){var l=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(a,h);i||(o=o.mult(l))}o=x3dom.fields.SFMatrix4f.translation(h.negate()).mult(o),d.node._vf.rotateYUp&&(o=l.inverse().mult(o))}return o},fieldChanged:function(e){"geoCenter"==e||"translation"==e||"rotation"==e||"scale"==e||"scaleOrientation"==e?(this._trafo=this.getGeoTransform(),this.invalidateVolume()):"render"==e&&this.invalidateVolume()}})),x3dom.registerNodeType("GeoViewpoint","Geospatial",defineClass(x3dom.nodeTypes.X3DViewpointNode,(function(e){x3dom.nodeTypes.GeoViewpoint.superClass.call(this,e),this.addField_MFString(e,"geoSystem",["GD","WE"]),this.addField_SFFloat(e,"fieldOfView",.785398),this.addField_SFRotation(e,"orientation",0,0,1,0),this.addField_SFVec3f(e,"centerOfRotation",0,0,0),this.addField_SFVec3d(e,"position",0,0,1e5),this.addField_SFBool(e,"headlight",void 0),this.addField_MFString(e,"navType",void 0),this.addField_SFFloat(e,"speedFactor",1),this.addField_SFFloat(e,"zNear",-1),this.addField_SFFloat(e,"zFar",-1),this.addField_SFBool(e,"elevationScaling",!0),this.addField_SFNode("geoOrigin",x3dom.nodeTypes.GeoOrigin),this._geoCenterOfRotation=this._vf.centerOfRotation,this._viewMatrix=x3dom.fields.SFMatrix4f.identity()}),{activate:function(e){var t=this._nameSpace.doc._viewarea;e&&t.animateTo(this,e._autoGen?null:e),t._needNavigationMatrixUpdate=!0,x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,e);var i=t._scene.getNavigationInfo();this._initSpeed=i._vf.speed,this._examineSpeed=i._vf.speed,this._lastSpeed=i._vf.speed,this._userSpeedFactor=1,this._lastNavType=i.getType(),x3dom.debug.logInfo("initial navigation speed: "+this._initSpeed),void 0!==this._vf.headlight&&(i._vf.headlight=this._vf.headlight),void 0!==this._vf.navType&&(i._vf.navType=this._vf.navType)},deactivate:function(e){this._nameSpace.doc._viewarea._scene.getNavigationInfo()._vf.speed=this._examineSpeed,x3dom.debug.logInfo("navigation speed restored to: "+this._examineSpeed),x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,e)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this),this._geoOrigin=this._cf.geoOrigin,this._geoSystem=this._vf.geoSystem,this._position=this._vf.position,this._orientation=this._vf.orientation,this._viewMatrix=this.getInitViewMatrix(this._orientation,this._geoSystem,this._geoOrigin,this._position),this._vf.centerOfRotation=this.getGeoCenterOfRotation(this._geoSystem,this._geoOrigin,this._geoCenterOfRotation),this._projMatrix=null,this._lastAspect=1,this._zRatio=1e4,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)},fieldChanged:function(e){"position"==e||"orientation"==e?this.resetView():"fieldOfView"==e||"zNear"==e||"zFar"==e?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):e.indexOf("bind")>=0&&this.bind(this._vf.bind)},setProjectionMatrix:function(e){this._projMatrix=e},getCenterOfRotation:function(){return this.getCurrentTransform().multMatrixPnt(this._vf.centerOfRotation)},getGeoCenterOfRotation:function(e,t,i){var s=new x3dom.fields.MFVec3f;return s.push(i),x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(e,t,s)[0]},isExamineMode:function(e){return"examine"==e||"turntable"==e||"lookaround"==e||"lookat"==e},getViewMatrix:function(){if(this._vf.isActive&&this._vf.elevationScaling){var e=this._nameSpace.doc._viewarea,t=e._scene.getNavigationInfo(),i=t.getType();if(this.isExamineMode(i))this.isExamineMode(this._lastNavType)||(t._vf.speed=this._examineSpeed),this._lastNavType=i;else{this.isExamineMode(this._lastNavType)&&(this._examineSpeed=t._vf.speed,x3dom.debug.logInfo("back from examine mode, resume speed: "+this._lastSpeed),t._vf.speed=this._lastSpeed),this._lastNavType=i,t._vf.speed!=this._lastSpeed&&(this._userSpeedFactor*=t._vf.speed/this._lastSpeed,x3dom.debug.logInfo("interactive speed factor changed: "+this._userSpeedFactor));var s=e._scene.getViewpoint().getCurrentTransform(),o=(s=s.inverse().mult(this._viewMatrix)).inverse().e3(),n=this._geoOrigin,r=this._geoSystem,a=o;if(n.node){var d=x3dom.nodeTypes.GeoCoordinate.prototype.OriginToGC(n);if(n.node._vf.rotateYUp)a=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(r,d).multMatrixPnt(o);a=a.add(d)}var h=new x3dom.fields.MFVec3f;h.push(a);var l=x3dom.nodeTypes.GeoCoordinate.prototype.GCtoGD(r,h)[0],f=Math.abs(l.z/10);f=f>1?f:1,t._vf.speed=f*this._vf.speedFactor*this._userSpeedFactor,this._lastSpeed=t._vf.speed}}return this._viewMatrix},getInitViewMatrix:function(e,t,i,s){var o=new x3dom.fields.MFVec3f;o.push(s);var n=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoGC(t,i,o)[0],r=e.toMatrix(),a=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(t,n).mult(r);if(i.node&&i.node._vf.rotateYUp){var d=x3dom.nodeTypes.GeoCoordinate.prototype.OriginToGC(i);a=x3dom.nodeTypes.GeoLocation.prototype.getGeoRotMat(t,d).inverse().mult(a)}var h=x3dom.nodeTypes.GeoCoordinate.prototype.GEOtoX3D(t,i,o)[0];return x3dom.fields.SFMatrix4f.translation(h).mult(a).inverse()},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=this.getInitViewMatrix(this._vf.orientation,this._vf.geoSystem,this._cf.geoOrigin,this._vf.position),this._vf.centerOfRotation=this.getGeoCenterOfRotation(this._vf.geoSystem,this._cf.geoOrigin,this._geoCenterOfRotation),this._nameSpace.doc._viewarea&&this._nameSpace.doc._viewarea.resetNavHelpers()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(e){var t=this._vf.fieldOfView,i=this._vf.zFar,s=this._vf.zNear;if(s<=0||i<=0){var o=.8,n=1.2,r=this._nameSpace.doc._viewarea,a=r._scene,d=x3dom.fields.SFVec3f.copy(a._lastMin),h=x3dom.fields.SFVec3f.copy(a._lastMax).subtract(d),l=h.length()/2,f=r.getViewMatrix().inverse(),u=f.e3(),_=new x3dom.fields.SFVec3f(0,0,0),c=new x3dom.fields.SFVec3f(1,1,1),m=new x3dom.fields.Quaternion(0,0,1,0),p=new x3dom.fields.Quaternion(0,0,1,0);f.getTransform(_,m,c,p);var x=c.x,v=c.x;v<c.y&&(v=c.y),x>c.y&&(x=c.y),v<c.z&&(v=c.z),x>c.z&&(x=c.z),v>1?o/=v:x>x3dom.fields.Eps&&x<1&&(n/=x);var g=d.add(h.multiply(.5)),y=u.subtract(g).length();l?(s=y>l?(y-l)*o:0,i=(y+l)*n):(s=.1,i=1e5);var S=i/this._zRatio;s=Math.max(s,Math.max(x3dom.fields.Eps,S)),i>this._vf.zNear&&this._vf.zNear>0&&(s=this._vf.zNear),this._vf.zFar>s&&(i=this._vf.zFar),i<=s&&(i=s+1)}if(null==this._projMatrix)this._projMatrix=x3dom.fields.SFMatrix4f.perspective(t,e,s,i);else if(this._zNear!=s||this._zFar!=i){var T=s-i;this._projMatrix._22=(s+i)/T,this._projMatrix._23=2*s*i/T}else this._lastAspect!=e&&(this._projMatrix._00=1/Math.tan(t/2)/e,this._lastAspect=e);return this._zNear=s,this._zFar=i,this._projMatrix}})),x3dom.registerNodeType("ScreenGroup","Layout",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.ScreenGroup.superClass.call(this,e)}),{collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){var r,a,d,h,l,f,u,_,c,m;i=!1,a=(r=this._nameSpace.doc)._scene.getViewpoint(),h=r._x3dElem.clientHeight/a.getImgPlaneHeightAtDistOne(),f=e,l=new x3dom.fields.SFVec3f(0,0,-1),u=d=new x3dom.fields.SFVec3f(0,0,0),_=t.viewMatrix.multMatrixPnt(f.multMatrixPnt(d)).subtract(u),c=l.dot(_)/h,m=x3dom.fields.SFMatrix4f.scale(new x3dom.fields.SFVec3f(c,c,c));for(var p=this.transformMatrix(f.mult(m)),x=0,v=this._childNodes.length;x<v;x++){var g=this._childNodes[x];g&&g.collectDrawableObjects(p,t,i,s,o,n)}}}})),x3dom.registerNodeType("X3DPlanarGeometryNode","Geometry2D",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.X3DPlanarGeometryNode.superClass.call(this,e)}))),x3dom.registerNodeType("Arc2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Arc2D.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"startAngle",0),this.addField_SFFloat(e,"endAngle",Math.PI/2),this.addField_SFFloat(e,"subdivision",32),this._mesh._primType="LINES";var t=this._vf.radius,i=this._vf.startAngle,s=this._vf.endAngle,o=2*Math.PI;i-=Math.floor(i/o)*o,(s-=Math.floor(s/o)*o)<=i&&(s+=o);var n="Arc2D_"+t+i+s;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[n])this._mesh=x3dom.geoCache[n];else{for(var r=this._vf.subdivision,a=(s-i)/r,d=i,h=0;h<=r+1;h++){var l=Math.cos(d)*t,f=Math.sin(d)*t;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),d+=a}for(var u=0;u<r;u++)this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[n]=this._mesh}}),{fieldChanged:function(e){if("radius"==e||"subdivision"==e||"startAngle"==e||"endAngle"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[];var t=this._vf.radius,i=this._vf.startAngle,s=this._vf.endAngle,o=this._vf.subdivision,n=2*Math.PI;i-=Math.floor(i/n)*n,(s-=Math.floor(s/n)*n)<=i&&(s+=n);for(var r=(s-i)/o,a=i,d=0;d<=o+1;d++){var h=Math.cos(a)*t,l=Math.sin(a)*t;this._mesh._positions[0].push(h),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),a+=r}for(var f=0;f<o;f++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()}))}}})),x3dom.registerNodeType("ArcClose2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.ArcClose2D.superClass.call(this,e),this.addField_SFString(e,"closureType","PIE"),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"startAngle",0),this.addField_SFFloat(e,"endAngle",Math.PI/2),this.addField_SFFloat(e,"subdivision",32);var t=this._vf.radius,i=this._vf.startAngle,s=this._vf.endAngle,o=this._vf.subdivision,n=this._vf.ccw,r=2*Math.PI;i-=Math.floor(i/r)*r,(s-=Math.floor(s/r)*r)<=i&&(s+=r);var a=["ArcClose2D",t,i,s,this._vf.closureType,o,n].join("-");if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[a])this._mesh=x3dom.geoCache[a];else{var d=(s-i)/o,h=i,l=n?1:-1;if("PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*l),this._mesh._texCoords[0].push(.5),this._mesh._texCoords[0].push(.5);for(var f=0;f<=o;f++){var u=Math.cos(h)*t,_=Math.sin(h)*t;this._mesh._positions[0].push(u),this._mesh._positions[0].push(_),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*l),this._mesh._texCoords[0].push((u+t)/(2*t)),this._mesh._texCoords[0].push((_+t)/(2*t)),h+=d}for(var c=1;c<=o;c++)this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(0),this._mesh._indices[0].push(c)}else{for(f=0;f<=o;f++){u=Math.cos(h)*t,_=Math.sin(h)*t;this._mesh._positions[0].push(u),this._mesh._positions[0].push(_),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*l),this._mesh._texCoords[0].push((u+t)/(2*t)),this._mesh._texCoords[0].push((_+t)/(2*t)),h+=d}u=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,_=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(u),this._mesh._positions[0].push(_),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*l),this._mesh._texCoords[0].push((u+t)/(2*t)),this._mesh._texCoords[0].push((_+t)/(2*t));for(c=0;c<o;c++)this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(o+1),this._mesh._indices[0].push(c)}this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[a]=this._mesh}}),{fieldChanged:function(e){var t=this._vf.radius,i=this._vf.startAngle,s=this._vf.endAngle,o=this._vf.subdivision,n=this._vf.ccw,r=2*Math.PI;i-=Math.floor(i/r)*r,(s-=Math.floor(s/r)*r)<=i&&(s+=r);var a=(s-i)/o,d=i;if("radius"===e){if(this._mesh._positions[0]=[],"PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0);for(var h=0;h<=o;h++){var l=Math.cos(d)*t,f=Math.sin(d)*t;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),d+=a}}else{for(h=0;h<=o;h++){l=Math.cos(d)*t,f=Math.sin(d)*t;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),d+=a}l=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,f=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0)}this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}else if("closureType"==e||"subdivision"==e||"startAngle"==e||"endAngle"==e){if(this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],"PIE"==this._vf.closureType.toUpperCase()){this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*n),this._mesh._texCoords[0].push(.5),this._mesh._texCoords[0].push(.5);for(h=0;h<=o;h++){l=Math.cos(d)*t,f=Math.sin(d)*t;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*n),this._mesh._texCoords[0].push((l+t)/(2*t)),this._mesh._texCoords[0].push((f+t)/(2*t)),d+=a}for(var u=1;u<=o;u++)this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(0),this._mesh._indices[0].push(u)}else{for(h=0;h<=o;h++){l=Math.cos(d)*t,f=Math.sin(d)*t;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*n),this._mesh._texCoords[0].push((l+t)/(2*t)),this._mesh._texCoords[0].push((f+t)/(2*t)),d+=a}l=(this._mesh._positions[0][0]+this._mesh._positions[0][this._mesh._positions[0].length-3])/2,f=(this._mesh._positions[0][1]+this._mesh._positions[0][this._mesh._positions[0].length-2])/2;this._mesh._positions[0].push(l),this._mesh._positions[0].push(f),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*n),this._mesh._texCoords[0].push((l+t)/(2*t)),this._mesh._texCoords[0].push((f+t)/(2*t));for(u=0;u<o;u++)this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(o+1),this._mesh._indices[0].push(u)}this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty()}))}}})),x3dom.registerNodeType("Circle2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Circle2D.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"subdivision",32),this._mesh._primType="LINES";var t=this._vf.radius,i="Circle2D_"+t;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[i])this._mesh=x3dom.geoCache[i];else{for(var s=this._vf.subdivision,o=0;o<=s;o++){var n=o*(2*Math.PI/s),r=Math.cos(n)*t,a=Math.sin(n)*t;this._mesh._positions[0].push(r),this._mesh._positions[0].push(a),this._mesh._positions[0].push(0)}for(o=0;o<s;o++)this._mesh._indices[0].push(o),o+1==s?this._mesh._indices[0].push(0):this._mesh._indices[0].push(o+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[i]=this._mesh}}),{fieldChanged:function(e){if("radius"==e||"subdivision"==e){var t=this._vf.radius,i=this._vf.subdivision;this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var s=0;s<=i;s++){var o=s*(2*Math.PI/i),n=Math.cos(o)*t,r=Math.sin(o)*t;this._mesh._positions[0].push(n),this._mesh._positions[0].push(r),this._mesh._positions[0].push(0)}for(s=0;s<i;s++)this._mesh._indices[0].push(s),s+1==i?this._mesh._indices[0].push(0):this._mesh._indices[0].push(s+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()}))}}})),x3dom.registerNodeType("Disk2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Disk2D.superClass.call(this,e),this.addField_SFFloat(e,"innerRadius",0),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFFloat(e,"subdivision",32);var t=this._vf.innerRadius,i=this._vf.outerRadius,s=this._vf.subdivision,o=this._vf.ccw,n=["Disk2D",t,i,s,o].join("-");if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[n])this._mesh=x3dom.geoCache[n];else{for(var r=o?1:-1,a=0;a<=s;a++){var d=a*(2*Math.PI/s),h=Math.cos(d)*i,l=Math.sin(d)*i,f=Math.cos(d)*t,u=Math.sin(d)*t;this._mesh._positions[0].push(h),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*r),this._mesh._texCoords[0].push((h+i)/(2*i)),this._mesh._texCoords[0].push((l+i)/(2*i)),this._mesh._positions[0].push(f),this._mesh._positions[0].push(u),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*r),this._mesh._texCoords[0].push((f+i)/(2*i)),this._mesh._texCoords[0].push((u+i)/(2*i))}for(a=0;a<2*s;a+=2)a==2*s-2?(this._mesh._indices[0].push(a+1),this._mesh._indices[0].push(a),this._mesh._indices[0].push(1),this._mesh._indices[0].push(1),this._mesh._indices[0].push(a),this._mesh._indices[0].push(0)):(this._mesh._indices[0].push(a+1),this._mesh._indices[0].push(a),this._mesh._indices[0].push(a+3),this._mesh._indices[0].push(a+3),this._mesh._indices[0].push(a),this._mesh._indices[0].push(a+2));this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[n]=this._mesh}}),{fieldChanged:function(e){var t=this._vf.ccw?1:-1;if("innerRadius"==e||"outerRadius"==e||"subdivision"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];for(var i=this._vf.innerRadius,s=this._vf.outerRadius,o=this._vf.subdivision,n=0;n<=o;n++){var r=n*(2*Math.PI/o),a=Math.cos(r)*s,d=Math.sin(r)*s,h=Math.cos(r)*i,l=Math.sin(r)*i;this._mesh._positions[0].push(a),this._mesh._positions[0].push(d),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*t),this._mesh._texCoords[0].push((a+s)/(2*s)),this._mesh._texCoords[0].push((d+s)/(2*s)),this._mesh._positions[0].push(h),this._mesh._positions[0].push(l),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1*t),this._mesh._texCoords[0].push((h+s)/(2*s)),this._mesh._texCoords[0].push((l+s)/(2*s))}for(n=0;n<2*o;n+=2)n==2*o-2?(this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(1),this._mesh._indices[0].push(1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(0)):(this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+3),this._mesh._indices[0].push(n+3),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+2));this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty()}))}}})),x3dom.registerNodeType("Polyline2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Polyline2D.superClass.call(this,e),this.addField_MFVec2f(e,"lineSegments",[]),this._mesh._primType="LINES";var t=0,i=0;this._vf.lineSegments.length&&(t=this._vf.lineSegments[0].x,i=this._vf.lineSegments[0].y);var s="Polyline2D_"+t+"-"+i;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[s])this._mesh=x3dom.geoCache[s];else{for(var o=0;o<this._vf.lineSegments.length;o++)t=this._vf.lineSegments[o].x,i=this._vf.lineSegments[o].y,this._mesh._positions[0].push(t),this._mesh._positions[0].push(i),this._mesh._positions[0].push(0);for(var n=0;n<this._vf.lineSegments.length-1;n++)this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[s]=this._mesh}}),{fieldChanged:function(e){if("lineSegments"==e){var t,i;this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var s=0;s<this._vf.lineSegments.length;s++)t=this._vf.lineSegments[s].x,i=this._vf.lineSegments[s].y,this._mesh._positions[0].push(t),this._mesh._positions[0].push(i),this._mesh._positions[0].push(0);for(var o=0;o<this._vf.lineSegments.length-1;o++)this._mesh._indices[0].push(o),this._mesh._indices[0].push(o+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/2,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e._dirty.indexes=!0,e.invalidateVolume()}))}}})),x3dom.registerNodeType("Polypoint2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Polypoint2D.superClass.call(this,e),this.addField_MFVec2f(e,"point",[]),this._mesh._primType="POINTS";var t=0,i=0;this._vf.point.length&&(t=this._vf.point[0].x,i=this._vf.point[0].y);var s="Polypoint2D_"+t+"-"+i;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[s])this._mesh=x3dom.geoCache[s];else{for(var o=0;o<this._vf.point.length;o++)t=this._vf.point[o].x,i=this._vf.point[o].y,this._mesh._positions[0].push(t),this._mesh._positions[0].push(i),this._mesh._positions[0].push(0);this._mesh._invalidate=!0,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[s]=this._mesh}}),{fieldChanged:function(e){if("point"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[];for(var t=0;t<this._vf.point.length;t++){var i=this._vf.point[t].x,s=this._vf.point[t].y;this._mesh._positions[0].push(i),this._mesh._positions[0].push(s),this._mesh._positions[0].push(0)}this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}))}}})),x3dom.registerNodeType("Rectangle2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.Rectangle2D.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y,n=this._vf.ccw,r=["Rectangle2D",t,i,s,o,n].join("-");if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[r])this._mesh=x3dom.geoCache[r];else{var a=t/s,d=i/o,h=n?1:-1;t/=2,i/=2;for(var l=0;l<=s;l++)for(var f=0;f<=o;f++)this._mesh._positions[0].push(l*a-t,f*d-i,0),this._mesh._normals[0].push(0,0,1*h),this._mesh._texCoords[0].push(l/s,f/o);for(l=1;l<=o;l++)for(f=0;f<s;f++)this._mesh._indices[0].push((l-1)*(s+1)+f+1),this._mesh._indices[0].push((l-1)*(s+1)+f),this._mesh._indices[0].push(l*(s+1)+f),this._mesh._indices[0].push((l-1)*(s+1)+f+1),this._mesh._indices[0].push(l*(s+1)+f),this._mesh._indices[0].push(l*(s+1)+f+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[r]=this._mesh}}),{fieldChanged:function(e){if("size"==e){this._mesh._positions[0]=[];var t=this._vf.size,i=t.x/2,s=t.y/2,o=i/(d=this._vf.subdivision.x),n=s/(h=this._vf.subdivision.y);i/=2,s/=2;for(var r=0;r<=d;r++)for(var a=0;a<=h;a++)this._mesh._positions[0].push(r*o-i,a*n-s,0);this.invalidateVolume(),this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty()}))}else if("subdivision"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];i=this._vf.size.x/2,s=this._vf.size.y/2,o=i/(d=this._vf.subdivision.x),n=s/(h=this._vf.subdivision.y);var d,h,l=this._vf.ccw?1:-1;i/=2,s/=2;for(r=0;r<=d;r++)for(a=0;a<=h;a++)this._mesh._positions[0].push(r*o-i,a*n-s,0),this._mesh._normals[0].push(0,0,1*l),this._mesh._texCoords[0].push(r/d,a/h);for(r=1;r<=h;r++)for(a=0;a<d;a++)this._mesh._indices[0].push((r-1)*(d+1)+a+1),this._mesh._indices[0].push((r-1)*(d+1)+a),this._mesh._indices[0].push(r*(d+1)+a),this._mesh._indices[0].push((r-1)*(d+1)+a+1),this._mesh._indices[0].push(r*(d+1)+a),this._mesh._indices[0].push(r*(d+1)+a+1);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty()}))}}})),x3dom.registerNodeType("TriangleSet2D","Geometry2D",defineClass(x3dom.nodeTypes.X3DPlanarGeometryNode,(function(e){x3dom.nodeTypes.TriangleSet2D.superClass.call(this,e),this.addField_MFVec2f(e,"vertices",[]);var t=0,i=0;this._vf.vertices.length&&(t=this._vf.vertices[0].x,i=this._vf.vertices[0].y);var s="TriangleSet2D_"+t+"-"+i;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[s])this._mesh=x3dom.geoCache[s];else{var o=0,n=0,r=0,a=0;this._vf.vertices.length&&(o=this._vf.vertices[0].x,n=this._vf.vertices[0].y,r=this._vf.vertices[0].x,a=this._vf.vertices[0].y);for(var d=0;d<this._vf.vertices.length;d++)this._vf.vertices[d].x<o&&(o=this._vf.vertices[d].x),this._vf.vertices[d].y<n&&(n=this._vf.vertices[d].y),this._vf.vertices[d].x>r&&(r=this._vf.vertices[d].x),this._vf.vertices[d].y>a&&(a=this._vf.vertices[d].y);for(d=0;d<this._vf.vertices.length;d++)t=this._vf.vertices[d].x,i=this._vf.vertices[d].y,this._mesh._positions[0].push(t),this._mesh._positions[0].push(i),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((t-o)/(r-o)),this._mesh._texCoords[0].push((i-n)/(a-n));for(var h=0;h<this._vf.vertices.length;h+=3)this._mesh._indices[0].push(h),this._mesh._indices[0].push(h+2),this._mesh._indices[0].push(h+1);this._mesh._numTexComponents=2,this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,x3dom.geoCache[s]=this._mesh}}),{fieldChanged:function(e){if("vertices"==e){this._mesh._positions[0]=[],this._mesh._indices[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[];for(var t=this._vf.vertices[0].x,i=this._vf.vertices[0].y,s=this._vf.vertices[0].x,o=this._vf.vertices[0].y,n=0;n<this._vf.vertices.length;n++)this._vf.vertices[n].x<t&&(t=this._vf.vertices[n].x),this._vf.vertices[n].y<i&&(i=this._vf.vertices[n].y),this._vf.vertices[n].x>s&&(s=this._vf.vertices[n].x),this._vf.vertices[n].y>o&&(o=this._vf.vertices[n].y);for(n=0;n<this._vf.vertices.length;n++){var r=this._vf.vertices[n].x,a=this._vf.vertices[n].y;this._mesh._positions[0].push(r),this._mesh._positions[0].push(a),this._mesh._positions[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push((r-t)/(s-t)),this._mesh._texCoords[0].push((a-i)/(o-i))}for(var d=0;d<this._vf.vertices.length;d+=3)this._mesh._indices[0].push(d),this._mesh._indices[0].push(d+2),this._mesh._indices[0].push(d+1);this._mesh._numTexComponents=2,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3,this._parentNodes.forEach((function(e){e.setAllDirty()}))}}})),x3dom.registerNodeType("X3DVolumeDataNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DShapeNode,(function(e){x3dom.nodeTypes.X3DVolumeDataNode.superClass.call(this,e),this.addField_SFVec3f(e,"dimensions",1,1,1),this.addField_SFNode("voxels",x3dom.nodeTypes.Texture),this.addField_SFBool(e,"allowViewpointInside",!0),this._textureID=0,this._first=!0,this._styleList=[],this.surfaceNormalsNeeded=!1,this.normalTextureProvided=!1,this.fragmentPreamble="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n"}),{getTextureSize:function(e){var t,i={w:0,h:0,valid:!1},s=this._webgl?this._webgl.texture:null,o=e&&s?s.length:0;for(t=0;t<o;t++)if(e==s[t].node&&s[t].texture){i.w=s[t].texture.width,i.h=s[t].texture.height,i.w&&i.h&&(i.valid=!0);break}return i},vertexShaderText:function(e){var t="attribute vec3 position;\nuniform vec3 dimensions;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec4 vertexPosition;\nvarying vec4 pos;\n";return(x3dom.nodeTypes.X3DLightNode.lightID>0||!0===e)&&(t+="uniform mat4 modelViewMatrix;\nvarying vec4 position_eye;\n"),t+="\nvoid main()\n{\n  vertexPosition = modelViewProjectionMatrix * vec4(position, 1.0);\n",(x3dom.nodeTypes.X3DLightNode.lightID>0||!0===e)&&(t+="  position_eye = modelViewMatrix * vec4(position, 1.0);\n"),t+="  pos = vec4((position/dimensions)+0.5, 1.0);\n  gl_Position = vertexPosition;\n}"},defaultUniformsShaderText:function(e,t,i,s){var o="uniform sampler2D uVolData;\nuniform vec3 dimensions;\nuniform vec3 offset;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInverse;\nvarying vec4 vertexPosition;\nvarying vec4 pos;\n";(x3dom.nodeTypes.X3DLightNode.lightID>0||!0===s)&&(o+="varying vec4 position_eye;\n");for(var n=0;n<x3dom.nodeTypes.X3DLightNode.lightID;n++)o+="uniform float light"+n+"_On;\nuniform float light"+n+"_Type;\nuniform vec3  light"+n+"_Location;\nuniform vec3  light"+n+"_Direction;\nuniform vec3  light"+n+"_Color;\nuniform vec3  light"+n+"_Attenuation;\nuniform float light"+n+"_Radius;\nuniform float light"+n+"_Intensity;\nuniform float light"+n+"_AmbientIntensity;\nuniform float light"+n+"_BeamWidth;\nuniform float light"+n+"_CutOffAngle;\nuniform float light"+n+"_ShadowIntensity;\n";return o+="const float Steps = 85.0;\nconst float numberOfSlices = "+e.toPrecision(5)+";\nconst float slicesOverX = "+t.toPrecision(5)+";\nconst float slicesOverY = "+i.toPrecision(5)+";\n"},texture3DFunctionShaderText:"vec4 cTexture3D(sampler2D vol, vec3 volpos, float nS, float nX, float nY)\n{\n  float s1,s2;\n  float dx1,dy1;\n  float dx2,dy2;\n  vec2 texpos1,texpos2;\n  s1 = floor(volpos.z*nS);\n  s2 = s1+1.0;\n  dx1 = fract(s1/nX);\n  dy1 = floor(s1/nX)/nY;\n  dx2 = fract(s2/nX);\n  dy2 = floor(s2/nX)/nY;\n  texpos1.x = dx1+(volpos.x/nX);\n  texpos1.y = dy1+(volpos.y/nY);\n  texpos2.x = dx2+(volpos.x/nX);\n  texpos2.y = dy2+(volpos.y/nY);\n  return mix( texture2D(vol,texpos1), texture2D(vol,texpos2), (volpos.z*nS)-s1);\n}\n\n",normalFunctionShaderText:function(){return this.surfaceNormalsNeeded?"vec4 getNormalFromTexture(sampler2D sampler, vec3 pos, float nS, float nX, float nY) {\n   vec4 n = (2.0*cTexture3D(sampler, pos, nS, nX, nY)-1.0);\n   return vec4(normalize(n.xyz), length(n.xyz));\n}\n\nvec4 getNormalOnTheFly(sampler2D sampler, vec3 voxPos, float nS, float nX, float nY){\n   float v0 = cTexture3D(sampler, voxPos + vec3(offset.x, 0, 0), nS, nX, nY).r;\n   float v1 = cTexture3D(sampler, voxPos - vec3(offset.x, 0, 0), nS, nX, nY).r;\n   float v2 = cTexture3D(sampler, voxPos + vec3(0, offset.y, 0), nS, nX, nY).r;\n   float v3 = cTexture3D(sampler, voxPos - vec3(0, offset.y, 0), nS, nX, nY).r;\n   float v4 = cTexture3D(sampler, voxPos + vec3(0, 0, offset.z), nS, nX, nY).r;\n   float v5 = cTexture3D(sampler, voxPos - vec3(0, 0, offset.z), nS, nX, nY).r;\n   vec3 grad = vec3(v0-v1, v2-v3, v4-v5)*0.5;\n   return vec4(normalize(grad), length(grad));\n}\n\n":""},defaultLoopFragmentShaderText:function(e,t,i){i=void 0!==i?i:"";var s="void main()\n{\n  vec3 cam_pos = vec3(modelViewMatrixInverse[3][0], modelViewMatrixInverse[3][1], modelViewMatrixInverse[3][2]);\n  vec3 cam_cube = cam_pos/dimensions+0.5;\n  vec3 dir = normalize(pos.xyz-cam_cube);\n";return this._vf.allowViewpointInside?s+="  float cam_inside = float(all(bvec2(all(lessThan(cam_cube, vec3(1.0))),all(greaterThan(cam_cube, vec3(0.0))))));\n  vec3 ray_pos = mix(pos.xyz, cam_cube, cam_inside);\n":s+="  vec3 ray_pos = pos.xyz;\n",s+="  vec4 accum  = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 sample = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 value  = vec4(0.0, 0.0, 0.0, 0.0);\n  float cont = 0.0;\n  vec3 step_size = (dir*1.4142)/Steps;\n",x3dom.nodeTypes.X3DLightNode.lightID>0?s+="  vec3 ambient = vec3(0.0, 0.0, 0.0);\n  vec3 diffuse = vec3(0.0, 0.0, 0.0);\n  vec3 specular = vec3(0.0, 0.0, 0.0);\n  vec4 step_eye = modelViewMatrix * vec4(step_size, 0.0);\n  vec4 positionE = position_eye;\n  float lightFactor = 1.0;\n":s+="  float lightFactor = 1.2;\n",s+=i+"  float opacityFactor = 10.0;\n  float t_near;\n  float t_far;\n  for(float i = 0.0; i < Steps; i+=1.0)\n  {\n    value = cTexture3D(uVolData, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n    value = value.rgbr;\n",this.surfaceNormalsNeeded&&(this.normalTextureProvided?s+="    vec4 gradEye = getNormalFromTexture(uSurfaceNormals, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n":s+="    vec4 gradEye = getNormalOnTheFly(uVolData, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n",s+="    vec4 grad = vec4((modelViewMatrix * vec4(gradEye.xyz, 0.0)).xyz, gradEye.a);\n"),s+=e,x3dom.nodeTypes.X3DLightNode.lightID>0&&(s+=t),s+="    sample.a = value.a * opacityFactor * (1.0/Steps);\n    sample.rgb = value.rgb * sample.a * lightFactor;\n    accum.rgb += (1.0 - accum.a) * sample.rgb;\n    accum.a += (1.0 - accum.a) * sample.a;\n    ray_pos.xyz += step_size;\n",x3dom.nodeTypes.X3DLightNode.lightID>0&&(s+="    positionE += step_eye;\n"),s+="    if(accum.a >= 1.0 || ray_pos.x < 0.0 || ray_pos.y < 0.0 || ray_pos.z < 0.0 || ray_pos.x > 1.0 || ray_pos.y > 1.0 || ray_pos.z > 1.0)\n      break;\n  }\n  gl_FragColor = accum;\n}"}})),x3dom.registerNodeType("X3DVolumeRenderStyleNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.X3DVolumeRenderStyleNode.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this._styleID=0,this._first=!1,this._volumeDataParent=null}),{nodeChanged:function(){this._styleID||(this._styleID=++x3dom.nodeTypes.X3DVolumeRenderStyleNode.styleID)},updateProperties:function(e){if(this._cf.renderStyle)if(this._cf.renderStyle.nodes)for(var t=0;t<this._cf.renderStyle.nodes.length;t++)null!=this._cf.renderStyle.nodes[t].updateProperties&&this._cf.renderStyle.nodes[t].updateProperties(e);else this._cf.renderStyle.node&&this._cf.renderStyle.node.updateProperties(e);this._volumeDataParent=e,-1!=this._volumeDataParent._styleList.indexOf(this.typeName())?this._first=!1:(this._first=!0,this._volumeDataParent._styleList.push(this.typeName()))},initializeValues:function(){return""},styleUniformsShaderText:function(){return""},styleShaderText:function(){return""},inlineStyleShaderText:function(){return""},lightAssigment:function(){for(var e="",t=0;t<x3dom.nodeTypes.X3DLightNode.lightID;t++)e+="    lighting(light"+t+"_Type, light"+t+"_Location, light"+t+"_Direction, light"+t+"_Color, light"+t+"_Attenuation, light"+t+"_Radius, light"+t+"_Intensity, light"+t+"_AmbientIntensity, light"+t+"_BeamWidth, light"+t+"_CutOffAngle, grad.xyz, positionE.xyz, ambient, diffuse, specular);\n";return e+="    value.rgb = ambient*value.rgb + diffuse*value.rgb + specular;\n"},lightEquationShaderText:function(){return x3dom.nodeTypes.X3DLightNode.lightID>0?"void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n       V = normalize(V);\n       attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n       L = normalize(L);\n       V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n           attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n       }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(L, N));\n   float NdotH = max(0.0, dot(H, N));\n   float ambientFactor  = lAmbientIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH,128.0);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n\n":""}})),x3dom.nodeTypes.X3DVolumeRenderStyleNode.styleID=0,x3dom.registerNodeType("X3DComposableVolumeRenderStyleNode","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode.superClass.call(this,e),this.addField_SFNode("surfaceNormals",x3dom.nodeTypes.Texture)}),{})),x3dom.registerNodeType("BlendedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.BlendedVolumeStyle.superClass.call(this,e),this.addField_SFNode("renderStyle",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.addField_SFNode("voxels",x3dom.nodeTypes.X3DVolumeDataNode),this.addField_SFFloat(e,"weightConstant1",.5),this.addField_SFFloat(e,"weightConstant2",.5),this.addField_SFString(e,"weightFunction1","CONSTANT"),this.addField_SFString(e,"weightFunction2","CONSTANT"),this.addField_SFNode("weightTransferFunction1",x3dom.nodeTypes.X3DTexture2DNode),this.addField_SFNode("weightTransferFunction2",x3dom.nodeTypes.X3DTexture2DNode),this.uniformFloatWeightConstant1=new x3dom.nodeTypes.Uniform(e),this.uniformFloatWeightConstant2=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DVoxels=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DWeightTransferFunction1=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DWeightTransferFunction2=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"weightConstant1":this.uniformFloatWeightConstant1._vf.value=this._vf.weightConstant1,this.uniformFloatWeightConstant1.fieldChanged("value");break;case"weightConstant2":this.uniformFloatWeightConstant2._vf.value=this._vf.weightConstant2,this.uniformFloatWeightConstant2.fieldChanged("value")}},uniforms:function(){var e=[];if((this._cf.voxels.node||this._cf.weightTransferFunction1.node||this._cf.weightTransferFunction2.node)&&(this.uniformSampler2DVoxels._vf.name="uVolBlendData",this.uniformSampler2DVoxels._vf.type="SFInt32",this.uniformSampler2DVoxels._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DVoxels),this._cf.weightTransferFunction1.node&&(this.uniformSampler2DWeightTransferFunction1._vf.name="uWeightTransferFunctionA",this.uniformSampler2DWeightTransferFunction1._vf.type="SFInt32",this.uniformSampler2DWeightTransferFunction1._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DWeightTransferFunction1)),this._cf.weightTransferFunction2.node&&(this.uniformSampler2DWeightTransferFunction2._vf.name="uWeightTransferFunctionB",this.uniformSampler2DWeightTransferFunction2._vf.type="SFInt32",this.uniformSampler2DWeightTransferFunction2._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DWeightTransferFunction2))),this.uniformFloatWeightConstant1._vf.name="uWeightConstantA",this.uniformFloatWeightConstant1._vf.type="SFFloat",this.uniformFloatWeightConstant1._vf.value=this._vf.weightConstant1,e.push(this.uniformFloatWeightConstant1),this.uniformFloatWeightConstant2._vf.name="uWeightConstantB",this.uniformFloatWeightConstant2._vf.type="SFFloat",this.uniformFloatWeightConstant2._vf.value=this._vf.weightConstant2,e.push(this.uniformFloatWeightConstant2),this._cf.renderStyle.node){var t=this._cf.renderStyle.node.uniforms();t.forEach((function(e){e._vf.name=e._vf.name.replace(/uSurfaceNormals/,"uBlendSurfaceNormals")})),e=e.concat(t)}return e},textures:function(){var e,t=[];this._cf.voxels.node&&((e=this._cf.voxels.node)._vf.repeatS=!1,e._vf.repeatT=!1,t.push(e));this._cf.weightTransferFunction1.node&&((e=this._cf.weightTransferFunction1.node)._vf.repeatS=!1,e._vf.repeatT=!1,t.push(e));this._cf.weightTransferFunction2.node&&((e=this._cf.weightTransferFunction2.node)._vf.repeatS=!1,e._vf.repeatT=!1,t.push(e));if(this._cf.renderStyle.node){var i=this._cf.renderStyle.node.textures();t=t.concat(i)}return t},initializeValues:function(){var e="";return x3dom.nodeTypes.X3DLightNode.lightID>0&&(e+="  vec3 ambientBlend = vec3(0.0, 0.0, 0.0);\n  vec3 diffuseBlend = vec3(0.0, 0.0, 0.0);\n  vec3 specularBlend = vec3(0.0, 0.0, 0.0);\n"),e},styleUniformsShaderText:function(){var e="uniform float uWeightConstantA;\nuniform float uWeightConstantB;\nuniform sampler2D uBlendSurfaceNormals;\n";return this._cf.voxels.node&&(e+="uniform sampler2D uVolBlendData;\n"),this._cf.weightTransferFunction1.node&&(e+="uniform sampler2D uWeightTransferFunctionA;\n"),this._cf.weightTransferFunction2.node&&(e+="uniform sampler2D uWeightTransferFunctionB;\n"),this._cf.renderStyle.node&&(e+=this._cf.renderStyle.node.styleUniformsShaderText()),e},styleShaderText:function(){var e="";return this._cf.renderStyle.node&&null!=this._cf.renderStyle.node.styleShaderText&&(e+=this._cf.renderStyle.node.styleShaderText()),e},inlineStyleShaderText:function(){var e=this._cf.voxels.node._vf.numberOfSlices.toPrecision(5),t=this._cf.voxels.node._vf.slicesOverX.toPrecision(5),i=this._cf.voxels.node._vf.slicesOverY.toPrecision(5),s="    vec4 blendValue = cTexture3D(uVolBlendData, ray_pos, "+e+", "+t+", "+i+");\n    blendValue = vec4(blendValue.rgb,(0.299*blendValue.r)+(0.587*blendValue.g)+(0.114*blendValue.b));\n";(this._cf.renderStyle.node&&this._cf.renderStyle.node._cf.surfaceNormals.node?s+="    vec4 blendGradEye = getNormalFromTexture(uBlendSurfaceNormals, ray_pos, "+e+", "+t+", "+i+");\n":s+="    vec4 blendGradEye = getNormalOnTheFly(uVolBlendData, ray_pos, "+e+", "+t+", "+i+");\n",s+="    vec4 blendGrad = vec4((modelViewMatrix * vec4(blendGradEye.xyz, 0.0)).xyz, blendGradEye.a);\n",this._cf.renderStyle.node)&&(s+=this._cf.renderStyle.node.inlineStyleShaderText().replace(/value/gm,"blendValue").replace(/grad/gm,"blendGrad").replace(/ambient/gm,"ambientBlend").replace(/diffuse/gm,"diffuseBlend").replace(/specular/gm,"specularBlend"));switch(this._vf.weightFunction1.toUpperCase()){case"CONSTANT":s+="    float wA = uWeightConstantA;\n";break;case"ALPHA0":s+="    float wA = value.a;\n";break;case"ALPHA1":s+="    float wA = blendValue.a;\n";break;case"ONE_MINUS_ALPHA0":s+="    float wA = 1.0 - value.a;\n";break;case"ONE_MINUS_ALPHA1":s+="    float wA = 1.0 - blendValue.a;\n";break;case"TABLE":this._cf.weightTransferFunction1?s+="    float wA = texture2D(uWeightTransferFunctionA, vec2(value.a, blendValue.a));\n":(s+="    float wA = value.a;\n",x3dom.debug.logWarning("[VolumeRendering][BlendedVolumeStyle] TABLE specified on weightFunction1 but not weightTrnafer function provided, using ALPHA0."))}switch(this._vf.weightFunction2.toUpperCase()){case"CONSTANT":s+="    float wB = uWeightConstantB;\n";break;case"ALPHA0":s+="    float wB = value.a;\n";break;case"ALPHA1":s+="    float wB = blendValue.a;\n";break;case"ONE_MINUS_ALPHA0":s+="    float wB = 1.0 - value.a;\n";break;case"ONE_MINUS_ALPHA1":s+="    float wB = 1.0 - blendValue.a;\n";break;case"TABLE":this._cf.weightTransferFunction2?s+="    float wB = texture2D(uWeightTransferFunctionB, vec2(value.a, blendValue.a));\n":(s+="    float wB = value.a;\n",x3dom.debug.logWarning("[VolumeRendering][BlendedVolumeStyle] TABLE specified on weightFunction2 but not weightTrasnferFunction provided, using ALPHA0."))}return 0==x3dom.nodeTypes.X3DLightNode.lightID&&(s+="    value = clamp(value * wA + blendValue * wB, 0.0, 1.0);\n"),s},lightAssigment:function(){var e="";if(x3dom.nodeTypes.X3DLightNode.lightID>0)if(this._cf.renderStyle.node){e+=this._cf.renderStyle.node.lightAssigment().replace(/value/gm,"blendValue").replace(/grad/gm,"blendGrad").replace(/ambient/gm,"ambientBlend").replace(/diffuse/gm,"diffuseBlend").replace(/specular/gm,"specularBlend")}else{for(var t=0;t<x3dom.nodeTypes.X3DLightNode.lightID;t++)e+="    lighting(light"+t+"_Type, light"+t+"_Location, light"+t+"_Direction, light"+t+"_Color, light"+t+"_Attenuation, light"+t+"_Radius, light"+t+"_Intensity, light"+t+"_AmbientIntensity, light"+t+"_BeamWidth, light"+t+"_CutOffAngle, blendGradEye.xyz, -positionE.xyz, ambientBlend, diffuseBlend, specularBlend);\n";e+="    blendValue.rgb = ambientBlend*blendValue.rgb + diffuseBlend*blendValue.rgb + specularBlend;\n"}return e+="    value.rgb = clamp(value.rgb * wA + blendValue.rgb * wB, 0.0, 1.0);\n    value.a = clamp(value.a * wA + blendValue.a * wB, 0.0, 1.0);\n"}})),x3dom.registerNodeType("BoundaryEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.BoundaryEnhancementVolumeStyle.superClass.call(this,e),this.addField_SFFloat(e,"retainedOpacity",1),this.addField_SFFloat(e,"boundaryOpacity",0),this.addField_SFFloat(e,"opacityFactor",1),this.uniformFloatRetainedOpacity=new x3dom.nodeTypes.Uniform(e),this.uniformFloatBoundaryOpacity=new x3dom.nodeTypes.Uniform(e),this.uniformFloatOpacityFactor=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableBoundary=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"retainedOpacity":this.uniformFloatRetainedOpacity._vf.value=this._vf.retainedOpacity,this.uniformFloatRetainedOpacity.fieldChanged("value");break;case"boundaryOpacity":this.uniformFloatBoundaryOpacity._vf.value=this._vf.boundaryOpacity,this.uniformFloatBoundaryOpacity.fieldChanged("value");break;case"opacityFactor":this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,this.uniformFloatOpacityFactor.fieldChanged("value")}},uniforms:function(){var e=[];if(this._cf.surfaceNormals.node){for(var t=this._parentNodes[0];!x3dom.isa(t,x3dom.nodeTypes.X3DVolumeDataNode)||!x3dom.isa(t,x3dom.nodeTypes.X3DNode);)t=t._parentNodes[0];0==x3dom.isa(t,x3dom.nodeTypes.X3DVolumeDataNode)&&(x3dom.debug.logError("[VolumeRendering][BoundaryEnhancementVolumeStyle] Not VolumeData parent found!"),t=null),this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=t._textureID++,e.push(this.uniformSampler2DSurfaceNormals)}return this.uniformFloatRetainedOpacity._vf.name="uRetainedOpacity"+this._styleID,this.uniformFloatRetainedOpacity._vf.type="SFFloat",this.uniformFloatRetainedOpacity._vf.value=this._vf.retainedOpacity,e.push(this.uniformFloatRetainedOpacity),this.uniformFloatBoundaryOpacity._vf.name="uBoundaryOpacity"+this._styleID,this.uniformFloatBoundaryOpacity._vf.type="SFFloat",this.uniformFloatBoundaryOpacity._vf.value=this._vf.boundaryOpacity,e.push(this.uniformFloatBoundaryOpacity),this.uniformFloatOpacityFactor._vf.name="uOpacityFactor"+this._styleID,this.uniformFloatOpacityFactor._vf.type="SFFloat",this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,e.push(this.uniformFloatOpacityFactor),this.uniformBoolEnableBoundary._vf.name="uEnableBoundary"+this._styleID,this.uniformBoolEnableBoundary._vf.type="SFBool",this.uniformBoolEnableBoundary._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableBoundary),e},textures:function(){var e=[];if(null!=this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleUniformsShaderText:function(){return"uniform float uRetainedOpacity"+this._styleID+";\nuniform float uBoundaryOpacity"+this._styleID+";\nuniform float uOpacityFactor"+this._styleID+";\nuniform bool uEnableBoundary"+this._styleID+";\n"},styleShaderText:function(){return this._first?"void boundaryEnhancement(inout vec4 original_color, in float gradientMagnitude, in float retainedOpacity, in float boundaryOpacity, in float opacityFactor){\n   original_color.a = original_color.a * (retainedOpacity + (boundaryOpacity * pow(gradientMagnitude, opacityFactor)));\n}\n":""},inlineStyleShaderText:function(){return"    if(uEnableBoundary"+this._styleID+"){\n    boundaryEnhancement(value, grad.w, uRetainedOpacity"+this._styleID+", uBoundaryOpacity"+this._styleID+", uOpacityFactor"+this._styleID+");\n}\n"}})),x3dom.registerNodeType("CartoonVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.CartoonVolumeStyle.superClass.call(this,e),this.addField_SFColor(e,"parallelColor",0,0,0),this.addField_SFColor(e,"orthogonalColor",1,1,1),this.addField_SFInt32(e,"colorSteps",4),this.uniformParallelColor=new x3dom.nodeTypes.Uniform(e),this.uniformOrthogonalColor=new x3dom.nodeTypes.Uniform(e),this.uniformIntColorSteps=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableCartoon=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"parallelColor":this.uniformParallelColor._vf.value=this._vf.parallelColor,this.uniformParallelColor.fieldChanged("value");break;case"orthogonalColor":this.uniformOrthogonalColor._vf.value=this._vf.orthogonalColor,this.uniformOrthogonalColor.fieldChanged("value");break;case"colorSteps":this.uniformIntColorSteps._vf.value=this._vf.colorSteps,this.uniformIntColorSteps.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.surfaceNormals.node&&(this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DSurfaceNormals)),this.uniformParallelColor._vf.name="uParallelColor"+this._styleID,this.uniformParallelColor._vf.type="SFColor",this.uniformParallelColor._vf.value=this._vf.parallelColor,e.push(this.uniformParallelColor),this.uniformOrthogonalColor._vf.name="uOrthogonalColor"+this._styleID,this.uniformOrthogonalColor._vf.type="SFColor",this.uniformOrthogonalColor._vf.value=this._vf.orthogonalColor,e.push(this.uniformOrthogonalColor),this.uniformIntColorSteps._vf.name="uColorSteps"+this._styleID,this.uniformIntColorSteps._vf.type="SFInt32",this.uniformIntColorSteps._vf.value=this._vf.colorSteps,e.push(this.uniformIntColorSteps),this.uniformBoolEnableCartoon._vf.name="uEnableCartoon"+this._styleID,this.uniformBoolEnableCartoon._vf.type="SFBool",this.uniformBoolEnableCartoon._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableCartoon),e},textures:function(){var e=[];if(this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleShaderText:function(){return this._first?"//Convert RGBA color to HSVA\nvec4 rgba2hsva(vec4 rgba){\n   float zat, izen;\n   float R = rgba.r, G = rgba.g, B = rgba.b;\n   float minim = min(R, min(G, B)), maxim = max(R, max(G, B));\n   float delta = maxim-minim;\n   if(minim == maxim){\n       return vec4(0.0, 0.0, maxim, rgba.a);\n   }else{\n       zat = (R == maxim) ? G - B : ((G == maxim) ? B - R : R - G);\n       izen = (R == maxim) ? ((G<B) ? 6.0 : 0.0) : ((G == maxim) ? 2.0 : 4.0);\n        return vec4((zat/delta + izen)/6.0, delta/maxim, maxim, rgba.a);\n    }\n}\n\n//Convert RGB color to HSV\nvec3 rgb2hsv(vec3 rgb){\n    return rgba2hsva(vec4(rgb, 1.0)).rgb;\n}\n\n//Convert HSVA color to RGBA\nvec4 hsva2rgba(vec4 hsva){\n   float r, g, b;\n   float h=hsva.x, s=hsva.y, v=hsva.z;\n   float i = floor(h * 6.0);\n   float f = h * 6.0 - i;\n   float p = v * (1.0 - s);\n   float q = v * (1.0 - f * s);\n   float t = v * (1.0 - (1.0 - f) * s);\n   i = mod(i,6.0);\n   if( i == 6.0 || i == 0.0 ) r = v, g = t, b = p;\n   else if( i == 1.0) r = q, g = v, b = p;\n   else if( i == 2.0) r = p, g = v, b = t;\n   else if( i == 3.0) r = p, g = q, b = v;\n   else if( i == 4.0) r = t, g = p, b = v;\n   else if( i == 5.0) r = v, g = p, b = q;\n   return vec4(r,g,b,hsva.w);\n}\n\n//Convert HSV color to RGB\nvec3 hsv2rgb(vec3 hsv){\n   return hsva2rgba(vec4(hsv, 1.0)).rgb;\n}\nvoid getCartoonStyle(inout vec4 outputColor, vec3 orthogonalColor, vec3 parallelColor, int colorSteps, vec4 surfNormal, vec3 V)\n{\n   float steps = clamp(float(colorSteps), 1.0,64.0);\n   float range_size = pi_half / steps;\n   float cos_angle = abs(dot(surfNormal.xyz, V));\n   float interval = clamp(floor(cos_angle / range_size),0.0,steps);\n   float ang = interval * range_size;\n   outputColor.rgb = hsv2rgb(mix(orthogonalColor, parallelColor, ang));\n}\n\n":""},styleUniformsShaderText:function(){var e="uniform vec3 uParallelColor"+this._styleID+";\nuniform vec3 uOrthogonalColor"+this._styleID+";\nuniform int uColorSteps"+this._styleID+";\nuniform bool uEnableCartoon"+this._styleID+";\n";return this._first&&(e+="const float pi_half = "+(Math.PI/2).toPrecision(5)+";\n"),e},inlineStyleShaderText:function(){return"  if(uEnableCartoon"+this._styleID+"){\n      getCartoonStyle(value, rgb2hsv(uOrthogonalColor"+this._styleID+"), rgb2hsv(uParallelColor"+this._styleID+"), uColorSteps"+this._styleID+", gradEye, dir);\n  }\n"}})),x3dom.registerNodeType("ComposedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.ComposedVolumeStyle.superClass.call(this,e),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.normalTextureProvided=!1}),{uniforms:function(){var e,t=[],i=this._cf.renderStyle.nodes.length;for(e=0;e<i;e++){this._cf.renderStyle.nodes[e].uniforms().forEach((function(e){var i=!1;t.forEach((function(t){t._vf.name==e._vf.name&&(i=!0)})),0==i&&(t=t.concat(e))}))}return t},textures:function(){var e,t=[],i=this._cf.renderStyle.nodes.length;for(e=0;e<i;e++)this._cf.renderStyle.nodes[e].textures().forEach((function(e){var i=!1;t.forEach((function(t){t._vf.url[0]==e._vf.url[0]&&(i=!0)})),0==i&&(t=t.concat(e))}));return t},initializeValues:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].initializeValues&&(e+=this._cf.renderStyle.nodes[i].initializeValues()+"\n");return e},styleUniformsShaderText:function(){var e="",t=this._cf.renderStyle.nodes.length;1!=t||x3dom.isa(this._cf.renderStyle.nodes[0],x3dom.nodeTypes.OpacityMapVolumeStyle)||(this.surfaceNormalsNeeded=!0);for(var i=0;i<t;i++)e+=this._cf.renderStyle.nodes[i].styleUniformsShaderText()+"\n",this._cf.renderStyle.nodes[i]._cf.surfaceNormals&&null!=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node&&(this.normalTextureProvided=!0,this._cf.surfaceNormals.node=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node);return e},styleShaderText:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].styleShaderText&&(e+=this._cf.renderStyle.nodes[i].styleShaderText()+"\n");return e},inlineStyleShaderText:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)e+=this._cf.renderStyle.nodes[i].inlineStyleShaderText();return e},lightAssigment:function(){var e,t=!1;return this._cf.renderStyle.nodes.forEach((function(i){x3dom.isa(i,x3dom.nodeTypes.BlendedVolumeStyle)&&(t=!0,e=i.lightAssigment())})),t?this._cf.renderStyle.nodes[0].lightAssigment()+e:this._cf.renderStyle.nodes[0].lightAssigment()},lightEquationShaderText:function(){return this._cf.renderStyle.nodes[0].lightEquationShaderText()}})),x3dom.registerNodeType("EdgeEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.EdgeEnhancementVolumeStyle.superClass.call(this,e),this.addField_SFColor(e,"edgeColor",0,0,0),this.addField_SFFloat(e,"gradientThreshold",.4),this.uniformColorEdgeColor=new x3dom.nodeTypes.Uniform(e),this.uniformFloatGradientThreshold=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEdgeEnable=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){"edgeColor"==e?(this.uniformColorEdgeColor._vf.value=this._vf.edgeColor,this.uniformColorEdgeColor.fieldChanged("value")):"gradientThreshold"==e&&(this.uniformFloatGradientThreshold._vf.value=this._vf.gradientThreshold,this.uniformFloatGradientThreshold.fieldChanged("value"))},uniforms:function(){var e=[];return this._cf.surfaceNormals.node&&(this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DSurfaceNormals)),this.uniformColorEdgeColor._vf.name="uEdgeColor"+this._styleID,this.uniformColorEdgeColor._vf.type="SFColor",this.uniformColorEdgeColor._vf.value=this._vf.edgeColor,e.push(this.uniformColorEdgeColor),this.uniformFloatGradientThreshold._vf.name="uGradientThreshold"+this._styleID,this.uniformFloatGradientThreshold._vf.type="SFFloat",this.uniformFloatGradientThreshold._vf.value=this._vf.gradientThreshold,e.push(this.uniformFloatGradientThreshold),this.uniformBoolEdgeEnable._vf.name="uEnableEdge"+this._styleID,this.uniformBoolEdgeEnable._vf.type="SFBool",this.uniformBoolEdgeEnable._vf.value=this._vf.enabled,e.push(this.uniformBoolEdgeEnable),e},textures:function(){var e=[];if(this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleUniformsShaderText:function(){return"uniform vec3 uEdgeColor"+this._styleID+";\nuniform float uGradientThreshold"+this._styleID+";\nuniform bool uEnableEdge"+this._styleID+";\n"},styleShaderText:function(){return this._first?"void edgeEnhancement(inout vec4 originalColor, in vec4 gradient, in vec3 V, in vec3 edgeColor, in float gradientT)\n{\n   if(gradient.a > 0.05){\n       float angle_dif = abs(dot(gradient.xyz,V));\n       if(angle_dif > cos(gradientT)){\n           originalColor.rgb = mix(edgeColor, originalColor.rgb, angle_dif);\n       }\n   }\n}\n":""},inlineStyleShaderText:function(){return"   if(uEnableEdge"+this._styleID+"){\n       edgeEnhancement(value, gradEye, dir, uEdgeColor"+this._styleID+", uGradientThreshold"+this._styleID+");\n   }\n"}})),x3dom.registerNodeType("IsoSurfaceVolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,(function(e){x3dom.nodeTypes.IsoSurfaceVolumeData.superClass.call(this,e),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DVolumeRenderStyleNode),this.addField_SFNode("gradients",x3dom.nodeTypes.Texture),this.addField_MFFloat(e,"surfaceValues",[0]),this.addField_SFFloat(e,"contourStepSize",0),this.addField_SFFloat(e,"surfaceTolerance",0),this.uniformSampler2DGradients=new x3dom.nodeTypes.Uniform(e),this.uniformFloatContourStepSize=new x3dom.nodeTypes.Uniform(e),this.uniformFloatSurfaceTolerance=new x3dom.nodeTypes.Uniform(e),this.uniformFloatArraySurfaceValues=new x3dom.nodeTypes.Uniform(e),this.vrcMultiTexture=new x3dom.nodeTypes.MultiTexture(e),this.vrcVolumeTexture=null,this.vrcSinglePassShader=new x3dom.nodeTypes.ComposedShader(e),this.vrcSinglePassShaderVertex=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFragment=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFieldVolData=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldOffset=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldDimensions=new x3dom.nodeTypes.Field(e)}),{fieldChanged:function(e){switch(e){case"surfaceValues":this.uniformFloatArraySurfaceValues._vf.value=this._vf.surfaceValues,this.uniformFloatArraySurfaceValues.fieldChanged("value");break;case"surfaceTolerance":this.uniformFloatSurfaceTolerance._vf.value=this._vf.surfaceTolerance,this.uniformFloatSurfaceTolerance.fieldChanged("value")}},uniforms:function(){var e=[];if(this._cf.gradients.node&&(this.uniformSampler2DGradients._vf.name="uSurfaceNormals",this.uniformSampler2DGradients._vf.type="SFInt32",this.uniformSampler2DGradients._vf.value=this._textureID++,e.push(this.uniformSampler2DGradients)),this.uniformFloatArraySurfaceValues._vf.name="uSurfaceValues",this.uniformFloatArraySurfaceValues._vf.type="MFFloat",this.uniformFloatArraySurfaceValues._vf.value=this._vf.surfaceValues,e.push(this.uniformFloatArraySurfaceValues),this.uniformFloatSurfaceTolerance._vf.name="uSurfaceTolerance",this.uniformFloatSurfaceTolerance._vf.type="MFFloat",this.uniformFloatSurfaceTolerance._vf.value=this._vf.surfaceTolerance,e.push(this.uniformFloatSurfaceTolerance),this._cf.renderStyle.nodes)for(var t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)this._cf.renderStyle.nodes[i].uniforms().forEach((function(t){var i=!1;e.forEach((function(e){e._vf.name==t._vf.name&&(i=!0)})),0==i&&(e=e.concat(t))}));return e},textures:function(){var e=[];if(this._cf.gradients.node){var t=this._cf.gradients.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}var i,s=this._cf.renderStyle.nodes.length;for(i=0;i<s;i++)this._cf.renderStyle.nodes[i].textures().forEach((function(t){var i=!1;e.forEach((function(e){e._vf.url[0]==t._vf.url[0]&&(i=!0)})),0==i&&(e=e.concat(t))}));return e},initializeValues:function(){for(var e="  float previous_value = 0.0;\n",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].initializeValues&&(e+=this._cf.renderStyle.nodes[i].initializeValues()+"\n");return e},styleUniformsShaderText:function(){var e="uniform float uSurfaceTolerance;\nuniform float uSurfaceValues["+this._vf.surfaceValues.length+"];\n";this._cf.gradients.node&&(e+="uniform sampler2D uSurfaceNormals;\n");for(var t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)e+=this._cf.renderStyle.nodes[i].styleUniformsShaderText()+"\n",this._cf.renderStyle.nodes[i]._cf.surfaceNormals&&null!=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node&&(this.normalTextureProvided=!0,this.surfaceNormals=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node);return this.surfaceNormalsNeeded=!0,e},inlineStyleShaderText:function(){var e="    sample = value.r;\n";if(1==this._vf.surfaceValues.length)if(0==this._vf.contourStepSize)e+="   if(((sample>=uSurfaceValues[0] && previous_value<uSurfaceValues[0])||(sample<uSurfaceValues[0] && previous_value>=uSurfaceValues[0])) && (grad.a>=uSurfaceTolerance)){\n       value = vec4(vec3(uSurfaceValues[0]),1.0);\n",this._cf.renderStyle.nodes&&(e+=this._cf.renderStyle.nodes[0].inlineStyleShaderText()),e+="       accum.rgb += (1.0 - accum.a) * (value.rgb * value.a);\n       accum.a += (1.0 - accum.a) * value.a;\n   }\n";else{for(var t=this._vf.surfaceValues[0],i=[t],s=[],o=[];t+this._vf.contourStepSize<=1;)t+=this._vf.contourStepSize,i.push(t);for(t=this._vf.surfaceValues[0];t-this._vf.contourStepSize>=0;)t-=this._vf.contourStepSize,s.unshift(t);o=s.concat(i);for(var n=0;n<=o.length-1;n++){var r=o[n].toPrecision(3);e+=" if(((sample>="+r+" && previous_value<"+r+")||(sample<"+r+" && previous_value>="+r+")) && (grad.a>=uSurfaceTolerance)){\n       value = vec4(vec3("+r+"),1.0);\n",this._cf.renderStyle.nodes&&(e+=this._cf.renderStyle.nodes[0].inlineStyleShaderText()),e+="       accum.rgb += (1.0 - accum.a) * (value.rgb * value.a);\n       accum.a += (1.0 - accum.a) * value.a;\n   }\n"}}else{var a=this._cf.renderStyle.nodes.length-1,d=this._vf.surfaceValues.length;for(n=0;n<d;n++){var h=Math.min(n,a);e+="   if(((sample>=uSurfaceValues["+n+"] && previous_value<uSurfaceValues["+n+"])||(sample<uSurfaceValues["+n+"] && previous_value>=uSurfaceValues["+n+"])) && (grad.a>=uSurfaceTolerance)){\n       value = vec4(vec3(uSurfaceValues["+n+"]),1.0);\n",this._cf.renderStyle.nodes&&(e+=this._cf.renderStyle.nodes[h].inlineStyleShaderText()),e+="   accum.rgb += (1.0 - accum.a) * (value.rgb * value.a);\n   accum.a += (1.0 - accum.a) * value.a;\n   }\n"}}return e+="    previous_value = sample;\n"},styleShaderText:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].styleShaderText&&(e+=this._cf.renderStyle.nodes[i].styleShaderText()+"\n");return e},lightAssigment:function(){return this._cf.renderStyle.nodes[0].lightAssigment()},lightEquationShaderText:function(){return this._cf.renderStyle.nodes[0].lightEquationShaderText()},nodeChanged:function(){if(!this._cf.appearance.node){this.addChild(new x3dom.nodeTypes.Appearance),this.vrcVolumeTexture=this._cf.voxels.node,this.vrcVolumeTexture._vf.repeatS=!1,this.vrcVolumeTexture._vf.repeatT=!1,this.vrcMultiTexture._nameSpace=this._nameSpace,this.vrcMultiTexture.addChild(this.vrcVolumeTexture,"texture"),this.vrcVolumeTexture.nodeChanged();var e=this.textures();for(t=0;t<e.length;t++)this.vrcMultiTexture.addChild(e[t],"texture"),this.vrcVolumeTexture.nodeChanged();this._cf.appearance.node.addChild(this.vrcMultiTexture),this.vrcMultiTexture.nodeChanged();for(var t=0;t<this._cf.renderStyle.nodes.length;t++)this._cf.renderStyle.nodes[t].updateProperties(this);this.vrcSinglePassShaderVertex._vf.type="vertex",this.vrcSinglePassShaderVertex._vf.url[0]=this.vertexShaderText(),this.vrcSinglePassShaderFragment._vf.type="fragment";var i=this.fragmentPreamble+this.defaultUniformsShaderText(this.vrcVolumeTexture._vf.numberOfSlices,this.vrcVolumeTexture._vf.slicesOverX,this.vrcVolumeTexture._vf.slicesOverY)+this.styleUniformsShaderText()+this.styleShaderText()+this.texture3DFunctionShaderText+this.normalFunctionShaderText()+this.lightEquationShaderText();i+="void main()\n{\n  vec3 cam_pos = vec3(modelViewMatrixInverse[3][0], modelViewMatrixInverse[3][1], modelViewMatrixInverse[3][2]);\n  vec3 cam_cube = cam_pos/dimensions+0.5;\n  vec3 dir = normalize(pos.xyz-cam_cube);\n",this._vf.allowViewpointInside?i+="  float cam_inside = float(all(bvec2(all(lessThan(cam_cube, vec3(1.0))),all(greaterThan(cam_cube, vec3(0.0))))));\n  vec3 ray_pos = mix(pos.xyz, cam_cube, cam_inside);\n":i+="  vec3 ray_pos = pos.xyz;\n",i+="  vec4 accum  = vec4(0.0, 0.0, 0.0, 0.0);\n  float sample = 0.0;\n  vec4 value  = vec4(0.0, 0.0, 0.0, 0.0);\n  float cont = 0.0;\n  vec3 step = dir/Steps;\n",x3dom.nodeTypes.X3DLightNode.lightID>0?i+="  vec3 ambient = vec3(0.0, 0.0, 0.0);\n  vec3 diffuse = vec3(0.0, 0.0, 0.0);\n  vec3 specular = vec3(0.0, 0.0, 0.0);\n  vec4 step_eye = modelViewMatrix * vec4(step, 0.0);\n  vec4 positionE = position_eye;\n  float lightFactor = 1.0;\n":i+="  float lightFactor = 1.2;\n",i+=this.initializeValues()+"  float opacityFactor = 6.0;\n  float t_near;\n  float t_far;\n  for(float i = 0.0; i < Steps; i+=1.0)\n  {\n    value = cTexture3D(uVolData, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n    value = value.rgbr;\n",this._cf.gradients.node?i+="    vec4 gradEye = getNormalFromTexture(uSurfaceNormals, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n":i+="    vec4 gradEye = getNormalOnTheFly(uVolData, ray_pos, numberOfSlices, slicesOverX, slicesOverY);\n",i+="    vec4 grad = vec4((modelViewMatrix * vec4(gradEye.xyz, 0.0)).xyz, gradEye.a);\n";for(var s=0;s<x3dom.nodeTypes.X3DLightNode.lightID;s++)i+="    lighting(light"+s+"_Type, light"+s+"_Location, light"+s+"_Direction, light"+s+"_Color, light"+s+"_Attenuation, light"+s+"_Radius, light"+s+"_Intensity, light"+s+"_AmbientIntensity, light"+s+"_BeamWidth, light"+s+"_CutOffAngle, grad.xyz, positionE.xyz, ambient, diffuse, specular);\n";i+=this.inlineStyleShaderText(),x3dom.nodeTypes.X3DLightNode.lightID>0&&(i+=this.lightAssigment()),i+="    //advance the current position\n    ray_pos.xyz += step;\n",x3dom.nodeTypes.X3DLightNode.lightID>0&&(i+="    positionE += step_eye;\n"),i+="    //break if the position is greater than <1, 1, 1>\n    if(ray_pos.x > 1.0 || ray_pos.y > 1.0 || ray_pos.z > 1.0 || ray_pos.x <= 0.0 || ray_pos.y <= 0.0 || ray_pos.z <= 0.0 || accum.a>=1.0)\n      break;\n  }\n  gl_FragColor = accum;\n}",this.vrcSinglePassShaderFragment._vf.url[0]=i,this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderVertex,"parts"),this.vrcSinglePassShaderVertex.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFragment,"parts"),this.vrcSinglePassShaderFragment.nodeChanged(),this.vrcSinglePassShaderFieldVolData._vf.name="uVolData",this.vrcSinglePassShaderFieldVolData._vf.type="SFInt32",this.vrcSinglePassShaderFieldVolData._vf.value=this._textureID++,this.vrcSinglePassShaderFieldDimensions._vf.name="dimensions",this.vrcSinglePassShaderFieldDimensions._vf.type="SFVec3f",this.vrcSinglePassShaderFieldDimensions._vf.value=this._vf.dimensions,this.vrcSinglePassShaderFieldOffset._vf.name="offset",this.vrcSinglePassShaderFieldOffset._vf.type="SFVec3f",this.vrcSinglePassShaderFieldOffset._vf.value="0.01 0.01 0.01",this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldVolData,"fields"),this.vrcSinglePassShaderFieldVolData.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldDimensions,"fields"),this.vrcSinglePassShaderFieldDimensions.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldOffset,"fields"),this.offsetInterval=window.setInterval((n=this.vrcVolumeTexture,r=this,function(){x3dom.debug.logInfo("[VolumeRendering][IsoSurfaceVolumeData] Looking for Volume Texture size...");var e=r.getTextureSize(n);e.valid&&(clearInterval(r.offsetInterval),r.vrcSinglePassShaderFieldOffset._vf.value=new x3dom.fields.SFVec3f(1/(e.w/n._vf.slicesOverX),1/(e.h/n._vf.slicesOverY),1/n._vf.numberOfSlices),r.vrcSinglePassShader.nodeChanged(),x3dom.debug.logInfo("[VolumeRendering][IsoSurfaceVolumeData] Volume Texture size obtained"))}),1e3);var o=this.uniforms();for(t=0;t<o.length;t++)this.vrcSinglePassShader.addChild(o[t],"fields");this._cf.appearance.node.addChild(this.vrcSinglePassShader),this.vrcSinglePassShader.nodeChanged(),this._cf.appearance.node.nodeChanged()}var n,r;this._cf.geometry.node||(this.addChild(new x3dom.nodeTypes.Box),this._cf.geometry.node._vf.solid=!1,this._cf.geometry.node._vf.hasHelperColors=!1,this._cf.geometry.node._vf.size=new x3dom.fields.SFVec3f(this._vf.dimensions.x,this._vf.dimensions.y,this._vf.dimensions.z),this._cf.geometry.node.fieldChanged("size"))}})),x3dom.registerNodeType("MPRVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.MPRVolumeStyle.superClass.call(this,e),this.addField_SFNode("transferFunction",x3dom.nodeTypes.Texture),this.addField_SFBool(e,"forceOpaque",!0),this.addField_MFNode("planes",x3dom.nodeTypes.MPRPlane),this.uniformSampler2DTransferFunction=new x3dom.nodeTypes.Uniform(e),this.uniformBoolForceOpaque=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"forceOpaque":this.uniformBoolForceOpaque._vf.value=this._vf.forceOpaque,this.uniformBoolForceOpaque.fieldChanged("value")}},uniforms:function(){var e=[];this._cf.transferFunction.node&&(this.uniformSampler2DTransferFunction._vf.name="uTransferFunction",this.uniformSampler2DTransferFunction._vf.type="SFInt32",this.uniformSampler2DTransferFunction._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DTransferFunction)),this.uniformBoolForceOpaque._vf.name="forceOpaque",this.uniformBoolForceOpaque._vf.type="SFBool",this.uniformBoolForceOpaque._vf.value=this._vf.forceOpaque,e.push(this.uniformBoolForceOpaque);var t,i=this._cf.planes.nodes.length;for(t=0;t<i;t++){this._cf.planes.nodes[t].uniforms().forEach((function(t){var i=!1;e.forEach((function(e){e._vf.name==t._vf.name&&(i=!0)})),0==i&&(e=e.concat(t))}))}return e},textures:function(){var e=[],t=this._cf.transferFunction.node;return t&&(t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)),e},styleUniformsShaderText:function(){var e="uniform bool forceOpaque;\n";this._cf.transferFunction.node&&(e+="uniform sampler2D uTransferFunction;\n");for(var t=0;t<this._cf.planes.nodes.length;t++)e+=this._cf.planes.nodes[t].styleUniformsShaderText();return e},fragmentShaderText:function(e,t,i){for(var s=this._parentNodes[0].fragmentPreamble+this._parentNodes[0].defaultUniformsShaderText(e,t,i)+this.styleUniformsShaderText()+this._parentNodes[0].texture3DFunctionShaderText+"void main()\n{\n  vec3 cam_pos = vec3(modelViewMatrixInverse[3][0], modelViewMatrixInverse[3][1], modelViewMatrixInverse[3][2]);\n  cam_pos = cam_pos/dimensions+0.5;\n  vec3 dir = normalize(pos.xyz-cam_pos);\n  float cam_inside = float(all(bvec2(all(lessThan(cam_pos, vec3(1.0))),all(greaterThan(cam_pos, vec3(0.0))))));\n  vec3 ray_pos = mix(pos.xyz, cam_pos, cam_inside);\n  float d = 1000.0;",o=0;o<this._cf.planes.nodes.length;o++)s+=this._cf.planes.nodes[o].styleShaderText();return s+="  vec4 color = vec4(0.0,0.0,0.0,0.0);\n  vec3 pos = d*dir+ray_pos;\n  if (!(any(bvec2(any(lessThan(pos.xyz, vec3(0.0))),any(greaterThan(pos.xyz, vec3(1.0))))))){\n    pos = clamp(pos, vec3(0.0), vec3(1.0));\n    vec4 intesity = cTexture3D(uVolData,pos.rgb,numberOfSlices,slicesOverX,slicesOverY);\n",this._cf.transferFunction.node?s+="    if (forceOpaque){\n      color = vec4(texture2D(uTransferFunction, vec2(intesity.r,0.5)).rgb, 1.0);\n    }else{\n      color = texture2D(uTransferFunction, vec2(intesity.r,0.5)).rgba;\n    }\n":s+="    if (forceOpaque){\n      color = vec4(intesity.rgb,1.0);\n    }else{\n      color = intesity;\n    }\n",s+="  }\n  gl_FragColor = color;\n}"}})),x3dom.registerNodeType("MPRPlane","VolumeRendering",defineClass(x3dom.nodeTypes.X3DNode,(function(e){x3dom.nodeTypes.MPRPlane.superClass.call(this,e),this.addField_SFBool(e,"enabled",!0),this.addField_SFVec3f(e,"normal",0,1,0),this.addField_SFFloat(e,"position",.5),this.uniformBooleanEnabled=new x3dom.nodeTypes.Uniform(e),this.uniformVec3fNormal=new x3dom.nodeTypes.Uniform(e),this.uniformFloatPosition=new x3dom.nodeTypes.Uniform(e),this._planeID=0}),{nodeChanged:function(){this._planeID||(this._planeID=++x3dom.nodeTypes.MPRPlane.planeID)},fieldChanged:function(e){switch(e){case"enabled":this.uniformBooleanEnabled._vf.value=this._vf.enabled.toString(),this.uniformBooleanEnabled.fieldChanged("value");break;case"position":this.uniformFloatPosition._vf.value=Math.min(Math.max(this._vf.position,.001),.999),this.uniformFloatPosition.fieldChanged("value");break;case"normal":this.uniformVec3fNormal._vf.value=this._vf.normal,this.uniformVec3fNormal.fieldChanged("value")}},uniforms:function(){var e=[];return this.uniformBooleanEnabled._vf.name="enabledPlane"+this._planeID,this.uniformBooleanEnabled._vf.type="SFBool",this.uniformBooleanEnabled._vf.value=this._vf.enabled,e.push(this.uniformBooleanEnabled),this.uniformVec3fNormal._vf.name="normalPlane"+this._planeID,this.uniformVec3fNormal._vf.type="SFVec3f",this.uniformVec3fNormal._vf.value=this._vf.normal,e.push(this.uniformVec3fNormal),this.uniformFloatPosition._vf.name="positionPlane"+this._planeID,this.uniformFloatPosition._vf.type="SFFloat",this.uniformFloatPosition._vf.value=this._vf.position,e.push(this.uniformFloatPosition),e},styleUniformsShaderText:function(){return"uniform vec3 normalPlane"+this._planeID+";\nuniform float positionPlane"+this._planeID+";\nuniform bool enabledPlane"+this._planeID+";\n"},styleShaderText:function(){return"  if(enabledPlane"+this._planeID+"){\n   vec3 pointLine"+this._planeID+" = normalPlane"+this._planeID+"*positionPlane"+this._planeID+";\n   float d"+this._planeID+" = dot(pointLine"+this._planeID+"-ray_pos,normalPlane"+this._planeID+")/dot(dir,normalPlane"+this._planeID+");\n   float f"+this._planeID+" = step(0.0, d"+this._planeID+");\n   d"+this._planeID+" = (1.0 - f"+this._planeID+") * 1000.0 + f"+this._planeID+" * d"+this._planeID+";\n   d = min(d"+this._planeID+",d);\n  }\n"}})),x3dom.nodeTypes.MPRPlane.planeID=0,x3dom.registerNodeType("OpacityMapVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.OpacityMapVolumeStyle.superClass.call(this,e),this.addField_SFNode("transferFunction",x3dom.nodeTypes.Texture),this.addField_SFString(e,"type","simple"),this.addField_SFFloat(e,"opacityFactor",6),this.addField_SFFloat(e,"lightFactor",1.2),this.uniformFloatOpacityFactor=new x3dom.nodeTypes.Uniform(e),this.uniformFloatLightFactor=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DTransferFunction=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableOpacityMap=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"opacityFactor":this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,this.uniformFloatOpacityFactor.fieldChanged("value");break;case"lightFactor":this.uniformFloatLightFactor._vf.value=this._vf.lightFactor,this.uniformFloatLightFactor.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.transferFunction.node&&(this.uniformSampler2DTransferFunction._vf.name="uTransferFunction"+this._styleID,this.uniformSampler2DTransferFunction._vf.type="SFInt32",this.uniformSampler2DTransferFunction._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DTransferFunction)),this.uniformFloatOpacityFactor._vf.name="uOpacityFactor"+this._styleID,this.uniformFloatOpacityFactor._vf.type="SFFloat",this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,e.push(this.uniformFloatOpacityFactor),this.uniformFloatLightFactor._vf.name="uLightFactor"+this._styleID,this.uniformFloatLightFactor._vf.type="SFFloat",this.uniformFloatLightFactor._vf.value=this._vf.lightFactor,e.push(this.uniformFloatLightFactor),this.uniformBoolEnableOpacityMap._vf.name="uEnableOpacityMap"+this._styleID,this.uniformBoolEnableOpacityMap._vf.type="SFBool",this.uniformBoolEnableOpacityMap._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableOpacityMap),e},textures:function(){var e=[],t=this._cf.transferFunction.node;return t&&(t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)),e},styleUniformsShaderText:function(){var e="uniform float uOpacityFactor"+this._styleID+";\nuniform float uLightFactor"+this._styleID+";\nuniform bool uEnableOpacityMap"+this._styleID+";\n";return this._cf.transferFunction.node&&(e+="uniform sampler2D uTransferFunction"+this._styleID+";\n"),e},inlineStyleShaderText:function(){var e="    if(uEnableOpacityMap"+this._styleID+"){\n       opacityFactor = uOpacityFactor"+this._styleID+";\n       lightFactor = uLightFactor"+this._styleID+";\n";return this._cf.transferFunction.node&&(e+="       value = texture2D(uTransferFunction"+this._styleID+",vec2(value.r,0.5));\n"),e+="    }\n"}})),x3dom.registerNodeType("ProjectionVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.ProjectionVolumeStyle.superClass.call(this,e),this.addField_SFFloat(e,"intensityThreshold",0),this.addField_SFString(e,"type","MAX"),this.uniformIntensityThreshold=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){"intensityThreshold"===e&&(this.uniformIntensityThreshold._vf.value=this._vf.intensityThreshold,this.uniformIntensityThreshold.fieldChanged("value"))},uniforms:function(){var e=[];return this.uniformIntensityThreshold._vf.name="uIntensityThreshold",this.uniformIntensityThreshold._vf.type="SFFloat",this.uniformIntensityThreshold._vf.value=this._vf.intensityThreshold,e.push(this.uniformIntensityThreshold),e},styleUniformsShaderText:function(){return"uniform int uType;\nuniform float uIntensityThreshold;\n"},fragmentShaderText:function(e,t,i){var s=this._parentNodes[0].fragmentPreamble+this._parentNodes[0].defaultUniformsShaderText(e,t,i)+this.styleUniformsShaderText()+this._parentNodes[0].texture3DFunctionShaderText+"void main()\n{\n  vec3 cam_pos = vec3(modelViewMatrixInverse[3][0], modelViewMatrixInverse[3][1], modelViewMatrixInverse[3][2]);\n  cam_pos = cam_pos/dimensions+0.5;\n  vec3 dir = normalize(pos.xyz-cam_pos);\n  vec3 ray_pos = pos.xyz;\n  vec4 accum  = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 sample = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 value  = vec4(0.0, 0.0, 0.0, 0.0);\n  vec4 color  = vec4(0.0);\n";if("max"===this._vf.type.toLowerCase()?s+="vec2 previous_value = vec2(0.0);\n":s+="vec2 previous_value = vec2(1.0);\n",s+="  float cont = 0.0;\n  vec3 step_size = (dir*1.4142)/Steps;\n  const float lightFactor = 1.3;\n  const float opacityFactor = 3.0;\n  for(float i = 0.0; i < Steps; i+=1.0)\n  {\n    value = cTexture3D(uVolData,ray_pos,numberOfSlices,slicesOverX,slicesOverY);\n    value = vec4(value.rgb,(0.299*value.r)+(0.587*value.g)+(0.114*value.b));\n    //Process the volume sample\n    sample.a = value.a * opacityFactor * (1.0/Steps);\n    sample.rgb = value.rgb * sample.a * lightFactor;\n    accum.a += (1.0-accum.a)*sample.a;\n",this._vf.enabled)switch(this._vf.type.toLowerCase()){case"max":s+="if(value.r > uIntensityThreshold && value.r <= previous_value.x){\n   break;\n}\ncolor.rgb = vec3(max(value.r, previous_value.x));\ncolor.a = (value.r > previous_value.x) ? accum.a : previous_value.y;\n";break;case"min":s+="if(value.r < uIntensityThreshold && value.r >= previous_value.x){\n   break;\n}\ncolor.rgb = vec3(min(value.r, previous_value.x));\ncolor.a = (value.r < previous_value.x) ? accum.a : previous_value.y;\n";break;case"average":s+="color.rgb += (1.0 - accum.a) * sample.rgb;\ncolor.a = accum.a;\n"}return s+="    //update the previous value and keeping the accumulated alpha\n    previous_value.x = color.r;\n    previous_value.y = accum.a;\n    //advance the current position\n    ray_pos.xyz += step_size;\n    //break if the position is greater than <1, 1, 1>\n    if(ray_pos.x > 1.0 || ray_pos.y > 1.0 || ray_pos.z > 1.0 || ray_pos.x <= 0.0 || ray_pos.y <= 0.0 || ray_pos.z <= 0.0 || accum.a>=1.0){\n","average"==this._vf.type.toLowerCase()&&this._vf.enabled&&(s+="     if((i > 0.0) && (i < Steps-1.0)){\ncolor.rgb = color.rgb/i;\n}\n"),s+="      break;\n    }\n }\n gl_FragColor = color;\n}"}})),x3dom.registerNodeType("SegmentedVolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,(function(e){x3dom.nodeTypes.SegmentedVolumeData.superClass.call(this,e),this.addField_MFNode("renderStyle",x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode),this.addField_SFNode("segmentIdentifiers",x3dom.nodeTypes.Texture),this.addField_SFFloat(e,"numberOfMaxSegments",10),this.uniformSampler2DSegmentIdentifiers=new x3dom.nodeTypes.Uniform(e),this.normalTextureProvided=!1,this.vrcMultiTexture=new x3dom.nodeTypes.MultiTexture(e),this.vrcVolumeTexture=null,this.vrcSinglePassShader=new x3dom.nodeTypes.ComposedShader(e),this.vrcSinglePassShaderVertex=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFragment=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFieldBackCoord=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldVolData=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldOffset=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldDimensions=new x3dom.nodeTypes.Field(e)}),{fieldChanged:function(e){"numberOfMaxSegments"===e||fieldname},uniforms:function(){var e=[];if(this._cf.segmentIdentifiers.node&&(this.uniformSampler2DSegmentIdentifiers._vf.name="uSegmentIdentifiers",this.uniformSampler2DSegmentIdentifiers._vf.type="SFInt32",this.uniformSampler2DSegmentIdentifiers._vf.value=this._textureID++,e.push(this.uniformSampler2DSegmentIdentifiers)),this._cf.renderStyle.nodes){var t,i=this._cf.renderStyle.nodes.length;for(t=0;t<i;t++){this._cf.renderStyle.nodes[t].uniforms().forEach((function(t){var i=!1;e.forEach((function(e){e._vf.name==t._vf.name&&(i=!0)})),0==i&&(e=e.concat(t))}))}}return e},textures:function(){var e=[];if(this._cf.segmentIdentifiers.node){var t=this._cf.segmentIdentifiers.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}var i,s=this._cf.renderStyle.nodes.length;for(i=0;i<s;i++)this._cf.renderStyle.nodes[i].textures().forEach((function(t){var i=!1;e.forEach((function(e){e._vf.url[0]==t._vf.url[0]&&(i=!0)})),0==i&&(e=e.concat(t))}));return e},initializeValues:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].initializeValues&&(e+=this._cf.renderStyle.nodes[i].initializeValues()+"\n");return e},styleUniformsShaderText:function(){for(var e="const float maxSegments = "+this._vf.numberOfMaxSegments.toPrecision(3)+";\nuniform sampler2D uSegmentIdentifiers;\n",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)e+=this._cf.renderStyle.nodes[i].styleUniformsShaderText()+"\n",this._cf.renderStyle.nodes[i]._cf.surfaceNormals&&null!=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node&&(e+="uniform sampler2D uSurfaceNormals;\n",this.normalTextureProvided=!0,this.surfaceNormals=this._cf.renderStyle.nodes[i]._cf.surfaceNormals.node),x3dom.isa(this._cf.renderStyle.nodes[i],x3dom.nodeTypes.OpacityMapVolumeStyle)||(this.surfaceNormalsNeeded=!0);return e},styleShaderText:function(){for(var e="",t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)null!=this._cf.renderStyle.nodes[i].styleShaderText&&(e+=this._cf.renderStyle.nodes[i].styleShaderText()+"\n");return e},inlineStyleShaderText:function(){var e="";this._cf.segmentIdentifiers.node?(e+="    float t_id = cTexture3D(uSegmentIdentifiers, ray_pos, numberOfSlices, slicesOverX, slicesOverY).r;\n    int s_id = int(clamp(floor(t_id*maxSegments-0.5),0.0,maxSegments));\n    opacityFactor = 10.0;\n",x3dom.nodeTypes.X3DLightNode.lightID>0?e+="    lightFactor = 1.0;\n":e+="    lightFactor = 1.2;\n"):e+="    int s_id = 0;\n";for(var t=this._cf.renderStyle.nodes.length,i=0;i<t;i++)e+="    if (s_id == "+i+"){\n"+this._cf.renderStyle.nodes[i].inlineStyleShaderText()+"    }\n";return e},lightAssigment:function(){return this._cf.renderStyle.nodes[0].lightAssigment()},lightEquationShaderText:function(){return this._cf.renderStyle.nodes[0].lightEquationShaderText()},nodeChanged:function(){if(!this._cf.appearance.node){this.addChild(new x3dom.nodeTypes.Appearance),this.vrcVolumeTexture=this._cf.voxels.node,this.vrcVolumeTexture._vf.repeatS=!1,this.vrcVolumeTexture._vf.repeatT=!1,this.vrcMultiTexture._nameSpace=this._nameSpace,this.vrcMultiTexture.addChild(this.vrcVolumeTexture,"texture"),this.vrcVolumeTexture.nodeChanged();var e=this.textures();for(t=0;t<e.length;t++)this.vrcMultiTexture.addChild(e[t],"texture"),this.vrcVolumeTexture.nodeChanged();this._cf.appearance.node.addChild(this.vrcMultiTexture),this.vrcMultiTexture.nodeChanged();for(var t=0;t<this._cf.renderStyle.nodes.length;t++)this._cf.renderStyle.nodes[t].updateProperties(this);this.vrcSinglePassShaderVertex._vf.type="vertex",this.vrcSinglePassShaderVertex._vf.url[0]=this.vertexShaderText(),this.vrcSinglePassShaderFragment._vf.type="fragment";var i=this.fragmentPreamble+this.defaultUniformsShaderText(this.vrcVolumeTexture._vf.numberOfSlices,this.vrcVolumeTexture._vf.slicesOverX,this.vrcVolumeTexture._vf.slicesOverY)+this.styleUniformsShaderText()+this.styleShaderText()+this.texture3DFunctionShaderText+this.normalFunctionShaderText()+this.lightEquationShaderText()+this.defaultLoopFragmentShaderText(this.inlineStyleShaderText(),this.lightAssigment(),this.initializeValues());this.vrcSinglePassShaderFragment._vf.url[0]=i,this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderVertex,"parts"),this.vrcSinglePassShaderVertex.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFragment,"parts"),this.vrcSinglePassShaderFragment.nodeChanged(),this.vrcSinglePassShaderFieldVolData._vf.name="uVolData",this.vrcSinglePassShaderFieldVolData._vf.type="SFInt32",this.vrcSinglePassShaderFieldVolData._vf.value=this._textureID++,this.vrcSinglePassShaderFieldDimensions._vf.name="dimensions",this.vrcSinglePassShaderFieldDimensions._vf.type="SFVec3f",this.vrcSinglePassShaderFieldDimensions._vf.value=this._vf.dimensions,this.vrcSinglePassShaderFieldOffset._vf.name="offset",this.vrcSinglePassShaderFieldOffset._vf.type="SFVec3f",this.vrcSinglePassShaderFieldOffset._vf.value="0.01 0.01 0.01",this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldVolData,"fields"),this.vrcSinglePassShaderFieldVolData.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldDimensions,"fields"),this.vrcSinglePassShaderFieldDimensions.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldOffset,"fields"),this.offsetInterval=window.setInterval((o=this.vrcVolumeTexture,n=this,function(){x3dom.debug.logInfo("[VolumeRendering][SegmentedVolumeData] Looking for Volume Texture size...");var e=n.getTextureSize(o);e.valid&&(clearInterval(n.offsetInterval),n.vrcSinglePassShaderFieldOffset._vf.value=new x3dom.fields.SFVec3f(1/(e.w/o._vf.slicesOverX),1/(e.h/o._vf.slicesOverY),1/o._vf.numberOfSlices),n.vrcSinglePassShader.nodeChanged(),x3dom.debug.logInfo("[VolumeRendering][SegmentedVolumeData] Volume Texture size obtained"))}),1e3);var s=this.uniforms();for(t=0;t<s.length;t++)this.vrcSinglePassShader.addChild(s[t],"fields");this._cf.appearance.node.addChild(this.vrcSinglePassShader),this.vrcSinglePassShader.nodeChanged(),this._cf.appearance.node.nodeChanged()}var o,n;this._cf.geometry.node||(this.addChild(new x3dom.nodeTypes.Box),this._cf.geometry.node._vf.solid=!1,this._cf.geometry.node._vf.hasHelperColors=!1,this._cf.geometry.node._vf.size=new x3dom.fields.SFVec3f(this._vf.dimensions.x,this._vf.dimensions.y,this._vf.dimensions.z),this._cf.geometry.node.fieldChanged("size"))}})),x3dom.registerNodeType("ShadedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.ShadedVolumeStyle.superClass.call(this,e),this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode),this.addField_SFBool(e,"lighting",!1),this.addField_SFBool(e,"shadows",!1),this.addField_SFString(e,"phaseFunction","Henyey-Greenstein"),this.uniformBoolLigthning=new x3dom.nodeTypes.Uniform(e),this.uniformBoolShadows=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformColorSpecular=new x3dom.nodeTypes.Uniform(e),this.uniformFloatAmbientIntensity=new x3dom.nodeTypes.Uniform(e),this.uniformFloatShininess=new x3dom.nodeTypes.Uniform(e),this.uniformFloatTransparency=new x3dom.nodeTypes.Uniform(e),this.uniformColorEmissive=new x3dom.nodeTypes.Uniform(e),this.uniformColorDiffuse=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableShaded=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"lightning":this.uniformBoolLightning._vf.value=this._vf.lightning,this.uniformBoolLightning.fieldChanged("value");break;case"shadows":this.uniformBoolShadows._vf.value=this._vf.shadows,this.uniformBoolShadows.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.surfaceNormals.node&&(this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DSurfaceNormals)),this.uniformBoolLigthning._vf.name="uLightning"+this._styleID,this.uniformBoolLigthning._vf.type="SFBool",this.uniformBoolLigthning._vf.value=this._vf.lighting,e.push(this.uniformBoolLigthning),this.uniformBoolShadows._vf.name="uShadows"+this._styleID,this.uniformBoolShadows._vf.type="SFBool",this.uniformBoolShadows._vf.value=this._vf.shadows,e.push(this.uniformBoolShadows),null!=this._cf.material.node&&(this.uniformColorSpecular._vf.name="specularColor"+this._styleID,this.uniformColorSpecular._vf.type="SFColor",this.uniformColorSpecular._vf.value=this._cf.material.node._vf.specularColor,e.push(this.uniformColorSpecular),this.uniformColorDiffuse._vf.name="diffuseColor"+this._styleID,this.uniformColorDiffuse._vf.type="SFColor",this.uniformColorDiffuse._vf.value=this._cf.material.node._vf.diffuseColor,e.push(this.uniformColorDiffuse),this.uniformColorEmissive._vf.name="emissiveColor"+this._styleID,this.uniformColorEmissive._vf.type="SFColor",this.uniformColorEmissive._vf.value=this._cf.material.node._vf.emissiveColor,e.push(this.uniformColorEmissive),this.uniformFloatAmbientIntensity._vf.name="ambientIntensity"+this._styleID,this.uniformFloatAmbientIntensity._vf.type="SFFloat",this.uniformFloatAmbientIntensity._vf.value=this._cf.material.node._vf.ambientIntensity,e.push(this.uniformFloatAmbientIntensity),this.uniformFloatShininess._vf.name="shininess"+this._styleID,this.uniformFloatShininess._vf.type="SFFloat",this.uniformFloatShininess._vf.value=this._cf.material.node._vf.shininess,e.push(this.uniformFloatShininess),this.uniformFloatTransparency._vf.name="transparency"+this._styleID,this.uniformFloatTransparency._vf.type="SFFloat",this.uniformFloatTransparency._vf.value=this._cf.material.node._vf.transperency,e.push(this.uniformFloatTransparency)),this.uniformBoolEnableShaded._vf.name="uEnableShaded"+this._styleID,this.uniformBoolEnableShaded._vf.type="SFBool",this.uniformBoolEnableShaded._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableShaded),e},textures:function(){var e=[];if(this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleUniformsShaderText:function(){var e="uniform bool uLightning"+this._styleID+";\nuniform bool uShadows"+this._styleID+";\nuniform float fogRange;\nuniform vec3 fogColor;\nuniform float fogType;\nuniform bool uEnableShaded"+this._styleID+";\n";return this._cf.material.node&&(e+="uniform vec3  diffuseColor"+this._styleID+";\nuniform vec3  specularColor"+this._styleID+";\nuniform vec3  emissiveColor"+this._styleID+";\nuniform float shininess"+this._styleID+";\nuniform float transparency"+this._styleID+";\nuniform float ambientIntensity"+this._styleID+";\n"),e},styleShaderText:function(){return this._first?"float computeFogInterpolant(float distanceFromPoint)\n{\n  if (distanceFromPoint > fogRange){\n    return 0.0;\n  }else if (fogType == 0.0){\n    return clamp((fogRange-distanceFromPoint) / fogRange, 0.0, 1.0);\n  }else{\n    return clamp(exp(-distanceFromPoint / (fogRange-distanceFromPoint)), 0.0, 1.0);\n  }\n}\n":""},lightEquationShaderText:function(){return this._first?"void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in float ambientIntensity, in float shininess, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n       V = normalize(V);\n       attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n       L = normalize(L);\n       V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n           attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n       }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3 H = normalize( L + V );\n   float NdotL = max(0.0, dot(L, N));\n   float NdotH = max(0.0, dot(H, N));\n   float ambientFactor = lAmbientIntensity * ambientIntensity;\n   float diffuseFactor = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shininess*128.0);\n   ambient += lColor * ambientFactor * attentuation * spot;\n   diffuse += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n":""},inlineStyleShaderText:function(){return this._first?"    float fogFactor = computeFogInterpolant(length(cam_pos-ray_pos));\n":""},lightAssigment:function(){for(var e="    if(uEnableShaded"+this._styleID+"){\n",t=0;t<x3dom.nodeTypes.X3DLightNode.lightID;t++)e+="    lighting(light"+t+"_Type, light"+t+"_Location, light"+t+"_Direction, light"+t+"_Color, light"+t+"_Attenuation, light"+t+"_Radius, light"+t+"_Intensity, light"+t+"_AmbientIntensity, light"+t+"_BeamWidth, light"+t+"_CutOffAngle, ambientIntensity"+this._styleID+", shininess"+this._styleID+", grad.xyz, positionE.xyz, ambient, diffuse, specular);\n";return 1==this._vf.lighting&&(this._cf.material.node?e+="      value.rgb = (fogColor*(1.0-fogFactor))+fogFactor*(emissiveColor"+this._styleID+" + ambient*value.rgb + diffuse*diffuseColor"+this._styleID+"*value.rgb + specular*specularColor"+this._styleID+");\n      value.a = value.a*(1.0-transparency"+this._styleID+");\n":e+="      value.rgb = (fogColor*(1.0-fogFactor))+fogFactor*(ambient*value.rgb + diffuse*value.rgb + specular);\n"),e+="    }\n"}})),x3dom.registerNodeType("SilhouetteEnhancementVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.SilhouetteEnhancementVolumeStyle.superClass.call(this,e),this.addField_SFFloat(e,"silhouetteBoundaryOpacity",0),this.addField_SFFloat(e,"silhouetteRetainedOpacity",1),this.addField_SFFloat(e,"silhouetteSharpness",.5),this.uniformFloatBoundaryOpacity=new x3dom.nodeTypes.Uniform(e),this.uniformFloatRetainedOpacity=new x3dom.nodeTypes.Uniform(e),this.uniformFloatSilhouetteSharpness=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableSilhouette=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"silhouetteBoundaryOpacity":this.uniformFloatBoundaryOpacity._vf.value=this._vf.silhouetteBoundaryOpacity,this.uniformFloatBoundaryOpacity.fieldChanged("value");break;case"silhouetteRetainedOpacity":this.uniformFloatRetainedOpacity._vf.value=this._vf.silhouetteRetainedOpacity,this.uniformFloatRetainedOpacity.fieldChanged("value");break;case"silhouetteSharpness":this.uniformFloatSilhouetteSharpness._vf.value=this._vf.silhouetteSharpness,this.uniformFloatSilhouetteSharpness.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.surfaceNormals.node&&(this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DSurfaceNormals)),this.uniformFloatBoundaryOpacity._vf.name="uSilhouetteBoundaryOpacity"+this._styleID,this.uniformFloatBoundaryOpacity._vf.type="SFFloat",this.uniformFloatBoundaryOpacity._vf.value=this._vf.silhouetteBoundaryOpacity,e.push(this.uniformFloatBoundaryOpacity),this.uniformFloatRetainedOpacity._vf.name="uSilhouetteRetainedOpacity"+this._styleID,this.uniformFloatRetainedOpacity._vf.type="SFFloat",this.uniformFloatRetainedOpacity._vf.value=this._vf.silhouetteRetainedOpacity,e.push(this.uniformFloatRetainedOpacity),this.uniformFloatSilhouetteSharpness._vf.name="uSilhouetteSharpness"+this._styleID,this.uniformFloatSilhouetteSharpness._vf.type="SFFloat",this.uniformFloatSilhouetteSharpness._vf.value=this._vf.silhouetteSharpness,e.push(this.uniformFloatSilhouetteSharpness),this.uniformBoolEnableSilhouette._vf.name="uEnableSilhouette"+this._styleID,this.uniformBoolEnableSilhouette._vf.type="SFBool",this.uniformBoolEnableSilhouette._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableSilhouette),e},textures:function(){var e=[];if(null!=this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleUniformsShaderText:function(){return"uniform float uSilhouetteBoundaryOpacity"+this._styleID+";\nuniform float uSilhouetteRetainedOpacity"+this._styleID+";\nuniform float uSilhouetteSharpness"+this._styleID+";\nuniform bool uEnableSilhouette"+this._styleID+";\n"},styleShaderText:function(){return this._first?"void silhouetteEnhancement(inout vec4 orig_color, in vec4 normal, in vec3 V, in float sBoundary, in float sRetained, in float sSharpness)\n{\n   if(normal.w > 0.02){\n       orig_color.a = orig_color.a * (sRetained + sBoundary * pow((1.0-abs(dot(normal.xyz, V))), sSharpness));\n   }\n}\n\n":""},inlineStyleShaderText:function(){return"  if(uEnableSilhouette"+this._styleID+"){\n       silhouetteEnhancement(value, gradEye, dir, uSilhouetteBoundaryOpacity"+this._styleID+", uSilhouetteRetainedOpacity"+this._styleID+", uSilhouetteSharpness"+this._styleID+");\n   }\n"}})),x3dom.registerNodeType("StippleVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.StippleVolumeStyle.superClass.call(this,e),this.addField_SFFloat(e,"distanceFactor",1),this.addField_SFFloat(e,"interiorFactor",1),this.addField_SFFloat(e,"lightingFactor",1),this.addField_SFFloat(e,"gradientThreshold",.4),this.addField_SFFloat(e,"gradientRetainedOpacity",1),this.addField_SFFloat(e,"gradientBoundaryOpacity",0),this.addField_SFFloat(e,"gradientOpacityFactor",1),this.addField_SFFloat(e,"silhouetteRetainedOpacity",1),this.addField_SFFloat(e,"silhouetteBoundaryOpacity",0),this.addField_SFFloat(e,"silhouetteOpacityFactor",1),this.addField_SFFloat(e,"resolutionFactor",1)}))),x3dom.registerNodeType("ToneMappedVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.ToneMappedVolumeStyle.superClass.call(this,e),this.addField_SFColor(e,"coolColor",0,0,1),this.addField_SFColor(e,"warmColor",1,1,0),this.uniformCoolColor=new x3dom.nodeTypes.Uniform(e),this.uniformWarmColor=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DSurfaceNormals=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableToneMapped=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"coolColor":this.uniformCoolColor._vf.value=this._vf.coolColor,this.uniformCoolColor.fieldChanged("value");break;case"warmColor":this.uniformWarmColor._vf.value=this._vf.warmColor,this.uniformWarmColor.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.surfaceNormals.node&&(this.uniformSampler2DSurfaceNormals._vf.name="uSurfaceNormals",this.uniformSampler2DSurfaceNormals._vf.type="SFInt32",this.uniformSampler2DSurfaceNormals._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DSurfaceNormals)),this.uniformCoolColor._vf.name="uCoolColor"+this._styleID,this.uniformCoolColor._vf.type="SFColor",this.uniformCoolColor._vf.value=this._vf.coolColor,e.push(this.uniformCoolColor),this.uniformWarmColor._vf.name="uWarmColor"+this._styleID,this.uniformWarmColor._vf.type="SFColor",this.uniformWarmColor._vf.value=this._vf.warmColor,e.push(this.uniformWarmColor),this.uniformBoolEnableToneMapped._vf.name="uEnableToneMapped"+this._styleID,this.uniformBoolEnableToneMapped._vf.type="SFBool",this.uniformBoolEnableToneMapped._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableToneMapped),e},textures:function(){var e=[];if(this._cf.surfaceNormals.node){var t=this._cf.surfaceNormals.node;t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)}return e},styleUniformsShaderText:function(){return"uniform vec3 uCoolColor"+this._styleID+";\nuniform vec3 uWarmColor"+this._styleID+";\nuniform bool uEnableToneMapped"+this._styleID+";\n"},styleShaderText:function(){return this._first?"void toneMapped(inout vec4 original_color, inout vec3 accum_color, in vec4 surfNormal, in vec3 lightDir, in vec3 cColor, in vec3 wColor)\n{\n   if(surfNormal.a > 0.02){\n       float color_factor = (1.0 + dot(lightDir, surfNormal.xyz))*0.5;\n       accum_color += mix(wColor, cColor, color_factor);\n       original_color.rgb = accum_color;\n   }else{\n       accum_color += mix(wColor, cColor, 0.5);\n       original_color.rgb = accum_color;\n   }\n}\n":""},inlineStyleShaderText:function(){for(var e="    if(uEnableToneMapped"+this._styleID+"){\n       vec3 toneColor = vec3(0.0, 0.0, 0.0);\n       vec3 L = vec3(0.0, 0.0, 0.0);\n",t=0;t<x3dom.nodeTypes.X3DLightNode.lightID;t++)e+="       L = (light"+t+"_Type == 1.0) ? normalize(light"+t+"_Location - positionE.xyz) : -light"+t+"_Direction;\n       toneMapped(value, toneColor, grad, L, uCoolColor"+this._styleID+", uWarmColor"+this._styleID+");\n";return e+="    }\n"},lightAssigment:function(){return""}})),x3dom.registerNodeType("RadarVolumeStyle","VolumeRendering",defineClass(x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode,(function(e){x3dom.nodeTypes.RadarVolumeStyle.superClass.call(this,e),this.addField_SFNode("transferFunction",x3dom.nodeTypes.Texture),this.addField_SFString(e,"type","simple"),this.addField_SFFloat(e,"opacityFactor",6),this.addField_SFFloat(e,"lightFactor",1.2),this.uniformFloatOpacityFactor=new x3dom.nodeTypes.Uniform(e),this.uniformFloatLightFactor=new x3dom.nodeTypes.Uniform(e),this.uniformSampler2DTransferFunction=new x3dom.nodeTypes.Uniform(e),this.uniformBoolEnableOpacityMap=new x3dom.nodeTypes.Uniform(e)}),{fieldChanged:function(e){switch(e){case"opacityFactor":this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,this.uniformFloatOpacityFactor.fieldChanged("value");break;case"lightFactor":this.uniformFloatLightFactor._vf.value=this._vf.lightFactor,this.uniformFloatLightFactor.fieldChanged("value")}},uniforms:function(){var e=[];return this._cf.transferFunction.node&&(this.uniformSampler2DTransferFunction._vf.name="uTransferFunction"+this._styleID,this.uniformSampler2DTransferFunction._vf.type="SFInt32",this.uniformSampler2DTransferFunction._vf.value=this._volumeDataParent._textureID++,e.push(this.uniformSampler2DTransferFunction)),this.uniformFloatOpacityFactor._vf.name="uOpacityFactor"+this._styleID,this.uniformFloatOpacityFactor._vf.type="SFFloat",this.uniformFloatOpacityFactor._vf.value=this._vf.opacityFactor,e.push(this.uniformFloatOpacityFactor),this.uniformFloatLightFactor._vf.name="uLightFactor"+this._styleID,this.uniformFloatLightFactor._vf.type="SFFloat",this.uniformFloatLightFactor._vf.value=this._vf.lightFactor,e.push(this.uniformFloatLightFactor),this.uniformBoolEnableOpacityMap._vf.name="uEnableOpacityMap"+this._styleID,this.uniformBoolEnableOpacityMap._vf.type="SFBool",this.uniformBoolEnableOpacityMap._vf.value=this._vf.enabled,e.push(this.uniformBoolEnableOpacityMap),e},textures:function(){var e=[],t=this._cf.transferFunction.node;return t&&(t._vf.repeatS=!1,t._vf.repeatT=!1,e.push(t)),e},styleUniformsShaderText:function(){var e="uniform float uOpacityFactor"+this._styleID+";\nuniform float uLightFactor"+this._styleID+";\nuniform bool uEnableOpacityMap"+this._styleID+";\n";return this._cf.transferFunction.node&&(e+="uniform sampler2D uTransferFunction"+this._styleID+";\n"),e},inlineStyleShaderText:function(){var e="    if(uEnableOpacityMap"+this._styleID+"){\n       opacityFactor = uOpacityFactor"+this._styleID+";\n       lightFactor = uLightFactor"+this._styleID+";\n";return this._cf.transferFunction.node&&(e+="       if(value.r > 0.3){\n",e+="         value = texture2D(uTransferFunction"+this._styleID+",vec2(value.r,0.5));\n",e+="       }else{\n",e+="         value.a = 0.0;\n",e+="       }\n"),e+="    }\n"}})),x3dom.registerNodeType("VolumeData","VolumeRendering",defineClass(x3dom.nodeTypes.X3DVolumeDataNode,(function(e){x3dom.nodeTypes.VolumeData.superClass.call(this,e),this.addField_SFNode("renderStyle",x3dom.nodeTypes.X3DVolumeRenderStyleNode),this.vrcMultiTexture=new x3dom.nodeTypes.MultiTexture(e),this.vrcVolumeTexture=null,this.vrcSinglePassShader=new x3dom.nodeTypes.ComposedShader(e),this.vrcSinglePassShaderVertex=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFragment=new x3dom.nodeTypes.ShaderPart(e),this.vrcSinglePassShaderFieldBackCoord=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldVolData=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldOffset=new x3dom.nodeTypes.Field(e),this.vrcSinglePassShaderFieldDimensions=new x3dom.nodeTypes.Field(e)}),{initializeValues:function(){var e="";return null!=this._cf.renderStyle.node.initializeValues&&(e+=this._cf.renderStyle.node.initializeValues()),e},styleUniformsShaderText:function(){var e=this._cf.renderStyle.node.styleUniformsShaderText();return this.surfaceNormalsNeeded=!0,this._cf.renderStyle.node._cf.surfaceNormals&&null!=this._cf.renderStyle.node._cf.surfaceNormals.node?(e+="uniform sampler2D uSurfaceNormals;\n",this.normalTextureProvided=!0,this.surfaceNormals=this._cf.renderStyle.node._cf.surfaceNormals.node):x3dom.isa(this._cf.renderStyle.node,x3dom.nodeTypes.OpacityMapVolumeStyle)&&(this.surfaceNormalsNeeded=!1,this.normalTextureProvided=!1),e},styleShaderText:function(){var e="";return null!=this._cf.renderStyle.node.styleShaderText&&(e+=this._cf.renderStyle.node.styleShaderText()),e},inlineStyleShaderText:function(){return this._cf.renderStyle.node.inlineStyleShaderText()},lightAssigment:function(){return this._cf.renderStyle.node.lightAssigment()},lightEquationShaderText:function(){return this._cf.renderStyle.node.lightEquationShaderText()},nodeChanged:function(){if(!this._cf.appearance.node){var e;if(this.addChild(new x3dom.nodeTypes.Appearance),this.vrcVolumeTexture=this._cf.voxels.node,this.vrcVolumeTexture._vf.repeatS=!1,this.vrcVolumeTexture._vf.repeatT=!1,this.vrcMultiTexture._nameSpace=this._nameSpace,this.vrcMultiTexture.addChild(this.vrcVolumeTexture,"texture"),this.vrcVolumeTexture.nodeChanged(),this._cf.renderStyle.node.textures){var t=this._cf.renderStyle.node.textures();for(e=0;e<t.length;e++)this.vrcMultiTexture.addChild(t[e],"texture"),this.vrcVolumeTexture.nodeChanged()}this._cf.appearance.node.addChild(this.vrcMultiTexture),this.vrcMultiTexture.nodeChanged(),this._cf.renderStyle.node.updateProperties(this),this.vrcSinglePassShaderVertex._vf.type="vertex",this.vrcSinglePassShaderVertex._vf.url[0]=this.vertexShaderText(x3dom.isa(this._cf.renderStyle.node,x3dom.nodeTypes.RadarVolumeStyle)),this.vrcSinglePassShaderFragment._vf.type="fragment";var i="";x3dom.isa(this._cf.renderStyle.node,x3dom.nodeTypes.X3DComposableVolumeRenderStyleNode)?i+=this.fragmentPreamble+this.defaultUniformsShaderText(this.vrcVolumeTexture._vf.numberOfSlices,this.vrcVolumeTexture._vf.slicesOverX,this.vrcVolumeTexture._vf.slicesOverY)+this.styleUniformsShaderText()+this.styleShaderText()+this.texture3DFunctionShaderText+this.normalFunctionShaderText()+this.lightEquationShaderText()+this.defaultLoopFragmentShaderText(this.inlineStyleShaderText(),this.lightAssigment(),this.initializeValues()):i+=this._cf.renderStyle.node.fragmentShaderText(this.vrcVolumeTexture._vf.numberOfSlices,this.vrcVolumeTexture._vf.slicesOverX,this.vrcVolumeTexture._vf.slicesOverY),this.vrcSinglePassShaderFragment._vf.url[0]=i,this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderVertex,"parts"),this.vrcSinglePassShaderVertex.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFragment,"parts"),this.vrcSinglePassShaderFragment.nodeChanged(),this.vrcSinglePassShaderFieldVolData._vf.name="uVolData",this.vrcSinglePassShaderFieldVolData._vf.type="SFInt32",this.vrcSinglePassShaderFieldVolData._vf.value=this._textureID++,this.vrcSinglePassShaderFieldDimensions._vf.name="dimensions",this.vrcSinglePassShaderFieldDimensions._vf.type="SFVec3f",this.vrcSinglePassShaderFieldDimensions._vf.value=this._vf.dimensions,this.vrcSinglePassShaderFieldOffset._vf.name="offset",this.vrcSinglePassShaderFieldOffset._vf.type="SFVec3f",this.vrcSinglePassShaderFieldOffset._vf.value="0.01 0.01 0.01",this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldVolData,"fields"),this.vrcSinglePassShaderFieldVolData.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldDimensions,"fields"),this.vrcSinglePassShaderFieldDimensions.nodeChanged(),this.vrcSinglePassShader.addChild(this.vrcSinglePassShaderFieldOffset,"fields"),this.offsetInterval=window.setInterval((o=this.vrcVolumeTexture,n=this,function(){x3dom.debug.logInfo("[VolumeRendering][VolumeData] Looking for Volume Texture size...");var e=n.getTextureSize(o);e.valid&&(clearInterval(n.offsetInterval),n.vrcSinglePassShaderFieldOffset._vf.value=new x3dom.fields.SFVec3f(1/(e.w/o._vf.slicesOverX),1/(e.h/o._vf.slicesOverY),1/o._vf.numberOfSlices),n.vrcSinglePassShader.nodeChanged(),x3dom.debug.logInfo("[VolumeRendering][VolumeData] Volume Texture size obtained"))}),1e3);var s=this._cf.renderStyle.node.uniforms();for(e=0;e<s.length;e++)this.vrcSinglePassShader.addChild(s[e],"fields");this._cf.appearance.node.addChild(this.vrcSinglePassShader),this.vrcSinglePassShader.nodeChanged(),this._cf.appearance.node.nodeChanged()}var o,n;this._cf.geometry.node||(this.addChild(new x3dom.nodeTypes.Box),this._cf.geometry.node._vf.solid=!1,this._cf.geometry.node._vf.hasHelperColors=!1,this._cf.geometry.node._vf.size=new x3dom.fields.SFVec3f(this._vf.dimensions.x,this._vf.dimensions.y,this._vf.dimensions.z),this._cf.geometry.node.fieldChanged("size"))}})),x3dom.registerNodeType("IndexedQuadSet","CADGeometry",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.IndexedQuadSet.superClass.call(this,e),this.addField_MFInt32(e,"index",[])}),{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,s,o,n=this._vf.colorPerVertex,r=this._vf.normalPerVertex,a=this._vf.index,d=!1,h=!1,l=!1,f=this._cf.coord.node;x3dom.debug.assert(f),t=f._vf.point;var u=this._cf.normal.node;u?(d=!0,i=u._vf.vector):d=!1;var _="",c=2,m=this._cf.texCoord.node;x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]),m?m._vf.point?(h=!0,s=m._vf.point,x3dom.isa(m,x3dom.nodeTypes.TextureCoordinate3D)&&(c=3)):m._vf.mode&&(_=m._vf.mode):h=!1;var p,x,v=3,g=this._cf.color.node;for(g?(l=!0,o=g._vf.color,x3dom.isa(g,x3dom.nodeTypes.ColorRGBA)&&(v=4)):l=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];t.length%4>0;)t.push(t.length-1);for(t.length,x=0,p=0;p<a.length;p++)p>0&&p%4==3?(x++,this._mesh._indices[0].push(a[p-3]),this._mesh._indices[0].push(a[p-1]),this._mesh._indices[0].push(a[p])):this._mesh._indices[0].push(a[p]),!r&&d&&(this._mesh._normals[0].push(i[x].x),this._mesh._normals[0].push(i[x].y),this._mesh._normals[0].push(i[x].z)),!n&&l&&(this._mesh._colors[0].push(o[x].r),this._mesh._colors[0].push(o[x].g),this._mesh._colors[0].push(o[x].b),4===v&&this._mesh._colors[0].push(o[x].a));for(this._mesh._positions[0]=t.toGL(),d?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(r?Math.PI:0),h?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=c):this._mesh.calcTexCoords(_),l&&n&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=v),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,p=0;p<this._mesh._indices.length;p++)this._mesh._numFaces+=this._mesh._indices[p].length/3,this._mesh._numCoords+=this._mesh._positions[p].length/3;(new Date).getTime()},fieldChanged:function(e){var t=this._cf.coord.node._vf.point;if(t.length>x3dom.Utils.maxIndexableCoords)x3dom.debug.logWarning("IndexedQuadSet: fieldChanged with too many coordinates not yet implemented!");else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}));else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var i=0,s=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(s=4),this._mesh._colors[0]=[];var o,n=this._vf.index;for(o=0;o<n.length;++o)o>0&&o%3==0&&i++,this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b),4===s&&this._mesh._colors[0].push(t[i].a)}this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){n=this._vf.index;this._mesh._normals[0]=[];i=0;for(o=0;o<n.length;++o)o>0&&o%3==0&&i++,this._mesh._normals[0].push(t[i].x),this._mesh._normals[0].push(t[i].y),this._mesh._normals[0].push(t[i].z)}this._parentNodes.forEach((function(e){e._dirty.normals=!0}))}else if("texCoord"==e){var r=this._cf.texCoord.node;x3dom.isa(r,x3dom.nodeTypes.MultiTextureCoordinate)&&r._cf.texCoord.nodes.length&&(r=r._cf.texCoord.nodes[0]),t=r._vf.point,this._mesh._texCoords[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}))}}})),x3dom.registerNodeType("QuadSet","CADGeometry",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,(function(e){x3dom.nodeTypes.QuadSet.superClass.call(this,e)}),{nodeChanged:function(){var e=(new Date).getTime();this.handleAttribs();var t,i,s,o,n=this._vf.colorPerVertex,r=this._vf.normalPerVertex,a=!1,d=!1,h=!1,l=this._cf.coord.node;x3dom.debug.assert(l),t=l._vf.point;var f=this._cf.normal.node;f?(a=!0,i=f._vf.vector):a=!1;var u="",_=2,c=this._cf.texCoord.node;x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c?c._vf.point?(d=!0,s=c._vf.point,x3dom.isa(c,x3dom.nodeTypes.TextureCoordinate3D)&&(_=3)):c._vf.mode&&(u=c._vf.mode):d=!1;var m,p,x=3,v=this._cf.color.node;for(v?(h=!0,o=v._vf.color,x3dom.isa(v,x3dom.nodeTypes.ColorRGBA)&&(x=4)):h=!1,this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];t.length%4>0;)t.push(t.length-1);for(t.length,p=0,m=0;m<t.length;m++)m>0&&m%4==3?(p++,this._mesh._indices[0].push(m-3),this._mesh._indices[0].push(m-1),this._mesh._indices[0].push(m)):this._mesh._indices[0].push(m),!r&&a&&(this._mesh._normals[0].push(i[p].x),this._mesh._normals[0].push(i[p].y),this._mesh._normals[0].push(i[p].z)),!n&&h&&(this._mesh._colors[0].push(o[p].r),this._mesh._colors[0].push(o[p].g),this._mesh._colors[0].push(o[p].b),4===x&&this._mesh._colors[0].push(o[p].a));for(this._mesh._positions[0]=t.toGL(),a?this._mesh._normals[0]=i.toGL():this._mesh.calcNormals(r?Math.PI:0),d?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=_):this._mesh.calcTexCoords(u),h&&n&&(this._mesh._colors[0]=o.toGL(),this._mesh._numColComponents=x),this.invalidateVolume(),this._mesh._numFaces=0,this._mesh._numCoords=0,m=0;m<this._mesh._indices.length;m++)this._mesh._numFaces+=this._mesh._indices[m].length/3,this._mesh._numCoords+=this._mesh._positions[m].length/3;(new Date).getTime()},fieldChanged:function(e){var t=this._cf.coord.node._vf.point;if(t.length>x3dom.Utils.maxIndexableCoords)x3dom.debug.logWarning("QuadSet: fieldChanged with too many coordinates not yet implemented!");else if("coord"==e)this._mesh._positions[0]=t.toGL(),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()}));else if("color"==e){if(t=this._cf.color.node._vf.color,this._vf.colorPerVertex)this._mesh._colors[0]=t.toGL();else if(!this._vf.colorPerVertex){var i=0,s=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(s=4),this._mesh._colors[0]=[];var o,n=this._vf.index;for(o=0;o<n.length;++o)o>0&&o%3==0&&i++,this._mesh._colors[0].push(t[i].r),this._mesh._colors[0].push(t[i].g),this._mesh._colors[0].push(t[i].b),4===s&&this._mesh._colors[0].push(t[i].a)}this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}else if("normal"==e){if(t=this._cf.normal.node._vf.vector,this._vf.normalPerVertex)this._mesh._normals[0]=t.toGL();else if(!this._vf.normalPerVertex){n=this._vf.index;this._mesh._normals[0]=[];i=0;for(o=0;o<n.length;++o)o>0&&o%3==0&&i++,this._mesh._normals[0].push(t[i].x),this._mesh._normals[0].push(t[i].y),this._mesh._normals[0].push(t[i].z)}this._parentNodes.forEach((function(e){e._dirty.normals=!0}))}else if("texCoord"==e){var r=this._cf.texCoord.node;x3dom.isa(r,x3dom.nodeTypes.MultiTextureCoordinate)&&r._cf.texCoord.nodes.length&&(r=r._cf.texCoord.nodes[0]),t=r._vf.point,this._mesh._texCoords[0]=t.toGL(),this._parentNodes.forEach((function(e){e._dirty.texcoords=!0}))}}})),x3dom.registerNodeType("CADLayer","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.CADLayer.superClass.call(this,e),this.addField_SFString(e,"name","")}))),x3dom.registerNodeType("CADAssembly","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.CADAssembly.superClass.call(this,e),this.addField_SFString(e,"name","")}))),x3dom.registerNodeType("CADPart","CADGeometry",defineClass(x3dom.nodeTypes.Transform,(function(e){x3dom.nodeTypes.CADPart.superClass.call(this,e),this.addField_SFString(e,"name","")}))),x3dom.registerNodeType("CADFace","CADGeometry",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.CADFace.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFNode("shape",x3dom.nodeTypes.X3DShapeNode)}),{getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag()){var t=this._cf.shape.node,i=t&&t.renderFlag&&!0===t.renderFlag()?t.getVolume():null;i&&i.isValid()&&e.extendBounds(i.min,i.max)}return e},collectDrawableObjects:function(e,t,i,s,o,n){var r,a;(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!this._cf.shape.node||(o=t.cull(e,this.graphState(),i,o))<0)||(i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e),(r=this._cf.shape.node)&&r.collectDrawableObjects(a,t,i,s,o,n))}})),x3dom.registerNodeType("Patch","BVHRefiner",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Patch.superClass.call(this,e),this.addField_SFVec2f(e,"size",2,2),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFVec3f(e,"center",0,0,0),this.addField_MFString(e,"primType",["TRIANGLES"]);var t=this._vf.size.x,i=this._vf.size.y,s=this._vf.subdivision.x,o=this._vf.subdivision.y;this._indexBufferTriangulationParts=[];var n=0,r=0,a=t/s/2,d=i/o/2;t/=2,i/=2;var h=2*s+1,l=2*o+1;for(r=0;r<=2*o;r++)for(n=0;n<=2*s;n++)this._mesh._positions[0].push(this._vf.center.x+n*a-t),this._mesh._positions[0].push(this._vf.center.y+r*d-i),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(n/(2*s)),this._mesh._texCoords[0].push(r/(2*o));for(r=0;r<l-2;r+=2)for(n=0;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(this._indexBufferTriangulationParts.push({offset:0,count:s*o*6}),r=0;r<l-2;r+=2)for(n=0;n<2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-2;r+=2)for(n=2;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*o}),r=0;r<l-2;r+=2)for(n=h-3;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-2;r+=2)for(n=0;n<h-4;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*o}),r=2;r<l-2;r+=2)for(n=0;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(r=0;r<2;r+=2)for(n=0;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s}),r=l-3;r<l-2;r+=2)for(n=0;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-4;r+=2)for(n=0;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s}),r=l-3;r<l-2;r+=2)for(n=h-3;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-4;r+=2)for(n=0;n<h-4;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(r=0;r<l-4;r+=2)for(n=h-3;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=l-3;r<l-2;r+=2)for(n=0;n<h-4;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s+9*(o-1)+3}),r=l-3;r<l-2;r+=2)for(n=0;n<2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-4;r+=2)for(n=2;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(r=l-3;r<l-2;r+=2)for(n=2;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<l-4;r+=2)for(n=0;n<2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s+9*(o-1)+3}),r=0;r<2;r+=2)for(n=0;n<2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=2;r<l-2;r+=2)for(n=2;n<h-2;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(r=2;r<l-2;r+=2)for(n=0;n<2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<2;r+=2)for(n=2;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s+9*(o-1)+3}),r=0;r<2;r+=2)for(n=h-3;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=2;r<l-2;r+=2)for(n=0;n<h-4;n+=2)this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+(r+2)*h);for(r=2;r<l-2;r+=2)for(n=h-3;n<h-2;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+2+(r+1)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);for(r=0;r<2;r+=2)for(n=0;n<h-4;n+=2)this._mesh._indices[0].push(n+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+2+(r+2)*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+2+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+r*h),this._mesh._indices[0].push(n+1+(r+1)*h),this._mesh._indices[0].push(n+r*h);this._indexBufferTriangulationParts.push({offset:this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].offset+2*this._indexBufferTriangulationParts[this._indexBufferTriangulationParts.length-1].count,count:s*o*6+9*s+9*(o-1)+3}),this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3}),{hasIndexOffset:function(){return!0},getTriangulationAttributes:function(e){return this._indexBufferTriangulationParts[e]}})),x3dom.registerNodeType("BVHRefiner","BVHRefiner",defineClass(x3dom.nodeTypes.X3DLODNode,(function(e){x3dom.nodeTypes.BVHRefiner.superClass.call(this,e),this.addField_SFFloat(e,"factor",1),this.addField_SFInt32(e,"maxDepth",3),this.addField_SFInt32(e,"minDepth",0),this.addField_SFInt32(e,"smoothLoading",1),this.addField_SFInt32(e,"interactionDepth",this._vf.maxDepth),this.addField_SFVec2f(e,"size",1,1),this.addField_SFVec3f(e,"octSize",1,1,1),this.addField_SFVec2f(e,"subdivision",1,1),this.addField_SFString(e,"url",""),this.addField_SFString(e,"elevationUrl",""),this.addField_SFString(e,"textureUrl",""),this.addField_SFString(e,"normalUrl",""),this.addField_SFString(e,"mode","3d"),this.addField_SFString(e,"subMode","wmts"),this.addField_SFString(e,"elevationFormat","png"),this.addField_SFString(e,"textureFormat","png"),this.addField_SFString(e,"normalFormat","png"),this.addField_SFFloat(e,"maxElevation",1),this.addField_SFBool(e,"useNormals",!0),this.addField_SFBool(e,"lit",!0),this.addField_SFInt32(e,"bvhCount",8),this.creationSmooth=0,this.togglePoints=!0,this.nodeProducer=new NodeProducer;for(var t=0,i=0;i<=this._vf.maxDepth;i++)t+=Math.pow(4,i);if(this.nodeList=new Array(t),"bin"===this._vf.mode)this.rootNode=new QuadtreeNodeBin(e,this,0,0,0,null);else if("3d"===this._vf.mode||"2d"===this._vf.mode){var s=new x3dom.nodeTypes.Plane(e);s._vf.subdivision.setValues(this._vf.subdivision),s.fieldChanged("subdivision"),s._vf.size.setValues(this._vf.size),"2d"===this._vf.mode?"wmts"===this._vf.subMode?this.rootNode=new QuadtreeNode2dWMTS(e,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,s):this.rootNode=new QuadtreeNode2D(e,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,s,"/",1):"32bit"===this._vf.subMode?this.rootNode=new QuadtreeNode3D_32bit(e,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,s):(s=new x3dom.nodeTypes.Patch(e),this.rootNode=new QuadtreeNode3D(e,this,0,0,x3dom.fields.SFMatrix4f.identity(),0,0,s))}else"bvh"===this._vf.mode?this.rootNode=new BVHNode(e,this,0,"/",1,this._vf.bvhCount):x3dom.debug.logError("Error attribute mode. Value: '"+this._vf.mode+"' isn't conform. Please use type 'bin', '2d' or '3d'")}),{visitChildren:function(e,t,i,s,o){var n=this._nameSpace.doc._x3dElem;"oct"===this._vf.mode?(n.runtime.isReady&&this.togglePoints&&(n.runtime.togglePoints(),this.togglePoints=!1,this.view=t.viewarea),this.creationSmooth++,i=!1,s=!0,this.rootNode.collectDrawables(e,t,i,s,o),this.view.isMovingOrAnimating()||this.creationSmooth%this._vf.smoothLoading!=0||this.nodeProducer.CreateNewNode()):(n.runtime.isReady&&this.togglePoints&&(this.view=n.runtime.canvas.doc._viewarea,this.togglePoints=!1),this.createChildren=0,this.creationSmooth++,i=!1,s=!0,this.rootNode.collectDrawables(e,t,i,s,o),this.view.isMovingOrAnimating()||this.creationSmooth%this._vf.smoothLoading!=0||this.nodeProducer.CreateNewNode())},getVolume:function(){var e=this._graph.volume;if(!this.volumeValid()&&this.renderFlag&&this.renderFlag()){var t=this.rootNode.getVolume();t&&t.isValid()&&e.extendBounds(t.min,t.max)}return e}})),x3dom.registerNodeType("Snout","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Snout.superClass.call(this,e),this.addField_SFFloat(e,"dbottom",1),this.addField_SFFloat(e,"dtop",.5),this.addField_SFFloat(e,"height",1),this.addField_SFFloat(e,"xoff",.25),this.addField_SFFloat(e,"yoff",.25),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"subdivision",32),this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e,t,i,s,o,n=this._vf.dbottom/2,r=this._vf.height,a=this._vf.dtop/2,d=this._vf.subdivision,h=2*Math.PI/d,l=(n-a)/r,f=1/Math.sqrt(1+l*l),u=0,_=0;if(r>0){var c=0,m=0;for(u=0,_=0;u<=d;u++)e=u*h,t=Math.sin(e),i=-Math.cos(e),c=t*a+this._vf.xoff,m=i*a+this._vf.yoff,this._mesh._positions[0].push(c,r/2,m),this._mesh._normals[0].push(t/f,l/f,i/f),this._mesh._texCoords[0].push(1-u/d,1),this._mesh._positions[0].push(t*n,-r/2,i*n),this._mesh._normals[0].push(t/f,l/f,i/f),this._mesh._texCoords[0].push(1-u/d,0),u>0&&(this._mesh._indices[0].push(_),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+1),this._mesh._indices[0].push(_+2),this._mesh._indices[0].push(_+3),_+=2)}if(n>0&&this._vf.bottom){for(o=this._mesh._positions[0].length/3,u=d-1;u>=0;u--)e=u*h,t=n*Math.sin(e),i=-n*Math.cos(e),this._mesh._positions[0].push(t,-r/2,i),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(t/n/2+.5,i/n/2+.5);for(s=o+1,u=2;u<d;u++)this._mesh._indices[0].push(s),this._mesh._indices[0].push(o),s=o+u,this._mesh._indices[0].push(s)}if(a>x3dom.fields.Eps&&this._vf.top){for(o=this._mesh._positions[0].length/3,u=d-1;u>=0;u--)e=u*h,t=a*Math.sin(e),i=-a*Math.cos(e),this._mesh._positions[0].push(t+this._vf.xoff,r/2,i+this._vf.yoff),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(t/a/2+.5,1-i/a/2+.5);for(s=o+1,u=2;u<d;u++)this._mesh._indices[0].push(o),this._mesh._indices[0].push(s),s=o+u,this._mesh._indices[0].push(s)}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"dtop"!=e&&"dbottom"!=e&&"height"!=e&&"subdivision"!=e&&"xoff"!=e&&"yoff"!=e&&"bottom"!=e&&"top"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("Dish","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Dish.superClass.call(this,e),this.addField_SFFloat(e,"diameter",2),this.addField_SFFloat(e,"height",1),this.addField_SFFloat(e,"radius",this._vf.diameter/2),this.addField_SFBool(e,"bottom",!0),this.addField_SFVec2f(e,"subdivision",24,24),this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e=2*Math.PI,t=Math.PI/2,i=this._vf.diameter/2,s=this._vf.radius;s=0==s||Math.abs(i-s)<=x3dom.fields.Eps?i:s;var o,n,r,a,d,h,l,f,u,_,c,m,p=Math.min(this._vf.height,s),x=s-p,v=i,g=s,y=i,S=this._vf.subdivision.x,T=this._vf.subdivision.y,F=this._vf.ccw?1:-1,b=t-Math.asin(1-p/s),C=Math.ceil(S/t*b),M=[],E=[];for(o=0;o<=S;o++){for(r=C==o?b:o*t/S,a=Math.sin(r),d=Math.cos(r),n=0;n<=T;n++)h=n*e/T,l=Math.sin(h),f=v*(-Math.cos(h)*a),u=g*d,_=y*(-l*a),c=.25-n/T,m=o/S,this._mesh._positions[0].push(f,u-x,_),this._mesh._texCoords[0].push(c,m),this._mesh._normals[0].push(F*f/(v*v),F*u/(g*g),F*_/(y*y)),o!=S&&C!=o||(M.push(f,u-x,_),E.push(c,m));if(C==o)break}for(o=0;o<S&&C!=o;o++)for(n=0;n<T;n++){var w=o*(T+1)+n,A=w+T+1;this._mesh._indices[0].push(w+1),this._mesh._indices[0].push(A),this._mesh._indices[0].push(w),this._mesh._indices[0].push(w+1),this._mesh._indices[0].push(A+1),this._mesh._indices[0].push(A)}if(this._vf.bottom)for(var D=this._mesh._positions[0].length/3,N=D+1,R=0,I=M.length/3;R<I;R++){var P=3*R;this._mesh._positions[0].push(M[P]),this._mesh._positions[0].push(M[P+1]),this._mesh._positions[0].push(M[P+2]),P=2*R,this._mesh._texCoords[0].push(E[P]),this._mesh._texCoords[0].push(E[P+1]),this._mesh._normals[0].push(0,-1*F,0),R>=2&&(this._mesh._indices[0].push(D),this._mesh._indices[0].push(N),N=D+R,this._mesh._indices[0].push(N))}this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"radius"!=e&&"height"!=e&&"diameter"!=e&&"subdivision"!=e&&"bottom"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("Pyramid","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Pyramid.superClass.call(this,e),this.addField_SFFloat(e,"xbottom",1),this.addField_SFFloat(e,"ybottom",1),this.addField_SFFloat(e,"xtop",.5),this.addField_SFFloat(e,"ytop",.5),this.addField_SFFloat(e,"height",1),this.addField_SFFloat(e,"xoff",.25),this.addField_SFFloat(e,"yoff",.25);var t=this._vf.xtop/2,i=this._vf.ytop/2,s=this._vf.xbottom/2,o=this._vf.ybottom/2,n=this._vf.xoff,r=this._vf.yoff,a=this._vf.height/2;this._mesh._positions[0]=[-s,-a,-o,-t+n,a,-i+r,t+n,a,-i+r,s,-a,-o,-s,-a,o,-t+n,a,i+r,t+n,a,i+r,s,-a,o,-s,-a,-o,-s,-a,o,-t+n,a,i+r,-t+n,a,-i+r,s,-a,-o,s,-a,o,t+n,a,i+r,t+n,a,-i+r,-t+n,a,-i+r,-t+n,a,i+r,t+n,a,i+r,t+n,a,-i+r,-s,-a,-o,-s,-a,o,s,-a,o,s,-a,-o],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._mesh._indices[0]=[0,1,2,2,3,0,6,5,4,4,7,6,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20],this._mesh.calcNormals(Math.PI,this._vf.ccw),this._mesh._invalidate=!0,this._mesh._numFaces=12,this._mesh._numCoords=24}),{fieldChanged:function(e){if("xbottom"==e||"ybottom"==e||"xtop"==e||"ytop"==e||"xoff"==e||"yoff"==e||"height"==e){var t=this._vf.xtop/2,i=this._vf.ytop/2,s=this._vf.xbottom/2,o=this._vf.ybottom/2,n=this._vf.xoff,r=this._vf.yoff,a=this._vf.height/2;this._mesh._positions[0]=[-s,-a,-o,-t+n,a,-i+r,t+n,a,-i+r,s,-a,-o,-s,-a,o,-t+n,a,i+r,t+n,a,i+r,s,-a,o,-s,-a,-o,-s,-a,o,-t+n,a,i+r,-t+n,a,-i+r,s,-a,-o,s,-a,o,t+n,a,i+r,t+n,a,-i+r,-t+n,a,-i+r,-t+n,a,i+r,t+n,a,i+r,t+n,a,-i+r,-s,-a,-o,-s,-a,o,s,-a,o,s,-a,-o],this._mesh._normals[0]=[],this._mesh.calcNormals(Math.PI,this._vf.ccw),this.invalidateVolume(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()}))}}})),x3dom.registerNodeType("RectangularTorus","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.RectangularTorus.superClass.call(this,e),this.addField_SFFloat(e,"innerRadius",.5),this.addField_SFFloat(e,"outerRadius",1),this.addField_SFFloat(e,"height",1),this.addField_SFFloat(e,"angle",2*Math.PI),this.addField_SFBool(e,"caps",!0),this.addField_SFFloat(e,"subdivision",32),this._origCCW=this._vf.ccw,this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e=2*Math.PI;if(this._vf.ccw=!this._origCCW,this._vf.angle<0?this._vf.angle=0:this._vf.angle>e&&(this._vf.angle=e),this._vf.innerRadius>this._vf.outerRadius){var t=this._vf.innerRadius;this._vf.innerRadius=this._vf.outerRadius,this._vf.outerRadius=t}var i,s,o,n,r,a,d,h=this._vf.innerRadius,l=this._vf.outerRadius,f=this._vf.height/2,u=this._vf.angle,_=this._vf.subdivision,c=u/_;for(r=0,n=0;r<=_;r++)i=r*c,s=l*(a=Math.cos(i)),o=l*(d=-Math.sin(i)),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(a,0,d),this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(a,0,d),r>0&&(this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+3),n+=2);for(r=0,n+=2;r<=_;r++)i=r*c,s=h*(a=Math.cos(i)),o=h*(d=-Math.sin(i)),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(-a,0,-d),this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(-a,0,-d),r>0&&(this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+3),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),n+=2);for(r=0,n+=2;r<=_;r++)i=r*c,s=l*(a=Math.cos(i)),o=l*(d=-Math.sin(i)),this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(0,1,0),s=h*a,o=h*d,this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(0,1,0),r>0&&(this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+3),n+=2);for(r=0,n+=2;r<=_;r++)i=r*c,s=l*(a=Math.cos(i)),o=l*(d=-Math.sin(i)),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(0,-1,0),s=h*a,o=h*d,this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(0,-1,0),r>0&&(this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+3),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),n+=2);u<e&&1==this._vf.caps&&(n+=2,s=l,o=0,this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(0,0,1),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(0,0,1),s=h,o=0,this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(0,0,1),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(0,0,1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+3),n+=4,s=l*(a=Math.cos(u)),o=l*(d=-Math.sin(u)),this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(d,0,-a),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(d,0,-a),s=h*a,o=h*d,this._mesh._positions[0].push(s,f,o),this._mesh._normals[0].push(d,0,-a),this._mesh._positions[0].push(s,-f,o),this._mesh._normals[0].push(d,0,-a),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+3),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2)),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"innerRadius"!=e&&"outerRadius"!=e&&"height"!=e&&"angle"!=e&&"subdivision"!=e&&"caps"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("SlopedCylinder","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.SlopedCylinder.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_SFFloat(e,"height",2),this.addField_SFBool(e,"bottom",!0),this.addField_SFBool(e,"top",!0),this.addField_SFFloat(e,"xtshear",.26179),this.addField_SFFloat(e,"ytshear",0),this.addField_SFFloat(e,"xbshear",.26179),this.addField_SFFloat(e,"ybshear",0),this.addField_SFFloat(e,"subdivision",32),this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e,t,i,s,o,n,r,a,d=this._vf.xtshear,h=this._vf.ytshear,l=this._vf.xbshear,f=this._vf.ybshear,u=this._vf.subdivision,_=this._vf.radius,c=this._vf.height/2,m=2*Math.PI/u;for(o=0,n=0;o<=u;o++)e=o*m,t=Math.sin(e),s=-Math.cos(e),this._mesh._positions[0].push(t*_,t*l-c+s*f,s*_),this._mesh._texCoords[0].push(1-o/u,0),this._mesh._positions[0].push(t*_,c+t*d+s*h,s*_),this._mesh._texCoords[0].push(1-o/u,1),o>0&&(this._mesh._indices[0].push(n),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+3),n+=2);if(this._vf.top&&_>0){for(a=this._mesh._positions[0].length/3,o=u-1;o>=0;o--)n=6*o,t=this._mesh._positions[0][n+3],i=this._mesh._positions[0][n+4],s=this._mesh._positions[0][n+5],this._mesh._positions[0].push(t,i,s),this._mesh._texCoords[0].push(t/2+.5,-s/2+.5);for(r=a+1,o=2;o<u;o++)this._mesh._indices[0].push(a),this._mesh._indices[0].push(r),r=a+o,this._mesh._indices[0].push(r)}if(this._vf.bottom&&_>0){for(a=this._mesh._positions[0].length/3,o=u-1;o>=0;o--)n=6*o,t=this._mesh._positions[0][n],i=this._mesh._positions[0][n+1],s=this._mesh._positions[0][n+2],this._mesh._positions[0].push(t,i,s),this._mesh._texCoords[0].push(t/2+.5,s/2+.5);for(r=a+1,o=2;o<u;o++)this._mesh._indices[0].push(r),this._mesh._indices[0].push(a),r=a+o,this._mesh._indices[0].push(r)}this._mesh.calcNormals(Math.PI,this._vf.ccw);var p=new x3dom.fields.SFVec3f(this._mesh._normals[0][0],this._mesh._normals[0][1],this._mesh._normals[0][2]),x=new x3dom.fields.SFVec3f(this._mesh._normals[0][3],this._mesh._normals[0][4],this._mesh._normals[0][5]);n=6*u;var v=new x3dom.fields.SFVec3f(this._mesh._normals[0][n],this._mesh._normals[0][n+1],this._mesh._normals[0][n+2]),g=new x3dom.fields.SFVec3f(this._mesh._normals[0][n+3],this._mesh._normals[0][n+4],this._mesh._normals[0][n+5]),y=p.add(v).normalize(),S=x.add(g).normalize();this._mesh._normals[0][0]=y.x,this._mesh._normals[0][1]=y.y,this._mesh._normals[0][2]=y.z,this._mesh._normals[0][3]=S.x,this._mesh._normals[0][4]=S.y,this._mesh._normals[0][5]=S.z,this._mesh._normals[0][n]=y.x,this._mesh._normals[0][n+1]=y.y,this._mesh._normals[0][n+2]=y.z,this._mesh._normals[0][n+3]=S.x,this._mesh._normals[0][n+4]=S.y,this._mesh._normals[0][n+5]=S.z,this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"xtshear"!=e&&"ytshear"!=e&&"xbshear"!=e&&"ybshear"!=e&&"radius"!=e&&"height"!=e&&"bottom"!=e&&"top"!=e&&"subdivision"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("Nozzle","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.Nozzle.superClass.call(this,e),this.addField_SFFloat(e,"nozzleHeight",.1),this.addField_SFFloat(e,"nozzleRadius",.6),this.addField_SFFloat(e,"height",1),this.addField_SFFloat(e,"outerRadius",.5),this.addField_SFFloat(e,"innerRadius",.4),this.addField_SFFloat(e,"subdivision",32),this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e=2*Math.PI,t=this._vf.subdivision,i=this._vf.height,s=i/2;if(this._vf.innerRadius>this._vf.outerRadius){var o=this._vf.innerRadius;this._vf.innerRadius=this._vf.outerRadius,this._vf.outerRadius=o}var n=this._vf.innerRadius,r=this._vf.outerRadius;this._vf.nozzleRadius<r&&(this._vf.nozzleRadius=r);var a=this._vf.nozzleRadius;this._vf.nozzleHeight>i&&(this._vf.nozzleHeight=i);var d,h,l,f,u,_,c,m,p=this._vf.nozzleHeight;for(h=e/t,_=0,u=0;_<=t;_++)d=_*h,l=r*(c=Math.sin(d)),f=r*(m=-Math.cos(d)),this._mesh._positions[0].push(l,-s,f),this._mesh._normals[0].push(c,0,m),this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(c,0,m),_>0&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+3),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=n*(c=Math.sin(d)),f=n*(m=-Math.cos(d)),this._mesh._positions[0].push(l,-s,f),this._mesh._normals[0].push(-c,0,-m),this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(-c,0,-m),_>0&&(this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+3),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=r*(c=Math.sin(d)),f=r*(m=-Math.cos(d)),this._mesh._positions[0].push(l,-s,f),this._mesh._normals[0].push(0,-1,0),l=n*c,f=n*m,this._mesh._positions[0].push(l,-s,f),this._mesh._normals[0].push(0,-1,0),_>0&&(this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+3),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=a*(c=Math.sin(d)),f=a*(m=-Math.cos(d)),this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(c,0,m),this._mesh._positions[0].push(l,s,f),this._mesh._normals[0].push(c,0,m),_>0&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+3),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=n*(c=Math.sin(d)),f=n*(m=-Math.cos(d)),this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(-c,0,-m),this._mesh._positions[0].push(l,s,f),this._mesh._normals[0].push(-c,0,-m),_>0&&(this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+3),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=a*(c=Math.sin(d)),f=a*(m=-Math.cos(d)),this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(0,-1,0),l=r*c,f=r*m,this._mesh._positions[0].push(l,i-p-s,f),this._mesh._normals[0].push(0,-1,0),_>0&&(this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+3),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),u+=2);for(_=0,u+=2;_<=t;_++)d=_*h,l=a*(c=Math.sin(d)),f=a*(m=-Math.cos(d)),this._mesh._positions[0].push(l,s,f),this._mesh._normals[0].push(0,1,0),l=n*c,f=n*m,this._mesh._positions[0].push(l,s,f),this._mesh._normals[0].push(0,1,0),_>0&&(this._mesh._indices[0].push(u),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+2),this._mesh._indices[0].push(u+1),this._mesh._indices[0].push(u+3),u+=2);this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"nozzleHeight"!=e&&"nozzleRadius"!=e&&"height"!=e&&"outerRadius"!=e&&"innerRadius"!=e&&"subdivision"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("SolidOfRevolution","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.SolidOfRevolution.superClass.call(this,e),this.addField_SFFloat(e,"creaseAngle",0),this.addField_MFVec2f(e,"crossSection",[]),this.addField_SFFloat(e,"angle",2*Math.PI),this.addField_SFBool(e,"caps",!0),this.addField_SFFloat(e,"subdivision",32),this._origCCW=this._vf.ccw,this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e=2*Math.PI;this._vf.angle<-e?this._vf.angle=-e:this._vf.angle>e&&(this._vf.angle=e);var t,i,s,o,n=this._vf.crossSection,r=this._vf.angle,a=this._vf.subdivision,d=n.length;if(d<1)x3dom.debug.logWarning("SolidOfRevolution requires crossSection curve.");else{var h,l=d>2&&n[0].equals(n[d-1],x3dom.fields.Eps),f=e-Math.abs(r)<=x3dom.fields.Eps,u=r/a,_=[],c=[];this._vf.ccw=r<0?this._origCCW:!this._origCCW,l||(Math.abs(n[d-1].y)>x3dom.fields.Eps&&n.push(new x3dom.fields.SFVec2f(n[d-1].x,0)),Math.abs(n[0].y)>x3dom.fields.Eps&&n.unshift(new x3dom.fields.SFVec2f(n[0].x,0)),d=n.length);var m=null,p=null,x=null,v=[];for(i=0;i<d;i++)m&&(p&&(x=p),p=m),m=new x3dom.fields.SFVec3f(n[i].x,0,n[i].y),i>=2&&(h=(h=m.subtract(p).normalize()).dot(p.subtract(x).normalize()),(h=Math.abs(Math.cos(h)))>this._vf.creaseAngle&&(c.push(x3dom.fields.SFVec3f.copy(p)),v.push(!0))),c.push(m),v.push(!1);for(d=c.length,t=0,h=0;t<=a;t++,h+=u){var g=x3dom.fields.SFMatrix4f.rotationX(h);for(i=0;i<d;i++)m=g.multMatrixPnt(c[i]),_.push(m),this._mesh._positions[0].push(m.x,m.y,m.z),t>0&&i>0&&(this._mesh._indices[0].push((t-1)*d+(i-1),(t-1)*d+i,t*d+i),this._mesh._indices[0].push(t*d+i,t*d+(i-1),(t-1)*d+(i-1)))}if(!f&&1==this._vf.caps){var y=new x3dom.DoublyLinkedList;for(o=this._mesh._positions[0].length/3,i=0,t=0;i<d;i++)v[i]||(y.appendNode(new x3dom.DoublyLinkedList.ListNode(_[i],t++)),m=_[i],this._mesh._positions[0].push(m.x,m.y,m.z));var S=x3dom.EarClipping.getIndexes(y);for(i=S.length-1;i>=0;i--)this._mesh._indices[0].push(o+S[i]);for(o=this._mesh._positions[0].length/3,i=0;i<d;i++)v[i]||(m=_[d*a+i],this._mesh._positions[0].push(m.x,m.y,m.z));for(i=0;i<S.length;i++)this._mesh._indices[0].push(o+S[i])}if(this._mesh.calcNormals(Math.PI,this._vf.ccw),f)for(o=3*d*a,i=0;i<d;i++)s=3*i,this._mesh._normals[0][o+s]=this._mesh._normals[0][s],this._mesh._normals[0][o+s+1]=this._mesh._normals[0][s+1],this._mesh._normals[0][o+s+2]=this._mesh._normals[0][s+2];this._mesh.calcTexCoords(""),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3}},fieldChanged:function(e){"crossSection"!=e&&"angle"!=e&&"caps"!=e&&"subdivision"!=e&&"creaseAngle"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("SphereSegment","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,(function(e){x3dom.nodeTypes.SphereSegment.superClass.call(this,e),this.addField_SFFloat(e,"radius",1),this.addField_MFFloat(e,"longitude",[]),this.addField_MFFloat(e,"latitude",[]),this.addField_SFVec2f(e,"stepSize",1,1);var t,i,s,o,n,r,a,d,h,l,f,u,_,c,m=this._vf.radius,p=this._vf.longitude,x=this._vf.latitude,v=this._vf.ccw?1:-1,g=p.length,y=x.length,S=g;for(s=0;s<=y;s++)for(n=(x[s]+90)*Math.PI/180,r=Math.sin(n),a=Math.cos(n),o=0;o<=S;o++)d=p[o]*Math.PI/180,h=Math.sin(d),l=-Math.cos(d)*r,f=-a,u=-h*r,_=o/(S-1),c=s/(y-1),this._mesh._positions[0].push(m*l,m*f,m*u),this._mesh._normals[0].push(v*l,v*f,v*u),this._mesh._texCoords[0].push(_,c);for(s=0;s<y;s++)for(o=0;o<S;o++)i=(t=s*(S+1)+o)+S+1,this._mesh._indices[0].push(t),this._mesh._indices[0].push(i),this._mesh._indices[0].push(t+1),this._mesh._indices[0].push(i),this._mesh._indices[0].push(i+1),this._mesh._indices[0].push(t+1);this._mesh._invalidate=!0,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3}))),x3dom.registerNodeType("ElevationGrid","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.ElevationGrid.superClass.call(this,e),this.addField_SFBool(e,"colorPerVertex",!0),this.addField_SFBool(e,"normalPerVertex",!0),this.addField_SFFloat(e,"creaseAngle",0),this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode),this.addField_SFNode("normal",x3dom.nodeTypes.Normal),this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode),this.addField_MFFloat(e,"height",[]),this.addField_SFInt32(e,"xDimension",0),this.addField_SFFloat(e,"xSpacing",1),this.addField_SFInt32(e,"zDimension",0),this.addField_SFFloat(e,"zSpacing",1)}),{nodeChanged:function(){this._mesh._indices[0]=[],this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._colors[0]=[];var e=0,t=0,i=this._vf.xDimension-1,s=this._vf.zDimension-1,o=this._vf.height;x3dom.debug.assert(o.length>=this._vf.xDimension*this._vf.zDimension,"Too few height values for given x/zDimension!");var n=null,r=null,a=null;this._cf.normal.node&&(n=this._cf.normal.node._vf.vector);var d,h=2,l=this._cf.texCoord.node;x3dom.isa(l,x3dom.nodeTypes.MultiTextureCoordinate)&&l._cf.texCoord.nodes.length&&(l=l._cf.texCoord.nodes[0]),l&&(l._vf.point?(r=l._vf.point,x3dom.isa(l,x3dom.nodeTypes.TextureCoordinate3D)&&(h=3)):l._vf.mode&&(d=l._vf.mode));var f=3;this._cf.color.node&&(a=this._cf.color.node._vf.color,x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(f=4));var u=0;for(t=0;t<=s;t++)for(e=0;e<=i;e++)this._mesh._positions[0].push(e*this._vf.xSpacing),this._mesh._positions[0].push(o[u]),this._mesh._positions[0].push(t*this._vf.zSpacing),n&&this._vf.normalPerVertex&&(this._mesh._normals[0].push(n[u].x),this._mesh._normals[0].push(n[u].y),this._mesh._normals[0].push(n[u].z)),r?(this._mesh._texCoords[0].push(r[u].x),this._mesh._texCoords[0].push(r[u].y),3===h&&this._mesh._texCoords[0].push(r[u].z)):(this._mesh._texCoords[0].push(e/i),this._mesh._texCoords[0].push(t/s)),a&&this._vf.colorPerVertex&&(this._mesh._colors[0].push(a[u].r),this._mesh._colors[0].push(a[u].g),this._mesh._colors[0].push(a[u].b),4===f&&this._mesh._colors[0].push(a[u].a)),u++;for(t=1;t<=s;t++)for(e=0;e<i;e++)this._mesh._indices[0].push((t-1)*(i+1)+e),this._mesh._indices[0].push(t*(i+1)+e),this._mesh._indices[0].push((t-1)*(i+1)+e+1),this._mesh._indices[0].push(t*(i+1)+e),this._mesh._indices[0].push(t*(i+1)+e+1),this._mesh._indices[0].push((t-1)*(i+1)+e+1);n||this._mesh.calcNormals(Math.PI,this._vf.ccw),d&&this._mesh.calcTexCoords(d),this.invalidateVolume(),this._mesh._numTexComponents=h,this._mesh._numColComponents=f,this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){var t,i,s=null;if(this._cf.normal.node&&(s=this._cf.normal.node._vf.vector),"height"==e){i=this._mesh._positions[0].length/3;var o=this._vf.height;for(t=0;t<i;t++)this._mesh._positions[0][3*t+1]=o[t];s||(this._mesh._normals[0]=[],this._mesh.calcNormals(Math.PI,this._vf.ccw)),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,s||(e._dirty.normals=!0),e.invalidateVolume()}))}else if("xSpacing"==e||"zSpacing"==e){for(var n=0;n<this._vf.zDimension;n++)for(var r=0;r<this._vf.xDimension;r++){var a=3*(n*this._vf.xDimension+r);this._mesh._positions[0][a]=r*this._vf.xSpacing,this._mesh._positions[0][a+2]=n*this._vf.zSpacing}s||(this._mesh._normals[0]=[],this._mesh.calcNormals(Math.PI,this._vf.ccw)),this.invalidateVolume(),this._parentNodes.forEach((function(e){e._dirty.positions=!0,s||(e._dirty.normals=!0),e.invalidateVolume()}))}else if("xDimension"==e||"zDimension"==e)this.nodeChanged(),this._parentNodes.forEach((function(e){e.setGeoDirty(),e.invalidateVolume()}));else if("color"==e){i=this._mesh._colors[0].length/3;var d=this._cf.color.node._vf.color;for(t=0;t<i;t++)this._mesh._colors[0][3*t]=d[t].r,this._mesh._colors[0][3*t+1]=d[t].g,this._mesh._colors[0][3*t+2]=d[t].b;this._parentNodes.forEach((function(e){e._dirty.colors=!0}))}}})),x3dom.registerNodeType("Extrusion","Geometry3DExt",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.Extrusion.superClass.call(this,e),this.addField_SFBool(e,"beginCap",!0),this.addField_SFBool(e,"endCap",!0),this.addField_SFBool(e,"convex",!0),this.addField_SFFloat(e,"creaseAngle",0),this.addField_MFVec2f(e,"crossSection",[new x3dom.fields.SFVec2f(1,1),new x3dom.fields.SFVec2f(1,-1),new x3dom.fields.SFVec2f(-1,-1),new x3dom.fields.SFVec2f(-1,1),new x3dom.fields.SFVec2f(1,1)]),this.addField_MFRotation(e,"orientation",[new x3dom.fields.Quaternion(0,0,0,1)]),this.addField_MFVec2f(e,"scale",[new x3dom.fields.SFVec2f(1,1)]),this.addField_MFVec3f(e,"spine",[new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,1,0)]),this.addField_SFFloat(e,"height",0),this.rebuildGeometry()}),{rebuildGeometry:function(){this._mesh._positions[0]=[],this._mesh._normals[0]=[],this._mesh._texCoords[0]=[],this._mesh._indices[0]=[];var e,t,i,s,o,n,r,a,d=1,h=1,l=this._vf.spine,f=this._vf.scale,u=this._vf.orientation,_=this._vf.crossSection,c=[],m=0;s=l.length,i=_.length,this._vf.height>0&&(l[0]=new x3dom.fields.SFVec3f(0,0,0),l[1]=new x3dom.fields.SFVec3f(0,this._vf.height,0),s=2);var p=new x3dom.fields.SFVec3f(0,0,1);if(s>2)for(e=1;e<s-1;e++){var x=l[e+1].subtract(l[e]).cross(l[e-1].subtract(l[e]));if(x.length()>x3dom.fields.Eps){p=x3dom.fields.SFVec3f.copy(x.normalize());break}}var v=0,g=[0];for(e=1;e<s;e++){v+=l[e].subtract(l[e-1]).length(),g[e]=v}var y=0,S=[0],T=0,F=0,b=0,C=0;for(t=1;t<i;t++){y+=_[t].subtract(_[t-1]).length(),S[t]=y,1==t&&(T=F=_[t-1].x,b=C=_[t-1].y),T<_[t].x&&(T=_[t].x),F>_[t].x&&(F=_[t].x),b<_[t].y&&(b=_[t].y),C>_[t].y&&(C=_[t].y)}if(Math.abs(T-F)<Math.abs(b-C)){var M=T,E=F;T=b,F=C,b=M,C=E}var w=Math.abs(T-F),A=Math.abs(b-C),D=s>2&&l[0].equals(l[l.length-1],x3dom.fields.Eps);for(e=0;e<s;e++){for((o=f.length)>0&&(e<o?(d=f[e].x,h=f[e].y):(d=f[o-1].x,h=f[o-1].y)),t=0;t<i;t++){var N=new x3dom.fields.SFVec3f(_[t].x*d+l[e].x,l[e].y,_[t].y*h+l[e].z);if(s>2){0==e?(D?(r=l[1].subtract(l[s-2]),a=l[1].subtract(l[0]).cross(l[s-2].subtract(l[0]))):(r=l[1].subtract(l[0]),a=l[2].subtract(l[1]).cross(l[0].subtract(l[1]))),a.length()>x3dom.fields.Eps&&(p=x3dom.fields.SFVec3f.copy(a))):e==s-1?D?(r=l[1].subtract(l[s-2]),a=l[1].subtract(l[0]).cross(l[s-2].subtract(l[0]))):(r=l[s-1].subtract(l[s-2]),a=x3dom.fields.SFVec3f.copy(p)):a=(r=l[e+1].subtract(l[e-1])).cross(l[e-1].subtract(l[e])),a.dot(p)<0&&(a=a.negate()),r=r.normalize(),(a=a.normalize()).length()<=x3dom.fields.Eps&&(a=x3dom.fields.SFVec3f.copy(p)),0!=e&&(p=x3dom.fields.SFVec3f.copy(a)),n=r.cross(a).normalize();var R=x3dom.fields.SFMatrix4f.identity();R.setValue(n,r,a);var I=e<u.length?u[e].toMatrix():u.length>0?u[u.length-1].toMatrix():x3dom.fields.SFMatrix4f.identity();N=N.subtract(l[e]),N=(N=R.multMatrixPnt(I.multMatrixPnt(N))).add(l[e])}if(N.crossSection=_[t],c.push(N),this._vf.creaseAngle<=x3dom.fields.Eps){if(e>0&&t>0){var P=(e-1)*i+(t-1);this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t-1]/y,g[e-1]/v),P=(e-1)*i+t,this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t]/y,g[e-1]/v),P=e*i+t,this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t]/y,g[e]/v),this._mesh._indices[0].push(m++,m++,m++),this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t]/y,g[e]/v),P=e*i+(t-1),this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t-1]/y,g[e]/v),P=(e-1)*i+(t-1),this._mesh._positions[0].push(c[P].x,c[P].y,c[P].z),this._mesh._texCoords[0].push(S[t-1]/y,g[e-1]/v),this._mesh._indices[0].push(m++,m++,m++)}}else this._mesh._positions[0].push(N.x,N.y,N.z),this._mesh._texCoords[0].push(S[t]/y,g[e]/v),e>0&&t>0&&(this._mesh._indices[0].push((e-1)*i+(t-1),(e-1)*i+t,e*i+t),this._mesh._indices[0].push(e*i+t,e*i+(t-1),(e-1)*i+(t-1)))}if(e==s-1){var V,O,L,B,U;if(this._vf.beginCap){for(B=new x3dom.DoublyLinkedList,O=this._mesh._positions[0].length/3,t=0;t<i;t++)B.appendNode(new x3dom.DoublyLinkedList.ListNode(c[t],t)),this._vf.creaseAngle>x3dom.fields.Eps&&(V=c[t],this._mesh._positions[0].push(V.x,V.y,V.z),this._mesh._texCoords[0].push((V.crossSection.x-F)/w,(V.crossSection.y-C)/A));for(0==this._vf.ccw&&B.invert(),t=(U=x3dom.EarClipping.getIndexes(B)).length-1;t>=0;t--)this._vf.creaseAngle>x3dom.fields.Eps?this._mesh._indices[0].push(O+U[t]):(V=c[U[t]],this._mesh._positions[0].push(V.x,V.y,V.z),this._mesh._texCoords[0].push((V.crossSection.x-F)/w,(V.crossSection.y-C)/A),this._mesh._indices[0].push(m++))}if(this._vf.endCap){for(B=new x3dom.DoublyLinkedList,L=(s-1)*i,O=this._mesh._positions[0].length/3,t=0;t<i;t++)B.appendNode(new x3dom.DoublyLinkedList.ListNode(c[L+t],L+t)),this._vf.creaseAngle>x3dom.fields.Eps&&(V=c[L+t],this._mesh._positions[0].push(V.x,V.y,V.z),this._mesh._texCoords[0].push((V.crossSection.x-F)/w,(V.crossSection.y-C)/A));for(0==this._vf.ccw&&B.invert(),U=x3dom.EarClipping.getIndexes(B),t=0;t<U.length;t++)this._vf.creaseAngle>x3dom.fields.Eps?this._mesh._indices[0].push(O+(U[t]-L)):(V=c[U[t]],this._mesh._positions[0].push(V.x,V.y,V.z),this._mesh._texCoords[0].push((V.crossSection.x-F)/w,(V.crossSection.y-C)/A),this._mesh._indices[0].push(m++))}}}this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),this._mesh._numFaces=this._mesh._indices[0].length/3,this._mesh._numCoords=this._mesh._positions[0].length/3},fieldChanged:function(e){"beginCap"!=e&&"endCap"!=e&&"crossSection"!=e&&"orientation"!=e&&"scale"!=e&&"spine"!=e&&"height"!=e&&"creaseAngle"!=e||(this.rebuildGeometry(),this._parentNodes.forEach((function(e){e.setAllDirty(),e.invalidateVolume()})))}})),x3dom.registerNodeType("HAnimDisplacer","H-Anim",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,(function(e){x3dom.nodeTypes.HAnimDisplacer.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFFloat(e,"weight",0),this.addField_MFInt32(e,"coordIndex",[]),this.addField_MFVec3f(e,"displacements",[]),x3dom.debug.logWarning("HAnimDisplacer in Segments NYI.")}))),x3dom.registerNodeType("HAnimJoint","H-Anim",defineClass(x3dom.nodeTypes.Transform,(function(e){x3dom.nodeTypes.HAnimJoint.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_MFNode("displacers",x3dom.nodeTypes.HAnimDisplacer),this.addField_SFRotation(e,"limitOrientation","0 0 1 0"),this.addField_MFFloat(e,"llimit",[]),this.addField_MFFloat(e,"ulimit",[]),this.addField_MFInt32(e,"skinCoordIndex",[]),this.addField_MFFloat(e,"skinCoordWeight",[]),this.addField_MFFloat(e,"stiffness",[0,0,0])}),{nodeChanged:function(){this._humanoid=function e(t){var i=t.parentNode._x3domNode;if(x3dom.isa(i,x3dom.nodeTypes.Scene))return!1;if(x3dom.isa(i,x3dom.nodeTypes.HAnimHumanoid))return i;return e(i._xmlNode)}(this._xmlNode)},collectDrawableObjects:function(e,t,i,s,o,n){i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),o=t.cull(e,this.graphState(),i,o);var r=this._humanoid._cf.skinCoord.node;if(!(o<0)||r){var a,d;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),d=this._graph.globalMatrix):d=this.transformMatrix(e);var h,l,f,u,_,c=this._childNodes.length;if(x3dom.nodeTypes.ClipPlane.count>0){for(var m=[],p=0;p<c;p++)(a=this._childNodes[p])&&x3dom.isa(a,x3dom.nodeTypes.ClipPlane)&&a._vf.on&&a._vf.enabled&&m.push({plane:a,trafo:d});n=m.concat(n)}r&&(f=this._humanoid,u=f.getCurrentTransform().inverse().mult(d),0!==(_=this._cf.displacers.nodes).length&&_.forEach((function(e){var t=e._vf.weight,i=e._vf.displacements,s=i.length;0!==s&&e._vf.coordIndex.forEach((function(e,o){r._vf.point[e]=r._vf.point[e].addScaled(u.multMatrixVec(i[o%s]),t)}))})),0!==(h=this._vf.skinCoordIndex).length&&(l=this._vf.skinCoordWeight,h.forEach((function(e,t){var i=f._restCoords[e];r._vf.point[e]=r._vf.point[e].add(u.multMatrixPnt(i).subtract(i).multiply(l[Math.min(t,l.length-1)]))}))));var x=this._humanoid._cf.skinNormal.node;x&&0!==(h=this._vf.skinCoordIndex).length&&(l=this._vf.skinCoordWeight,f=this._humanoid,u=f.getCurrentTransform().inverse().mult(d).inverse().transpose(),h.forEach((function(e,t){var i=f._restNormals[e];x._vf.vector[e]=x._vf.vector[e].add(u.multMatrixVec(i).subtract(i).multiply(l[Math.min(t,l.length-1)]))})));for(var v=0;v<c;v++)(a=this._childNodes[v])&&a.collectDrawableObjects(d,t,i,s,o,n)}}})),x3dom.registerNodeType("HAnimSegment","H-Anim",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.HAnimSegment.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFVec3f(e,"centerOfMass",0,0,0),this.addField_SFFloat(e,"mass",0),this.addField_MFFloat(e,"momentsOfInertia",[0,0,0,0,0,0,0,0,0]),this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFNode("displacers",x3dom.nodeTypes.HAnimDisplacer)}),{})),x3dom.registerNodeType("HAnimSite","H-Anim",defineClass(x3dom.nodeTypes.Transform,(function(e){x3dom.nodeTypes.HAnimSite.superClass.call(this,e),this.addField_SFString(e,"name","")}))),x3dom.registerNodeType("HAnimHumanoid","H-Anim",defineClass(x3dom.nodeTypes.Transform,(function(e){x3dom.nodeTypes.HAnimHumanoid.superClass.call(this,e),this.addField_SFString(e,"name",""),this.addField_SFString(e,"version",""),this.addField_MFString(e,"info",[]),this.addField_MFNode("joints",x3dom.nodeTypes.HAnimJoint),this.addField_MFNode("segments",x3dom.nodeTypes.HAnimSegment),this.addField_MFNode("sites",x3dom.nodeTypes.HAnimSite),this.addField_MFNode("skeleton",x3dom.nodeTypes.HAnimJoint),this.addField_MFNode("skin",x3dom.nodeTypes.X3DChildNode),this.addField_SFNode("skinCoord",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFNode("skinNormal",x3dom.nodeTypes.X3DNormalNode),this.addField_MFNode("viewpoints",x3dom.nodeTypes.HAnimSite),this.addField_SFString(e,"skeletalConfiguration","BASIC"),this.addField_MFVec3f(e,"jointBindingPositions",[0,0,0]),this.addField_MFRotation(e,"jointBindingRotations",[0,0,1,0]),this.addField_MFVec3f(e,"jointBindingScales",[1,1,1]),this.addField_MFVec3f(e,"skinBindingCoords",[]),this.addField_MFVec3f(e,"skinBindingNormals",[])}),{collectDrawableObjects:function(e,t,i,s,o,n){if(i&&this._parentNodes.length>1&&(i=!1),i&&(s=s||this.cacheInvalid())&&this.invalidateCache(),!((o=t.cull(e,this.graphState(),i,o))<0)){var r,a;i?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(e)),a=this._graph.globalMatrix):a=this.transformMatrix(e);var d=this._childNodes.length;if(x3dom.nodeTypes.ClipPlane.count>0){for(var h=[],l=0;l<d;l++)(r=this._childNodes[l])&&x3dom.isa(r,x3dom.nodeTypes.ClipPlane)&&r._vf.on&&r._vf.enabled&&h.push({plane:r,trafo:a});n=h.concat(n)}this._cf.skinCoord.node&&this._cf.skinCoord.node._vf.point.setValues(this._restCoords),this._cf.skinNormal.node&&this._cf.skinNormal.node._vf.vector.setValues(this._restNormals),this._cf.skeleton.nodes.forEach((function(e){e.collectDrawableObjects(a,t,i,s,o,n)})),this._cf.skin.nodes.forEach((function(e){e.collectDrawableObjects(a,t,i,s,o,n)})),this._cf.skinCoord.node&&this._cf.skinCoord.node._parentNodes.forEach((function(e){e.fieldChanged("coord")}))}},nodeChanged:function(){this._cf.skinCoord.node&&(this._restCoords=this._cf.skinCoord.node._vf.point.copy()),this._cf.skinNormal.node&&(this._restNormals=this._cf.skinNormal.node._vf.vector.copy())}})),x3dom.registerNodeType("X3DParametricGeometryNode","NURBS",defineClass(x3dom.nodeTypes.X3DGeometryNode,(function(e){x3dom.nodeTypes.X3DParametricGeometryNode.superClass.call(this,e)}),{})),x3dom.registerNodeType("X3DNurbsSurfaceGeometryNode","NURBS",defineClass(x3dom.nodeTypes.X3DParametricGeometryNode,(function(e){x3dom.nodeTypes.X3DParametricGeometryNode.superClass.call(this,e),this.addField_SFInt32(e,"uDimension",0),this.addField_SFInt32(e,"vDimension",0),this.addField_SFInt32(e,"uOrder",3),this.addField_SFInt32(e,"vOrder",3),this.addField_SFFloat(e,"uTessellation",0),this.addField_SFFloat(e,"vTessellation",0),this.addField_MFDouble(e,"uKnot",[]),this.addField_MFDouble(e,"vKnot",[]),this.addField_MFDouble(e,"weight",[]),this.addField_SFNode("controlPoint",x3dom.nodeTypes.X3DCoordinateNode),this.addField_SFBool(e,"uClosed",!1),this.addField_SFBool(e,"vClosed",!1),this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode),this.addField_SFBool(e,"solid",!1),this.addField_SFBool(e,"normalPerVertex",!0),this._needReRender=!0,this.basisFunsCache=new Map,this.uv=[],this.lastTime=-1}),{nodeChanged:function(){if(this._needReRender=!0,this._vf.ccw=!1,this._vf.solid=!1,this._vf.useGeoCache=!1,!this._hasCoarseMesh){var e=this.createCoarseITS(this);this._mesh=e._mesh,this._hasCoarseMesh=!0}this._vf.uKnot.length!==this._vf.uDimension+this._vf.uOrder&&(this._vf.uKnot=this.createDefaultKnots(this._vf.uDimension,this._vf.uOrder)),this._vf.vKnot.length!==this._vf.vDimension+this._vf.vOrder&&(this._vf.vKnot=this.createDefaultKnots(this._vf.vDimension,this._vf.vOrder));var t=[];if(this._cf.trimmingContour&&this._cf.trimmingContour.nodes.length)for(var i=this._cf.trimmingContour.nodes.length,s=0;s<i;s++){var o=this._cf.trimmingContour.nodes[s];if(o._cf.children){t[s]=[];for(var n=o._cf.children.nodes,r=0;r<n.length;r++){var a=n[r];if(a._vf.order||(a._vf.order=2),!a._vf.knot){var d=[];d.push(0),d.push(0);for(var h=2;h<a._vf.controlPoint.length;h++)d.push(h-1);d.push(d[d.length-1]+1),d.push(d[d.length-1]),a._vf.knot=d}t[s].push([a._vf.controlPoint.length-1,a._vf.order-1,a._vf.knot,a._vf.controlPoint,a._vf.weight])}}}var l=this._cf.controlPoint.node,f=[this._vf.uDimension-1,this._vf.vDimension-1,this._vf.uOrder-1,this._vf.vOrder-1,this._vf.uKnot,this._vf.vKnot,l.getPoints(),this._vf.weight,this._vf.uTessellation,this._vf.vTessellation,t,this.basisFunsCache,this.uv,performance.now()];this.workerTask&&(this.workerTask.discard=!0),this.workerTask=new x3dom.WorkerTask(x3dom.tessWorkerScript,this,(function(e){if(e.data.length>=3&&e.data[5]>this.caller.lastTime){if(this.caller.uv.length){for(var t=e.data[1],i=new x3dom.fields.MFVec3f,s=0;s<t.length;s++)i.push(new x3dom.fields.SFVec3f(t[s][0],t[s][1],t[s][2]));this.caller._mesh._positions[0]=i.toGL()}else{var o=this.caller.createITS(e.data,this.caller);if(this.caller.workerTask=null,this.caller._mesh=o._mesh,this.caller._nameSpace){var n=x3dom.tessWorkerPool.taskQueue.length;this.caller._nameSpace.doc._x3dElem.runtime.canvas.progressText=0==n?"":"Tesselation tasks: "+n}}this.caller._cleanupGLObjects&&this.caller._cleanupGLObjects(!0),this.caller._parentNodes.forEach((function(e){e.setAllDirty()})),this.caller.basisFunsCache=e.data[3],this.caller.uv=e.data[4],this.caller.lastTime=e.data[5]}}),f),x3dom.tessWorkerPool.addWorkerTask(this.workerTask)},fieldChanged:function(e){if("order"==e||"knot"==e||e.includes("Tessellation"))return this.basisFunsCache=new Map,this.uv=[],void this.nodeChanged();this.uv.length&&this.nodeChanged()},createDefaultKnots:function(e,t){for(var i=Array(e+t).fill(0),s=t;s<e;s++)i[s]=(s-1)/(e-1);for(s=i.length-t;s<i.length;s++)i[s]=1;return i},createCoarseITS:function(e){var t=e._vf.uDimension,i=e._vf.vDimension,s=e._cf.controlPoint.node,o=new x3dom.nodeTypes.IndexedTriangleSet;o._nameSpace=e._nameSpace,o._vf.solid=!1,o._vf.ccw=!1,o._cf.texCoord=e._cf.texCoord;for(var n=[],r=0,a=t,d=0;d<i-1;d++){for(var h=0;h<t-1;h++)n.push(r),n.push(r+1),n.push(a),n.push(a),n.push(r+1),n.push(a+1),r++,a++;r++,a++}return o._vf.index=n,o.addChild(s),o.nodeChanged(),o._xmlNode=e._xmlNode,o},createITS:function(e,t){var i=new x3dom.nodeTypes.IndexedTriangleSet;i._nameSpace=t._nameSpace,i._vf.normalPerVertex=t._vf.normalPerVertex,i._vf.solid=!1,i._vf.ccw=!1,i._vf.index=e[0];var s=new x3dom.nodeTypes.Coordinate;s._nameSpace=t._nameSpace,s._vf.point=new x3dom.fields.MFVec3f;for(var o=0;o<e[1].length;o++)s._vf.point.push(new x3dom.fields.SFVec3f(e[1][o][0],e[1][o][1],e[1][o][2]));if(i.addChild(s),null!==t._cf.texCoord.node)i._cf.texCoord=t._cf.texCoord;else{var n=new x3dom.nodeTypes.TextureCoordinate;n._nameSpace=t._nameSpace,n._vf.point=new x3dom.fields.MFVec2f;for(o=0;o<e[2].length;o++)n._vf.point.push(new x3dom.fields.SFVec2f(e[2][o][0],e[2][o][1]));i.addChild(n)}return i.nodeChanged(),i._xmlNode=t._xmlNode,i}})),x3dom.registerNodeType("NurbsPatchSurface","NURBS",defineClass(x3dom.nodeTypes.X3DNurbsSurfaceGeometryNode,(function(e){x3dom.nodeTypes.NurbsPatchSurface.superClass.call(this,e),this._needReRender=!0}),{nodeChanged:function(){x3dom.nodeTypes.NurbsTrimmedSurface.prototype.nodeChanged.call(this)}})),x3dom.registerNodeType("NurbsCurve","NURBS",defineClass(x3dom.nodeTypes.X3DParametricGeometryNode,(function(e){x3dom.nodeTypes.NurbsCurve.superClass.call(this,e),this.addField_SFInt32(e,"order",3),this.addField_MFDouble(e,"knot",[]),this.addField_SFNode("controlPoint",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFDouble(e,"weight",[]),this.addField_SFInt32(e,"tessellation",0),this.addField_SFBool(e,"closed",!1),this.points=[],this.uList=[],this.basisFunsCache={},this.ils=new x3dom.nodeTypes.IndexedLineSet,this.ils.addChild(new x3dom.nodeTypes.Coordinate)}),{nodeChanged:function(){if(this._needReRender=!0,this._vf.useGeoCache=!1,!this._hasCoarseMesh){var e=this.createCoarseILS(this);this._mesh=e._mesh,this._hasCoarseMesh=!0}this.generateGeometry()},fieldChanged:function(e){switch(this._parentNodes.forEach((function(e){e._dirty.positions=!0,e.invalidateVolume()})),e){case"tessellation":this.uList=[];break;case"knot":case"order":case"closed":this.uList=[],this.basisFunsCache={}}this.generateGeometry()},generateGeometry:function(){this.points=this._cf.controlPoint.node._vf.point;var e=this.points.length;this._vf.knot.length!==e+this._vf.order&&this.createDefaultKnots(),this._vf.weight.length!=e&&(this._vf.weight=Array(e).fill(1));var t=this.calcTessPoints(this._vf.tessellation,e);0==this.uList.length&&(this.uList=this.listPoints(t,this._vf.knot));var i=this.tessellate();this.createILS(i,this),this._mesh=this.ils._mesh},createDefaultKnots:function(){for(var e=Array(this.points.length+this._vf.order).fill(0),t=this._vf.order;t<this.points.length;t++)e[t]=t-1;for(t=e.length-this._vf.order;t<e.length;t++)e[t]=this.points.length-1;this._vf.knot=e},calcTessPoints:function(e,t){return e>0?e+1:0==e?2*t+1:-e*t+1},listPoints:function(e,t){var i=t[t.length-1]-t[0];i/=e-1;for(var s=[],o=0;o<e;o++)s.push(t[0]+o*i);return s},tessellate:function(){var e={dimension:this.points.length-1,u:this.uList,degree:this._vf.order-1,knots:this._vf.knot,points:this.points,weights:this._vf.weight,closed:this._vf.closed};return e.u.map((function(t){return this.curvePoint3DH(e.dimension,e.degree,e.knots,e.points,e.weights,t)}),this)},curvePoint3DH:function(e,t,i,s,o,n){var r,a,d,h,l,f=[0,0,0,0];for(r=this.findSpan(e,t,n,i),l=this.basisFuns(r,n,t,i),a=r-t,d=0;d<=t;d++)h=a+d,f[0]+=l[d]*s[h].x,f[1]+=l[d]*s[h].y,f[2]+=l[d]*s[h].z,f[3]+=l[d]*o[h];return new x3dom.fields.SFVec3f(f[0]/f[3],f[1]/f[3],f[2]/f[3])},findSpan:function(e,t,i,s){var o,n,r;if(i>=s[e])return e;if(i<=s[t])return t;for(o=0,r=e+1,n=Math.floor((o+r)/2);i<s[n]||i>=s[n+1];)i<s[n]?r=n:o=n,n=Math.floor((o+r)/2);return n},basisFuns:function(e,t,i,s){var o=Math.floor(1e11*t);if(this.basisFunsCache[o])return this.basisFunsCache[o];var n,r,a,d,h=[],l=[],f=[];for(h[0]=1,a=0;a<=i;a++)l[a]=0,f[a]=0;for(a=1;a<=i;a++){for(l[a]=t-s[e+1-a],f[a]=s[e+a]-t,n=0,d=0;d<a;d++)r=h[d]/(f[d+1]+l[a-d]),h[d]=n+f[d+1]*r,n=l[a-d]*r;h[a]=n}return this.basisFunsCache[o]=h,h},createCoarseILS:function(e){var t=e._cf.controlPoint.node,i=new x3dom.nodeTypes.IndexedLineSet;i._nameSpace=e._nameSpace;for(var s=[],o=0;o<t._vf.point.length;o++)s.push(o);return s.push(-1),i._vf.coordIndex=s,i.addChild(t),i.nodeChanged(),i._xmlNode=e._xmlNode,i},createILS:function(e,t){this.ils._nameSpace=t._nameSpace,this.ils._vf.coordIndex=[];var i=this.ils._cf.coord.node;i._nameSpace=t._nameSpace,i._vf.point=new x3dom.fields.MFVec3f;for(var s=0;s<e.length;s++)i._vf.point.push(e[s]),this.ils._vf.coordIndex.push(s);return this.ils.nodeChanged(),this.ils._xmlNode=t._xmlNode,this.ils}})),x3dom.registerNodeType("NurbsPositionInterpolator","NURBS",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.NurbsPositionInterpolator.superClass.call(this,e),this.addField_SFInt32(e,"order",3),this.addField_MFDouble(e,"knot",[]),this.addField_SFNode("controlPoint",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFDouble(e,"weight",[]),this.addField_SFFloat(e,"set_fraction",0),this.points=[]}),{fieldChanged:function(e){if("set_fraction"===e){var t=this.getValue(this._vf.set_fraction);this.postMessage("value_changed",t)}},getValue:function(e){this.points=this._cf.controlPoint.node._vf.point;var t=this.points.length;return this._vf.knot.length!==t+this._vf.order&&this.createDefaultKnots(),this._vf.weight.length!=t&&(this._vf.weight=Array(t).fill(1)),this.curvePoint(e)},createDefaultKnots:function(){for(var e=this.points.length,t=Array(e+this._vf.order).fill(0),i=this._vf.order;i<e;i++)t[i]=(i-1)/(e-1);for(i=t.length-this._vf.order;i<t.length;i++)t[i]=1;this._vf.knot=t},curvePoint:function(e){var t={dimension:this.points.length-1,degree:this._vf.order-1,knots:this._vf.knot,points:this.points,weights:this._vf.weight};return x3dom.nodeTypes.NurbsCurve.prototype.curvePoint3DH.call(this,t.dimension,t.degree,t.knots,t.points,t.weights,e)},findSpan:function(e,t,i,s){return x3dom.nodeTypes.NurbsCurve.prototype.findSpan(e,t,i,s)},basisFuns:function(e,t,i,s){var o,n,r,a,d=[],h=[],l=[];for(d[0]=1,r=0;r<=i;r++)h[r]=0,l[r]=0;for(r=1;r<=i;r++){for(h[r]=t-s[e+1-r],l[r]=s[e+r]-t,o=0,a=0;a<r;a++)n=d[a]/(l[a+1]+h[r-a]),d[a]=o+l[a+1]*n,o=h[r-a]*n;d[r]=o}return d}})),x3dom.registerNodeType("NurbsOrientationInterpolator","NURBS",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.NurbsOrientationInterpolator.superClass.call(this,e),this.addField_SFInt32(e,"order",3),this.addField_MFDouble(e,"knot",[]),this.addField_SFNode("controlPoint",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFDouble(e,"weight",[]),this.addField_SFFloat(e,"set_fraction",0),this.points=[],this._fractionalShift=.01,this._downZ=new x3dom.fields.SFVec3f(0,0,-1)}),{fieldChanged:function(e){if("set_fraction"===e){var t=this.getValue(this._vf.set_fraction);this.postMessage("value_changed",t)}},getValue:function(e){this.points=this._cf.controlPoint.node._vf.point;var t=this.points.length,i=this._vf.knot;i.length!==t+this._vf.order&&x3dom.nodeTypes.NurbsPositionInterpolator.prototype.createDefaultKnots.call(this),this._vf.weight.length!=t&&(this._vf.weight=Array(t).fill(1));var s=(i[i.length-1]-i[0])*this._fractionalShift,o=this.curvePoint(e).subtract(this.curvePoint(e+s));return x3dom.fields.Quaternion.rotateFromTo(this._downZ,o)},curvePoint:function(e){return x3dom.nodeTypes.NurbsPositionInterpolator.prototype.curvePoint.call(this,e)},findSpan:function(e,t,i,s){return x3dom.nodeTypes.NurbsCurve.prototype.findSpan(e,t,i,s)},basisFuns:function(e,t,i,s){return x3dom.nodeTypes.NurbsPositionInterpolator.prototype.basisFuns(e,t,i,s)}})),x3dom.registerNodeType("NurbsSurfaceInterpolator","NURBS",defineClass(x3dom.nodeTypes.X3DChildNode,(function(e){x3dom.nodeTypes.NurbsSurfaceInterpolator.superClass.call(this,e),this.addField_SFInt32(e,"uDimension",0),this.addField_SFInt32(e,"vDimension",0),this.addField_MFDouble(e,"uKnot",[]),this.addField_MFDouble(e,"vKnot",[]),this.addField_SFInt32(e,"uOrder",3),this.addField_SFInt32(e,"vOrder",3),this.addField_SFNode("controlPoint",x3dom.nodeTypes.X3DCoordinateNode),this.addField_MFDouble(e,"weight",[]),this.addField_SFVec2f(e,"set_fraction",0,0),this.points=[],this._fractionalShift=.01}),{nodeChanged:function(){this.points=this._cf.controlPoint.node._vf.point,this.pointsLength=this.points.length},fieldChanged:function(e){if("set_fraction"===e){var t=this.getValue(this._vf.set_fraction);this.postMessage("position_changed",t.position),this.postMessage("normal_changed",t.normal)}},getValue:function(e){var t=e.x,i=e.y;this.points=this._cf.controlPoint.node._vf.point;var s=this._vf.uKnot,o=this._vf.vKnot;s.length!==this._vf.uDimension+this._vf.uOrder&&(s=this.createDefaultKnots(this._vf.uDimension,this._vf.uOrder)),o.length!==this._vf.vDimension+this._vf.vOrder&&(o=this.createDefaultKnots(this._vf.vDimension,this._vf.vOrder)),this._vf.weight.length!=this.pointsLength&&(this._vf.weight=Array(this.pointsLength).fill(1));var n=(s[s.length-1]-s[0])*this._fractionalShift,r=(o[o.length-1]-o[0])*this._fractionalShift,a=this.surfacePoint(t+n,i).subtract(this.surfacePoint(t,i)),d=this.surfacePoint(t,i+r).subtract(this.surfacePoint(t,i));return{position:this.surfacePoint(t,i),normal:a.cross(d).normalize()}},createDefaultKnots:function(e,t){for(var i=Array(e+t).fill(0),s=t;s<e;s++)i[s]=(s-1)/(e-1);for(s=i.length-t;s<i.length;s++)i[s]=1;return i},surfacePoint:function(e,t){return this.surfacePoint3DH(this._vf.uDimension-1,this._vf.vDimension-1,this._vf.uOrder-1,this._vf.vOrder-1,this._vf.uKnot,this._vf.vKnot,this.points,this._vf.weight,e,t)},findSpan:function(e,t,i,s){return x3dom.nodeTypes.NurbsCurve.prototype.findSpan(e,t,i,s)},basisFuns:function(e,t,i,s){return x3dom.nodeTypes.NurbsPositionInterpolator.prototype.basisFuns(e,t,i,s)},surfacePoint3DH:function(e,t,i,s,o,n,r,a,d,h){var l,f,u,_,c,m,p,x,v,g=0,y=[],S=[0,0,0,0],T=[];for(l=this.findSpan(e,i,d,o),x=this.basisFuns(l,d,i,o),f=this.findSpan(t,s,h,n),v=this.basisFuns(f,h,s,n),u=l-i,c=0;c<=s;c++){for(_=f-s+c,m=0;m<4;m++)T[g+m]=0;for(m=0;m<=i;m++)p=u+m+_*(e+1),T[g+0]+=x[m]*r[p].x,T[g+1]+=x[m]*r[p].y,T[g+2]+=x[m]*r[p].z,T[g+3]+=x[m]*a[p];g+=4}for(g=0,c=0;c<=s;c++)S[0]+=v[c]*T[g+0],S[1]+=v[c]*T[g+1],S[2]+=v[c]*T[g+2],S[3]+=v[c]*T[g+3],g+=4;for(g=0;g<3;g++)y[g]=S[g]/S[3];return new x3dom.fields.SFVec3f(y[0],y[1],y[2])}})),x3dom.registerNodeType("NurbsCurve2D","NURBS",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.NurbsCurve2D.superClass.call(this,e),this.addField_SFInt32(e,"order",3),this.addField_MFDouble(e,"knot",[]),this.addField_MFVec2f(e,"controlPoint",[]),this.addField_MFDouble(e,"weight",[]),this.addField_SFBool(e,"closed",!1)}),{})),x3dom.registerNodeType("NurbsTrimmedSurface","NURBS",defineClass(x3dom.nodeTypes.X3DNurbsSurfaceGeometryNode,(function(e){x3dom.nodeTypes.NurbsTrimmedSurface.superClass.call(this,e),this.addField_MFNode("trimmingContour",x3dom.nodeTypes.Contour2D),this._needReRender=!0}),{})),x3dom.registerNodeType("ContourPolyline2D","NURBS",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.ContourPolyline2D.superClass.call(this,e),this.addField_MFVec2f(e,"controlPoint",[])}),{})),x3dom.registerNodeType("Contour2D","NURBS",defineClass(x3dom.nodeTypes.X3DGroupingNode,(function(e){x3dom.nodeTypes.Contour2D.superClass.call(this,e),this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)}),{})),function(){var e;x3dom.tessWorkerScript=URL.createObjectURL(new Blob(["("+function(){function t(e,t,i,s){var o,n,r;if(i>=s[e])return e;if(i<=s[t])return t;for(o=0,r=e+1,n=Math.floor((o+r)/2);i<s[n]||i>=s[n+1];)i<s[n]?r=n:o=n,n=Math.floor((o+r)/2);return n}function i(t,i,s,o){var n=Object.values(o).toString()+Math.floor(1e11*i);if(e.has(n))return e.get(n);var r,a,d,h,l=[],f=[],u=[];for(l[0]=1,d=0;d<=s;d++)f[d]=0,u[d]=0;for(d=1;d<=s;d++){for(f[d]=i-o[t+1-d],u[d]=o[t+d]-i,r=0,h=0;h<d;h++)a=l[h]/(u[h+1]+f[d-h]),l[h]=r+u[h+1]*a,r=f[d-h]*a;l[d]=r}return e.set(n,l),l}function s(e){this.bbox_split=4,this.use_objectspace=!0,this.edge_thresh=.1,this.trim_thresh=.1,this.split_bias=.5,this.skew_thresh=.01,this.max_rec=5,this.w=e[0],this.h=e[1],this.p=e[2],this.q=e[3],this.U=e[4],this.V=e[5],this.P=e[6],this.W=e[7],this.tloops=e[10],this.useUV=e[12],this.surfaceHash=[],this.indexHash=[],this.curveHash=null,this.coordinates=[],this.texcoords=[],this.indices=[],this.uv=[],this.coordIndex=0,this.u0=0,this.u1=1,this.v0=0,this.v1=1,this.deform=function(){this.useUV.forEach((function(e){this.computeSurface(e,!1)}),this)},this.tessellate=function(){this.W&&this.W.length!=(this.w+1)*(this.h+1)&&(this.W={}),this.u0=this.U[this.p],this.u1=this.U[this.U.length-this.p-1];var e=.5*(this.u0+this.u1);this.v0=this.V[this.q],this.v1=this.V[this.V.length-this.q-1];var t=.5*(this.v0+this.v1);this.tessTri([[this.u0,this.v0],[this.u0,t],[e,this.v0]]),this.tessTri([[this.u0,t],[e,t],[e,this.v0]]),this.tessTri([[this.u0,t],[this.u0,this.v1],[e,t]]),this.tessTri([[this.u0,this.v1],[e,this.v1],[e,t]]),this.tessTri([[e,this.v0],[e,t],[this.u1,this.v0]]),this.tessTri([[e,t],[this.u1,t],[this.u1,this.v0]]),this.tessTri([[e,t],[e,this.v1],[this.u1,t]]),this.tessTri([[e,this.v1],[this.u1,this.v1],[this.u1,t]])},this.adjustThresholds=function(e,t){if(e<0){this.use_objectspace=!1,t>=0&&(t=e);var i=2/(this.w+1),s=2/(this.h+1);i*=this.U[this.U.length-this.p-1]-this.U[this.p],s*=this.V[this.V.length-this.q-1]-this.V[this.q],this.edge_thresh_u=-e*i,this.edge_thresh_v=-t*s}else{for(var o=Number.MAX_VALUE,n=-Number.MAX_VALUE,r=[o,o,o,n,n,n],a=0;a<this.P.length;a++)this.P[a].x<r[0]&&(r[0]=this.P[a].x),this.P[a].y<r[1]&&(r[1]=this.P[a].y),this.P[a].z<r[2]&&(r[2]=this.P[a].z),this.P[a].x>r[3]&&(r[3]=this.P[a].x),this.P[a].y>r[4]&&(r[4]=this.P[a].y),this.P[a].z>r[5]&&(r[5]=this.P[a].z);var d=Math.sqrt((r[0]-r[3])*(r[0]-r[3])+(r[1]-r[4])*(r[1]-r[4])+(r[2]-r[5])*(r[2]-r[5]))/this.bbox_split;e<=1e-5&&(e=1),this.edge_thresh*=d*e,this.trim_thresh*=d*e}},this.tessTri=function(e){for(var t=[e];t.length;){var i=t.splice(0,1);t=this.refineTri(i[0]).concat(t)}},this.refineTri=function(e){if(this.tloops&&this.inOut(e)<0)return[];var t=e[0][0]*e[1][1]-e[1][0]*e[0][1]+e[1][0]*e[2][1]-e[2][0]*e[1][1]+e[2][0]*e[0][1]-e[0][0]*e[2][1];t<0&&(t=-t);var i=[],s=[];i[0]=e[0][0]-e[1][0],i[1]=e[0][1]-e[1][1];var o=i[0]*i[0]+i[1]*i[1];if(i[0]=e[1][0]-e[2][0],i[1]=e[1][1]-e[2][1],o+=i[0]*i[0]+i[1]*i[1],i[0]=e[2][0]-e[0][0],i[1]=e[2][1]-e[0][1],(t/=o+=i[0]*i[0]+i[1]*i[1])<=this.skew_thresh)return this.diceTri(e),[];var n=[];o=0;for(var r=0;r<3;r++){var a=(r+2)%3;i=e[f=(r+1)%3],s=e[a],n[r]=this.splitEdge(i,s),n[r]>o&&(o=n[r])}o*=this.split_bias;var d=[],h=[],l=0;for(r=0;r<3;r++){var f=(r+1)%3;a=(r+2)%3;n[r]>this.edge_thresh&&n[r]>=o?(l++,h[r]=[],h[r][0]=.5*(e[f][0]+e[a][0]),h[r][1]=.5*(e[f][1]+e[a][1]),d[r]=r-3):n[f]>n[a]?(h[r]=e[f],d[r]=f):(h[r]=e[a],d[r]=a)}var u=[];if(l){var _=++l;for(r=0;r<3;r++){f=(r+1)%3;d[a=(r+2)%3]!=r&&d[f]!=r&&(u[--_]=[e[r],h[a],h[f]])}if(_){if(d[0]==d[1]||d[1]==d[2]||d[2]==d[0])return[];u[0]=[h[0],h[1],h[2]]}return u}return this.trimFinal(e),[]},this.diceTri=function(e){var t=[];t[0]=(e[0][0]+e[1][0]+e[2][0])/3,t[1]=(e[0][1]+e[1][1]+e[2][1])/3,this.computeSurface(t);for(var i=0;i<3;i++){var s=[],o=[],n=(i+1)%3;o[0]=e[n][0]-e[i][0],o[1]=e[n][1]-e[i][1],s[0]=1;for(var r=0;s.length;){var a=[],d=[],h=s[0];if(a[0]=e[i][0]+o[0]*r,a[1]=e[i][1]+o[1]*r,d[0]=e[i][0]+o[0]*h,d[1]=e[i][1]+o[1]*h,this.splitEdge(a,d)>this.edge_thresh)s.splice(0,0,.5*(r+h));else{this.computeSurface(a),this.computeSurface(d);var l=[t,a,d];this.trimFinal(l),s.splice(0,1),r=h}}}},this.computeSurface=function(e,s){var o,n=Math.floor(1e11*e[0]),r=Math.floor(1e11*e[1]);if(this.surfaceHash[n]){var a=this.surfaceHash[n][r];if(a)return a}return o=Object.keys(this.W).length?function(e,s,o,n,r,a,d,h,l,f){var u,_,c,m,p,x,v,g,y,S=0,T=[],F=[0,0,0,0],b=[];for(g=i(u=t(e,o,l,r),l,o,r),y=i(_=t(s,n,f,a),f,n,a),c=u-o,p=0;p<=n;p++){for(m=_-n+p,x=0;x<4;x++)b[S+x]=0;for(x=0;x<=o;x++)v=c+x+m*(e+1),b[S+0]+=g[x]*d[v].x,b[S+1]+=g[x]*d[v].y,b[S+2]+=g[x]*d[v].z,b[S+3]+=g[x]*h[v];S+=4}for(S=0,p=0;p<=n;p++)F[0]+=y[p]*b[S+0],F[1]+=y[p]*b[S+1],F[2]+=y[p]*b[S+2],F[3]+=y[p]*b[S+3],S+=4;for(S=0;S<3;S++)T[S]=F[S]/F[3];return T}(this.w,this.h,this.p,this.q,this.U,this.V,this.P,this.W,e[0],e[1]):function(e,s,o,n,r,a,d,h,l){var f,u,_,c,m,p,x,v,g,y=0,S=[0,0,0],T=[];for(v=i(f=t(e,o,h,r),h,o,r),g=i(u=t(s,n,l,a),l,n,a),_=f-o,m=0;m<=n;m++){for(c=u-n+m,T[y+0]=0,T[y+1]=0,T[y+2]=0,p=0;p<=o;p++)x=_+p+c*(e+1),T[y+0]+=v[p]*d[x].x,T[y+1]+=v[p]*d[x].y,T[y+2]+=v[p]*d[x].z;y+=3}for(y=0,m=0;m<=n;m++)S[0]+=g[m]*T[y+0],S[1]+=g[m]*T[y+1],S[2]+=g[m]*T[y+2],y+=3;return S}(this.w,this.h,this.p,this.q,this.U,this.V,this.P,e[0],e[1]),this.curveHash?o:(this.surfaceHash[n]||(this.surfaceHash[n]=[]),this.surfaceHash[n][r]=o,s||(this.indexHash[n]||(this.indexHash[n]=[]),this.indexHash[n][r]=this.coordIndex,this.coordIndex++,this.coordinates.push(o),this.texcoords.push([(e[0]+this.u0)/(this.u1-this.u0),(e[1]+this.v0)/(this.v1-this.v0)]),this.uv.push(e)),o)},this.computeCurve=function(e,s,o){var n=Math.floor(1e11*o);if(this.curveHash[e][s]){var r=this.curveHash[e][s][n];if(r)return r}var a,d=this.tloops[e][s];return a=d[4]&&d[4].length?function(e,s,o,n,r,a){var d,h,l,f,u=0,_=0,c=0;for(f=i(d=t(e,s,a,o),a,s,o),h=0;h<=s;h++)l=d-s+h,u+=f[h]*n[l].x,_+=f[h]*n[l].y,c+=f[h]*r[l];return[u/c,_/c]}(d[0],d[1],d[2],d[3],d[4],o):function(e,s,o,n,r){var a,d,h,l,f=0,u=0;for(l=i(a=t(e,s,r,o),r,s,o),d=0;d<=s;d++)h=a-s+d,f+=l[d]*n[h].x,u+=l[d]*n[h].y;return[f,u]}(d[0],d[1],d[2],d[3],o),this.curveHash[e][s]||(this.curveHash[e][s]=[]),this.curveHash[e][s][n]=a,a},this.splitEdge=function(e,t){var i=this.computeSurface(e),s=this.computeSurface(t);if(!this.use_objectspace)return Math.sqrt((e[0]-t[0])*(e[0]-t[0])/this.edge_thresh_u+(e[1]-t[1])*(e[1]-t[1])/this.edge_thresh_v);if(Math.abs(i[0]-s[0])>1e-5||Math.abs(i[1]-s[1])>1e-5||Math.abs(i[2]-s[2])>1e-5){var o=Math.sqrt((i[0]-s[0])*(i[0]-s[0])+(i[1]-s[1])*(i[1]-s[1])+(i[2]-s[2])*(i[2]-s[2]));if(o<this.edge_thresh){var n=[e[0]+.5*(t[0]-e[0]),e[1]+.5*(t[1]-e[1])],r=this.computeSurface(n,!1),a=0;(Math.abs(i[0]-r[0])>1e-5||Math.abs(i[1]-r[1])>1e-5||Math.abs(i[2]-r[2])>1e-5)&&(a+=Math.sqrt((i[0]-r[0])*(i[0]-r[0])+(i[1]-r[1])*(i[1]-r[1])+(i[2]-r[2])*(i[2]-r[2]))),(Math.abs(s[0]-r[0])>1e-5||Math.abs(s[1]-r[1])>1e-5||Math.abs(s[2]-r[2])>1e-5)&&(a+=Math.sqrt((s[0]-r[0])*(s[0]-r[0])+(s[1]-r[1])*(s[1]-r[1])+(s[2]-r[2])*(s[2]-r[2]))),a>1.01*o&&(o+=a)}return o}return 0},this.splitCenter=function(e){var t=[];this.curveHash=[],t[0]=(e[0][0]+e[1][0]+e[2][0])/3,t[1]=(e[0][1]+e[1][1]+e[2][1])/3;for(var i=0,s=0;s<3;s++)i+=this.splitEdge(e[s],t);return this.curveHash=null,.5*i>this.edge_thresh&&(this.computeSurface(t),!0)},this.renderFinal=function(e){for(var t=0;t<3;t++){var i=e[t],s=Math.floor(1e11*i[0]),o=Math.floor(1e11*i[1]);this.indexHash[s]&&this.indices.push(this.indexHash[s][o])}},this.intersectTrim=function(e,t,i){var s=0,o=0;i&&(s=i[2],o=i[3]+1);for(var n=s;n<this.ttloops.length;n++){for(var r=this.ttloops[n],a=o;a<r.length-1;a++){var d=r[a],h=r[a+1];if(Math.abs(e[0]-d[0])<1e-5&&Math.abs(e[1]-d[1])<1e-5||Math.abs(e[0]-h[0])<1e-5&&Math.abs(e[1]-h[1])<1e-5)return[];if(Math.abs(t[0]-d[0])<1e-5&&Math.abs(t[1]-d[1])<1e-5||Math.abs(t[0]-h[0])<1e-5&&Math.abs(t[1]-h[1])<1e-5)return[];var l=(t[0]-e[0])*(h[1]-d[1])-(t[1]-e[1])*(h[0]-d[0]);if(!(Math.abs(l)<1e-5)){var f=((e[1]-d[1])*(h[0]-d[0])-(e[0]-d[0])*(h[1]-d[1]))/l;if(!(f<1e-5||f>.99999)){var u=((e[1]-d[1])*(t[0]-e[0])-(e[0]-d[0])*(t[1]-e[1]))/l;if(!(u<1e-5||u>.99999))return[e[0]+f*(t[0]-e[0]),e[1]+f*(t[1]-e[1]),n,a]}}}if(i)return[]}return[]},this.renderDiced=function(e,t,i,s,o,n){var r=o,a=n;(e[0]-o[0])*(e[0]-o[0])+(e[1]-o[1])*(e[1]-o[1])>(e[0]-n[0])*(e[0]-n[0])+(e[1]-n[1])*(e[1]-n[1])&&(r=n,a=o),this.renderFinal([e,s,i]),this.renderFinal([e,r,s]),this.renderFinal([t,i,s]),this.renderFinal([t,s,a])},this.renderComplex=function(e,t,i,s){this.diceTri([e[0],t,s]),this.diceTri([t,e[1],i]),this.diceTri([t,i,s]),this.diceTri([s,i,e[2]])},this.renderTrimmed=function(e){var t=.3,i=this.intersectTrim(e[0],e[1]),s=this.intersectTrim(e[1],e[2]),o=this.intersectTrim(e[2],e[0]),n=(i.length>0)+(s.length>0)+(o.length>0);if(1==n){for(var r=[i,s,o],a=0;a<3;a++)if(r[a].length&&(Math.abs(e[a][0]-r[a][0])<1e-5&&Math.abs(e[a][1]-r[a][1])<1e-5||Math.abs(e[(a+1)%3][0]-r[a][0])<1e-5&&Math.abs(e[(a+1)%3][1]-r[a][1])<1e-5))return void this.renderFinal(e);if(i.length){var d=this.intersectTrim(e[0],e[1],i);if(d.length){var h=this.ttloops[d[2]][d[3]];return this.computeSurface(h),this.computeSurface(i),this.computeSurface(d),void(this.inOut([e[2],[e[2][0]+(e[1][0]-e[2][0])*t,e[2][1]+(e[1][1]-e[2][1])*t],[e[2][0]+(e[0][0]-e[2][0])*t,e[2][1]+(e[0][1]-e[2][1])*t]])>0?this.renderDiced(e[0],e[1],e[2],h,i,d):this.renderFinal([i,h,d]))}}else if(s.length){var l=this.intersectTrim(e[1],e[2],s);if(l.length){h=this.ttloops[l[2]][l[3]];return this.computeSurface(h),this.computeSurface(s),this.computeSurface(l),void(this.inOut([e[0],[e[0][0]+(e[1][0]-e[0][0])*t,e[0][1]+(e[1][1]-e[0][1])*t],[e[0][0]+(e[2][0]-e[0][0])*t,e[0][1]+(e[2][1]-e[0][1])*t]])>0?this.renderDiced(e[1],e[2],e[0],h,s,l):this.renderFinal([s,h,l]))}}else if(o.length){var f=this.intersectTrim(e[2],e[0],o);if(f.length){h=this.ttloops[f[2]][f[3]];return this.computeSurface(h),this.computeSurface(o),this.computeSurface(f),void(this.inOut([e[1],[e[1][0]+(e[0][0]-e[1][0])*t,e[1][1]+(e[0][1]-e[1][1])*t],[e[1][0]+(e[2][0]-e[1][0])*t,e[1][1]+(e[2][1]-e[1][1])*t]])>0?this.renderDiced(e[2],e[0],e[1],h,o,f):this.renderFinal([o,h,f]))}}if(this.max_rec)return this.max_rec--,this.diceTri(e),void this.max_rec++}if(2!=n){if(3==n)return void this.renderComplex(e,i,s,o);var u=0;if(this.inOut([e[0],[e[0][0]+(e[1][0]-e[0][0])*t,e[0][1]+(e[1][1]-e[0][1])*t],[e[0][0]+(e[2][0]-e[0][0])*t,e[0][1]+(e[2][1]-e[0][1])*t]])<0&&u++,this.inOut([e[1],[e[1][0]+(e[0][0]-e[1][0])*t,e[1][1]+(e[0][1]-e[1][1])*t],[e[1][0]+(e[2][0]-e[1][0])*t,e[1][1]+(e[2][1]-e[1][1])*t]])<0&&u++,this.inOut([e[2],[e[2][0]+(e[1][0]-e[2][0])*t,e[2][1]+(e[1][1]-e[2][1])*t],[e[2][0]+(e[0][0]-e[2][0])*t,e[2][1]+(e[0][1]-e[2][1])*t]])<0&&u++,u>0)return;this.renderFinal(e)}else i.length?s.length?(this.computeSurface(i),this.computeSurface(s),this.inOut([e[1],[e[1][0]+(i[0]-e[1][0])*t,e[1][1]+(i[1]-e[1][1])*t],[e[1][0]+(s[0]-e[1][0])*t,e[1][1]+(s[1]-e[1][1])*t]])<=0?(this.renderFinal([e[0],i,s]),this.renderFinal([e[0],s,e[2]])):this.renderFinal([e[1],s,i])):(this.computeSurface(i),this.computeSurface(o),this.inOut([e[0],[e[0][0]+(o[0]-e[0][0])*t,e[0][1]+(o[1]-e[0][1])*t],[e[0][0]+(i[0]-e[0][0])*t,e[0][1]+(i[1]-e[0][1])*t]])<=0?(this.renderFinal([e[1],o,i]),this.renderFinal([e[1],e[2],o])):this.renderFinal([e[0],i,o])):(this.computeSurface(s),this.computeSurface(o),this.inOut([e[2],[e[2][0]+(o[0]-e[2][0])*t,e[2][1]+(o[1]-e[2][1])*t],[e[2][0]+(s[0]-e[2][0])*t,e[2][1]+(s[1]-e[2][1])*t]])<=0?(this.renderFinal([e[0],s,o]),this.renderFinal([e[0],e[1],s])):this.renderFinal([e[2],o,s]))},this.inOut=function(e){for(var t=[],i=[],s=[],o=[],n=[],r=0;r<3;r++){t[r]=[];var a=e[r],d=e[(r+1)%3];t[r][0]=a[1]-d[1],t[r][1]=d[0]-a[0],i[r]=t[r][0]*a[0]+t[r][1]*a[1],s[r]=o[r]=0,n[r]=Math.abs(t[r][0])>Math.abs(t[r][1])?1:0}for(var h=0;h<this.ttloops.length;h++)for(var l=this.ttloops[h],f=0;f<l.length-1;f++){var u=l[f],_=l[f+1],c=0;for(r=0;r<3;r++){var m=u[0]*t[r][0]+u[1]*t[r][1]-i[r],p=_[0]*t[r][0]+_[1]*t[r][1]-i[r];if(c+=m<0?1:-1,!(m<0?p<0:p>=0)){var x=(_[n[r]]*m-u[n[r]]*p)/(m-p),v=x<e[r][n[r]],g=x<e[(r+1)%3][n[r]];if(v&&g)s[r]++;else{if(v||g)return 0;o[r]++}}}if(3==c||-3==c)return 0}return 1&s[0]&&1&s[1]&&1&s[2]?1:1&s[0]||1&s[1]||1&s[2]?0:-1},this.refineTrim=function(e,t,i){var s=this.computeCurve(e,Math.floor(t),t),o=this.computeCurve(e,Math.floor(i),i);return this.splitEdge(s,o)>this.edge_thresh},this.initTrims=function(){this.ttloops=[],this.curveHash=[];var e=this.edge_thresh;this.edge_thresh=this.trim_thresh;for(var t=0;t<this.tloops.length;t++){var i=this.tloops[t];this.curveHash[t]=[],this.ttloops[t]=[];for(var s,o=[],n=0;n<i.length;n++){var r=i[n][2],a=1/(r[r.length-1]-r[0]);if(Math.abs(1-a)>1e-11)for(var d=0;d<r.length;d++)r[d]=r[d]*a;var h=r[0]-n;if(Math.abs(h)>1e-11)for(d=0;d<r.length;d++)r[d]=r[d]-h;var l=i[n][1],f=r[l];for(s=r[r.length-l-1];f<s;){for(this.ttloops[t].push(this.computeCurve(t,n,f)),o.push(f),l++;Math.abs(f-r[l])<1e-5;)l++;f=r[l]}}for(var u=this.ttloops[t],_=0;_<u.length;){var c=o[_],m=Math.floor(c),p=_+1;p==u.length&&(p=0);var x=o[p];if(i[m][1]>1&&this.refineTrim(t,c,x)){var v;0==p?(v=.5*(c+s),p=_+1):v=.5*(c+x);var g=this.computeCurve(t,m,v);u.splice(p,0,g),o.splice(p,0,v)}else{if(0==p)break;_=p}}u.push(u[0])}this.curveHash=null,this.edge_thresh=e},this.trimFinal=function(e){if(this.tloops){if(this.inOut(e)>=0)return void this.renderTrimmed(e);var t=.3,i=0;if(this.inOut([e[0],[e[0][0]+(e[1][0]-e[0][0])*t,e[0][1]+(e[1][1]-e[0][1])*t],[e[0][0]+(e[2][0]-e[0][0])*t,e[0][1]+(e[2][1]-e[0][1])*t]])<0&&i++,this.inOut([e[1],[e[1][0]+(e[0][0]-e[1][0])*t,e[1][1]+(e[0][1]-e[1][1])*t],[e[1][0]+(e[2][0]-e[1][0])*t,e[1][1]+(e[2][1]-e[1][1])*t]])<0&&i++,this.inOut([e[2],[e[2][0]+(e[1][0]-e[2][0])*t,e[2][1]+(e[1][1]-e[2][1])*t],[e[2][0]+(e[0][0]-e[2][0])*t,e[2][1]+(e[0][1]-e[2][1])*t]])<0&&i++,i>0)return}this.renderFinal(e)}}onmessage=function(t){e=t.data[11]?t.data[11]:new Map;var i=new s(t.data);if(t.data[12]&&t.data[12].length?i.deform():(i.adjustThresholds(t.data[8],t.data[9]),t.data[10]&&t.data[10].length?i.initTrims():i.tloops=null,i.tessellate()),i.have_transferables){for(var o=new Uint32Array(i.indices.length),n=0;n<i.indices.length;n++)o[n]=i.indices[n];postMessage(o.buffer,[o.buffer]);var r=new Float64Array(i.coordinates.length);for(n=0;n<i.coordinates.length;n++)r[n]=i.coordinates[n];postMessage(r.buffer,[r.buffer]);var a=new Float64Array(i.texcoords.length);for(n=0;n<i.texcoords.length;n++)a[n]=i.texcoords[n];postMessage(a.buffer,[a.buffer])}else postMessage([i.indices,i.coordinates,i.texcoords,e,i.uv,t.data[13]]);close()}}.toString()+")()"],{type:"application/javascript"}))}(),x3dom.WorkerPool=function(e){var t=this;this.taskQueue=[],this.workerQueue=[],this.poolSize=e,this.init=function(){for(var e=0;e<this.poolSize;e++)t.workerQueue.push(new x3dom.WorkerThread(t))},this.addWorkerTask=function(e){t.workerQueue.length>0?t.workerQueue.shift().run(e):t.taskQueue.push(e)},this.freeWorkerThread=function(e){if(t.taskQueue.length>0){var i=t.taskQueue.shift();if(i.discard)return this.freeWorkerThread(e);e.run(i)}else t.workerQueue.push(e)}},x3dom.WorkerThread=function(e){var t=this;this.workerPool=e,this.workerTask={},this.run=function(e){t.workerTask=e;var i=new Worker(e.script);i.caller=e.caller,i.onmessage=function(e){t.workerTask.callback(e),t.workerPool.freeWorkerThread(t)},i.postMessage(e.startMessage)}},x3dom.WorkerTask=function(e,t,i,s){this.script=e,this.caller=t,this.callback=i,this.startMessage=s},function(){var e=1;navigator.hardwareConcurrency&&(e=Math.max(1,navigator.hardwareConcurrency-1)),x3dom.tessWorkerPool=new x3dom.WorkerPool(e),x3dom.tessWorkerPool.init()}();